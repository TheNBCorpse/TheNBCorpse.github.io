// Generated by Construct, the game and animation creation tool
// Visit: https://www.construct.net

var __create=Object.create,__defProp=Object.defineProperty,__getOwnPropDesc=Object.getOwnPropertyDescriptor,__getOwnPropNames=Object.getOwnPropertyNames,__getProtoOf=Object.getPrototypeOf,__hasOwnProp=Object.prototype.hasOwnProperty,__commonJS=(e,t)=>function(){return t||(0,e[__getOwnPropNames(e)[0]])((t={exports:{}}).exports,t),t.exports},__copyProps=(e,t,s,i)=>{if(t&&"object"==typeof t||"function"==typeof t)for(let r of __getOwnPropNames(t))__hasOwnProp.call(e,r)||r===s||__defProp(e,r,{get:()=>t[r],enumerable:!(i=__getOwnPropDesc(t,r))||i.enumerable});return e},__toESM=(e,t,s)=>(s=null!=e?__create(__getProtoOf(e)):{},__copyProps(!t&&e&&e.__esModule?s:__defProp(s,"default",{value:e,enumerable:!0}),e)),require_c3runtime=__commonJS({"file-map:scripts/c3runtime.js"(exports,module){{let e=function(e){ARRAY_TYPE=e},n=function(e){return e*degree},h=function(e,t){return Math.abs(e-t)<=EPSILON*Math.max(1,Math.abs(e),Math.abs(t))},u=function(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0),e[0]=1,e[3]=1,e},_=function(e){var t=new ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},p=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},m=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e},g=function(e,t,s,i){var r=new ARRAY_TYPE(4);return r[0]=e,r[1]=t,r[2]=s,r[3]=i,r},S=function(e,t,s,i,r){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e},G=function(e,t){if(e===t){var s=t[1];e[1]=t[2],e[2]=s}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e},y=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=s*n-r*i;return a?(a=1/a,e[0]=n*a,e[1]=-i*a,e[2]=-r*a,e[3]=s*a,e):null},I=function(e,t){var s=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=s,e},T=function(e){return e[0]*e[3]-e[2]*e[1]},C=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[0],h=s[1],l=s[2],c=s[3];return e[0]=i*o+n*h,e[1]=r*o+a*h,e[2]=i*l+n*c,e[3]=r*l+a*c,e},b=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=Math.sin(s),h=Math.cos(s);return e[0]=i*h+n*o,e[1]=r*h+a*o,e[2]=i*-o+n*h,e[3]=r*-o+a*h,e},x=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[0],h=s[1];return e[0]=i*o,e[1]=r*o,e[2]=n*h,e[3]=a*h,e},w=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=s,e[2]=-s,e[3]=i,e},P=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e},R=function(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},v=function(e){return Math.hypot(e[0],e[1],e[2],e[3])},A=function(e,t,s,i){return e[2]=i[2]/i[0],s[0]=i[0],s[1]=i[1],s[3]=i[3]-e[2]*s[1],[e,t,s]},M=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e},D=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e[3]=t[3]-s[3],e},E=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},F=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=t[0],o=t[1],h=t[2],l=t[3];return Math.abs(s-a)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(i-o)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-h)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(n-l)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(l))},O=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e},B=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e[3]=t[3]+s[3]*i,e},k=function(){var e=new ARRAY_TYPE(6);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[4]=0,e[5]=0),e[0]=1,e[3]=1,e},L=function(e){var t=new ARRAY_TYPE(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t},N=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e},W=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e},U=function(e,t,s,i,r,n){var a=new ARRAY_TYPE(6);return a[0]=e,a[1]=t,a[2]=s,a[3]=i,a[4]=r,a[5]=n,a},V=function(e,t,s,i,r,n,a){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e[4]=n,e[5]=a,e},H=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=s*n-i*r;return h?(h=1/h,e[0]=n*h,e[1]=-i*h,e[2]=-r*h,e[3]=s*h,e[4]=(r*o-n*a)*h,e[5]=(i*a-s*o)*h,e):null},j=function(e){return e[0]*e[3]-e[1]*e[2]},z=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=s[0],c=s[1],u=s[2],d=s[3],_=s[4],p=s[5];return e[0]=i*l+n*c,e[1]=r*l+a*c,e[2]=i*u+n*d,e[3]=r*u+a*d,e[4]=i*_+n*p+o,e[5]=r*_+a*p+h,e},X=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=Math.sin(s),c=Math.cos(s);return e[0]=i*c+n*l,e[1]=r*c+a*l,e[2]=i*-l+n*c,e[3]=r*-l+a*c,e[4]=o,e[5]=h,e},Y=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=s[0],c=s[1];return e[0]=i*l,e[1]=r*l,e[2]=n*c,e[3]=a*c,e[4]=o,e[5]=h,e},q=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=s[0],c=s[1];return e[0]=i,e[1]=r,e[2]=n,e[3]=a,e[4]=i*l+n*c+o,e[5]=r*l+a*c+h,e},K=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=s,e[2]=-s,e[3]=i,e[4]=0,e[5]=0,e},$=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e},J=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e},Z=function(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"},Q=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],1)},ee=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e[4]=t[4]+s[4],e[5]=t[5]+s[5],e},te=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e[3]=t[3]-s[3],e[4]=t[4]-s[4],e[5]=t[5]-s[5],e},se=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*s,e[5]=t[5]*s,e},ie=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e[3]=t[3]+s[3]*i,e[4]=t[4]+s[4]*i,e[5]=t[5]+s[5]*i,e},re=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]},ne=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],h=t[0],l=t[1],c=t[2],u=t[3],d=t[4],_=t[5];return Math.abs(s-h)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(i-l)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(r-c)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(n-u)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(u))&&Math.abs(a-d)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(d))&&Math.abs(o-_)<=EPSILON*Math.max(1,Math.abs(o),Math.abs(_))},ae=function(){var e=new ARRAY_TYPE(9);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e},oe=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e},he=function(e){var t=new ARRAY_TYPE(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t},le=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},ce=function(e,t,s,i,r,n,a,o,h){var l=new ARRAY_TYPE(9);return l[0]=e,l[1]=t,l[2]=s,l[3]=i,l[4]=r,l[5]=n,l[6]=a,l[7]=o,l[8]=h,l},ue=function(e,t,s,i,r,n,a,o,h,l){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e[4]=n,e[5]=a,e[6]=o,e[7]=h,e[8]=l,e},de=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},_e=function(e,t){if(e===t){var s=t[1],i=t[2],r=t[5];e[1]=t[3],e[2]=t[6],e[3]=s,e[5]=t[7],e[6]=i,e[7]=r}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e},pe=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=c*a-o*l,d=-c*n+o*h,_=l*n-a*h,p=s*u+i*d+r*_;return p?(p=1/p,e[0]=u*p,e[1]=(-c*i+r*l)*p,e[2]=(o*i-r*a)*p,e[3]=d*p,e[4]=(c*s-r*h)*p,e[5]=(-o*s+r*n)*p,e[6]=_*p,e[7]=(-l*s+i*h)*p,e[8]=(a*s-i*n)*p,e):null},fe=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8];return e[0]=a*c-o*l,e[1]=r*l-i*c,e[2]=i*o-r*a,e[3]=o*h-n*c,e[4]=s*c-r*h,e[5]=r*n-s*o,e[6]=n*l-a*h,e[7]=i*h-s*l,e[8]=s*a-i*n,e},me=function(e){var t=e[0],s=e[1],i=e[2],r=e[3],n=e[4],a=e[5],o=e[6],h=e[7],l=e[8];return t*(l*n-a*h)+s*(-l*r+a*o)+i*(h*r-n*o)},ge=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=t[8],d=s[0],_=s[1],p=s[2],f=s[3],m=s[4],g=s[5],S=s[6],G=s[7],y=s[8];return e[0]=d*i+_*a+p*l,e[1]=d*r+_*o+p*c,e[2]=d*n+_*h+p*u,e[3]=f*i+m*a+g*l,e[4]=f*r+m*o+g*c,e[5]=f*n+m*h+g*u,e[6]=S*i+G*a+y*l,e[7]=S*r+G*o+y*c,e[8]=S*n+G*h+y*u,e},Se=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=t[8],d=s[0],_=s[1];return e[0]=i,e[1]=r,e[2]=n,e[3]=a,e[4]=o,e[5]=h,e[6]=d*i+_*a+l,e[7]=d*r+_*o+c,e[8]=d*n+_*h+u,e},Ge=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=t[8],d=Math.sin(s),_=Math.cos(s);return e[0]=_*i+d*a,e[1]=_*r+d*o,e[2]=_*n+d*h,e[3]=_*a-d*i,e[4]=_*o-d*r,e[5]=_*h-d*n,e[6]=l,e[7]=c,e[8]=u,e},ye=function(e,t,s){var i=s[0],r=s[1];return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=r*t[3],e[4]=r*t[4],e[5]=r*t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e},Ie=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e},Te=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=-s,e[4]=i,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},Ce=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e},be=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e},xe=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=s+s,o=i+i,h=r+r,l=s*a,c=i*a,u=i*o,d=r*a,_=r*o,p=r*h,f=n*a,m=n*o,g=n*h;return e[0]=1-u-p,e[3]=c-g,e[6]=d+m,e[1]=c+g,e[4]=1-l-p,e[7]=_-f,e[2]=d-m,e[5]=_+f,e[8]=1-l-u,e},we=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=t[9],d=t[10],_=t[11],p=t[12],f=t[13],m=t[14],g=t[15],S=s*o-i*a,G=s*h-r*a,y=s*l-n*a,I=i*h-r*o,T=i*l-n*o,C=r*l-n*h,b=c*f-u*p,x=c*m-d*p,w=c*g-_*p,P=u*m-d*f,R=u*g-_*f,v=d*g-_*m,A=S*v-G*R+y*P+I*w-T*x+C*b;return A?(A=1/A,e[0]=(o*v-h*R+l*P)*A,e[1]=(h*w-a*v-l*x)*A,e[2]=(a*R-o*w+l*b)*A,e[3]=(r*R-i*v-n*P)*A,e[4]=(s*v-r*w+n*x)*A,e[5]=(i*w-s*R-n*b)*A,e[6]=(f*C-m*T+g*I)*A,e[7]=(m*y-p*C-g*G)*A,e[8]=(p*T-f*y+g*S)*A,e):null},Pe=function(e,t,s){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/s,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e},Re=function(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"},ve=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8])},Ae=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e[4]=t[4]+s[4],e[5]=t[5]+s[5],e[6]=t[6]+s[6],e[7]=t[7]+s[7],e[8]=t[8]+s[8],e},Me=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e[3]=t[3]-s[3],e[4]=t[4]-s[4],e[5]=t[5]-s[5],e[6]=t[6]-s[6],e[7]=t[7]-s[7],e[8]=t[8]-s[8],e},De=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*s,e},Ee=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e[3]=t[3]+s[3]*i,e[4]=t[4]+s[4]*i,e[5]=t[5]+s[5]*i,e[6]=t[6]+s[6]*i,e[7]=t[7]+s[7]*i,e[8]=t[8]+s[8]*i,e},Fe=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},Oe=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8],u=t[0],d=t[1],_=t[2],p=t[3],f=t[4],m=t[5],g=t[6],S=t[7],G=t[8];return Math.abs(s-u)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(u))&&Math.abs(i-d)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(d))&&Math.abs(r-_)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(_))&&Math.abs(n-p)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(p))&&Math.abs(a-f)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(f))&&Math.abs(o-m)<=EPSILON*Math.max(1,Math.abs(o),Math.abs(m))&&Math.abs(h-g)<=EPSILON*Math.max(1,Math.abs(h),Math.abs(g))&&Math.abs(l-S)<=EPSILON*Math.max(1,Math.abs(l),Math.abs(S))&&Math.abs(c-G)<=EPSILON*Math.max(1,Math.abs(c),Math.abs(G))},Be=function(){var e=new ARRAY_TYPE(16);return ARRAY_TYPE!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e},ke=function(e){var t=new ARRAY_TYPE(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t},Le=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},Ne=function(e,t,s,i,r,n,a,o,h,l,c,u,d,_,p,f){var m=new ARRAY_TYPE(16);return m[0]=e,m[1]=t,m[2]=s,m[3]=i,m[4]=r,m[5]=n,m[6]=a,m[7]=o,m[8]=h,m[9]=l,m[10]=c,m[11]=u,m[12]=d,m[13]=_,m[14]=p,m[15]=f,m},We=function(e,t,s,i,r,n,a,o,h,l,c,u,d,_,p,f,m){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e[4]=n,e[5]=a,e[6]=o,e[7]=h,e[8]=l,e[9]=c,e[10]=u,e[11]=d,e[12]=_,e[13]=p,e[14]=f,e[15]=m,e},Ue=function(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},Ve=function(e,t){if(e===t){var s=t[1],i=t[2],r=t[3],n=t[6],a=t[7],o=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=s,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=n,e[11]=t[14],e[12]=r,e[13]=a,e[14]=o}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e},He=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=t[9],d=t[10],_=t[11],p=t[12],f=t[13],m=t[14],g=t[15],S=s*o-i*a,G=s*h-r*a,y=s*l-n*a,I=i*h-r*o,T=i*l-n*o,C=r*l-n*h,b=c*f-u*p,x=c*m-d*p,w=c*g-_*p,P=u*m-d*f,R=u*g-_*f,v=d*g-_*m,A=S*v-G*R+y*P+I*w-T*x+C*b;return A?(A=1/A,e[0]=(o*v-h*R+l*P)*A,e[1]=(r*R-i*v-n*P)*A,e[2]=(f*C-m*T+g*I)*A,e[3]=(d*T-u*C-_*I)*A,e[4]=(h*w-a*v-l*x)*A,e[5]=(s*v-r*w+n*x)*A,e[6]=(m*y-p*C-g*G)*A,e[7]=(c*C-d*y+_*G)*A,e[8]=(a*R-o*w+l*b)*A,e[9]=(i*w-s*R-n*b)*A,e[10]=(p*T-f*y+g*S)*A,e[11]=(u*y-c*T-_*S)*A,e[12]=(o*x-a*P-h*b)*A,e[13]=(s*P-i*x+r*b)*A,e[14]=(f*G-p*I-m*S)*A,e[15]=(c*I-u*G+d*S)*A,e):null},je=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],u=t[9],d=t[10],_=t[11],p=t[12],f=t[13],m=t[14],g=t[15],S=s*o-i*a,G=s*h-r*a,y=s*l-n*a,I=i*h-r*o,T=i*l-n*o,C=r*l-n*h,b=c*f-u*p,x=c*m-d*p,w=c*g-_*p,P=u*m-d*f,R=u*g-_*f,v=d*g-_*m;return e[0]=o*v-h*R+l*P,e[1]=r*R-i*v-n*P,e[2]=f*C-m*T+g*I,e[3]=d*T-u*C-_*I,e[4]=h*w-a*v-l*x,e[5]=s*v-r*w+n*x,e[6]=m*y-p*C-g*G,e[7]=c*C-d*y+_*G,e[8]=a*R-o*w+l*b,e[9]=i*w-s*R-n*b,e[10]=p*T-f*y+g*S,e[11]=u*y-c*T-_*S,e[12]=o*x-a*P-h*b,e[13]=s*P-i*x+r*b,e[14]=f*G-p*I-m*S,e[15]=c*I-u*G+d*S,e},ze=function(e){var t=e[0],s=e[1],i=e[2],r=e[3],n=e[4],a=e[5],o=e[6],h=e[7],l=e[8],c=e[9],u=e[10],d=e[11],_=e[12],p=e[13],f=e[14],m=t*a-s*n,g=t*o-i*n,S=s*o-i*a,G=l*p-c*_,y=l*f-u*_,I=c*f-u*p;return h*(t*I-s*y+i*G)-r*(n*I-a*y+o*G)+e[15]*(l*S-c*g+u*m)-d*(_*S-p*g+f*m)},Xe=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=t[8],d=t[9],_=t[10],p=t[11],f=t[12],m=t[13],g=t[14],S=t[15],G=s[0],y=s[1],I=s[2],T=s[3];return e[0]=G*i+y*o+I*u+T*f,e[1]=G*r+y*h+I*d+T*m,e[2]=G*n+y*l+I*_+T*g,e[3]=G*a+y*c+I*p+T*S,G=s[4],y=s[5],I=s[6],T=s[7],e[4]=G*i+y*o+I*u+T*f,e[5]=G*r+y*h+I*d+T*m,e[6]=G*n+y*l+I*_+T*g,e[7]=G*a+y*c+I*p+T*S,G=s[8],y=s[9],I=s[10],T=s[11],e[8]=G*i+y*o+I*u+T*f,e[9]=G*r+y*h+I*d+T*m,e[10]=G*n+y*l+I*_+T*g,e[11]=G*a+y*c+I*p+T*S,G=s[12],y=s[13],I=s[14],T=s[15],e[12]=G*i+y*o+I*u+T*f,e[13]=G*r+y*h+I*d+T*m,e[14]=G*n+y*l+I*_+T*g,e[15]=G*a+y*c+I*p+T*S,e},Ye=function(e,t,s){var i,r,n,a,o,h,l,c,u,d,_,p,f=s[0],m=s[1],g=s[2];return t===e?(e[12]=t[0]*f+t[4]*m+t[8]*g+t[12],e[13]=t[1]*f+t[5]*m+t[9]*g+t[13],e[14]=t[2]*f+t[6]*m+t[10]*g+t[14],e[15]=t[3]*f+t[7]*m+t[11]*g+t[15]):(i=t[0],r=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=t[8],d=t[9],_=t[10],p=t[11],e[0]=i,e[1]=r,e[2]=n,e[3]=a,e[4]=o,e[5]=h,e[6]=l,e[7]=c,e[8]=u,e[9]=d,e[10]=_,e[11]=p,e[12]=i*f+o*m+u*g+t[12],e[13]=r*f+h*m+d*g+t[13],e[14]=n*f+l*m+_*g+t[14],e[15]=a*f+c*m+p*g+t[15]),e},qe=function(e,t,s){var i=s[0],r=s[1],n=s[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e},Ke=function(e,t,s,i){var r,n,a,o,h,l,c,u,d,_,p,f,m,g,S,G,y,I,T,C,b,x,w,P,R=i[0],v=i[1],A=i[2],M=Math.hypot(R,v,A);return M<EPSILON?null:(R*=M=1/M,v*=M,A*=M,r=Math.sin(s),a=1-(n=Math.cos(s)),o=t[0],h=t[1],l=t[2],c=t[3],u=t[4],d=t[5],_=t[6],p=t[7],f=t[8],m=t[9],g=t[10],S=t[11],G=R*R*a+n,y=v*R*a+A*r,I=A*R*a-v*r,T=R*v*a-A*r,C=v*v*a+n,b=A*v*a+R*r,x=R*A*a+v*r,w=v*A*a-R*r,P=A*A*a+n,e[0]=o*G+u*y+f*I,e[1]=h*G+d*y+m*I,e[2]=l*G+_*y+g*I,e[3]=c*G+p*y+S*I,e[4]=o*T+u*C+f*b,e[5]=h*T+d*C+m*b,e[6]=l*T+_*C+g*b,e[7]=c*T+p*C+S*b,e[8]=o*x+u*w+f*P,e[9]=h*x+d*w+m*P,e[10]=l*x+_*w+g*P,e[11]=c*x+p*w+S*P,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)},$e=function(e,t,s){var i=Math.sin(s),r=Math.cos(s),n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=t[9],u=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*r+l*i,e[5]=a*r+c*i,e[6]=o*r+u*i,e[7]=h*r+d*i,e[8]=l*r-n*i,e[9]=c*r-a*i,e[10]=u*r-o*i,e[11]=d*r-h*i,e},Je=function(e,t,s){var i=Math.sin(s),r=Math.cos(s),n=t[0],a=t[1],o=t[2],h=t[3],l=t[8],c=t[9],u=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*r-l*i,e[1]=a*r-c*i,e[2]=o*r-u*i,e[3]=h*r-d*i,e[8]=n*i+l*r,e[9]=a*i+c*r,e[10]=o*i+u*r,e[11]=h*i+d*r,e},Ze=function(e,t,s){var i=Math.sin(s),r=Math.cos(s),n=t[0],a=t[1],o=t[2],h=t[3],l=t[4],c=t[5],u=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*r+l*i,e[1]=a*r+c*i,e[2]=o*r+u*i,e[3]=h*r+d*i,e[4]=l*r-n*i,e[5]=c*r-a*i,e[6]=u*r-o*i,e[7]=d*r-h*i,e},Qe=function(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e},et=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},tt=function(e,t,s){var i,r,n,a=s[0],o=s[1],h=s[2],l=Math.hypot(a,o,h);return l<EPSILON?null:(a*=l=1/l,o*=l,h*=l,i=Math.sin(t),n=1-(r=Math.cos(t)),e[0]=a*a*n+r,e[1]=o*a*n+h*i,e[2]=h*a*n-o*i,e[3]=0,e[4]=a*o*n-h*i,e[5]=o*o*n+r,e[6]=h*o*n+a*i,e[7]=0,e[8]=a*h*n+o*i,e[9]=o*h*n-a*i,e[10]=h*h*n+r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)},st=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=i,e[6]=s,e[7]=0,e[8]=0,e[9]=-s,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},it=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=0,e[2]=-s,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=s,e[9]=0,e[10]=i,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},rt=function(e,t){var s=Math.sin(t),i=Math.cos(t);return e[0]=i,e[1]=s,e[2]=0,e[3]=0,e[4]=-s,e[5]=i,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},nt=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=i+i,h=r+r,l=n+n,c=i*o,u=i*h,d=i*l,_=r*h,p=r*l,f=n*l,m=a*o,g=a*h,S=a*l;return e[0]=1-(_+f),e[1]=u+S,e[2]=d-g,e[3]=0,e[4]=u-S,e[5]=1-(c+f),e[6]=p+m,e[7]=0,e[8]=d+g,e[9]=p-m,e[10]=1-(c+_),e[11]=0,e[12]=s[0],e[13]=s[1],e[14]=s[2],e[15]=1,e},at=function(e,t){var s=new ARRAY_TYPE(3),i=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=i*i+r*r+n*n+a*a;return u>0?(s[0]=2*(o*a+c*i+h*n-l*r)/u,s[1]=2*(h*a+c*r+l*i-o*n)/u,s[2]=2*(l*a+c*n+o*r-h*i)/u):(s[0]=2*(o*a+c*i+h*n-l*r),s[1]=2*(h*a+c*r+l*i-o*n),s[2]=2*(l*a+c*n+o*r-h*i)),nt(e,t,s),e},ot=function(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e},ht=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[4],a=t[5],o=t[6],h=t[8],l=t[9],c=t[10];return e[0]=Math.hypot(s,i,r),e[1]=Math.hypot(n,a,o),e[2]=Math.hypot(h,l,c),e},lt=function(e,t){var s=new ARRAY_TYPE(3);ht(s,t);var i=1/s[0],r=1/s[1],n=1/s[2],a=t[0]*i,o=t[1]*r,h=t[2]*n,l=t[4]*i,c=t[5]*r,u=t[6]*n,d=t[8]*i,_=t[9]*r,p=t[10]*n,f=a+c+p,m=0;return f>0?(m=2*Math.sqrt(f+1),e[3]=.25*m,e[0]=(u-_)/m,e[1]=(d-h)/m,e[2]=(o-l)/m):a>c&&a>p?(m=2*Math.sqrt(1+a-c-p),e[3]=(u-_)/m,e[0]=.25*m,e[1]=(o+l)/m,e[2]=(d+h)/m):c>p?(m=2*Math.sqrt(1+c-a-p),e[3]=(d-h)/m,e[0]=(o+l)/m,e[1]=.25*m,e[2]=(u+_)/m):(m=2*Math.sqrt(1+p-a-c),e[3]=(o-l)/m,e[0]=(d+h)/m,e[1]=(u+_)/m,e[2]=.25*m),e},ct=function(e,t,s,i){t[0]=i[12],t[1]=i[13],t[2]=i[14];var r=i[0],n=i[1],a=i[2],o=i[4],h=i[5],l=i[6],c=i[8],u=i[9],d=i[10];s[0]=Math.hypot(r,n,a),s[1]=Math.hypot(o,h,l),s[2]=Math.hypot(c,u,d);var _=1/s[0],p=1/s[1],f=1/s[2],m=r*_,g=n*p,S=a*f,G=o*_,y=h*p,I=l*f,T=c*_,C=u*p,b=d*f,x=m+y+b,w=0;return x>0?(w=2*Math.sqrt(x+1),e[3]=.25*w,e[0]=(I-C)/w,e[1]=(T-S)/w,e[2]=(g-G)/w):m>y&&m>b?(w=2*Math.sqrt(1+m-y-b),e[3]=(I-C)/w,e[0]=.25*w,e[1]=(g+G)/w,e[2]=(T+S)/w):y>b?(w=2*Math.sqrt(1+y-m-b),e[3]=(T-S)/w,e[0]=(g+G)/w,e[1]=.25*w,e[2]=(I+C)/w):(w=2*Math.sqrt(1+b-m-y),e[3]=(g-G)/w,e[0]=(T+S)/w,e[1]=(I+C)/w,e[2]=.25*w),e},ut=function(e,t,s,i){var r=t[0],n=t[1],a=t[2],o=t[3],h=r+r,l=n+n,c=a+a,u=r*h,d=r*l,_=r*c,p=n*l,f=n*c,m=a*c,g=o*h,S=o*l,G=o*c,y=i[0],I=i[1],T=i[2];return e[0]=(1-(p+m))*y,e[1]=(d+G)*y,e[2]=(_-S)*y,e[3]=0,e[4]=(d-G)*I,e[5]=(1-(u+m))*I,e[6]=(f+g)*I,e[7]=0,e[8]=(_+S)*T,e[9]=(f-g)*T,e[10]=(1-(u+p))*T,e[11]=0,e[12]=s[0],e[13]=s[1],e[14]=s[2],e[15]=1,e},dt=function(e,t,s,i,r){var n=t[0],a=t[1],o=t[2],h=t[3],l=n+n,c=a+a,u=o+o,d=n*l,_=n*c,p=n*u,f=a*c,m=a*u,g=o*u,S=h*l,G=h*c,y=h*u,I=i[0],T=i[1],C=i[2],b=r[0],x=r[1],w=r[2],P=(1-(f+g))*I,R=(_+y)*I,v=(p-G)*I,A=(_-y)*T,M=(1-(d+g))*T,D=(m+S)*T,E=(p+G)*C,F=(m-S)*C,O=(1-(d+f))*C;return e[0]=P,e[1]=R,e[2]=v,e[3]=0,e[4]=A,e[5]=M,e[6]=D,e[7]=0,e[8]=E,e[9]=F,e[10]=O,e[11]=0,e[12]=s[0]+b-(P*b+A*x+E*w),e[13]=s[1]+x-(R*b+M*x+F*w),e[14]=s[2]+w-(v*b+D*x+O*w),e[15]=1,e},_t=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=s+s,o=i+i,h=r+r,l=s*a,c=i*a,u=i*o,d=r*a,_=r*o,p=r*h,f=n*a,m=n*o,g=n*h;return e[0]=1-u-p,e[1]=c+g,e[2]=d-m,e[3]=0,e[4]=c-g,e[5]=1-l-p,e[6]=_+f,e[7]=0,e[8]=d+m,e[9]=_-f,e[10]=1-l-u,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e},pt=function(e,t,s,i,r,n,a){var o=1/(s-t),h=1/(r-i),l=1/(n-a);return e[0]=2*n*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*n*h,e[6]=0,e[7]=0,e[8]=(s+t)*o,e[9]=(r+i)*h,e[10]=(a+n)*l,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*n*2*l,e[15]=0,e},ft=function(e,t,s,i,r){var n=1/Math.tan(t/2);if(e[0]=n/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0){var a=1/(i-r);e[10]=(r+i)*a,e[14]=2*r*i*a}else e[10]=-1,e[14]=-2*i;return e},mt=function(e,t,s,i,r){var n=1/Math.tan(t/2);if(e[0]=n/s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0){var a=1/(i-r);e[10]=r*a,e[14]=r*i*a}else e[10]=-1,e[14]=-i;return e},gt=function(e,t,s,i){var r=Math.tan(t.upDegrees*Math.PI/180),n=Math.tan(t.downDegrees*Math.PI/180),a=Math.tan(t.leftDegrees*Math.PI/180),o=Math.tan(t.rightDegrees*Math.PI/180),h=2/(a+o),l=2/(r+n);return e[0]=h,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=l,e[6]=0,e[7]=0,e[8]=-(a-o)*h*.5,e[9]=(r-n)*l*.5,e[10]=i/(s-i),e[11]=-1,e[12]=0,e[13]=0,e[14]=i*s/(s-i),e[15]=0,e},St=function(e,t,s,i,r,n,a){var o=1/(t-s),h=1/(i-r),l=1/(n-a);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*h,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*l,e[11]=0,e[12]=(t+s)*o,e[13]=(r+i)*h,e[14]=(a+n)*l,e[15]=1,e},Gt=function(e,t,s,i,r,n,a){var o=1/(t-s),h=1/(i-r),l=1/(n-a);return e[0]=-2*o,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*h,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=l,e[11]=0,e[12]=(t+s)*o,e[13]=(r+i)*h,e[14]=n*l,e[15]=1,e},yt=function(e,t,s,i){var r,n,a,o,h,l,c,u,d,_,p=t[0],f=t[1],m=t[2],g=i[0],S=i[1],G=i[2],y=s[0],I=s[1],T=s[2];return Math.abs(p-y)<EPSILON&&Math.abs(f-I)<EPSILON&&Math.abs(m-T)<EPSILON?Ue(e):(c=p-y,u=f-I,d=m-T,r=S*(d*=_=1/Math.hypot(c,u,d))-G*(u*=_),n=G*(c*=_)-g*d,a=g*u-S*c,(_=Math.hypot(r,n,a))?(r*=_=1/_,n*=_,a*=_):(r=0,n=0,a=0),o=u*a-d*n,h=d*r-c*a,l=c*n-u*r,(_=Math.hypot(o,h,l))?(o*=_=1/_,h*=_,l*=_):(o=0,h=0,l=0),e[0]=r,e[1]=o,e[2]=c,e[3]=0,e[4]=n,e[5]=h,e[6]=u,e[7]=0,e[8]=a,e[9]=l,e[10]=d,e[11]=0,e[12]=-(r*p+n*f+a*m),e[13]=-(o*p+h*f+l*m),e[14]=-(c*p+u*f+d*m),e[15]=1,e)},It=function(e,t,s,i){var r=t[0],n=t[1],a=t[2],o=i[0],h=i[1],l=i[2],c=r-s[0],u=n-s[1],d=a-s[2],_=c*c+u*u+d*d;_>0&&(c*=_=1/Math.sqrt(_),u*=_,d*=_);var p=h*d-l*u,f=l*c-o*d,m=o*u-h*c;return(_=p*p+f*f+m*m)>0&&(p*=_=1/Math.sqrt(_),f*=_,m*=_),e[0]=p,e[1]=f,e[2]=m,e[3]=0,e[4]=u*m-d*f,e[5]=d*p-c*m,e[6]=c*f-u*p,e[7]=0,e[8]=c,e[9]=u,e[10]=d,e[11]=0,e[12]=r,e[13]=n,e[14]=a,e[15]=1,e},Tt=function(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"},Ct=function(e){return Math.hypot(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15])},bt=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e[4]=t[4]+s[4],e[5]=t[5]+s[5],e[6]=t[6]+s[6],e[7]=t[7]+s[7],e[8]=t[8]+s[8],e[9]=t[9]+s[9],e[10]=t[10]+s[10],e[11]=t[11]+s[11],e[12]=t[12]+s[12],e[13]=t[13]+s[13],e[14]=t[14]+s[14],e[15]=t[15]+s[15],e},xt=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e[3]=t[3]-s[3],e[4]=t[4]-s[4],e[5]=t[5]-s[5],e[6]=t[6]-s[6],e[7]=t[7]-s[7],e[8]=t[8]-s[8],e[9]=t[9]-s[9],e[10]=t[10]-s[10],e[11]=t[11]-s[11],e[12]=t[12]-s[12],e[13]=t[13]-s[13],e[14]=t[14]-s[14],e[15]=t[15]-s[15],e},wt=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*s,e[9]=t[9]*s,e[10]=t[10]*s,e[11]=t[11]*s,e[12]=t[12]*s,e[13]=t[13]*s,e[14]=t[14]*s,e[15]=t[15]*s,e},Pt=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e[3]=t[3]+s[3]*i,e[4]=t[4]+s[4]*i,e[5]=t[5]+s[5]*i,e[6]=t[6]+s[6]*i,e[7]=t[7]+s[7]*i,e[8]=t[8]+s[8]*i,e[9]=t[9]+s[9]*i,e[10]=t[10]+s[10]*i,e[11]=t[11]+s[11]*i,e[12]=t[12]+s[12]*i,e[13]=t[13]+s[13]*i,e[14]=t[14]+s[14]*i,e[15]=t[15]+s[15]*i,e},Rt=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},vt=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8],u=e[9],d=e[10],_=e[11],p=e[12],f=e[13],m=e[14],g=e[15],S=t[0],G=t[1],y=t[2],I=t[3],T=t[4],C=t[5],b=t[6],x=t[7],w=t[8],P=t[9],R=t[10],v=t[11],A=t[12],M=t[13],D=t[14],E=t[15];return Math.abs(s-S)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(S))&&Math.abs(i-G)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(G))&&Math.abs(r-y)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(n-I)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(I))&&Math.abs(a-T)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(T))&&Math.abs(o-C)<=EPSILON*Math.max(1,Math.abs(o),Math.abs(C))&&Math.abs(h-b)<=EPSILON*Math.max(1,Math.abs(h),Math.abs(b))&&Math.abs(l-x)<=EPSILON*Math.max(1,Math.abs(l),Math.abs(x))&&Math.abs(c-w)<=EPSILON*Math.max(1,Math.abs(c),Math.abs(w))&&Math.abs(u-P)<=EPSILON*Math.max(1,Math.abs(u),Math.abs(P))&&Math.abs(d-R)<=EPSILON*Math.max(1,Math.abs(d),Math.abs(R))&&Math.abs(_-v)<=EPSILON*Math.max(1,Math.abs(_),Math.abs(v))&&Math.abs(p-A)<=EPSILON*Math.max(1,Math.abs(p),Math.abs(A))&&Math.abs(f-M)<=EPSILON*Math.max(1,Math.abs(f),Math.abs(M))&&Math.abs(m-D)<=EPSILON*Math.max(1,Math.abs(m),Math.abs(D))&&Math.abs(g-E)<=EPSILON*Math.max(1,Math.abs(g),Math.abs(E))},At=function(){var e=new ARRAY_TYPE(3);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e},Mt=function(e){var t=new ARRAY_TYPE(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t},Dt=function(e){var t=e[0],s=e[1],i=e[2];return Math.hypot(t,s,i)},Et=function(e,t,s){var i=new ARRAY_TYPE(3);return i[0]=e,i[1]=t,i[2]=s,i},Ft=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e},Ot=function(e,t,s,i){return e[0]=t,e[1]=s,e[2]=i,e},Bt=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e},kt=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e},Lt=function(e,t,s){return e[0]=t[0]*s[0],e[1]=t[1]*s[1],e[2]=t[2]*s[2],e},Nt=function(e,t,s){return e[0]=t[0]/s[0],e[1]=t[1]/s[1],e[2]=t[2]/s[2],e},Wt=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e},Ut=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e},Vt=function(e,t,s){return e[0]=Math.min(t[0],s[0]),e[1]=Math.min(t[1],s[1]),e[2]=Math.min(t[2],s[2]),e},Ht=function(e,t,s){return e[0]=Math.max(t[0],s[0]),e[1]=Math.max(t[1],s[1]),e[2]=Math.max(t[2],s[2]),e},jt=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e},zt=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e},Xt=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e},Yt=function(e,t){var s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2];return Math.hypot(s,i,r)},qt=function(e,t){var s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2];return s*s+i*i+r*r},Kt=function(e){var t=e[0],s=e[1],i=e[2];return t*t+s*s+i*i},$t=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e},Jt=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e},Zt=function(e,t){var s=t[0],i=t[1],r=t[2],n=s*s+i*i+r*r;return n>0&&(n=1/Math.sqrt(n)),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e},Qt=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]},es=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=s[0],o=s[1],h=s[2];return e[0]=r*h-n*o,e[1]=n*a-i*h,e[2]=i*o-r*a,e},ts=function(e,t,s,i){var r=t[0],n=t[1],a=t[2];return e[0]=r+i*(s[0]-r),e[1]=n+i*(s[1]-n),e[2]=a+i*(s[2]-a),e},ss=function(e,t,s,i){var r=Math.acos(Math.min(Math.max(Qt(t,s),-1),1)),n=Math.sin(r),a=Math.sin((1-i)*r)/n,o=Math.sin(i*r)/n;return e[0]=a*t[0]+o*s[0],e[1]=a*t[1]+o*s[1],e[2]=a*t[2]+o*s[2],e},is=function(e,t,s,i,r,n){var a=n*n,o=a*(2*n-3)+1,h=a*(n-2)+n,l=a*(n-1),c=a*(3-2*n);return e[0]=t[0]*o+s[0]*h+i[0]*l+r[0]*c,e[1]=t[1]*o+s[1]*h+i[1]*l+r[1]*c,e[2]=t[2]*o+s[2]*h+i[2]*l+r[2]*c,e},rs=function(e,t,s,i,r,n){var a=1-n,o=a*a,h=n*n,l=o*a,c=3*n*o,u=3*h*a,d=h*n;return e[0]=t[0]*l+s[0]*c+i[0]*u+r[0]*d,e[1]=t[1]*l+s[1]*c+i[1]*u+r[1]*d,e[2]=t[2]*l+s[2]*c+i[2]*u+r[2]*d,e},ns=function(e,t){t=t||1;var s=2*RANDOM()*Math.PI,i=2*RANDOM()-1,r=Math.sqrt(1-i*i)*t;return e[0]=Math.cos(s)*r,e[1]=Math.sin(s)*r,e[2]=i*t,e},as=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=s[3]*i+s[7]*r+s[11]*n+s[15];return a=a||1,e[0]=(s[0]*i+s[4]*r+s[8]*n+s[12])/a,e[1]=(s[1]*i+s[5]*r+s[9]*n+s[13])/a,e[2]=(s[2]*i+s[6]*r+s[10]*n+s[14])/a,e},os=function(e,t,s){var i=t[0],r=t[1],n=t[2];return e[0]=i*s[0]+r*s[3]+n*s[6],e[1]=i*s[1]+r*s[4]+n*s[7],e[2]=i*s[2]+r*s[5]+n*s[8],e},hs=function(e,t,s){var i=s[0],r=s[1],n=s[2],a=s[3],o=t[0],h=t[1],l=t[2],c=r*l-n*h,u=n*o-i*l,d=i*h-r*o,_=r*d-n*u,p=n*c-i*d,f=i*u-r*c,m=2*a;return c*=m,u*=m,d*=m,_*=2,p*=2,f*=2,e[0]=o+c+_,e[1]=h+u+p,e[2]=l+d+f,e},ls=function(e,t,s,i){var r=[],n=[];return r[0]=t[0]-s[0],r[1]=t[1]-s[1],r[2]=t[2]-s[2],n[0]=r[0],n[1]=r[1]*Math.cos(i)-r[2]*Math.sin(i),n[2]=r[1]*Math.sin(i)+r[2]*Math.cos(i),e[0]=n[0]+s[0],e[1]=n[1]+s[1],e[2]=n[2]+s[2],e},cs=function(e,t,s,i){var r=[],n=[];return r[0]=t[0]-s[0],r[1]=t[1]-s[1],r[2]=t[2]-s[2],n[0]=r[2]*Math.sin(i)+r[0]*Math.cos(i),n[1]=r[1],n[2]=r[2]*Math.cos(i)-r[0]*Math.sin(i),e[0]=n[0]+s[0],e[1]=n[1]+s[1],e[2]=n[2]+s[2],e},us=function(e,t,s,i){var r=[],n=[];return r[0]=t[0]-s[0],r[1]=t[1]-s[1],r[2]=t[2]-s[2],n[0]=r[0]*Math.cos(i)-r[1]*Math.sin(i),n[1]=r[0]*Math.sin(i)+r[1]*Math.cos(i),n[2]=r[2],e[0]=n[0]+s[0],e[1]=n[1]+s[1],e[2]=n[2]+s[2],e},ds=function(e,t){var s=e[0],i=e[1],r=e[2],n=t[0],a=t[1],o=t[2],h=Math.sqrt((s*s+i*i+r*r)*(n*n+a*a+o*o)),l=h&&Qt(e,t)/h;return Math.acos(Math.min(Math.max(l,-1),1))},_s=function(e){return e[0]=0,e[1]=0,e[2]=0,e},ps=function(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"},fs=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]},ms=function(e,t){var s=e[0],i=e[1],r=e[2],n=t[0],a=t[1],o=t[2];return Math.abs(s-n)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(n))&&Math.abs(i-a)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-o)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(o))},gs=function(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e},Ss=function(e){var t=new ARRAY_TYPE(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},Gs=function(e,t,s,i){var r=new ARRAY_TYPE(4);return r[0]=e,r[1]=t,r[2]=s,r[3]=i,r},ys=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},Is=function(e,t,s,i,r){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e},Ts=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e},Cs=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e[2]=t[2]-s[2],e[3]=t[3]-s[3],e},bs=function(e,t,s){return e[0]=t[0]*s[0],e[1]=t[1]*s[1],e[2]=t[2]*s[2],e[3]=t[3]*s[3],e},xs=function(e,t,s){return e[0]=t[0]/s[0],e[1]=t[1]/s[1],e[2]=t[2]/s[2],e[3]=t[3]/s[3],e},ws=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e},Ps=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e},Rs=function(e,t,s){return e[0]=Math.min(t[0],s[0]),e[1]=Math.min(t[1],s[1]),e[2]=Math.min(t[2],s[2]),e[3]=Math.min(t[3],s[3]),e},vs=function(e,t,s){return e[0]=Math.max(t[0],s[0]),e[1]=Math.max(t[1],s[1]),e[2]=Math.max(t[2],s[2]),e[3]=Math.max(t[3],s[3]),e},As=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e},Ms=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e},Ds=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e[2]=t[2]+s[2]*i,e[3]=t[3]+s[3]*i,e},Es=function(e,t){var s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2],n=t[3]-e[3];return Math.hypot(s,i,r,n)},Fs=function(e,t){var s=t[0]-e[0],i=t[1]-e[1],r=t[2]-e[2],n=t[3]-e[3];return s*s+i*i+r*r+n*n},Os=function(e){var t=e[0],s=e[1],i=e[2],r=e[3];return Math.hypot(t,s,i,r)},Bs=function(e){var t=e[0],s=e[1],i=e[2],r=e[3];return t*t+s*s+i*i+r*r},ks=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e},Ls=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e},Ns=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=s*s+i*i+r*r+n*n;return a>0&&(a=1/Math.sqrt(a)),e[0]=s*a,e[1]=i*a,e[2]=r*a,e[3]=n*a,e},Ws=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]},Us=function(e,t,s,i){var r=s[0]*i[1]-s[1]*i[0],n=s[0]*i[2]-s[2]*i[0],a=s[0]*i[3]-s[3]*i[0],o=s[1]*i[2]-s[2]*i[1],h=s[1]*i[3]-s[3]*i[1],l=s[2]*i[3]-s[3]*i[2],c=t[0],u=t[1],d=t[2],_=t[3];return e[0]=u*l-d*h+_*o,e[1]=-c*l+d*a-_*n,e[2]=c*h-u*a+_*r,e[3]=-c*o+u*n-d*r,e},Vs=function(e,t,s,i){var r=t[0],n=t[1],a=t[2],o=t[3];return e[0]=r+i*(s[0]-r),e[1]=n+i*(s[1]-n),e[2]=a+i*(s[2]-a),e[3]=o+i*(s[3]-o),e},Hs=function(e,t){var s,i,r,n,a,o;t=t||1;do{a=(s=2*RANDOM()-1)*s+(i=2*RANDOM()-1)*i}while(a>=1);do{o=(r=2*RANDOM()-1)*r+(n=2*RANDOM()-1)*n}while(o>=1);var h=Math.sqrt((1-a)/o);return e[0]=t*s,e[1]=t*i,e[2]=t*r*h,e[3]=t*n*h,e},js=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3];return e[0]=s[0]*i+s[4]*r+s[8]*n+s[12]*a,e[1]=s[1]*i+s[5]*r+s[9]*n+s[13]*a,e[2]=s[2]*i+s[6]*r+s[10]*n+s[14]*a,e[3]=s[3]*i+s[7]*r+s[11]*n+s[15]*a,e},zs=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=s[0],o=s[1],h=s[2],l=s[3],c=l*i+o*n-h*r,u=l*r+h*i-a*n,d=l*n+a*r-o*i,_=-a*i-o*r-h*n;return e[0]=c*l+_*-a+u*-h-d*-o,e[1]=u*l+_*-o+d*-a-c*-h,e[2]=d*l+_*-h+c*-o-u*-a,e[3]=t[3],e},Xs=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=0,e},Ys=function(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},qs=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]},Ks=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=t[0],o=t[1],h=t[2],l=t[3];return Math.abs(s-a)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(a))&&Math.abs(i-o)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-h)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(h))&&Math.abs(n-l)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(l))},$s=function(){var e=new ARRAY_TYPE(4);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e},Js=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e},Zs=function(e,t,s){s*=.5;var i=Math.sin(s);return e[0]=i*t[0],e[1]=i*t[1],e[2]=i*t[2],e[3]=Math.cos(s),e},Qs=function(e,t){var s=2*Math.acos(t[3]),i=Math.sin(s/2);return i>EPSILON?(e[0]=t[0]/i,e[1]=t[1]/i,e[2]=t[2]/i):(e[0]=1,e[1]=0,e[2]=0),s},ei=function(e,t){var s=dot$2(e,t);return Math.acos(2*s*s-1)},ti=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[0],h=s[1],l=s[2],c=s[3];return e[0]=i*c+a*o+r*l-n*h,e[1]=r*c+a*h+n*o-i*l,e[2]=n*c+a*l+i*h-r*o,e[3]=a*c-i*o-r*h-n*l,e},si=function(e,t,s){s*=.5;var i=t[0],r=t[1],n=t[2],a=t[3],o=Math.sin(s),h=Math.cos(s);return e[0]=i*h+a*o,e[1]=r*h+n*o,e[2]=n*h-r*o,e[3]=a*h-i*o,e},ii=function(e,t,s){s*=.5;var i=t[0],r=t[1],n=t[2],a=t[3],o=Math.sin(s),h=Math.cos(s);return e[0]=i*h-n*o,e[1]=r*h+a*o,e[2]=n*h+i*o,e[3]=a*h-r*o,e},ri=function(e,t,s){s*=.5;var i=t[0],r=t[1],n=t[2],a=t[3],o=Math.sin(s),h=Math.cos(s);return e[0]=i*h+r*o,e[1]=r*h-i*o,e[2]=n*h+a*o,e[3]=a*h-n*o,e},ni=function(e,t){var s=t[0],i=t[1],r=t[2];return e[0]=s,e[1]=i,e[2]=r,e[3]=Math.sqrt(Math.abs(1-s*s-i*i-r*r)),e},ai=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=Math.sqrt(s*s+i*i+r*r),o=Math.exp(n),h=a>0?o*Math.sin(a)/a:0;return e[0]=s*h,e[1]=i*h,e[2]=r*h,e[3]=o*Math.cos(a),e},oi=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=Math.sqrt(s*s+i*i+r*r),o=a>0?Math.atan2(a,n)/a:0;return e[0]=s*o,e[1]=i*o,e[2]=r*o,e[3]=.5*Math.log(s*s+i*i+r*r+n*n),e},hi=function(e,t,s){return oi(e,t),scale$2(e,e,s),ai(e,e),e},li=function(e,t,s,i){var r,n,a,o,h,l=t[0],c=t[1],u=t[2],d=t[3],_=s[0],p=s[1],f=s[2],m=s[3];return(n=l*_+c*p+u*f+d*m)<0&&(n=-n,_=-_,p=-p,f=-f,m=-m),1-n>EPSILON?(r=Math.acos(n),a=Math.sin(r),o=Math.sin((1-i)*r)/a,h=Math.sin(i*r)/a):(o=1-i,h=i),e[0]=o*l+h*_,e[1]=o*c+h*p,e[2]=o*u+h*f,e[3]=o*d+h*m,e},ci=function(e){var t=RANDOM(),s=RANDOM(),i=RANDOM(),r=Math.sqrt(1-t),n=Math.sqrt(t);return e[0]=r*Math.sin(2*Math.PI*s),e[1]=r*Math.cos(2*Math.PI*s),e[2]=n*Math.sin(2*Math.PI*i),e[3]=n*Math.cos(2*Math.PI*i),e},ui=function(e,t){var s=t[0],i=t[1],r=t[2],n=t[3],a=s*s+i*i+r*r+n*n,o=a?1/a:0;return e[0]=-s*o,e[1]=-i*o,e[2]=-r*o,e[3]=n*o,e},di=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e},_i=function(e,t){var s,i=t[0]+t[4]+t[8];if(i>0)s=Math.sqrt(i+1),e[3]=.5*s,s=.5/s,e[0]=(t[5]-t[7])*s,e[1]=(t[6]-t[2])*s,e[2]=(t[1]-t[3])*s;else{var r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);var n=(r+1)%3,a=(r+2)%3;s=Math.sqrt(t[3*r+r]-t[3*n+n]-t[3*a+a]+1),e[r]=.5*s,s=.5/s,e[3]=(t[3*n+a]-t[3*a+n])*s,e[n]=(t[3*n+r]+t[3*r+n])*s,e[a]=(t[3*a+r]+t[3*r+a])*s}return e},pi=function(e,t,s,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:ANGLE_ORDER,n=Math.PI/360;t*=n,i*=n,s*=n;var a=Math.sin(t),o=Math.cos(t),h=Math.sin(s),l=Math.cos(s),c=Math.sin(i),u=Math.cos(i);switch(r){case"xyz":e[0]=a*l*u+o*h*c,e[1]=o*h*u-a*l*c,e[2]=o*l*c+a*h*u,e[3]=o*l*u-a*h*c;break;case"xzy":e[0]=a*l*u-o*h*c,e[1]=o*h*u-a*l*c,e[2]=o*l*c+a*h*u,e[3]=o*l*u+a*h*c;break;case"yxz":e[0]=a*l*u+o*h*c,e[1]=o*h*u-a*l*c,e[2]=o*l*c-a*h*u,e[3]=o*l*u+a*h*c;break;case"yzx":e[0]=a*l*u+o*h*c,e[1]=o*h*u+a*l*c,e[2]=o*l*c-a*h*u,e[3]=o*l*u-a*h*c;break;case"zxy":e[0]=a*l*u-o*h*c,e[1]=o*h*u+a*l*c,e[2]=o*l*c+a*h*u,e[3]=o*l*u-a*h*c;break;case"zyx":e[0]=a*l*u-o*h*c,e[1]=o*h*u+a*l*c,e[2]=o*l*c-a*h*u,e[3]=o*l*u+a*h*c;break;default:throw new Error("Unknown angle order "+r)}return e},fi=function(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"},mi=function(e,t){return Math.abs(Ws(e,t))>=1-EPSILON},gi=function(){var e=new ARRAY_TYPE(8);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0),e[3]=1,e},Si=function(e){var t=new ARRAY_TYPE(8);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t},Gi=function(e,t,s,i,r,n,a,o){var h=new ARRAY_TYPE(8);return h[0]=e,h[1]=t,h[2]=s,h[3]=i,h[4]=r,h[5]=n,h[6]=a,h[7]=o,h},yi=function(e,t,s,i,r,n,a){var o=new ARRAY_TYPE(8);o[0]=e,o[1]=t,o[2]=s,o[3]=i;var h=.5*r,l=.5*n,c=.5*a;return o[4]=h*i+l*s-c*t,o[5]=l*i+c*e-h*s,o[6]=c*i+h*t-l*e,o[7]=-h*e-l*t-c*s,o},Ii=function(e,t,s){var i=.5*s[0],r=.5*s[1],n=.5*s[2],a=t[0],o=t[1],h=t[2],l=t[3];return e[0]=a,e[1]=o,e[2]=h,e[3]=l,e[4]=i*l+r*h-n*o,e[5]=r*l+n*a-i*h,e[6]=n*l+i*o-r*a,e[7]=-i*a-r*o-n*h,e},Ti=function(e,t){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=.5*t[0],e[5]=.5*t[1],e[6]=.5*t[2],e[7]=0,e},Ci=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},bi=function(e,t){var s=$s();lt(s,t);var i=new ARRAY_TYPE(3);return ot(i,t),Ii(e,s,i),e},xi=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e},wi=function(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e},Pi=function(e,t,s,i,r,n,a,o,h){return e[0]=t,e[1]=s,e[2]=i,e[3]=r,e[4]=n,e[5]=a,e[6]=o,e[7]=h,e},Ri=function(e,t){return e[0]=t[4],e[1]=t[5],e[2]=t[6],e[3]=t[7],e},vi=function(e,t){return e[4]=t[0],e[5]=t[1],e[6]=t[2],e[7]=t[3],e},Ai=function(e,t){var s=t[4],i=t[5],r=t[6],n=t[7],a=-t[0],o=-t[1],h=-t[2],l=t[3];return e[0]=2*(s*l+n*a+i*h-r*o),e[1]=2*(i*l+n*o+r*a-s*h),e[2]=2*(r*l+n*h+s*o-i*a),e},Mi=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=.5*s[0],h=.5*s[1],l=.5*s[2],c=t[4],u=t[5],d=t[6],_=t[7];return e[0]=i,e[1]=r,e[2]=n,e[3]=a,e[4]=a*o+r*l-n*h+c,e[5]=a*h+n*o-i*l+u,e[6]=a*l+i*h-r*o+d,e[7]=-i*o-r*h-n*l+_,e},Di=function(e,t,s){var i=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=o*a+c*i+h*n-l*r,d=h*a+c*r+l*i-o*n,_=l*a+c*n+o*r-h*i,p=c*a-o*i-h*r-l*n;return si(e,t,s),i=e[0],r=e[1],n=e[2],a=e[3],e[4]=u*a+p*i+d*n-_*r,e[5]=d*a+p*r+_*i-u*n,e[6]=_*a+p*n+u*r-d*i,e[7]=p*a-u*i-d*r-_*n,e},Ei=function(e,t,s){var i=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=o*a+c*i+h*n-l*r,d=h*a+c*r+l*i-o*n,_=l*a+c*n+o*r-h*i,p=c*a-o*i-h*r-l*n;return ii(e,t,s),i=e[0],r=e[1],n=e[2],a=e[3],e[4]=u*a+p*i+d*n-_*r,e[5]=d*a+p*r+_*i-u*n,e[6]=_*a+p*n+u*r-d*i,e[7]=p*a-u*i-d*r-_*n,e},Fi=function(e,t,s){var i=-t[0],r=-t[1],n=-t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],u=o*a+c*i+h*n-l*r,d=h*a+c*r+l*i-o*n,_=l*a+c*n+o*r-h*i,p=c*a-o*i-h*r-l*n;return ri(e,t,s),i=e[0],r=e[1],n=e[2],a=e[3],e[4]=u*a+p*i+d*n-_*r,e[5]=d*a+p*r+_*i-u*n,e[6]=_*a+p*n+u*r-d*i,e[7]=p*a-u*i-d*r-_*n,e},Oi=function(e,t,s){var i=s[0],r=s[1],n=s[2],a=s[3],o=t[0],h=t[1],l=t[2],c=t[3];return e[0]=o*a+c*i+h*n-l*r,e[1]=h*a+c*r+l*i-o*n,e[2]=l*a+c*n+o*r-h*i,e[3]=c*a-o*i-h*r-l*n,o=t[4],h=t[5],l=t[6],c=t[7],e[4]=o*a+c*i+h*n-l*r,e[5]=h*a+c*r+l*i-o*n,e[6]=l*a+c*n+o*r-h*i,e[7]=c*a-o*i-h*r-l*n,e},Bi=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[0],h=s[1],l=s[2],c=s[3];return e[0]=i*c+a*o+r*l-n*h,e[1]=r*c+a*h+n*o-i*l,e[2]=n*c+a*l+i*h-r*o,e[3]=a*c-i*o-r*h-n*l,o=s[4],h=s[5],l=s[6],c=s[7],e[4]=i*c+a*o+r*l-n*h,e[5]=r*c+a*h+n*o-i*l,e[6]=n*c+a*l+i*h-r*o,e[7]=a*c-i*o-r*h-n*l,e},ki=function(e,t,s,i){if(Math.abs(i)<EPSILON)return xi(e,t);var r=Math.hypot(s[0],s[1],s[2]);i*=.5;var n=Math.sin(i),a=n*s[0]/r,o=n*s[1]/r,h=n*s[2]/r,l=Math.cos(i),c=t[0],u=t[1],d=t[2],_=t[3];e[0]=c*l+_*a+u*h-d*o,e[1]=u*l+_*o+d*a-c*h,e[2]=d*l+_*h+c*o-u*a,e[3]=_*l-c*a-u*o-d*h;var p=t[4],f=t[5],m=t[6],g=t[7];return e[4]=p*l+g*a+f*h-m*o,e[5]=f*l+g*o+m*a-p*h,e[6]=m*l+g*h+p*o-f*a,e[7]=g*l-p*a-f*o-m*h,e},Li=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e[2]=t[2]+s[2],e[3]=t[3]+s[3],e[4]=t[4]+s[4],e[5]=t[5]+s[5],e[6]=t[6]+s[6],e[7]=t[7]+s[7],e},Ni=function(e,t,s){var i=t[0],r=t[1],n=t[2],a=t[3],o=s[4],h=s[5],l=s[6],c=s[7],u=t[4],d=t[5],_=t[6],p=t[7],f=s[0],m=s[1],g=s[2],S=s[3];return e[0]=i*S+a*f+r*g-n*m,e[1]=r*S+a*m+n*f-i*g,e[2]=n*S+a*g+i*m-r*f,e[3]=a*S-i*f-r*m-n*g,e[4]=i*c+a*o+r*l-n*h+u*S+p*f+d*g-_*m,e[5]=r*c+a*h+n*o-i*l+d*S+p*m+_*f-u*g,e[6]=n*c+a*l+i*h-r*o+_*S+p*g+u*m-d*f,e[7]=a*c-i*o-r*h-n*l+p*S-u*f-d*m-_*g,e},Wi=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e[2]=t[2]*s,e[3]=t[3]*s,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e},Ui=function(e,t,s,i){var r=1-i;return dot$1(t,s)<0&&(i=-i),e[0]=t[0]*r+s[0]*i,e[1]=t[1]*r+s[1]*i,e[2]=t[2]*r+s[2]*i,e[3]=t[3]*r+s[3]*i,e[4]=t[4]*r+s[4]*i,e[5]=t[5]*r+s[5]*i,e[6]=t[6]*r+s[6]*i,e[7]=t[7]*r+s[7]*i,e},Vi=function(e,t){var s=squaredLength$1(t);return e[0]=-t[0]/s,e[1]=-t[1]/s,e[2]=-t[2]/s,e[3]=t[3]/s,e[4]=-t[4]/s,e[5]=-t[5]/s,e[6]=-t[6]/s,e[7]=t[7]/s,e},Hi=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e[4]=-t[4],e[5]=-t[5],e[6]=-t[6],e[7]=t[7],e},ji=function(e,t){var s=squaredLength$1(t);if(s>0){s=Math.sqrt(s);var i=t[0]/s,r=t[1]/s,n=t[2]/s,a=t[3]/s,o=t[4],h=t[5],l=t[6],c=t[7],u=i*o+r*h+n*l+a*c;e[0]=i,e[1]=r,e[2]=n,e[3]=a,e[4]=(o-i*u)/s,e[5]=(h-r*u)/s,e[6]=(l-n*u)/s,e[7]=(c-a*u)/s}return e},zi=function(e){return"quat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+")"},Xi=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]},Yi=function(e,t){var s=e[0],i=e[1],r=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=t[0],u=t[1],d=t[2],_=t[3],p=t[4],f=t[5],m=t[6],g=t[7];return Math.abs(s-c)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(c))&&Math.abs(i-u)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(u))&&Math.abs(r-d)<=EPSILON*Math.max(1,Math.abs(r),Math.abs(d))&&Math.abs(n-_)<=EPSILON*Math.max(1,Math.abs(n),Math.abs(_))&&Math.abs(a-p)<=EPSILON*Math.max(1,Math.abs(a),Math.abs(p))&&Math.abs(o-f)<=EPSILON*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(h-m)<=EPSILON*Math.max(1,Math.abs(h),Math.abs(m))&&Math.abs(l-g)<=EPSILON*Math.max(1,Math.abs(l),Math.abs(g))},qi=function(){var e=new ARRAY_TYPE(2);return ARRAY_TYPE!=Float32Array&&(e[0]=0,e[1]=0),e},Ki=function(e){var t=new ARRAY_TYPE(2);return t[0]=e[0],t[1]=e[1],t},$i=function(e,t){var s=new ARRAY_TYPE(2);return s[0]=e,s[1]=t,s},Ji=function(e,t){return e[0]=t[0],e[1]=t[1],e},Zi=function(e,t,s){return e[0]=t,e[1]=s,e},Qi=function(e,t,s){return e[0]=t[0]+s[0],e[1]=t[1]+s[1],e},er=function(e,t,s){return e[0]=t[0]-s[0],e[1]=t[1]-s[1],e},tr=function(e,t,s){return e[0]=t[0]*s[0],e[1]=t[1]*s[1],e},sr=function(e,t,s){return e[0]=t[0]/s[0],e[1]=t[1]/s[1],e},ir=function(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e},rr=function(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e},nr=function(e,t,s){return e[0]=Math.min(t[0],s[0]),e[1]=Math.min(t[1],s[1]),e},ar=function(e,t,s){return e[0]=Math.max(t[0],s[0]),e[1]=Math.max(t[1],s[1]),e},hr=function(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e},lr=function(e,t,s){return e[0]=t[0]*s,e[1]=t[1]*s,e},cr=function(e,t,s,i){return e[0]=t[0]+s[0]*i,e[1]=t[1]+s[1]*i,e},ur=function(e,t){var s=t[0]-e[0],i=t[1]-e[1];return Math.hypot(s,i)},dr=function(e,t){var s=t[0]-e[0],i=t[1]-e[1];return s*s+i*i},_r=function(e){var t=e[0],s=e[1];return Math.hypot(t,s)},pr=function(e){var t=e[0],s=e[1];return t*t+s*s},fr=function(e,t){return e[0]=-t[0],e[1]=-t[1],e},mr=function(e,t){return e[0]=1/t[0],e[1]=1/t[1],e},gr=function(e,t){var s=t[0],i=t[1],r=s*s+i*i;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e},Sr=function(e,t){return e[0]*t[0]+e[1]*t[1]},Gr=function(e,t,s){var i=t[0]*s[1]-t[1]*s[0];return e[0]=e[1]=0,e[2]=i,e},yr=function(e,t,s,i){var r=t[0],n=t[1];return e[0]=r+i*(s[0]-r),e[1]=n+i*(s[1]-n),e},Ir=function(e,t){t=t||1;var s=2*RANDOM()*Math.PI;return e[0]=Math.cos(s)*t,e[1]=Math.sin(s)*t,e},Tr=function(e,t,s){var i=t[0],r=t[1];return e[0]=s[0]*i+s[2]*r,e[1]=s[1]*i+s[3]*r,e},Cr=function(e,t,s){var i=t[0],r=t[1];return e[0]=s[0]*i+s[2]*r+s[4],e[1]=s[1]*i+s[3]*r+s[5],e},br=function(e,t,s){var i=t[0],r=t[1];return e[0]=s[0]*i+s[3]*r+s[6],e[1]=s[1]*i+s[4]*r+s[7],e},xr=function(e,t,s){var i=t[0],r=t[1];return e[0]=s[0]*i+s[4]*r+s[12],e[1]=s[1]*i+s[5]*r+s[13],e},wr=function(e,t,s,i){var r=t[0]-s[0],n=t[1]-s[1],a=Math.sin(i),o=Math.cos(i);return e[0]=r*o-n*a+s[0],e[1]=r*a+n*o+s[1],e},Pr=function(e,t){var s=e[0],i=e[1],r=t[0],n=t[1],a=Math.sqrt((s*s+i*i)*(r*r+n*n)),o=a&&(s*r+i*n)/a;return Math.acos(Math.min(Math.max(o,-1),1))},Rr=function(e){return e[0]=0,e[1]=0,e},vr=function(e){return"vec2("+e[0]+", "+e[1]+")"},Ar=function(e,t){return e[0]===t[0]&&e[1]===t[1]},Mr=function(e,t){var s=e[0],i=e[1],r=t[0],n=t[1];return Math.abs(s-r)<=EPSILON*Math.max(1,Math.abs(s),Math.abs(r))&&Math.abs(i-n)<=EPSILON*Math.max(1,Math.abs(i),Math.abs(n))};setMatrixArrayType=e,toRadian=n,equals$9=h,create$8=u,clone$8=_,copy$8=p,identity$5=m,fromValues$8=g,set$8=S,transpose$2=G,invert$5=y,adjoint$2=I,determinant$3=T,multiply$8=C,rotate$4=b,scale$8=x,fromRotation$4=w,fromScaling$3=P,str$8=R,frob$3=v,LDU=A,add$8=M,subtract$6=D,exactEquals$8=E,equals$8=F,multiplyScalar$3=O,multiplyScalarAndAdd$3=B,create$7=k,clone$7=L,copy$7=N,identity$4=W,fromValues$7=U,set$7=V,invert$4=H,determinant$2=j,multiply$7=z,rotate$3=X,scale$7=Y,translate$3=q,fromRotation$3=K,fromScaling$2=$,fromTranslation$3=J,str$7=Z,frob$2=Q,add$7=ee,subtract$5=te,multiplyScalar$2=se,multiplyScalarAndAdd$2=ie,exactEquals$7=re,equals$7=ne,create$6=ae,fromMat4$1=oe,clone$6=he,copy$6=le,fromValues$6=ce,set$6=ue,identity$3=de,transpose$1=_e,invert$3=pe,adjoint$1=fe,determinant$1=me,multiply$6=ge,translate$2=Se,rotate$2=Ge,scale$6=ye,fromTranslation$2=Ie,fromRotation$2=Te,fromScaling$1=Ce,fromMat2d=be,fromQuat$1=xe,normalFromMat4=we,projection=Pe,str$6=Re,frob$1=ve,add$6=Ae,subtract$4=Me,multiplyScalar$1=De,multiplyScalarAndAdd$1=Ee,exactEquals$6=Fe,equals$6=Oe,create$5=Be,clone$5=ke,copy$5=Le,fromValues$5=Ne,set$5=We,identity$2=Ue,transpose=Ve,invert$2=He,adjoint=je,determinant=ze,multiply$5=Xe,translate$1=Ye,scale$5=qe,rotate$1=Ke,rotateX$3=$e,rotateY$3=Je,rotateZ$3=Ze,fromTranslation$1=Qe,fromScaling=et,fromRotation$1=tt,fromXRotation=st,fromYRotation=it,fromZRotation=rt,fromRotationTranslation$1=nt,fromQuat2=at,getTranslation$1=ot,getScaling=ht,getRotation=lt,decompose=ct,fromRotationTranslationScale=ut,fromRotationTranslationScaleOrigin=dt,fromQuat=_t,frustum=pt,perspectiveNO=ft,perspectiveZO=mt,perspectiveFromFieldOfView=gt,orthoNO=St,orthoZO=Gt,lookAt=yt,targetTo=It,str$5=Tt,frob=Ct,add$5=bt,subtract$3=xt,multiplyScalar=wt,multiplyScalarAndAdd=Pt,exactEquals$5=Rt,equals$5=vt,create$4=At,clone$4=Mt,length$4=Dt,fromValues$4=Et,copy$4=Ft,set$4=Ot,add$4=Bt,subtract$2=kt,multiply$4=Lt,divide$2=Nt,ceil$2=Wt,floor$2=Ut,min$2=Vt,max$2=Ht,round$2=jt,scale$4=zt,scaleAndAdd$2=Xt,distance$2=Yt,squaredDistance$2=qt,squaredLength$4=Kt,negate$2=$t,inverse$2=Jt,normalize$4=Zt,dot$4=Qt,cross$2=es,lerp$4=ts,slerp$1=ss,hermite=is,bezier=rs,random$3=ns,transformMat4$2=as,transformMat3$1=os,transformQuat$1=hs,rotateX$2=ls,rotateY$2=cs,rotateZ$2=us,angle$1=ds,zero$2=_s,str$4=ps,exactEquals$4=fs,equals$4=ms,create$3=gs,clone$3=Ss,fromValues$3=Gs,copy$3=ys,set$3=Is,add$3=Ts,subtract$1=Cs,multiply$3=bs,divide$1=xs,ceil$1=ws,floor$1=Ps,min$1=Rs,max$1=vs,round$1=As,scale$3=Ms,scaleAndAdd$1=Ds,distance$1=Es,squaredDistance$1=Fs,length$3=Os,squaredLength$3=Bs,negate$1=ks,inverse$1=Ls,normalize$3=Ns,dot$3=Ws,cross$1=Us,lerp$3=Vs,random$2=Hs,transformMat4$1=js,transformQuat=zs,zero$1=Xs,str$3=Ys,exactEquals$3=qs,equals$3=Ks,create$2=$s,identity$1=Js,setAxisAngle=Zs,getAxisAngle=Qs,getAngle=ei,multiply$2=ti,rotateX$1=si,rotateY$1=ii,rotateZ$1=ri,calculateW=ni,exp=ai,ln=oi,pow=hi,slerp=li,random$1=ci,invert$1=ui,conjugate$1=di,fromMat3=_i,fromEuler=pi,str$2=fi,equals$2=mi,create$1=gi,clone$1=Si,fromValues$1=Gi,fromRotationTranslationValues=yi,fromRotationTranslation=Ii,fromTranslation=Ti,fromRotation=Ci,fromMat4=bi,copy$1=xi,identity=wi,set$1=Pi,getDual=Ri,setDual=vi,getTranslation=Ai,translate=Mi,rotateX=Di,rotateY=Ei,rotateZ=Fi,rotateByQuatAppend=Oi,rotateByQuatPrepend=Bi,rotateAroundAxis=ki,add$1=Li,multiply$1=Ni,scale$1=Wi,lerp$1=Ui,invert=Vi,conjugate=Hi,normalize$1=ji,str$1=zi,exactEquals$1=Xi,equals$1=Yi,create=qi,clone=Ki,fromValues=$i,copy=Ji,set=Zi,add=Qi,subtract=er,multiply=tr,divide=sr,ceil=ir,floor=rr,min=nr,max=ar,round=hr,scale=lr,scaleAndAdd=cr,distance=ur,squaredDistance=dr,length=_r,squaredLength=pr,negate=fr,inverse=mr,normalize=gr,dot=Sr,cross=Gr,lerp=yr,random=Ir,transformMat2=Tr,transformMat2d=Cr,transformMat3=br,transformMat4=xr,rotate=wr,angle=Pr,zero=Rr,str=vr,exactEquals=Ar,equals=Mr,EPSILON=1e-6,ARRAY_TYPE="undefined"!=typeof Float32Array?Float32Array:Array,RANDOM=Math.random,ANGLE_ORDER="zyx",degree=Math.PI/180,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),common={__proto__:null,EPSILON:EPSILON,get ARRAY_TYPE(){return ARRAY_TYPE},RANDOM:RANDOM,ANGLE_ORDER:ANGLE_ORDER,setMatrixArrayType:e,toRadian:n,equals:h},mul$8=C,sub$6=D,mat2=Object.freeze({__proto__:null,create:u,clone:_,copy:p,identity:m,fromValues:g,set:S,transpose:G,invert:y,adjoint:I,determinant:T,multiply:C,rotate:b,scale:x,fromRotation:w,fromScaling:P,str:R,frob:v,LDU:A,add:M,subtract:D,exactEquals:E,equals:F,multiplyScalar:O,multiplyScalarAndAdd:B,mul:mul$8,sub:sub$6}),mul$7=z,sub$5=te,mat2d=Object.freeze({__proto__:null,create:k,clone:L,copy:N,identity:W,fromValues:U,set:V,invert:H,determinant:j,multiply:z,rotate:X,scale:Y,translate:q,fromRotation:K,fromScaling:$,fromTranslation:J,str:Z,frob:Q,add:ee,subtract:te,multiplyScalar:se,multiplyScalarAndAdd:ie,exactEquals:re,equals:ne,mul:mul$7,sub:sub$5}),mul$6=ge,sub$4=Me,mat3=Object.freeze({__proto__:null,create:ae,fromMat4:oe,clone:he,copy:le,fromValues:ce,set:ue,identity:de,transpose:_e,invert:pe,adjoint:fe,determinant:me,multiply:ge,translate:Se,rotate:Ge,scale:ye,fromTranslation:Ie,fromRotation:Te,fromScaling:Ce,fromMat2d:be,fromQuat:xe,normalFromMat4:we,projection:Pe,str:Re,frob:ve,add:Ae,subtract:Me,multiplyScalar:De,multiplyScalarAndAdd:Ee,exactEquals:Fe,equals:Oe,mul:mul$6,sub:sub$4}),perspective=ft,ortho=St,mul$5=Xe,sub$3=xt,mat4=Object.freeze({__proto__:null,create:Be,clone:ke,copy:Le,fromValues:Ne,set:We,identity:Ue,transpose:Ve,invert:He,adjoint:je,determinant:ze,multiply:Xe,translate:Ye,scale:qe,rotate:Ke,rotateX:$e,rotateY:Je,rotateZ:Ze,fromTranslation:Qe,fromScaling:et,fromRotation:tt,fromXRotation:st,fromYRotation:it,fromZRotation:rt,fromRotationTranslation:nt,fromQuat2:at,getTranslation:ot,getScaling:ht,getRotation:lt,decompose:ct,fromRotationTranslationScale:ut,fromRotationTranslationScaleOrigin:dt,fromQuat:_t,frustum:pt,perspectiveNO:ft,perspective:perspective,perspectiveZO:mt,perspectiveFromFieldOfView:gt,orthoNO:St,ortho:ortho,orthoZO:Gt,lookAt:yt,targetTo:It,str:Tt,frob:Ct,add:bt,subtract:xt,multiplyScalar:wt,multiplyScalarAndAdd:Pt,exactEquals:Rt,equals:vt,mul:mul$5,sub:sub$3}),sub$2=kt,mul$4=Lt,div$2=Nt,dist$2=Yt,sqrDist$2=qt,len$4=Dt,sqrLen$4=Kt,t=At(),forEach$2=function(e,s,i,r,n,a){var o,h;for(s||(s=3),i||(i=0),h=r?Math.min(r*s+i,e.length):e.length,o=i;o<h;o+=s)t[0]=e[o],t[1]=e[o+1],t[2]=e[o+2],n(t,t,a),e[o]=t[0],e[o+1]=t[1],e[o+2]=t[2];return e},vec3=Object.freeze({__proto__:null,create:At,clone:Mt,length:Dt,fromValues:Et,copy:Ft,set:Ot,add:Bt,subtract:kt,multiply:Lt,divide:Nt,ceil:Wt,floor:Ut,min:Vt,max:Ht,round:jt,scale:zt,scaleAndAdd:Xt,distance:Yt,squaredDistance:qt,squaredLength:Kt,negate:$t,inverse:Jt,normalize:Zt,dot:Qt,cross:es,lerp:ts,slerp:ss,hermite:is,bezier:rs,random:ns,transformMat4:as,transformMat3:os,transformQuat:hs,rotateX:ls,rotateY:cs,rotateZ:us,angle:ds,zero:_s,str:ps,exactEquals:fs,equals:ms,sub:sub$2,mul:mul$4,div:div$2,dist:dist$2,sqrDist:sqrDist$2,len:len$4,sqrLen:sqrLen$4,forEach:forEach$2}),sub$1=Cs,mul$3=bs,div$1=xs,dist$1=Es,sqrDist$1=Fs,len$3=Os,sqrLen$3=Bs,forEach$1=function(){var e=gs();return function(t,s,i,r,n,a){var o,h;for(s||(s=4),i||(i=0),h=r?Math.min(r*s+i,t.length):t.length,o=i;o<h;o+=s)e[0]=t[o],e[1]=t[o+1],e[2]=t[o+2],e[3]=t[o+3],n(e,e,a),t[o]=e[0],t[o+1]=e[1],t[o+2]=e[2],t[o+3]=e[3];return t}}(),vec4=Object.freeze({__proto__:null,create:gs,clone:Ss,fromValues:Gs,copy:ys,set:Is,add:Ts,subtract:Cs,multiply:bs,divide:xs,ceil:ws,floor:Ps,min:Rs,max:vs,round:As,scale:Ms,scaleAndAdd:Ds,distance:Es,squaredDistance:Fs,length:Os,squaredLength:Bs,negate:ks,inverse:Ls,normalize:Ns,dot:Ws,cross:Us,lerp:Vs,random:Hs,transformMat4:js,transformQuat:zs,zero:Xs,str:Ys,exactEquals:qs,equals:Ks,sub:sub$1,mul:mul$3,div:div$1,dist:dist$1,sqrDist:sqrDist$1,len:len$3,sqrLen:sqrLen$3,forEach:forEach$1}),clone$2=Ss,fromValues$2=Gs,copy$2=ys,set$2=Is,add$2=Ts,mul$2=ti,scale$2=Ms,dot$2=Ws,lerp$2=Vs,length$2=Os,len$2=length$2,squaredLength$2=Bs,sqrLen$2=squaredLength$2,normalize$2=Ns,exactEquals$2=qs,rotationTo=function(){var e=At(),t=Et(1,0,0),s=Et(0,1,0);return function(i,r,n){var a=Qt(r,n);return a<-.999999?(es(e,t,r),len$4(e)<1e-6&&es(e,s,r),Zt(e,e),Zs(i,e,Math.PI),i):a>.999999?(i[0]=0,i[1]=0,i[2]=0,i[3]=1,i):(es(e,r,n),i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=1+a,normalize$2(i,i))}}(),sqlerp=function(){var e=$s(),t=$s();return function(s,i,r,n,a,o){return li(e,i,a,o),li(t,r,n,o),li(s,e,t,2*o*(1-o)),s}}(),setAxes=function(){var e=ae();return function(t,s,i,r){return e[0]=i[0],e[3]=i[1],e[6]=i[2],e[1]=r[0],e[4]=r[1],e[7]=r[2],e[2]=-s[0],e[5]=-s[1],e[8]=-s[2],normalize$2(t,_i(t,e))}}(),quat=Object.freeze({__proto__:null,create:$s,identity:Js,setAxisAngle:Zs,getAxisAngle:Qs,getAngle:ei,multiply:ti,rotateX:si,rotateY:ii,rotateZ:ri,calculateW:ni,exp:ai,ln:oi,pow:hi,slerp:li,random:ci,invert:ui,conjugate:di,fromMat3:_i,fromEuler:pi,str:fi,clone:clone$2,fromValues:fromValues$2,copy:copy$2,set:set$2,add:add$2,mul:mul$2,scale:scale$2,dot:dot$2,lerp:lerp$2,length:length$2,len:len$2,squaredLength:squaredLength$2,sqrLen:sqrLen$2,normalize:normalize$2,exactEquals:exactEquals$2,equals:mi,rotationTo:rotationTo,sqlerp:sqlerp,setAxes:setAxes}),getReal=copy$2,setReal=copy$2,mul$1=Ni,dot$1=dot$2,length$1=length$2,len$1=length$1,squaredLength$1=squaredLength$2,sqrLen$1=squaredLength$1,quat2=Object.freeze({__proto__:null,create:gi,clone:Si,fromValues:Gi,fromRotationTranslationValues:yi,fromRotationTranslation:Ii,fromTranslation:Ti,fromRotation:Ci,fromMat4:bi,copy:xi,identity:wi,set:Pi,getReal:getReal,getDual:Ri,setReal:setReal,setDual:vi,getTranslation:Ai,translate:Mi,rotateX:Di,rotateY:Ei,rotateZ:Fi,rotateByQuatAppend:Oi,rotateByQuatPrepend:Bi,rotateAroundAxis:ki,add:Li,multiply:Ni,mul:mul$1,scale:Wi,dot:dot$1,lerp:Ui,invert:Vi,conjugate:Hi,length:length$1,len:len$1,squaredLength:squaredLength$1,sqrLen:sqrLen$1,normalize:ji,str:zi,exactEquals:Xi,equals:Yi}),len=_r,sub=er,mul=tr,div=sr,dist=ur,sqrDist=dr,sqrLen=pr,forEach=function(){var e=qi();return function(t,s,i,r,n,a){var o,h;for(s||(s=2),i||(i=0),h=r?Math.min(r*s+i,t.length):t.length,o=i;o<h;o+=s)e[0]=t[o],e[1]=t[o+1],n(e,e,a),t[o]=e[0],t[o+1]=e[1];return t}}(),vec2=Object.freeze({__proto__:null,create:qi,clone:Ki,fromValues:$i,copy:Ji,set:Zi,add:Qi,subtract:er,multiply:tr,divide:sr,ceil:ir,floor:rr,min:nr,max:ar,round:hr,scale:lr,scaleAndAdd:cr,distance:ur,squaredDistance:dr,length:_r,squaredLength:pr,negate:fr,inverse:mr,normalize:gr,dot:Sr,cross:Gr,lerp:yr,random:Ir,transformMat2:Tr,transformMat2d:Cr,transformMat3:br,transformMat4:xr,rotate:wr,angle:Pr,zero:Rr,str:vr,exactEquals:Ar,equals:Mr,len:len,sub:sub,mul:mul,div:div,dist:dist,sqrDist:sqrDist,sqrLen:sqrLen,forEach:forEach}),globalThis.glMatrix=common,globalThis.glMatrix.mat2=mat2,globalThis.glMatrix.mat2d=mat2d,globalThis.glMatrix.mat3=mat3,globalThis.glMatrix.mat4=mat4,globalThis.glMatrix.quat=quat,globalThis.glMatrix.quat2=quat2,globalThis.glMatrix.vec2=vec2,globalThis.glMatrix.vec3=vec3,globalThis.glMatrix.vec4=vec4}var t,EPSILON,ARRAY_TYPE,RANDOM,ANGLE_ORDER,degree,common,mul$8,sub$6,mat2,mul$7,sub$5,mat2d,mul$6,sub$4,mat3,perspective,ortho,mul$5,sub$3,mat4,sub$2,mul$4,div$2,dist$2,sqrDist$2,len$4,sqrLen$4,forEach$2,vec3,sub$1,mul$3,div$1,dist$1,sqrDist$1,len$3,sqrLen$3,forEach$1,vec4,clone$2,fromValues$2,copy$2,set$2,add$2,mul$2,scale$2,dot$2,lerp$2,length$2,len$2,squaredLength$2,sqrLen$2,normalize$2,exactEquals$2,rotationTo,sqlerp,setAxes,quat,getReal,setReal,mul$1,dot$1,length$1,len$1,squaredLength$1,sqrLen$1,quat2,len,sub,mul,div,dist,sqrDist,sqrLen,forEach,vec2,setMatrixArrayType,toRadian,equals$9,create$8,clone$8,copy$8,identity$5,fromValues$8,set$8,transpose$2,invert$5,adjoint$2,determinant$3,multiply$8,rotate$4,scale$8,fromRotation$4,fromScaling$3,str$8,frob$3,LDU,add$8,subtract$6,exactEquals$8,equals$8,multiplyScalar$3,multiplyScalarAndAdd$3,create$7,clone$7,copy$7,identity$4,fromValues$7,set$7,invert$4,determinant$2,multiply$7,rotate$3,scale$7,translate$3,fromRotation$3,fromScaling$2,fromTranslation$3,str$7,frob$2,add$7,subtract$5,multiplyScalar$2,multiplyScalarAndAdd$2,exactEquals$7,equals$7,create$6,fromMat4$1,clone$6,copy$6,fromValues$6,set$6,identity$3,transpose$1,invert$3,adjoint$1,determinant$1,multiply$6,translate$2,rotate$2,scale$6,fromTranslation$2,fromRotation$2,fromScaling$1,fromMat2d,fromQuat$1,normalFromMat4,projection,str$6,frob$1,add$6,subtract$4,multiplyScalar$1,multiplyScalarAndAdd$1,exactEquals$6,equals$6,create$5,clone$5,copy$5,fromValues$5,set$5,identity$2,transpose,invert$2,adjoint,determinant,multiply$5,translate$1,scale$5,rotate$1,rotateX$3,rotateY$3,rotateZ$3,fromTranslation$1,fromScaling,fromRotation$1,fromXRotation,fromYRotation,fromZRotation,fromRotationTranslation$1,fromQuat2,getTranslation$1,getScaling,getRotation,decompose,fromRotationTranslationScale,fromRotationTranslationScaleOrigin,fromQuat,frustum,perspectiveNO,perspectiveZO,perspectiveFromFieldOfView,orthoNO,orthoZO,lookAt,targetTo,str$5,frob,add$5,subtract$3,multiplyScalar,multiplyScalarAndAdd,exactEquals$5,equals$5,create$4,clone$4,length$4,fromValues$4,copy$4,set$4,add$4,subtract$2,multiply$4,divide$2,ceil$2,floor$2,min$2,max$2,round$2,scale$4,scaleAndAdd$2,distance$2,squaredDistance$2,squaredLength$4,negate$2,inverse$2,normalize$4,dot$4,cross$2,lerp$4,slerp$1,hermite,bezier,random$3,transformMat4$2,transformMat3$1,transformQuat$1,rotateX$2,rotateY$2,rotateZ$2,angle$1,zero$2,str$4,exactEquals$4,equals$4,create$3,clone$3,fromValues$3,copy$3,set$3,add$3,subtract$1,multiply$3,divide$1,ceil$1,floor$1,min$1,max$1,round$1,scale$3,scaleAndAdd$1,distance$1,squaredDistance$1,length$3,squaredLength$3,negate$1,inverse$1,normalize$3,dot$3,cross$1,lerp$3,random$2,transformMat4$1,transformQuat,zero$1,str$3,exactEquals$3,equals$3,create$2,identity$1,setAxisAngle,getAxisAngle,getAngle,multiply$2,rotateX$1,rotateY$1,rotateZ$1,calculateW,exp,ln,pow,slerp,random$1,invert$1,conjugate$1,fromMat3,fromEuler,str$2,equals$2,create$1,clone$1,fromValues$1,fromRotationTranslationValues,fromRotationTranslation,fromTranslation,fromRotation,fromMat4,copy$1,identity,set$1,getDual,setDual,getTranslation,translate,rotateX,rotateY,rotateZ,rotateByQuatAppend,rotateByQuatPrepend,rotateAroundAxis,add$1,multiply$1,scale$1,lerp$1,invert,conjugate,normalize$1,str$1,exactEquals$1,equals$1,create,clone,fromValues,copy,set,add,subtract,multiply,divide,ceil,floor,min,max,round,scale,scaleAndAdd,distance,squaredDistance,length,squaredLength,negate,inverse,normalize,dot,cross,lerp,random,transformMat2,transformMat2d,transformMat3,transformMat4,rotate,angle,zero,str,exactEquals,equals,tmpPoint1,tmpPoint2,tmpLine1,tmpLine2,lineInt,lineSegmentsIntersect,triangleArea,isLeft,isLeftOn,isRight,isRightOn,collinear,sqdist,polygonAt,polygonClear,polygonAppend,polygonMakeCCW,polygonReverse,polygonIsReflex,polygonCanSee,polygonCanSee2,polygonCopy,polygonGetCutEdges,polygonDecomp,polygonSlice,polygonIsSimple,getIntersectionPoint,polygonQuickDecomp,polygonRemoveCollinearPoints,polygonRemoveDuplicatePoints,scalar_eq,points_eq,ReadBrandList,RunTest,GetWindowsNTVersionName,s,a,c,i,l,f,d,r,a,o,assertFail,isValidTypeChange,logDefendedObjectWarning,CheckDefendedObjectsUsedCorrectly,getObjectPropertySet,VerifyObjectPropertiesConsistent,isNegativeZero,OnTask,padTwoDigits,hueToRGB,RequireStringOrNumber,SetNewCallback,DoAsyncifiedWork,DoNextAsyncifiedJob,ClearTimeCache,CheckActiveIdleTimeouts,lookupHtmlEntity,bbToHtmlReplacerFunc,IsWordBreakWhiteSpace,IsOpeningCJKPunctiationChar,IsContinuingCJKPunctuationChar,WordBreakTrimEnd,IsNewline,PlaneFromPoints,IsInFrontOfPlane,IsPointInFrontOfPlane,interpolateQuad,GetFormatSpecifiers,fillOrStrokeRect,ptToPx,getOffsetParam,UpdateLayoutEndValues,makeNullFilledArray,GetFragmentInputStructDeclaration,HashPipelineState,SortZOrderList,GetDispatcher,MakeIWorldInstanceClass,GetDispatcher,GetTimelineState,GetTimelineState,GetTweenState,IsStaticTextureDataType,GetTypeFromFileExtension,AddScript,SortByInstLastCachedZIndex,SortByInstLastCachedZIndex,SortByInstZElevation,vec3EqualsXYZ,MaybePrepareLayerDraw,SortSolArray,IsSolArrayIdentical,NoActions,WrapIndex,GetExpressionFunc,EvalParams,EvalParams,GetInst,GetWorldInfo,GetInst_SDKv2,GetWorldInfo_SDKv2,GetObjectClass,GetLayer,CollMemory_Add,CollMemory_Remove,CollMemory_RemoveInstance,CollMemory_Get,DoOverlapCondition,FinishCollisionConditionPicking,FinishCollisionCondition,PickByUID_Normal,PickByUID_Inverted,GetNextParamMap,ValidateInternalAPIToken,CreateRuntime,InitRuntime,ForEachOrdered_SortInstances,SortZOrderList,SortInstancesByValue,GetAudioSdkInstance,GetAudioDOMInterface,GetKeyboardSdkInstance,StringFromCharCode,GetMouseSdkInstance,RunLengthDecode,WrapModeToStr,getOffsetParam,normalizeCssColorString,GetParticleEngine,randomOffset,getIndexForEase,ValidateTags,unaryminus,bothNumbers,add,subtract,multiply,divide,mod,pow,and,or;{let Dr=function(e,t,s){s=s||0;var i,r,n,a,o,h,l,c=[0,0];return i=e[1][1]-e[0][1],r=e[0][0]-e[1][0],n=i*e[0][0]+r*e[0][1],a=t[1][1]-t[0][1],o=t[0][0]-t[1][0],h=a*t[0][0]+o*t[0][1],nn(l=i*o-a*r,0,s)||(c[0]=(o*n-r*h)/l,c[1]=(i*h-a*n)/l),c},Er=function(e,t,s,i){var r=t[0]-e[0],n=t[1]-e[1],a=i[0]-s[0],o=i[1]-s[1];if(a*n-o*r===0)return!1;var h=(r*(s[1]-e[1])+n*(e[0]-s[0]))/(a*n-o*r),l=(a*(e[1]-s[1])+o*(s[0]-e[0]))/(o*r-a*n);return h>=0&&h<=1&&l>=0&&l<=1},Fr=function(e,t,s){return(t[0]-e[0])*(s[1]-e[1])-(s[0]-e[0])*(t[1]-e[1])},Or=function(e,t,s){return Fr(e,t,s)>0},Br=function(e,t,s){return Fr(e,t,s)>=0},kr=function(e,t,s){return Fr(e,t,s)<0},Lr=function(e,t,s){return Fr(e,t,s)<=0},Nr=function(e,t,s,i){if(i){var r=tmpPoint1,n=tmpPoint2;r[0]=t[0]-e[0],r[1]=t[1]-e[1],n[0]=s[0]-t[0],n[1]=s[1]-t[1];var a=r[0]*n[0]+r[1]*n[1],o=Math.sqrt(r[0]*r[0]+r[1]*r[1]),h=Math.sqrt(n[0]*n[0]+n[1]*n[1]);return Math.acos(a/(o*h))<i}return 0===Fr(e,t,s)},Wr=function(e,t){var s=t[0]-e[0],i=t[1]-e[1];return s*s+i*i},Ur=function(e,t){var s=e.length;return e[t<0?t%s+s:t%s]},Vr=function(e){e.length=0},Hr=function(e,t,s,i){for(var r=s;r<i;r++)e.push(t[r])},jr=function(e){for(var t=0,s=e,i=1;i<e.length;++i)(s[i][1]<s[t][1]||s[i][1]===s[t][1]&&s[i][0]>s[t][0])&&(t=i);return!Or(Ur(e,t-1),Ur(e,t),Ur(e,t+1))&&(zr(e),!0)},zr=function(e){for(var t=[],s=e.length,i=0;i!==s;i++)t.push(e.pop());for(i=0;i!==s;i++)e[i]=t[i]},Xr=function(e,t){return kr(Ur(e,t-1),Ur(e,t),Ur(e,t+1))},Yr=function(e,t,s){var i,r,n=tmpLine1,a=tmpLine2;if(Br(Ur(e,t+1),Ur(e,t),Ur(e,s))&&Lr(Ur(e,t-1),Ur(e,t),Ur(e,s)))return!1;r=Wr(Ur(e,t),Ur(e,s));for(var o=0;o!==e.length;++o)if((o+1)%e.length!==t&&o!==t&&Br(Ur(e,t),Ur(e,s),Ur(e,o+1))&&Lr(Ur(e,t),Ur(e,s),Ur(e,o))&&(n[0]=Ur(e,t),n[1]=Ur(e,s),a[0]=Ur(e,o),a[1]=Ur(e,o+1),i=Dr(n,a),Wr(Ur(e,t),i)<r))return!1;return!0},qr=function(e,t,s){for(var i=0;i!==e.length;++i)if(i!==t&&i!==s&&(i+1)%e.length!==t&&(i+1)%e.length!==s&&Er(Ur(e,t),Ur(e,s),Ur(e,i),Ur(e,i+1)))return!1;return!0},Kr=function(e,t,s,i){var r=i||[];if(Vr(r),t<s)for(var n=t;n<=s;n++)r.push(e[n]);else{for(n=0;n<=s;n++)r.push(e[n]);for(n=t;n<e.length;n++)r.push(e[n])}return r},$r=function(e){for(var t=[],s=[],i=[],r=[],n=Number.MAX_VALUE,a=0;a<e.length;++a)if(Xr(e,a))for(var o=0;o<e.length;++o)if(Yr(e,a,o)){s=$r(Kr(e,a,o,r)),i=$r(Kr(e,o,a,r));for(var h=0;h<i.length;h++)s.push(i[h]);s.length<n&&(t=s,n=s.length,t.push([Ur(e,a),Ur(e,o)]))}return t},Jr=function(e){var t=$r(e);return t.length>0?Zr(e,t):[e]},Zr=function(e,t){if(0===t.length)return[e];if(t instanceof Array&&t.length&&t[0]instanceof Array&&2===t[0].length&&t[0][0]instanceof Array){for(var s=[e],i=0;i<t.length;i++)for(var r=t[i],n=0;n<s.length;n++){var a=Zr(s[n],r);if(a){s.splice(n,1),s.push(a[0],a[1]);break}}return s}return r=t,i=e.indexOf(r[0]),n=e.indexOf(r[1]),-1!==i&&-1!==n&&[Kr(e,i,n),Kr(e,n,i)]},Qr=function(e){var t,s=e;for(t=0;t<s.length-1;t++)for(var i=0;i<t-1;i++)if(Er(s[t],s[t+1],s[i],s[i+1]))return!1;for(t=1;t<s.length-2;t++)if(Er(s[0],s[s.length-1],s[t],s[t+1]))return!1;return!0},en=function(e,t,s,i,r){r=r||0;var n=t[1]-e[1],a=e[0]-t[0],o=n*e[0]+a*e[1],h=i[1]-s[1],l=s[0]-i[0],c=h*s[0]+l*s[1],u=n*l-h*a;return nn(u,0,r)?[0,0]:[(l*o-a*c)/u,(n*c-h*o)/u]},tn=function(e,t,s,i,r,n,a){n=n||100,a=a||0,r=r||25,t=void 0!==t?t:[],s=s||[],i=i||[];var o=[0,0],h=[0,0],l=[0,0],c=0,u=0,d=0,_=0,p=0,f=0,m=0,g=[],S=[],G=e,y=e;if(y.length<3)return t;if(++a>n)return console.warn("quickDecomp: max level ("+n+") reached."),t;for(var I=0;I<e.length;++I)if(Xr(G,I)){s.push(G[I]),c=u=Number.MAX_VALUE;for(var T=0;T<e.length;++T)Or(Ur(G,I-1),Ur(G,I),Ur(G,T))&&Lr(Ur(G,I-1),Ur(G,I),Ur(G,T-1))&&(l=en(Ur(G,I-1),Ur(G,I),Ur(G,T),Ur(G,T-1)),kr(Ur(G,I+1),Ur(G,I),l)&&(d=Wr(G[I],l))<u&&(u=d,h=l,f=T)),Or(Ur(G,I+1),Ur(G,I),Ur(G,T+1))&&Lr(Ur(G,I+1),Ur(G,I),Ur(G,T))&&(l=en(Ur(G,I+1),Ur(G,I),Ur(G,T),Ur(G,T+1)),Or(Ur(G,I-1),Ur(G,I),l)&&(d=Wr(G[I],l))<c&&(c=d,o=l,p=T));if(f===(p+1)%e.length)l[0]=(h[0]+o[0])/2,l[1]=(h[1]+o[1])/2,i.push(l),I<p?(Hr(g,G,I,p+1),g.push(l),S.push(l),0!==f&&Hr(S,G,f,G.length),Hr(S,G,0,I+1)):(0!==I&&Hr(g,G,I,G.length),Hr(g,G,0,p+1),g.push(l),S.push(l),Hr(S,G,f,I+1));else{if(f>p&&(p+=e.length),_=Number.MAX_VALUE,p<f)return t;for(T=f;T<=p;++T)Br(Ur(G,I-1),Ur(G,I),Ur(G,T))&&Lr(Ur(G,I+1),Ur(G,I),Ur(G,T))&&(d=Wr(Ur(G,I),Ur(G,T)))<_&&qr(G,I,T)&&(_=d,m=T%e.length);I<m?(Hr(g,G,I,m+1),0!==m&&Hr(S,G,m,y.length),Hr(S,G,0,I+1)):(0!==I&&Hr(g,G,I,y.length),Hr(g,G,0,m+1),Hr(S,G,m,I+1))}return g.length<S.length?(tn(g,t,s,i,r,n,a),tn(S,t,s,i,r,n,a)):(tn(S,t,s,i,r,n,a),tn(g,t,s,i,r,n,a)),t}return t.push(e),t},sn=function(e,t){for(var s=0,i=e.length-1;e.length>3&&i>=0;--i)Nr(Ur(e,i-1),Ur(e,i),Ur(e,i+1),t)&&(e.splice(i%e.length,1),s++);return s},rn=function(e,t){for(var s=e.length-1;s>=1;--s)for(var i=e[s],r=s-1;r>=0;--r)an(i,e[r],t)&&e.splice(s,1)},nn=function(e,t,s){return s=s||0,Math.abs(e-t)<=s},an=function(e,t,s){return nn(e[0],t[0],s)&&nn(e[1],t[1],s)};lineInt=Dr,lineSegmentsIntersect=Er,triangleArea=Fr,isLeft=Or,isLeftOn=Br,isRight=kr,isRightOn=Lr,collinear=Nr,sqdist=Wr,polygonAt=Ur,polygonClear=Vr,polygonAppend=Hr,polygonMakeCCW=jr,polygonReverse=zr,polygonIsReflex=Xr,polygonCanSee=Yr,polygonCanSee2=qr,polygonCopy=Kr,polygonGetCutEdges=$r,polygonDecomp=Jr,polygonSlice=Zr,polygonIsSimple=Qr,getIntersectionPoint=en,polygonQuickDecomp=tn,polygonRemoveCollinearPoints=sn,polygonRemoveDuplicatePoints=rn,scalar_eq=nn,points_eq=an,tmpPoint1=[],tmpPoint2=[],tmpLine1=[],tmpLine2=[],self.polyDecomp={decomp:Jr,quickDecomp:tn,isSimple:Qr,removeCollinearPoints:sn,removeDuplicatePoints:rn,makeCCW:jr}}{let on=!1,hn=!1,cn="dev";const un=Symbol("Construct internal API token");let dn=16;const _n=self.C3=class{constructor(){throw TypeError("static class can't be instantiated")}static _GetInternalAPIToken(){if(dn<=0)throw new Error("cannot obtain internal API token");return--dn,un}static SetReady(){on=!0}static IsReady(){return on}static SetAppStarted(){hn=!0}static HasAppStarted(){return hn}static SetBuildMode(e){cn=e}static GetBuildMode(){return cn}static IsReleaseBuild(){return"final"===cn}};_n.isDebug=!1,_n.isDebugDefend=!1,_n.hardwareConcurrency=navigator.hardwareConcurrency||2,self.C3X={}}{const pn=self.C3;pn.QueryParser=class{constructor(e){this._queryString=e,this._parameters=new Map,this._Parse()}_Parse(){let e=this._queryString;(e.startsWith("?")||e.startsWith("#"))&&(e=e.substr(1));const t=e.split("&");for(const e of t)this._ParseParameter(e)}_ParseParameter(e){if(!e)return;if(!e.includes("="))return void this._parameters.set(e,null);const t=e.indexOf("="),s=decodeURIComponent(e.substring(0,t)),i=decodeURIComponent(e.substring(t+1));this._parameters.set(s,i)}LogAll(){for(const e of this._parameters)console.log("[QueryParser] Parameter '"+e[0]+"' = "+(null===e[1]?"null":"'"+e[1]+"'"))}Has(e){return this._parameters.has(e)}Get(e){const t=this._parameters.get(e);return void 0===t?null:t}ClearHash(){history.replaceState("",document.title,location.pathname+location.search)}Reparse(e){this._queryString=e,this._parameters.clear(),this._Parse()}},pn.QueryString=new pn.QueryParser(location.search),pn.LocationHashString=new pn.QueryParser(location.hash),pn.QueryString.Has("perf")&&(pn.isPerformanceProfiling=!0),"dev"!==pn.QueryString.Get("mode")&&pn.SetBuildMode("final")}{let fn=function(e){const t=parseFloat(e);return Sn.get(t)||(t>=13?"11":"NT "+e)};GetWindowsNTVersionName=fn;const mn=self.C3,gn="(unknown)";mn.Platform={OS:gn,OSVersion:gn,Browser:gn,BrowserVersion:gn,BrowserVersionNumber:NaN,BrowserEngine:gn,Context:"browser",IsDesktop:!0,IsMobile:!1,IsAppleOS:!1,IsIpadOS:!1,GetDetailedInfo:async()=>{}};const Sn=new Map([[5,"2000"],[5.1,"XP"],[5.2,"XP"],[6,"Vista"],[6.1,"7"],[6.2,"8"],[6.3,"8.1"],[10,"10"]]),Gn=navigator.userAgent,yn=navigator.userAgentData;if(yn&&yn.brands.length>0){let Tn=function(e){let t="",s="",i="",r="";for(const n of e){const e=Cn.get(n.brand);!t&&e&&(t=e,s=n.version);const a=bn.get(n.brand);!i&&a&&(i=a,r=n.version)}t||"Chromium"!==i||(mn.Platform.Browser="Chromium",mn.Platform.BrowserVersion=r),mn.Platform.Browser=t||gn,mn.Platform.BrowserVersion=s||gn,mn.Platform.BrowserEngine=i||gn};ReadBrandList=Tn,mn.Platform.OS=yn.platform,mn.Platform.IsMobile=yn.mobile,mn.Platform.IsDesktop=!mn.Platform.IsMobile;const Cn=new Map([["Google Chrome","Chrome"],["Microsoft Edge","Edge"],["Opera","Opera"],["Opera GX","Opera GX"],["Mozilla Firefox","Firefox"],["Apple Safari","Safari"],["NW.js","NW.js"]]),bn=new Map([["Chromium","Chromium"],["Gecko","Gecko"],["WebKit","WebKit"]]);Tn(yn.brands);let xn=!1;mn.Platform.GetDetailedInfo=async()=>{if(!xn)try{const e=await navigator.userAgentData.getHighEntropyValues(["platformVersion","fullVersionList"]);Tn(e.fullVersionList),"Windows"===mn.Platform.OS?mn.Platform.OSVersion=fn(e.platformVersion):mn.Platform.OSVersion=e.platformVersion,xn=!0}catch(e){console.warn("Failed to get detailed user agent information: ",e)}}}else{let wn=function(e,t){const s=Array.isArray(e)?e:[e];for(const e of s){const s=e.exec(Gn);if(s){t(s);break}}};RunTest=wn,wn(/windows\s+nt\s+([\d\.]+)/i,e=>{mn.Platform.OS="Windows";const t=e[1];mn.Platform.OSVersion=fn(t)}),wn(/mac\s+os\s+x\s+([\d\._]+)/i,e=>{mn.Platform.OS="macOS",mn.Platform.OSVersion=e[1].replace(/_/g,".")}),wn(/CrOS/,()=>{mn.Platform.OS="Chrome OS"}),wn(/linux|openbsd|freebsd|netbsd/i,()=>{mn.Platform.OS="Linux"}),wn(/android/i,()=>{mn.Platform.OS="Android"}),wn(/android\s+([\d\.]+)/i,e=>{mn.Platform.OS="Android",mn.Platform.OSVersion=e[1]}),mn.Platform.OS===gn&&(wn(/(iphone|ipod|ipad)/i,e=>{mn.Platform.OS="iOS"}),wn([/iphone\s+os\s+([\d\._]+)/i,/ipad[^)]*os\s+([\d\._]+)/i],e=>{mn.Platform.OS="iOS",mn.Platform.OSVersion=e[1].replace(/_/g,".")}));const Pn=/chrome\//i.test(Gn),Rn=/chromium\//i.test(Gn),vn=/edg\//i.test(Gn),An=/OPR\//.test(Gn),Mn=/nwjs/i.test(Gn),Dn=/safari\//i.test(Gn),En=/webkit/i.test(Gn);vn||An||wn(/chrome\/([\d\.]+)/i,e=>{mn.Platform.Browser="Chrome",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Chromium"}),wn(/edg\/([\d\.]+)/i,e=>{mn.Platform.Browser="Edge",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Chromium"}),wn(/OPR\/([\d\.]+)/,e=>{mn.Platform.Browser="Opera",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Chromium"}),wn(/chromium\/([\d\.]+)/i,e=>{mn.Platform.Browser="Chromium",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Chromium"}),wn(/nwjs\/[0-9.]+/i,e=>{mn.Platform.Browser="NW.js",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Chromium",mn.Platform.Context="nwjs"}),wn(/firefox\/([\d\.]+)/i,e=>{mn.Platform.Browser="Firefox",mn.Platform.BrowserVersion=e[1],mn.Platform.BrowserEngine="Gecko"}),!Dn||Pn||Rn||vn||An||Mn||(mn.Platform.Browser="Safari",mn.Platform.BrowserEngine="WebKit",wn(/version\/([\d\.]+)/i,e=>{mn.Platform.BrowserVersion=e[1]}),wn(/crios\/([\d\.]+)/i,e=>{mn.Platform.Browser="Chrome for iOS",mn.Platform.BrowserVersion=e[1]}),wn(/fxios\/([\d\.]+)/i,e=>{mn.Platform.Browser="Firefox for iOS",mn.Platform.BrowserVersion=e[1]}),wn(/edgios\/([\d\.]+)/i,e=>{mn.Platform.Browser="Edge for iOS",mn.Platform.BrowserVersion=e[1]})),mn.Platform.BrowserEngine===gn&&En&&(mn.Platform.BrowserEngine="WebKit"),"Android"===mn.Platform.OS&&"Safari"===mn.Platform.Browser&&(mn.Platform.Browser="Stock");const Fn=new Set(["Windows","macOS","Linux","Chrome OS"]).has(mn.Platform.OS)||"nwjs"===mn.Platform.Context;mn.Platform.IsDesktop=Fn,mn.Platform.IsMobile=!Fn}"Chrome"===mn.Platform.Browser&&"browser"===mn.Platform.Context&&/wv\)/.test(Gn)&&(mn.Platform.Context="webview"),"nwjs"!==mn.Platform.Context&&"undefined"!=typeof window&&(window.matchMedia&&window.matchMedia("(display-mode: standalone)").matches||navigator.standalone)&&(mn.Platform.Context="webapp"),mn.Platform.BrowserVersionNumber=parseFloat(mn.Platform.BrowserVersion);const In="macOS"===mn.Platform.OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>2;In&&(mn.Platform.OS="iOS",mn.Platform.OSVersion=mn.Platform.BrowserVersion,mn.Platform.IsDesktop=!1,mn.Platform.IsMobile=!0,mn.Platform.IsIpadOS=!0),mn.Platform.IsAppleOS="macOS"===mn.Platform.OS||"iOS"===mn.Platform.OS}{let On=function(e){return new Promise((t,s)=>{e.onsuccess=()=>t(e.result),e.onerror=()=>s(e.error)})},Bn=function(e){return new Promise((t,s)=>{e.oncomplete=()=>t(),e.onerror=()=>s(e.error),e.onabort=()=>s(e.error)})},kn=function(e,t){return Yn(e,t)},Ln=function(e,t){return Yn(e,t,!0)},Nn=function(e){Wn(e);let t=jn.get(e);return t instanceof Promise||(t=qn(e),jn.set(e,t),t.catch(t=>jn.delete(e))),t},Wn=function(e){if("string"!=typeof e)throw new TypeError("expected string")},Un=function(e,t){const s=e.objectStore(Hn).openCursor();return new Promise(e=>{const i=[];s.onsuccess=s=>{const r=s.target.result;if(r){switch(t){case"entries":i.push([r.key,r.value]);break;case"keys":i.push(r.key);break;case"values":i.push(r.value)}r.continue()}else e(i)}})};s=On,a=Bn,c=kn,i=Ln,l=Nn,f=Wn,d=Un;const Vn=2,Hn="keyvaluepairs",jn=new Map,zn="undefined"!=typeof IDBObjectStore&&"function"==typeof IDBObjectStore.prototype.getAll,Xn="undefined"!=typeof IDBObjectStore&&"function"==typeof IDBObjectStore.prototype.getAllKeys;async function Yn(e,t,s=!1,i=!0){const r=await Nn(e);try{return t(r.transaction([Hn],s?"readwrite":"readonly"))}catch(r){if(i&&"InvalidStateError"===r.name)return jn.delete(e),Yn(e,t,s,!1);throw r}}async function qn(e){Wn(e);const t=indexedDB.open(e,Vn);return t.addEventListener("upgradeneeded",t=>{try{t.target.result.createObjectStore(Hn)}catch(t){console.error(`Failed to create objectstore for database ${e}`,t)}}),On(t)}class Kn{constructor(e){Wn(e),this.name=e}async ready(){await Nn(this.name)}set(e,t){return Wn(e),Ln(this.name,async s=>{const i=On(s.objectStore(Hn).put(t,e)),r=Bn(s);await Promise.all([r,i])})}get(e){return Wn(e),kn(this.name,async t=>{const s=On(t.objectStore(Hn).get(e)),i=Bn(t),[r,n]=await Promise.all([i,s]);return n})}delete(e){return Wn(e),Ln(this.name,async t=>{const s=On(t.objectStore(Hn).delete(e)),i=Bn(t);await Promise.all([i,s])})}clear(){return Ln(this.name,async e=>{const t=On(e.objectStore(Hn).clear()),s=Bn(e);await Promise.all([s,t])})}keys(){return kn(this.name,async e=>{let t;t=Xn?On(e.objectStore(Hn).getAllKeys()):Un(e,"keys");const s=Bn(e),[i,r]=await Promise.all([s,t]);return r})}values(){return kn(this.name,async e=>{let t;t=zn?On(e.objectStore(Hn).getAll()):Un(e,"values");const s=Bn(e),[i,r]=await Promise.all([s,t]);return r})}entries(){return kn(this.name,async e=>{const t=Un(e,"entries"),s=Bn(e),[i,r]=await Promise.all([s,t]);return r})}}self.KVStorageContainer=Kn}{let $n=function(e){throw new Error(`"${e}" is not implemented`)},Jn=function(e){if("function"==typeof e)throw new Error("localforage callback API is not implemented; please use the promise API instead")},Zn=function(e){return"object"==typeof e?new Promise(t=>{const{port1:s,port2:i}=new MessageChannel;i.onmessage=e=>t(e.data),s.postMessage(e)}):Promise.resolve(e)};r=$n,a=Jn,o=Zn;const Qn=self.KVStorageContainer,ea=[/no available storage method found/i,/an attempt was made to break through the security policy of the user agent/i,/the user denied permission to access the database/i,/a mutation operation was attempted on a database that did not allow mutations/i,/idbfactory\.open\(\) called in an invalid security context/i];class ta{constructor(e){this._inst=e,this._isInMemory=!this._inst,this._isInMemory||"undefined"!=typeof indexedDB||(this._isInMemory=!0,console.warn("Unable to use local storage because IndexedDB API is not available")),this._memoryStorage=new Map}_MaybeSwitchToMemoryFallback(e){if(!this._isInMemory)for(const t of ea)if(e&&t.test(e.message)){console.error("Unable to use local storage, reverting to in-memory store: ",e,e.message),this._isInMemory=!0;break}}async _getItemFallback(e){const t=this._memoryStorage.get(e),s=await Zn(t);return void 0===s?null:s}async _setItemFallback(e,t){t=await Zn(t),this._memoryStorage.set(e,t)}_removeItemFallback(e){this._memoryStorage.delete(e)}_clearFallback(){this._memoryStorage.clear()}_keysFallback(){return Array.from(this._memoryStorage.keys())}IsInMemory(){return this._isInMemory}GetMemoryStorage(){return this._memoryStorage}SetMemoryStorage(e){this._memoryStorage=e}async getItem(e,t){if(Jn(t),this._isInMemory)return await this._getItemFallback(e);let s;try{s=await this._inst.get(e)}catch(t){return this._MaybeSwitchToMemoryFallback(t),this._isInMemory?await this._getItemFallback(e):(console.error(`Error reading '${e}' from storage, returning null: `,t),null)}return void 0===s?null:s}async setItem(e,t,s){if(Jn(s),void 0===t&&(t=null),this._isInMemory)await this._setItemFallback(e,t);else try{await this._inst.set(e,t)}catch(s){if(this._MaybeSwitchToMemoryFallback(s),!this._isInMemory)throw s;await this._setItemFallback(e,t)}}async removeItem(e,t){if(Jn(t),this._isInMemory)this._removeItemFallback(e);else try{await this._inst.delete(e)}catch(t){this._MaybeSwitchToMemoryFallback(t),this._isInMemory?this._removeItemFallback(e):console.error(`Error removing '${e}' from storage: `,t)}}async clear(e){if(Jn(e),this._isInMemory)this._clearFallback();else try{await this._inst.clear()}catch(e){this._MaybeSwitchToMemoryFallback(e),this._isInMemory?this._clearFallback():console.error("Error clearing storage: ",e)}}async keys(e){if(Jn(e),this._isInMemory)return this._keysFallback();let t=[];try{t=await this._inst.keys()}catch(e){if(this._MaybeSwitchToMemoryFallback(e),this._isInMemory)return this._keysFallback();console.error("Error getting storage keys: ",e)}return t}ready(e){return Jn(e),this._isInMemory?Promise.resolve(!0):this._inst.ready()}createInstance(e){if(e.forceInMemoryFallback)return new ta(null);{const t=e.name;if("string"!=typeof t)throw new TypeError("invalid store name");const s=new Qn(t);return new ta(s)}}length(e){$n("localforage.length()")}key(e,t){$n("localforage.key()")}iterate(e,t){$n("localforage.iterate()")}setDriver(e){$n("localforage.setDriver()")}config(e){$n("localforage.config()")}defineDriver(e){$n("localforage.defineDriver()")}driver(){$n("localforage.driver()")}supports(e){$n("localforage.supports()")}dropInstance(){$n("localforage.dropInstance()")}}self.localforage=new ta(new Qn("localforage"))}{const sa=self.C3;if(sa.Supports={},sa.Supports.WebAnimations=(()=>{try{if("undefined"==typeof document)return!1;const e=document.createElement("div");return void 0!==e.animate&&void 0!==e.animate([{opacity:"0"},{opacity:"1"}],1e3).reverse}catch(e){return!1}})(),sa.Supports.DialogElement="undefined"!=typeof HTMLDialogElement,sa.Supports.RequestIdleCallback=!!self.requestIdleCallback,sa.Supports.ImageBitmap=!!self.createImageBitmap,sa.Supports.ImageBitmapOptions=!1,sa.Supports.ImageBitmapOptionsResize=!1,sa.Supports.ImageBitmap){try{self.createImageBitmap(new ImageData(32,32),{premultiplyAlpha:"none"}).then(()=>{sa.Supports.ImageBitmapOptions=!0}).catch(()=>{sa.Supports.ImageBitmapOptions=!1})}catch(ia){sa.Supports.ImageBitmapOptions=!1}try{self.createImageBitmap(new ImageData(32,32),{resizeWidth:10,resizeHeight:10}).then(e=>{sa.Supports.ImageBitmapOptionsResize=10===e.width&&10===e.height}).catch(()=>{sa.Supports.ImageBitmapOptionsResize=!1})}catch(ra){sa.Supports.ImageBitmapOptionsResize=!1}}if(sa.Supports.ClipboardReadText=!(!navigator.clipboard||!navigator.clipboard.readText),sa.Supports.PermissionsQuery=!(!navigator.permissions||!navigator.permissions.query),sa.Supports.ClipboardPermissionsQuery=!1,sa.Supports.PermissionsQuery){const na={name:"clipboard-read"};navigator.permissions.query(na).then(()=>{sa.Supports.ClipboardPermissionsQuery=!0}).catch(()=>{sa.Supports.ClipboardPermissionsQuery=!1})}sa.Supports.AsyncClipboardApi=!!(navigator.permissions&&navigator.clipboard&&self.ClipboardItem),sa.Supports.Proxies="undefined"!=typeof Proxy,sa.Supports.DownloadAttribute="undefined"!=typeof document&&void 0!==document.createElement("a").download,sa.Supports.Fetch="function"==typeof fetch,sa.Supports.PersistentStorage=!!(self.isSecureContext&&"Opera"!==sa.Platform.Browser&&navigator.storage&&navigator.storage.persist),sa.Supports.StorageQuotaEstimate=!!(self.isSecureContext&&navigator.storage&&navigator.storage.estimate),sa.Supports.Fullscreen=(()=>{if("undefined"==typeof document)return!1;if("iOS"===sa.Platform.OS)return!1;const e=document.documentElement;return!!(e.requestFullscreen||e.msRequestFullscreen||e.mozRequestFullScreen||e.webkitRequestFullscreen)})(),sa.Supports.ImageDecoder=void 0!==self.ImageDecoder,sa.Supports.WebCodecs=!!self.VideoEncoder,sa.Supports.NativeFileSystemAPI=!!self.showOpenFilePicker,sa.Supports.FileInputDirectory=function(){if("undefined"==typeof document)return!1;const e=document.createElement("input");return e.type="file","webkitdirectory"in e||"directory"in e}(),sa.Supports.QueryLocalFonts=!!self.queryLocalFonts,sa.Supports.UserActivation=!!navigator.userActivation,sa.Supports.CanvasToBlobWebP=!1,(async()=>{let e;"undefined"==typeof document?e=new OffscreenCanvas(32,32):(e=document.createElement("canvas"),e.width=32,e.height=32);const t=e.getContext("2d");t.fillStyle="blue",t.fillRect(0,0,32,32);let s=null;try{e.convertToBlob?s=await e.convertToBlob({type:"image/webp",quality:1}):e.toBlob&&(s=await new Promise(t=>e.toBlob(t,"image/webp",1))),sa.Supports.CanvasToBlobWebP=s&&"image/webp"===s.type}catch(e){sa.Supports.CanvasToBlobWebP=!1}})()}{const aa=self.C3;String.prototype.replaceAll||(String.prototype.replaceAll=function(e,t){return this.replace(new RegExp(aa.EscapeRegex(e),"g"),t)}),Array.prototype.at||(Array.prototype.at=function(e){if((e=Math.trunc(e)||0)<0&&(e+=this.length),!(e<0||e>=this.length))return this[e]}),String.prototype.at||(String.prototype.at=function(e){if((e=Math.trunc(e)||0)<0&&(e+=this.length),!(e<0||e>=this.length))return this[e]}),RegExp.escape||(RegExp.escape=function(e){return String(e).replace(/[\\^$*+?.()|[\]{}]/g,"\\$&")}),Set.prototype.isSubsetOf||(Set.prototype.isSubsetOf=function(e){if(!(e instanceof Set))throw new TypeError("argument must be a Set");for(const t of this)if(!e.has(t))return!1;return!0}),Set.prototype.difference||(Set.prototype.difference=function(e){if(!(e instanceof Set))throw new TypeError("argument must be a Set");const t=new Set;for(const s of this)e.has(s)||t.add(s);return t}),Set.prototype.union||(Set.prototype.union=function(e){const t=new Set(this);for(const s of e)t.add(s);return t}),navigator.storage&&!navigator.storage.estimate&&navigator.webkitTemporaryStorage&&navigator.webkitTemporaryStorage.queryUsageAndQuota&&(navigator.storage.estimate=function(){return new Promise((e,t)=>navigator.webkitTemporaryStorage.queryUsageAndQuota((t,s)=>e({usage:t,quota:s}),t))})}{let oa=function(e){let t="Assertion failure: "+e+"\n\nStack trace:\n"+ha.GetCallStack();console.error(t)};assertFail=oa;const ha=self.C3;self.assert=function(e,t){e||oa(t)}}{const la=self.C3,ca=self.C3X;la.IsNumber=function(e){return"number"==typeof e},la.IsFiniteNumber=function(e){return la.IsNumber(e)&&isFinite(e)},la.RequireNumber=function(e){if(!la.IsNumber(e))throw new TypeError("expected number")},la.RequireOptionalNumber=function(e){la.IsNullOrUndefined(e)},la.RequireNumberInRange=function(e,t,s){if(!la.IsNumber(e)||isNaN(e)||t>e||s<e)throw new RangeError("number outside of range")},la.RequireAllNumber=function(...e){for(let t of e);},la.RequireFiniteNumber=function(e){if(!la.IsFiniteNumber(e))throw new TypeError("expected finite number")},la.RequireOptionalFiniteNumber=function(e){la.IsNullOrUndefined(e)},la.RequireAllFiniteNumber=function(...e){for(let t of e);},la.IsDataURI=function(e){return!!la.IsString(e)&&/^data:.+,.+$/i.test(e)},la.IsString=function(e){return"string"==typeof e},la.RequireString=function(e){if(!la.IsString(e))throw new TypeError("expected string")},la.RequireOptionalString=function(e){la.IsNullOrUndefined(e)},la.RequireAllString=function(...e){for(let t of e);},la.IsSimpleObject=function(e){if("object"!=typeof e||null===e)return!1;let t=Object.getPrototypeOf(e);return t?t.constructor===Object:null===t},la.RequireSimpleObject=function(e){if(!la.IsSimpleObject(e))throw new TypeError("expected simple object")},la.RequireOptionalSimpleObject=function(e){if(!la.IsNullOrUndefined(e)&&!la.IsSimpleObject(e))throw new TypeError("expected simple object")},la.IsObject=function(e){return"object"==typeof e&&null!==e&&!Array.isArray(e)},la.RequireObject=function(e){if(!la.IsObject(e))throw new TypeError("expected object")},la.RequireOptionalObject=function(e){la.IsNullOrUndefined(e)},la.RequireAllObject=function(...e){for(let t of e);},la.IsFileLike=function(e){return la.WeakIsInstanceOf(e,Blob)&&"string"==typeof e.name},la.RequireFileLike=function(e){if(!la.IsFileLike(e))throw new TypeError("expected file")},la.RequireOptionalFileLike=function(e){la.IsNullOrUndefined(e)},la.IsArray=function(e){return Array.isArray(e)},la.RequireArray=function(e){if(!la.IsArray(e))throw new TypeError("expected array")},la.RequireOptionalArray=function(e){la.IsNullOrUndefined(e)},la.RequireAllArray=function(...e){for(let t of e);},la.Is2DArray=function(e){return!(!la.IsArray(e)||e.length&&!la.IsArray(e[0]))},la.Require2DArray=function(e){if(!la.Is2DArray(e))throw new TypeError("expected 2d array");for(let t of e)if(!la.IsArray(t))throw new TypeError("expected 2d array")},la.RequireOptional2DArray=function(e){la.IsNullOrUndefined(e)},la.IsFunction=function(e){return"function"==typeof e},la.RequireFunction=function(e,t){if(!la.IsFunction(e))throw new TypeError("expected function");if(!la.IsNullOrUndefined(t)&&e!==t)throw new TypeError("expected same function reference")},la.RequireOptionalFunction=function(e){la.IsNullOrUndefined(e)},la.RequireAllFunction=function(...e){for(let t of e);},la.RequireAnyFunction=function(e,...t){if(!la.IsFunction(e))throw new TypeError("expected function");if(!t.length)throw new Error("missing comparison functions");for(let s of t)if(!la.IsNullOrUndefined(s)&&e===s)return;throw new TypeError("expected same function reference")},la.RequireOptionalAllFunction=function(...e){if(!la.IsNullOrUndefined(e))for(let t of e);},la.IsInstanceOf=function(e,t){return e instanceof t},la.IsInstanceOfAny=function(e,...t){for(let s of t)if(la.IsInstanceOf(e,s))return!0;return!1},la.RequireInstanceOf=function(e,t){if(!la.IsInstanceOf(e,t))throw new TypeError("unexpected type")},la.RequireOptionalInstanceOf=function(e,t){la.IsNullOrUndefined(e)},la.RequireAllInstanceOf=function(e,...t){for(let e of t);},la.RequireAnyInstanceOf=function(e,...t){if(!la.IsInstanceOfAny(e,...t))throw new TypeError("unexpected type")},la.RequireAnyOptionalInstanceOf=function(e,...t){if(!la.IsNullOrUndefined(e)&&!la.IsInstanceOfAny(e,...t))throw new TypeError("unexpected type")},la.IsArrayOf=function(e,t){for(let s of e)if(!la.IsInstanceOf(s,t))return!1;return!0},la.IsArrayOfFiniteNumbers=function(e){for(let t of e)if(!la.IsFiniteNumber(t))return!1;return!0},la.RequireArrayOf=function(e,t){for(let t of e);},la.RequireOptionalArrayOf=function(e,t){if(!la.IsNullOrUndefined(e))for(let t of e);},la.RequireOptionalArrayOfFunctions=function(e,t){if(!la.IsNullOrUndefined(e))for(let t of e);},la.RequireArrayOfAny=function(e,...t){for(let t of e);},la.RequireOptionalArrayOfAny=function(e,...t){if(!la.IsNullOrUndefined(e))for(let t of e);},la.IsDOMNode=function(e,t){return!(la.IsNullOrUndefined(e)||!la.IsString(e.nodeName))&&(!t||la.equalsNoCase(e.nodeName,t))},la.RequireDOMNode=function(e,t){if(la.IsNullOrUndefined(e)||!la.IsString(e.nodeName))throw new TypeError("expected DOM node");if(t&&!la.equalsNoCase(e.nodeName,t))throw new TypeError(`expected DOM '${t}' node`)},la.RequireOptionalDOMNode=function(e,t){la.IsNullOrUndefined(e)},la.IsHTMLElement=function(e,t){return!(la.IsNullOrUndefined(e)||!la.IsString(e.tagName))&&(!t||la.equalsNoCase(e.tagName,t))},la.RequireHTMLElement=function(e,t){if(la.IsNullOrUndefined(e)||!la.IsString(e.tagName))throw new TypeError("expected HTML element");if(t&&!la.equalsNoCase(e.tagName,t))throw new TypeError(`expected HTML '${t}' element`)},la.RequireOptionalHTMLElement=function(e,t){la.IsNullOrUndefined(e)},la.IsDrawable=function(e){return la.IsHTMLElement(e,"img")||la.IsHTMLElement(e,"canvas")||la.IsHTMLElement(e,"video")||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap},la.RequireDrawable=function(e){if(!la.IsDrawable(e))throw new TypeError("expected drawable")},la.RequireOptionalDrawable=function(e){la.IsNullOrUndefined(e)},la.IsDrawableOrImageData=function(e){return e instanceof ImageData||la.IsDrawable(e)},la.RequireDrawableOrImageData=function(e){if(!la.IsDrawableOrImageData(e))throw new TypeError("expected drawable or image data")},la.RequireOptionalDrawableOrImageData=function(e){if(!la.IsNullOrUndefined(e)&&!la.IsDrawableOrImageData(e))throw new TypeError("expected drawable or image data")},la.IsStringLike=function(e){return"string"==typeof e||la.HtmlString&&e instanceof la.HtmlString||e instanceof la.BBString},la.RequireStringLike=function(e){if(!la.IsStringLike(e))throw new TypeError("expected string-like")},la.RequireOptionalStringLike=function(e){la.IsNullOrUndefined(e)},la.RequireAllStringLike=function(...e){for(let t of e);},la.RequireOverride=function(){throw new Error("must be overridden")},la.NotYetImplemented=function(){throw new Error("not yet implemented")},la.IsGeneratorFunction=function(e){return e.constructor===function*(){}.constructor},la.RequireGeneratorFunction=function(e){if(!la.IsGeneratorFunction(e))throw new Error("expected generator function")},la.IsIterable=function(e){return"function"===e[Symbol.iterator]},la.RequireIterable=function(e){if(!la.IsIterable(e))throw new Error("expected iterable")},la.IsDefined=function(e){return!la.IsNullOrUndefined(e)},la.IsNullOrUndefined=function(e){return null==e},la.AreArrayElementsOfSameType=function(e){let t=e[0].constructor;for(let s of e)if(s.constructor!==t)return!1;return t},la.AreArrayElementsOfType=function(e,t){for(let s of e)if(!(s instanceof t))return!1;return!0};const ua=Object.getPrototypeOf(Uint8Array);la.IsTypedArray=function(e){return la.IsInstanceOf(e,ua)},la.RequireTypedArray=function(e){},la.WeakRequireTypedArray=function(e){la.WeakRequireInstanceOf(e,ua)},la.WeakRequireAnyInstanceOf=function(e,...t){if(!la.WeakIsAnyInstanceOf(e,...t))throw new TypeError("unexpected type")},la.WeakIsAnyInstanceOf=function(e,...t){for(const s of t)if(la.WeakIsInstanceOf(e,s))return!0;return!1},la.WeakRequireInstanceOf=function(e,t){if(!la.WeakIsInstanceOf(e,t))throw new TypeError("unexpected type")},la.WeakIsInstanceOf=function(e,t){for(;e=Object.getPrototypeOf(e);)if(e.constructor.name===t.name)return!0;return!1},ca.RequireNumber=la.RequireNumber,ca.RequireOptionalNumber=la.RequireOptionalNumber,ca.RequireFiniteNumber=la.RequireFiniteNumber,ca.RequireOptionalFiniteNumber=la.RequireOptionalFiniteNumber,ca.RequireString=la.RequireString,ca.RequireOptionalString=la.RequireOptionalString,ca.RequireObject=la.RequireObject,ca.RequireOptionalObject=la.RequireOptionalObject,ca.RequireArray=la.RequireArray,ca.RequireOptionalArray=la.RequireOptionalArray,ca.RequireFunction=la.RequireFunction,ca.RequireOptionalFunction=la.RequireOptionalFunction,ca.RequireInstanceOf=la.RequireInstanceOf,ca.RequireOptionalInstanceOf=la.RequireOptionalInstanceOf,ca.IsNullOrUndefined=la.IsNullOrUndefined}{let da=function(e,t){let s=ga.getType(e),i=ga.getType(t);return"null"===s||"null"===i||"undefined"!==s&&"undefined"!==i&&s===i},_a=function(e){console.warn("[Defence] "+e+" @",ga.GetCallStack())},pa=function(){if(xa=-1,ya.size>0||Ia.size>0){let e=[...new Set([...ya.keys()].map(e=>ga.getName(e)))].join(",");console.warn(`An object derived from DefendedBase was not protected with debugDefend(). This will disable some checks. See the coding guidelines! Possible affected class names: ${e}`),ya.clear(),Ia.clear()}},fa=function(e){let t=new Set;for(let s in e)t.add(s);return t},ma=function(e,t){let s=fa(t),i=wa.get(e);if(i){let t=[];for(let e of i.values())s.has(e)?s.delete(e):t.push(e);ga.appendArray(t,[...s]),t.length&&console.warn(`[Defence] '${ga.getName(e)}' constructor creates inconsistent properties: ${t.join(", ")}`)}else wa.set(e,s)};isValidTypeChange=da,logDefendedObjectWarning=_a,CheckDefendedObjectsUsedCorrectly=pa,getObjectPropertySet=fa,VerifyObjectPropertiesConsistent=ma;const ga=self.C3,Sa=new Map;let Ga;ga.ColorLog=function(e,t){console.log(`%c${e}`,`font-weight: bold; color:${t}`)},ga.RafLog=function(e,...t){Sa.has(e)||Sa.set(e,-1),-1===Sa.get(e)&&Sa.set(e,requestAnimationFrame(()=>{console.log(`%c${e}`,"font-weight: bold",...t),Sa.set(e,-1)}))},ga.StartMeasure=function(e){performance.mark(e),Ga||(Ga=new Map),Ga.has(e)||Ga.set(e,{current:0,total:0,average:0,calls:1,toString:function(){return`${e} :: current => ${this.current.toPrecision(3)} :: average => ${this.average.toPrecision(3)} :: calls => ${this.calls}`}})},ga.EndMeasure=function(e){performance.measure(`measure-${e}`,e);const t=performance.getEntriesByName(`measure-${e}`)[0],s=Ga.get(e);s.current=t.duration,s.total+=s.current,s.average=s.total/s.calls,console.log(s.toString()),s.calls++,performance.clearMarks(e),performance.clearMeasures(`measure-${e}`)},ga.GetCallStack=function(){return(new Error).stack},ga.Debugger=function(){},ga.cast=function(e,t){return e&&e instanceof t?e:null},ga.getName=function(e){return void 0===e?"undefined":null===e?"null":"boolean"==typeof e?"<boolean>":ga.IsNumber(e)?"<number>":ga.IsString(e)?"<string>":ga.IsArray(e)?"<array>":"symbol"==typeof e?"<"+e.toString()+">":ga.IsFunction(e)?e.name&&"Function"!==e.name?e.name:"<anonymous function>":"object"==typeof e?e.constructor&&e.constructor.name&&"Object"!==e.constructor.name?e.constructor.name:"<anonymous object>":"<unknown>"},ga.getType=function(e){return null===e?"null":Array.isArray(e)?"array":typeof e},ga.range=function*(e,t){if(!isFinite(Math.abs(e-t)))throw new Error("Invalid parameters");if(e>t)for(let s=e-1;s>=t;s--)yield s;else for(let s=e;s<t;s++)yield s};let ya=new Map,Ia=new Map,Ta=new WeakMap,Ca=new WeakMap;ga.DefendHandler={};const ba=new Set(["then","splice"]);ga.DefendHandler.get=function(e,t){return t in e||"symbol"==typeof t||ba.has(t)||_a(`Accessed missing property '${t}' from defended object '${ga.getName(e)}', returning undefined`),Ca.has(e)&&"symbol"!=typeof t&&!ba.has(t)&&_a(`Accessed property '${t}' on a released object '${ga.getName(e)}'\nObject was originally released at: ${Ca.get(e)})\nCall stack at access: `),e[t]},ga.DefendHandler.set=function(e,t,s){return t in e||ya.has(e)||_a(`Set non-existent property '${t}' to '${s}' on defended object '${ga.getName(e)}'`),da(e[t],s)||ya.has(e)||_a(`Set '${ga.getType(e[t])}' property '${t}' to type '${ga.getType(s)}' on defended object '${ga.getName(e)}'`),Ca.has(e)&&_a(`Set property '${t}' on a released object '${ga.getName(e)}'\nObject was originally released at: ${Ca.get(e)})\nCall stack at access: `),e[t]=s,!0},ga.DefendHandler.deleteProperty=function(e,t){throw new ReferenceError(`Cannot delete property '${t}' from defended object '${ga.getName(e)}'`)},ga.DefendHandler.defineProperty=function(e,t,s){throw new ReferenceError(`Cannot define property '${t}' on defended object '${ga.getName(e)}'`)},ga.DefendHandler.enumerate=function(e){throw new ReferenceError(`Cannot enumerate defended object '${ga.getName(e)}'`)};let xa=-1;ga.DefendedBase=class{constructor(){if(!ga.isDebugDefend||!ga.Supports.Proxies)return;let e=new.target,t=Object.create(e.prototype),s=new Proxy(t,ga.DefendHandler);return ya.set(t,s),Ia.set(s,t),Ta.set(s,t),-1===xa&&(xa=requestAnimationFrame(pa)),s}},ga.debugDefend=function(e){if(ga.isDebugDefend&&ga.Supports.Proxies&&e instanceof ga.DefendedBase){if(!Ia.has(e))return e;let t=Ia.get(e);return Ia.delete(e),ya.delete(t),e}return ga.isDebug?Object.seal(e):e},ga.New=function(e,...t){let s;try{s=new e(...t)}catch(e){throw Ia.clear(),ya.clear(),e}return ga.isDebugDefend&&ma(e,s),ga.debugDefend(s)},ga.Release=function(e){let t=Ta.get(e);t&&Ca.set(t,ga.GetCallStack())},ga.WasReleased=function(e){let t=Ta.get(e);return!!t&&!!Ca.get(t)};let wa=new Map;ga.PerfMark=class{constructor(e){this._name="",e&&this.start(e)}start(e){ga.isPerformanceProfiling&&(this._name=e,performance.mark(this._name+"-Start"))}end(){ga.isPerformanceProfiling&&(performance.mark(this._name+"-End"),performance.measure(this._name,this._name+"-Start",this._name+"-End"))}next(e){ga.isPerformanceProfiling&&(this.end(),this._name=e,performance.mark(this._name+"-Start"))}}}{let Pa=function(e){return 0===e&&1/e<0};isNegativeZero=Pa;const Ra=self.C3,va=2*Math.PI,Aa=Math.PI/180,Ma=180/Math.PI;Ra.wrap=function(e,t,s){e=Math.floor(e),t=Math.floor(t);const i=(s=Math.floor(s))-t;if(0===i)return s;if(e<t){const r=s-(t-e)%i;return r===s?0:r}return t+(e-t)%i},Ra.mapToRange=function(e,t,s,i,r){const n=s-t;return 0===n&&0===i?e:(e-t)*(r-i)/n+i},Ra.normalize=function(e,t,s){return t-s===0?1:(e-t)/(s-t)},Ra.clamp=function(e,t,s){return e<t?t:e>s?s:e},Ra.clampAngle=function(e){return(e%=va)<0&&(e+=va),e},Ra.toRadians=function(e){return e*Aa},Ra.toDegrees=function(e){return e*Ma},Ra.hypot2DFast=function(e,t){return Math.sqrt(e*e+t*t)},Ra.hypot3DFast=function(e,t,s){return Math.sqrt(e*e+t*t+s*s)},Ra.distanceTo=function(e,t,s,i){return Ra.hypot2DFast(s-e,i-t)},Ra.distanceSquared=function(e,t,s,i){const r=s-e,n=i-t;return r*r+n*n},Ra.angleTo=function(e,t,s,i){return Math.atan2(i-t,s-e)},Ra.angleDiff=function(e,t){if(e===t)return 0;let s=Math.sin(e),i=Math.cos(e),r=s*Math.sin(t)+i*Math.cos(t);return r>=1?0:r<=-1?Math.PI:Math.acos(r)},Ra.angleRotate=function(e,t,s){let i=Math.sin(e),r=Math.cos(e),n=Math.sin(t),a=Math.cos(t);return Math.acos(i*n+r*a)>s?r*n-i*a>0?Ra.clampAngle(e+s):Ra.clampAngle(e-s):Ra.clampAngle(t)},Ra.angleClockwise=function(e,t){let s=Math.sin(e);return Math.cos(e)*Math.sin(t)-s*Math.cos(t)<=0},Ra.angleLerp=function(e,t,s,i=0){let r=Ra.angleDiff(e,t);const n=va*i;return Ra.angleClockwise(t,e)?Ra.clampAngle(e+(r+n)*s):Ra.clampAngle(e-(r+n)*s)},Ra.angleLerpClockwise=function(e,t,s,i=0){const r=Ra.angleDiff(e,t),n=va*i;return Ra.angleClockwise(t,e)?Ra.clampAngle(e+(r+n)*s):Ra.clampAngle(e+(va-r+n)*s)},Ra.angleLerpAntiClockwise=function(e,t,s,i=0){const r=Ra.angleDiff(e,t),n=va*i;return Ra.angleClockwise(t,e)?Ra.clampAngle(e-(-va+r-n)*s):Ra.clampAngle(e-(r+n)*s)},Ra.angleReflect=function(e,t){const s=Ra.angleDiff(e,t);return Ra.angleClockwise(e,t)?Ra.clampAngle(t-s):Ra.clampAngle(t+s)},Ra.lerp=function(e,t,s){return e+s*(t-e)},Ra.unlerp=function(e,t,s){return e===t?0:(s-e)/(t-e)},Ra.relerp=function(e,t,s,i,r){return Ra.lerp(i,r,Ra.unlerp(e,t,s))},Ra.qarp=function(e,t,s,i){return Ra.lerp(Ra.lerp(e,t,i),Ra.lerp(t,s,i),i)},Ra.cubic=function(e,t,s,i,r){return Ra.lerp(Ra.qarp(e,t,s,r),Ra.qarp(t,s,i,r),r)},Ra.cosp=function(e,t,s){return(e+t+(e-t)*Math.cos(s*Math.PI))/2},Ra.isPOT=function(e){return e>0&&!(e-1&e)},Ra.nextHighestPowerOfTwo=function(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1},Ra.roundToNearestFraction=function(e,t){return Math.round(e*t)/t},Ra.floorToNearestFraction=function(e,t){return Math.floor(e*t)/t},Ra.roundToDp=function(e,t){t=Math.max(Math.floor(t),0);const s=Math.pow(10,t);return Math.round(e*s)/s},Ra.countDecimals=function(e){return Math.floor(e)!==e&&e.toString().split(".")[1].length||0},Ra.toFixed=function(e,t){let s=e.toFixed(t),i=s.length-1;for(;i>=0&&"0"===s.charAt(i);--i);return i>=0&&"."===s.charAt(i)&&--i,i<0?s:s.substr(0,i+1)},Ra.PackRGB=function(e,t,s){return Ra.clamp(e,0,255)|Ra.clamp(t,0,255)<<8|Ra.clamp(s,0,255)<<16};const Da=1024,Ea=1023,Fa=16384,Oa=8191,Ba=-8192;Ra.PackRGBAEx=function(e,t,s,i){return(e=Ra.clamp(Math.floor(1024*e),-8192,8191))<0&&(e+=16384),(t=Ra.clamp(Math.floor(1024*t),-8192,8191))<0&&(t+=16384),(s=Ra.clamp(Math.floor(1024*s),-8192,8191))<0&&(s+=16384),-(16384*e*16384*1024+16384*t*1024+1024*s+(i=Ra.clamp(Math.floor(1023*i),0,1023)))},Ra.PackRGBEx=function(e,t,s){return Ra.PackRGBAEx(e,t,s,1)},Ra.GetRValue=function(e){if(e>=0)return(255&e)/255;{let t=Math.floor(-e/274877906944);return t>8191&&(t-=16384),t/1024}},Ra.GetGValue=function(e){if(e>=0)return((65280&e)>>8)/255;{let t=Math.floor(-e%274877906944/16777216);return t>8191&&(t-=16384),t/1024}},Ra.GetBValue=function(e){if(e>=0)return((16711680&e)>>16)/255;{let t=Math.floor(-e%16777216/1024);return t>8191&&(t-=16384),t/1024}},Ra.GetAValue=function(e){return Pa(e)?0:e>=0?1:Math.floor(-e%1024)/1023},Ra.greatestCommonDivisor=function(e,t){for(e=Math.floor(e),t=Math.floor(t);0!==t;){let s=t;t=e%t,e=s}return e};const ka=[[3,2],[4,3],[5,4],[5,3],[6,5],[14,9],[16,9],[16,10],[21,9]];Ra.getAspectRatio=function(e,t){if((e=Math.floor(e))===(t=Math.floor(t)))return[1,1];for(let s of ka){let i=e/s[0]*s[1];if(Math.abs(t-i)<1)return s.slice(0);if(i=e/s[1]*s[0],Math.abs(t-i)<1)return[s[1],s[0]]}let s=Ra.greatestCommonDivisor(e,t);return[e/s,t/s]},Ra.segmentsIntersect=function(e,t,s,i,r,n,a,o){const h=Math.min(e,s),l=Math.max(e,s),c=Math.min(r,a),u=Math.max(r,a);if(l<c||h>u)return!1;const d=Math.min(t,i),_=Math.max(t,i),p=Math.min(n,o),f=Math.max(n,o);if(_<p||d>f)return!1;const m=r-e+a-s,g=n-t+o-i,S=s-e,G=i-t,y=a-r,I=o-n,T=Math.abs(G*y-I*S),C=y*g-I*m;if(Math.abs(C)>T)return!1;const b=S*g-G*m;return Math.abs(b)<=T},Ra.segmentsIntersectPreCalc=function(e,t,s,i,r,n,a,o,h,l,c,u){const d=Math.min(h,c),_=Math.max(h,c);if(n<d||r>_)return!1;const p=Math.min(l,u),f=Math.max(l,u);if(o<p||a>f)return!1;const m=h-e+c-s,g=l-t+u-i,S=s-e,G=i-t,y=c-h,I=u-l,T=Math.abs(G*y-I*S),C=y*g-I*m;if(Math.abs(C)>T)return!1;const b=S*g-G*m;return Math.abs(b)<=T},Ra.segmentIntersectsQuad=function(e,t,s,i,r){const n=Math.min(e,s),a=Math.max(e,s),o=Math.min(t,i),h=Math.max(t,i),l=r.getTlx(),c=r.getTly(),u=r.getTrx(),d=r.getTry(),_=r.getBrx(),p=r.getBry(),f=r.getBlx(),m=r.getBly();return Ra.segmentsIntersectPreCalc(e,t,s,i,n,a,o,h,l,c,u,d)||Ra.segmentsIntersectPreCalc(e,t,s,i,n,a,o,h,u,d,_,p)||Ra.segmentsIntersectPreCalc(e,t,s,i,n,a,o,h,_,p,f,m)||Ra.segmentsIntersectPreCalc(e,t,s,i,n,a,o,h,f,m,l,c)},Ra.segmentIntersectsAnyN=function(e,t,s,i,r){const n=Math.min(e,s),a=Math.max(e,s),o=Math.min(t,i),h=Math.max(t,i);let l=0;for(let c=r.length-4;l<=c;l+=2)if(Ra.segmentsIntersectPreCalc(e,t,s,i,n,a,o,h,r[l],r[l+1],r[l+2],r[l+3]))return!0;return Ra.segmentsIntersectPreCalc(e,t,s,i,n,a,o,h,r[l],r[l+1],r[0],r[1])};const La=2,Na=1e-6;Ra.rayIntersect=function(e,t,s,i,r,n,a,o){const h=s-e,l=o-n,c=h*l-(i-t)*(a-r);if(0===c)return 2;const u=((t-i)*(a-e)+h*(o-t))/c;return 0<u&&u<1.000001?(l*(a-e)+(r-a)*(o-t))/c:2},Ra.rayIntersectExtended=function(e,t,s,i,r,n,a,o,h){const l=(a-r)*h,c=(o-n)*h;return Ra.rayIntersect(e,t,s,i,r-l,n-c,a+l,o+c)},Ra.isPointInTriangleInclusive=function(e,t,s,i,r,n,a,o){const h=r-s,l=n-i,c=a-s,u=o-i,d=e-s,_=t-i,p=h*h+l*l,f=h*c+l*u,m=h*d+l*_,g=c*c+u*u,S=c*d+u*_,G=1/(p*g-f*f),y=(g*m-f*S)*G,I=(p*S-f*m)*G;return y>=0&&I>=0&&y+I<=1},Ra.triangleCartesianToBarycentric=function(e,t,s,i,r,n,a,o){const h=r-s,l=n-i,c=a-s,u=o-i,d=e-s,_=t-i,p=h*h+l*l,f=h*c+l*u,m=c*c+u*u,g=d*h+_*l,S=d*c+_*u,G=p*m-f*f,y=(m*g-f*S)/G,I=(p*S-f*g)/G;return[1-y-I,y,I]},Ra.triangleBarycentricToCartesian3d=function(e,t,s,i,r,n,a,o,h,l,c,u){return[e*i+t*a+s*l,e*r+t*o+s*c,e*n+t*h+s*u]},Ra.vec3FromArray=function(e,t,s=0){return e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],e},Ra.vec3ToArray=function(e,t,s=0){return t[s]=e[0],t[s+1]=e[1],t[s+2]=e[2],t},Ra.quatFromArray=function(e,t,s=0){return e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],e[3]=t[s+3],e},Ra.mat4FromArray=function(e,t,s=0){return e[0]=t[s],e[1]=t[s+1],e[2]=t[s+2],e[3]=t[s+3],e[4]=t[s+4],e[5]=t[s+5],e[6]=t[s+6],e[7]=t[s+7],e[8]=t[s+8],e[9]=t[s+9],e[10]=t[s+10],e[11]=t[s+11],e[12]=t[s+12],e[13]=t[s+13],e[14]=t[s+14],e[15]=t[s+15],e},Ra.makeScaleMatrix=function(e,t,s,i,r){return e.identity(t),t[0]=s,t[5]=i,t[10]=r,t},Ra.makeTranslateMatrix=function(e,t,s,i,r){return e.identity(t),t[12]=s,t[13]=i,t[14]=r,t}}{let Wa=function(e){const t=Xa.get(e);Xa.delete(e),t&&t(performance.now())};OnTask=Wa;const Ua=self.C3;let Va=null,Ha="";if("undefined"!=typeof document){Va=document;const $a=document.querySelector("base");Ha=$a&&$a.hasAttribute("href")?$a.getAttribute("href"):"",Ha&&(Ha.startsWith("/")&&(Ha=Ha.substr(1)),Ha.endsWith("/")||(Ha+="/"))}Ua.GetBaseHref=function(){return Ha},Ua.GetBaseURL=function(){if(!Va)return"";const e=Va.location;return Ua.GetPathFromURL(e.origin+e.pathname)+Ha},Ua.GetPathFromURL=function(e){if(!e.length)return e;if(e.endsWith("/")||e.endsWith("\\"))return e;const t=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\"));return-1===t?"":e.substr(0,t+1)},Ua.GetFilenameFromURL=function(e){if(!e.length)return e;if(e.endsWith("/")||e.endsWith("\\"))return"";const t=Math.max(e.lastIndexOf("/"),e.lastIndexOf("\\"));return-1===t?e:e.substr(t+1)},Ua.GetFileExtension=function(e){let t=e.lastIndexOf(".");return t<1?"":e.substr(t)},Ua.SetFileExtension=function(e,t){const s=e.lastIndexOf(".");return-1===s?e+"."+t:e.substr(0,s+1)+t},Ua.GetFileNamePart=function(e){let t=e.lastIndexOf(".");return t<1?e:e.substr(0,t)},Ua.NormalizeFileSeparator=function(e){return e.replace(/\\/g,"/")},Ua.IsFileExtension=function(e,t){return t===(e?Ua.GetFileExtension(e).slice(1):"")},Ua.FileNameEquals=function(e,t){let s,i;return Ua.IsFileLike(e)&&(s=Ua.GetFileNamePart(e.name)),Ua.IsString(e)&&(s=Ua.GetFileNamePart(e)),Ua.IsFileLike(t)&&(i=Ua.GetFileNamePart(t.name)),Ua.IsString(t)&&(i=Ua.GetFileNamePart(t)),s===i},Ua.ParseFilePath=function(e){e=Ua.NormalizeFileSeparator(e);let t=/^\w\:\//.exec(e);t?(t=t[0],"/"!==(e=e.slice(3))[0]&&(e="/"+e)):t="",(e=e.replace(/\/{2,}/g,"/")).length>1&&"/"===e.slice(-1)&&(e=e.slice(0,-1));const s=e.lastIndexOf("/")+1;let i,r="",n=e,a="";s>0&&(r=e.slice(0,s),n=e.slice(s)),i=n;const o=n.lastIndexOf(".");return o>0&&(a=n.slice(o),i=n.slice(0,-a.length)),{dir:r,base:n,name:i,root:t,ext:a,full:t+r+n}},Ua.Wait=function(e,t){return new Promise((s,i)=>{self.setTimeout(s,e,t)})},Ua.swallowException=function(e){try{e()}catch(e){Ua.isDebug&&console.warn("Swallowed exception: ",e)}},Ua.noop=function(){},Ua.equalsNoCase=function(e,t){return"string"==typeof e&&"string"==typeof t&&(e===t||e.normalize().toLowerCase()===t.normalize().toLowerCase())},Ua.equalsCase=function(e,t){return"string"==typeof e&&"string"==typeof t&&(e===t||e.normalize()===t.normalize())},Ua.typedArraySet16=function(e,t,s){e[s++]=t[0],e[s++]=t[1],e[s++]=t[2],e[s++]=t[3],e[s++]=t[4],e[s++]=t[5],e[s++]=t[6],e[s++]=t[7],e[s++]=t[8],e[s++]=t[9],e[s++]=t[10],e[s++]=t[11],e[s++]=t[12],e[s++]=t[13],e[s++]=t[14],e[s]=t[15]},Ua.truncateArray=function(e,t){e.length=t},Ua.clearArray=function(e){e&&0!==e.length&&Ua.truncateArray(e,0)},Ua.clear2DArray=function(e){if(e){for(let t=0;t<e.length;t++){let s=e[t];Ua.truncateArray(s,0)}Ua.truncateArray(e,0)}},Ua.extendArray=function(e,t,s){t|=0;const i=e.length;if(!(t<=i))for(let r=i;r<t;++r)e.push(s)},Ua.resizeArray=function(e,t,s){t|=0;const i=e.length;t<i?Ua.truncateArray(e,t):t>i&&Ua.extendArray(e,t,s)},Ua.shallowAssignArray=function(e,t){Ua.clearArray(e),Ua.appendArray(e,t)},Ua.appendArray=function(e,t){if(t.length<1e4)e.push(...t);else for(let s=0,i=t.length;s<i;++s)e.push(t[s])},Ua.arrayRemove=function(e,t){if((t=Math.floor(t))<0||t>=e.length)return;let s=e.length-1;for(let i=t;i<s;++i)e[i]=e[i+1];Ua.truncateArray(e,s)},Ua.arrayFindRemove=function(e,t){let s=e.indexOf(t);s>=0&&e.splice(s,1)},Ua.arraysEqual=function(e,t){let s=e.length;if(t.length!==s)return!1;for(let i=0;i<s;++i)if(e[i]!==t[i])return!1;return!0},Ua.arrayFilterOut=function(e,t){let s=[],i=0;for(let r=0,n=e.length;r<n;++r){let n=e[r];t(n)?s.push(n):(e[i]=n,++i)}return Ua.truncateArray(e,i),s},Ua.arrayRemoveAllInSet=function(e,t){const s=e.length;let i=0;for(let s=0,r=e.length;s<r;++s){let r=e[s];t.has(r)||(e[i++]=r)}return Ua.truncateArray(e,i),s-i},Ua.isArrayIndexInBounds=function(e,t){return e===Math.floor(e)&&e>=0&&e<t.length},Ua.validateArrayIndex=function(e,t){if(!Ua.isArrayIndexInBounds(e,t))throw new RangeError("array index out of bounds")},Ua.cloneArray=function(e){return e.slice()},Ua.deepCloneArray=function(e,t){let s=[];for(let i of e)if(Ua.IsObject(i)){let e=t(i);if(!e)throw new Error("missing clone");if(e.constructor!==i.constructor)throw new Error("object is not a clone");s.push(e)}else Ua.IsArray(i)?s.push(Ua.deepCloneArray(i,t)):s.push(i);return s},Ua.clone2DArray=function(e){let t=[];for(let s of e)t.push(s.slice());return t},Ua.toArrayLike=function(e){return Ua.IsArray(e)?e:e?(e.length=Object.keys(e).length,e):void 0},Ua.splitStringAndNormalize=function(e,t=" "){return e?e.split(t).map(e=>e.trim()).filter(e=>!!e):[]},Ua.ensureSet=function(e){return e instanceof Set?e:new Set(e)},Ua.filterSet=function(e,t,s){const i=new Set;for(const r of e.values())t(r)&&(s?i.add(s(r)):i.add(r));return i},Ua.mergeSetsInPlace=function(e,t){for(const s of t)e.add(s);return e},Ua.first=function(e){for(let t of e)return t;return null},Ua.xor=function(e,t){return!e!=!t},Ua.compare=function(e,t,s){switch(t){case 0:return e===s;case 1:return e!==s;case 2:return e<s;case 3:return e<=s;case 4:return e>s;case 5:return e>=s;default:return!1}},Ua.hasAnyOwnProperty=function(e){for(let t in e)if(e.hasOwnProperty(t))return!0;return!1},Ua.PromiseAllWithProgress=function(e,t){return e.length?new Promise((s,i)=>{const r=[];let n=0,a=!1;for(let o=0,h=e.length;o<h;++o)r.push(void 0),e[o].then(i=>{a||(r[o]=i,++n,n===e.length?s(r):t(n,e.length))}).catch(e=>{a=!0,i(e)})}):Promise.resolve([])};let ja=[];Ua.AddLibraryMemoryCallback=function(e){ja.push(e)},Ua.GetEstimatedLibraryMemoryUsage=function(){let e=0;for(let t of ja)e+=t();return Math.floor(e)};let za=1;const Xa=new Map,Ya=globalThis.scheduler,qa=new MessageChannel;qa.port2.onmessage=e=>Wa(e.data),Ua.RequestUnlimitedAnimationFrame=function(e,t="user-visible"){const s=za++;return Xa.set(s,e),Ya?Ya.postTask(()=>Wa(s),{priority:t}):qa.port1.postMessage(s),s},Ua.CancelUnlimitedAnimationFrame=function(e){Xa.delete(e)},Ua.PostTask=Ua.RequestUnlimitedAnimationFrame,Ua.WaitForNextTask=function(){return new Promise(e=>Ua.PostTask(e))};const Ka=new Set;Ua.RequestPostAnimationFrame=function(e){const t=self.requestAnimationFrame(async s=>{await Ua.WaitForNextTask(),Ka.has(t)&&(Ka.delete(t),e(s))});return Ka.add(t),t},Ua.CancelPostAnimationFrame=function(e){Ka.has(e)&&(self.cancelAnimationFrame(e),Ka.delete(e))}}{const Ja=self.C3;Ja.IsAbsoluteURL=function(e){return/^(?:[a-z\-]+:)?\/\//.test(e)||"data:"===e.substr(0,5)||"blob:"===e.substr(0,5)},Ja.IsRelativeURL=function(e){return!Ja.IsAbsoluteURL(e)},Ja.ThrowIfNotOk=function(e){if(!e.ok)throw new Error(`fetch '${e.url}' response returned ${e.status} ${e.statusText}`)},Ja.FetchOk=function(e,t){return fetch(e,t).then(e=>(Ja.ThrowIfNotOk(e),e))},Ja.FetchText=function(e){return Ja.FetchOk(e).then(e=>e.text())},Ja.FetchJson=function(e){return Ja.FetchOk(e).then(e=>e.json())},Ja.FetchBlob=function(e){return Ja.FetchOk(e).then(e=>e.blob())},Ja.FetchArrayBuffer=function(e){return Ja.FetchOk(e).then(e=>e.arrayBuffer())},Ja.FetchImage=function(e){return new Promise((t,s)=>{const i=new Image;i.onload=()=>t(i),i.onerror=e=>s(e),i.src=e})},Ja.BlobToArrayBuffer=function(e){return"function"==typeof e.arrayBuffer?e.arrayBuffer():new Promise((t,s)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=()=>s(i.error),i.readAsArrayBuffer(e)})},Ja.BlobToString=function(e){return"function"==typeof e.text?e.text():new Promise((t,s)=>{const i=new FileReader;i.onload=()=>t(i.result),i.onerror=()=>s(i.error),i.readAsText(e)})},Ja.BlobToJson=function(e){return Ja.BlobToString(e).then(e=>JSON.parse(e))},Ja.BlobToImage=async function(e,t){let s=URL.createObjectURL(e);try{const e=await Ja.FetchImage(s);return URL.revokeObjectURL(s),s="",t&&"function"==typeof e.decode&&await e.decode(),e}finally{s&&URL.revokeObjectURL(s)}},Ja.CreateCanvas=function(e,t){if("undefined"!=typeof document&&"function"==typeof document.createElement){const s=document.createElement("canvas");return s.width=e,s.height=t,s}return new OffscreenCanvas(e,t)},Ja.CanvasToBlob=function(e,t,s){if("number"!=typeof s&&(s=1),t=t||"image/png",s=Ja.clamp(s,0,1),e.convertToBlob)return e.convertToBlob({type:t,quality:s});if(e.toBlob)return new Promise(i=>e.toBlob(i,t,s));throw new Error("could not convert canvas to blob")},Ja.DrawableToBlob=function(e,t,s){const i=Ja.CreateCanvas(e.width,e.height);return i.getContext("2d").drawImage(e,0,0),Ja.CanvasToBlob(i,t,s)},Ja.ImageDataToBlob=function(e,t,s){if(Ja.Supports.ImageBitmapOptions)return createImageBitmap(e,{premultiplyAlpha:"none"}).then(e=>Ja.DrawableToBlob(e,t,s));if(Ja.Supports.ImageBitmap)return createImageBitmap(e).then(e=>Ja.DrawableToBlob(e,t,s));{const i=Ja.CreateCanvas(e.width,e.height);return i.getContext("2d").putImageData(e,0,0),Ja.CanvasToBlob(i,t,s)}},Ja.CopySet=function(e,t){e.clear();for(const s of t)e.add(s)},Ja.MapToObject=function(e){const t=Object.create(null);for(const[s,i]of e.entries())t[s]=i;return t},Ja.ObjectToMap=function(e,t){t.clear();for(const[s,i]of Object.entries(e))t.set(s,i)},Ja.ToSuperJSON=function e(t){if("object"==typeof t&&null!==t){if(t instanceof Set)return{_c3type_:"set",data:[...t].map(t=>e(t))};if(t instanceof Map)return{_c3type_:"map",data:[...t].map(t=>[t[0],e(t[1])])};{const s=Object.create(null);for(const[i,r]of Object.entries(t))s[i]=e(r);return s}}return t},Ja.FromSuperJSON=function e(t){if("object"==typeof t&null!==t){if("set"===t._c3type_)return new Set(t.data.map(t=>e(t)));if("map"===t._c3type_)return new Map(t.data.map(t=>[t[0],e(t[1])]));{const s=Object.create(null);for(const[i,r]of Object.entries(t))s[i]=e(r);return s}}return t},Ja.CSSToCamelCase=function(e){if(e.startsWith("--"))return e;let t="",s=!1,i=0;for(const r of e)"-"===r?i>0&&(s=!0):s?(t+=r.toUpperCase(),s=!1):t+=r,++i;return t},Ja.IsIterator=function(e){return"object"==typeof e&&"function"==typeof e.next},Ja.MakeFilledArray=function(e,t){const s=[];if("function"==typeof t)for(let i=0;i<e;++i)s.push(t());else for(let i=0;i<e;++i)s.push(t);return s}}{let Za=function(e){return 0===e.length?"00":1===e.length?"0"+e:e},Qa=function(e,t,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?e+6*(t-e)*s:s<.5?t:s<2/3?e+(t-e)*(2/3-s)*6:e};padTwoDigits=Za,hueToRGB=Qa;const eo=self.C3,to=/([0-9.]+),([0-9.]+)\%?,([0-9.]+)\%?/i,so=/([0-9.]+),([0-9.]+)\%?,([0-9.]+)\%?,([0-9.])/i;eo.Color=class{constructor(e,t,s,i){this._r=NaN,this._g=NaN,this._b=NaN,this._a=NaN,this._r=0,this._g=0,this._b=0,this._a=0,e instanceof eo.Color?this.set(e):this.setRgba(e||0,t||0,s||0,i||0)}setRgb(e,t,s){return this._r=+e,this._g=+t,this._b=+s,this.clamp(),this}setRgba(e,t,s,i){return this._r=+e,this._g=+t,this._b=+s,this._a=+i,this.clamp(),this}set(e){return this._r=e._r,this._g=e._g,this._b=e._b,this._a=e._a,this}copy(e){return this.set(e)}add(e){this._r+=e._r,this._g+=e._g,this._b+=e._b,this._a+=e._a,this.clamp()}addRgb(e,t,s,i=0){this._r+=+e,this._g+=+t,this._b+=+s,this._a+=+i,this.clamp()}diff(e){this.setR(Math.max(this._r,e._r)-Math.min(this._r,e._r)),this.setG(Math.max(this._g,e._g)-Math.min(this._g,e._g)),this.setB(Math.max(this._b,e._b)-Math.min(this._b,e._b)),this.setA(Math.max(this._a,e._a)-Math.min(this._a,e._a)),this.clamp()}copyRgb(e){this._r=e._r,this._g=e._g,this._b=e._b}setR(e){this._r=eo.clamp(+e,0,1)}getR(){return this._r}setG(e){this._g=eo.clamp(+e,0,1)}getG(){return this._g}setB(e){this._b=eo.clamp(+e,0,1)}getB(){return this._b}setA(e){this._a=eo.clamp(+e,0,1)}getA(){return this._a}clone(){return eo.New(eo.Color,this._r,this._g,this._b,this._a)}toArray(){return[this._r,this._g,this._b,this._a]}toTypedArray(){return new Float64Array(this.toArray())}writeToTypedArray(e,t){e[t++]=this._r,e[t++]=this._g,e[t++]=this._b,e[t]=this._a}writeToTypedArrayx4(e,t){const s=this._r,i=this._g,r=this._b,n=this._a;e[t++]=s,e[t++]=i,e[t++]=r,e[t++]=n,e[t++]=s,e[t++]=i,e[t++]=r,e[t++]=n,e[t++]=s,e[t++]=i,e[t++]=r,e[t++]=n,e[t++]=s,e[t++]=i,e[t++]=r,e[t]=n}writeRGBToTypedArray(e,t){e[t++]=this._r,e[t++]=this._g,e[t]=this._b}equals(e){return this._r===e._r&&this._g===e._g&&this._b===e._b&&this._a===e._a}equalsIgnoringAlpha(e){return this._r===e._r&&this._g===e._g&&this._b===e._b}equalsRgb(e,t,s){return this._r===e&&this._g===t&&this._b===s}equalsRgba(e,t,s,i){return this._r===e&&this._g===t&&this._b===s&&this._a===i}equalsF32Array(e,t){return e[t]===Math.fround(this._r)&&e[t+1]===Math.fround(this._g)&&e[t+2]===Math.fround(this._b)&&e[t+3]===Math.fround(this._a)}equalsRGBF32Array(e,t){return e[t]===Math.fround(this._r)&&e[t+1]===Math.fround(this._g)&&e[t+2]===Math.fround(this._b)}multiply(e){this._r*=e._r,this._g*=e._g,this._b*=e._b,this._a*=e._a}multiplyAlpha(e){this._r*=e,this._g*=e,this._b*=e,this._a*=e}premultiply(){return this._r*=this._a,this._g*=this._a,this._b*=this._a,this}unpremultiply(){return this._r/=this._a,this._g/=this._a,this._b/=this._a,this}clamp(){return this._r=eo.clamp(this._r,0,1),this._g=eo.clamp(this._g,0,1),this._b=eo.clamp(this._b,0,1),this._a=eo.clamp(this._a,0,1),this}setFromRgbValue(e){this._r=eo.GetRValue(e),this._g=eo.GetGValue(e),this._b=eo.GetBValue(e),this._a=eo.GetAValue(e)}getCssRgb(e,t,s){return`rgb(${100*(eo.IsFiniteNumber(e)?e:this.getR())}%, ${100*(eo.IsFiniteNumber(t)?t:this.getG())}%, ${100*(eo.IsFiniteNumber(s)?s:this.getB())}%)`}getCssRgba(e,t,s,i){return`rgba(${100*(eo.IsFiniteNumber(e)?e:this.getR())}%, ${100*(eo.IsFiniteNumber(t)?t:this.getG())}%, ${100*(eo.IsFiniteNumber(s)?s:this.getB())}%, ${eo.IsFiniteNumber(i)?i:this.getA()})`}toHexString(e=!1){const t=Math.round(255*this.getR()),s=Math.round(255*this.getG()),i=Math.round(255*this.getB());let r="#"+Za(t.toString(16))+Za(s.toString(16))+Za(i.toString(16));return e&&(r+=Za(Math.round(255*this.getA()).toString(16))),r}parseHexString(e){if("string"!=typeof e)return!1;let t,s,i,r;if("#"===(e=e.trim()).charAt(0)&&(e=e.substr(1)),3===e.length||4===e.length)t=parseInt(e[0],16)/15,s=parseInt(e[1],16)/15,i=parseInt(e[2],16)/15,4===e.length&&(r=parseInt(e[3],16)/15);else{if(6!==e.length&&8!==e.length)return!1;t=parseInt(e.substr(0,2),16)/255,s=parseInt(e.substr(2,2),16)/255,i=parseInt(e.substr(4,2),16)/255,8===e.length&&(r=parseInt(e.substr(6,2),16)/255)}return!!(Number.isFinite(t)&&Number.isFinite(s)&&Number.isFinite(i))&&(this.setRgb(t,s,i),Number.isFinite(r)?this.setA(r):this.setA(1),!0)}toCommaSeparatedRgb(){return`${Math.round(255*this.getR())}, ${Math.round(255*this.getG())}, ${Math.round(255*this.getB())}`}toRgbArray(){return[Math.round(255*this.getR()),Math.round(255*this.getG()),Math.round(255*this.getB())]}parseCommaSeparatedRgb(e){if("string"!=typeof e)return!1;const t=(e=e.replace(/^rgb\(|\)|%/,"")).split(",");if(t.length<3)return!1;const s=parseInt(t[0].trim(),10)/255,i=parseInt(t[1].trim(),10)/255,r=parseInt(t[2].trim(),10)/255;return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),this.setA(1),!0}parseCommaSeparatedPercentageRgb(e){if("string"!=typeof e)return!1;const t=(e=e.replace(/^rgb\(|\)|%/,"")).split(",");if(t.length<3)return!1;const s=parseInt(t[0].trim(),10)/100,i=parseInt(t[1].trim(),10)/100,r=parseInt(t[2].trim(),10)/100;return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),this.setA(1),!0}parseCommaSeparatedRgba(e){if("string"!=typeof e)return!1;const t=(e=e.replace(/^rgba\(|\)|%/,"")).split(",");if(t.length<4)return!1;const s=parseInt(t[0].trim(),10)/255,i=parseInt(t[1].trim(),10)/255,r=parseInt(t[2].trim(),10)/255,n=parseFloat(t[3].trim());return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),isFinite(n)&&this.setA(n),!0}parseCommaSeparatedPercentageRgba(e){if("string"!=typeof e)return!1;const t=(e=e.replace(/^rgba\(|\)|%/,"")).split(",");if(t.length<4)return!1;const s=parseInt(t[0].trim(),10)/100,i=parseInt(t[1].trim(),10)/100,r=parseInt(t[2].trim(),10)/100,n=parseFloat(t[3].trim());return isFinite(s)&&this.setR(s),isFinite(i)&&this.setG(i),isFinite(r)&&this.setB(r),isFinite(n)&&this.setA(n),!0}parseString(e){if("string"!=typeof e)return!1;if((e=e.replace(/\s+/,"")).includes(",")){if(e.startsWith("rgb("))return e.includes("%")?this.parseCommaSeparatedPercentageRgb(e):this.parseCommaSeparatedRgb(e);if(e.startsWith("rgba("))return e.includes("%")?this.parseCommaSeparatedPercentageRgba(e):this.parseCommaSeparatedRgba(e);if(e.startsWith("hsl(")||e.startsWith("hsla("))return this.parseHSLString(e);{const t=e.split(",");return e.includes("%")?3===t.length?this.parseCommaSeparatedPercentageRgb(e):4===t.length&&this.parseCommaSeparatedPercentageRgba(e):3===t.length?this.parseCommaSeparatedRgb(e):4===t.length&&this.parseCommaSeparatedRgba(e)}}return this.parseHexString(e)}toJSON(){return[this._r,this._g,this._b,this._a]}setFromHSLA(e,t,s,i){let r,n,a;if(e%=360,t=eo.clamp(t,0,100),s=eo.clamp(s,0,100),i=eo.clamp(i,0,1),e/=360,s/=100,0==(t/=100))r=n=a=s;else{const i=s<.5?s*(1+t):s+t-s*t,o=2*s-i;r=Qa(o,i,e+1/3),n=Qa(o,i,e),a=Qa(o,i,e-1/3)}return this.setR(r),this.setG(n),this.setB(a),this.setA(i),this}parseHSLString(e){const t=e.replace(/ |hsl|hsla|\(|\)|;/gi,""),s=to.exec(t),i=so.exec(t);return s&&4===s.length?(this.setFromHSLA(+s[1],+s[2],+s[3],1),!0):!(!i||5!==i.length||(this.setFromHSLA(+s[1],+s[2],+s[3],+s[4]),0))}toHSLAString(){const e=this._r,t=this._g,s=this._b,i=this._a;return`hsla(${eo.Color.GetHue(e,t,s)}, ${eo.Color.GetSaturation(e,t,s)}%, ${eo.Color.GetLuminosity(e,t,s)}%, ${i})`}toHSLAArray(){const e=this._r,t=this._g,s=this._b;return[eo.Color.GetHue(e,t,s),eo.Color.GetSaturation(e,t,s),eo.Color.GetLuminosity(e,t,s),this._a]}setFromJSON(e){Array.isArray(e)&&(e.length<3||(this._r=e[0],this._g=e[1],this._b=e[2],e.length>=4?this._a=e[3]:this._a=1))}set r(e){this.setR(e)}get r(){return this.getR()}set g(e){this.setG(e)}get g(){return this.getG()}set b(e){this.setB(e)}get b(){return this.getB()}set a(e){this.setA(e)}get a(){return this.getA()}setAtIndex(e,t){switch(e){case 0:this.setR(t);break;case 1:this.setG(t);break;case 2:this.setB(t);break;case 3:this.setA(t);break;default:throw new RangeError("invalid color index")}}getAtIndex(e){switch(e){case 0:return this.getR();case 1:return this.getG();case 2:return this.getB();case 3:return this.getA();default:throw new RangeError("invalid color index")}}static Equals(e,t){let s,i;if(Array.isArray(e))s=new eo.Color,s.setFromJSON(e);else{if(!(e instanceof eo.Color))throw new Error("unexpected type");s=e}if(Array.isArray(t))i=new eo.Color,i.setFromJSON(t);else{if(!(t instanceof eo.Color))throw new Error("unexpected type");i=t}return s.equals(i)}static DiffChannel(e,t){return eo.clamp(Math.max(e,t)-Math.min(e,t),0,1)}static Diff(e,t){const s=new eo.Color;return s.setR(Math.max(e._r,t._r)-Math.min(e._r,t._r)),s.setG(Math.max(e._g,t._g)-Math.min(e._g,t._g)),s.setB(Math.max(e._b,t._b)-Math.min(e._b,t._b)),s.setA(Math.max(e._a,t._a)-Math.min(e._a,t._a)),s}static DiffNoAlpha(e,t){const s=new eo.Color(0,0,0,1);return s.setR(Math.max(e._r,t._r)-Math.min(e._r,t._r)),s.setG(Math.max(e._g,t._g)-Math.min(e._g,t._g)),s.setB(Math.max(e._b,t._b)-Math.min(e._b,t._b)),s}static GetHue(e,t,s){const i=Math.max(e,t,s),r=Math.min(e,t,s);if(i===r)return 0;let n=0;switch(i){case e:n=(t-s)/(i-r)+(t<s?6:0);break;case t:n=(s-e)/(i-r)+2;break;case s:n=(e-t)/(i-r)+4}return Math.round(n/6*360)}static GetSaturation(e,t,s){const i=Math.max(e,t,s),r=Math.min(e,t,s);if(i===r)return 0;const n=i-r,a=(i+r)/2>.5?n/(2-i-r):n/(i+r);return Math.round(100*a)}static GetLuminosity(e,t,s){const i=Math.max(e,t,s),r=(i+Math.min(e,t,s))/2;return i?Math.round(100*r):0}},eo.Color.White=Object.freeze(eo.New(eo.Color,1,1,1,1)),eo.Color.Black=Object.freeze(eo.New(eo.Color,0,0,0,1)),eo.Color.TransparentBlack=Object.freeze(eo.New(eo.Color,0,0,0,0))}{const io=self.C3;io.Vector2=class{constructor(e,t){this._x=0,this._y=0,e instanceof io.Vector2?this.copy(e):this.set(e||0,t||0)}set(e,t){this._x=+e,this._y=+t}copy(e){this._x=e._x,this._y=e._y}equals(e){return this._x===e._x&&this._y===e._y}equalsValues(e,t){return this._x===e&&this._y===t}equalsF32Array(e,t){return e[t]===Math.fround(this._x)&&e[t+1]===Math.fround(this._y)}setX(e){this._x=+e}getX(){return this._x}setY(e){this._y=+e}getY(){return this._y}toArray(){return[this._x,this._y]}toTypedArray(){return new Float64Array(this.toArray())}writeToTypedArray(e,t){e[t++]=this._x,e[t]=this._y}offset(e,t){this._x+=+e,this._y+=+t}scale(e,t){this._x*=e,this._y*=t}divide(e,t){this._x/=e,this._y/=t}round(){this._x=Math.round(this._x),this._y=Math.round(this._y)}floor(){this._x=Math.floor(this._x),this._y=Math.floor(this._y)}ceil(){this._x=Math.ceil(this._x),this._y=Math.ceil(this._y)}angle(){return io.angleTo(0,0,this._x,this._y)}lengthSquared(){return this._x*this._x+this._y*this._y}length(){return io.hypot2DFast(this._x,this._y)}rotatePrecalc(e,t){const s=this._x*t-this._y*e;this._y=this._y*t+this._x*e,this._x=s}rotate(e){0!==e&&this.rotatePrecalc(Math.sin(e),Math.cos(e))}rotateAbout(e,t,s){0===e||t===this._x&&s===this._y||(this._x-=t,this._y-=s,this.rotatePrecalc(Math.sin(e),Math.cos(e)),this._x+=+t,this._y+=+s)}move(e,t){0!==t&&(this._x+=Math.cos(e)*t,this._y+=Math.sin(e)*t)}normalize(){const e=this.length();0!==e&&1!==e&&(this._x/=e,this._y/=e)}clamp(e,t){this._x=io.clamp(this._x,e,t),this._y=io.clamp(this._y,e,t)}dot(e){return this._x*e._x+this._y*e._y}reverse(){this._x=-this._x,this._y=-this._y}perp(){let e=this._x;return this._x=this._y,this._y=-e,this}}}{const ro=self.C3;ro.Rect=class{constructor(e,t,s,i){this._left=NaN,this._top=NaN,this._right=NaN,this._bottom=NaN,this._left=0,this._top=0,this._right=0,this._bottom=0,e instanceof ro.Rect?this.copy(e):this.set(e||0,t||0,s||0,i||0)}set(e,t,s,i){this._left=+e,this._top=+t,this._right=+s,this._bottom=+i}setWH(e,t,s,i){e=+e,t=+t,this._left=e,this._top=t,this._right=e+ +s,this._bottom=t+ +i}copy(e){this._left=+e._left,this._top=+e._top,this._right=+e._right,this._bottom=+e._bottom}clone(){return new ro.Rect(this._left,this._top,this._right,this._bottom)}static Merge(e,t){const s=new ro.Rect;return s.setLeft(Math.min(e._left,t._left)),s.setTop(Math.min(e._top,t._top)),s.setRight(Math.max(e._right,t._right)),s.setBottom(Math.max(e._bottom,t._bottom)),s}static FromObject(e){return new ro.Rect(e.left,e.top,e.right,e.bottom)}equals(e){return this._left===e._left&&this._top===e._top&&this._right===e._right&&this._bottom===e._bottom}equalsWH(e,t,s,i){return this._left===e&&this._top===t&&this.width()===s&&this.height()===i}equalsF32Array(e,t){return e[t]===Math.fround(this._left)&&e[t+1]===Math.fround(this._top)&&e[t+2]===Math.fround(this._right)&&e[t+3]===Math.fround(this._bottom)}setLeft(e){this._left=+e}getLeft(){return this._left}setTop(e){this._top=+e}getTop(){return this._top}setRight(e){this._right=+e}getRight(){return this._right}setBottom(e){this._bottom=+e}getBottom(){return this._bottom}toArray(){return[this._left,this._top,this._right,this._bottom]}toTypedArray(){return new Float64Array(this.toArray())}toDOMRect(){return new DOMRect(this._left,this._top,this.width(),this.height())}static fromDOMRect(e){return ro.New(ro.Rect,e.left,e.top,e.right,e.bottom)}writeToTypedArray(e,t){e[t++]=this._left,e[t++]=this._top,e[t++]=this._right,e[t]=this._bottom}writeAsQuadToTypedArray(e,t){const s=this._left,i=this._top,r=this._right,n=this._bottom;e[t++]=s,e[t++]=i,e[t++]=r,e[t++]=i,e[t++]=r,e[t++]=n,e[t++]=s,e[t]=n}writeAsQuadToTypedArray3D(e,t,s){const i=this._left,r=this._top,n=this._right,a=this._bottom;e[t++]=i,e[t++]=r,e[t++]=s,e[t++]=n,e[t++]=r,e[t++]=s,e[t++]=n,e[t++]=a,e[t++]=s,e[t++]=i,e[t++]=a,e[t]=s}width(){return this._right-this._left}height(){return this._bottom-this._top}midX(){return(this._left+this._right)/2}midY(){return(this._top+this._bottom)/2}offset(e,t){e=+e,t=+t,this._left+=e,this._top+=t,this._right+=e,this._bottom+=t}offsetLeft(e){this._left+=+e}offsetTop(e){this._top+=+e}offsetRight(e){this._right+=+e}offsetBottom(e){this._bottom+=+e}toSquare(e){if("x"!==e)throw new Error("invalid axis, only 'x' supported");this._top<this._bottom?this._left<this._right?this._bottom=this._top+this.width():this._bottom=this._top-this.width():this._left<this._right?this._bottom=this._top-this.width():this._bottom=this._top+this.width()}inflate(e,t){e=+e,t=+t,this._left-=e,this._top-=t,this._right+=e,this._bottom+=t}deflate(e,t){e=+e,t=+t,this._left+=e,this._top+=t,this._right-=e,this._bottom-=t}multiply(e,t){this._left*=e,this._top*=t,this._right*=e,this._bottom*=t}divide(e,t){this._left/=e,this._top/=t,this._right/=e,this._bottom/=t}mirrorAround(e){this._left=+e-this._left,this._right=+e-this._right}flipAround(e){this._top=+e-this._top,this._bottom=+e-this._bottom}rotate90DegreesAround(e,t){const s=this.width(),i=this.height(),r=this.getLeft()+s*e,n=this.getTop()+i*t;this.setWH(r-i*t,n-s*e,i,s)}swapLeftRight(){const e=this._left;this._left=this._right,this._right=e}swapTopBottom(){const e=this._top;this._top=this._bottom,this._bottom=e}shuntY(e){const t=this._top;this._top=+e-this._bottom,this._bottom=+e-t}round(){this._left=Math.round(this._left),this._top=Math.round(this._top),this._right=Math.round(this._right),this._bottom=Math.round(this._bottom)}roundInner(){this._left=Math.ceil(this._left),this._top=Math.ceil(this._top),this._right=Math.floor(this._right),this._bottom=Math.floor(this._bottom)}roundOuter(){this._left=Math.floor(this._left),this._top=Math.floor(this._top),this._right=Math.ceil(this._right),this._bottom=Math.ceil(this._bottom)}floor(){this._left=Math.floor(this._left),this._top=Math.floor(this._top),this._right=Math.floor(this._right),this._bottom=Math.floor(this._bottom)}ceil(){this._left=Math.ceil(this._left),this._top=Math.ceil(this._top),this._right=Math.ceil(this._right),this._bottom=Math.ceil(this._bottom)}clamp(e,t,s,i){this._left=Math.max(this._left,+e),this._top=Math.max(this._top,+t),this._right=Math.min(this._right,+s),this._bottom=Math.min(this._bottom,+i)}clampBoth(e,t,s,i){e=+e,t=+t,s=+s,i=+i,this._left=ro.clamp(this._left,e,s),this._top=ro.clamp(this._top,t,i),this._right=ro.clamp(this._right,e,s),this._bottom=ro.clamp(this._bottom,t,i)}normalize(){this._left>this._right&&this.swapLeftRight(),this._top>this._bottom&&this.swapTopBottom()}intersectsRect(e){return!(e._right<this._left||e._bottom<this._top||e._left>this._right||e._top>this._bottom)}intersectsRectOffset(e,t,s){return!(e._right+t<this._left||e._bottom+s<this._top||e._left+t>this._right||e._top+s>this._bottom)}containsPoint(e,t){return e>=this._left&&e<=this._right&&t>=this._top&&t<=this._bottom}containsRect(e){return e._left>=this._left&&e._top>=this._top&&e._right<=this._right&&e._bottom<=this._bottom}expandToContain(e){e._left<this._left&&(this._left=+e._left),e._top<this._top&&(this._top=+e._top),e._right>this._right&&(this._right=+e._right),e._bottom>this._bottom&&(this._bottom=+e._bottom)}lerpInto(e){this._left=ro.lerp(e._left,e._right,this._left),this._top=ro.lerp(e._top,e._bottom,this._top),this._right=ro.lerp(e._left,e._right,this._right),this._bottom=ro.lerp(e._top,e._bottom,this._bottom)}}}{const no=self.C3;no.Quad=class{constructor(e,t,s,i,r,n,a,o){this._tlx=NaN,this._tly=NaN,this._trx=NaN,this._try=NaN,this._brx=NaN,this._bry=NaN,this._blx=NaN,this._bly=NaN,this._tlx=0,this._tly=0,this._trx=0,this._try=0,this._brx=0,this._bry=0,this._blx=0,this._bly=0,e instanceof no.Quad?this.copy(e):this.set(e||0,t||0,s||0,i||0,r||0,n||0,a||0,o||0)}set(e,t,s,i,r,n,a,o){this._tlx=+e,this._tly=+t,this._trx=+s,this._try=+i,this._brx=+r,this._bry=+n,this._blx=+a,this._bly=+o}setRect(e,t,s,i){this.set(e,t,s,t,s,i,e,i)}copy(e){this._tlx=e._tlx,this._tly=e._tly,this._trx=e._trx,this._try=e._try,this._brx=e._brx,this._bry=e._bry,this._blx=e._blx,this._bly=e._bly}equals(e){return this._tlx===e._tlx&&this._tly===e._tly&&this._trx===e._trx&&this._try===e._try&&this._brx===e._brx&&this._bry===e._bry&&this._blx===e._blx&&this._bly===e._bly}setTlx(e){this._tlx=+e}getTlx(){return this._tlx}setTly(e){this._tly=+e}getTly(){return this._tly}setTrx(e){this._trx=+e}getTrx(){return this._trx}setTry(e){this._try=+e}getTry(){return this._try}setBrx(e){this._brx=+e}getBrx(){return this._brx}setBry(e){this._bry=+e}getBry(){return this._bry}setBlx(e){this._blx=+e}getBlx(){return this._blx}setBly(e){this._bly=+e}getBly(){return this._bly}toDOMQuad(){return new DOMQuad(new DOMPoint(this._tlx,this._tly),new DOMPoint(this._trx,this._try),new DOMPoint(this._brx,this._bry),new DOMPoint(this._blx,this._bly))}static fromDOMQuad(e){return no.New(no.Quad,e.p1.x,e.p1.y,e.p2.x,e.p2.y,e.p3.x,e.p3.y,e.p4.x,e.p4.y)}toArray(){return[this._tlx,this._tly,this._trx,this._try,this._brx,this._bry,this._blx,this._bly]}toTypedArray(){return new Float64Array(this.toArray())}writeToTypedArray(e,t){e[t++]=this._tlx,e[t++]=this._tly,e[t++]=this._trx,e[t++]=this._try,e[t++]=this._brx,e[t++]=this._bry,e[t++]=this._blx,e[t]=this._bly}writeToTypedArray3D(e,t,s){e[t++]=this._tlx,e[t++]=this._tly,e[t++]=s,e[t++]=this._trx,e[t++]=this._try,e[t++]=s,e[t++]=this._brx,e[t++]=this._bry,e[t++]=s,e[t++]=this._blx,e[t++]=this._bly,e[t]=s}offset(e,t){e=+e,t=+t,this._tlx+=e,this._tly+=t,this._trx+=e,this._try+=t,this._brx+=e,this._bry+=t,this._blx+=e,this._bly+=t}round(){this._tlx=Math.round(this._tlx),this._tly=Math.round(this._tly),this._trx=Math.round(this._trx),this._try=Math.round(this._try),this._brx=Math.round(this._brx),this._bry=Math.round(this._bry),this._blx=Math.round(this._blx),this._bly=Math.round(this._bly)}floor(){this._tlx=Math.floor(this._tlx),this._tly=Math.floor(this._tly),this._trx=Math.floor(this._trx),this._try=Math.floor(this._try),this._brx=Math.floor(this._brx),this._bry=Math.floor(this._bry),this._blx=Math.floor(this._blx),this._bly=Math.floor(this._bly)}ceil(){this._tlx=Math.ceil(this._tlx),this._tly=Math.ceil(this._tly),this._trx=Math.ceil(this._trx),this._try=Math.ceil(this._try),this._brx=Math.ceil(this._brx),this._bry=Math.ceil(this._bry),this._blx=Math.ceil(this._blx),this._bly=Math.ceil(this._bly)}setFromRect(e){this._tlx=e._left,this._tly=e._top,this._trx=e._right,this._try=e._top,this._brx=e._right,this._bry=e._bottom,this._blx=e._left,this._bly=e._bottom}setFromRotatedRect(e,t){0===t?this.setFromRect(e):this.setFromRotatedRectPrecalc(e,Math.sin(t),Math.cos(t))}setFromRotatedRectPrecalc(e,t,s){const i=e._left*t,r=e._top*t,n=e._right*t,a=e._bottom*t,o=e._left*s,h=e._top*s,l=e._right*s,c=e._bottom*s;this._tlx=o-r,this._tly=h+i,this._trx=l-r,this._try=h+n,this._brx=l-a,this._bry=c+n,this._blx=o-a,this._bly=c+i}getBoundingBox(e){e.set(Math.min(this._tlx,this._trx,this._brx,this._blx),Math.min(this._tly,this._try,this._bry,this._bly),Math.max(this._tlx,this._trx,this._brx,this._blx),Math.max(this._tly,this._try,this._bry,this._bly))}containsPoint(e,t){let s=this._trx-this._tlx,i=this._try-this._tly;const r=this._brx-this._tlx,n=this._bry-this._tly,a=e-this._tlx,o=t-this._tly;let h=s*s+i*i,l=s*r+i*n,c=s*a+i*o;const u=r*r+n*n,d=r*a+n*o;let _=1/(h*u-l*l),p=(u*c-l*d)*_,f=(h*d-l*c)*_;return p>=0&&f>0&&p+f<1||(s=this._blx-this._tlx,i=this._bly-this._tly,h=s*s+i*i,l=s*r+i*n,c=s*a+i*o,_=1/(h*u-l*l),p=(u*c-l*d)*_,f=(h*d-l*c)*_,p>=0&&f>0&&p+f<1)}midX(){return(this._tlx+this._trx+this._brx+this._blx)/4}midY(){return(this._tly+this._try+this._bry+this._bly)/4}intersectsSegment(e,t,s,i){return!(!this.containsPoint(e,t)&&!this.containsPoint(s,i))||no.segmentIntersectsQuad(e,t,s,i,this)}intersectsQuad(e){let t=e.midX(),s=e.midY();if(this.containsPoint(t,s))return!0;if(t=this.midX(),s=this.midY(),e.containsPoint(t,s))return!0;const i=this._tlx,r=this._tly,n=this._trx,a=this._try,o=this._brx,h=this._bry,l=this._blx,c=this._bly;return no.segmentIntersectsQuad(i,r,n,a,e)||no.segmentIntersectsQuad(n,a,o,h,e)||no.segmentIntersectsQuad(o,h,l,c,e)||no.segmentIntersectsQuad(l,c,i,r,e)}rotatePointsAnticlockwise(){const e=this._tlx,t=this._tly;this._tlx=this._trx,this._tly=this._try,this._trx=this._brx,this._try=this._bry,this._brx=this._blx,this._bry=this._bly,this._blx=e,this._bly=t}mirror(){this._swap(0,2),this._swap(1,3),this._swap(6,4),this._swap(7,5)}flip(){this._swap(0,6),this._swap(1,7),this._swap(2,4),this._swap(3,5)}diag(){this._swap(2,6),this._swap(3,7)}_swap(e,t){const s=this._getAtIndex(e);this._setAtIndex(e,this._getAtIndex(t)),this._setAtIndex(t,s)}_getAtIndex(e){switch(e){case 0:return this._tlx;case 1:return this._tly;case 2:return this._trx;case 3:return this._try;case 4:return this._brx;case 5:return this._bry;case 6:return this._blx;case 7:return this._bly;default:throw new RangeError("invalid quad point index")}}_setAtIndex(e,t){switch(t=+t,e){case 0:this._tlx=t;break;case 1:this._tly=t;break;case 2:this._trx=t;break;case 3:this._try=t;break;case 4:this._brx=t;break;case 5:this._bry=t;break;case 6:this._blx=t;break;case 7:this._bly=t;break;default:throw new RangeError("invalid quad point index")}}divide(e,t){this._tlx/=e,this._tly/=t,this._trx/=e,this._try/=t,this._brx/=e,this._bry/=t,this._blx/=e,this._bly/=t}}}{const ao=self.C3,oo=self.assert,ho=[0,0,1,0,1,1,0,1],lo=ao.New(ao.Quad);ao.CollisionPoly=class extends ao.DefendedBase{constructor(e,t=!0){super(),e||(e=ho),this._ptsArr=Float64Array.from(e),this._bbox=new ao.Rect,this._isBboxChanged=!0,this._enabled=t}Release(){}pointsArr(){return this._ptsArr}pointCount(){return this._ptsArr.length/2}setPoints(e){this._ptsArr.length===e.length?this._ptsArr.set(e):this._ptsArr=Float64Array.from(e),this._isBboxChanged=!0}setDefaultPoints(){this.setPoints(ho)}copy(e){this.setPoints(e._ptsArr)}setBboxChanged(){this._isBboxChanged=!0}_updateBbox(){if(!this._isBboxChanged)return;const e=this._ptsArr;let t=e[0],s=e[1],i=t,r=s;for(let n=0,a=e.length;n<a;n+=2){const a=e[n],o=e[n+1];a<t&&(t=a),a>i&&(i=a),o<s&&(s=o),o>r&&(r=o)}this._bbox.set(t,s,i,r),this._isBboxChanged=!1}setFromRect(e,t,s){let i=this._ptsArr;8!==i.length&&(i=new Float64Array(8),this._ptsArr=i),i[0]=e.getLeft()-t,i[1]=e.getTop()-s,i[2]=e.getRight()-t,i[3]=e.getTop()-s,i[4]=e.getRight()-t,i[5]=e.getBottom()-s,i[6]=e.getLeft()-t,i[7]=e.getBottom()-s,this._bbox.copy(e),0===t&&0===s||this._bbox.offset(-t,-s),this._isBboxChanged=!1}setFromQuad(e,t,s){lo.copy(e),lo.offset(t,s),this.setPoints(lo.toArray()),this._isBboxChanged=!0}transform(e,t,s){let i=0,r=1;0!==s&&(i=Math.sin(s),r=Math.cos(s)),this.transformPrecalc(e,t,i,r)}transformPrecalc(e,t,s,i){const r=this._ptsArr;for(let n=0,a=r.length;n<a;n+=2){const a=n+1,o=r[n]*e,h=r[a]*t;r[n]=o*i-h*s,r[a]=h*i+o*s}this._isBboxChanged=!0}offset(e,t){const s=this._ptsArr;for(let i=0,r=s.length;i<r;i+=2)s[i]+=e,s[i+1]+=t}containsPoint(e,t){const s=this._ptsArr;if(e===s[0]&&t===s[1])return!0;this._updateBbox();const i=this._bbox,r=i.getLeft()-110,n=i.getTop()-101,a=i.getRight()+131,o=i.getBottom()+120;let h=0,l=0,c=0,u=0,d=0,_=0,p=0,f=0;r<e?(h=r,c=e):(h=e,c=r),n<t?(l=n,u=t):(l=t,u=n),a<e?(d=a,p=e):(d=e,p=a),o<t?(_=o,f=t):(_=t,f=o);let m=0,g=0;for(let i=0,S=s.length;i<S;i+=2){const G=(i+2)%S,y=s[i],I=s[i+1],T=s[G],C=s[G+1];ao.segmentsIntersectPreCalc(r,n,e,t,h,c,l,u,y,I,T,C)&&++m,ao.segmentsIntersectPreCalc(a,o,e,t,d,p,_,f,y,I,T,C)&&++g}return m%2==1||g%2==1}intersectsPoly(e,t,s){const i=e._ptsArr,r=this._ptsArr;if(this.containsPoint(i[0]+t,i[1]+s))return!0;if(e.containsPoint(r[0]-t,r[1]-s))return!0;for(let e=0,n=r.length;e<n;e+=2){const a=(e+2)%n,o=r[e],h=r[e+1],l=r[a],c=r[a+1];let u=0,d=0,_=0,p=0;o<l?(u=o,_=l):(u=l,_=o),h<c?(d=h,p=c):(d=c,p=h);for(let e=0,r=i.length;e<r;e+=2){const n=(e+2)%r,a=i[e]+t,f=i[e+1]+s,m=i[n]+t,g=i[n+1]+s;if(ao.segmentsIntersectPreCalc(o,h,l,c,u,_,d,p,a,f,m,g))return!0}}return!1}intersectsSegment(e,t,s,i,r,n){if(this.containsPoint(s-e,i-t))return!0;if(this.containsPoint(r-e,n-t))return!0;let a=0,o=0,h=0,l=0;s<r?(a=s,h=r):(a=r,h=s),i<n?(o=i,l=n):(o=n,l=i);const c=this._ptsArr;for(let u=0,d=c.length;u<d;u+=2){const _=(u+2)%d,p=c[u]+e,f=c[u+1]+t,m=c[_]+e,g=c[_+1]+t;if(ao.segmentsIntersectPreCalc(s,i,r,n,a,h,o,l,p,f,m,g))return!0}return!1}mirror(e){const t=this._ptsArr;for(let s=0,i=t.length;s<i;s+=2)t[s]=2*e-t[s];this._isBboxChanged=!0}flip(e){const t=this._ptsArr;for(let s=0,i=t.length;s<i;s+=2){const i=s+1;t[i]=2*e-t[i]}this._isBboxChanged=!0}diag(){const e=this._ptsArr;for(let t=0,s=e.length;t<s;t+=2){const s=t+1,i=e[t];e[t]=e[s],e[s]=i}this._isBboxChanged=!0}GetMidX(){const e=this._ptsArr;let t=0;for(let s=0,i=e.length;s<i;s+=2)t+=e[s];return t/this.pointCount()}GetMidY(){const e=this._ptsArr;let t=0;for(let s=0,i=e.length;s<i;s+=2)t+=e[s+1];return t/this.pointCount()}GetPointsArray(){return this._ptsArr}GetPointCount(){return this.pointCount()}IsEnabled(){return this._enabled}}}{const co=self.C3;co.PairMap=class extends co.DefendedBase{constructor(e){if(super(),this._firstMap=new Map,e)for(const[t,s,i]of e)this.Set(t,s,i)}Release(){this.Clear(),this._firstMap=null}IsEmpty(){return 0===this._firstMap.size}Clear(){const e=this._firstMap;for(const t of e.values())t.clear();e.clear()}Set(e,t,s){const i=this._firstMap;let r=i.get(e);r||(r=new Map,i.set(e,r)),r.set(t,s)}Get(e,t){const s=this._firstMap.get(e);return s?s.get(t):s}Has(e,t){const s=this._firstMap.get(e);return!!s&&s.has(t)}Delete(e,t){const s=this._firstMap,i=s.get(e);if(!i)return!1;const r=i.delete(t);return r&&0===i.size&&s.delete(e),r}DeleteEither(e){const t=this._firstMap,s=t.get(e);s&&(s.clear(),t.delete(e));for(const[s,i]of t.entries())i.delete(e)&&0===i.size&&t.delete(s)}GetSize(){let e=0;for(const t of this._firstMap.values())e+=t.size;return e}*values(){for(const e of this._firstMap.values())yield*e.values()}*keyPairs(){for(const[e,t]of this._firstMap.entries())for(const s of t.keys())yield[e,s]}*entries(){for(const[e,t]of this._firstMap.entries())for(const[s,i]of t.entries())yield[e,s,i]}}}{const uo=self.C3;uo.ArraySet=class extends uo.DefendedBase{constructor(){super(),this._set=new Set,this._arr=[],this._needToRebuildArray=!1}Release(){this.Clear()}Clear(){this._set.clear(),uo.clearArray(this._arr),this._needToRebuildArray=!1}Add(e){this._set.has(e)||(this._set.add(e),this._needToRebuildArray||this._arr.push(e))}Has(e){return this._set.has(e)}Delete(e){this._set.delete(e)&&(this._needToRebuildArray=!0)}GetSize(){return this._set.size}IsEmpty(){return 0===this._set.size}GetArray(){return this._needToRebuildArray&&(this._RebuildArray(),this._needToRebuildArray=!1),this._arr}_RebuildArray(){const e=this._arr;uo.clearArray(e);for(const t of this._set)e.push(t)}}}{const _o=self.C3,po=new Map,fo=new Map,mo=new Map,go=new Map,So=new Map,Go=new Map,yo=new Map,Io=new Map,To=new Map;To.set("linear","noease"),To.set("default","noease");const Co=["default","noease","easeinquad","easeoutquad","easeinoutquad","easeincubic","easeoutcubic","easeinoutcubic","easeinquart","easeoutquart","easeinoutquart","easeinquint","easeoutquint","easeinoutquint","easeinsine","easeoutsine","easeinoutsine","easeinexpo","easeoutexpo","easeinoutexpo","easeincirc","easeoutcirc","easeinoutcirc","easeinelastic","easeoutelastic","easeinoutelastic","easeinback","easeoutback","easeinoutback","easeinbounce","easeoutbounce","easeinoutbounce"],bo=["default","noease","quad","cubic","quart","quint","sine","expo","circ","elastic","back","bounce"],xo=new Map([["linear","noease"],["in-sine","easeinsine"],["out-sine","easeoutsine"],["in-out-sine","easeinoutsine"],["in-elastic","easeinelastic"],["out-elastic","easeoutelastic"],["in-out-elastic","easeinoutelastic"],["in-back","easeinback"],["out-back","easeoutback"],["in-out-back","easeinoutback"],["in-bounce","easeinbounce"],["out-bounce","easeoutbounce"],["in-out-bounce","easeinoutbounce"],["in-cubic","easeincubic"],["out-cubic","easeoutcubic"],["in-out-cubic","easeinoutcubic"],["in-quadratic","easeinquad"],["out-quadratic","easeoutquad"],["in-out-quadratic","easeinoutquad"],["in-quartic","easeinquart"],["out-quartic","easeoutquart"],["in-out-quartic","easeinoutquart"],["in-quintic","easeinquint"],["out-quintic","easeoutquint"],["in-out-quintic","easeinoutquint"],["in-circular","easeincirc"],["out-circular","easeoutcirc"],["in-out-circular","easeinoutcirc"],["in-exponential","easeinexpo"],["out-exponential","easeoutexpo"],["in-out-exponential","easeinoutexpo"]]);self.Ease=class e{constructor(){}static InheritEase(){return"default"}static DefaultEase(){return"noease"}static ToInternal(e){return xo.get(e)}static GetEditorEaseNames(t,...s){let i,r;this._CreateEaseMap(),t?(mo.has(t)||mo.set(t,new Map),i=mo.get(t),r=[...i.keys()].filter(s=>!e.GetEditorEaseData(s,t)||e.GetEditorEaseData(s,t).transition.IsForAnyPurpose())):(i=So,r=[...i.keys()]);const n=r.sort();return[...fo.keys()].concat(n).filter(e=>!s.includes(e))}static GetRuntimeEaseNames(){this._CreateEaseMap();const e=[...So.keys()];return e.sort(),[...fo.keys()].concat(e)}static GetCustomRuntimeEaseNames(){this._CreateEaseMap();const e=[...So.keys()];return e.sort(),e}static IsPredefinedTranslatedName(e){for(const t of Co)if(self.lang(`ui.bars.timeline.eases.${t}`)===e)return!0;for(const t of bo)if(self.lang(`ui.bars.timeline.short-eases.${t}`)===e)return!0}static IsNamePredefined(e){return this._CreateEaseMap(),[...fo.keys()].includes(e)}static _GetEase(t){const s=To.get(t);return s?po.get(s):e.IsNamePredefined(t)?po.get(t):yo.has(t)?yo.get(t):void 0}static GetBuiltInTransition(e){return this._CreateEaseMap(),Io.get(e)}static GetEditorEase(t,s){this._CreateEaseMap();const i=e._GetEase(t);if(i)return i;if(!s)throw new Error("missing ease function");return mo.get(s).get(t)}static GetEditorEaseData(e,t){this._CreateEaseMap();const s=go.get(t);if(s)return s.get(e)}static HasEditorEase(t,s){return this._CreateEaseMap(),!!e._GetEase(t)||!!mo.get(s).get(t)}static GetRuntimeEase(t){this._CreateEaseMap();return e._GetEase(t)||So.get(t)}static GetRuntimeEaseData(e){return this._CreateEaseMap(),Go.get(e)}static GetEaseFromIndex(e){return this._CreateEaseMap(),this.GetRuntimeEaseNames()[e]}static GetIndexForEase(e,t){return this._CreateEaseMap(),this.GetEditorEaseNames(t).indexOf(e)}static GetIndexForEaseAtRuntime(e){return this.GetIndexForEase(e)}static _CreateEaseMap(){0===po.size&&(this._AddPredifinedEase("default",()=>{}),this._AddPredifinedEase("noease",[{x:0,y:0,sax:.336,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.336,eay:0,se:!1,ee:!0}],!0),this._AddPredifinedEase("easeinsine",[{x:0,y:0,sax:.485,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.038,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutsine",[{x:0,y:0,sax:.038,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.485,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutsine",[{x:0,y:0,sax:.336,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.336,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinelastic",[{x:0,y:0,sax:.018,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.116,y:.002,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.266,y:-.005,sax:.024,say:0,eax:-.021,eay:0,se:!0,ee:!0},{x:.416,y:.016,sax:.024,say:0,eax:-.026,eay:0,se:!0,ee:!0},{x:.566,y:-.045,sax:.061,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.716,y:.132,sax:.072,say:-.004,eax:-.045,eay:0,se:!0,ee:!0},{x:.866,y:-.373,sax:.06,say:0,eax:-.049,eay:-.002,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.038,eay:-.263,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutelastic",[{x:0,y:0,sax:.038,say:.263,eax:0,eay:0,se:!0,ee:!1},{x:.136,y:1.373,sax:.049,say:.002,eax:-.06,eay:0,se:!0,ee:!0},{x:.286,y:.868,sax:.045,say:0,eax:-.072,eay:.004,se:!0,ee:!0},{x:.436,y:1.045,sax:.025,say:0,eax:-.061,eay:0,se:!0,ee:!0},{x:.586,y:.984,sax:.026,say:0,eax:-.024,eay:0,se:!0,ee:!0},{x:.736,y:1.005,sax:.021,say:0,eax:-.024,eay:0,se:!0,ee:!0},{x:.886,y:.998,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.018,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutelastic",[{x:0,y:0,sax:.025,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.067,y:.001,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.18,y:-.005,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.292,y:.025,sax:.053,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.405,y:-.118,sax:.069,say:0,eax:-.027,eay:0,se:!0,ee:!0},{x:.597,y:1.118,sax:.027,say:0,eax:-.069,eay:0,se:!0,ee:!0},{x:.71,y:.975,sax:.025,say:0,eax:-.053,eay:0,se:!0,ee:!0},{x:.822,y:1.005,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.935,y:.999,sax:.025,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.025,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinback",[{x:0,y:0,sax:.35,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.34,eay:-1.579,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutback",[{x:0,y:0,sax:.34,say:1.579,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.35,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutback",[{x:0,y:0,sax:.035,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.242,y:-.1,sax:.258,say:0,eax:-.025,eay:0,se:!0,ee:!0},{x:.76,y:1.1,sax:.025,say:0,eax:-.26,eay:0,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.035,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinbounce",[{x:0,y:0,sax:.033,say:.025,eax:0,eay:0,se:!0,ee:!1},{x:.092,y:0,sax:.026,say:.078,eax:-.033,eay:.025,se:!0,ee:!0},{x:.274,y:0,sax:.097,say:.319,eax:-.026,eay:.078,se:!0,ee:!0},{x:.637,y:0,sax:.105,say:.625,eax:-.097,eay:.319,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.125,eay:-.004,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutbounce",[{x:0,y:0,sax:.125,say:.004,eax:0,eay:0,se:!0,ee:!1},{x:.365,y:1,sax:.097,say:-.319,eax:-.105,eay:-.625,se:!0,ee:!0},{x:.728,y:1,sax:.026,say:-.078,eax:-.097,eay:-.319,se:!0,ee:!0},{x:.91,y:1,sax:.033,say:-.025,eax:-.026,eay:-.078,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.033,eay:-.025,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutbounce",[{x:0,y:0,sax:.01,say:.006,eax:0,eay:0,se:!0,ee:!1},{x:.046,y:0,sax:.021,say:.038,eax:-.01,eay:.006,se:!0,ee:!0},{x:.137,y:0,sax:.059,say:.158,eax:-.021,eay:.038,se:!0,ee:!0},{x:.319,y:0,sax:.117,say:.744,eax:-.059,eay:.158,se:!0,ee:!0},{x:.683,y:1,sax:.059,say:-.158,eax:-.117,eay:-.744,se:!0,ee:!0},{x:.865,y:1,sax:.021,say:-.038,eax:-.059,eay:-.158,se:!0,ee:!0},{x:.956,y:1,sax:.01,say:-.006,eax:-.021,eay:-.038,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.01,eay:-.006,se:!1,ee:!0}]),this._AddPredifinedEase("easeincubic",[{x:0,y:0,sax:.75,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.138,eay:-.321,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutcubic",[{x:0,y:0,sax:.138,say:.321,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.75,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutcubic",[{x:0,y:0,sax:.285,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.5,y:.5,sax:.081,say:.272,eax:-.081,eay:-.272,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.285,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinquad",[{x:0,y:0,sax:.4,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.178,eay:-.392,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutquad",[{x:0,y:0,sax:.178,say:.392,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.4,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutquad",[{x:0,y:0,sax:.25,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.5,y:.5,sax:.03,say:.065,eax:-.03,eay:-.065,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.25,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinquart",[{x:0,y:0,sax:.5,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.25,eay:-1,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutquart",[{x:0,y:0,sax:.25,say:1,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.5,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutquart",[{x:0,y:0,sax:.765,say:.03,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.765,eay:-.03,se:!1,ee:!0}]),this._AddPredifinedEase("easeinquint",[{x:0,y:0,sax:.6,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.2,eay:-1,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutquint",[{x:0,y:0,sax:.2,say:1,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.6,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutquint",[{eax:0,eay:0,ee:!1,sax:.84,say:0,se:!0,x:0,y:0},{eax:-.84,eay:0,ee:!0,sax:0,say:0,se:!1,x:1,y:1}]),this._AddPredifinedEase("easeincirc",[{x:0,y:0,sax:.25,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.024,eay:-.808,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutcirc",[{x:0,y:0,sax:.024,say:.808,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.25,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutcirc",[{x:0,y:0,sax:.125,say:0,eax:0,eay:0,se:!0,ee:!1},{x:.5,y:.5,sax:.02,say:.428,eax:-.02,eay:-.428,se:!0,ee:!0},{x:1,y:1,sax:0,say:0,eax:-.125,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinexpo",[{x:0,y:0,sax:.66,say:0,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.14,eay:-1,se:!1,ee:!0}]),this._AddPredifinedEase("easeoutexpo",[{x:0,y:0,sax:.14,say:1,eax:0,eay:0,se:!0,ee:!1},{x:1,y:1,sax:0,say:0,eax:-.66,eay:0,se:!1,ee:!0}]),this._AddPredifinedEase("easeinoutexpo",[{eax:0,eay:0,ee:!1,sax:.345,say:0,se:!0,x:0,y:0},{eax:-.06,eay:-.5,ee:!0,sax:.06,say:.5,se:!0,x:.5,y:.5},{eax:-.335,eay:0,ee:!0,sax:0,say:0,se:!1,x:1,y:1}]),this._AddPrivateCustomEase("cubicbezier",this.EaseCubicBezier),this._AddPrivateCustomEase("spline",this.EaseSpline))}static _AddPredifinedEase(t,s,i=!1){if("function"==typeof s)e._AddEase(t,s,"predefined");else{if(!_o.IsArray(s))throw new Error("unexpected arguments");if(self.BuiltInTransition){const r=_o.New(self.BuiltInTransition,t,i);r.SetFromJson(s),e._AddEase(t,(e,t,s,i)=>r.Interpolate(e,t,s,i),"predefined"),Io.set(t,r)}else{const r=_o.New(_o.Transition,[t,s.map(e=>[e.x,e.y,e.sax,e.say,e.eax,e.eay,e.se,e.ee])],!1);r.MakeLinear(i),e._AddEase(t,(e,t,s,i)=>r.Interpolate(e,t,s,i),"predefined")}}}static _AddPrivateCustomEase(t,s){e._AddEase(t,s,"private")}static AddCustomEase(t,s,i,r){this._CreateEaseMap(),e._AddEase(t,s,"custom",i,r)}static RemoveCustomEase(e,t){if(this.IsNamePredefined(e))return;if([...yo.keys()].includes(e))return;const s=mo.get(t);s&&s.delete(e);const i=go.get(t);i&&i.delete(e)}static _AddEase(e,t,s,i,r){switch(s){case"predefined":po.set(e,t),fo.set(e,t);break;case"custom":i?(mo.has(i)||mo.set(i,new Map),go.has(i)||go.set(i,new Map),mo.get(i).set(e,t),go.get(i).set(e,r)):(So.set(e,t),Go.set(e,r));break;case"private":po.set(e,t),yo.set(e,t);break;default:throw new Error("unexpected ease mode")}}static NoEase(e,t,s,i){return 0===i?t:s*e/i+t}static EaseCubicBezier(e,t,s,i,r){return t+3*e*(s-t)+3*e**2*(t+i-2*s)+e**3*(r-t+3*s-3*i)}static EaseSpline(e,t,s,i,r,n,a,o,h,l){if(i===r&&n===a)return e;const c=ko(e,t,i,n,o,l),u=Do(s,r,a,h),d=Eo(s,r,a,h),_=Fo(s,r,a,h);return Oo(c,u,d,_)}static GetBezierSamples(e,t,s,i){const r=[],n=Do(e,t,s,i),a=Eo(e,t,s,i),o=Fo(e,t,s,i);for(let e=0;e<wo;++e){const t=Oo(e*Po,n,a,o);r.push(t)}return r}};const wo=11,Po=1/(wo-1),Ro=4,vo=.01,Ao=1e-7,Mo=10,Do=(e,t,s,i)=>i-3*s+3*t-e,Eo=(e,t,s,i)=>3*s-6*t+3*e,Fo=(e,t,s,i)=>3*(t-e),Oo=(e,t,s,i)=>((t*e+s)*e+i)*e,Bo=(e,t,s,i)=>3*t*e*e+2*s*e+i,ko=(e,t,s,i,r,n)=>{if(1==e)return 1;let a=0,o=1,h=n[o],l=wo-1;for(n[wo-1];o!=l&&h<=e;)o++,h=n[o],a+=Po;o--,h=n[o];let c=a+(e-h)/(n[o+1]-h)*Po;const u=Do(t,s,i,r),d=Eo(t,s,i,r),_=Fo(t,s,i,r),p=Bo(c,u,d,_);if(0===p)return c;if(p>=.01){for(let t=0;t<4;++t)c-=(Oo(c,u,d,_)-e)/Bo(c,u,d,_);return c}{let t,s,i=a,r=a+Po,n=0;do{c=i+(r-i)/2;let a=Oo(c,u,d,_)-e;a>0?r=c:i=c,t=Math.abs(a)>1e-7,s=++n<10}while(t&&s);return c}}}{let Lo=function(e){No.IsString(e)};RequireStringOrNumber=Lo;const No=self.C3;No.ProbabilityTable=class{constructor(e){this._items=[],this._name=e||"",this._totalWeight=0}Release(){this.Clear(),this._items=null}GetName(){return this._name}Clear(){No.clear2DArray(this._items),this._totalWeight=0}GetTotalWeight(){return this._totalWeight}Sample(e=Math.random()*this.GetTotalWeight()){let t=0;for(const[s,i]of this._items)if(t+=s,e<t)return i;return 0}HasItems(){return!!this._items.length}AddItem(e,t){Lo(t),this._totalWeight+=e,this._items.push([e,t])}RemoveItem(e,t){Lo(t);const s=0===e;for(let i=0;i<this._items.length;i++){const r=this._items[i],n=s||r[0]===e,a=r[1]===t;if(n&&a){this._items.splice(i,1),this._totalWeight-=r[0];break}}}asJSON(){return JSON.stringify(this._items)}static fromJSON(e,t){const s=new No.ProbabilityTable(t),i=JSON.parse(e);for(const e of i){const t=e[0],i=e[1];s.AddItem(t,i)}return s}}}{const Wo=self.C3;let Uo=0;Wo.ScreenReaderText=class{constructor(e,t){this._runtime=e,this._text=t,this._id=Uo++,this._runtime.PostComponentMessageToDOM("runtime","screen-reader-text",{type:"create",id:this._id,text:this._text})}Release(){this._runtime.PostComponentMessageToDOM("runtime","screen-reader-text",{type:"release",id:this._id}),this._runtime=null,this._text="",this._id=-1}SetText(e){this._text!==e&&(this._text=e,this._runtime.PostComponentMessageToDOM("runtime","screen-reader-text",{type:"update",id:this._id,text:this._text}))}}}{const Vo=self.C3;Vo.Event=class{constructor(e,t){this.type=e,this.cancelable=!!t,this.defaultPrevented=!1,this.propagationStopped=!1,this.isAsync=!1}preventDefault(){if(!this.cancelable)throw new Error(`event '${this.type}' is not cancelable`);this.defaultPrevented=!0}stopPropagation(){if(!this.cancelable)throw new Error(`event '${this.type}' cannot be stopped`);if(this.isAsync)throw new Error(`cannot stop async event '${this.type}' propagation`);this.propagationStopped=!0}}}{const Ho=self.C3,jo=self.assert;Ho.Event.Handler=class extends Ho.DefendedBase{#e=null;#t=null;#s=0;#i=null;constructor(){super()}Release(){this.#s>0||(this.#e&&(this.#e.clear(),this.#e=null),this.#t&&(this.#t.clear(),this.#t=null),this.#i&&(Ho.clearArray(this.#i),this.#i=null),Ho.Release(this))}_AddListener(e,t){if(this.#r())return this.#i||(this.#i=[]),void this.#i.push({op:"add",func:e,capture:t});t?(this.#e||(this.#e=new Set),this.#e.add(e)):(this.#t||(this.#t=new Set),this.#t.add(e))}_RemoveListener(e,t){if(this.#r())return this.#i||(this.#i=[]),void this.#i.push({op:"remove",func:e,capture:t});t?this.#e&&(this.#e.delete(e),0===this.#e.size&&(this.#e=null)):this.#t&&(this.#t.delete(e),0===this.#t.size&&(this.#t=null))}_IsEmpty(){return!this.#e&&!this.#t}#r(){return this.#s>0}#n(){if(this.#i){for(const e of this.#i)if("add"===e.op)this._AddListener(e.func,e.capture);else{if("remove"!==e.op)throw new Error("invalid op");this._RemoveListener(e.func,e.capture)}Ho.clearArray(this.#i),this.#i=null}}_FireCancellable(e){this.#a();let t=!1;if(this.#e)for(const s of this.#e)if(s(e),e.propagationStopped){t=!0;break}if(!t&&this.#t)for(const t of this.#t)if(t(e),e.propagationStopped)break;return this.#o(),!e.defaultPrevented}_FireNonCancellable(e){if(this.#a(),this.#e)for(const t of this.#e)t(e);if(this.#t)for(const t of this.#t)t(e);return this.#o(),!0}#a(){this.#s++}#o(){this.#s--,0===this.#s&&this.#i&&this.#i.length>0&&this.#n()}SetDelayRemoveEventsEnabled(e){e?this.#a():this.#o()}_FireAsync(e){let t=[];if(this.#e)for(const s of this.#e)t.push(Ho.Asyncify(()=>s(e)));if(this.#t)for(const s of this.#t)t.push(Ho.Asyncify(()=>s(e)));return Promise.all(t).then(()=>!e.defaultPrevented)}_FireAndWait_AsyncOptional(e){const t=[];if(this.#a(),this.#e)for(const s of this.#e){const i=s(e);i instanceof Promise&&t.push(i)}if(this.#t)for(const s of this.#t){const i=s(e);i instanceof Promise&&t.push(i)}return this.#o(),t.length?Promise.all(t).then(()=>!e.defaultPrevented):!e.defaultPrevented}async _FireAndWaitAsync(e){return await this._FireAndWait_AsyncOptional(e)}async _FireAndWaitAsyncSequential(e){if(this.#a(),this.#e)for(const t of this.#e){const s=t(e);s instanceof Promise&&await s}if(this.#t)for(const t of this.#t){const s=t(e);s instanceof Promise&&await s}return this.#o(),!e.defaultPrevented}*_FireAsGenerator(e){if(this.#a(),this.#e)for(const t of this.#e){const s=t(e);Ho.IsIterator(s)&&(yield*s)}if(this.#t)for(const t of this.#t){const s=t(e);Ho.IsIterator(s)&&(yield*s)}this.#o()}}}{const zo=self.C3,Xo=new WeakSet;zo.Event.Dispatcher=class extends zo.DefendedBase{#e=null;constructor(){super()}Release(){if(Xo.has(this))throw new Error("already released");this.ClearEvents(),Xo.add(this),zo.Release(this)}WasReleased(){return Xo.has(this)}ClearEvents(){if(this.#e){for(const e of this.#e.values())e.Release();this.#e.clear(),this.#e=null}}_GetHandlerByType(e,t){if(this.#e){const t=this.#e.get(e);if(t)return t}if(t){const t=zo.New(zo.Event.Handler);return this.#e||(this.#e=new Map),this.#e.set(e,t),t}return null}HasAnyHandlerFor(e){return this.#e&&this.#e.has(e)}addEventListener(e,t,s){this._GetHandlerByType(e,!0)._AddListener(t,!!s)}removeEventListener(e,t,s){const i=this._GetHandlerByType(e,!1);i&&(i._RemoveListener(t,!!s),this.#e&&i._IsEmpty()&&this.#e.delete(e))}dispatchEvent(e){const t=this._GetHandlerByType(e.type,!1);return!t||(e.cancelable?t._FireCancellable(e):t._FireNonCancellable(e))}dispatchEventAsync(e){const t=this._GetHandlerByType(e.type,!1);return t?(e.isAsync=!0,t._FireAsync(e)):Promise.resolve(!0)}async dispatchEventAndClearAsync(e){const t=this._GetHandlerByType(e.type,!1);if(!t)return!0;this.#e&&this.#e.delete(e.type),e.isAsync=!0;const s=await t._FireAsync(e);return t.Release(),s}async dispatchEventAndWaitAsync(e){const t=this._GetHandlerByType(e.type,!1);return!t||await t._FireAndWaitAsync(e)}dispatchEventAndWait_AsyncOptional(e){const t=this._GetHandlerByType(e.type,!1);return!t||t._FireAndWait_AsyncOptional(e)}async dispatchEventAndWaitAsyncSequential(e){const t=this._GetHandlerByType(e.type,!1);return!t||await t._FireAndWaitAsyncSequential(e)}dispatchGeneratorEvent(e){const t=this._GetHandlerByType(e.type,!1);if(!t)return null;if(e.cancelable)throw new Error("not supported");return t._FireAsGenerator(e)}SetDelayRemoveEventsEnabled(e){if(this.#e)for(const t of this.#e.values())t.SetDelayRemoveEventsEnabled(e)}}}{let Yo=function(e){sh=eh&&0===ih?requestIdleCallback(qo,{timeout:35}):setTimeout(qo,ih>0?1:e)},qo=function(e){if(sh=-1,!th.length)return;let t=performance.now(),s=t,i=0,r=0;do{Ko(th.shift()),s=performance.now(),++i,r=(s-t)/i*1.1}while(th.length&&(eh&&0===ih&&void 0!==e?r<e.timeRemaining():s-t+r<12));if(-1===sh&&th.length){let e=s-t;Yo(Math.max(16-e,4))}},Ko=function(e){let t;try{t=e.func()}catch(t){return void e.reject(t)}e.resolve(t)};SetNewCallback=Yo,DoAsyncifiedWork=qo,DoNextAsyncifiedJob=Ko;const $o=self.C3,Jo=12,Zo=16,Qo=35,eh="undefined"!=typeof requestIdleCallback;let th=[],sh=-1,ih=0,rh=$o.QueryString.Has("disable-asyncify");rh&&console.warn("[Asyncify] Asyncify has been disabled due to disable-asyncify in the query string. Some work will now be done synchronously."),$o.Asyncify=function(e){let t=null;return $o.isDebug&&(t=$o.GetCallStack()),new Promise((s,i)=>{th.push({func:e,resolve:s,reject:i,stack:t}),rh?Ko(th.pop()):-1===sh&&Yo(16)})},$o.Asyncify.SetHighThroughputMode=function(e){if(e)++ih;else if(--ih,ih<0)throw new Error("already turned off high throughput mode")}}{let nh=function(){ch=-1},ah=function(){uh=-1,dh=-1;let e=Date.now();for(let t of _h)if(t._CheckTimeout(e)){let e=t._GetDeadline();(-1===dh||e<dh)&&(dh=e)}else _h.delete(t);if(-1!==dh){let t=Math.max(dh-e+100,1e3);uh=self.setTimeout(ah,t)}};ClearTimeCache=nh,CheckActiveIdleTimeouts=ah;const oh=self.C3,hh=1e3,lh=100;let ch=-1;oh.FastGetDateNow=function(){return-1===ch&&(ch=Date.now(),self.setTimeout(nh,16)),ch};let uh=-1,dh=-1,_h=new Set;oh.IdleTimeout=class{constructor(e,t){this._callback=e,this._timeout=1e3*t,this._deadline=0,this._isActive=!1}Reset(){let e=oh.FastGetDateNow();this._deadline=e+this._timeout,this._isActive||(_h.add(this),this._isActive=!0),-1===uh?(dh=this._deadline,uh=self.setTimeout(ah,this._timeout+100)):this._deadline<dh&&dh>e+1e3&&(self.clearTimeout(uh),dh=this._deadline,uh=self.setTimeout(ah,this._timeout+100))}_CheckTimeout(e){return!(e>=this._deadline&&(this._callback()?(this._deadline=e+this._timeout,0):(this._isActive=!1,1)))}_GetDeadline(){return this._deadline}Cancel(){this._isActive&&(_h.delete(this),this._isActive=!1,0===_h.size&&-1!==uh&&(self.clearTimeout(uh),uh=-1,dh=-1))}Release(){this.Cancel(),this._callback=null}}}{const ph=self.C3,fh=new WeakSet;ph.Disposable=class e{constructor(e){this._disposeAction=e}Dispose(){fh.has(this)||(fh.add(this),this._disposeAction&&(this._disposeAction(),this._disposeAction=null))}IsDisposed(){return fh.has(this)}Release(){this.Dispose()}static Release(t){return new e(()=>t.Release())}static From(e,t,s,i,r){if("string"!=typeof t&&!Array.isArray(t))throw new TypeError("expected string or array");if(null==i)i=!1;else if("boolean"!=typeof i&&"object"!=typeof i)throw new TypeError("invalid event listener options");if(r&&(s=s.bind(r)),Array.isArray(t)||t.includes(" ")){"string"==typeof t&&(t=t.split(" "));const r=new ph.CompositeDisposable;for(const n of t)e.addEventListener(n,s,i),r.Add(ph.New(ph.Disposable,()=>e.removeEventListener(n,s,i)));return r}return e.addEventListener(t,s,i),ph.New(ph.Disposable,()=>e.removeEventListener(t,s,i))}},ph.StubDisposable=class extends ph.Disposable{SetAction(e){this._disposeAction=e}},ph.CompositeDisposable=class extends ph.Disposable{constructor(...e){super(),this._disposables=new Set;for(const t of e)this.Add(t)}Add(...e){if(this.IsDisposed())throw new Error("already disposed");for(const t of e)this._disposables.add(t)}Remove(e){if(this.IsDisposed())throw new Error("already disposed");this._disposables.delete(e)}RemoveAll(){if(this.IsDisposed())throw new Error("already disposed");if(this._disposables){for(const e of this._disposables)e.Dispose();this._disposables.clear()}}Dispose(){if(this.IsDisposed())throw new Error("already disposed");super.Dispose();for(const e of this._disposables)e.Dispose();this._disposables.clear(),this._disposables=null}}}{const mh=self.C3;mh.KahanSum=class extends mh.DefendedBase{constructor(){super(),this._c=0,this._y=0,this._t=0,this._sum=0}Add(e){e=+e,this._y=e-this._c,this._t=this._sum+this._y,this._c=this._t-this._sum-this._y,this._sum=this._t}Subtract(e){this._sum-=+e}Get(){return this._sum}Reset(){this._c=0,this._y=0,this._t=0,this._sum=0}Set(e){this._c=0,this._y=0,this._t=0,this._sum=+e}Copy(e){this._c=e._c,this._y=e._y,this._t=e._t,this._sum=e._sum}Release(){}}}{const gh=self.C3,Sh={},Gh=!0,yh=!1;Sh.RBnode=function(e){this.tree=e,this.right=this.tree.sentinel,this.left=this.tree.sentinel,this.parent=null,this.color=!1,this.key=null},Sh.RedBlackSet=function(e){this.size=0,this.sentinel=new Sh.RBnode(this),this.sentinel.color=!1,this.root=this.sentinel,this.root.parent=this.sentinel,this.compare=e||this.default_compare},Sh.RedBlackSet.prototype.default_compare=function(e,t){return e<t?-1:t<e?1:0},Sh.RedBlackSet.prototype.clone=function(){var e=new Sh.RedBlackSet(this.compare);return e.insertAll(this),e},Sh.RedBlackSet.prototype.clear=function(){this.size=0,this.sentinel=new Sh.RBnode(this),this.sentinel.color=!1,this.root=this.sentinel,this.root.parent=this.sentinel},Sh.RedBlackSet.prototype.leftRotate=function(e){var t=e.right;e.right=t.left,t.left!=this.sentinel&&(t.left.parent=e),t.parent=e.parent,e.parent==this.sentinel?this.root=t:e==e.parent.left?e.parent.left=t:e.parent.right=t,t.left=e,e.parent=t},Sh.RedBlackSet.prototype.rightRotate=function(e){var t=e.left;e.left=t.right,t.right!=this.sentinel&&(t.right.parent=e),t.parent=e.parent,e.parent==this.sentinel?this.root=t:e==e.parent.right?e.parent.right=t:e.parent.left=t,t.right=e,e.parent=t},Sh.RedBlackSet.prototype.insert=function(e){if(this.contains(e))this.get_(e).key=e;else{var t=new Sh.RBnode(this);t.key=e;for(var s=this.sentinel,i=this.root;i!=this.sentinel;)s=i,i=this.compare(t.key,i.key)<0?i.left:i.right;t.parent=s,s==this.sentinel?this.root=t:this.compare(t.key,s.key)<0?s.left=t:s.right=t,t.left=this.sentinel,t.right=this.sentinel,t.color=Gh,this.insertFixup(t),this.size++}},Sh.RedBlackSet.prototype.insertFixup=function(e){for(;e!=this.sentinel&&e!=this.root&&e.parent.color==Gh;){var t;e.parent==e.parent.parent.left?(t=e.parent.parent.right).color==Gh?(e.parent.color=!1,t.color=!1,e.parent.parent.color=Gh,e=e.parent.parent):(e==e.parent.right&&(e=e.parent,this.leftRotate(e)),e.parent.color=!1,e.parent.parent.color=Gh,e.parent.parent!=this.sentinel&&this.rightRotate(e.parent.parent)):(t=e.parent.parent.left).color==Gh?(e.parent.color=!1,t.color=!1,e.parent.parent.color=Gh,e=e.parent.parent):(e==e.parent.left&&(e=e.parent,this.rightRotate(e)),e.parent.color=!1,e.parent.parent.color=Gh,e.parent.parent!=this.sentinel&&this.leftRotate(e.parent.parent))}this.root.color=!1},Sh.RedBlackSet.prototype.delete_=function(e){var t,s;(s=(t=e.left==this.sentinel||e.right==this.sentinel?e:this.successor_(e)).left!=this.sentinel?t.left:t.right).parent=t.parent,t.parent==this.sentinel?this.root=s:t==t.parent.left?t.parent.left=s:t.parent.right=s,t!=e&&(e.key=t.key),0==t.color&&this.deleteFixup(s),this.size--},Sh.RedBlackSet.prototype.deleteFixup=function(e){for(;e!=this.root&&0==e.color;){var t;e==e.parent.left?((t=e.parent.right).color==Gh&&(t.color=!1,e.parent.color=Gh,this.leftRotate(e.parent),t=e.parent.right),0==t.left.color&&0==t.right.color?(t.color=Gh,e=e.parent):(0==t.right.color&&(t.left.color=!1,t.color=Gh,this.rightRotate(t),t=e.parent.right),t.color=e.parent.color,e.parent.color=!1,t.right.color=!1,this.leftRotate(e.parent),e=this.root)):((t=e.parent.left).color==Gh&&(t.color=!1,e.parent.color=Gh,this.rightRotate(e.parent),t=e.parent.left),0==t.right.color&&0==t.left.color?(t.color=Gh,e=e.parent):(0==t.left.color&&(t.right.color=!1,t.color=Gh,this.leftRotate(t),t=e.parent.left),t.color=e.parent.color,e.parent.color=!1,t.left.color=!1,this.rightRotate(e.parent),e=this.root))}e.color=!1},Sh.RedBlackSet.prototype.remove=function(e){var t=this.get_(e);if(t!=this.sentinel){var s=t.key;return this.delete_(t),s}return null},Sh.RedBlackSet.prototype.removeSwapped=function(e,t){this.remove(t)},Sh.RedBlackSet.prototype.min=function(e){for(;e.left!=this.sentinel;)e=e.left;return e},Sh.RedBlackSet.prototype.max=function(e){for(;e.right!=this.sentinel;)e=e.right;return e},Sh.RedBlackSet.prototype.successor_=function(e){if(e.right!=this.sentinel)return this.min(e.right);for(var t=e.parent;t!=this.sentinel&&e==t.right;)e=t,t=t.parent;return t},Sh.RedBlackSet.prototype.predeccessor_=function(e){if(e.left!=this.sentinel)return this.max(e.left);for(var t=e.parent;t!=this.sentinel&&e==t.left;)e=t,t=t.parent;return t},Sh.RedBlackSet.prototype.successor=function(e){if(this.size>0){var t=this.get_(e);if(t==this.sentinel)return null;if(t.right!=this.sentinel)return this.min(t.right).key;for(var s=t.parent;s!=this.sentinel&&t==s.right;)t=s,s=s.parent;return s!=this.sentinel?s.key:null}return null},Sh.RedBlackSet.prototype.predecessor=function(e){if(this.size>0){var t=this.get_(e);if(t==this.sentinel)return null;if(t.left!=this.sentinel)return this.max(t.left).key;for(var s=t.parent;s!=this.sentinel&&t==s.left;)t=s,s=s.parent;return s!=this.sentinel?s.key:null}return null},Sh.RedBlackSet.prototype.getMin=function(){return this.min(this.root).key},Sh.RedBlackSet.prototype.getMax=function(){return this.max(this.root).key},Sh.RedBlackSet.prototype.get_=function(e){for(var t=this.root;t!=this.sentinel&&0!=this.compare(t.key,e);)t=this.compare(e,t.key)<0?t.left:t.right;return t},Sh.RedBlackSet.prototype.contains=function(e){return null!=this.get_(e).key},Sh.RedBlackSet.prototype.getValues=function(){var e=[];return this.forEach(function(t){e.push(t)}),e},Sh.RedBlackSet.prototype.insertAll=function(e){if("array"==Sh.typeOf(e))for(var t=0;t<e.length;t++)this.insert(e[t]);else if("function"==Sh.typeOf(e.forEach))e.forEach(this.insert,this);else if("function"==Sh.typeOf(e.getValues)){var s=e.getValues();for(t=0;t<s.length;t++)this.insert(s[t])}else if("object"==Sh.typeOf(e))for(var i in e)this.insert(e[i])},Sh.RedBlackSet.prototype.removeAll=function(e){if("array"==Sh.typeOf(e))for(var t=0;t<e.length;t++)this.remove(e[t]);else if("function"==Sh.typeOf(e.forEach))e.forEach(this.removeSwapped,this);else if("function"==Sh.typeOf(e.getValues)){var s=e.getValues();for(t=0;t<s.length;t++)this.remove(s[t])}else if("object"==Sh.typeOf(e))for(var i in e)this.remove(e[i])},Sh.RedBlackSet.prototype.containsAll=function(e){if("array"==Sh.typeOf(e)){for(var t=0;t<e.length;t++)if(!this.contains(e[t]))return!1;return!0}if("function"==Sh.typeOf(e.forEach))return e.every(this.contains,this);if("function"==Sh.typeOf(e.getValues)){var s=e.getValues();for(t=0;t<s.length;t++)if(!this.contains(s[t]))return!1;return!0}if("object"==Sh.typeOf(e)){for(var i in e)if(!this.contains(e[i]))return!1;return!0}},Sh.RedBlackSet.prototype.range=function(e,t){var s=[];return this.traverseFromTo(function(e){s.push(e)},e,t),s},Sh.RedBlackSet.prototype.traverse=function(e,t){if(!this.isEmpty())for(var s=this.min(this.root);s!=this.sentinel;){if(e.call(t,s.key,this))return;s=this.successor_(s)}},Sh.RedBlackSet.prototype.traverseFrom=function(e,t,s){if(!this.isEmpty())for(var i=this.get_(t);i!=this.sentinel;){if(e.call(s,i.key,this))return;i=this.successor_(i)}},Sh.RedBlackSet.prototype.traverseTo=function(e,t,s){if(!this.isEmpty())for(var i=this.min(this.root),r=this.get_(t);i!=r;){if(e.call(s,i.key,this))return;i=this.successor_(i)}},Sh.RedBlackSet.prototype.traverseFromTo=function(e,t,s,i){if(!this.isEmpty())for(var r=this.get_(t),n=this.get_(s);r!=n;){if(e.call(i,r.key,this))return;r=this.successor_(r)}},Sh.RedBlackSet.prototype.traverseBackwards=function(e,t){if(!this.isEmpty())for(var s=this.max(this.root);s!=this.sentinel;){if(e.call(t,s.key,this))return;s=this.predeccessor_(s)}},Sh.RedBlackSet.prototype.forEach=function(e,t){if(!this.isEmpty())for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))e.call(t,s.key,s.key,this)},Sh.RedBlackSet.prototype.some=function(e,t){if(this.isEmpty())return!1;for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))if(e.call(t,s.key,s.key,this))return!0;return!1},Sh.RedBlackSet.prototype.every=function(e,t){if(this.isEmpty())return!1;for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))if(!e.call(t,s.key,s.key,this))return!1;return!0},Sh.RedBlackSet.prototype.map=function(e,t){var s=[];if(this.isEmpty())return s;for(var i=this.min(this.root);i!=this.sentinel;i=this.successor_(i))s.push(e.call(t,i.key,i.key,this));return s},Sh.RedBlackSet.prototype.filter=function(e,t){var s=[];if(this.isEmpty())return s;for(var i=this.min(this.root);i!=this.sentinel;i=this.successor_(i))e.call(t,i.key,i.key,this)&&s.push(i.key);return s},Sh.RedBlackSet.prototype.getCount=function(){return this.size},Sh.RedBlackSet.prototype.isEmpty=function(){return 0==this.size},Sh.RedBlackSet.prototype.isSubsetOf=function(e){var t=Sh.getCount(e);if(this.getCount()>t)return!1;var s=0;if(this.isEmpty())return!0;for(var i=this.min(this.root);i!=this.sentinel;i=this.successor_(i))Sh.contains.call(e,e,i.key)&&s++;return s==this.getCount()},Sh.RedBlackSet.prototype.intersection=function(e){var t=new Sh.RedBlackSet(this.compare);if(this.isEmpty())return t;for(var s=this.min(this.root);s!=this.sentinel;s=this.successor_(s))e.contains.call(e,s.key,s.key,this)&&t.insert(s.key);return t},gh.RedBlackSet=class extends gh.DefendedBase{constructor(e){super(),this._rbSet=new Sh.RedBlackSet(e),this._enableQueue=!1,this._queueInsert=new Set,this._queueRemove=new Set}Add(e){this._enableQueue?this._rbSet.contains(e)?this._queueRemove.delete(e):this._queueInsert.add(e):this._rbSet.insert(e)}Remove(e){this._enableQueue?this._rbSet.contains(e)?this._queueRemove.add(e):this._queueInsert.delete(e):this._rbSet.remove(e)}Has(e){return this._enableQueue?!!this._queueInsert.has(e)||!this._queueRemove.has(e)&&this._rbSet.contains(e):this._rbSet.contains(e)}Clear(){this._rbSet.clear(),this._queueInsert.clear(),this._queueRemove.clear()}toArray(){if(this._enableQueue)throw new Error("cannot be used in queueing mode");return this._rbSet.getValues()}GetSize(){return this._rbSet.getCount()+this._queueInsert.size-this._queueRemove.size}IsEmpty(){return 0===this.GetSize()}Front(){if(this.IsEmpty())throw new Error("empty set");if(this._enableQueue)throw new Error("cannot be used in queueing mode");const e=this._rbSet;return e.min(e.root).key}Shift(){if(this.IsEmpty())throw new Error("empty set");if(this._enableQueue)throw new Error("cannot be used in queueing mode");const e=this.Front();return this.Remove(e),e}SetQueueingEnabled(e){if(e=!!e,this._enableQueue!==e&&(this._enableQueue=e,!e)){for(const e of this._queueRemove)this._rbSet.remove(e);this._queueRemove.clear();for(const e of this._queueInsert)this._rbSet.insert(e);this._queueInsert.clear()}}ForEach(e){this._rbSet.forEach(e)}*values(){if(this.IsEmpty())return;const e=this._rbSet;for(let t=e.min(e.root);t!=e.sentinel;t=e.successor_(t))yield t.key}[Symbol.iterator](){return this.values()}}}{const Ih=self.C3;Ih.PromiseThrottle=class{constructor(e=Ih.hardwareConcurrency){this._maxParallel=e,this._queue=[],this._activeCount=0}Add(e,t){return new Promise((s,i)=>{const r={func:e,resolve:s,reject:i,opts:t};t?.signal&&t.signal.aborted?i(new Error("abort")):(t?.signal&&(r.onabort=()=>{const e=this._queue.indexOf(r);-1!==e&&(this._queue.splice(e,1),i(new Error("abort")))},t.signal.addEventListener("abort",r.onabort)),this._queue.push(r),this._MaybeStartNext())})}_FindInQueue(e){for(let t=0,s=this._queue.length;t<s;++t)if(this._queue[t].func===e)return t;return-1}RemoveAndResolve(e,t){const s=this._FindInQueue(e);if(-1===s)throw new Error("cannot find promise to resolve");this._queue[s].resolve(t),this._queue.splice(s,1)}RemoveAndReject(e,t){const s=this._FindInQueue(e);if(-1===s)throw new Error("cannot find promise to reject");this._queue[s].reject(t),this._queue.splice(s,1)}async _MaybeStartNext(){if(!this._queue.length)return;if(this._activeCount>=this._maxParallel)return;this._activeCount++;const e=this._queue.shift();e.opts?.signal&&e.onabort&&e.opts.signal.removeEventListener("abort",e.onabort);try{const t=await e.func();e.resolve(t)}catch(t){e.reject(t)}this._activeCount--,this._MaybeStartNext()}}}{const Th=self.C3;Th.RateLimiter=class{constructor(e,t,s){this._callback=e,this._interval=t,this._intervalOnBattery=s||2*t,this._timerId=-1,this._lastCallTime=-1/0,this._timerCallFunc=()=>this._OnTimer(),this._ignoreReset=!1,this._canRunImmediate=!1,this._callbackArguments=null}SetCanRunImmediate(e){this._canRunImmediate=!!e}_GetInterval(){return void 0!==Th.Battery&&Th.Battery.IsOnBatteryPower()?this._intervalOnBattery:this._interval}Call(...e){if(-1!==this._timerId)return;this._callbackArguments=e;let t=Th.FastGetDateNow(),s=t-this._lastCallTime,i=this._GetInterval();s>=i&&this._canRunImmediate?(this._lastCallTime=t,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(i-s,4))}_RunCallback(){this._ignoreReset=!0;const e=this._callbackArguments;this._callbackArguments=null,e?this._callback(...e):this._callback(),this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._callbackArguments=null,this._lastCallTime=Th.FastGetDateNow())}_OnTimer(){this._timerId=-1,this._lastCallTime=Th.FastGetDateNow(),this._RunCallback()}_CancelTimer(){-1!==this._timerId&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer(),this._callback=null,this._callbackArguments=null,this._timerCallFunc=null}}}{const Ch=self.C3;Ch.SVGRasterManager=class{constructor(){this._images=new Map,this._allowNpotSurfaces=!1,this._getBaseSizeCallback=null,this._rasterAtSizeCallback=null,this._releaseResultCallback=null,this._redrawCallback=null}SetNpotSurfaceAllowed(e){this._allowNpotSurfaces=!!e}IsNpotSurfaceAllowed(){return this._allowNpotSurfaces}SetGetBaseSizeCallback(e){this._getBaseSizeCallback=e}GetBaseSize(e){if(!this._getBaseSizeCallback)throw new Error("no get base size callback set");return this._getBaseSizeCallback(e)}SetRasterAtSizeCallback(e){this._rasterAtSizeCallback=e}RasterAtSize(e,t,s,i,r,n){if(!this._rasterAtSizeCallback)throw new Error("no raster at size callback set");return this._rasterAtSizeCallback(e,t,s,i,r,n)}SetReleaseResultCallback(e){this._releaseResultCallback=e}ReleaseResult(e){if(!this._releaseResultCallback)throw new Error("no release result callback set");this._releaseResultCallback(e)}SetRedrawCallback(e){this._redrawCallback=e}Redraw(){if(!this._redrawCallback)throw new Error("no redraw callback set");this._redrawCallback()}AddImage(e){let t=this._images.get(e);return t||(t=Ch.New(Ch.SVGRasterImage,this,e),this._images.set(e,t)),t.IncReference(),t}_RemoveImage(e){this._images.delete(e.GetDataSource())}OnTexturesChanged(){for(const e of this._images.values())e.ReleaseRasterizedResult(),e.ForceRasterAgain()}}}{const bh=self.C3,xh=4096;bh.SVGRasterImage=class{constructor(e,t){this._manager=e,this._dataSource=t,this._refCount=0,this._baseWidth=0,this._baseHeight=0,this._getBaseSizePromise=this._manager.GetBaseSize(t).then(e=>{this._manager&&(this._baseWidth=e[0],this._baseHeight=e[1],this._manager.Redraw())}).catch(e=>{console.error("[SVG] Error loading SVG: ",e),this._hadError=!0,this._manager&&this._manager.Redraw()}),this._rasterSurfaceWidth=0,this._rasterSurfaceHeight=0,this._rasterImageWidth=0,this._rasterImageHeight=0,this._isRasterizing=!1,this._rasterizedResult=null,this._forceRaster=!1,this._hadError=!1}Release(){if(this._refCount<=0)throw new Error("already released");this._refCount--,0===this._refCount&&this._Release()}ReleaseRasterizedResult(){this._rasterizedResult&&(this._manager.ReleaseResult(this._rasterizedResult),this._rasterizedResult=null)}_Release(){this.ReleaseRasterizedResult(),this._manager._RemoveImage(this),this._manager=null}GetDataSource(){return this._dataSource}IncReference(){this._refCount++}HasReferences(){return this._refCount>0}GetRasterizedResult(){return this._rasterizedResult}ForceRasterAgain(){this._forceRaster=!0}async StartRasterForSize(e,t,s){if(0===t||0===s||this._hadError)return;if(this._isRasterizing)return;let i=bh.nextHighestPowerOfTwo(Math.ceil(t)),r=bh.nextHighestPowerOfTwo(Math.ceil(s));const n=Math.max(i,r);if(n>4096){const e=4096/n;t*=e,s*=e,i=Math.min(Math.ceil(i*e),4096),r=Math.min(Math.ceil(r*e),4096)}if(t<i&&s<r){const e=t/s;i/r>e?(t=r*e,s=r):(t=i,s=i/e)}if(this._manager.IsNpotSurfaceAllowed()&&(i=Math.ceil(t),r=Math.ceil(s)),i<=this._rasterSurfaceWidth&&r<=this._rasterSurfaceHeight&&!this._forceRaster)return;this._isRasterizing=!0,this._rasterSurfaceWidth=i,this._rasterSurfaceHeight=r;const a=await this._manager.RasterAtSize(this._dataSource,e,this._rasterSurfaceWidth,this._rasterSurfaceHeight,t,s);this._manager&&(this.ReleaseRasterizedResult(),this._rasterizedResult=a,this._rasterImageWidth=t,this._rasterImageHeight=s,this._isRasterizing=!1,this._forceRaster=!1,this._manager.Redraw())}WhenBaseSizeReady(){return this._getBaseSizePromise}GetBaseWidth(){return this._baseWidth}GetBaseHeight(){return this._baseHeight}GetRasterWidth(){return this._rasterImageWidth}GetRasterHeight(){return this._rasterImageHeight}HadError(){return this._hadError}}}{let wh=function(e){return Dh.get(e)};lookupHtmlEntity=wh;const Ph=self.C3;Ph.UTF8_BOM="\ufeff";const Rh=new Set("0123456789");Ph.IsNumericChar=function(e){return Rh.has(e)};const vh=new Set(" \t\n\r\u2028\u2029");Ph.IsWhitespaceChar=function(e){return vh.has(e)},Ph.FilterWhitespace=function(e){return[...e].filter(e=>!Ph.IsWhitespaceChar(e)).join("")},Ph.IsStringAllWhitespace=function(e){for(const t of e)if(!Ph.IsWhitespaceChar(t))return!1;return!0},Ph.IsCharArrayAllWhitespace=function(e){for(const t of e)if(!Ph.IsWhitespaceChar(t))return!1;return!0},Ph.IsUnprintableChar=function(e){return 1===e.length&&e.charCodeAt(0)<32},Ph.FilterUnprintableChars=function(e){return[...e].filter(e=>!Ph.IsUnprintableChar(e)).join("")};let Ah=null;try{Ah=new RegExp("\\p{P}(?<=[\\u3000-\\u303F\\uFF00-\\uFFEF])","u")}catch(t){console.warn("Unable to detect CJK punctuation: ",t)}Ph.IsCJKPunctuationChar=function(e){return!Ph.IsWhitespaceChar(e)&&Ah&&Ah.test(e)};const Mh=new Set("0123456789.+-e");Ph.IsStringNumber=function(e){if(!(e=e.trim()).length)return!1;let t=e.charAt(0);if("-"!==t&&!Rh.has(t))return!1;for(let t of e)if(!Mh.has(t))return!1;return!0},Ph.RemoveTrailingDigits=function(e){let t=e.length;for(;t>0;){let s=e.charAt(t-1);if(!Ph.IsNumericChar(s))break;--t}return e.substr(0,t)},Ph.IncrementNumberAtEndOf=function(e){let t=Ph.RemoveTrailingDigits(e),s=e.substr(t.length);return s=s?(parseInt(s,10)+1).toString():"2",t+s};const Dh=new Map([["&","&amp;"],["<","&lt;"],[">","&gt;"],['"',"&quot;"],["'","&#39;"]]),Eh=/[&<>"']/g;Ph.EscapeHTML=function(e){return e.replace(Eh,wh)},Ph.EscapeJS=function(e){let t=Ph.ReplaceAll(e,"\\","\\\\");return t=Ph.ReplaceAll(t,'"','\\"'),t=Ph.ReplaceAll(t,"\t","\\t"),t=Ph.ReplaceAll(t,"\r",""),Ph.ReplaceAll(t,"\n","\\n")},Ph.EscapeXML=function(e){let t=Ph.ReplaceAll(e,"&","&amp;");return t=Ph.ReplaceAll(t,"<","&lt;"),t=Ph.ReplaceAll(t,">","&gt;"),Ph.ReplaceAll(t,'"',"&quot;")};const Fh=/[-[\]{}()*+?.,\\^$|#\s]/g;Ph.EscapeRegex=function(e){return e.replace(Fh,"\\$&")},Ph.CountCharsInString=function(e,t){let s=0;for(const i of e)i===t&&++s;return s},Ph.StringPosToLineNumber=function(e,t){let s=0,i=0;for(;s<t;){if(s=e.indexOf("\n",s),-1===s)return i;i++,s++}return i},Ph.FindAll=function(e,t,s=!1){if(!t)return[];s||(e=e.toLowerCase(),t=t.toLowerCase());const i=t.length;let r=0,n=0,a=[];for(;(n=e.indexOf(t,r))>-1;)a.push(n),r=n+i;return a},Ph.ReplaceAll=function(e,t,s){return e.replaceAll(t,()=>s)},Ph.ReplaceAllCaseInsensitive=function(e,t,s){return e.replace(new RegExp(Ph.EscapeRegex(t),"gi"),()=>s)},Ph.SetElementContent=function(e,t){"string"==typeof t?e.textContent=t:t.isPlainText()?e.textContent=t.toString():(e.innerHTML=t.toHTML(),t instanceof Ph.BBString&&t.attachLinkHandlers(e))},Ph.StringLikeEquals=function(e,t){return e instanceof Ph.HtmlString||e instanceof Ph.BBString?e.equals(t):t instanceof Ph.HtmlString||t instanceof Ph.BBString?t.equals(e):e===t},Ph.StringSubstitute=function(e,...t){let s=e;for(let i=0,r=t.length;i<r;++i){const r=`{${i}}`;if(!e.includes(r))throw new Error(`missing placeholder '${r}' in string substitution`);s=s.replace(r,t[i].toString())}return s},Ph.StringSubstituteAllowMissing=function(e,...t){let s=e,i=-1,r=-1;for(let n=0,a=t.length;n<a;++n){const a=`{${n}}`;e.includes(a)?(r=n,s=s.replace(a,t[n].toString())):-1===i&&(i=n)}if(i>=0&&r>=0&&i<r)throw new Error(`missing placeholder '${i}' in string substitution`);return s},Ph.StringSubstituteMap=function(e,t){let s=e;for(let[e,i]of Object.entries(t))s=s.replaceAll(e,i.toString());return s},Ph.SortAZ=function(e,t){return e>t?1:e<t?-1:0},Ph.SortAZCaseInsensitive=function(e,t){let s=e.toLowerCase(),i=t.toLowerCase();return s>i?1:s<i?-1:0};const Oh=new self.Intl.Segmenter;Ph.SplitGraphemes=function(e){if(1===e.length)return[e];const t=[];for(const s of Oh.segment(e))t.push(s.segment);return t},Ph.IterateGraphemes=function*(e){for(const t of Oh.segment(e))yield t.segment},Ph.CountGraphemes=function(e){let t=0;for(const s of Oh.segment(e))++t;return t};const Bh=1024,kh=1048576,Lh=1073741824,Nh=1099511627776;Ph.FormatDataSize=function(e,t){let s="common."+(t?"dataRates":"dataSizes")+".";const i=self.langSub;if(e<1024)return i(s+"bytes",e);if(e<1048576){let t=e/1024;return t=t<10?Math.round(10*t)/10:Math.round(t),i(s+"kilobytes",t)}if(e<Lh){let t=e/1048576;return t=t<10?Math.round(10*t)/10:Math.round(t),i(s+"megabytes",t)}if(e<Nh){let t=e/Lh;return t=t<10?Math.round(10*t)/10:Math.round(t),i(s+"gigabytes",t)}{let t=e/Nh;return t=t<10?Math.round(10*t)/10:Math.round(t),i(s+"terabytes",t)}};const Wh={approximate:!1,days:!0,hours:!0,minutes:!0,seconds:!0};Ph.FormatTime=function(e,t){t=Object.assign({},Wh,t),Ph.Lang.PushContext("common.time");const s=[],i=self.lang,r=self.langPluralSub;if(t.days){const t=Math.floor(e/86400);t>0&&(e-=24*t*3600,s.push(r(".days",null,t)))}if(t.hours){const t=Math.floor(e/3600);(t>0||s.length)&&(e-=3600*t,s.push(r(".hours",null,t)))}if(t.minutes){const i=Math.floor(e/60);(i>0||s.length||!t.seconds)&&(e-=60*i,s.push(r(".minutes",null,i)))}if(t.seconds){const t=Math.floor(e%60);s.push(r(".seconds",null,t))}const n=(t.approximate?i(".approx-prefix"):"")+s.join(i(".separator"));return Ph.Lang.PopContext(),n},Ph.ZeroPad=function(e,t){let s=e<0?"-":"",i=(e=Math.abs(e)).toString(),r=t-i.length;for(let e=0;e<r;++e)s+="0";return s+i},Ph.StringToTitleCase=function(e){return e.toLowerCase().replace(/\b\w/g,e=>e.toUpperCase())},Ph.CompareVersionStrings=function(e,t){let s=e.split(".").map(e=>e.trim()),i=t.split(".").map(e=>e.trim());Ph.resizeArray(s,4,"0"),Ph.resizeArray(i,4,"0"),s=s.map(e=>parseInt(e,10)),i=i.map(e=>parseInt(e,10));for(let e=0;e<4;++e){const t=s[e]-i[e];if(0!==t)return t<0?-1:1}return 0},Ph.CreateGUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.floor(16*Math.random());return("x"===e?t:3&t|8).toString(16)})},Ph.StringHammingDistance=function(e,t){if(e.length!==t.length)throw new Error("strings must be same length");let s=0;for(let i=0,r=e.length;i<r;++i)e.charAt(i)!==t.charAt(i)&&++s;return s},Ph.StringLevenshteinDistance=function(e,t){if(0===e.length)return t.length;if(0===t.length)return e.length;let s,i,r,n,a,o;for(e.length>t.length&&(s=e,e=t,t=s),o=Array(e.length+1),i=0;i<=e.length;i++)o[i]=i;for(i=1;i<=t.length;i++){for(n=i,r=1;r<=e.length;r++)a=t[i-1]===e[r-1]?o[r-1]:Math.min(o[r-1]+1,Math.min(n+1,o[r]+1)),o[r-1]=n,n=a;o[e.length]=n}return o[e.length]},Ph.StringByteLengthAsUTF8=function(e){return(new TextEncoder).encode(e).length}}{let Uh=function(e,t,s){const i=jh.get(s);if(!i)return"class"===s?t?"</span>":`<span class="bbclass${$h++}">`:e;if("string"==typeof i){if("a"===i&&0===qh.length||"abbr"===i&&0===Kh.length)return e;if("a"!==i||t){if("abbr"!==i||t)return"<"+t+i+">";{const e=parseInt(s.substring(3),10)-1;if(e<0||e>=Kh.length)throw new Error("invalid bbcode tip substitution");const t=Kh[e];let i="";if("string"==typeof t?i=t:"function"==typeof t&&(i=t()),"string"!=typeof i)throw new TypeError("invalid bbcode tip");return`<abbr title="${Vh.ReplaceAll(i,'"',"&quot;")}">`}}{const e=parseInt(s.substring(1),10)-1;if(e<0||e>=qh.length)throw new Error("invalid bbcode link substitution");const t=qh[e];if("string"==typeof t)return`<a href="${qh[e]}">`;if("function"==typeof t)return`<a class="bblink${e}">`;throw new TypeError("invalid bbcode link action")}}if(Array.isArray(i)){let e=i[0],s=i[1];return t?"</"+e+">":`<${e} class="${s}">`}};bbToHtmlReplacerFunc=Uh;const Vh=self.C3,Hh=self.assert,jh=new Map([["b","strong"],["i","em"],["s","s"],["u","u"],["sub","sub"],["sup","sup"],["small","small"],["mark","mark"],["code","code"],["a1","a"],["a2","a"],["a3","a"],["a4","a"],["a5","a"],["a6","a"],["a7","a"],["a8","a"],["a9","a"],["tip1","abbr"],["tip2","abbr"],["tip3","abbr"],["tip4","abbr"],["tip5","abbr"],["tip6","abbr"],["tip7","abbr"],["tip8","abbr"],["tip9","abbr"],["bad",["span","bbCodeBad"]],["good",["span","bbCodeGood"]],["info",["span","bbCodeInfo"]],["h1",["span","bbCodeH1"]],["h2",["span","bbCodeH2"]],["h3",["span","bbCodeH3"]],["h4",["span","bbCodeH4"]],["item",["span","bbCodeItem"]]]),zh=new Set(["icon"]),Xh=/\[(\/?)([a-zA-Z0-9]+)\]/g,Yh=/\[(\/?)([^\[\n]*?)\]/g;let qh=null,Kh=null,$h=0;const Jh=/\n/g;Vh.BBString=class{constructor(e,t){if(this._bbstr=t&&t.noEscape?e:Vh.EscapeHTML(e),this._htmlstr="",this._convertLineBreaks=!1,this._linkActions=[],this._tipList=[],t){if(this._convertLineBreaks=!!t.convertLineBreaks,t.links){if(t.links.length>9)throw new Error("too many links");this._linkActions=t.links}if(t.tips){if(t.tips.length>9)throw new Error("too many tips");this._tipList=t.tips}}this._hasAnyBBtags=this._bbstr.includes("["),this._needsLineBreakConversion=this._convertLineBreaks&&this._bbstr.includes("\n"),this._isPlain=!this._hasAnyBBtags&&!this._needsLineBreakConversion&&!this._bbstr.includes("&"),this._hasParsedFragments=!1,this._fragments=[]}toString(){return this._bbstr}valueOf(){return this._bbstr}isPlainText(){return this._isPlain}toPlainText(){return this._hasAnyBBtags?this._bbstr.replace(Xh,""):this._bbstr}toHTML(){if(this._isPlain)return this._bbstr;if(!this._htmlstr&&this._bbstr){let e=this._bbstr;this._hasAnyBBtags&&($h=0,qh=this._linkActions,Kh=this._tipList,e=e.replace(Xh,Uh),qh=null,Kh=null),this._needsLineBreakConversion&&(e=e.replace(Jh,"<br>")),this._htmlstr=e}return this._htmlstr}attachLinkHandlers(e){if(this._linkActions.length)for(let t=0,s=this._linkActions.length;t<s;++t){const s=this._linkActions[t];if("function"!=typeof s)continue;const i=e.querySelector(".bblink"+t);if(!i)throw new Error("unable to attach BBString link handler");i.onclick=s}}equals(e){return e instanceof Vh.HtmlString?this.toHTML()===e.toHTML():e instanceof Vh.BBString?this._bbstr===e._bbstr:this._bbstr===e}toFragmentList(){if(this._hasParsedFragments)return this._fragments;const e=[],t=this._bbstr,s=[];Yh.lastIndex=0;let i=0,r=null;for(;null!==(r=Yh.exec(t));){const n=r.index;if(n>0&&"\\"===t.charAt(n-1))continue;const a=r[0],o=r[1],h=r[2],l=t.substring(i,n);if(i=n+a.length,l&&e.push({text:l,styles:s.slice(0)}),h)if(o){const e=h.toLowerCase();for(let t=s.length-1;t>=0;--t)if(s[t].tag===e){s.splice(t,1);break}}else{let t=h,i=null;const r=h.indexOf("=");if(-1!==r?(t=h.substring(0,r).toLowerCase(),i=h.substring(r+1)):t=t.toLowerCase(),zh.has(t)){if("icon"!==t)throw new Error(`unknown self-closing tag ${t}`);e.push({icon:i,styles:s.slice(0)})}else s.push({tag:t,param:i})}}i<t.length&&e.push({text:t.substring(i),styles:s.slice(0)});for(const t of e)t.text&&(t.text=this._ProcessBBCodeEscapeSequences(t.text));return this._fragments=e.map(e=>e.icon?Vh.New(Vh.IconFragment,{icon:e.icon,styles:e.styles}):Vh.New(Vh.TextFragment,{chArr:Vh.SplitGraphemes(e.text),styles:e.styles})),this._hasParsedFragments=!0,this._fragments}_ProcessBBCodeEscapeSequences(e){return e=Vh.ReplaceAll(e,"\\[","["),Vh.ReplaceAll(e,"\\\\","\\")}static StripTags(e){return Vh.New(Vh.BBString,e,{noEscape:!0}).toPlainText()}static StripAnyTags(e){return e.replace(Yh,"")}}}{let Zh=function(e){return""!==e&&""!==e&&il.IsWhitespaceChar(e)},Qh=function(e){return rl.has(e)},el=function(e){return il.IsCJKPunctuationChar(e)&&!Qh(e)},tl=function(e){for(;e.length>0&&Zh(e.at(-1));)e.pop()},sl=function(e){return"\n"===e||"\r\n"===e};IsWordBreakWhiteSpace=Zh,IsOpeningCJKPunctiationChar=Qh,IsContinuingCJKPunctuationChar=el,WordBreakTrimEnd=tl,IsNewline=sl;const il=self.C3,rl=new Set("");class nl{constructor(){this.fragments=[],this.width=0,this.height=0,this.fontBoundingBoxAscent=0,this.fontBoundingBoxDescent=0,this.topToAlphabeticDistance=0,this.isMeasured=!1}static FromSingleFragment(e,t,s,i,r,n){const a=new nl;return a.fragments.push(e),a.width=t,a.height=s,a.fontBoundingBoxAscent=i,a.fontBoundingBoxDescent=r,a.topToAlphabeticDistance=n,a}Copy(e){this.fragments=e.fragments.map(e=>e._Clone()),this.width=e.width,this.height=e.height,this.fontBoundingBoxAscent=e.fontBoundingBoxAscent,this.fontBoundingBoxDescent=e.fontBoundingBoxDescent,this.topToAlphabeticDistance=e.topToAlphabeticDistance,this.isMeasured=e.isMeasured}Reset(){this.fragments=[],this.width=0,this.height=0,this.fontBoundingBoxAscent=0,this.fontBoundingBoxDescent=0,this.topToAlphabeticDistance=0,this.isMeasured=!1}SetMetrics(e,t){t||(this.width=e.width),this.height=e.height||0,this.fontBoundingBoxAscent=e.fontBoundingBoxAscent||0,this.fontBoundingBoxDescent=e.fontBoundingBoxDescent||0,this.topToAlphabeticDistance=e.topToAlphabeticDistance||0,this.isMeasured=!0}AddWord(e){const t=this.fragments.length?this.fragments.at(-1):null;let s=0;t&&t.IsText()&&e[0].IsText()&&e[0].GetStyles()===t.GetStyles()&&(t._Append(e[0].GetCharacterArray()),s=1);for(let t=e.length;s<t;++s){const t=e[s];this.fragments.push(t._Clone())}this.isMeasured=!1}}il.WordWrap=class{constructor(){this._lines=[],this._iconSet=null,this._lastFitLineState=new nl,this._tryLineState=new nl,this._hitNewline=!1}GetLines(){return this._lines}GetLineCount(){return this._lines.length}SetIconSet(e){this._iconSet=e}WordWrap(e,t,s,i,r){if("string"==typeof e&&(e=[il.New(il.TextFragment,{chArr:il.SplitGraphemes(e)})]),il.clearArray(this._lines),!e.length||1===e.length&&e[0].IsText()&&e[0].IsEmpty()||s<2)return;if(1===e.length){const i=e[0];if(i.IsText()&&i.GetLength()<=100&&!i.HasNewLine()){let{width:e,height:n,fontBoundingBoxAscent:a,fontBoundingBoxDescent:o,topToAlphabeticDistance:h}=t(i);if(e+=r,i.SetWidth(e),i.SetHeight(n),i.SetFontBoundingBoxAscent(a||0),i.SetFontBoundingBoxDescent(o||0),i.SetTopToAlphabeticDistance(h||0),e<=s)return void this._AddLine(nl.FromSingleFragment(i,e,n,a,o,h))}}let n,a=4;"word"===i?n=this._TokeniseByWord(e):"cjk"===i?(n=this._TokeniseByCJK(e),a=8):(n=this._TokeniseByChar(e),a=8),this._WrapText(n,t,s,a,r)}_TokeniseByWord(e){const t=[];let s=[],i=!1;for(const r of e){const e=r.GetStyles();if(r.IsIcon())s.length>0&&t.push(s),t.push([r]),s=[];else for(const n of r.GetCharacterArray())if(sl(n))s.length>0&&t.push(s),t.push([il.New(il.TextFragment,{chArr:["\n"],styles:e})]),s=[];else if(0===s.length)s.push(il.New(il.TextFragment,{chArr:[n],styles:e})),i=Zh(n);else{const r=Zh(n);if(r===i){const t=s.at(-1);t.GetStyles()===e?t._AppendChar(n):s.push(il.New(il.TextFragment,{chArr:[n],styles:e}))}else t.push(s),s=[il.New(il.TextFragment,{chArr:[n],styles:e})],i=r}}return s.length>0&&t.push(s),t}_TokeniseByCJK(e){const t=[];let s=[],i=!1;for(const r of e){const e=r.GetStyles();if(r.IsIcon())s.length>0&&t.push(s),t.push([r]),s=[];else for(const n of r.GetCharacterArray())if(sl(n))s.length>0&&t.push(s),t.push([il.New(il.TextFragment,{chArr:["\n"],styles:e})]),s=[];else if(0===s.length)s.push(il.New(il.TextFragment,{chArr:[n],styles:e})),i=Qh(n);else if(i||el(n)){const t=s.at(-1);t.GetStyles()===e?t._AppendChar(n):s.push(il.New(il.TextFragment,{chArr:[n],styles:e})),i=Qh(n)}else t.push(s),s=[il.New(il.TextFragment,{chArr:[n],styles:e})],i=Qh(n)}return s.length>0&&t.push(s),t}_TokeniseByChar(e){const t=[];for(const s of e)if(s.IsText()){const e=s.GetCharacterArray();il.appendArray(t,e.map(e=>[il.New(il.TextFragment,{chArr:[e],styles:s.GetStyles()})]))}else t.push([s]);return t}_MeasureLine(e,t){let s=0,i=0,r=0,n=0,a=0;for(const o of e){if(-1===o.GetWidth()){const e=t(o);o.SetHeight(e.height),o.SetFontBoundingBoxAscent(e.fontBoundingBoxAscent||0),o.SetFontBoundingBoxDescent(e.fontBoundingBoxDescent||0),o.SetTopToAlphabeticDistance(e.topToAlphabeticDistance||0),o.IsText()?o.SetWidth(e.width):o.IsIcon()&&o.CalculateWidthFromHeight(this._iconSet)}s+=o.GetWidth(),i=Math.max(i,o.GetHeight()),r=Math.max(r,o.GetFontBoundingBoxAscent()),n=Math.max(n,o.GetFontBoundingBoxDescent()),a=Math.max(a,o.GetTopToAlphabeticDistance())}return{width:s,height:i,fontBoundingBoxAscent:r,fontBoundingBoxDescent:n,topToAlphabeticDistance:a}}_ResetLineStates(){this._lastFitLineState.Reset(),this._tryLineState.Reset()}_AddLine(e){this._lines.push(new il.WordWrap.Line(e)),this._ResetLineStates()}_IsWordNewLine(e){return 1===e.length&&e[0].IsText()&&1===e[0].GetLength()&&sl(e[0].GetCharacterArray()[0])}_IsWordWhitespace(e){return e[0].IsText()&&il.IsCharArrayAllWhitespace(e[0].GetCharacterArray())}_WrapText(e,t,s,i,r){let n=0;for(;n<e.length;)n=this._WrapText_Chunk(e,n,t,s,i);if(this._tryLineState.fragments.length>0){if(!this._tryLineState.isMeasured){const e=this._MeasureLine(this._tryLineState.fragments,t);this._tryLineState.SetMetrics(e)}this._AddLine(this._tryLineState)}this._TrimLinesTrailingWhitespace(t,r),this._ResetLineStates(),this._hitNewline=!1}_WrapText_Chunk(e,t,s,i,r){const n=this._lastFitLineState,a=this._tryLineState,o=e[t];if(this._IsWordNewLine(o)){if(!a.isMeasured){const e=s(il.New(il.TextFragment,{chArr:[" "],styles:o[0].GetStyles()}));a.SetMetrics(e,!0)}return this._AddLine(a),t+1}const h=this._WrapText_CollectChunk(e,t,r),l=this._MeasureLine(a.fragments,s);return a.SetMetrics(l),l.width>=i?this._WrapText_RetryChunk(e,t,s,i):(n.Copy(a),this._hitNewline&&this._AddLine(n),h+1)}_WrapText_CollectChunk(e,t,s){const i=this._tryLineState;this._hitNewline=!1;let r=t,n=0;for(let t=e.length;r<t;++r){const t=e[r];if(this._IsWordNewLine(t)){this._hitNewline=!0;break}if(i.AddWord(t),!this._IsWordWhitespace(t)&&(++n,n===s))break}return r}_WrapText_RetryChunk(e,t,s,i){const r=this._lastFitLineState,n=this._tryLineState;n.Copy(r);let a=t;for(let t=e.length;a<t;++a){const o=e[a];if(this._IsWordNewLine(o))return this._AddLine(r),a+1;if(n.AddWord(o),!this._IsWordWhitespace(o)||0===r.fragments.length){const o=this._MeasureLine(n.fragments,s);if(n.SetMetrics(o),o.width>=i){let s;return r.fragments.length>0?s=r:(s=n,++a,a<t&&this._IsWordWhitespace(e[a])&&++a),this._AddLine(s),a}r.Copy(n)}}return a}_TrimLinesTrailingWhitespace(e,t){for(const s of this._lines){const i=s._GetFragmentsArray();if(!i.length)continue;let r=i.at(-1);if(r.IsText()){const n=r.GetCharacterArray(),a=n.slice(0);if(tl(a),0===a.length)s.OffsetWidth(-r.GetWidth()),i.pop();else if(a.length<n.length){r.SetCharacterArray(a);const t=e(r).width,i=r.GetWidth()-t;r.SetWidth(t),s.OffsetWidth(-i)}0!==t&&i.length>0&&(r=i.at(-1),r.OffsetWidth(t),s.OffsetWidth(t))}}}Clear(){il.clearArray(this._lines)}GetMaxLineWidth(){return this._lines.reduce((e,t)=>Math.max(e,t.GetWidth()),0)}GetTotalLineHeight(){return this._lines.reduce((e,t)=>e+t.GetHeight(),0)}}}{const al=self.C3;al.WordWrap.Line=class{constructor(e){this._fragments=e.fragments,this._width=e.width,this._height=e.height,this._fontBoundingBoxAscent=e.fontBoundingBoxAscent,this._fontBoundingBoxDescent=e.fontBoundingBoxDescent,this._topToAlphabeticDistance=e.topToAlphabeticDistance,this._posX=0,this._posY=0}fragments(){return this._fragments.values()}*fragmentsReverse(){const e=this._fragments;for(let t=e.length-1;t>=0;--t)yield e[t]}_GetFragmentsArray(){return this._fragments}OffsetWidth(e){this._width+=e}GetWidth(){return this._width}GetHeight(){return this._height}GetFoundBoundingBoxAscent(){return this._fontBoundingBoxAscent}GetFontBoundingBoxDescent(){return this._fontBoundingBoxDescent}GetTopToAlphabeticDistance(){return this._topToAlphabeticDistance}SetPosX(e){this._posX=e}GetPosX(){return this._posX}SetPosY(e){this._posY=e}GetPosY(){return this._posY}}}{const ol=self.C3;ol.FragmentBase=class{constructor(e){this._styles=e.styles||[],this._width=e.width||-1,this._height=e.height||-1,this._fontBoundingBoxAscent=e.fontBoundingBoxAscent||-1,this._fontBoundingBoxDescent=e.fontBoundingBoxDescent||-1,this._topToAlphabeticDistance=e.topToAlphabeticDistance||-1,this._posX=0,this._posY=0}IsText(){return!1}IsIcon(){return!1}GetStyles(){return this._styles}GetStyleTag(e){const t=this._styles;for(let s=t.length-1;s>=0;--s){const i=t[s];if(i.tag===e)return i}return null}HasStyleTag(e){return!!this.GetStyleTag(e)}GetStyleMap(){const e=new Map;for(const t of this._styles)e.set(t.tag,t.param);return e}OffsetWidth(e){this._width+=e}SetWidth(e){this._width=e}GetWidth(){return this._width}SetHeight(e){this._height=e}GetHeight(){return this._height}SetFontBoundingBoxAscent(e){this._fontBoundingBoxAscent=e}GetFontBoundingBoxAscent(){return this._fontBoundingBoxAscent}SetFontBoundingBoxDescent(e){this._fontBoundingBoxDescent=e}GetFontBoundingBoxDescent(){return this._fontBoundingBoxDescent}SetTopToAlphabeticDistance(e){this._topToAlphabeticDistance=e}GetTopToAlphabeticDistance(){return this._topToAlphabeticDistance}SetPosX(e){this._posX=e}GetPosX(){return this._posX}SetPosY(e){this._posY=e}GetPosY(){return this._posY}}}{const hl=self.C3;hl.TextFragment=class extends hl.FragmentBase{constructor(e){super(e),this._chArr=e.chArr}IsText(){return!0}_Append(e){hl.appendArray(this._chArr,e),this._width=-1,this._height=-1,this._fontBoundingBoxAscent=-1,this._fontBoundingBoxDescent=-1,this._topToAlphabeticDistance=-1}_AppendChar(e){this._chArr.push(e)}_Clone(){return hl.New(hl.TextFragment,{chArr:this._chArr.slice(0),styles:this._styles,width:this._width,height:this._height,fontBoundingBoxAscent:this._fontBoundingBoxAscent,fontBoundingBoxDescent:this._fontBoundingBoxDescent,topToAlphabeticDistance:this._topToAlphabeticDistance})}GetCharacterArray(){return this._chArr}SetCharacterArray(e){this._chArr=e}GetLength(){return this._chArr.length}IsEmpty(){return 0===this._chArr.length}HasNewLine(){return this._chArr.includes("\n")}}}{const ll=self.C3;ll.IconFragment=class extends ll.FragmentBase{constructor(e){super(e),this._icon=e.icon}IsIcon(){return!0}GetIconParameter(){return this._icon}_Clone(){return ll.New(ll.IconFragment,{icon:this._icon,styles:this._styles,width:this._width,height:this._height,fontBoundingBoxAscent:this._fontBoundingBoxAscent,fontBoundingBoxDescent:this._fontBoundingBoxDescent,topToAlphabeticDistance:this._topToAlphabeticDistance})}GetTextIcon(e){if(!e)return null;let t=Number(this._icon);return String(t)===this._icon?(t=Math.floor(t),e.GetTextIconByIndex(t)):e.GetTextIconByTag(this._icon)}CalculateWidthFromHeight(e){const t=this.GetTextIcon(e);this._width=t?this._height*t.GetWidth()/t.GetHeight():0}GetDrawable(e){const t=this.GetTextIcon(e);return t?t.GetDrawable():null}GetLength(){return 1}}}{const cl=self.C3;cl.TextIconManager=class{constructor(e){this._iconSets=new Map,this._getIconSetMetaCallback=e.getIconSetMeta,this._getIconSetContentCallback=e.getIconSetContent}Release(){for(const e of this._iconSets.values())e.Release();this._iconSets.clear()}GetIconSet(e){let t=this._iconSets.get(e);if(t)return t;const s=this._getIconSetMetaCallback(e);return t=cl.New(cl.TextIconSet,this,{source:e,iconMeta:s}),this._iconSets.set(e,t),t}HasIconSet(e){return this._iconSets.has(e)}DeleteIconSet(e){const t=this._iconSets.get(e);t&&t.Release(),this._iconSets.delete(e)}async _GetIconSetContent(e){return await this._getIconSetContentCallback(e)}}}{const ul=self.C3;ul.TextIconSet=class{constructor(e,t){this._textIconManager=e,this._source=t.source,this._iconsArray=[],this._iconsByTag=new Map,this._hasStartedLoad=!1,this._isLoading=!1,this._loadPromise=null;const s=t.iconMeta.icons;for(let e=0,t=s.length;e<t;++e){const t=s[e],i=ul.New(ul.TextIcon,this,{index:e,tag:t.tag,source:t.source,width:t.width,height:t.height});this._iconsArray.push(i),t.tag&&this._iconsByTag.set(t.tag.toLowerCase(),i)}}Release(){for(const e of this._iconsArray)e.Release();ul.clearArray(this._iconsArray),this._iconsByTag.clear(),this._textIconManager=null,this._source=null}HasLoaded(){return this._hasStartedLoad}IsLoading(){return this._isLoading}LoadContent(){return this._loadPromise||(this._loadPromise=this._DoLoadContent()),this._loadPromise}async _DoLoadContent(){if(this._hasStartedLoad)return;this._hasStartedLoad=!0,this._isLoading=!0;const e=await this._textIconManager._GetIconSetContent(this._source);if(!this._textIconManager)return;const t=e.icons;for(let e=0,s=Math.min(t.length,this._iconsArray.length);e<s;++e){const s=t[e].drawable;this._iconsArray[e]._SetDrawable(s)}this._isLoading=!1}GetTextIconByIndex(e){return(e=Math.floor(e))<0||e>=this._iconsArray.length?null:this._iconsArray[e]}GetTextIconByTag(e){return this._iconsByTag.get(e.toLowerCase())||null}}}{const dl=self.C3;dl.TextIcon=class{constructor(e,t){this._textIconSet=e,this._source=t.source||null,this._index=t.index,this._tag=t.tag,this._width=t.width,this._height=t.height,this._drawable=null}Release(){this._width=0,this._height=0,this._textIconSet=null}GetSource(){return this._source}GetWidth(){return this._width}GetHeight(){return this._height}_SetDrawable(e){this._drawable=e}GetDrawable(){return this._drawable}}}{let _l=function(e,t,s,i){const r=Cl;Sl.subtract(Il,s,t),Sl.subtract(Tl,e,t),Sl.cross(r,Il,Tl),Sl.normalize(r,r),i.set(r[0],r[1],r[2],Sl.dot(e,r))},pl=function(e,t,s,i,r,n,a){const o=a.x,h=a.y,l=a.z,c=a.w,u=a.xF,d=a.yF,_=a.zF,p=1-u,f=1-d,m=1-_;return o*e*u+o*i*p+h*t*d+h*r*f+l*s*_+l*n*m>=c||o*i*u+o*e*p+h*r*d+h*t*f+l*n*_+l*s*m>c},fl=function(e,t,s,i){return i.x*e+i.y*t+i.z*s>=i.w};PlaneFromPoints=_l,IsInFrontOfPlane=pl,IsPointInFrontOfPlane=fl;const ml=self.C3,gl=self.glMatrix,Sl=gl.vec3,Gl=gl.vec4,yl=gl.mat4,Il=Sl.create(),Tl=Sl.create(),Cl=Sl.create(),bl=Gl.create(),xl=yl.create(),wl=Sl.create(),Pl=Sl.create(),Rl=Sl.create(),vl=Sl.create(),Al=Sl.create(),Ml=Sl.create(),Dl=Sl.create(),El=Sl.create(),Fl=Gl.fromValues(0,0,1,1);ml.Gfx={Project(e,t,s,i,r,n,a){const o=i[0]*e+i[4]*t+i[8]*s+i[12],h=i[1]*e+i[5]*t+i[9]*s+i[13],l=i[2]*e+i[6]*t+i[10]*s+i[14],c=i[3]*e+i[7]*t+i[11]*s+i[15];let u=r[0]*o+r[4]*h+r[8]*l+r[12]*c,d=r[1]*o+r[5]*h+r[9]*l+r[13]*c,_=r[2]*o+r[6]*h+r[10]*l+r[14]*c,p=r[3]*o+r[7]*h+r[11]*l+r[15]*c;return 0!==p&&(p=1/p,u*=p,d*=p,_*=p,a[0]=(.5*u+.5)*n[2]+n[0],a[1]=(.5*d+.5)*n[3]+n[1],a[2]=.5*(1+_),!0)},Unproject(e,t,s,i,r,n,a){const o=xl,h=bl;return yl.multiply(o,r,i),null!==yl.invert(o,o)&&(h[0]=(e-n[0])/n[2]*2-1,h[1]=(t-n[1])/n[3]*2-1,h[2]=2*s-1,h[3]=1,Gl.transformMat4(h,h,o),0!==h[3]&&(h[3]=1/h[3],a[0]=h[0]*h[3],a[1]=h[1]*h[3],a[2]=h[2]*h[3],!0))},UnprojectScreenToWorldZ(e,t,s,i,r,n,a){const o=Il,h=Tl;if(!ml.Gfx.Unproject(e,t,0,i,r,n,o))return!1;if(!ml.Gfx.Unproject(e,t,1,i,r,n,h))return!1;const l=Tl;Sl.subtract(l,h,o);const c=Cl;Sl.set(c,0,0,1);const u=-s,d=Sl.dot(c,l);let _=0;if(0===d){if(0!==Sl.dot(c,o)+u)return!1}else if(_=-(Sl.dot(o,c)+u)/d,_<0)return!1;return Sl.scaleAndAdd(a,o,l,_),!0}};class Ol{constructor(){this.x=NaN,this.y=NaN,this.z=NaN,this.w=NaN,this.xF=NaN,this.yF=NaN,this.zF=NaN}set(e,t,s,i){this.x=e,this.y=t,this.z=s,this.w=i,this.xF=e>0?1:0,this.yF=t>0?1:0,this.zF=s>0?1:0}}ml.Gfx.ViewFrustum=class{constructor(){this._leftP=new Ol,this._topP=new Ol,this._rightP=new Ol,this._bottomP=new Ol,this._nearP=new Ol,this._farP=new Ol}CalculatePlanes(e,t){const s=Fl;ml.Gfx.Unproject(0,1,0,e,t,s,wl),ml.Gfx.Unproject(1,1,0,e,t,s,Pl),ml.Gfx.Unproject(0,0,0,e,t,s,Rl),ml.Gfx.Unproject(1,0,0,e,t,s,vl),ml.Gfx.Unproject(0,1,1,e,t,s,Al),ml.Gfx.Unproject(1,1,1,e,t,s,Ml),ml.Gfx.Unproject(0,0,1,e,t,s,Dl),ml.Gfx.Unproject(1,0,1,e,t,s,El),_l(Rl,wl,Al,this._leftP),_l(wl,Pl,Ml,this._topP),_l(Pl,vl,El,this._rightP),_l(vl,Rl,Dl,this._bottomP),_l(Dl,Al,Ml,this._farP),_l(vl,Pl,wl,this._nearP)}ContainsAABB(e,t,s,i,r,n){return pl(e,t,s,i,r,n,this._leftP)&&pl(e,t,s,i,r,n,this._topP)&&pl(e,t,s,i,r,n,this._rightP)&&pl(e,t,s,i,r,n,this._bottomP)&&pl(e,t,s,i,r,n,this._nearP)&&pl(e,t,s,i,r,n,this._farP)}IsBehindNearPlane(e,t,s){return!fl(e,t,s,this._nearP)}}}{const Bl=self.C3,kl=self.glMatrix,Ll=kl.vec3,Nl=kl.vec4,Wl=kl.mat4,Ul=Wl.create(),Vl=Ll.fromValues(0,0,0),Hl=Ll.fromValues(0,0,0),jl=Ll.fromValues(0,0,0),zl=Ll.fromValues(0,1,0),Xl=Nl.fromValues(0,0,0,0),Yl=new Bl.Quad,ql=new Bl.Rect,Kl=new Bl.Quad(0,0,1,0,1,1,0,1),$l={nearZ:1,farZ:1e4},Jl=Wl.fromValues(1,0,0,0,0,1,0,0,0,0,.5,0,0,0,.5,1);Bl.Gfx.RendererBase=class{constructor(e){e=Object.assign({},$l,e),this._width=0,this._height=0,this._fovY=Bl.toRadians(45),this._tan_fovY_2=Math.tan(this._fovY/2),this._matP=Wl.create(),this._matMV=Wl.create(),this._zAxisScale=!1,this._nearZ=e.nearZ,this._farZ=e.farZ,this._allShaderPrograms=[],this._shaderProgramsByName=new Map,this._spTextureFill=null,this._spPoints=null,this._spTilemapFill=null,this._spTileRandomization=null,this._spColorFill=null,this._spLinearGradientFill=null,this._spPenumbraFill=null,this._spHardEllipseFill=null,this._spHardEllipseOutline=null,this._spSmoothEllipseFill=null,this._spSmoothEllipseOutline=null,this._spSmoothLineFill=null,this._stateGroups=new Map,this._currentStateGroup=null,this._blendModeTable=[],this._namedBlendModeMap=new Map,this._baseZ=0,this._currentZ=0,this._lineWidth=1,this._lineWidthStack=[this._lineWidth],this._lineCap=1,this._lineCapStack=[this._lineCap],this._lineOffset=.5,this._lineOffsetStack=[this._lineOffset],this._frameNumber=0,this._enableMipmaps=!0,this._hasMajorPerformanceCaveat=!1}_ClearState(){this._baseZ=0,this._currentZ=0,this._spTextureFill=null,this._spPoints=null,this._spTilemapFill=null,this._spTileRandomization=null,this._spColorFill=null,this._spLinearGradientFill=null,this._spPenumbraFill=null,this._spHardEllipseFill=null,this._spHardEllipseOutline=null,this._spSmoothEllipseFill=null,this._spSmoothEllipseOutline=null,this._spSmoothLineFill=null,this._ClearAllShaderPrograms()}InitState(){this._ClearState(),this._currentStateGroup=null}OnDeviceOrContextLost(){for(const e of this._allShaderPrograms)e.Release();this._ClearState()}GetWidth(){return this._width}GetHeight(){return this._height}GetDefaultCameraZ(e){return this.IsZAxisScaleNormalized()?100:e/(2*this._GetTanFovYDiv2())}GetZAxisScaleFactor(e){return this.IsZAxisScaleNormalized()?e/(2*this._GetTanFovYDiv2())/this.GetDefaultCameraZ(e):1}SetNearZ(e){this._nearZ=e}GetNearZ(){return this._nearZ}SetFarZ(e){this._farZ=e}GetFarZ(){return this._farZ}SetFovY(e){this._fovY=e,this._tan_fovY_2=Math.tan(this._fovY/2)}GetFovY(){return this._fovY}_GetTanFovYDiv2(){return this._tan_fovY_2}SetZAxisScaleNormalized(){this._zAxisScale=!1}SetZAxisScaleRegular(){this._zAxisScale=!0}IsZAxisScaleNormalized(){return!this._zAxisScale}IsZAxisScaleRegular(){return this._zAxisScale}CalculatePerspectiveMatrix(e,t,s=.5,i=.5){const r=this.GetNearZ(),n=this.GetFarZ(),a=this.GetFovY();if(.5===s&&.5===i)this.IsWebGPU()?Wl.perspectiveZO(e,a,t,r,n):Wl.perspective(e,a,t,r,n);else{const a=2*(s=1-s)-2,o=2*s,h=2*i-2,l=2*i,c=this._GetTanFovYDiv2()*r,u=c*t;Wl.frustum(e,a*u,o*u,h*c,l*c,r,n),this.IsWebGPU()&&Wl.mul(e,Jl,e)}}CalculateOrthographicMatrix(e,t,s,i=1){const r=self.devicePixelRatio,n=2*this.GetDefaultCameraZ(s)*r*this._GetTanFovYDiv2()/s,a=t*n/(2*r*i),o=s*n/(2*r*i),h=-a,l=a,c=-o,u=o;this.IsWebGPU()?Wl.orthoZO(e,h,l,c,u,this.GetNearZ(),this.GetFarZ()):Wl.ortho(e,h,l,c,u,this.GetNearZ(),this.GetFarZ())}CalculateLookAtModelView(e,t,s,i,r,n=1){let a=1;this.IsZAxisScaleNormalized()&&(a=200*this._GetTanFovYDiv2()/r);const o=jl;Ll.set(o,a,-a,1);const h=Vl,l=Hl;Ll.multiply(h,t,o),Ll.multiply(l,s,o),Wl.lookAt(e,h,l,i||zl),o[2]=n,Wl.scale(e,e,o)}CalculateLookAtModelView2(e,t,s,i,r,n,a,o){return Ll.set(Vl,e,t,s),Ll.set(Hl,i,r,n),this.CalculateLookAtModelView(Ul,Vl,Hl,zl,a,o),Ul}_AddShaderProgram(e){this._allShaderPrograms.push(e),this._shaderProgramsByName.set(e.GetName(),e)}_RemoveShaderProgram(e){const t=this._allShaderPrograms.indexOf(e);-1!==t&&this._allShaderPrograms.splice(t,1),this._shaderProgramsByName.delete(e.GetName())}_ClearAllShaderPrograms(){Bl.clearArray(this._allShaderPrograms),this._shaderProgramsByName.clear()}GetShaderProgramByName(e){return this._shaderProgramsByName.get(e)||null}GetTextureFillShaderProgram(){return this._spTextureFill}SetTextureFillMode(){this.SetProgram(this._spTextureFill)}GetPointsRenderingProgram(){return this._spPoints}SetPointsRenderingProgram(){this.SetProgram(this._spPoints)}SetTilemapFillMode(){this.SetProgram(this._spTilemapFill)}SetTileRandomizationMode(){this.SetProgram(this._spTileRandomization)}SetColorFillMode(){this.SetProgram(this._spColorFill)}SetLinearGradientFillMode(){this.SetProgram(this._spLinearGradientFill)}SetPenumbraFillMode(){this.SetProgram(this._spPenumbraFill)}SetHardEllipseFillMode(){this.SetProgram(this._spHardEllipseFill)}SetHardEllipseOutlineMode(){this.SetProgram(this._spHardEllipseOutline)}SetSmoothEllipseFillMode(){this.SetProgram(this._spSmoothEllipseFill)}SetSmoothEllipseOutlineMode(){this.SetProgram(this._spSmoothEllipseOutline)}SetSmoothLineFillMode(){this.SetProgram(this._spSmoothLineFill)}_SetCurrentStateGroup(e){this._currentStateGroup=e}GetCurrentStateGroup(){return this._currentStateGroup}AcquireStateGroup(e,t,s,i,r,n){const a=Bl.Gfx.StateGroup.MakeKey(e,t,s,i,r,n);let o=this._stateGroups.get(a);return o||(o=Bl.New(Bl.Gfx.StateGroup,this,e,t,s,i,r,n),this._stateGroups.set(a,o)),o.AddRef(),o}ReleaseStateGroup(e){e.DecRef(),0===e._GetRefCount()&&(this._currentStateGroup===e&&(this._currentStateGroup=null),this._stateGroups.delete(e.GetKey()),e.Release())}_InitBlendModeData(e){Bl.clearArray(this._blendModeTable),this._namedBlendModeMap.clear();let t=0;for(const s of e){const e=s[0],i=s[1];this._blendModeTable.push(i),this._namedBlendModeMap.set(e,t),t++}}_GetBlendParametersByIndex(e){return this._blendModeTable[e]}NamedBlendToNumber(e){const t=this._namedBlendModeMap.get(e);if(void 0===t)throw new Error("invalid blend name");return t}SetBaseZ(e){this._baseZ=e}GetBaseZ(){return this._baseZ}SetCurrentZ(e){this._currentZ=e,this._currentStateGroup=null}GetCurrentZ(){return this._currentZ}Line(e,t,s,i){const r=Bl.angleTo(e,t,s,i),n=Math.sin(r),a=Math.cos(r),o=.5*this._lineWidth,h=n*o,l=a*o,c=this._lineCap;2===c?this.LinePreCalc_LineCap2(e,t,0,s,i,0,h,l):1===c?this.LinePreCalc_LineCap1(e,t,0,s,i,0,h,l):this.LinePreCalc_LineCap0(e,t,0,s,i,0,h,l)}Line3D(e,t,s,i,r,n){const a=Bl.angleTo(e,t,i,r),o=Math.sin(a),h=Math.cos(a),l=.5*this._lineWidth,c=o*l,u=h*l,d=this._lineCap;2===d?this.LinePreCalc_LineCap2(e,t,s,i,r,n,c,u):1===d?this.LinePreCalc_LineCap1(e,t,s,i,r,n,c,u):this.LinePreCalc_LineCap0(e,t,s,i,r,n,c,u)}LinePreCalc_LineCap2(e,t,s,i,r,n,a,o){const h=this._lineOffset,l=e+h-o,c=t+h-a,u=i+h+o,d=r+h+a,_=2*o,p=2*a,f=l+a,m=c-o,g=l-a+_,S=c+o+p,G=u+a,y=d-o,I=u-a-_,T=d+o-p;this.Quad3D2(f,m,s,G,y,n,I,T,n,g,S,s,Kl)}LinePreCalc_LineCap1(e,t,s,i,r,n,a,o){const h=this._lineOffset,l=e+h-o,c=t+h-a,u=i+h+o,d=r+h+a,_=l+a,p=c-o,f=l-a,m=c+o,g=u+a,S=d-o,G=u-a,y=d+o;this.Quad3D2(_,p,s,g,S,n,G,y,n,f,m,s,Kl)}LinePreCalc_LineCap0(e,t,s,i,r,n,a,o){const h=this._lineOffset,l=e+h,c=t+h,u=i+h,d=r+h,_=l+a,p=c-o,f=l-a,m=c+o,g=u+a,S=d-o,G=u-a,y=d+o;this.Quad3D2(_,p,s,g,S,n,G,y,n,f,m,s,Kl)}TexturedLine(e,t,s,i,r,n){const a=Bl.angleTo(e,t,s,i),o=Math.sin(a),h=Math.cos(a),l=.5*this._lineWidth,c=o*l,u=h*l,d=this._lineCap;2===d?this.TexturedLinePreCalc_LineCap2(e,t,s,i,c,u,r,n):1===d?this.TexturedLinePreCalc_LineCap1(e,t,s,i,c,u,r,n):this.TexturedLinePreCalc_LineCap0(e,t,s,i,c,u,r,n)}TexturedLinePreCalc_LineCap2(e,t,s,i,r,n,a,o){const h=this._lineOffset,l=e+h-n,c=t+h-r,u=s+h+n,d=i+h+r,_=2*n,p=2*r,f=l+r,m=c-n,g=l-r+_,S=c+n+p,G=u+r,y=d-n,I=u-r-_,T=d+n-p;Yl.set(f,m,G,y,I,T,g,S),ql.set(a,0,o,0),this.Quad3(Yl,ql)}TexturedLinePreCalc_LineCap1(e,t,s,i,r,n,a,o){const h=this._lineOffset,l=e+h-n,c=t+h-r,u=s+h+n,d=i+h+r,_=l+r,p=c-n,f=l-r,m=c+n,g=u+r,S=d-n,G=u-r,y=d+n;Yl.set(_,p,g,S,G,y,f,m),ql.set(a,0,o,0),this.Quad3(Yl,ql)}TexturedLinePreCalc_LineCap0(e,t,s,i,r,n,a,o){const h=this._lineOffset,l=e+h,c=t+h,u=s+h,d=i+h,_=l+r,p=c-n,f=l-r,m=c+n,g=u+r,S=d-n,G=u-r,y=d+n;Yl.set(_,p,g,S,G,y,f,m),ql.set(a,0,o,0),this.Quad3(Yl,ql)}LineRect(e,t,s,i){const r=.5*this._lineWidth,n=this._lineCap;2===n?this._LineRectPreCalc_LineCap2(e,t,s,i,r):1===n?this._LineRectPreCalc_LineCap1(e,t,s,i,r):this._LineRectPreCalc_LineCap0(e,t,s,i,r)}_LineRectPreCalc_LineCap2(e,t,s,i,r){this.LinePreCalc_LineCap2(e,t,0,s,t,0,0,r),this.LinePreCalc_LineCap2(s,t,0,s,i,0,r,0),this.LinePreCalc_LineCap2(s,i,0,e,i,0,0,-r),this.LinePreCalc_LineCap2(e,i,0,e,t,0,-r,0)}_LineRectPreCalc_LineCap1(e,t,s,i,r){this.LinePreCalc_LineCap1(e,t,0,s,t,0,0,r),this.LinePreCalc_LineCap1(s,t,0,s,i,0,r,0),this.LinePreCalc_LineCap1(s,i,0,e,i,0,0,-r),this.LinePreCalc_LineCap1(e,i,0,e,t,0,-r,0)}_LineRectPreCalc_LineCap0(e,t,s,i,r){this.LinePreCalc_LineCap0(e,t,0,s,t,0,0,r),this.LinePreCalc_LineCap0(s,t,0,s,i,0,r,0),this.LinePreCalc_LineCap0(s,i,0,e,i,0,0,-r),this.LinePreCalc_LineCap0(e,i,0,e,t,0,-r,0)}LineRect2(e){this.LineRect(e.getLeft(),e.getTop(),e.getRight(),e.getBottom())}LineQuad(e){const t=Bl.angleTo(e.getTlx(),e.getTly(),e.getTrx(),e.getTry()),s=Math.sin(t),i=Math.cos(t),r=.5*this._lineWidth,n=s*r,a=i*r,o=this._lineCap;2===o?this._LineQuadPreCalc_LineCap2(e,n,a):1===o?this._LineQuadPreCalc_LineCap1(e,n,a):this._LineQuadPreCalc_LineCap0(e,n,a)}_LineQuadPreCalc_LineCap2(e,t,s){this.LinePreCalc_LineCap2(e.getTlx(),e.getTly(),0,e.getTrx(),e.getTry(),0,t,s),this.LinePreCalc_LineCap2(e.getTrx(),e.getTry(),0,e.getBrx(),e.getBry(),0,s,-t),this.LinePreCalc_LineCap2(e.getBrx(),e.getBry(),0,e.getBlx(),e.getBly(),0,-t,-s),this.LinePreCalc_LineCap2(e.getBlx(),e.getBly(),0,e.getTlx(),e.getTly(),0,-s,t)}_LineQuadPreCalc_LineCap1(e,t,s){this.LinePreCalc_LineCap1(e.getTlx(),e.getTly(),0,e.getTrx(),e.getTry(),0,t,s),this.LinePreCalc_LineCap1(e.getTrx(),e.getTry(),0,e.getBrx(),e.getBry(),0,s,-t),this.LinePreCalc_LineCap1(e.getBrx(),e.getBry(),0,e.getBlx(),e.getBly(),0,-t,-s),this.LinePreCalc_LineCap1(e.getBlx(),e.getBly(),0,e.getTlx(),e.getTly(),0,-s,t)}_LineQuadPreCalc_LineCap0(e,t,s){this.LinePreCalc_LineCap0(e.getTlx(),e.getTly(),0,e.getTrx(),e.getTry(),0,t,s),this.LinePreCalc_LineCap0(e.getTrx(),e.getTry(),0,e.getBrx(),e.getBry(),0,s,-t),this.LinePreCalc_LineCap0(e.getBrx(),e.getBry(),0,e.getBlx(),e.getBly(),0,-t,-s),this.LinePreCalc_LineCap0(e.getBlx(),e.getBly(),0,e.getTlx(),e.getTly(),0,-s,t)}SetLineWidth(e){this._lineWidth=e,this._lineWidthStack[this._lineWidthStack.length-1]=e}GetLineWidth(){return this._lineWidth}PushLineWidth(e){if(this._lineWidthStack.length>=100)throw new Error("pushed too many line widths - check push/pop pairs");this._lineWidthStack.push(e),this._lineWidth=e}PopLineWidth(){if(this._lineWidthStack.length<=1)throw new Error("cannot pop last line width - check push/pop pairs");this._lineWidthStack.pop(),this._lineWidth=this._lineWidthStack.at(-1)}SetLineCapButt(){this._lineCap=0,this._lineCapStack[this._lineCapStack.length-1]=0}SetLineCapSquare(){this._lineCap=1,this._lineCapStack[this._lineCapStack.length-1]=0}SetLineCapZag(){this._lineCap=2,this._lineCapStack[this._lineCapStack.length-1]=0}PushLineCap(e){if("butt"===e)this.PushLineCapButt();else if("square"===e)this.PushLineCapSquare();else{if("zag"!==e)throw new Error("invalid line cap");this.PushLineCapZag()}}PushLineCapButt(){if(this._lineCapStack.length>=100)throw new Error("pushed too many line caps - check push/pop pairs");this._lineCapStack.push(0),this._lineCap=0}PushLineCapSquare(){if(this._lineCapStack.length>=100)throw new Error("pushed too many line caps - check push/pop pairs");this._lineCapStack.push(1),this._lineCap=1}PushLineCapZag(){if(this._lineCapStack.length>=100)throw new Error("pushed too many line caps - check push/pop pairs");this._lineCapStack.push(2),this._lineCap=2}PopLineCap(){if(this._lineCapStack.length<=1)throw new Error("cannot pop last line cap - check push/pop pairs");this._lineCapStack.pop(),this._lineCap=this._lineCapStack.at(-1)}SetLineOffset(e){this._lineOffset=e,this._lineOffsetStack[this._lineOffsetStack.length-1]=e}GetLineOffset(){return this._lineOffset}PushLineOffset(e){if(this._lineOffsetStack.length>=100)throw new Error("pushed too many line offsets - check push/pop pairs");this._lineOffsetStack.push(e),this._lineOffset=e}PopLineOffset(){if(this._lineOffsetStack.length<=1)throw new Error("cannot pop last line offset - check push/pop pairs");this._lineOffsetStack.pop(),this._lineOffset=this._lineOffsetStack.at(-1)}IsColorDataF16(){return!1}ResetCullState(){this.SetCullFaceMode(0),this.SetFrontFaceWinding(0)}ConvexPoly(e){const t=e.length/2;if(t<3)throw new Error("need at least 3 points");const s=t-2,i=s-1,r=e[0],n=e[1];for(let t=0;t<s;t+=2){const s=2*t,a=e[s+2],o=e[s+3],h=e[s+4],l=e[s+5];if(t===i)this.Quad2(r,n,a,o,h,l,h,l);else{const t=e[s+6],i=e[s+7];this.Quad2(r,n,a,o,h,l,t,i)}}}Finish(){this.EndBatch(!0),this._frameNumber++}GetFrameNumber(){return this._frameNumber}IncrementFrameNumber(){this._frameNumber++}SetMipmapsEnabled(e){this._enableMipmaps=!!e}AreMipmapsEnabled(){return this._enableMipmaps}SetHasMajorPerformanceCaveat(e){this._hasMajorPerformanceCaveat=!!e}HasMajorPerformanceCaveat(){return this._hasMajorPerformanceCaveat}IsWebGL(){return!1}IsWebGPU(){return!1}GetEstimatedBackBufferMemoryUsage(){}GetEstimatedRenderBufferMemoryUsage(){}GetEstimatedTextureMemoryUsage(){}GetEstimatedTotalMemoryUsage(){return this.GetEstimatedBackBufferMemoryUsage()+this.GetEstimatedRenderBufferMemoryUsage()+this.GetEstimatedTextureMemoryUsage()}CreateRendererText(){return Bl.New(Bl.Gfx.RendererText,this)}CreateMeshData(e,t,s){}}}{const Zl=self.C3;Zl.Gfx.ShaderProgramBase=class{constructor(e,t){this._name=t.name,this._renderer=e,this._extendBoxHorizontal=t.extendBoxHorizontal||0,this._extendBoxVertical=t.extendBoxVertical||0,this._crossSampling=!!t.crossSampling,this._mustPreDraw=!!t.mustPreDraw,this._preservesOpaqueness=!!t.preservesOpaqueness,this._supports3dDirectRendering=!!t.supports3dDirectRendering,this._animated=!!t.animated,this._blendsBackground=!!t.blendsBackground,this._usesDepth=!!t.usesDepth,this._usesAnySrcRectOrPixelSize=!1,this._needsPostDrawOrExtendBox=this._crossSampling||this._blendsBackground||0!==this._extendBoxHorizontal||0!==this._extendBoxVertical}Release(){this._renderer=null}GetRenderer(){return this._renderer}GetName(){return this._name}ExtendsBox(){return 0!==this._extendBoxHorizontal||0!==this._extendBoxVertical}GetBoxExtendHorizontal(){return this._extendBoxHorizontal}GetBoxExtendVertical(){return this._extendBoxVertical}UsesCrossSampling(){return this._crossSampling}MustPreDraw(){return this._mustPreDraw}PreservesOpaqueness(){return this._preservesOpaqueness}Supports3DDirectRendering(){return this._supports3dDirectRendering}IsAnimated(){return this._animated}BlendsBackground(){return this._blendsBackground}UsesDepth(){return this._usesDepth}UsesAnySrcRectOrPixelSize(){return this._usesAnySrcRectOrPixelSize}NeedsPostDrawOrExtendsBox(){return this._needsPostDrawOrExtendBox}UsesIsSrcTexRotated(){return!1}}}{const Ql=self.C3;Ql.Gfx.StateGroup=class{constructor(e,t,s,i,r,n,a){this._renderer=e,this._refCount=0,this._shaderProgram=null,this._shaderProgramName="",this._blendMode=s,this._color=Ql.New(Ql.Color),this._color.set(i),this._zElevation=r,this._cullFaceMode=n,this._frontFaceWinding=a,"string"==typeof t?this._shaderProgramName=t:(this._shaderProgram=t,this._shaderProgramName=this._shaderProgram.GetName())}Release(){if(this._refCount>0)throw new Error("releasing state group still in use");this._renderer=null,this._shaderProgram=null,this._shaderProgramName=""}Apply(){const e=this._renderer;e.SetProgram(this._shaderProgram),e.SetBlendMode(this._blendMode),e.SetColor(this._color),e.SetCurrentZ(this._zElevation),e.SetCullFaceMode(this._cullFaceMode),e.SetFrontFaceWinding(this._frontFaceWinding),e._SetCurrentStateGroup(this)}GetKey(){return Ql.Gfx.StateGroup.MakeKey(this._shaderProgramName,this._blendMode,this._color,this._zElevation,this._cullFaceMode,this._frontFaceWinding)}AddRef(){++this._refCount}DecRef(){--this._refCount}_GetRefCount(){return this._refCount}OnContextLost(){this._shaderProgram=null}OnContextRestored(e){if(this._shaderProgram=e.GetShaderProgramByName(this._shaderProgramName),!this._shaderProgram)throw new Error("failed to restore shader program")}static MakeKey(e,t,s,i,r,n){return("string"==typeof e?e:e.GetName())+","+t+","+s.getR()+","+s.getG()+","+s.getB()+","+s.getA()+","+i+","+r+","+n}}}{let ec=function(e,t,s){const i=s.getTlx(),r=s.getTly(),n=s.getTrx()-i,a=s.getTry()-r;return[i+n*e+(s.getBlx()-i)*t,r+a*e+(s.getBly()-r)*t]};interpolateQuad=ec;const tc=globalThis.C3,sc=globalThis.assert,ic=65535;tc.Gfx.DeformMeshPoint=class{#s;#e=0;#t=0;#i=NaN;#h=NaN;#a=NaN;#o=NaN;#n=NaN;constructor(e,t,s){this.#s=e,this.#e=t,this.#t=s,this.#i=0,this.#h=0,this.#a=0,this.#o=0,this.#n=0}_Init(e,t,s,i){this.#i=e,this.#h=t,this.#o=s,this.#n=i}GetX(){return this.#i}SetX(e){this.#i!==e&&(this.#i=e,this.#s._SetPointsChanged())}GetY(){return this.#h}SetY(e){this.#h!==e&&(this.#h=e,this.#s._SetPointsChanged())}GetZElevation(){return this.#a}SetZElevation(e){this.#a!==e&&(this.#a=Math.max(e,0),this.#s._SetPointsChanged())}GetU(){return this.#o}SetU(e){this.#o=e}GetV(){return this.#n}SetV(e){this.#n=e}_Interpolate_TexRect(e,t,s){[this.#i,this.#h]=ec(e.GetX(),e.GetY(),t),this.#a=e.GetZElevation(),this.#o=tc.lerp(s.getLeft(),s.getRight(),e.GetU()),this.#n=tc.lerp(s.getTop(),s.getBottom(),e.GetV())}_Interpolate_TexQuad(e,t,s){[this.#i,this.#h]=ec(e.GetX(),e.GetY(),t),this.#a=e.GetZElevation(),[this.#o,this.#n]=ec(e.GetU(),e.GetV(),s)}SaveToJson(){return{x:this.GetX(),y:this.GetY(),z:this.GetZElevation(),u:this.GetU(),v:this.GetV()}}LoadFromJson(e){this.SetX(e.x),this.SetY(e.y),e.hasOwnProperty("z")&&this.SetZElevation(e.z),this.SetU(e.u),this.SetV(e.v)}GetMesh(){return this.#s}GetColumn(){return this.#e}GetRow(){return this.#t}},tc.Gfx.DeformMesh=class{#r=null;#l=0;#c=0;#u=[];#d=0;#_=0;#p=1;#f=1;#m=0;#g=!1;#S=null;#G=!0;#y=0;#I=new tc.Color(0,0,0,0);constructor(e,t,s){if(e<2||t<2)throw new Error("invalid mesh size");this.#l=e,this.#c=t,this.#r=s||null;const i=e-1,r=t-1;for(let s=0;s<t;++s){const t=[];for(let n=0;n<e;++n){const e=tc.New(tc.Gfx.DeformMeshPoint,this,n,s),a=n/i,o=s/r;e._Init(a,o,a,o),t.push(e)}this.#u.push(t)}}Release(){this.#S&&(this.#S.Release(),this.#S=null),tc.clearArray(this.#u)}GetHSize(){return this.#l}GetVSize(){return this.#c}GetOwner(){return this.#r}_GetPoints(){return this.#u}_SetPointsChanged(){this.#g=!0,this.#G=!0}#T(){if(!this.#g)return;let e=1/0,t=1/0,s=-1/0,i=-1/0,r=0;for(const n of this.#u)for(const a of n){const n=a.GetX(),o=a.GetY();e=Math.min(e,n),t=Math.min(t,o),s=Math.max(s,n),i=Math.max(i,o),r=Math.max(r,a.GetZElevation())}this.#d=e,this.#_=t,this.#p=s,this.#f=i,this.#m=r,this.#g=!1}GetMinX(){return this.#T(),this.#d}GetMinY(){return this.#T(),this.#_}GetMaxX(){return this.#T(),this.#p}GetMaxY(){return this.#T(),this.#f}GetMaxZ(){return this.#T(),this.#m}HasAnyZElevation(){return this.GetMaxZ()>0}GetMeshPointAt(e,t){return e=Math.floor(e),t=Math.floor(t),e<0||e>=this.#l||t<0||t>=this.#c?null:this.#u[t][e]}CalculateTransformedMesh(e,t,s){const i=s instanceof tc.Rect;if(e.GetHSize()!==this.GetHSize()||e.GetVSize()!==this.GetVSize())throw new Error("source mesh wrong size");const r=e._GetPoints(),n=this._GetPoints();for(let e=0,a=n.length;e<a;++e){const a=r[e],o=n[e];for(let e=0,r=o.length;e<r;++e){const r=a[e],n=o[e];i?n._Interpolate_TexRect(r,t,s):n._Interpolate_TexQuad(r,t,s)}}this.#G=!0}#C(e){if(this.#S)return;const t=this.#l,s=this.#c,i=t*s,r=(t-1)*(s-1)*6;this.#S=e.CreateMeshData(i,r,{staticIndices:!0,debugLabel:"deformmesh"}),this.#S.CreateGPUResources(),this.#b()}#b(){const e=this.#l,t=this.#c,s=this.#S.indices;let i=0;for(let r=0,n=t-1;r<n;++r){const t=r*e,n=(r+1)*e;for(let r=0,a=e-1;r<a;++r){const e=r+1,a=r+t,o=e+t,h=e+n,l=r+n;s[i++]=a,s[i++]=o,s[i++]=h,s[i++]=a,s[i++]=h,s[i++]=l}}this.#S.MarkIndexDataChanged()}#x(e){if(!this.#G&&this.#y===e)return;const t=this.#u,s=this.#c,i=this.#S.positions,r=this.#S.texCoords;let n=0,a=0,o=0,h=-1,l=-1,c=-1,u=-1;for(let d=0,_=s;d<_;++d){const s=t[d];for(let t=0,d=s.length;t<d;++t){const d=s[t],_=Math.fround(d.GetX()),p=i[n];i[n++]=_;const f=Math.fround(d.GetY()),m=i[n];i[n++]=f;const g=Math.fround(d.GetZElevation()+e),S=i[n];i[n++]=g;const G=Math.fround(d.GetU()),y=r[a];r[a++]=G;const I=Math.fround(d.GetV()),T=r[a];r[a++]=I,_===p&&f===m&&g===S||(-1===h?(h=o,l=o+1):l=o+1),G===y&&I===T||(-1===c?(c=o,u=o+1):u=o+1),o++}}-1!==h&&this.#S.MarkDataChanged("positions",h,l),-1!==c&&this.#S.MarkDataChanged("texCoords",c,u),this.#G=!1,this.#y=e}#w(e){if(e.equals(this.#I))return;this.#I.set(e);const t=this.#S.colors,s=e.getR(),i=e.getG(),r=e.getB(),n=e.getA();for(let e=0,a=t.length;e<a;)t[e++]=s,t[e++]=i,t[e++]=r,t[e++]=n;this.#S.MarkDataChanged("colors",0,this.#S.GetVertexCount())}Draw(e,t){this.#C(e),this.#x(t),this.#w(e.GetColor()),e.DrawMeshData(this.#S)}Outline(e,t){t||(t=(e,t,s)=>[e,t,s]);const s=this.#u;let i=s[0];for(let r=1,n=s.length;r<n;++r){const a=s[r];let o=i[0],h=a[0];for(let s=1,l=a.length;s<l;++s){const c=i[s],u=a[s],[d,_,p]=t(o.GetX(),o.GetY(),o.GetZElevation()),[f,m,g]=t(c.GetX(),c.GetY(),c.GetZElevation()),[S,G,y]=t(u.GetX(),u.GetY(),u.GetZElevation()),[I,T,C]=t(h.GetX(),h.GetY(),h.GetZElevation());e.Line3D(d,_,p,f,m,g),e.Line3D(d,_,p,S,G,y),e.Line3D(d,_,p,I,T,C),s===l-1&&e.Line3D(f,m,g,S,G,y),r===n-1&&e.Line3D(I,T,C,S,G,y),o=c,h=u}i=a}}InsertPolyMeshVertices(e){const t=.001,s=.99999999,i=e.pointsArr(),r=[],n=this.GetHSize()-1,a=this.GetVSize()-1,o=1/n,h=1/a,l=n-1,c=a-1;let u=i[0],d=i[1],_=tc.clamp(Math.floor(u*n),0,l),p=tc.clamp(Math.floor(d*a),0,c),f=!0,m=0,g=0,S=0,G=-1;const y=()=>{u=tc.clamp(tc.lerp(u,m,S),0,1),d=tc.clamp(tc.lerp(d,g,S),0,1),r.push(u,d)};for(let e=0,I=i.length;e<I;e+=2){u=i[e],d=i[e+1],r.push(u,d),_=tc.clamp(Math.floor(u*n),0,l),p=tc.clamp(Math.floor(d*a),0,c);const T=(e+2)%I;for(m=i[T],g=i[T+1],G=-1;;){if(r.length>1e6)throw new Error("Too many mesh poly points");const e=_*o,i=p*h,n=(_+1)*o,a=(p+1)*h;if(f=tc.isPointInTriangleInclusive(u,d,e,i,n,i,n,a),0!==G&&(S=tc.rayIntersectExtended(u,d,m,g,e,i,n,a,-.001),S>=0&&S<=s))y(),f=!f,G=0;else if(p>0&&2!==G&&(S=tc.rayIntersectExtended(u,d,m,g,e,i,n,i,t),S>=0&&S<=s))y(),p--,f=!1,G=4;else if(_<l&&3!==G&&(S=tc.rayIntersectExtended(u,d,m,g,n,i,n,a,t),S>=0&&S<=s))y(),_++,f=!1,G=1;else if(_>0&&1!==G&&(S=tc.rayIntersectExtended(u,d,m,g,e,i,e,a,t),S>=0&&S<=s))y(),_--,f=!0,G=3;else{if(!(p<c&&4!==G&&(S=tc.rayIntersectExtended(u,d,m,g,e,a,n,a,t),S>=0&&S<=s)))break;y(),p++,f=!0,G=2}}}return tc.New(tc.CollisionPoly,r)}TransformCollisionPoly(e,t){const s=this.#P(e);this.#R(s),t.setPoints(s)}#P(e){const t=[],s=e.pointsArr();for(let e=0,i=s.length;e<i;e+=2){const i=s[e],r=s[e+1],[n,a]=this.TransformPoint(i,r);t.push(n,a)}return t}TransformPoint(e,t){const s=this.GetHSize()-1,i=this.GetVSize()-1,r=1/s,n=1/i,a=tc.clamp(Math.floor(e*s),0,s-1),o=tc.clamp(Math.floor(t*i),0,i-1),h=a*r,l=o*n,c=(a+1)*r,u=(o+1)*n,d=this.GetMeshPointAt(a,o),_=this.GetMeshPointAt(a+1,o+1),p=tc.isPointInTriangleInclusive(e,t,h,l,c,l,c,u),f=p?h+r:h,m=p?l:l+n,g=this.GetMeshPointAt(a+(p?1:0),o+(p?0:1)),[S,G,y]=tc.triangleCartesianToBarycentric(e,t,h,l,f,m,c,u);return tc.triangleBarycentricToCartesian3d(S,G,y,d.GetX(),d.GetY(),d.GetZElevation(),g.GetX(),g.GetY(),g.GetZElevation(),_.GetX(),_.GetY(),_.GetZElevation())}#R(e){const t=[],s=1e-7;let i=e[0],r=e[1],n=i-e.at(-2),a=r-e.at(-1);for(let o=0,h=e.length;o<h;o+=2){const l=(o+2)%h,c=e[l],u=e[l+1],d=c-i,_=u-r,p=Math.abs(d)<s&&Math.abs(n)<s&&Math.sign(_)===Math.sign(a),f=Math.abs(_)<s&&Math.abs(a)<s&&Math.sign(d)===Math.sign(n);(!p&&!f&&Math.abs(d/n-_/a)>.001||0==d&&0===_)&&t.push(i,r),i=c,r=u,n=d,a=_}t.length>=6&&t.length<e.length&&tc.shallowAssignArray(e,t)}SaveToJson(){return{cols:this.GetHSize(),rows:this.GetVSize(),points:this.#u.map(e=>e.map(e=>e.SaveToJson()))}}LoadFromJson(e){const t=this.GetHSize(),s=this.GetVSize();if(e.cols!==t||e.rows!==s)throw new Error("mesh data wrong size");const i=e.points;for(let e=0;e<s;++e){const s=i[e];for(let i=0;i<t;++i)this.GetMeshPointAt(i,e).LoadFromJson(s[i])}}}}{const rc=globalThis.C3,nc=globalThis.assert,ac={staticPositions:!1,staticTexCoords:!1,staticColors:!1,staticIndices:!1,texIndices:!1,debugLabel:""},oc=128,hc=1024;class lc{#e=!1;#s=0;#n=0;#i=0;SetMaxSize(e){this.#i=e}MarkChanged(e,t){if(e<0||t>this.#i)throw new RangeError(`invalid data range (${e} to ${t} outside allowed range 0 to ${this.#i})`);this.#e?(this.#s=Math.min(e,this.#s),this.#n=Math.max(t,this.#n)):(this.#e=!0,this.#s=e,this.#n=t)}GetPendingChange(){return this.#e?{start:this.#s,end:this.#n}:null}Reset(){this.#e=!1}}rc.Gfx.MeshData=class{positions=null;texCoords=null;texIndices=null;colors=null;indices=null;#t;#r="";#h=0;#g=0;#o=!1;#a=0;#l=new lc;#d=new lc;#y=null;#u=new lc;#S=new lc;constructor(e,t,s,i){if(t=Math.floor(t),s=Math.floor(s),t<0||s<0)throw new Error("invalid count");this.#t=e,this.#h=t,this.#g=s,i=Object.assign({},ac,i),this.#o=i.texIndices,this.#r=i.debugLabel,this.#l.SetMaxSize(t),this.#d.SetMaxSize(t),this.#u.SetMaxSize(t),this.#S.SetMaxSize(s),this.#o&&(this.#y=new lc,this.#y.SetMaxSize(t))}Release(){this.#t._ReleaseMeshData(this),this.ReleaseGPUResources(),this.positions=null,this.texCoords=null,this.texIndices=null,this.colors=null,this.indices=null,this.#t=null}GetRenderer(){return this.#t}GetDebugLabel(){return this.#r}CreateGPUResources(){this.positions||(this.positions=new Float32Array(3*this.#h),this.texCoords=new Float32Array(2*this.#h),this.#o&&(this.texIndices=new Uint32Array(this.#h)),this.#t.IsColorDataF16()?this.colors=new globalThis.Float16Array(4*this.#h):this.colors=new Float32Array(4*this.#h),this.IsIndexTypeUint16()?this.indices=new Uint16Array(this.#g):this.indices=new Uint32Array(this.#g))}WriteGPUData(){}ReleaseGPUResources(){this.positions=null,this.texCoords=null,this.texIndices=null,this.colors=null,this.indices=null,this.#t._GetCurrentMeshData()===this&&this.#t.EndBatch()}OnContextLost(){}OnContextRestored(){this.CreateGPUResources(),this.MarkAllVertexDataChanged(),this.MarkIndexDataChanged()}IsIndexTypeUint16(){return this.GetVertexCount()<65536}GetVertexCount(){return this.#h}GetIndexCount(){return this.#g}IsSmall(){return this.GetVertexCount()<128&&this.GetIndexCount()<1024}GetPendingBufferUpdate(e){switch(e){case"positions":return this.#l;case"texCoords":return this.#d;case"texIndices":if(!this.#o)throw new Error("texture indices not enabled");return this.#y;case"colors":return this.#u;case"indices":return this.#S;default:throw new Error(`invalid buffer type '${e}'`)}}MarkDataChanged(e,t,s){(t=Math.floor(t))!==(s=Math.floor(s))&&this.GetPendingBufferUpdate(e).MarkChanged(t,s)}MarkAllVertexDataChanged(e=0,t=this.GetVertexCount()){this.MarkDataChanged("positions",e,t),this.MarkDataChanged("texCoords",e,t),this.MarkDataChanged("colors",e,t),this.#o&&this.MarkDataChanged("texIndices",e,t)}MarkIndexDataChanged(e=0,t=this.GetIndexCount()){this.MarkDataChanged("indices",e,t)}FillColor(e,t,s,i){const r=this.colors;for(let n=0,a=r.length;n<a;)r[n++]=e,r[n++]=t,r[n++]=s,r[n++]=i}FillTexIndices(e){this.#a!==e&&(this.#a=e,this.texIndices.fill(e),this.MarkDataChanged("texIndices",0,this.GetVertexCount()))}}}{const cc=globalThis.C3,uc=globalThis.assert,dc=65535,_c=393210,pc=new cc.Quad(0,0,1,0,1,1,0,1),fc={texIndices:!1};cc.Gfx.DynamicMeshData=class{#s;#e=0;#t=0;#i=null;#r=null;#o=null;#h=null;#n=null;#a=new cc.Color(1,1,1,1);constructor(e,t){t=Object.assign({},fc,t),this.#s=e.CreateMeshData(65535,393210,{texIndices:t.texIndices,debugLabel:"dynamic"})}Release(){this.#s.Release(),this.#s=null,this.#i=null,this.#r=null,this.#o=null,this.#h=null,this.#n=null}_GetMeshData(){return this.#s}CreateGPUResources(){this.#s.CreateGPUResources(),this.#i=this.#s.positions,this.#r=this.#s.texCoords,this.#o=this.#s.texIndices,this.#h=this.#s.colors,this.#n=this.#s.indices}WriteGPUData(e){this.#s.MarkAllVertexDataChanged(0,this.#e),this.#s.MarkIndexDataChanged(0,this.#t),this.#s.WriteGPUData(e),this.#e=0,this.#t=0}ReleaseGPUResources(){this.#s.ReleaseGPUResources(),this.#i=null,this.#r=null,this.#o=null,this.#h=null,this.#n=null}OnContextLost(){this.#s.OnContextLost()}WebGPUInitRenderPassVertexBuffers(e){this.#s.WebGPUInitRenderPassVertexBuffers(e)}WebGPUInitRenderPassIndexBuffer(e){this.#s.WebGPUInitRenderPassIndexBuffer(e)}CanFit(e,t){return this.#e+e<=65535&&this.#t+t<=393210}GetVertexPtr(){return this.#e}GetIndexPtr(){return this.#t}static GetMaxVertices(){return 65535}static GetMaxIndices(){return 393210}GetDefaultColor(){return this.#a}#g(){const e=this.#e;this.#e+=4;let t=this.#t;this.#t+=6;const s=this.#n;return s[t++]=e,s[t++]=e+1,s[t++]=e+2,s[t++]=e,s[t++]=e+2,s[t]=e+3,e}WriteTexIndicesForQuad(e,t){const s=this.#o;s[e++]=t,s[e++]=t,s[e++]=t,s[e]=t}FillTexIndices(e,t,s){this.#o.fill(s,e,e+t)}WriteQuad(e,t){return this.WriteQuad4(e,t,pc)}WriteQuad2(e,t,s,i,r,n,a,o,h){const l=this.#g(),c=this.#i;let u=3*l;return c[u++]=t,c[u++]=s,c[u++]=e,c[u++]=i,c[u++]=r,c[u++]=e,c[u++]=n,c[u++]=a,c[u++]=e,c[u++]=o,c[u++]=h,c[u]=e,pc.writeToTypedArray(this.#r,2*l),this.#a.writeToTypedArrayx4(this.#h,4*l),l}WriteQuad3(e,t,s){const i=this.#g();return t.writeToTypedArray3D(this.#i,3*i,e),s.writeAsQuadToTypedArray(this.#r,2*i),this.#a.writeToTypedArrayx4(this.#h,4*i),i}WriteQuad4(e,t,s){const i=this.#g();return t.writeToTypedArray3D(this.#i,3*i,e),s.writeToTypedArray(this.#r,2*i),this.#a.writeToTypedArrayx4(this.#h,4*i),i}WriteQuad5(e,t,s,i){const r=this.#g();return t.writeToTypedArray3D(this.#i,3*r,e),s.writeToTypedArray(this.#r,2*r),this.#h.set(i,4*r),r}WriteQuad3D(e,t,s,i,r,n,a,o,h,l,c,u,d,_){const p=this.#g(),f=this.#i;let m=3*p;return f[m++]=t,f[m++]=s,f[m++]=i+e,f[m++]=r,f[m++]=n,f[m++]=a+e,f[m++]=o,f[m++]=h,f[m++]=l+e,f[m++]=c,f[m++]=u,f[m]=d+e,_.writeAsQuadToTypedArray(this.#r,2*p),this.#a.writeToTypedArrayx4(this.#h,4*p),p}WriteQuad3D2(e,t,s,i,r,n,a,o,h,l,c,u,d,_){const p=this.#g(),f=this.#i;let m=3*p;return f[m++]=t,f[m++]=s,f[m++]=i+e,f[m++]=r,f[m++]=n,f[m++]=a+e,f[m++]=o,f[m++]=h,f[m++]=l+e,f[m++]=c,f[m++]=u,f[m]=d+e,_.writeToTypedArray(this.#r,2*p),this.#a.writeToTypedArrayx4(this.#h,4*p),p}WriteQuad3D3(e,t,s,i,r,n,a,o,h,l,c,u,d,_,p){const f=this.#g(),m=this.#i;let g=3*f;return m[g++]=t,m[g++]=s,m[g++]=i+e,m[g++]=r,m[g++]=n,m[g++]=a+e,m[g++]=o,m[g++]=h,m[g++]=l+e,m[g++]=c,m[g++]=u,m[g]=d+e,_.writeToTypedArray(this.#r,2*f),this.#h.set(p,4*f),this.#a.writeToTypedArrayx4(this.#h,4*f),f}WriteMesh(e,t,s,i,r=0){const n=Math.floor(e.length/3),a=this.#e;this.#i.set(e,3*a),this.#r.set(t,2*a);const o=this.#n;if(0===a&&0===r)o.set(s,this.#t);else{let e=this.#t;for(let t=0,i=s.length;t<i;++t)o[e++]=s[t]+a-r}const h=this.#h;if(i)h.set(i,4*a);else{const e=this.#a,t=e.getR(),s=e.getG(),i=e.getB(),r=e.getA();let o=4*a;for(let e=0,a=n;e<a;++e)h[o++]=t,h[o++]=s,h[o++]=i,h[o++]=r}return this.#e+=n,this.#t+=s.length,a}static CalculatePartialIndexRange(e,t,s){let i=e[t],r=e[t];for(let n=t+1,a=t+s;n<a;++n){const t=e[n];i=Math.min(i,t),r=Math.max(r,t)}return{minIndex:i,maxIndex:r}}}}{let mc=function(e,t){let s,i,r,n;switch(e){case"rgba8":s=t.RGBA8,i=t.RGBA,r=t.RGBA,n=t.UNSIGNED_BYTE;break;case"rgb8":s=t.RGB8,i=t.RGB,r=t.RGB,n=t.UNSIGNED_BYTE;break;case"rgba4":s=t.RGBA4,i=t.RGBA,r=t.RGBA,n=t.UNSIGNED_SHORT_4_4_4_4;break;case"rgb5_a1":s=t.RGB5_A1,i=t.RGBA,r=t.RGBA,n=t.UNSIGNED_SHORT_5_5_5_1;break;case"rgb565":s=t.RGB565,i=t.RGB,r=t.RGB,n=t.UNSIGNED_SHORT_5_6_5;break;default:throw new Error("invalid pixel format")}return{sizedinternalformat:s,internalformat:i,format:r,type:n}};GetFormatSpecifiers=mc;const gc=self.C3,Sc=new Set(["rgba8","rgb8","rgba4","rgb5_a1","rgb565"]),Gc=new Set(["nearest","bilinear","trilinear"]),yc=new Set(["default","low","high"]),Ic=new Set(["clamp-to-edge","repeat","mirror-repeat"]),Tc={wrapX:"clamp-to-edge",wrapY:"clamp-to-edge",sampling:"trilinear",anisotropy:0,pixelFormat:"rgba8",mipMap:!0,mipMapQuality:"default",premultiplyAlpha:!0,isSvg:!1,width:-1,height:-1},Cc={premultiplyAlpha:!0,flipY:!1},bc=new Set;gc.Gfx.WebGLRendererTexture=class{constructor(e){this._renderer=e,this._texture=null,this._width=0,this._height=0,this._isStatic=!0,this._wrapX="clamp-to-edge",this._wrapY="clamp-to-edge",this._sampling="trilinear",this._anisotropy=0,this._pixelFormat="rgba8",this._isMipMapped=!1,this._mipMapQuality="default",this._refCount=0}_CreateStatic(e,t){if(!("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||e instanceof ImageData||e instanceof ArrayBuffer))throw new Error("invalid texture source");if(t=Object.assign({},Tc,t),this._texture)throw new Error("already created texture");if(this._wrapX=t.wrapX,this._wrapY=t.wrapY,this._sampling=t.sampling,this._anisotropy=t.anisotropy,this._pixelFormat=t.pixelFormat,this._isMipMapped=!!t.mipMap&&this._renderer.AreMipmapsEnabled(),this._mipMapQuality=t.mipMapQuality,!Ic.has(this._wrapX)||!Ic.has(this._wrapY))throw new Error("invalid wrap mode");if(!Gc.has(this._sampling))throw new Error("invalid sampling");if(!Sc.has(this._pixelFormat))throw new Error("invalid pixel format");if(!yc.has(this._mipMapQuality))throw new Error("invalid mipmap quality");if(this._isStatic=!0,e instanceof ArrayBuffer||null===e||t.isSvg){if(this._width=t.width,this._height=t.height,e instanceof ArrayBuffer&&e.byteLength!==this._width*this._height*4)throw new Error("ArrayBuffer wrong size")}else this._width=e.width,this._height=e.height;if(this._width<=0||this._height<=0)throw new Error("invalid texture data size");if(t.isSvg){const t=gc.CreateCanvas(this._width,this._height);t.getContext("2d").drawImage(e,0,0,this._width,this._height),e=t}const s=gc.isPOT(this._width)&&gc.isPOT(this._height),i=this._renderer.GetMaxTextureSize();if(this._width>i||this._height>i)throw new Error("texture data exceeds maximum texture size");const r=this._renderer.GetContext(),n=this._renderer.GetWebGLVersionNumber();this._texture=r.createTexture(),r.bindTexture(r.TEXTURE_2D,this._texture),r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,!1);const a=mc(this._pixelFormat,r);if(this._renderer.SupportsNPOTTextures()||s||!this._IsTiled())if(n>=2){let t;t=this._isMipMapped?Math.floor(Math.log2(Math.max(this._width,this._height))+1):1,r.texStorage2D(r.TEXTURE_2D,t,a.sizedinternalformat,this._width,this._height),e instanceof ArrayBuffer?r.texSubImage2D(r.TEXTURE_2D,0,0,0,this._width,this._height,a.format,a.type,new Uint8Array(e)):null!==e&&r.texSubImage2D(r.TEXTURE_2D,0,0,0,a.format,a.type,e)}else e instanceof ArrayBuffer?r.texImage2D(r.TEXTURE_2D,0,a.internalformat,this._width,this._height,0,a.format,a.type,new Uint8Array(e)):null===e?r.texImage2D(r.TEXTURE_2D,0,a.internalformat,this._width,this._height,0,a.format,a.type,null):r.texImage2D(r.TEXTURE_2D,0,a.internalformat,a.format,a.type,e);else{if(null===e)throw new Error("cannot pass null data when creating a NPOT tiled texture without NPOT support");if(e instanceof ArrayBuffer&&(e=new ImageData(new Uint8ClampedArray(e),this._width,this._height)),e instanceof ImageData){const t=gc.CreateCanvas(this._width,this._height);t.getContext("2d").putImageData(e,0,0),e=t}const t=gc.CreateCanvas(gc.nextHighestPowerOfTwo(this._width),gc.nextHighestPowerOfTwo(this._height)),s=t.getContext("2d");s.imageSmoothingEnabled="nearest"!==this._sampling,s.drawImage(e,0,0,this._width,this._height,0,0,t.width,t.height),r.texImage2D(r.TEXTURE_2D,0,a.internalformat,a.format,a.type,t)}null!==e&&this._SetTextureParameters(r),r.bindTexture(r.TEXTURE_2D,null),this._renderer._ResetLastTexture(),this._refCount=1,bc.add(this)}_CreateDynamic(e,t,s){if(s=Object.assign({},Tc,s),this._texture)throw new Error("already created texture");if(this._wrapX=s.wrapX,this._wrapY=s.wrapY,this._sampling=s.sampling,this._pixelFormat=s.pixelFormat,this._isMipMapped=!!s.mipMap&&this._renderer.AreMipmapsEnabled(),this._mipMapQuality=s.mipMapQuality,!Ic.has(this._wrapX)||!Ic.has(this._wrapY))throw new Error("invalid wrap mode");if(!Gc.has(this._sampling))throw new Error("invalid sampling");if(!Sc.has(this._pixelFormat))throw new Error("invalid pixel format");if(!yc.has(this._mipMapQuality))throw new Error("invalid mipmap quality");this._isStatic=!1,this._width=Math.floor(e),this._height=Math.floor(t);const i=gc.isPOT(this._width)&&gc.isPOT(this._height),r=this._renderer.GetMaxTextureSize();if(this._width<=0||this._height<=0)throw new Error("invalid texture size");if(this._width>r||this._height>r)throw new Error("texture exceeds maximum texture size");if(!this._renderer.SupportsNPOTTextures()&&this._IsTiled()&&!i)throw new Error("non-power-of-two tiled textures not supported");const n=this._renderer.GetContext(),a=this._renderer.GetWebGLVersionNumber();this._texture=n.createTexture(),n.bindTexture(n.TEXTURE_2D,this._texture),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s.premultiplyAlpha),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!1);const o=mc(this._pixelFormat,n),h=a>=2?o.sizedinternalformat:o.internalformat;n.texImage2D(n.TEXTURE_2D,0,h,this._width,this._height,0,o.format,o.type,null),this._SetTextureParameters(n),n.bindTexture(n.TEXTURE_2D,null),this._renderer._ResetLastTexture(),this._refCount=1,bc.add(this)}_GetMipMapHint(e){if("default"===this._mipMapQuality)return this._isStatic?e.NICEST:e.FASTEST;if("low"===this._mipMapQuality)return e.FASTEST;if("high"===this._mipMapQuality)return e.NICEST;throw new Error("invalid mipmap quality")}_IsTiled(){return"clamp-to-edge"!==this._wrapX||"clamp-to-edge"!==this._wrapY}_GetTextureWrapMode(e,t){if("clamp-to-edge"===t)return e.CLAMP_TO_EDGE;if("repeat"===t)return e.REPEAT;if("mirror-repeat"===t)return e.MIRRORED_REPEAT;throw new Error("invalid wrap mode")}_SetTextureParameters(e){const t=gc.isPOT(this._width)&&gc.isPOT(this._height);if(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,this._GetTextureWrapMode(e,this._wrapX)),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,this._GetTextureWrapMode(e,this._wrapY)),"nearest"===this._sampling)e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),this._isMipMapped=!1;else if(e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),(t||this._renderer.SupportsNPOTTextures())&&this._isMipMapped){e.hint(e.GENERATE_MIPMAP_HINT,this._GetMipMapHint(e)),e.generateMipmap(e.TEXTURE_2D);const t="trilinear"===this._sampling&&!this._renderer.HasMajorPerformanceCaveat();e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,t?e.LINEAR_MIPMAP_LINEAR:e.LINEAR_MIPMAP_NEAREST)}else e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.LINEAR),this._isMipMapped=!1;const s=this._renderer._GetAnisotropicExtension();s&&this._anisotropy>0&&"nearest"!==this._sampling&&e.texParameterf(e.TEXTURE_2D,s.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(this._anisotropy,this._renderer._GetMaxAnisotropy()))}_Update(e,t){if(!("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||e instanceof ImageData))throw new Error("invalid texture source");if(!this._texture||this._refCount<=0)throw new Error("texture not created");if(this._isStatic)throw new Error("cannot update static texture");t=Object.assign({},Cc,t);const s=e.width||e.videoWidth,i=e.height||e.videoHeight,r=this._renderer.GetWebGLVersionNumber(),n=this._renderer.GetContext();n.bindTexture(n.TEXTURE_2D,this._texture),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t.premultiplyAlpha),n.pixelStorei(n.UNPACK_FLIP_Y_WEBGL,!!t.flipY);const a=mc(this._pixelFormat,n),o=r>=2?a.sizedinternalformat:a.internalformat;try{if(this._width===s&&this._height===i){const t=gc.isPOT(this._width)&&gc.isPOT(this._height);n.texSubImage2D(n.TEXTURE_2D,0,0,0,a.format,a.type,e),(t||this._renderer.SupportsNPOTTextures())&&this._isMipMapped&&(n.hint(n.GENERATE_MIPMAP_HINT,this._GetMipMapHint(n)),n.generateMipmap(n.TEXTURE_2D))}else{this._width=s,this._height=i;const t=gc.isPOT(this._width)&&gc.isPOT(this._height);if(!this._renderer.SupportsNPOTTextures()&&this._IsTiled()&&!t)throw new Error("non-power-of-two tiled textures not supported");n.texImage2D(n.TEXTURE_2D,0,o,a.format,a.type,e),(t||this._renderer.SupportsNPOTTextures())&&this._isMipMapped&&(n.hint(n.GENERATE_MIPMAP_HINT,this._GetMipMapHint(n)),n.generateMipmap(n.TEXTURE_2D))}}catch(e){console.error("Error updating WebGL texture: ",e)}n.bindTexture(n.TEXTURE_2D,null),this._renderer._ResetLastTexture()}_Delete(){if(this._refCount>0)throw new Error("texture still has references");if(!this._texture)throw new Error("already deleted texture");bc.delete(this),this._renderer.GetContext().deleteTexture(this._texture),this._texture=null}IsValid(){return!!this._texture}_GetTexture(){return this._texture}GetRenderer(){return this._renderer}AddReference(){this._refCount++}SubtractReference(){if(this._refCount<=0)throw new Error("no more references");this._refCount--}GetReferenceCount(){return this._refCount}GetWidth(){return this._width}GetHeight(){return this._height}IsStatic(){return this._isStatic}GetEstimatedMemoryUsage(){let e=this._width*this._height;switch(this._pixelFormat){case"rgba8":e*=4;break;case"rgb8":e*=3;break;case"rgba4":case"rgb5_a1":case"rgb565":e*=2}return this._isMipMapped&&(e+=Math.floor(e/3)),e}static OnContextLost(){bc.clear()}static allTextures(){return bc.values()}}}{const xc=self.C3,wc=self.assert,Pc=self.glMatrix,Rc=Pc.vec3,vc=Pc.mat4,Ac=new Set(["nearest","bilinear","trilinear"]),Mc={sampling:"trilinear",alpha:!0,depth:!1,isSampled:!0,isDefaultSize:!0,multisampling:0},Dc=new Set;xc.Gfx.WebGLRenderTarget=class{constructor(e){this._renderer=e,this._frameBuffer=null,this._frameBufferNoDepth=null,this._texture=null,this._renderBuffer=null,this._width=0,this._height=0,this._isDefaultSize=!0,this._sampling="trilinear",this._alpha=!0,this._depth=!1,this._isSampled=!0,this._multisampling=0,this._projectionMatrix=vc.create(),this._lastFov=0,this._lastNearZ=0,this._lastFarZ=0}_Create(e,t,s){s=Object.assign({},Mc,s);const i=this._renderer.GetWebGLVersionNumber();if(this._texture||this._renderBuffer)throw new Error("already created render target");if(this._sampling=s.sampling,this._alpha=!!s.alpha,this._depth=!!s.depth,this._isSampled=!!s.isSampled,this._isDefaultSize=!!s.isDefaultSize,this._multisampling=s.multisampling,!Ac.has(this._sampling))throw new Error("invalid sampling");if(this._multisampling>0&&(i<2||this._isSampled))throw new Error("invalid use of multisampling");if(i<2&&(this._isSampled=!0),this._width=e,this._height=t,this._width<=0||this._height<=0)throw new Error("invalid render target size");this._CalculateProjection();const r=this._renderer.GetContext();if(this._frameBuffer=r.createFramebuffer(),this._depth&&(this._frameBufferNoDepth=r.createFramebuffer()),this._isSampled){this._texture=this._renderer.CreateDynamicTexture(this._width,this._height,{sampling:this._sampling,pixelFormat:this._alpha?"rgba8":"rgb8",mipMap:!1});const e=this._texture._GetTexture();r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,e,0),this._depth&&(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBufferNoDepth),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,e,0))}else{this._renderBuffer=r.createRenderbuffer(),r.bindRenderbuffer(r.RENDERBUFFER,this._renderBuffer);const e=this._alpha?r.RGBA8:r.RGB8;if(this._multisampling>0){const t=r.getInternalformatParameter(r.RENDERBUFFER,e,r.SAMPLES);if(t&&t[0]){const e=t[0];this._multisampling>e&&(this._multisampling=e)}else this._multisampling=0}0===this._multisampling?r.renderbufferStorage(r.RENDERBUFFER,e,this._width,this._height):r.renderbufferStorageMultisample(r.RENDERBUFFER,this._multisampling,e,this._width,this._height),r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,this._renderBuffer),this._depth&&(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBufferNoDepth),r.framebufferRenderbuffer(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.RENDERBUFFER,this._renderBuffer)),r.bindRenderbuffer(r.RENDERBUFFER,null)}const n=this._renderer._GetDepthBuffer();this._depth&&n&&(r.bindFramebuffer(r.FRAMEBUFFER,this._frameBuffer),this._renderer._CanSampleDepth()?r.framebufferTexture2D(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.TEXTURE_2D,n,0):r.framebufferRenderbuffer(r.FRAMEBUFFER,r.DEPTH_STENCIL_ATTACHMENT,r.RENDERBUFFER,n)),r.bindFramebuffer(r.FRAMEBUFFER,null),Dc.add(this)}_Resize(e,t){if(this._width===e&&this._height===t)return;this._width=e,this._height=t,this._CalculateProjection();const s=this._renderer.GetContext();s.bindFramebuffer(s.FRAMEBUFFER,this._frameBuffer),this._texture?this._texture._Update(new ImageData(this._width,this._height)):(s.bindRenderbuffer(s.RENDERBUFFER,this._renderBuffer),s.renderbufferStorage(s.RENDERBUFFER,this._alpha?s.RGBA8:s.RGB8,this._width,this._height),s.bindRenderbuffer(s.RENDERBUFFER,null));const i=this._renderer._GetDepthBuffer();this._depth&&i&&(this._renderer._CanSampleDepth()?s.framebufferTexture2D(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.TEXTURE_2D,i,0):s.framebufferRenderbuffer(s.FRAMEBUFFER,s.DEPTH_STENCIL_ATTACHMENT,s.RENDERBUFFER,i)),s.bindFramebuffer(s.FRAMEBUFFER,null)}_Delete(){if(!this._texture&&!this._renderBuffer)throw new Error("already deleted render target");Dc.delete(this);const e=this._renderer.GetContext();this._texture?(e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,null,0),this._depth&&(e.bindFramebuffer(e.FRAMEBUFFER,this._frameBufferNoDepth),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,null,0)),this._renderer.DeleteTexture(this._texture),this._texture=null):this._renderBuffer&&(e.bindFramebuffer(e.FRAMEBUFFER,this._frameBuffer),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,null),this._depth&&(e.bindFramebuffer(e.FRAMEBUFFER,this._frameBufferNoDepth),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,null)),e.deleteRenderbuffer(this._renderBuffer),this._renderBuffer=null),e.bindFramebuffer(e.FRAMEBUFFER,null),this._renderer.GetWebGLVersionNumber()>=2&&(e.bindFramebuffer(e.READ_FRAMEBUFFER,null),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null)),e.deleteFramebuffer(this._frameBuffer),this._depth&&e.deleteFramebuffer(this._frameBufferNoDepth);const t=this._renderer.GetBatchState();t.currentFramebuffer=null,t.currentFramebufferNoDepth=null,this._frameBuffer=null}_CalculateProjection(){this._renderer.CalculatePerspectiveMatrix(this._projectionMatrix,this._width/this._height),this._lastFov=this._renderer.GetFovY(),this._lastNearZ=this._renderer.GetNearZ(),this._lastFarZ=this._renderer.GetFarZ()}_GetFramebuffer(){return this._frameBuffer}_GetFramebufferNoDepth(){return this._frameBufferNoDepth}GetRenderer(){return this._renderer}GetTexture(){return this._texture}GetProjectionMatrix(){return this._renderer.GetFovY()===this._lastFov&&this._renderer.GetNearZ()===this._lastNearZ&&this._renderer.GetFarZ()===this._lastFarZ||this._CalculateProjection(),this._projectionMatrix}IsLinearSampling(){return"nearest"!==this._sampling}HasAlpha(){return this._alpha}IsSampled(){return this._isSampled}HasDepthBuffer(){return this._depth}GetWidth(){return this._width}GetHeight(){return this._height}IsDefaultSize(){return this._isDefaultSize}GetMultisampling(){return this._multisampling}GetOptions(){const e={sampling:this._sampling,alpha:this._alpha,isSampled:this._isSampled};return this._isDefaultSize||(e.width=this._width,e.height=this._height),e}IsCompatibleWithOptions(e){return"nearest"!==(e=Object.assign({},Mc,e)).sampling===this.IsLinearSampling()&&!!e.alpha===this.HasAlpha()&&!!e.depth===this.HasDepthBuffer()&&!(this._renderer.GetWebGLVersionNumber()>=2&&!!e.isSampled!==this.IsSampled())&&("number"==typeof e.width||"number"==typeof e.height?!this.IsDefaultSize()&&this.GetWidth()===Math.floor(e.width)&&this.GetHeight()===Math.floor(e.height):this.IsDefaultSize())}_GetWebGLTexture(){return this._texture?this._texture._GetTexture():null}GetEstimatedMemoryUsage(){return this._texture?this._texture.GetEstimatedMemoryUsage():this._width*this._height*(this._alpha?4:3)}static async DebugReadPixelsToBlob(e,t){const s=await e.ReadBackRenderTargetToImageData(t,!0);return await xc.ImageDataToBlob(s)}static OnContextLost(){Dc.clear()}static allRenderTargets(){return Dc.values()}static ResizeAll(e,t){for(const s of Dc)s.IsDefaultSize()&&s._Resize(e,t)}}}{const Ec=self.C3,Fc=self.glMatrix,Oc=Fc.vec3,Bc=Fc.mat4,kc=new Set(["aPos","aTex","aColor","aPoints","matP","matMV","samplerFront","samplerBack","samplerDepth","destStart","destEnd","srcStart","srcEnd","srcOriginStart","srcOriginEnd","pixelSize","seconds","devicePixelRatio","layerScale","layerAngle","layoutStart","layoutEnd","color","color2_","pointTexStart","pointTexEnd","zElevation","tileSize","tileSpacing","outlineThickness","zNear","zFar"]);Ec.Gfx.WebGLShaderProgram=class extends Ec.Gfx.ShaderProgramBase{static async Compile(e,t){const s=e.GetContext(),i=t.src,r=t.vertexSrc,n=t.name,a=s.createShader(s.FRAGMENT_SHADER);s.shaderSource(a,i),s.compileShader(a);const o=s.createShader(s.VERTEX_SHADER);s.shaderSource(o,r),s.compileShader(o);const h=s.createProgram();s.attachShader(h,a),s.attachShader(h,o),s.bindAttribLocation(h,0,"aPos"),s.bindAttribLocation(h,1,"aTex"),s.bindAttribLocation(h,2,"aColor"),s.bindAttribLocation(h,3,"aPoints"),s.linkProgram(h);const l=e._GetParallelShaderCompileExtension();if(l?await e._WaitForObjectReady(()=>s.getProgramParameter(h,l.COMPLETION_STATUS_KHR)):await Ec.Wait(5),!s.getShaderParameter(a,s.COMPILE_STATUS)){const e=s.getShaderInfoLog(a);throw s.deleteShader(a),s.deleteShader(o),s.deleteProgram(h),new Error("Error compiling fragment shader: "+e)}if(!s.getShaderParameter(o,s.COMPILE_STATUS)){const e=s.getShaderInfoLog(o);throw s.deleteShader(a),s.deleteShader(o),s.deleteProgram(h),new Error("Error compiling vertex shader: "+e)}if(!s.getProgramParameter(h,s.LINK_STATUS)){const e=s.getProgramInfoLog(h);throw s.deleteShader(a),s.deleteShader(o),s.deleteProgram(h),new Error("Error linking shader program: "+e)}const c=Ec.FilterUnprintableChars(s.getProgramInfoLog(h)||"").trim();return c&&!Ec.IsStringAllWhitespace(c)&&console.info(`[WebGL] Shader program '${n}' compilation log: `,c),s.deleteShader(a),s.deleteShader(o),h}static async Create(e,t){const s=await Ec.Gfx.WebGLShaderProgram.Compile(e,t);return new Ec.Gfx.WebGLShaderProgram(e,s,t)}constructor(e,t,s){super(e,s);const i=e.GetContext(),r=e.GetBatchState();e.EndBatch(),i.useProgram(t),this._gl=i,this._shaderProgram=t,this._isDeviceTransform="<default-device-transform>"===s.name,this._uMatP=new Ec.Gfx.WebGLShaderUniform(this,"matP","mat4"),this._uMatMV=new Ec.Gfx.WebGLShaderUniform(this,"matMV","mat4"),this._uColor=new Ec.Gfx.WebGLShaderUniform(this,"color","vec4"),this._uSamplerFront=new Ec.Gfx.WebGLShaderUniform(this,"samplerFront","sampler"),this._uPointTexStart=new Ec.Gfx.WebGLShaderUniform(this,"pointTexStart","vec2"),this._uPointTexEnd=new Ec.Gfx.WebGLShaderUniform(this,"pointTexEnd","vec2"),this._uZElevation=new Ec.Gfx.WebGLShaderUniform(this,"zElevation","float"),this._uTileSize=new Ec.Gfx.WebGLShaderUniform(this,"tileSize","vec2"),this._uTileSpacing=new Ec.Gfx.WebGLShaderUniform(this,"tileSpacing","vec2"),this._uColor2=new Ec.Gfx.WebGLShaderUniform(this,"color2_","vec4"),this._uOutlineThickness=new Ec.Gfx.WebGLShaderUniform(this,"outlineThickness","float"),this._uSamplerBack=new Ec.Gfx.WebGLShaderUniform(this,"samplerBack","sampler"),this._uSamplerDepth=new Ec.Gfx.WebGLShaderUniform(this,"samplerDepth","sampler"),this._uDestStart=new Ec.Gfx.WebGLShaderUniform(this,"destStart","vec2"),this._uDestEnd=new Ec.Gfx.WebGLShaderUniform(this,"destEnd","vec2"),this._uSrcStart=new Ec.Gfx.WebGLShaderUniform(this,"srcStart","vec2"),this._uSrcEnd=new Ec.Gfx.WebGLShaderUniform(this,"srcEnd","vec2"),this._uSrcOriginStart=new Ec.Gfx.WebGLShaderUniform(this,"srcOriginStart","vec2"),this._uSrcOriginEnd=new Ec.Gfx.WebGLShaderUniform(this,"srcOriginEnd","vec2"),this._uPixelSize=new Ec.Gfx.WebGLShaderUniform(this,"pixelSize","vec2"),this._uSeconds=new Ec.Gfx.WebGLShaderUniform(this,"seconds","float"),this._uDevicePixelRatio=new Ec.Gfx.WebGLShaderUniform(this,"devicePixelRatio","float"),this._uLayerScale=new Ec.Gfx.WebGLShaderUniform(this,"layerScale","float"),this._uLayerAngle=new Ec.Gfx.WebGLShaderUniform(this,"layerAngle","float"),this._uLayoutStart=new Ec.Gfx.WebGLShaderUniform(this,"layoutStart","vec2"),this._uLayoutEnd=new Ec.Gfx.WebGLShaderUniform(this,"layoutEnd","vec2"),this._uZNear=new Ec.Gfx.WebGLShaderUniform(this,"zNear","float"),this._uZFar=new Ec.Gfx.WebGLShaderUniform(this,"zFar","float"),this._hasAnyOptionalUniforms=!!(this._uPixelSize.IsUsed()||this._uSeconds.IsUsed()||this._uSamplerBack.IsUsed()||this._uDestStart.IsUsed()||this._uDestEnd.IsUsed()||this._uSrcStart.IsUsed()||this._uSrcEnd.IsUsed()||this._uSrcOriginStart.IsUsed()||this._uSrcOriginEnd.IsUsed()||this._uDevicePixelRatio.IsUsed()||this._uLayerScale.IsUsed()||this._uLayerAngle.IsUsed()||this._uLayoutStart.IsUsed()||this._uLayoutEnd.IsUsed());const n=s.parameters||[];this._uCustomParameters=[],this._usesAnySrcRectOrPixelSize=this._uPixelSize.IsUsed()||this._uSrcStart.IsUsed()||this._uSrcEnd.IsUsed()||this._uSrcOriginStart.IsUsed()||this._uSrcOriginEnd.IsUsed(),this._hasCurrentMatP=!1,this._hasCurrentMatMV=!1,this._uColor.Init4f(1,1,1,1),this._uColor2.Init4f(1,1,1,1),this._uSamplerFront.Init1i(0),this._uSamplerBack.Init1i(1),this._uSamplerDepth.Init1i(2),this._uPointTexStart.Init2f(0,0),this._uPointTexEnd.Init2f(1,1),this._uZElevation.Init1f(0),this._uTileSize.Init2f(0,0),this._uTileSpacing.Init2f(0,0),this._uDestStart.Init2f(0,0),this._uDestEnd.Init2f(1,1),this._uSrcStart.Init2f(0,0),this._uSrcEnd.Init2f(0,0),this._uSrcOriginStart.Init2f(0,0),this._uSrcOriginEnd.Init2f(0,0),this._uPixelSize.Init2f(0,0),this._uDevicePixelRatio.Init1f(1),this._uZNear.Init1f(e.GetNearZ()),this._uZFar.Init1f(e.GetFarZ()),this._uLayerScale.Init1f(1),this._uLayerAngle.Init1f(0),this._uSeconds.Init1f(0),this._uLayoutStart.Init2f(0,0),this._uLayoutEnd.Init2f(0,0),this._uOutlineThickness.Init1f(1);for(const e of n){const t=e[0],s=e[2],i=new Ec.Gfx.WebGLShaderUniform(this,t,s);"color"===s?i.Init3f(0,0,0):i.Init1f(0),this._uCustomParameters.push(i)}this._isDeviceTransform?this._UpdateDeviceTransformUniforms(r.currentMatP):(this.UpdateMatP(r.currentMatP,!0),this.UpdateMatMV(r.currentMV,!0));const a=r.currentShader;i.useProgram(a?a._shaderProgram:null)}Release(){this._gl.deleteProgram(this._shaderProgram),this._shaderProgram=null,this._renderer._RemoveShaderProgram(this),this._gl=null,super.Release()}GetWebGLContext(){return this._gl}GetShaderProgram(){return this._shaderProgram}GetParameterCount(){return this._uCustomParameters.length}GetParameterType(e){return e<0||e>=this._uCustomParameters.length?null:this._uCustomParameters[e].GetType()}AreCustomParametersAlreadySetInBatch(e){for(let t=0,s=e.length;t<s;++t)if(!this._uCustomParameters[t].IsSetToCustomInBatch(e[t]))return!1;return!0}SetCustomParametersInBatch(e){for(let t=0,s=e.length;t<s;++t)this._uCustomParameters[t].SetBatchValueCustom(e[t])}AreOptionalUniformsAlreadySetInBatch(e,t,s,i,r,n,a,o,h,l){return!(this._uSamplerBack.IsUsed()||this._uPixelSize.IsUsed()&&!this._uPixelSize.IsSetTo2InBatch(r,n)||this._uDestStart.IsUsed()&&!this._uDestStart.IsSetTo2InBatch(e.getLeft(),e.getTop())||this._uDestEnd.IsUsed()&&!this._uDestEnd.IsSetTo2InBatch(e.getRight(),e.getBottom())||this._uDevicePixelRatio.IsUsed()&&!this._uDevicePixelRatio.IsSetTo1InBatch(a)||this._uLayerScale.IsUsed()&&!this._uLayerScale.IsSetTo1InBatch(o)||this._uLayerAngle.IsUsed()&&!this._uLayerAngle.IsSetTo1InBatch(h)||this._uSrcStart.IsUsed()&&!this._uSrcStart.IsSetTo2InBatch(t.getLeft(),t.getTop())||this._uSrcEnd.IsUsed()&&!this._uSrcEnd.IsSetTo2InBatch(t.getRight(),t.getBottom())||this._uSrcOriginStart.IsUsed()&&!this._uSrcOriginStart.IsSetTo2InBatch(s.getLeft(),s.getTop())||this._uSrcOriginEnd.IsUsed()&&!this._uSrcOriginEnd.IsSetTo2InBatch(s.getRight(),s.getBottom())||this._uLayoutStart.IsUsed()&&!this._uLayoutStart.IsSetTo2InBatch(i.getLeft(),i.getTop())||this._uLayoutEnd.IsUsed()&&!this._uLayoutEnd.IsSetTo2InBatch(i.getTop(),i.getBottom())||this._uSeconds.IsUsed()&&!this._uSeconds.IsSetTo1InBatch(l))}SetOptionalUniformsInBatch(e,t,s,i,r,n,a,o,h,l){this._uSamplerBack.IsUsed()||(this._uPixelSize.IsUsed()&&this._uPixelSize.SetBatch2(r,n),this._uDestStart.IsUsed()&&this._uDestStart.SetBatch2(e.getLeft(),e.getTop()),this._uDestEnd.IsUsed()&&this._uDestEnd.SetBatch2(e.getRight(),e.getBottom()),this._uDevicePixelRatio.IsUsed()&&this._uDevicePixelRatio.SetBatch1(a),this._uLayerScale.IsUsed()&&this._uLayerScale.SetBatch1(o),this._uLayerAngle.IsUsed()&&this._uLayerAngle.SetBatch1(h),this._uSrcStart.IsUsed()&&this._uSrcStart.SetBatch2(t.getLeft(),t.getTop()),this._uSrcEnd.IsUsed()&&this._uSrcEnd.SetBatch2(t.getRight(),t.getBottom()),this._uSrcOriginStart.IsUsed()&&this._uSrcOriginStart.SetBatch2(s.getLeft(),s.getTop()),this._uSrcOriginEnd.IsUsed()&&this._uSrcOriginEnd.SetBatch2(s.getRight(),s.getBottom()),this._uLayoutStart.IsUsed()&&this._uLayoutStart.SetBatch2(i.getLeft(),i.getTop()),this._uLayoutEnd.IsUsed()&&this._uLayoutEnd.SetBatch2(i.getTop(),i.getBottom()),this._uSeconds.IsUsed()&&this._uSeconds.SetBatch1(l))}UpdateMatP(e,t){this._hasCurrentMatP&&!t||this._isDeviceTransform||(this._uMatP.IsUsed()&&this._uMatP.UpdateMatrix4fv(e),this._hasCurrentMatP=!0)}SetMatPStale(){this._hasCurrentMatP=!1}UpdateMatMV(e,t){this._hasCurrentMatMV&&!t||this._isDeviceTransform||(this._uMatMV.IsUsed()&&this._uMatMV.UpdateMatrix4fv(e),this._hasCurrentMatMV=!0)}SetMatMVStale(){this._hasCurrentMatMV=!1}_UpdateDeviceTransformUniforms(e){if(!this._isDeviceTransform)throw new Error("not device transform shader");this._uMatP.UpdateMatrix4fv(e);const t=this._renderer,s=t.GetWidth()/2,i=t.GetHeight()/2,r=t.CalculateLookAtModelView2(s,i,t.GetDefaultCameraZ(t.GetHeight()),s,i,0,t.GetHeight());this._uMatMV.UpdateMatrix4fv(r)}UpdateColor(e){this._uColor.IsUsed()&&this._uColor.Update4f(e[0],e[1],e[2],e[3])}static GetReservedUniformNames(){return kc}static _GetConservativeDepthShaderPrefix(e){return e?"\n#extension GL_EXT_conservative_depth : enable\nlayout (depth_greater) out highp float gl_FragDepth;\n\t":""}static GetDefaultVertexShaderSource(e){const t=e?"highp":"mediump";return["attribute highp vec3 aPos;",`attribute ${t} vec2 aTex;`,`varying ${t} vec2 vTex;`,"attribute lowp vec4 aColor;","varying lowp vec4 vColor;","uniform highp mat4 matP;","uniform highp mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPos, 1.0);","\tvTex = aTex;","\tvColor = aColor;","}"].join("\n")}static GetDefaultVertexShaderSource_WebGL2(e){const t=e?"highp":"mediump";return["#version 300 es","in highp vec3 aPos;",`in ${t} vec2 aTex;`,`out ${t} vec2 vTex;`,"in lowp vec4 aColor;","out lowp vec4 vColor;","uniform highp mat4 matP;","uniform highp mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPos, 1.0);","\tvTex = aTex;","\tvColor = aColor;","}"].join("\n")}static GetTextureFillFragmentShaderSource_WebGL1_NoFragDepth(){return["varying mediump vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","void main(void) {","\tgl_FragColor = texture2D(samplerFront, vTex) * vColor;","}"].join("\n")}static GetTextureFillFragmentShaderSource_WebGL1_FragDepthEXT(){return["#extension GL_EXT_frag_depth : enable","varying mediump vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","void main(void) {","\tgl_FragColor = texture2D(samplerFront, vTex) * vColor;","\tgl_FragDepthEXT = (gl_FragColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTextureFillFragmentShaderSource_WebGL2(e){return["#version 300 es",Ec.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(e),"in mediump vec2 vTex;","out lowp vec4 outColor;","in lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","void main(void) {","\toutColor = texture(samplerFront, vTex) * vColor;","\tgl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTilemapFragmentShaderSource_WebGL1_NoFragDepth(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","uniform highp vec2 srcStart;","uniform highp vec2 pixelSize;","uniform highp vec2 tileSize;","uniform highp vec2 tileSpacing;","void main(void) {","\thighp vec2 tile = floor(vTex);","\thighp vec2 tex = fract(vTex);","\thighp vec2 tileOrigin = srcStart + tile * (tileSize + tileSpacing);","\thighp vec2 lowerBound = tileOrigin + pixelSize / 2.0;","\thighp vec2 upperBound = tileOrigin + tileSize - pixelSize / 2.0;","\tgl_FragColor = texture2D(samplerFront, clamp(tex, lowerBound, upperBound), -16.0) * vColor;","}"].join("\n")}static GetTilemapFragmentShaderSource_WebGL1_FragDepthEXT(){return["#extension GL_EXT_frag_depth : enable","varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","uniform highp vec2 srcStart;","uniform highp vec2 pixelSize;","uniform highp vec2 tileSize;","uniform highp vec2 tileSpacing;","void main(void) {","\thighp vec2 tile = floor(vTex);","\thighp vec2 tex = fract(vTex);","\thighp vec2 tileOrigin = srcStart + tile * (tileSize + tileSpacing);","\thighp vec2 lowerBound = tileOrigin + pixelSize / 2.0;","\thighp vec2 upperBound = tileOrigin + tileSize - pixelSize / 2.0;","\tgl_FragColor = texture2D(samplerFront, clamp(tex, lowerBound, upperBound), -16.0) * vColor;","\tgl_FragDepthEXT = (gl_FragColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTilemapFragmentShaderSource_WebGL2(e){return["#version 300 es",Ec.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(e),"in highp vec2 vTex;","out lowp vec4 outColor;","in lowp vec4 vColor;","uniform lowp sampler2D samplerFront;","uniform highp vec2 srcStart;","uniform highp vec2 pixelSize;","uniform highp vec2 tileSize;","uniform highp vec2 tileSpacing;","void main(void) {","\thighp vec2 tile = floor(vTex);","\thighp vec2 tex = fract(vTex);","\thighp vec2 tileOrigin = srcStart + tile * (tileSize + tileSpacing);","\thighp vec2 lowerBound = tileOrigin + pixelSize / 2.0;","\thighp vec2 upperBound = tileOrigin + tileSize - pixelSize / 2.0;","\toutColor = texture(samplerFront, clamp(tex, lowerBound, upperBound), -16.0) * vColor;","\tgl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetTileRandomizationFragmentShaderSource(e,t,s,i){let r="";return e>=2?r="#version 300 es\n"+Ec.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(i):(t&&(r="#extension GL_EXT_frag_depth : enable\n"),s&&(r+="#extension GL_EXT_shader_texture_lod : enable\n",r+="#extension GL_OES_standard_derivatives : enable\n")),r+`\nprecision highp float;\n${e>=2?"in":"varying"} vec2 vTex;\n${e>=2?"out lowp vec4 outColor;":""}\n${e>=2?"in":"varying"} lowp vec4 vColor;\nuniform lowp sampler2D samplerFront;\nuniform vec2 pixelSize;\n\nuniform vec2 tileSize;\nuniform vec2 tileSpacing;\nuniform float outlineThickness;\n\nconst float PI = 3.1415926;\n\nlowp vec4 cospVec4(lowp vec4 a, lowp vec4 b, float x)\n{\n\treturn (a + b + (a - b) * cos(x * PI)) / 2.0;\n}\n\nvec3 randVec3(vec2 seed)\n{\n\treturn vec3(fract(sin(dot(seed.xy + vec2(0.1, 0.1), vec2(12.9898,78.233))) * 43758.5453),\n\t\t\t\tfract(sin(dot(seed.yx + vec2(0.1, 0.1), vec2(12.9898,-78.233))) * 43758.5453),\n\t\t\t\tfract(sin(dot(seed.xy + vec2(0.1, 0.1), vec2(-12.9898,-78.233))) * 43758.5453));\n}\n\nlowp vec4 sampleTile(vec2 tile, vec2 uv, vec2 ddx, vec2 ddy)\n{\n\tvec2 posRandom = tileSize;\n\tfloat angleRandom = outlineThickness;\n\t\n\tvec3 rand = (randVec3(floor(tile + 0.5)) - 0.5) * 2.0;\n\t\n\tfloat angle = angleRandom * rand.z * PI;\n\tfloat sin_a = sin(angle);\n\tfloat cos_a = cos(angle);\n\tfloat aspect = pixelSize.x / pixelSize.y;\n\n\tvec2 mid = tile + vec2(0.5, 0.5);\n\tvec2 dp = uv - mid;\n\tdp.x /= aspect;\n\tvec2 r = vec2(dp.x * cos_a - dp.y * sin_a,\n\t\t\t\t  dp.y * cos_a + dp.x * sin_a);\n\tr.x *= aspect;\n\n\tvec2 p = mid + r + (posRandom * rand.xy / 2.0);\n\t\n\t${e>=2?"return textureGrad(samplerFront, p, ddx, ddy);":""}\n\t${e<2&&s?"return texture2DGradEXT(samplerFront, p, ddx, ddy);":""}\n\t${e<2&&!s?"return texture2D(samplerFront, p);":""}\n}\n\nvoid main(void) {\n\t\n\t${e<2?"lowp vec4 outColor;":""}\n\t\n\tfloat blendMarginX = tileSpacing.x;\n\tfloat blendMarginY = tileSpacing.y;\n\t\n\tvec2 tile = floor(vTex);\n\tvec2 tex = fract(vTex);\n\tvec2 ddx = ${e>=2||s?"dFdx(vTex)":"vec2(0.0, 0.0)"};\n\tvec2 ddy = ${e>=2||s?"dFdy(vTex)":"vec2(0.0, 0.0)"};\n\t\n\tvec4 curTile = sampleTile(tile, vTex, ddx, ddy);\n\t\n\tbool inLeftMargin = (tex.x < blendMarginX);\n\tbool inRightMargin = (tex.x > 1.0 - blendMarginX);\n\tbool inTopMargin = (tex.y < blendMarginY);\n\tbool inBottomMargin = (tex.y > 1.0 - blendMarginY);\n\t\n\tif (inLeftMargin)\n\t{\n\t\tlowp vec4 leftTile = sampleTile(tile + vec2(-1.0, 0.0), vTex, ddx, ddy);\n\t\tfloat leftMix = (tex.x / (blendMarginX * 2.0)) + 0.5;\n\t\tlowp vec4 leftMixedTile = cospVec4(leftTile, curTile, leftMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tlowp vec4 topTile =     sampleTile(tile + vec2(0.0,  -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topLeftTile = sampleTile(tile + vec2(-1.0, -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topLeftMixedTile = cospVec4(topLeftTile, topTile, leftMix);\n\t\t\t\n\t\t\toutColor = cospVec4(topLeftMixedTile, leftMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tlowp vec4 bottomTile =     sampleTile(tile + vec2(0.0,  1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomLeftTile = sampleTile(tile + vec2(-1.0, 1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomLeftMixedTile = cospVec4(bottomLeftTile, bottomTile, leftMix);\n\t\t\t\n\t\t\toutColor = cospVec4(leftMixedTile, bottomLeftMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutColor = leftMixedTile;\n\t\t}\n\t}\n\telse if (inRightMargin)\n\t{\n\t\tlowp vec4 rightTile = sampleTile(tile + vec2(1.0, 0.0), vTex, ddx, ddy);\n\t\tfloat rightMix = (tex.x - (1.0 - blendMarginX)) / (blendMarginX * 2.0);\n\t\tlowp vec4 rightMixedTile = cospVec4(curTile, rightTile, rightMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tlowp vec4 topTile =      sampleTile(tile + vec2(0.0, -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topRightTile = sampleTile(tile + vec2(1.0, -1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 topRightMixedTile = cospVec4(topTile, topRightTile, rightMix);\n\t\t\t\n\t\t\toutColor = cospVec4(topRightMixedTile, rightMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tlowp vec4 bottomTile =      sampleTile(tile + vec2(0.0, 1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomRightTile = sampleTile(tile + vec2(1.0, 1.0), vTex, ddx, ddy);\n\t\t\tlowp vec4 bottomRightMixedTile = cospVec4(bottomTile, bottomRightTile, rightMix);\n\t\t\t\n\t\t\toutColor = cospVec4(rightMixedTile, bottomRightMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutColor = rightMixedTile;\n\t\t}\n\t}\n\telse if (inTopMargin)\n\t{\n\t\tlowp vec4 topTile = sampleTile(tile + vec2(0.0, -1.0), vTex, ddx, ddy);\n\t\toutColor = cospVec4(topTile, curTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t}\n\telse if (inBottomMargin)\n\t{\n\t\tlowp vec4 bottomTile = sampleTile(tile + vec2(0.0, 1.0), vTex, ddx, ddy);\n\t\toutColor = cospVec4(curTile, bottomTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t}\n\telse\n\t{\n\t\toutColor = curTile;\n\t}\n\t\n\toutColor *= vColor;\n\t${e<2?"gl_FragColor = outColor;":""}\n\t${e>=2?"gl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);":""}\n\t${e<2&&t?"gl_FragDepthEXT = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);":""}\n}\n`}static GetPointVertexShaderSource_WebGL1(){return["attribute vec4 aPoints;","varying float pointOpacity;","uniform float zElevation;","uniform mat4 matP;","uniform mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPoints.xy, zElevation, 1.0);","\tgl_PointSize = aPoints.z;","\tpointOpacity = aPoints.w;","}"].join("\n")}static GetPointVertexShaderSource_WebGL2(){return["#version 300 es","in vec4 aPoints;","out float pointOpacity;","uniform float zElevation;","uniform mat4 matP;","uniform mat4 matMV;","void main(void) {","\tgl_Position = matP * matMV * vec4(aPoints.xy, zElevation, 1.0);","\tgl_PointSize = aPoints.z;","\tpointOpacity = aPoints.w;","}"].join("\n")}static GetPointFragmentShaderSource_WebGL1_NoFragDepth(){return["uniform lowp sampler2D samplerFront;","varying lowp float pointOpacity;","uniform mediump vec2 pointTexStart;","uniform mediump vec2 pointTexEnd;","uniform lowp vec4 color;","void main(void) {","\tmediump vec2 pointTexMin = min(pointTexStart, pointTexEnd);","\tmediump vec2 pointTexMax = max(pointTexStart, pointTexEnd);","\tmediump vec2 pointCoord = (pointTexEnd.x > pointTexStart.x ? gl_PointCoord : vec2(1.0 - gl_PointCoord.y, gl_PointCoord.x));","\tgl_FragColor = texture2D(samplerFront, mix(pointTexMin, pointTexMax, pointCoord)) * color * pointOpacity;","}"].join("\n")}static GetPointFragmentShaderSource_WebGL1_FragDepthEXT(){return["#extension GL_EXT_frag_depth : enable","uniform lowp sampler2D samplerFront;","varying lowp float pointOpacity;","uniform mediump vec2 pointTexStart;","uniform mediump vec2 pointTexEnd;","uniform lowp vec4 color;","void main(void) {","\tmediump vec2 pointTexMin = min(pointTexStart, pointTexEnd);","\tmediump vec2 pointTexMax = max(pointTexStart, pointTexEnd);","\tmediump vec2 pointCoord = (pointTexEnd.x > pointTexStart.x ? gl_PointCoord : vec2(1.0 - gl_PointCoord.y, gl_PointCoord.x));","\tgl_FragColor = texture2D(samplerFront, mix(pointTexMin, pointTexMax, pointCoord)) * color * pointOpacity;","\tgl_FragDepthEXT = (gl_FragColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetPointFragmentShaderSource_WebGL2(e){return["#version 300 es",Ec.Gfx.WebGLShaderProgram._GetConservativeDepthShaderPrefix(e),"uniform lowp sampler2D samplerFront;","in lowp float pointOpacity;","uniform mediump vec2 pointTexStart;","uniform mediump vec2 pointTexEnd;","uniform lowp vec4 color;","out lowp vec4 outColor;","void main(void) {","\tmediump vec2 pointTexMin = min(pointTexStart, pointTexEnd);","\tmediump vec2 pointTexMax = max(pointTexStart, pointTexEnd);","\tmediump vec2 pointCoord = (pointTexEnd.x > pointTexStart.x ? gl_PointCoord : vec2(1.0 - gl_PointCoord.y, gl_PointCoord.x));","\toutColor = texture(samplerFront, mix(pointTexMin, pointTexMax, pointCoord)) * color * pointOpacity;","\tgl_FragDepth = (outColor.a == 0.0 ? 1.0 : gl_FragCoord.z);","}"].join("\n")}static GetColorFillFragmentShaderSource(){return["varying lowp vec4 vColor;","void main(void) {","\tgl_FragColor = vColor;","}"].join("\n")}static GetLinearGradientFillFragmentShaderSource(){return["precision lowp float;","varying mediump vec2 vTex;","varying vec4 vColor;","uniform vec4 color2_;","vec3 fromLinear(vec3 linearRGB)","{","\tbvec3 cutoff = lessThan(linearRGB, vec3(0.0031308));","\tvec3 higher = vec3(1.055) * pow(abs(linearRGB), vec3(1.0/2.4)) - vec3(0.055);","\tvec3 lower = linearRGB * vec3(12.92);","\treturn mix(higher, lower, vec3(cutoff));","}","vec3 toLinear(vec3 sRGB)","{","\tbvec3 cutoff = lessThan(sRGB, vec3(0.04045));","\tvec3 higher = pow(abs((sRGB + vec3(0.055))/vec3(1.055)), vec3(2.4));","\tvec3 lower = sRGB/vec3(12.92);","\treturn mix(higher, lower, vec3(cutoff));","}","void main(void) {","\tvec3 linearGrad = mix(toLinear(vColor.rgb), toLinear(color2_.rgb), vTex.x);","\tfloat a = mix(vColor.a, color2_.a, vTex.x);","\tgl_FragColor = vec4(fromLinear(linearGrad) * a, a);","}"].join("\n")}static GetPenumbraFillFragmentShaderSource(){return["precision lowp float;","varying highp vec2 vTex;","varying vec4 vColor;","void main(void) {","\thighp float grad = vTex.x / (1.0 - vTex.y);","\tgl_FragColor = vColor * (1.0 - (cos(grad * 3.141592653589793) + 1.0) / 2.0);","}"].join("\n")}static GetSmoothLineFillFragmentShaderSource(){return["varying mediump vec2 vTex;","varying lowp vec4 vColor;","void main(void) {","\tlowp float f = 1.0 - abs(vTex.y - 0.5) * 2.0;","\tgl_FragColor = vColor * f;","}"].join("\n")}static GetHardEllipseFillFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp float f = step(diffSq.x + diffSq.y, 0.25);","\tgl_FragColor = vColor * f;","}"].join("\n")}static GetHardEllipseOutlineFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform highp vec2 pixelSize;","uniform highp float outlineThickness;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp float distSq = diffSq.x + diffSq.y;","\thighp vec2 norm = normalize(diff);","\thighp vec2 halfNorm = norm * 0.5;","\thighp float innerF = step(distSq, 0.25);","\thighp vec2 innerEdge = halfNorm - pixelSize * norm * outlineThickness;","\thighp vec2 innerEdgeSq = innerEdge * innerEdge;","\thighp float outerF = step(innerEdgeSq.x + innerEdgeSq.y, distSq);","\tgl_FragColor = vColor * innerF * outerF;","}"].join("\n")}static GetSmoothEllipseFillFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform highp vec2 pixelSize;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp vec2 norm = normalize(diff);","\thighp vec2 halfNorm = norm * 0.5;","\thighp vec2 halfNormSq = halfNorm * halfNorm;","\thighp vec2 innerEdge = halfNorm - pixelSize * norm;","\thighp vec2 innerEdgeSq = innerEdge * innerEdge;","\thighp float f = smoothstep(halfNormSq.x + halfNormSq.y, innerEdgeSq.x + innerEdgeSq.y, diffSq.x + diffSq.y);","\tgl_FragColor = vColor * f;","}"].join("\n")}static GetSmoothEllipseOutlineFragmentShaderSource(){return["varying highp vec2 vTex;","varying lowp vec4 vColor;","uniform highp vec2 pixelSize;","uniform highp float outlineThickness;","void main(void) {","\thighp vec2 diff = vTex - vec2(0.5, 0.5);","\thighp vec2 diffSq = diff * diff;","\thighp float distSq = diffSq.x + diffSq.y;","\thighp vec2 norm = normalize(diff);","\thighp vec2 halfNorm = norm * 0.5;","\thighp vec2 halfNormSq = halfNorm * halfNorm;","\thighp vec2 pxNorm = pixelSize * norm;","\thighp vec2 innerEdge1 = halfNorm - pxNorm;","\thighp vec2 innerEdge1Sq = innerEdge1 * innerEdge1;","\thighp float innerF = smoothstep(halfNormSq.x + halfNormSq.y, innerEdge1Sq.x + innerEdge1Sq.y, distSq);","\thighp vec2 innerEdge2 = halfNorm - pxNorm * outlineThickness;","\thighp vec2 innerEdge2Sq = innerEdge2 * innerEdge2;","\thighp vec2 innerEdge3 = halfNorm - pxNorm * (outlineThickness + 1.0);","\thighp vec2 innerEdge3Sq = innerEdge3 * innerEdge3;","\thighp float outerF = smoothstep(innerEdge3Sq.x + innerEdge3Sq.y, innerEdge2Sq.x + innerEdge2Sq.y, distSq);","\tgl_FragColor = vColor * innerF * outerF;","}"].join("\n")}}}{const Lc=self.C3,Nc=self.glMatrix,Wc=Nc.mat4,Uc=new Map([["float",1],["percent",1],["sampler",1],["vec2",2],["vec3",3],["color",3],["vec4",4],["mat4",16]]);Lc.Gfx.WebGLShaderUniform=class{constructor(e,t,s){if(!Uc.has(s))throw new Error("invalid uniform type");this._owner=e,this._gl=this._owner.GetWebGLContext(),this._name=t,this._type=s,this._isColorType="color"===this._type,this._location=this._gl.getUniformLocation(this._owner.GetShaderProgram(),t),this._isUsed=!!this._location;const i=Uc.get(s);this._lastValue=new Float32Array(i),this._lastBatchValue=new Float32Array(i)}Release(){this._owner=null,this._gl=null,this._location=null}IsUsed(){return this._isUsed}GetType(){return this._type}IsColorType(){return this._isColorType}Init1f(e){this.IsUsed()&&(this._lastValue[0]=e,this._lastBatchValue.set(this._lastValue),this._gl.uniform1f(this._location,e))}Init1i(e){this.IsUsed()&&(this._lastValue[0]=e,this._lastBatchValue.set(this._lastValue),this._gl.uniform1i(this._location,e))}Init2f(e,t){this.IsUsed()&&(this._lastValue[0]=e,this._lastValue[1]=t,this._lastBatchValue.set(this._lastValue),this._gl.uniform2f(this._location,e,t))}Init3f(e,t,s){this.IsUsed()&&(this._lastValue[0]=e,this._lastValue[1]=t,this._lastValue[2]=s,this._lastBatchValue.set(this._lastValue),this._gl.uniform3f(this._location,e,t,s))}Init4f(e,t,s,i){this.IsUsed()&&(this._lastValue[0]=e,this._lastValue[1]=t,this._lastValue[2]=s,this._lastValue[3]=i,this._lastBatchValue.set(this._lastValue),this._gl.uniform4f(this._location,e,t,s,i))}Update1f(e){e=Math.fround(e);const t=this._lastValue;t[0]!==e&&(t[0]=e,this._gl.uniform1f(this._location,e))}Update1i(e){const t=this._lastValue;t[0]!==e&&(t[0]=e,this._gl.uniform1i(this._location,e))}Update2f(e,t){e=Math.fround(e),t=Math.fround(t);const s=this._lastValue;s[0]===e&&s[1]===t||(s[0]=e,s[1]=t,this._gl.uniform2f(this._location,e,t))}Update3f(e,t,s){e=Math.fround(e),t=Math.fround(t),s=Math.fround(s);const i=this._lastValue;i[0]===e&&i[1]===t&&i[2]===s||(i[0]=e,i[1]=t,i[2]=s,this._gl.uniform3f(this._location,e,t,s))}Update4f(e,t,s,i){e=Math.fround(e),t=Math.fround(t),s=Math.fround(s),i=Math.fround(i);const r=this._lastValue;r[0]===e&&r[1]===t&&r[2]===s&&r[3]===i||(r[0]=e,r[1]=t,r[2]=s,r[3]=i,this._gl.uniform4f(this._location,e,t,s,i))}UpdateMatrix4fv(e){const t=this._lastValue;Wc.exactEquals(t,e)||(Lc.typedArraySet16(t,e,0),this._gl.uniformMatrix4fv(this._location,!1,e))}IsSetToCustomInBatch(e){const t=this._lastBatchValue;return this.IsColorType()?t[0]===Math.fround(e.getR())&&t[1]===Math.fround(e.getG())&&t[2]===Math.fround(e.getB()):t[0]===Math.fround(e)}SetBatchValueCustom(e){const t=this._lastBatchValue;this.IsColorType()?(t[0]=e.getR(),t[1]=e.getG(),t[2]=e.getB()):t[0]=e}IsSetTo1InBatch(e){return this._lastBatchValue[0]===Math.fround(e)}IsSetTo2InBatch(e,t){const s=this._lastBatchValue;return s[0]===Math.fround(e)&&s[1]===Math.fround(t)}SetBatch1(e){this._lastBatchValue[0]=e}SetBatch2(e,t){const s=this._lastBatchValue;s[0]=e,s[1]=t}}}{const Vc=self.C3,Hc=self.glMatrix,jc=Hc.vec4,zc=Hc.mat4,Xc=0,Yc=1,qc=2,Kc=3,$c=4,Jc=5,Zc=6,Qc=7,eu=8,tu=9,su=10,iu=11,ru=12,nu=13,au=14,ou=15,hu=16,lu=17,cu=18,uu=19,du=20,_u=21,pu=22,fu=23,mu=24,gu=25,Su=26,Gu=27,yu=28,Iu=29,Tu=30,Cu=31;Vc.Gfx.BatchState=class{constructor(e){this.renderer=e,this.currentMV=zc.create(),this.currentMatP=zc.create(),this.currentFramebuffer=null,this.currentFramebufferNoDepth=null,this.isDepthSamplingEnabled=!1,this.currentShader=null,this.currentMeshData=e._GetCurrentMeshData(),this.pointTexCoords=new Vc.Rect,this.clearColor=Vc.New(Vc.Color,0,0,0,0)}},Vc.Gfx.WebGLBatchJob=class{constructor(e){const t=new ArrayBuffer(96);this._type=0,this._batchState=e,this._gl=e.renderer.GetContext(),this._startIndex=0,this._indexCount=0,this._texParam=null,this._mat4param=new Float32Array(t,0,16),this._colorParam=new Float32Array(t,64,4),this._srcOriginRect=new Float32Array(t,80,4),this._shaderParams=[]}InitDraw(e,t){this._type=1,this._startIndex=e,this._indexCount=t}DoDraw(){const e=this._gl,t=this._batchState.currentMeshData;e.drawElements(e.TRIANGLES,this._indexCount,t.IsIndexTypeUint16()?e.UNSIGNED_SHORT:e.UNSIGNED_INT,this._startIndex)}InitSetTexture(e){this._type=2,this._texParam=e}DoSetTexture(){const e=this._gl,t=this._texParam;e.bindTexture(e.TEXTURE_2D,t?t._GetTexture():null)}InitSetGradientColor(e){this._type=20,e.writeToTypedArray(this._colorParam,0)}DoSetGradientColor(){const e=this._colorParam,t=this._batchState.currentShader;t._uColor2.IsUsed()&&t._uColor2.Update4f(e[0],e[1],e[2],e[3])}InitSetBlend(e){this._type=3;const t=this._mat4param;t[0]=e.length;for(let s=0,i=e.length;s<i;++s)t[s+1]=e[s]}DoSetBlend(){const e=this._gl,t=this._mat4param,s=t[0],i=t[1],r=t[2];let n=i,a=r,o=e.FUNC_ADD,h=e.FUNC_ADD;s>=4&&(n=t[3],a=t[4]),6===s&&(o=t[5],h=t[6]),e.blendFuncSeparate(i,r,n,a),e.blendEquationSeparate(o,h)}InitSetViewport(e,t,s,i){this._type=4;const r=this._colorParam;r[0]=e,r[1]=t,r[2]=s,r[3]=i}DoSetViewport(){const e=this._colorParam;this._gl.viewport(e[0],e[1],e[2],e[3])}InitSetProjection(e){this._type=5,zc.copy(this._mat4param,e)}DoSetProjection(){const e=this._batchState,t=e.renderer._allShaderPrograms,s=e.currentShader,i=this._mat4param;for(let e=0,r=t.length;e<r;++e){const r=t[e];r===s?r.UpdateMatP(i,!0):r.SetMatPStale()}zc.copy(e.currentMatP,i)}InitSetModelView(e){this._type=6,zc.copy(this._mat4param,e)}DoSetModelView(){const e=this._batchState,t=e.renderer._allShaderPrograms,s=e.currentShader,i=this._mat4param;for(let e=0,r=t.length;e<r;++e){const r=t[e];r===s?r.UpdateMatMV(i,!0):r.SetMatMVStale()}zc.copy(e.currentMV,i)}InitSetRenderTarget(e){this._type=7,this._texParam=e}DoSetRenderTarget(){const e=this._gl,t=this._texParam,s=this._batchState;t?(s.currentFramebuffer=t._GetFramebuffer(),s.currentFramebufferNoDepth=t._GetFramebufferNoDepth(),s.isDepthSamplingEnabled&&s.currentFramebufferNoDepth?e.bindFramebuffer(e.FRAMEBUFFER,s.currentFramebufferNoDepth):e.bindFramebuffer(e.FRAMEBUFFER,s.currentFramebuffer)):(s.currentFramebuffer=null,s.currentFramebufferNoDepth=null,e.bindFramebuffer(e.FRAMEBUFFER,null))}InitClearSurface(e){this._type=8,e.writeToTypedArray(this._mat4param,0)}InitClearSurface2(e,t,s,i){this._type=8;const r=this._mat4param;r[0]=e,r[1]=t,r[2]=s,r[3]=i}DoClearSurface(){const e=this._gl,t=this._mat4param,s=this._batchState.clearColor,i=t[0],r=t[1],n=t[2],a=t[3];s.equalsRgba(i,r,n,a)||(e.clearColor(i,r,n,a),s.setRgba(i,r,n,a)),e.clear(e.COLOR_BUFFER_BIT)}InitSetPointTexCoords(e){this._type=14,e.writeToTypedArray(this._mat4param,0)}DoSetPointTextureCoords(){const e=this._mat4param;this._batchState.pointTexCoords.set(e[0],e[1],e[2],e[3])}InitPoints(e,t,s){this._type=9,this._startIndex=e,this._indexCount=1,this._mat4param[0]=t,s.writeToTypedArray(this._colorParam,0)}DoPoints(){const e=this._gl,t=this._batchState,s=t.renderer,i=s._spPoints;e.useProgram(i._shaderProgram),s._BindVAO(null),i.UpdateMatP(t.currentMatP,!1),i.UpdateMatMV(t.currentMV,!1);const r=t.pointTexCoords;i._uPointTexStart.IsUsed()&&i._uPointTexStart.Update2f(r.getLeft(),r.getTop()),i._uPointTexEnd.IsUsed()&&i._uPointTexEnd.Update2f(r.getRight(),r.getBottom());const n=this._mat4param[0];if(i._uZElevation.IsUsed()&&i._uZElevation.Update1f(n),i._uColor.IsUsed()){const e=this._colorParam;i._uColor.Update4f(e[0],e[1],e[2],e[3])}e.drawArrays(e.POINTS,this._startIndex/4,this._indexCount),e.useProgram(t.currentShader._shaderProgram),s._BindVAO(t.currentMeshData._GetVAO())}InitSetProgram(e){this._type=10,this._texParam=e}DoSetProgram(){const e=this._gl,t=this._batchState,s=this._texParam;t.currentShader=s,e.useProgram(s._shaderProgram),s.UpdateMatP(t.currentMatP,!1),s.UpdateMatMV(t.currentMV,!1)}InitSetProgramParameters(){this._type=11}DoSetProgramParameters(){const e=this._batchState.currentShader,t=this._gl,s=this._mat4param,i=this._colorParam,r=this._srcOriginRect;if(e._uSamplerBack.IsUsed()){const e=this._batchState.renderer,s=this._texParam;e._lastTexture1!==s&&(t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,s?s._GetTexture():null),e._lastTexture1=s,t.activeTexture(t.TEXTURE0))}e._uPixelSize.IsUsed()&&e._uPixelSize.Update2f(s[0],s[1]),e._uDestStart.IsUsed()&&e._uDestStart.Update2f(s[2],s[3]),e._uDestEnd.IsUsed()&&e._uDestEnd.Update2f(s[4],s[5]),e._uDevicePixelRatio.IsUsed()&&e._uDevicePixelRatio.Update1f(this._indexCount),e._uLayerScale.IsUsed()&&e._uLayerScale.Update1f(s[6]),e._uLayerAngle.IsUsed()&&e._uLayerAngle.Update1f(s[7]),e._uSrcStart.IsUsed()&&e._uSrcStart.Update2f(s[12],s[13]),e._uSrcEnd.IsUsed()&&e._uSrcEnd.Update2f(s[14],s[15]),e._uSrcOriginStart.IsUsed()&&e._uSrcOriginStart.Update2f(r[0],r[1]),e._uSrcOriginEnd.IsUsed()&&e._uSrcOriginEnd.Update2f(r[2],r[3]),e._uLayoutStart.IsUsed()&&e._uLayoutStart.Update2f(i[0],i[1]),e._uLayoutEnd.IsUsed()&&e._uLayoutEnd.Update2f(i[2],i[3]),e._uSeconds.IsUsed()&&e._uSeconds.Update1f(this._startIndex)}InitSetProgramCustomParameters(){this._type=12}DoSetProgramCustomParameters(){const e=this._batchState.currentShader._uCustomParameters,t=this._shaderParams;for(let s=0,i=e.length;s<i;++s){const i=e[s],r=t[s];i.IsColorType()?i.Update3f(r.getR(),r.getG(),r.getB()):i.Update1f(r)}}InitInvalidateFramebuffer(e){this._type=13,this._texParam=e}DoInvalidateFramebuffer(){const e=this._gl,t=this._texParam,s=this._batchState.currentFramebuffer;t!==s&&e.bindFramebuffer(e.FRAMEBUFFER,t),e.invalidateFramebuffer(e.FRAMEBUFFER,[e.COLOR_ATTACHMENT0]),t!==s&&e.bindFramebuffer(e.FRAMEBUFFER,s)}InitBlitFramebuffer(e,t,s){this._type=16;const i=this._mat4param,r=this._batchState.renderer;i[0]=e.GetWidth(),i[1]=e.GetHeight(),i[2]=t?t.GetWidth():r.GetWidth(),i[3]=t?t.GetHeight():r.GetHeight(),i[4]=e.IsLinearSampling()?1:0,i[5]="stretch"===s;const n=this._shaderParams;Vc.clearArray(n),n.push(e._GetFramebuffer()),n.push(t?t._GetFramebuffer():null)}DoBlitFramebuffer(){const e=this._mat4param,t=this._shaderParams,s=this._gl,i=e[0],r=e[1],n=e[2],a=e[3],o=0!==e[4],h=0!==e[5],l=t[0],c=t[1];if(s.bindFramebuffer(s.READ_FRAMEBUFFER,l),s.bindFramebuffer(s.DRAW_FRAMEBUFFER,c),h)s.blitFramebuffer(0,0,i,r,0,0,n,a,s.COLOR_BUFFER_BIT,o?s.LINEAR:s.NEAREST);else{const e=Math.min(i,n),t=Math.min(r,a),o=Math.max(r-a,0),h=Math.max(a-r,0);s.blitFramebuffer(0,o,e,t+o,0,h,e,t+h,s.COLOR_BUFFER_BIT,s.NEAREST)}}InitStartQuery(e){this._type=17,this._texParam=e}DoStartQuery(){this._texParam.BeginTimeElapsed(),this._texParam=null}InitEndQuery(e){this._type=18,this._texParam=e}DoEndQuery(){this._texParam.EndTimeElapsed(),this._texParam=null}InitSetEllipseParams(e,t,s){this._type=19;const i=this._mat4param;i[0]=e,i[1]=t,i[2]=s}DoSetEllipseParams(){const e=this._batchState.currentShader,t=this._mat4param;e._uPixelSize.IsUsed()&&e._uPixelSize.Update2f(t[0],t[1]),e._uOutlineThickness.IsUsed()&&e._uOutlineThickness.Update1f(t[2])}InitSetTilemapInfo(e,t,s,i,r,n,a){this._type=15;const o=this._mat4param;e.writeToTypedArray(o,0),o[4]=1/t,o[5]=1/s,o[6]=i/t,o[7]=r/s,o[8]=n/t,o[9]=a/s}DoSetTilemapInfo(){const e=this._batchState.currentShader,t=this._mat4param;e._uSrcStart.IsUsed()&&e._uSrcStart.Update2f(t[0],t[1]),e._uPixelSize.IsUsed()&&e._uPixelSize.Update2f(t[4],t[5]),e._uTileSize.IsUsed()&&e._uTileSize.Update2f(t[6],t[7]),e._uTileSpacing.IsUsed()&&e._uTileSpacing.Update2f(t[8],t[9])}InitSetTileRandomizationInfo(e,t,s,i,r,n,a){this._type=28;const o=this._mat4param;o[0]=1/e,o[1]=1/t,o[2]=s,o[3]=i,o[4]=r,o[5]=n,o[6]=a}DoSetTileRandomizationInfo(){const e=this._batchState.currentShader,t=this._mat4param;e._uPixelSize.IsUsed()&&e._uPixelSize.Update2f(t[0],t[1]),e._uTileSize.IsUsed()&&e._uTileSize.Update2f(t[2],t[3]),e._uOutlineThickness.IsUsed()&&e._uOutlineThickness.Update1f(t[4]),e._uTileSpacing.IsUsed()&&e._uTileSpacing.Update2f(t[5],t[6])}InitClearDepth(e){this._type=21,this._startIndex=e?1:0}DoClearDepth(){const e=this._gl,t=0!==this._startIndex;t||e.depthMask(!0),e.clear(e.DEPTH_BUFFER_BIT),t||e.depthMask(!1)}InitSetDepthEnabled(e){this._type=22,this._startIndex=e?1:0}DoSetDepthEnabled(){const e=this._gl;0===this._startIndex?(e.disable(e.DEPTH_TEST),e.depthMask(!1)):(e.enable(e.DEPTH_TEST),e.depthMask(!0))}InitSetDepthSamplingEnabled(e){this._type=23,this._startIndex=e?1:0}DoSetDepthSamplingEnabled(){const e=this._gl,t=this._batchState,s=t.renderer,i=0!==this._startIndex;t.isDepthSamplingEnabled=i,e.activeTexture(e.TEXTURE2),i?(t.currentFramebufferNoDepth&&e.bindFramebuffer(e.FRAMEBUFFER,t.currentFramebufferNoDepth),e.bindTexture(e.TEXTURE_2D,s._GetDepthBuffer())):(e.bindTexture(e.TEXTURE_2D,null),t.currentFramebufferNoDepth&&e.bindFramebuffer(e.FRAMEBUFFER,t.currentFramebuffer)),e.activeTexture(e.TEXTURE0)}InitCoplanarStartStencilPass(){this._type=24}DoCoplanarStartStencilPass(){const e=this._gl;e.clear(e.STENCIL_BUFFER_BIT),e.enable(e.STENCIL_TEST),e.stencilFunc(e.ALWAYS,1,1),e.stencilOp(e.KEEP,e.KEEP,e.REPLACE),e.colorMask(!1,!1,!1,!1)}InitCoplanarStartColorPass(){this._type=25}DoCoplanarStartColorPass(){const e=this._gl;e.enable(e.STENCIL_TEST),e.colorMask(!0,!0,!0,!0),e.stencilFunc(e.EQUAL,1,1),e.stencilOp(e.KEEP,e.KEEP,e.KEEP)}InitCoplanarRestore(){this._type=26}DoCoplanarRestore(){const e=this._gl;e.disable(e.STENCIL_TEST)}InitSetScissor(e,t,s,i,r){this._type=27,this._startIndex=e?1:0;const n=this._mat4param;n[0]=t,n[1]=s,n[2]=i,n[3]=r}DoSetScissor(){const e=this._gl,t=this._mat4param;1===this._startIndex?(e.enable(e.SCISSOR_TEST),e.scissor(t[0],t[1],t[2],t[3])):e.disable(e.SCISSOR_TEST)}InitSetCullFaceMode(e){this._type=29,this._startIndex=e}DoSetCullFaceMode(){const e=this._gl,t=this._startIndex;0===t?e.disable(e.CULL_FACE):(e.enable(e.CULL_FACE),1===t?e.cullFace(e.BACK):e.cullFace(e.FRONT))}InitSetFrontFaceWinding(e){this._type=30,this._startIndex=e}DoSetFrontFaceWinding(){const e=this._gl;e.frontFace(0===this._startIndex?e.CW:e.CCW)}InitSetCurrentMeshData(e){this._type=31,this._texParam=e}DoSetCurrentMeshData(){const e=this._batchState,t=e.renderer,s=this._texParam;t._BindVAO(s._GetVAO()),e.currentMeshData=s}Run(){switch(this._type){case 1:return void this.DoDraw();case 2:return void this.DoSetTexture();case 3:return void this.DoSetBlend();case 4:return void this.DoSetViewport();case 5:return void this.DoSetProjection();case 6:return void this.DoSetModelView();case 7:return void this.DoSetRenderTarget();case 8:return void this.DoClearSurface();case 9:return void this.DoPoints();case 10:return void this.DoSetProgram();case 11:return void this.DoSetProgramParameters();case 12:return void this.DoSetProgramCustomParameters();case 13:return void this.DoInvalidateFramebuffer();case 14:return void this.DoSetPointTextureCoords();case 15:return void this.DoSetTilemapInfo();case 16:return void this.DoBlitFramebuffer();case 17:return void this.DoStartQuery();case 18:return void this.DoEndQuery();case 19:return void this.DoSetEllipseParams();case 20:return void this.DoSetGradientColor();case 21:return void this.DoClearDepth();case 22:return void this.DoSetDepthEnabled();case 23:return void this.DoSetDepthSamplingEnabled();case 24:return void this.DoCoplanarStartStencilPass();case 25:return void this.DoCoplanarStartColorPass();case 26:return void this.DoCoplanarRestore();case 27:return void this.DoSetScissor();case 28:return void this.DoSetTileRandomizationInfo();case 29:return void this.DoSetCullFaceMode();case 30:return void this.DoSetFrontFaceWinding();case 31:return void this.DoSetCurrentMeshData()}}}}{let bu=function(e,t,s,i,r,n){t?e.strokeRect(s,i,r,n):e.fillRect(s,i,r,n)},xu=function(e){return e*(4/3)},wu=function(e,t){e=e.trim();const s=parseFloat(e);return isFinite(s)?e.endsWith("%")?t*s/100:s:0};fillOrStrokeRect=bu,ptToPx=xu,getOffsetParam=wu;const Pu=self.C3,Ru=4096,vu=4,Au=new Set(["serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]),Mu={timeout:60},Du=new Pu.Color(0,0,0,1),Eu=new Set(["left","center","right"]),Fu=new Set(["top","center","bottom"]),Ou=new Set(["word","cjk","character"]),Bu=new Set(["ltr","rtl"]),ku=1e3,Lu=10,Nu=2,Wu=new Set;Pu.FontManager&&Pu.FontManager.addEventListener("fontload",e=>{const t=e.font.GetName();for(const e of Wu)(e.IsBBCodeEnabled()||Pu.equalsNoCase(e.GetFontName(),t))&&(e._SetWordWrapChanged(),e._ClearMeasurementCache())});let Uu=!1,Vu=!1;Pu.Gfx.RendererText=class{constructor(e,t){t=Object.assign({},Mu,t),this._renderer=e,this._fontName="Arial",this._fontSize=16,this._fontSizeScale=1,this._lineHeight=0,this._isBold=!1,this._isItalic=!1,this._colorStr="black",this._isBBcodeEnabled=!1,this._iconSet=null,this._iconSmoothing=!0,this.onloadfont=null,this._alreadyLoadedFonts=new Set,this._horizontalAlign="left",this._verticalAlign="top",this._text="",this._bbString=null,this._wrappedText=Pu.New(Pu.WordWrap),this._wrapMode="word",this._textDirection="ltr",this._wordWrapChanged=!1,this._textLayoutChanged=!1,this._drawChanged=!1,this._canvasContentChanged=!1,this._forceRecreateTexture=!1,this._drawMaxCharCount=-1,this._drawCharCount=0,this._cssWidth=0,this._cssHeight=0,this._width=0,this._height=0,this._zoom=1,this._textCanvas=null,this._textContext=null,this._measureContext=null,this._measureContextTop=null,this._lastCanvasWidth=-1,this._lastCanvasHeight=-1,this._lastTextCanvasFont="",this._lastMeasureCanvasFont="",this._lastTextCanvasFillStyle="",this._lastTextCanvasOpacity=1,this._lastTextCanvasLineWidth=1,this._measureTextCallback=e=>this._MeasureText(e),this._measurementCache=new Map,this._measurementCacheIdleTimeout=new Pu.IdleTimeout(()=>this._ClearMeasurementCache(!0),2),this._texture=null,this._enableMipMap=!0,this._rcTex=new Pu.Rect,this._scaleFactor=1,this._textureTimeout=new Pu.IdleTimeout(()=>{this.ReleaseTexture(),this._SetTextCanvasSize(8,8),this._SetDrawChanged()},t.timeout),this.ontextureupdate=null,this._wasReleased=!1,Wu.add(this)}Release(){this.onloadfont=null,this._alreadyLoadedFonts.clear(),this._iconSet=null,this._bbString=null,this._textCanvas=null,this._textContext=null,this._measureContext=null,this._measureContextTop=null,this._measureTextCallback=null,this._ClearMeasurementCache(),this._measurementCacheIdleTimeout.Release(),this._textureTimeout.Release(),this.ontextureupdate=null,this.ReleaseTexture(),this._wrappedText.Clear(),this._wrappedText=null,this._renderer=null,this._wasReleased=!0,Wu.delete(this)}_SetDrawChanged(){this._drawChanged=!0}_SetTextLayoutChanged(){this._SetDrawChanged(),this._textLayoutChanged=!0}_SetWordWrapChanged(){this._SetTextLayoutChanged(),this._wordWrapChanged=!0}SetBBCodeEnabled(e){if(e=!!e,this._isBBcodeEnabled===e)return;this._isBBcodeEnabled=e;const t=this._isBBcodeEnabled?"alphabetic":"top";this._textContext&&(this._textContext.textBaseline=t),this._measureContext&&(this._measureContext.textBaseline=t),this._ClearMeasurementCache(),this._SetWordWrapChanged()}IsBBCodeEnabled(){return this._isBBcodeEnabled}SetIconSet(e){this._iconSet!==e&&(this._iconSet=e,this._wrappedText.SetIconSet(e),this._iconSet&&this._iconSet.IsLoading()&&this._iconSet.LoadContent().then(()=>this._SetDrawChanged()),this._SetWordWrapChanged())}SetIconSmoothing(e){e=!!e,this._iconSmoothing!==e&&(this._iconSmoothing=e,this._SetDrawChanged())}SetFontName(e){e||(e="serif"),this._fontName!==e&&(this._fontName=e,this._ClearMeasurementCache(),this._SetWordWrapChanged())}GetFontName(){return this._fontName}SetFontSize(e){e<.1&&(e=.1),this._fontSize!==e&&(this._fontSize=e,this._ClearMeasurementCache(),this._SetWordWrapChanged())}GetFontSize(){return this._fontSize}SetFontSizeScale(e){this._fontSizeScale!==e&&(this._fontSizeScale=e,this._ClearMeasurementCache(),this._SetWordWrapChanged())}SetLineHeight(e){this._lineHeight!==e&&(this._lineHeight=e,this._SetTextLayoutChanged())}GetLineHeight(){return this._lineHeight}SetBold(e){e=!!e,this._isBold!==e&&(this._isBold=e,this._ClearMeasurementCache(),this._SetWordWrapChanged())}IsBold(){return this._isBold}SetItalic(e){e=!!e,this._isItalic!==e&&(this._isItalic=e,this._ClearMeasurementCache(),this._SetWordWrapChanged())}IsItalic(){return this._isItalic}SetDrawMaxCharacterCount(e){e=Math.floor(e),this._drawMaxCharCount!==e&&(this._drawMaxCharCount=e,this._SetDrawChanged())}GetDrawMaxCharacterCount(){return this._drawMaxCharCount}_GetFontString(e,t){let s=[];(this._isBold||t.HasStyleTag("b"))&&s.push("bold"),(this._isItalic||t.HasStyleTag("i"))&&s.push("italic");const i=t.GetStyleTag("size"),r=(i?parseFloat(i.param):this._fontSize)*this._fontSizeScale;e?s.push(r+"pt"):s.push(r*this.GetDrawScale()+"pt");let n=this._fontName;const a=t.GetStyleTag("font");return a&&a.param&&(n=a.param,this.onloadfont&&!this._alreadyLoadedFonts.has(n)&&(this.onloadfont(n),this._alreadyLoadedFonts.add(n))),n&&(Au.has(n)?s.push(n):s.push('"'+n+'"')),s.join(" ")}SetColor(e){e instanceof Pu.Color&&(e=e.getCssRgb()),this._colorStr!==e&&(this._colorStr=e,this._SetDrawChanged())}SetColorRgb(e,t,s){Du.setRgb(e,t,s),this.SetColor(Du)}SetHorizontalAlignment(e){if(!Eu.has(e))throw new Error("invalid horizontal alignment");this._horizontalAlign!==e&&(this._horizontalAlign=e,this._SetTextLayoutChanged())}GetHorizontalAlignment(){return this._horizontalAlign}SetVerticalAlignment(e){if(!Fu.has(e))throw new Error("invalid vertical alignment");this._verticalAlign!==e&&(this._verticalAlign=e,this._SetTextLayoutChanged())}GetVerticalAlignment(){return this._verticalAlign}SetWordWrapMode(e){if(!Ou.has(e))throw new Error("invalid word wrap mode");this._wrapMode!==e&&(this._wrapMode=e,this._ClearMeasurementCache(),this._SetWordWrapChanged())}GetWordWrapMode(){return this._wrapMode}SetTextDirection(e){if(!Bu.has(e))throw new Error("invalid text direction");this._textDirection!==e&&(this._textDirection=e,this._textContext&&(this._textContext.direction=this._textDirection),this._measureContext&&(this._measureContext.direction=this._textDirection),this._ClearMeasurementCache(),this._SetWordWrapChanged())}GetTextDirection(){return this._textDirection}SetText(e){this._text!==e&&(this._text=e,this._ClearMeasurementCache(),this._SetWordWrapChanged())}GetText(){return this._text}GetDrawScale(){return this._scaleFactor*this._zoom*self.devicePixelRatio}SetMipMapEnabled(e){e=!!e,this._enableMipMap!==e&&(this._enableMipMap=e,this._forceRecreateTexture=!0)}IsMipMapEnabled(){return this._enableMipMap}SetSize(e,t,s){if(void 0===s&&(s=1),e<=0||e<=0)return;if(this._cssWidth===e&&this._cssHeight===t&&this._zoom===s)return;const i=this._cssWidth;this._cssWidth=e,this._cssHeight=t,this._zoom=s;const r=self.devicePixelRatio;this._width=this._cssWidth*this._zoom*r,this._height=this._cssHeight*this._zoom*r;const n=Math.max(this._width,this._height),a=Math.min(this._renderer.GetMaxTextureSize(),4096);let o=1;n>a&&(o=a/n,this._width=Math.min(this._width*o,a),this._height=Math.min(this._height*o,a)),this._scaleFactor=o,this._cssWidth!==i?this._SetWordWrapChanged():this._SetTextLayoutChanged()}GetWidth(){return this._width}GetHeight(){return this._height}GetZoom(){return this._zoom}GetTextWidth(){return this._UpdateTextMeasurements(),this._wrappedText.GetMaxLineWidth()}GetTextHeight(){return this._UpdateTextMeasurements(),this._wrappedText.GetTotalLineHeight()+this._wrappedText.GetLineCount()*(this._lineHeight+4)-this._lineHeight}GetLengthInGraphemes(){this._UpdateTextMeasurements();let e=0;for(const t of this._wrappedText.GetLines())for(const s of t.fragments())e+=s.GetLength();return e}HitTestFragment(e,t){this._UpdateTextMeasurements();const s=this.GetDrawScale(),i=this._wrappedText.GetLines();for(const r of i){const i=r.GetFontBoundingBoxDescent()*s;if(t>=r.GetPosY()-r.GetHeight()*s+i&&t<r.GetPosY()+i)for(const t of r.fragments())if(e>=t.GetPosX()&&e<t.GetPosX()+t.GetWidth()*s)return t}return null}*fragmentsWithTag(e){this._UpdateTextMeasurements();const t=this._wrappedText.GetLines();for(const s of t)for(const t of s.fragments()){const s=t.GetStyleTag("tag");s&&Pu.equalsNoCase(s.param,e)&&(yield t)}}FindFragmentWithTag(e,t){for(const s of this.fragmentsWithTag(e)){if(0===t)return s;--t}return null}CountFragmentsWithTag(e){let t=0;for(const s of this.fragmentsWithTag(e))++t;return t}MaybeUpdateCanvas(){return!(this._textContext&&!this._drawChanged&&!this._textLayoutChanged&&!this._wordWrapChanged||this._wasReleased||this._width<=0||this._height<=0||(this._UpdateTextMeasurements(),this._DrawTextToCanvas(),0))}_MaybeUpdateTexture(){this._wasReleased||this._width<=0||this._height<=0||(this.MaybeUpdateCanvas(),(!this._texture||this._forceRecreateTexture||this._canvasContentChanged)&&(this._UpdateTexture(),this._textureTimeout.Reset()))}GetTexture(){return this._textureTimeout.Reset(),this._MaybeUpdateTexture(),this._texture}_SetTextCanvasSize(e,t){this._textCanvas||(this._textCanvas=Pu.CreateCanvas(16,16));let s=!1;this._lastCanvasWidth===e&&this._lastCanvasHeight===t||(this._lastCanvasWidth=e,this._lastCanvasHeight=t,this._textCanvas.width=e,this._textCanvas.height=t,s=!0),this._textContext||(this._textContext=this._textCanvas.getContext("2d"),s=!0),s?(this._textContext.textBaseline=this._isBBcodeEnabled?"alphabetic":"top",this._textContext.direction=this._textDirection,this._textContext.font=this._lastTextCanvasFont,this._textContext.fillStyle=this._lastTextCanvasFillStyle,this._textContext.strokeStyle=this._lastTextCanvasFillStyle,this._textContext.globalAlpha=this._lastTextCanvasOpacity,this._textContext.lineWidth=this._lastTextCanvasLineWidth):this._textContext.clearRect(0,0,e,t)}_MaybeCreateMeasureContext(){this._measureContext||(this._measureContext=Pu.CreateCanvas(16,16).getContext("2d"),this._measureContextTop=Pu.CreateCanvas(16,16).getContext("2d"),this._measureContext.textBaseline=this._isBBcodeEnabled?"alphabetic":"top",this._measureContextTop.textBaseline="top",this._measureContext.direction=this._textDirection,this._measureContextTop.direction=this._textDirection)}_SetMeasureFontString(e){this._lastMeasureCanvasFont!==e&&(this._lastMeasureCanvasFont=e,this._measureContext.font=e,this._measureContextTop.font=e)}_SupportsFontBoundingBoxMeasurements(){if(!Uu){Uu=!0,this._MaybeCreateMeasureContext();const e=this._measureContext.measureText("test");Vu="number"==typeof e.fontBoundingBoxAscent&&"number"==typeof e.fontBoundingBoxDescent}return Vu}_UpdateTextMeasurements(){this._UpdateWordWrap(),this._UpdateTextLayout()}_UpdateWordWrap(){this._wordWrapChanged&&(this._MaybeCreateMeasureContext(),!this._isBBcodeEnabled||this._bbString&&this._bbString.toString()===this._text||(this._bbString=new Pu.BBString(this._text,{noEscape:!0})),this._measurementCacheIdleTimeout.Reset(),this._wrappedText.WordWrap(this._isBBcodeEnabled?this._bbString.toFragmentList():this._text,this._measureTextCallback,this._cssWidth,this._wrapMode,0),this._wordWrapChanged=!1)}_UpdateTextLayout(){this._textLayoutChanged&&(this._LayoutText(),this._textLayoutChanged=!1)}_ClearMeasurementCache(e){this._measurementCache.clear(),e||this._measurementCacheIdleTimeout.Cancel()}_AddToMeasurementCache(e,t){const s=this._measurementCache;if(s.set(e,t),s.size>1e3){let e=0;for(const t of s.keys())if(s.delete(t),e++,e>=10)break}}_MeasureText(e){const t=e.IsText()?e.GetCharacterArray().join(""):" ",s=this._GetFontString(!0,e),i=s+"|"+t,r=this._measurementCache;let n=r.get(i);if(n)return r.delete(i),r.set(i,n),n;this._SetMeasureFontString(s);const a=this._measureContext.measureText(t);let o=0;if(this._isBBcodeEnabled&&this._SupportsFontBoundingBoxMeasurements()){const e=this._measureContextTop.measureText(t);o=a.fontBoundingBoxAscent-e.fontBoundingBoxAscent}const h=e.GetStyleTag("size"),l=(h?parseFloat(h.param):this._fontSize)*this._fontSizeScale;return n={width:a.width,height:xu(l),fontBoundingBoxAscent:a.fontBoundingBoxAscent||0,fontBoundingBoxDescent:a.fontBoundingBoxDescent||0,topToAlphabeticDistance:o},this._AddToMeasurementCache(i,n),n}_SetDrawFontString(e){this._lastTextCanvasFont!==e&&(this._lastTextCanvasFont=e,this._textContext.font=e)}_SetDrawCanvasColor(e){this._lastTextCanvasFillStyle!==e&&(this._lastTextCanvasFillStyle=e,this._textContext.fillStyle=e,this._textContext.strokeStyle=e)}_SetDrawCanvasOpacity(e){this._lastTextCanvasOpacity!==e&&(this._lastTextCanvasOpacity=e,this._textContext.globalAlpha=e)}_SetDrawCanvasLineWith(e){this._lastTextCanvasLineWidth!==e&&(this._lastTextCanvasLineWidth=e,this._textContext.lineWidth=e)}_LayoutText(){const e=this.GetDrawScale(),t=(4+this._lineHeight)*e;let s=0;const i=this._wrappedText.GetLines();if(0===i.length)return;for(const e of i){e.SetPosX(NaN),e.SetPosY(NaN);for(const t of e.fragments())t.SetPosX(NaN),t.SetPosY(NaN)}const r=this._isBBcodeEnabled&&this._SupportsFontBoundingBoxMeasurements();let n=i[0].GetHeight()*e;if("center"===this._verticalAlign){const a=i.reduce((s,i)=>s+i.GetHeight()*e+t,0)-t;s=Math.max(this._height/2-a/2,0),r&&(n=i[0].GetTopToAlphabeticDistance()*e)}else if("bottom"===this._verticalAlign){const n=i.reduce((s,i)=>s+i.GetHeight()*e+t,0)-this._lineHeight*e,a=r?i.at(-1).GetFontBoundingBoxDescent()*e:0;s=this._height-n-a-2}for(let r=0,a=i.length;r<a;++r){const a=i[r],o=a.GetHeight()*e,h=s;if(this._isBBcodeEnabled){if(s+=0===r?n:o,r>0&&s>this._height-4*e)break}else if(r>0&&s>=this._height-o)break;h>=0&&this._LayoutTextLine(a,s,e),this._isBBcodeEnabled||(s+=o),s+=t}}_LayoutTextLine(e,t,s){let i=0;"center"===this._horizontalAlign?i=Math.floor((this._width-e.GetWidth()*s)/2):"right"===this._horizontalAlign&&(i=this._width-e.GetWidth()*s),e.SetPosX(i),e.SetPosY(t);for(const r of"ltr"===this._textDirection?e.fragments():e.fragmentsReverse())this._LayoutFragment(r,i,t,s),i+=r.GetWidth()*s}_LayoutFragment(e,t,s,i){const r=e.GetStyleTag("offsetx");t+=r?wu(r.param,e.GetHeight())*i:0;const n=e.GetStyleTag("offsety");if(s+=n?wu(n.param,e.GetHeight())*i:0,e.IsIcon()){const t=e.GetStyleTag("iconoffsety");s+=t?wu(t.param,e.GetHeight())*i:.2*e.GetHeight()*i}e.SetPosX(t),e.SetPosY(s)}_DrawTextToCanvas(){if(!this._drawChanged)return;this._SetTextCanvasSize(Math.max(Pu.nextHighestPowerOfTwo(Math.ceil(this._width)),128),Math.max(Pu.nextHighestPowerOfTwo(Math.ceil(this._height)),64)),this._textContext.imageSmoothingEnabled=this._iconSmoothing,this._textContext.imageSmoothingQuality="high",this._drawCharCount=0;const e=this.GetDrawScale(),t=this._wrappedText.GetLines();for(const s of t)this._DrawTextLine(s,e);this._drawChanged=!1,this._canvasContentChanged=!0}_DrawTextLine(e,t){const s=e.GetPosX(),i=e.GetPosY();if(Number.isFinite(s)&&Number.isFinite(i))for(const s of"ltr"===this._textDirection?e.fragments():e.fragmentsReverse())this._DrawFragment(s,t,e.GetHeight())}_DrawFragment(e,t,s){const i=this._textContext,r=e.GetPosX(),n=e.GetPosY();if(!Number.isFinite(r)||!Number.isFinite(n))return;const a=s/16;let o=e.GetWidth()*t;const h=e.GetHeight()*t,l=e.GetHeight()/16,c=(4+this._lineHeight)*t;let u=e.IsText()?e.GetCharacterArray():null;if(-1!==this._drawMaxCharCount){if(this._drawCharCount>=this._drawMaxCharCount)return;e.IsText()&&this._drawCharCount+u.length>this._drawMaxCharCount&&(u=u.slice(0,this._drawMaxCharCount-this._drawCharCount),o=this._MeasureText(e).width*t),this._drawCharCount+=e.GetLength()}const d=e.GetStyleTag("background"),_=e.HasStyleTag("u"),p=e.HasStyleTag("s");if(e.IsText()&&Pu.IsCharArrayAllWhitespace(u)&&!d&&!_&&!p||e.HasStyleTag("hide"))return;const f=e.GetStyleTag("color"),m=e.GetStyleTag("opacity");this._SetDrawCanvasOpacity(m?parseFloat(m.param)/100:1),d&&(this._SetDrawCanvasColor(d.param),i.fillRect(r,n-h,o,h+c));const g=e.GetStyleTag("linethickness"),S=g?parseFloat(g.param):1,G=e.HasStyleTag("stroke");if(G&&this._SetDrawCanvasLineWith(.5*l*S*this.GetDrawScale()),e.IsText()){const t=u.join("");if(this._SetDrawFontString(this._GetFontString(!1,e)),!G){this._SetDrawCanvasLineWith(.5*l*S*this.GetDrawScale());const s=e.GetStyleTag("outlineback");s&&(this._SetDrawCanvasColor(s.param),this._FillOrStrokeText(!0,t,r,n,o))}if(this._SetDrawCanvasColor(f?f.param:this._colorStr),this._FillOrStrokeText(G,t,r,n,o),!G){this._SetDrawCanvasLineWith(.5*l*S*this.GetDrawScale());const s=e.GetStyleTag("outline");s&&(this._SetDrawCanvasColor(s.param),this._FillOrStrokeText(!0,t,r,n,o))}}else if(e.IsIcon()&&e.GetWidth()>0){const t=e.GetDrawable(this._iconSet);t&&i.drawImage(t,r,n-h,o,h)}if(this._SetDrawCanvasColor(f?f.param:this._colorStr),_&&bu(i,G,r,n+t*a,o,t*a*S),p){const e=t*l,s=n-h/4+e/2;i.fillRect(r,s-e*S/2,o,e*S)}}_FillOrStrokeText(e,t,s,i,r){"rtl"===this._textDirection&&(s+=r),e?"Gecko"===Pu.Platform.BrowserEngine?this._textContext.strokeText(t,s,i,r):this._textContext.strokeText(t,s,i):"Gecko"===Pu.Platform.BrowserEngine?this._textContext.fillText(t,s,i,r):this._textContext.fillText(t,s,i)}_UpdateTexture(){this._renderer.IsContextLost()||(this._texture&&!this._forceRecreateTexture||(this.ReleaseTexture(),this._texture=this._renderer.CreateDynamicTexture(this._textCanvas.width,this._textCanvas.height,{mipMap:this._enableMipMap,mipMapQuality:"high",isWebGPUFastUpdate:!this._enableMipMap}),this._forceRecreateTexture=!1),this._renderer.UpdateTexture(this._textCanvas,this._texture),this._rcTex.set(0,0,this._width/this._texture.GetWidth(),this._height/this._texture.GetHeight()),this._canvasContentChanged=!1,this.ontextureupdate&&this.ontextureupdate())}GetTexRect(){return this._rcTex}ReleaseTexture(){this._texture&&(this._renderer.IsContextLost()||this._renderer.DeleteTexture(this._texture),this._texture=null)}static OnContextLost(){for(const e of Wu)e.ReleaseTexture()}static GetAll(){return Wu.values()}}}{const Hu=self.C3;class ju{constructor(e){this._gl=e.GetContext(),this._version=e.GetWebGLVersionNumber(),this._timerExt=e._GetDisjointTimerQueryExtension(),this._query=null,this._isActive=!1,this._hasResult=!1,this._result=0,1===this._version?this._query=this._timerExt.createQueryEXT():this._query=this._gl.createQuery()}Release(){this._DeleteQueryObject(),this._gl=null,this._timerExt=null,this._hasResult=!1}_DeleteQueryObject(){this._query&&(1===this._version?this._timerExt.deleteQueryEXT(this._query):this._gl.deleteQuery(this._query),this._query=null)}BeginTimeElapsed(){if(this._isActive)throw new Error("query already active");1===this._version?this._timerExt.beginQueryEXT(this._timerExt.TIME_ELAPSED_EXT,this._query):this._gl.beginQuery(this._timerExt.TIME_ELAPSED_EXT,this._query),this._isActive=!0}EndTimeElapsed(){if(!this._isActive)throw new Error("query not active");1===this._version?this._timerExt.endQueryEXT(this._timerExt.TIME_ELAPSED_EXT):this._gl.endQuery(this._timerExt.TIME_ELAPSED_EXT),this._isActive=!1}CheckForResult(){if(!this._query||this._hasResult||this._isActive)return;let e=!1;e=1===this._version?this._timerExt.getQueryObjectEXT(this._query,this._timerExt.QUERY_RESULT_AVAILABLE_EXT):this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT_AVAILABLE);const t=this._gl.getParameter(this._timerExt.GPU_DISJOINT_EXT);e&&!t&&(1===this._version?this._result=this._timerExt.getQueryObjectEXT(this._query,this._timerExt.QUERY_RESULT_EXT):this._result=this._gl.getQueryParameter(this._query,this._gl.QUERY_RESULT),this._result/=1e9,this._hasResult=!0),(e||t)&&this._DeleteQueryObject()}HasResult(){return this._hasResult}GetResult(){if(!this._hasResult)throw new Error("no result available");return this._result}}Hu.Gfx.WebGLTimeElapsedQuery=class{constructor(e){this._renderer=e,this._frameNumber=e.GetFrameNumber(),this._isActive=!1,this._parentQuery=null,this._isNested=!1,this._realQuery=null,this._queries=[]}Release(){for(const e of this._queries)e instanceof ju&&e.Release();Hu.clearArray(this._queries),this._parentQuery=null,this._realQuery=null,this._renderer=null}BeginTimeElapsed(){if(this._isActive)throw new Error("query already active");const e=this._renderer._GetTimeQueryStack();e.length>0?(this._isNested=!0,this._parentQuery=e.at(-1),this._parentQuery._EndReal(),this._parentQuery._queries.push(this)):(this._isNested=!1,this._parentQuery=null),this._isActive=!0,e.push(this),this._StartReal()}EndTimeElapsed(){if(!this._isActive)throw new Error("query not active");if(this._renderer._GetTimeQueryStack().pop()!==this)throw new Error("can only end most nested query");this._isActive=!1,this._EndReal(),this._parentQuery&&(this._parentQuery._StartReal(),this._parentQuery=null)}_StartReal(){this._realQuery=Hu.New(ju,this._renderer),this._queries.push(this._realQuery),this._realQuery.BeginTimeElapsed()}_EndReal(){this._realQuery.EndTimeElapsed(),this._realQuery=null}CheckForResult(){for(const e of this._queries)e.CheckForResult()}IsNested(){return this._isNested}HasResult(){return this._queries.every(e=>e.HasResult())}GetResult(){return this._queries.reduce((e,t)=>e+t.GetResult(),0)}GetFrameNumber(){return this._frameNumber}}}{const zu=self.C3;zu.Gfx.WebGLQueryResultBuffer=class{constructor(e,t=1e3){this._renderer=e,this._maxQueries=t,this._buffer=[],this._renderer._AddQueryResultBuffer(this)}Release(){this.Clear(),this._renderer._RemoveQueryResultBuffer(this),this._renderer=null}Clear(){for(const e of this._buffer)e.Release();zu.clearArray(this._buffer)}AddTimeElapsedQuery(){const e=new zu.Gfx.WebGLTimeElapsedQuery(this._renderer);return this._buffer.push(e),this._buffer.length>this._maxQueries&&this._buffer.shift().Release(),e}CheckForResults(e){for(const t of this._buffer){if(t.GetFrameNumber()>=e)return;if(t.IsNested())return;t.CheckForResult()}}GetFrameRangeResultSum(e,t){if(t<=e)return NaN;let s=0;for(const i of this._buffer){if(i.GetFrameNumber()>=t)break;if(!(i.GetFrameNumber()<e)){if(!i.HasResult())return NaN;s+=i.GetResult()}}return s}DeleteAllBeforeFrameNumber(e){for(let t=0,s=this._buffer.length;t<s;++t){const s=this._buffer[t];if(!(s.GetFrameNumber()<e))return void(t>0&&this._buffer.splice(0,t));s.Release()}}}}{const Xu=globalThis.C3,Yu=globalThis.assert,qu=4,Ku=2,$u=4,Ju=2;Xu.Gfx.MeshDataWebGL=class extends Xu.Gfx.MeshData{#e=null;#s=null;#t=null;#r=null;#i=null;#o=!1;#m=!1;#n=!1;#h=!1;constructor(e,t,s,i){super(e,t,s,i),this.#o=!!i.staticPositions,this.#m=!!i.staticTexCoords,this.#n=!!i.staticColors,this.#h=!!i.staticIndices}CreateGPUResources(){if(super.CreateGPUResources(),this.IsSmall())return;const e=this.GetRenderer(),t=e.GetContext();e.GetWebGLVersionNumber()<2?this.#i=e._GetVAOExtension().createVertexArrayOES():this.#i=t.createVertexArray(),e._BindVAO(this.#i),this.#e=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.#e),t.bufferData(t.ARRAY_BUFFER,this.positions.byteLength,this.#o?t.STATIC_DRAW:t.DYNAMIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,3,t.FLOAT,!1,0,0),this.#s=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.#s),t.bufferData(t.ARRAY_BUFFER,this.texCoords.byteLength,this.#m?t.STATIC_DRAW:t.DYNAMIC_DRAW),t.enableVertexAttribArray(1),t.vertexAttribPointer(1,2,t.FLOAT,!1,0,0),this.#t=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,this.#t),t.bufferData(t.ARRAY_BUFFER,this.colors.byteLength,this.#n?t.STATIC_DRAW:t.DYNAMIC_DRAW),t.enableVertexAttribArray(2),t.vertexAttribPointer(2,4,e.IsColorDataF16()?t.HALF_FLOAT:t.FLOAT,!1,0,0),this.#r=t.createBuffer(),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.#r),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indices.byteLength,this.#h?t.STATIC_DRAW:t.DYNAMIC_DRAW),e._BindVAO(null)}WriteGPUData(){const e=this.GetRenderer(),t=e.GetContext();let s=!1,i=this.GetPendingBufferUpdate("positions"),r=i.GetPendingChange();if(r&&(t.bindBuffer(t.ARRAY_BUFFER,this.#e),t.bufferSubData(t.ARRAY_BUFFER,3*r.start*4,this.positions.subarray(3*r.start,3*r.end)),i.Reset()),i=this.GetPendingBufferUpdate("texCoords"),r=i.GetPendingChange(),r&&(t.bindBuffer(t.ARRAY_BUFFER,this.#s),t.bufferSubData(t.ARRAY_BUFFER,2*r.start*4,this.texCoords.subarray(2*r.start,2*r.end)),i.Reset()),i=this.GetPendingBufferUpdate("colors"),r=i.GetPendingChange(),r){const s=e.IsColorDataF16()?2:4;t.bindBuffer(t.ARRAY_BUFFER,this.#t),t.bufferSubData(t.ARRAY_BUFFER,4*r.start*s,this.colors.subarray(4*r.start,4*r.end)),i.Reset()}if(i=this.GetPendingBufferUpdate("indices"),r=i.GetPendingChange(),r){e._BindVAO(this.#i),s=!0;const n=this.IsIndexTypeUint16()?2:4;t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,r.start*n,this.indices.subarray(r.start,r.end)),i.Reset()}return s}_GetVAO(){return this.#i}ReleaseGPUResources(){super.ReleaseGPUResources();const e=this.GetRenderer(),t=e.GetContext();this.#i&&(e.GetWebGLVersionNumber()<2?e._GetVAOExtension().deleteVertexArrayOES(this.#i):t.deleteVertexArray(this.#i),this.#i=null),this.#e&&(t.deleteBuffer(this.#e),this.#e=null),this.#s&&(t.deleteBuffer(this.#s),this.#s=null),this.#t&&(t.deleteBuffer(this.#t),this.#t=null),this.#r&&(t.deleteBuffer(this.#r),this.#r=null)}OnContextLost(){this.#e=null,this.#s=null,this.#t=null,this.#r=null,this.#i=null}}}{const Zu=self.C3,Qu=self.assert,ed=self.glMatrix,td=ed.vec3,sd=ed.vec4,id=ed.mat4,rd={powerPreference:"default",enableGpuProfiling:!0,alpha:!1,depth:!1,canSampleDepth:!1,maxWebGLVersion:2,failIfMajorPerformanceCaveat:!1},nd=new Set(["default","low-power","high-performance"]),ad=8e3,od=7996,hd=new Zu.Quad(0,0,1,0,1,1,0,1),ld=id.create(),cd=id.create(),ud=new Zu.Quad,dd=new Zu.Rect;let _d=null;Zu.isDebug&&(self.debug_lose_webgl_context=function(){_d?_d.loseContext():console.warn("WEBGL_lose_context not supported")},self.debug_restore_webgl_context=function(){_d?_d.restoreContext():console.warn("WEBGL_lose_context not supported")}),Zu.Gfx.WebGLRenderer=class extends Zu.Gfx.RendererBase{#s=new Set;#e=new Zu.Gfx.DynamicMeshData(this);#i=this.#e._GetMeshData();#r=this.#i;#t=null;#h=new Set;#a=!1;#n=new Set;#o=-1;#l=0;constructor(e,t){if(super(t),t=Object.assign({},rd,t),!nd.has(t.powerPreference))throw new Error("invalid power preference");const s={alpha:!!t.alpha,depth:!1,antialias:!1,powerPreference:t.powerPreference,failIfMajorPerformanceCaveat:!!t.failIfMajorPerformanceCaveat};let i=null,r=0;if(t.maxWebGLVersion>=2&&(i=e.getContext("webgl2",s),r=2),i||(i=e.getContext("webgl",s),r=1),!i)throw new Error("renderer-unavailable (could not get WebGL context)");this._gl=i,this._attribs=i.getContextAttributes(),this._versionString=i.getParameter(i.VERSION),this._version=r,this._viewport=sd.create(),this._didChangeTransform=!1,this._bbProjectionMatrix=id.create(),this._usesDepthBuffer=!!t.depth,this._canSampleDepth=!(!t.depth||!t.canSampleDepth),this._isDepthEnabled=this._usesDepthBuffer,this._isDepthSamplingEnabled=!1,this._depthBuffer=null,this._isAutoSizeDepthBuffer=!0,this._depthBufferWidth=0,this._depthBufferHeight=0,this.#a=this._version>=2&&void 0!==globalThis.Float16Array,this._pointBuffer=null,this._pointData=new Float32Array(32e3),this._pointPtr=0,this._lastProgram=null,this._spDeviceTransformTextureFill=null,this._batch=[],this._batchPtr=0,this._topOfBatch=0,this._currentRenderTarget=null,this._lastPointZ=0,this._batchState=Zu.New(Zu.Gfx.BatchState,this),this._lastColor=this.#e.GetDefaultColor(),this._lastTexture0=null,this._lastTexture1=null,this._lastBlendMode=0,this._lastPointTexCoords=new Zu.Rect,this._lastScissorRect=Zu.New(Zu.Rect,0,0,-1,-1),this._coplanarMode=0,this._lastCullFace=0,this._lastFrontFaceWinding=0,this._maxTextureSize=-1,this._minPointSize=0,this._maxPointSize=0,this._unmaskedVendor="(unavailable)",this._unmaskedRenderer="(unavailable)",this._extensions=[],this._isInitialisingAfterContextRestored=!1,this._parallelShaderCompileExt=null,this._anisotropicExt=null,this._conservativeDepthExt=null,this._depthTextureExt=null,this._fragDepthExt=null,this._stdDerivativesExt=null,this._textureLodExt=null,this._blendMinMaxExt=null,this._maxAnisotropy=0,this._isGpuProfilingEnabled=!!t.enableGpuProfiling,this._timerExt=null,this._allQueryResultBuffers=new Set,this._timeQueryStack=[]}IsWebGL(){return!0}async InitState(){super.InitState();const e=this._gl;this._lastColor.setRgba(1,1,1,1),this._lastTexture0=null,this._lastTexture1=null,this._pointPtr=0,Zu.clearArray(this._batch),this._batchPtr=0,this._topOfBatch=0,this._lastProgram=null,this._currentRenderTarget=null,this._lastPointTexCoords.set(0,0,1,1),this._lastPointZ=0;const t=this._batchState;t.currentShader=null,t.currentFramebuffer=null,t.currentFramebufferNoDepth=null,t.clearColor.setRgba(0,0,0,0),t.pointTexCoords.set(0,0,1,1),e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT),e.enable(e.BLEND),e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),this._lastBlendMode=0,1===this._version?this._blendMinMaxExt=e.getExtension("EXT_blend_minmax"):this._blendMinMaxExt=null,this._InitBlendModes(e),e.cullFace(e.BACK),e.disable(e.CULL_FACE),this._lastCullFace=0,e.frontFace(e.CW),this._lastFrontFaceWinding=0,e.disable(e.STENCIL_TEST),e.disable(e.DITHER),this._usesDepthBuffer?(e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LEQUAL)):(e.disable(e.DEPTH_TEST),e.depthMask(!1)),this.GetWebGLVersionNumber()>=2?this.#l=e.getParameter(e.MAX_CLIENT_WAIT_TIMEOUT_WEBGL):this.#l=0,this._isDepthEnabled=this._usesDepthBuffer,this._isDepthSamplingEnabled=!1,this.GetWebGLVersionNumber()<2&&(this.#t=e.getExtension("OES_vertex_array_object"),e.getExtension("OES_element_index_uint"),this._fragDepthExt=e.getExtension("EXT_frag_depth"),this._stdDerivativesExt=e.getExtension("OES_standard_derivatives"),this._textureLodExt=e.getExtension("EXT_shader_texture_lod")),this.#e.CreateGPUResources(),this._BindVAO(null),this._pointBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this._pointBuffer),e.bufferData(e.ARRAY_BUFFER,this._pointData.byteLength,e.DYNAMIC_DRAW),e.enableVertexAttribArray(3),e.vertexAttribPointer(3,4,e.FLOAT,!1,0,0),this._BindVAO(this.#i._GetVAO()),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,null),this._maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE);const s=e.getParameter(e.ALIASED_POINT_SIZE_RANGE);this._minPointSize=s[0],this._maxPointSize=s[1],this._maxPointSize>2048&&(this._maxPointSize=2048),this._extensions=e.getSupportedExtensions();const i=e.getExtension("WEBGL_debug_renderer_info");if(i&&(this._unmaskedVendor=e.getParameter(i.UNMASKED_VENDOR_WEBGL),this._unmaskedRenderer=e.getParameter(i.UNMASKED_RENDERER_WEBGL)),this._parallelShaderCompileExt=e.getExtension("KHR_parallel_shader_compile"),this._version>=2&&("Chromium"!==Zu.Platform.BrowserEngine||Zu.Platform.BrowserVersionNumber>=135)&&(this._conservativeDepthExt=e.getExtension("EXT_conservative_depth")),Zu.isDebug&&(_d=e.getExtension("WEBGL_lose_context")),this._isGpuProfilingEnabled&&(1===this.GetWebGLVersionNumber()?this._timerExt=e.getExtension("EXT_disjoint_timer_query"):this._timerExt=e.getExtension("EXT_disjoint_timer_query_webgl2")||e.getExtension("EXT_disjoint_timer_query")),this._anisotropicExt=e.getExtension("EXT_texture_filter_anisotropic"),this._anisotropicExt?this._maxAnisotropy=e.getParameter(this._anisotropicExt.MAX_TEXTURE_MAX_ANISOTROPY_EXT):this._maxAnisotropy=0,this.GetWebGLVersionNumber()<2&&this._usesDepthBuffer&&this._canSampleDepth&&(this._depthTextureExt=e.getExtension("WEBGL_depth_texture"),!this._depthTextureExt))throw new Error("no depth texture support");const r=Zu.Gfx.WebGLShaderProgram,n=r.GetDefaultVertexShaderSource(!1);let a=r.GetTextureFillFragmentShaderSource_WebGL1_NoFragDepth(),o=n,h=r.GetPointFragmentShaderSource_WebGL1_NoFragDepth(),l=r.GetPointVertexShaderSource_WebGL1(),c=r.GetTilemapFragmentShaderSource_WebGL1_NoFragDepth(),u=r.GetDefaultVertexShaderSource(!0),d=!1;this._usesDepthBuffer&&(this.GetWebGLVersionNumber()<2?this._fragDepthExt&&(a=r.GetTextureFillFragmentShaderSource_WebGL1_FragDepthEXT(),h=r.GetPointFragmentShaderSource_WebGL1_FragDepthEXT(),c=r.GetTilemapFragmentShaderSource_WebGL1_FragDepthEXT(),d=!0):(o=r.GetDefaultVertexShaderSource_WebGL2(),a=r.GetTextureFillFragmentShaderSource_WebGL2(this._SupportsConservativeDepth()),h=r.GetPointFragmentShaderSource_WebGL2(this._SupportsConservativeDepth()),l=r.GetPointVertexShaderSource_WebGL2(),c=r.GetTilemapFragmentShaderSource_WebGL2(this._SupportsConservativeDepth()),u=r.GetDefaultVertexShaderSource_WebGL2(!0)));const _=r.GetTileRandomizationFragmentShaderSource(this.GetWebGLVersionNumber(),d,this._stdDerivativesExt&&this._textureLodExt,this._SupportsConservativeDepth()),p=this.GetWebGLVersionNumber()>=2?r.GetDefaultVertexShaderSource_WebGL2():n,f=[[a,o,"<default>"],[a,o,"<default-device-transform>"],[h,l,"<point>"],[r.GetColorFillFragmentShaderSource(),n,"<fill>"],[r.GetLinearGradientFillFragmentShaderSource(),n,"<lineargradient>"],[r.GetPenumbraFillFragmentShaderSource(),n,"<penumbra>"],[r.GetHardEllipseFillFragmentShaderSource(),n,"<hardellipse>"],[r.GetHardEllipseOutlineFragmentShaderSource(),n,"<hardellipseoutline>"],[r.GetSmoothEllipseFillFragmentShaderSource(),n,"<smoothellipse>"],[r.GetSmoothEllipseOutlineFragmentShaderSource(),n,"<smoothellipseoutline>"],[r.GetSmoothLineFillFragmentShaderSource(),n,"<smoothline>"],[c,u,"<tilemap>"],[_,p,"<tilerandomization>"]],m=await Promise.all(f.map(e=>this.CreateShaderProgram({src:e[0],vertexSrc:e[1],name:e[2]})));this._spTextureFill=m[0],this._spDeviceTransformTextureFill=m[1],this._spPoints=m[2],this._spColorFill=m[3],this._spLinearGradientFill=m[4],this._spPenumbraFill=m[5],this._spHardEllipseFill=m[6],this._spHardEllipseOutline=m[7],this._spSmoothEllipseFill=m[8],this._spSmoothEllipseOutline=m[9],this._spSmoothLineFill=m[10],this._spTilemapFill=m[11],this._spTileRandomization=m[12],this.SetTextureFillMode()}async CreateShaderProgram(e){const t=await Zu.Gfx.WebGLShaderProgram.Create(this,e);return this._AddShaderProgram(t),t}ResetLastProgram(){this._lastProgram=null}SetSize(e,t,s){if(this._width===e&&this._height===t&&!s)return;this.EndBatch();const i=this._gl,r=this._batchState;this._width=e,this._height=t,this._SetViewport(0,0,e,t),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,e/t),this.SetProjectionMatrix(this._bbProjectionMatrix),this._spDeviceTransformTextureFill&&(i.useProgram(this._spDeviceTransformTextureFill.GetShaderProgram()),this._spDeviceTransformTextureFill._UpdateDeviceTransformUniforms(this._matP),this._lastProgram=this._spDeviceTransformTextureFill,this._batchState.currentShader=this._spDeviceTransformTextureFill),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,null),i.activeTexture(i.TEXTURE0),this._lastTexture0=null,this._lastTexture1=null,this._usesDepthBuffer&&this._isAutoSizeDepthBuffer&&this._SetDepthBufferSize(this._width,this._height),this._currentRenderTarget&&this._currentRenderTarget._Resize(this._width,this._height),i.bindFramebuffer(i.FRAMEBUFFER,null),this._currentRenderTarget=null,r.currentFramebuffer=null,r.currentFramebufferNoDepth=null}_SetDepthBufferSize(e,t){const s=this._gl;this._depthBuffer&&this._depthBufferWidth===e&&this._depthBufferHeight===t||(this._canSampleDepth?(this._depthBuffer&&s.deleteTexture(this._depthBuffer),this._depthBuffer=s.createTexture(),s.bindTexture(s.TEXTURE_2D,this._depthBuffer),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),this.GetWebGLVersionNumber()>=2?s.texImage2D(s.TEXTURE_2D,0,s.DEPTH24_STENCIL8,e,t,0,s.DEPTH_STENCIL,s.UNSIGNED_INT_24_8,null):this._depthTextureExt&&s.texImage2D(s.TEXTURE_2D,0,s.DEPTH_STENCIL,e,t,0,s.DEPTH_STENCIL,this._depthTextureExt.UNSIGNED_INT_24_8_WEBGL,null),s.bindTexture(s.TEXTURE_2D,null)):(this._depthBuffer&&s.deleteRenderbuffer(this._depthBuffer),this._depthBuffer=s.createRenderbuffer(),s.bindRenderbuffer(s.RENDERBUFFER,this._depthBuffer),s.renderbufferStorage(s.RENDERBUFFER,this._version>=2?s.DEPTH24_STENCIL8:s.DEPTH_STENCIL,e,t),s.bindRenderbuffer(s.RENDERBUFFER,null)),this._depthBufferWidth=e,this._depthBufferHeight=t)}SetFixedSizeDepthBuffer(e,t){this._usesDepthBuffer&&(this._isAutoSizeDepthBuffer=!1,this._SetDepthBufferSize(e,t))}SetAutoSizeDepthBuffer(){this._usesDepthBuffer&&(this._isAutoSizeDepthBuffer=!0,this._SetDepthBufferSize(this._width,this._height))}_SetViewport(e,t,s,i){const r=this._viewport;r[0]===e&&r[1]===t&&r[2]===s&&r[3]===i||(this.PushBatch().InitSetViewport(e,t,s,i),sd.set(r,e,t,s,i),this._topOfBatch=0)}SetFovY(e){super.SetFovY(e),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,this._width/this._height)}SetNearZ(e){super.SetNearZ(e),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,this._width/this._height)}SetFarZ(e){super.SetFarZ(e),this.CalculatePerspectiveMatrix(this._bbProjectionMatrix,this._width/this._height)}SetProjectionMatrix(e){id.exactEquals(this._matP,e)||(this.PushBatch().InitSetProjection(e),id.copy(this._matP,e),this._topOfBatch=0,this._didChangeTransform=!0)}SetDefaultRenderTargetProjectionState(){let e,t,s;const i=this._currentRenderTarget;null===i?(e=this._bbProjectionMatrix,t=this.GetWidth(),s=this.GetHeight()):(e=i.GetProjectionMatrix(),t=i.GetWidth(),s=i.GetHeight()),this.SetProjectionMatrix(e),this._SetViewport(0,0,t,s)}SetModelViewMatrix(e){id.exactEquals(this._matMV,e)||(this.PushBatch().InitSetModelView(e),id.copy(this._matMV,e),this._topOfBatch=0,this._didChangeTransform=!0)}ResetDidChangeTransformFlag(){this._didChangeTransform=!1}DidChangeTransform(){return this._didChangeTransform}GetBatchState(){return this._batchState}PushBatch(){const e=this._batch;return this._batchPtr===e.length&&e.push(new Zu.Gfx.WebGLBatchJob(this._batchState)),e[this._batchPtr++]}EndBatch(){0!==this._batchPtr&&(this.IsContextLost()||(this._WriteBuffers(),this._ExecuteBatch(),this._batchPtr=0,this._pointPtr=0,this._topOfBatch=0))}_WriteBuffers(){const e=this._gl;this.#e.WriteGPUData(),this._pointPtr>0&&(e.bindBuffer(e.ARRAY_BUFFER,this._pointBuffer),e.bufferSubData(e.ARRAY_BUFFER,0,this._pointData.subarray(0,this._pointPtr)));const t=this._GetCurrentBoundVAO();let s=!1;for(const e of this.#h)e!==this.#i&&e.WriteGPUData()&&(s=!0);this.#h.clear(),s&&this._BindVAO(t)}_ExecuteBatch(){const e=this._batch;for(let t=0,s=this._batchPtr;t<s;++t)e[t].Run()}GetOpacity(){return this._lastColor.getA()}SetColorRgba(e,t,s,i){const r=this._lastColor;r.equalsRgba(e,t,s,i)||(r.setRgba(e,t,s,i),this._currentStateGroup=null,2===this._topOfBatch&&(this._topOfBatch=0))}SetOpacity(e){const t=this._lastColor;t.getA()!==e&&(t.setA(e),this._currentStateGroup=null,2===this._topOfBatch&&(this._topOfBatch=0))}SetColor(e){const t=this._lastColor;t.equals(e)||(t.set(e),this._currentStateGroup=null,2===this._topOfBatch&&(this._topOfBatch=0))}ResetColor(){this.SetColorRgba(1,1,1,1)}GetColor(){return this._lastColor}SetTexture(e){e!==this._lastTexture0&&(this.PushBatch().InitSetTexture(e),this._lastTexture0=e,this._topOfBatch=0)}_ResetLastTexture(){this._lastTexture0=null}SetBlendMode(e){this._lastBlendMode!==e&&(this._lastBlendMode=e,this._SetBlend(this._GetBlendParametersByIndex(e)))}SetNamedBlendMode(e){this.SetBlendMode(this.NamedBlendToNumber(e))}_SetBlend(e){this.PushBatch().InitSetBlend(e),this._topOfBatch=0,this._currentStateGroup=null}IsPremultipliedAlphaBlend(){return 0===this._lastBlendMode}SetAlphaBlend(){this.SetBlendMode(0)}SetCullFaceMode(e){this._lastCullFace!==e&&(this.PushBatch().InitSetCullFaceMode(e),this._lastCullFace=e,this._topOfBatch=0,this._currentStateGroup=null)}GetCullFaceMode(){return this._lastCullFace}SetFrontFaceWinding(e){this._lastFrontFaceWinding!==e&&(this.PushBatch().InitSetFrontFaceWinding(e),this._lastFrontFaceWinding=e,this._topOfBatch=0,this._currentStateGroup=null)}GetFrontFaceWinding(){return this._lastFrontFaceWinding}SetCopyBlend(){this.SetBlendMode(3)}Rect(e){this.Rect2(e.getLeft(),e.getTop(),e.getRight(),e.getBottom())}Rect2(e,t,s,i){this.Quad2(e,t,s,t,s,i,e,i)}#d(e,t){this.#v();const s=this.#e;s.CanFit(e,t)||this.EndBatch(),1===this._topOfBatch?this._batch[this._batchPtr-1]._indexCount+=t:(this.PushBatch().InitDraw(2*s.GetIndexPtr(),t),this._topOfBatch=1)}Quad(e){this.Quad4(e,hd)}Quad2(e,t,s,i,r,n,a,o){this.#d(4,6),this.#e.WriteQuad2(this._baseZ+this._currentZ,e,t,s,i,r,n,a,o)}Quad3(e,t){this.#d(4,6),this.#e.WriteQuad3(this._baseZ+this._currentZ,e,t)}Quad4(e,t){this.#d(4,6),this.#e.WriteQuad4(this._baseZ+this._currentZ,e,t)}Quad5(e,t,s){this.#d(4,6),this.#e.WriteQuad5(this._baseZ+this._currentZ,e,t,s)}Quad3D(e,t,s,i,r,n,a,o,h,l,c,u,d){this.#d(4,6),this.#e.WriteQuad3D(this._baseZ+this._currentZ,e,t,s,i,r,n,a,o,h,l,c,u,d)}Quad3D2(e,t,s,i,r,n,a,o,h,l,c,u,d){this.#d(4,6),this.#e.WriteQuad3D2(this._baseZ+this._currentZ,e,t,s,i,r,n,a,o,h,l,c,u,d)}Quad3D3(e,t,s,i,r,n,a,o,h,l,c,u,d,_){this.#d(4,6),this.#e.WriteQuad3D3(this._baseZ+this._currentZ,e,t,s,i,r,n,a,o,h,l,c,u,d,_)}FullscreenQuad(e,t){this.SetCurrentZ(0),id.copy(ld,this._matP),id.copy(cd,this._matMV),this.SetDefaultRenderTargetProjectionState();const[s,i]=this.GetRenderTargetSize(this._currentRenderTarget),r=this.CalculateLookAtModelView2(0,0,this.GetDefaultCameraZ(i),0,0,0,i);if(this.SetModelViewMatrix(r),"crop"===e&&this._currentRenderTarget&&t){const e=this._width/2,s=this._height/2,i=t.GetWidth(),r=t.GetHeight(),n=this._currentRenderTarget.GetWidth(),a=this._currentRenderTarget.GetHeight(),o=Math.min(n,i),h=Math.min(a,r),l=Math.max(r-a,0),c=Math.max(a-r,0);dd.set(-e,s-c,-e+o,s-h-c),ud.setFromRect(dd),dd.set(0,l,o,h+l),dd.divide(i,r),this.Quad3(ud,dd)}else{const e=s/2,t=i/2;this.Rect2(-e,t,e,-t)}this.SetProjectionMatrix(ld),this.SetModelViewMatrix(cd)}StartRenderingPoints(e){this._lastPointTexCoords.equals(e)||(this._lastPointTexCoords.copy(e),this.PushBatch().InitSetPointTexCoords(e),this._topOfBatch=0)}FinishRenderingPoints(){}Point(e,t,s,i){this._pointPtr>=7996&&this.EndBatch();let r=this._pointPtr;const n=this._baseZ+this._currentZ;2===this._topOfBatch&&this._lastPointZ===n?this._batch[this._batchPtr-1]._indexCount++:(this.PushBatch().InitPoints(r,n,this._lastColor),this._topOfBatch=2,this._lastPointZ=n);const a=this._pointData;a[r++]=e,a[r++]=t,a[r++]=s,a[r++]=i,this._pointPtr=r}CreateMeshData(e,t,s){const i=new Zu.Gfx.MeshDataWebGL(this,e,t,s);return this.#s.add(i),i}_ReleaseMeshData(e){this.EndBatch(),this.#s.delete(e)}DrawMesh(e,t,s,i){const r=Zu.Gfx.DynamicMeshData.GetMaxVertices(),n=Zu.Gfx.DynamicMeshData.GetMaxIndices();if(e.length%3!=0)throw new Error("vertex buffer length not multiple of 3");if(e.length>3*r)throw new Error(`too many vertices (${e.length/3}, limit ${r})`);if(s.length%3!=0)throw new Error("index buffer length not multiple of 3");if(s.length>n)throw new Error(`too many indices (${s.length}, limit ${n})`);this.#d(e.length,s.length),this.#e.WriteMesh(e,t,s,i)}DrawMeshData(e,t=0,s=e.GetIndexCount()){if(e.IsSmall())if(0===t&&s===e.GetIndexCount())this.#d(e.GetVertexCount(),e.GetIndexCount()),this.#e.WriteMesh(e.positions,e.texCoords,e.indices,e.colors);else{const{minIndex:i,maxIndex:r}=Zu.Gfx.DynamicMeshData.CalculatePartialIndexRange(e.indices,t,s),n=i,a=r+1;this.#d(a-n,s),this.#e.WriteMesh(e.positions.subarray(3*n,3*a),e.texCoords.subarray(2*n,2*a),e.indices.subarray(t,t+s),e.colors.subarray(4*n,4*a),i)}else{this.#g(e),this.#h.add(e);const i=e.IsIndexTypeUint16()?2:4;this.PushBatch().InitDraw(t*i,s),this._topOfBatch=0}}#v(){this.#g(this.#i)}#g(e){this.#r!==e&&(this.PushBatch().InitSetCurrentMeshData(e),this.#r=e,this._topOfBatch=0)}_GetCurrentMeshData(){return this.#r}_BindVAO(e){this.GetWebGLVersionNumber()<2?this.#t.bindVertexArrayOES(e):this._gl.bindVertexArray(e)}_GetCurrentBoundVAO(){const e=this._gl;return this.GetWebGLVersionNumber()<2?e.getParameter(this.#t.VERTEX_ARRAY_BINDING_OES):e.getParameter(e.VERTEX_ARRAY_BINDING)}SetProgram(e){this._lastProgram!==e&&(this.PushBatch().InitSetProgram(e),this._lastProgram=e,this._topOfBatch=0,this._currentStateGroup=null)}GetProgram(){return this._lastProgram}SetDeviceTransformTextureFillMode(){this.SetProgram(this._spDeviceTransformTextureFill)}SetGradientColor(e){this.PushBatch().InitSetGradientColor(e),this._topOfBatch=0}SetEllipseParams(e,t,s=1){this.PushBatch().InitSetEllipseParams(e,t,s),this._topOfBatch=0}SetTilemapInfo(e,t,s,i,r,n,a){if(this._lastProgram!==this._spTilemapFill)throw new Error("must set tilemap fill mode first");this.PushBatch().InitSetTilemapInfo(e,t,s,i,r,n,a),this._topOfBatch=0}SetTileRandomizationInfo(e,t,s,i,r,n,a){if(this._lastProgram!==this._spTileRandomization)throw new Error("must set tile randomization mode first");this.PushBatch().InitSetTileRandomizationInfo(e,t,s,i,r,n,a),this._topOfBatch=0}SetProgramParameters(e,t,s,i,r,n,a,o,h,l,c){const u=this._lastProgram;if(c%=10800,!u._hasAnyOptionalUniforms||u.AreOptionalUniformsAlreadySetInBatch(t,s,i,r,n,a,o,h,l,c))return;const d=this.PushBatch();d.InitSetProgramParameters(),u.SetOptionalUniformsInBatch(t,s,i,r,n,a,o,h,l,c);const _=d._mat4param;_[0]=n,_[1]=a,t.writeToTypedArray(_,2),_[6]=h,_[7]=l,s.writeToTypedArray(_,12);const p=d._colorParam;r.writeToTypedArray(p,0);const f=p[1];p[1]=p[3],p[3]=f,i.writeToTypedArray(d._srcOriginRect,0),d._startIndex=c,d._indexCount=o,u._uSamplerBack.IsUsed()?d._texParam=e?e.GetTexture():null:d._texParam=null,this._topOfBatch=0}SetProgramCustomParameters(e){const t=this._lastProgram;if(0===e.length||t.AreCustomParametersAlreadySetInBatch(e))return;const s=this.PushBatch();s.InitSetProgramCustomParameters(),t.SetCustomParametersInBatch(e),Zu.shallowAssignArray(s._shaderParams,e),this._topOfBatch=0}ClearRgba(e,t,s,i){this.PushBatch().InitClearSurface2(e,t,s,i),this._topOfBatch=0}Clear(e){this.PushBatch().InitClearSurface(e),this._topOfBatch=0}Start(){}Finish(){super.Finish(),this._gl.flush()}ClearDepth(){this._usesDepthBuffer&&this._currentRenderTarget&&this._currentRenderTarget.HasDepthBuffer()&&(this.PushBatch().InitClearDepth(this._isDepthEnabled),this._topOfBatch=0)}SetDepthEnabled(e){e=!!e,this._isDepthEnabled!==e&&this._usesDepthBuffer&&(this._isDepthEnabled=e,this.PushBatch().InitSetDepthEnabled(e),this._topOfBatch=0)}IsDepthEnabled(){return this._isDepthEnabled}_GetDepthBuffer(){return this._depthBuffer}_CanSampleDepth(){return this._canSampleDepth}SetDepthSamplingEnabled(e){if(e=!!e,this._canSampleDepth&&this._isDepthSamplingEnabled!==e){if(e&&this.IsDepthEnabled())throw new Error("depth still enabled");this._isDepthSamplingEnabled=e,this.PushBatch().InitSetDepthSamplingEnabled(e),this._topOfBatch=0}}SetScissorRect(e,t,s,i,r=0){e=Math.floor(e),t=Math.floor(t),s=Math.floor(s),i=Math.floor(i),this._lastScissorRect.equalsWH(e,t,s,i)||(this._lastScissorRect.setWH(e,t,s,i),t=(r||this.GetRenderTargetSize(this.GetRenderTarget())[1])-t-i,this.PushBatch().InitSetScissor(!0,e,t,s,i),this._topOfBatch=0)}RemoveScissorRect(){-1!==this._lastScissorRect.getRight()&&(this._lastScissorRect.set(0,0,-1,-1),this.PushBatch().InitSetScissor(!1,0,0,0,0),this._topOfBatch=0)}CheckForQueryResults(){for(const e of this._allQueryResultBuffers)e.CheckForResults(this._frameNumber)}IsContextLost(){return!this._gl||this._gl.isContextLost()||this._isInitialisingAfterContextRestored}OnContextLost(){super.OnDeviceOrContextLost(),Zu.Gfx.WebGLRendererTexture.OnContextLost(),Zu.Gfx.WebGLRenderTarget.OnContextLost(),Zu.Gfx.RendererText.OnContextLost();for(const e of this._allQueryResultBuffers)e.Clear();this.#e.OnContextLost();for(const e of this.#s)e!==this.#i&&e.OnContextLost();this._extensions=[],this.#t=null,this._timerExt=null,this._parallelShaderCompileExt=null,this._conservativeDepthExt=null,this._anisotropicExt=null,this._depthTextureExt=null,this._fragDepthExt=null,this._stdDerivativesExt=null,this._textureLodExt=null,this._maxAnisotropy=0,this._unmaskedVendor="(unavailable)",this._unmaskedRenderer="(unavailable)",this._lastProgram=null,this._spDeviceTransformTextureFill=null,this._depthBuffer=null;for(const e of this._stateGroups.values())e.OnContextLost()}async OnContextRestored(){this._isInitialisingAfterContextRestored=!0,await this.InitState(),this._isInitialisingAfterContextRestored=!1;for(const e of this._stateGroups.values())e.OnContextRestored(this);for(const e of this.#s)e!==this.#i&&e.OnContextRestored();this.SetSize(this._width,this._height,!0)}CreateStaticTexture(e,t){if(this.IsContextLost())throw new Error("context lost");this.EndBatch();const s=Zu.New(Zu.Gfx.WebGLRendererTexture,this);return s._CreateStatic(e,t),s}async CreateStaticTextureAsync(e,t){if(this.IsContextLost())throw new Error("context lost");if(t=Object.assign({},t),Zu.Supports.ImageBitmapOptions){let s=await createImageBitmap(e,{premultiplyAlpha:"premultiply"});const i=t.wrapX&&"clamp-to-edge"!==t.wrapX||t.wrapY&&"clamp-to-edge"!==t.wrapY,r=Zu.isPOT(s.width)&&Zu.isPOT(s.height);return this.SupportsNPOTTextures()||r||!i?t.premultiplyAlpha=!1:Zu.Supports.ImageBitmapOptionsResize?(s=await createImageBitmap(e,{premultiplyAlpha:"premultiply",resizeWidth:Zu.nextHighestPowerOfTwo(s.width),resizeHeight:Zu.nextHighestPowerOfTwo(s.height)}),t.premultiplyAlpha=!1):s=await createImageBitmap(e,{premultiplyAlpha:"none"}),await Zu.Asyncify(()=>this.CreateStaticTexture(s,t))}if(e instanceof Blob){if("undefined"==typeof Image)throw new Error("texture upload variant not supported in worker");const t=await Zu.BlobToImage(e);e=t}return await Zu.Asyncify(()=>this.CreateStaticTexture(e,t))}CreateDynamicTexture(e,t,s){this.EndBatch();const i=Zu.New(Zu.Gfx.WebGLRendererTexture,this);return i._CreateDynamic(e,t,s),i}UpdateTexture(e,t,s){this.EndBatch(),t._Update(e,s)}DeleteTexture(e){e&&(e.SubtractReference(),e.GetReferenceCount()>0||(this.EndBatch(),e===this._lastTexture0&&(this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._lastTexture0=null),e===this._lastTexture1&&(this._gl.activeTexture(this._gl.TEXTURE1),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.activeTexture(this._gl.TEXTURE0),this._lastTexture1=null),e._Delete()))}CreateRenderTarget(e){let t=this._width,s=this._height,i=!0;if(e&&("number"==typeof e.width&&(t=Math.floor(e.width),i=!1),"number"==typeof e.height&&(s=Math.floor(e.height),i=!1)),t<=0||s<=0)throw new Error("invalid size");this.EndBatch();const r=Zu.New(Zu.Gfx.WebGLRenderTarget,this);return r._Create(t,s,Object.assign({isDefaultSize:i},e)),this._currentRenderTarget=null,this._batchState.currentFramebuffer=null,this._batchState.currentFramebufferNoDepth=null,r}SetRenderTarget(e,t=!0){e!==this._currentRenderTarget&&(e&&e.IsDefaultSize()&&e._Resize(this._width,this._height),this.PushBatch().InitSetRenderTarget(e),this._currentRenderTarget=e,this._topOfBatch=0,t&&this.SetDefaultRenderTargetProjectionState(),e&&this._lastTexture0===e.GetTexture()&&this.SetTexture(null))}GetRenderTarget(){return this._currentRenderTarget}GetRenderTargetSize(e){return e?[e.GetWidth(),e.GetHeight()]:[this._width,this._height]}CopyRenderTarget(e,t="stretch"){this._version<2||this._currentRenderTarget&&this._currentRenderTarget.GetMultisampling()>0?(this.SetCopyBlend(),this.ResetColor(),this.DrawRenderTarget(e,t)):(this.PushBatch().InitBlitFramebuffer(e,this._currentRenderTarget,t),this._topOfBatch=0)}DrawRenderTarget(e,t="stretch"){const s=e.GetTexture();if(!s)throw new Error("not a texture-backed render target");this.SetTexture(s),this.FullscreenQuad(t,s)}InvalidateRenderTarget(e){this._version<2||(this.PushBatch().InitInvalidateFramebuffer(e._GetFramebuffer()),this._topOfBatch=0)}DeleteRenderTarget(e){this.SetRenderTarget(null),this.EndBatch();const t=e.GetTexture();t===this._lastTexture0&&(this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._lastTexture0=null),t===this._lastTexture1&&(this._gl.activeTexture(this._gl.TEXTURE1),this._gl.bindTexture(this._gl.TEXTURE_2D,null),this._gl.activeTexture(this._gl.TEXTURE0),this._lastTexture1=null),e._Delete()}async ReadBackRenderTargetToImageData(e,t,s){this.EndBatch();const i=this._currentRenderTarget;let r,n,a;e?(r=e.GetWidth(),n=e.GetHeight(),a=e._GetFramebuffer()):(r=this.GetWidth(),n=this.GetHeight(),a=null);let o=0,h=0,l=r,c=n;if(s){o=Zu.clamp(Math.floor(s.getLeft()),0,r-1),h=Zu.clamp(Math.floor(s.getTop()),0,n-1);let e=s.width();e=0===e?r-o:Zu.clamp(Math.floor(e),0,r-o);let t=s.height();t=0===t?n-h:Zu.clamp(Math.floor(t),0,n-h),l=e,c=t,h=n-(h+c)}const u=this._gl;u.bindFramebuffer(u.FRAMEBUFFER,a);const d=()=>{u.bindFramebuffer(u.FRAMEBUFFER,null),this._currentRenderTarget=null,this._batchState.currentFramebuffer=null,this._batchState.currentFramebufferNoDepth=null,this.SetRenderTarget(i)};let _;if(!t&&this.GetWebGLVersionNumber()>=2){u.bindFramebuffer(u.READ_FRAMEBUFFER,a);const e=u.createBuffer(),t=l*c*4,s=u.PIXEL_PACK_BUFFER;u.bindBuffer(s,e),u.bufferData(s,t,u.STREAM_READ),u.readPixels(o,h,l,c,u.RGBA,u.UNSIGNED_BYTE,0),u.bindFramebuffer(u.READ_FRAMEBUFFER,null),u.bindBuffer(s,null),d(),await this.WaitForSubmittedWorkDone(),_=new ImageData(l,c),u.bindBuffer(s,e),u.getBufferSubData(s,0,new Uint8Array(_.data.buffer),0,t),u.bindBuffer(s,null),u.deleteBuffer(e)}else _=new ImageData(l,c),u.readPixels(o,h,l,c,u.RGBA,u.UNSIGNED_BYTE,new Uint8Array(_.data.buffer)),d();return _}CoplanarStartStencilPass(){this.SetDepthEnabled(!0),this.PushBatch().InitCoplanarStartStencilPass(),this._topOfBatch=0,this._coplanarMode=1}CoplanarStartColorPass(e=!1){this.SetDepthEnabled(e),this.PushBatch().InitCoplanarStartColorPass(),this._topOfBatch=0,this._coplanarMode=2}IsCoplanarColorPass(){return 2===this._coplanarMode}CoplanarRestoreStandardRendering(e=!0){this.SetDepthEnabled(e),this.PushBatch().InitCoplanarRestore(),this._topOfBatch=0,this._coplanarMode=0}StartQuery(e){this.SupportsGPUProfiling()&&(this.PushBatch().InitStartQuery(e),this._topOfBatch=0)}EndQuery(e){this.SupportsGPUProfiling()&&(this.PushBatch().InitEndQuery(e),this._topOfBatch=0)}async WaitForSubmittedWorkDone(){if(this.GetWebGLVersionNumber()<2)return;const e=this._gl,t=e.fenceSync(e.SYNC_GPU_COMMANDS_COMPLETE,0);await this._WaitForObjectReady(()=>{const s=e.clientWaitSync(t,e.SYNC_FLUSH_COMMANDS_BIT,Math.min(1e6,this.#l));return s===e.ALREADY_SIGNALED||s===e.CONDITION_SATISFIED}),e.deleteSync(t)}_WaitForObjectReady(e){const t=new Promise(t=>this.#n.add({resolve:t,checkFunc:e}));return-1===this.#o&&(this.#o=self.requestAnimationFrame(()=>this.#u())),t}#u(){this.#o=-1,this._CheckPendingPolls(),this.#n.size>0&&(this.#o=self.requestAnimationFrame(()=>this.#u()))}_CheckPendingPolls(){for(const e of this.#n)e.checkFunc()&&(e.resolve(),this.#n.delete(e))}GetEstimatedBackBufferMemoryUsage(){return this._width*this._height*(this._attribs.alpha?4:3)}GetEstimatedRenderBufferMemoryUsage(){let e=0;for(const t of Zu.Gfx.WebGLRenderTarget.allRenderTargets())t.GetTexture()||(e+=t.GetEstimatedMemoryUsage());return e}GetEstimatedTextureMemoryUsage(){let e=0;for(const t of Zu.Gfx.WebGLRendererTexture.allTextures())e+=t.GetEstimatedMemoryUsage();return e}GetWebGLVersionString(){return this._versionString}GetWebGLVersionNumber(){return this._version}IsColorDataF16(){return this.#a}GetDisplayName(){return"webgl"+this.GetWebGLVersionNumber()}SupportsNPOTTextures(){return this.GetWebGLVersionNumber()>=2}GetMaxTextureSize(){return this._maxTextureSize}GetMinPointSize(){return this._minPointSize}GetMaxPointSize(){return this._maxPointSize}GetUnmaskedVendor(){return this._unmaskedVendor}GetUnmaskedRenderer(){return this._unmaskedRenderer}GetWebGLExtensionsAnalyticsString(){if(this.GetWebGLVersionNumber()>=2)return"webgl2";{const e=[];return this._fragDepthExt&&e.push("EXT_frag_depth"),this._stdDerivativesExt&&e.push("OES_standard_derivatives"),this._textureLodExt&&e.push("EXT_shader_texture_lod"),e.length>0?"webgl1:"+e.join(","):"webgl1:none"}}GetExtensions(){return this._extensions}_GetVAOExtension(){return this.#t}SupportsGPUProfiling(){return!!this._timerExt}_GetDisjointTimerQueryExtension(){return this._timerExt}_GetParallelShaderCompileExtension(){return this._parallelShaderCompileExt}_SupportsConservativeDepth(){return!!this._conservativeDepthExt}_GetAnisotropicExtension(){return this._anisotropicExt}_GetMaxAnisotropy(){return this._maxAnisotropy}_AddQueryResultBuffer(e){this._allQueryResultBuffers.add(e)}_RemoveQueryResultBuffer(e){this._allQueryResultBuffers.delete(e)}_GetTimeQueryStack(){return this._timeQueryStack}GetContext(){return this._gl}_InitBlendModes(e){let t=e.FUNC_ADD,s=e.FUNC_ADD;this._version>=2?(t=e.MAX,s=e.MIN):this._blendMinMaxExt&&(t=this._blendMinMaxExt.MAX_EXT,s=this._blendMinMaxExt.MIN_EXT),this._InitBlendModeData([["normal",[e.ONE,e.ONE_MINUS_SRC_ALPHA]],["additive",[e.ONE,e.ONE]],["xor",[e.ONE,e.ONE_MINUS_SRC_ALPHA]],["copy",[e.ONE,e.ZERO]],["destination-over",[e.ONE_MINUS_DST_ALPHA,e.ONE]],["source-in",[e.DST_ALPHA,e.ZERO]],["destination-in",[e.ZERO,e.SRC_ALPHA]],["source-out",[e.ONE_MINUS_DST_ALPHA,e.ZERO]],["destination-out",[e.ZERO,e.ONE_MINUS_SRC_ALPHA]],["source-atop",[e.DST_ALPHA,e.ONE_MINUS_SRC_ALPHA]],["destination-atop",[e.ONE_MINUS_DST_ALPHA,e.SRC_ALPHA]],["lighten",[e.ONE,e.ONE,e.ONE,e.ONE,t,t]],["darken",[e.ONE,e.ONE,e.ONE,e.ONE,s,s]],["multiply",[e.DST_COLOR,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA]],["screen",[e.ONE,e.ONE_MINUS_SRC_COLOR,e.ONE,e.ONE_MINUS_SRC_ALPHA]]])}CreateWebGLText(){return this.CreateRendererText()}}}{const pd=globalThis.C3,fd=globalThis.glMatrix,md=fd.vec3,gd=fd.mat4,Sd=globalThis.assert,Gd=globalThis.GPUBufferUsage,yd=globalThis.GPUShaderStage,Id=globalThis.GPUMapMode,Td=globalThis.GPUTextureUsage,Cd={powerPreference:"default",depth:!1,failIfMajorPerformanceCaveat:!1,canSampleBackbuffer:!1,backTextureSampling:"bilinear",usesBackgroundBlending:!1,canSampleDepth:!1,isMultiTexturingAllowed:!0},bd=16384,xd=65520,wd=1,Pd=2,Rd=4,vd=8,Ad=16,Md=32,Dd=64,Ed=128,Fd=256,Od=512,Bd=1024,kd=2048,Ld=4096,Nd=8192,Wd=16384,Ud=32768,Vd=65536,Hd=1<<17,jd=1<<18,zd=1<<19,Xd=1<<20,Yd=1<<21,qd=1<<22,Kd=1<<23,$d=1<<24,Jd=1<<25,Zd=1<<26,Qd=1<<27,e_=1<<28,t_=1<<29,s_=1<<30,i_=1,r_=2,n_=17392,a_=17401,o_=50160,h_=15360,l_=4,c_=4,u_=new pd.Quad(0,0,1,0,1,1,0,1),d_=pd.New(pd.Vector2),__=pd.New(pd.Rect),p_=pd.New(pd.Rect),f_=pd.New(pd.Quad);pd.Gfx.WebGPURenderer=class extends pd.Gfx.RendererBase{#e=new Set;#s=new pd.Gfx.DynamicMeshData(this,{texIndices:!0});#r=this.#s._GetMeshData();#i=this.#r;#h=new Set;#t=null;#n=!1;#a=-1;#d=-1;#o=new Set;#l=new Set;constructor(e){super(e),this._adapterOpts=null,this._adapter=null,this._adapterInfo=null,this._device=null,this._canvas=null,this._presentCtx=null,this._swapChainFormat="",this._swapChainTexture=null,this._swapChainTexView=null,this._viewportWidth=0,this._viewportHeight=0,this._matTransform=gd.create(),this._depthBuffer=null,this._nullDepthBuffer=null,this._depthBufferView=null,this._nullDepthBufferView=null,this._depthBufferBindGroup=null,this._nullDepthBufferBindGroup=null,this._depthBufferWidth=0,this._depthBufferHeight=0,this._vertexUniformBuffer=null,this._fragmentUniformBuffer=null,this._fragmentC3ParamsBuffer=null,this._fragmentDefaultCustomParamsBuffer=null,this._pointsIndexBuffer=null,this._pointBuffer=null,this._vertexUniformBufferLayout=pd.Gfx.WebGPUShaderProgram.GetVertexUniformBufferLayout(),this._vertexUniformBufferSize=pd.Gfx.WebGPUShaderProgram.GetVertexUniformBufferSize(),this._vertexUniformArrayBuffer=null,this._vertexUniformf32=null,this._fragUniformBufferLayout=pd.Gfx.WebGPUShaderProgram.GetFragmentUniformBufferLayout(),this._fragUniformBufferSize=pd.Gfx.WebGPUShaderProgram.GetFragmentUniformBufferSize(),this._fragUniformArrayBuffer=null,this._fragUniformf32=null,this._fragC3ParamsLayout=pd.Gfx.WebGPUShaderProgram.GetFragmentC3ParamsBufferLayout(),this._fragC3ParamsSize=pd.Gfx.WebGPUShaderProgram.GetFragmentC3ParamsBufferSize(),this._fragC3ParamsArrayBuffer=null,this._fragC3Paramsf32=null,this._fragC3Paramsu32=null,pd.Gfx.DynamicMeshData.GetMaxVertices(),this._pointData=new Float32Array(65536),this._currentMultiTextureIndex=0,this._currentColor=this.#s.GetDefaultColor(),this._pointPtr=0,this._bufferManager=pd.New(pd.Gfx.WebGPUBufferManager,this),this._flags=65536,this._flags2=0,this._drawFirstIndex=0,this._drawIndexCount=0,this._vertexUniformUpdateStart=0,this._vertexUniformUpdateEnd=0,this._fragUniformUpdateStart=0,this._fragUniformUpdateEnd=0,this._fragC3ParamsUpdateStart=0,this._fragC3ParamsUpdateEnd=0,this._scissorRect=pd.New(pd.Rect,0,0,0,0),this._currentColor2=pd.New(pd.Color,1,1,1,1),this._currentPointColor=pd.New(pd.Color,1,1,1,1),this._currentPointTexCoords=pd.New(pd.Rect,0,0,0,0),this._currentVertexZElevation=0,this._textureFormat="",this._bufferBindGroupLayout=null,this._defaultBufferBindGroup=null,this._textureBindGroupLayout=null,this._backTextureBindGroupLayout=null,this._depthTextureBindGroupLayout=null,this._nullTexture=null,this._currentTexture=null,this._currentTextureBindGroup=null,this._currentBackTexture=null,this._currentBackTextureBindGroup=null,this._currentDepthTextureBindGroup=null,this._currentBufferBindGroup=null,this._mipmapGeneratorPipeline=null,this._availableMultiTextures=new Set,this._nonFullMultiTexGroups=new Set,this._maxTextureSize=8192,this._pipelineLayout=null,this._defaultVertexModule=null,this._normVertexModule=null,this._currentProgram=null,this._currentBlendMode=0,this._currentMultisampleCount=0,this._currentCullFace=0,this._currentFrontFaceWinding=0,this._mipmapGeneratorProgram=null,this._spSingleTextureFill=null,this._samplerMap=new Map,this._commandEncoder=null,this._currentRenderPass=null,this._commandBuffers=[],this._backbufferRenderTarget=null,this._currentRenderTarget=null,this._canSampleBackbuffer=!1,this._backTextureSampling="bilinear",this._usesBackgroundBlending=!1,this._canSampleDepth=!1,this.ondevicelost=null,this.ondevicerestored=null,this._InitBlendModes()}IsWebGPU(){return!0}_SetFlag(e,t){t?this._flags|=e:this._flags&=~e}_IsFlagSet(e){return 0!==(this._flags&e)}_SetFlag2(e,t){t?this._flags2|=e:this._flags2&=~e}_IsFlagSet2(e){return 0!==(this._flags2&e)}async Create(e,t){if(t=Object.assign({},Cd,t),!navigator.gpu)throw new Error("renderer-unavailable (WebGPU not supported)");t.depth&&(this._flags|=1048576),t.isMultiTexturingAllowed&&(this._flags|=131072),this._canSampleBackbuffer=!!t.canSampleBackbuffer,this._backTextureSampling=t.backTextureSampling,this._usesBackgroundBlending=!!t.usesBackgroundBlending,this._adapterOpts={},this._canSampleDepth=!(!t.depth||!t.canSampleDepth),"default"!==t.powerPreference&&(this._adapterOpts.powerPreference=t.powerPreference),this._canvas=e,await this._InitDevice(t.failIfMajorPerformanceCaveat)}async _InitDevice(e){for(this._device=null,await this._TryGetDeviceOnCurrentAdapter(e);!this._device;)this._adapter=null,await this._TryGetDeviceOnCurrentAdapter(e);await this.InitState()}async _TryGetDeviceOnCurrentAdapter(e){if(!this._adapter){if(this._adapter=await navigator.gpu.requestAdapter(this._adapterOpts),!this._adapter)throw new Error("renderer-unavailable (no WebGPU adapter available)");const t=this._adapter.info;if(e&&t.isFallbackAdapter)throw new Error("renderer-unavailable (WebGPU provided fallback adapter)");if("adreno-7xx"===t.architecture)throw new Error("WebGPU disabled on adreno-7xx devices - see https://issues.chromium.org/issues/329702056");if("intel"===t.vendor&&("gen-7"===t.architecture||"gen7"===t.architecture))throw new Error("WebGPU disabled on Intel Gen7 GPUs - see https://issues.chromium.org/issues/462468373")}const t=[];if(this._adapter.features.has("timestamp-query")&&t.push("timestamp-query"),this._adapter.features.has("shader-f16")&&t.push("shader-f16"),this._device=await this._adapter.requestDevice({requiredFeatures:t,requiredLimits:{maxTextureDimension2D:this._adapter.limits.maxTextureDimension2D}}),!this._device)return null;this._maxTextureSize=this._device.limits.maxTextureDimension2D,this._SetFlag(268435456,this._device.features.has("timestamp-query")),this._SetFlag(536870912,this._device.features.has("shader-f16")),this._SetFlag(1073741824,this._IsFlagSet(536870912)&&void 0!==globalThis.Float16Array),this._device.lost.then(e=>this._OnDeviceLost(e)),this._SetFlag(65536,!1)}async _OnDeviceLost(e){console.log("[WebGPU] Device lost: ",e),super.OnDeviceOrContextLost(),this._bufferManager.OnContextLost(),pd.Gfx.WebGPURendererTexture.OnContextLost(),pd.Gfx.WebGPURenderTarget.OnContextLost(),pd.Gfx.RendererText.OnContextLost(),this.#s.OnContextLost();for(const e of this.#e)e!==this.#r&&e.OnContextLost();this._swapChainFormat="",this._swapChainTexture=null,this._swapChainTexView=null,this._depthBuffer=null,this._depthBufferView=null,this._nullDepthBuffer=null,this._nullDepthBufferView=null,this._depthBufferBindGroup=null,this._nullDepthBufferBindGroup=null,this._pointsIndexBuffer=null,this._pointBuffer=null,this._vertexUniformBuffer=null,this._fragmentUniformBuffer=null,this._fragmentC3ParamsBuffer=null,this._fragmentDefaultCustomParamsBuffer=null,this._defaultBufferBindGroup=null,this._bufferBindGroupLayout=null,this._currentBufferBindGroup=null,this._textureBindGroupLayout=null,this._backTextureBindGroupLayout=null,this._depthTextureBindGroupLayout=null,this._pipelineLayout=null,this._currentProgram=null,this._nullTexture=null,this._currentTexture=null,this._currentTextureBindGroup=null,this._currentBackTexture=null,this._currentBackTextureBindGroup=null,this._currentDepthTextureBindGroup=null,this._defaultVertexModule=null,this._normVertexModule=null,this._backbufferRenderTarget=null,this._currentRenderTarget=null,this._mipmapGeneratorPipeline=null,this.#t=null,this._mipmapGeneratorProgram=null,this._spSingleTextureFill=null,this._availableMultiTextures.clear(),this._nonFullMultiTexGroups.clear(),this._samplerMap.clear();for(const e of this._stateGroups.values())e.OnContextLost();this._device=null,this._adapter=null,this._adapterInfo=null,this._flags|=65536,this.ondevicelost&&this.ondevicelost(),await this._InitDevice();for(const e of this._stateGroups.values())e.OnContextRestored(this);for(const e of this.#e)e!==this.#r&&e.OnContextRestored();this.SetSize(this._width,this._height,!0),this.ondevicerestored&&this.ondevicerestored()}async InitState(){super.InitState();const e=this._device;this._swapChainFormat=navigator.gpu.getPreferredCanvasFormat(),this._swapChainTexture=null,this._swapChainTexView=null;let t=Td.RENDER_ATTACHMENT;this._canSampleBackbuffer&&(t|=Td.TEXTURE_BINDING),this._usesBackgroundBlending&&(t|=Td.COPY_SRC),this._swapChainFormat.startsWith("rgba8")||this._swapChainFormat.startsWith("bgra8")?this._textureFormat=this._swapChainFormat:this._textureFormat="rgba8unorm",this._flags&=1880227840,this._flags|=15360,this._flags2=0,this.SupportsGPUProfiling()&&(this.#t=new pd.Gfx.WebGPUTimeQuerySet(this)),this._IsFlagSet(1048576)&&(this._flags|=140509184),this._currentBlendMode=0,this._currentCullFace=0,this._currentFrontFaceWinding=0,this._currentMultisampleCount=0,this._currentColor.setRgba(1,1,1,1),this._currentColor2.setRgba(1,1,1,1),this._currentPointColor.setRgba(1,1,1,1),this._vertexUniformArrayBuffer=new ArrayBuffer(this._vertexUniformBufferSize),this._vertexUniformf32=new Float32Array(this._vertexUniformArrayBuffer),this._fragUniformArrayBuffer=new ArrayBuffer(this._fragUniformBufferSize),this._fragUniformf32=new Float32Array(this._fragUniformArrayBuffer),this._fragC3ParamsArrayBuffer=new ArrayBuffer(this._fragC3ParamsSize),this._fragC3Paramsf32=new Float32Array(this._fragC3ParamsArrayBuffer),this._fragC3Paramsu32=new Uint32Array(this._fragC3ParamsArrayBuffer),this.#s.CreateGPUResources(),this._pointsIndexBuffer=e.createBuffer({label:"pointsindexbuffer",size:196608,usage:Gd.INDEX,mappedAtCreation:!0});const s=this._pointsIndexBuffer.getMappedRange();this._FillPointsIndexBuffer(s),this._pointsIndexBuffer.unmap(),this._pointBuffer=e.createBuffer({label:"pointbuffer",size:this._pointData.byteLength,usage:Gd.VERTEX|Gd.STORAGE|Gd.COPY_DST}),this._bufferBindGroupLayout=e.createBindGroupLayout({label:"bufferbindgrouplayout",entries:[{binding:0,visibility:yd.VERTEX,buffer:{type:"uniform",minBindingSize:this._vertexUniformBufferSize}},{binding:1,visibility:yd.FRAGMENT,buffer:{type:"uniform",minBindingSize:this._fragUniformBufferSize}},{binding:3,visibility:yd.VERTEX,buffer:{type:"read-only-storage",minBindingSize:this._pointData.byteLength}},{binding:4,visibility:yd.FRAGMENT,buffer:{type:"uniform",minBindingSize:this._fragC3ParamsSize}},{binding:5,visibility:yd.FRAGMENT,buffer:{type:"uniform"}}]});const i=[],r=pd.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(let e=0;e<r;++e)i.push({binding:2*e,visibility:yd.FRAGMENT,sampler:{type:"filtering"}},{binding:2*e+1,visibility:yd.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d"}});this._textureBindGroupLayout=e.createBindGroupLayout({label:"texturebindgrouplayout",entries:i}),this._backTextureBindGroupLayout=e.createBindGroupLayout({label:"backtexturebindgrouplayout",entries:[{binding:0,visibility:yd.FRAGMENT,sampler:{type:"nearest"===this._backTextureSampling?"non-filtering":"filtering"}},{binding:1,visibility:yd.FRAGMENT,texture:{sampleType:"float",viewDimension:"2d"}}]}),this._depthTextureBindGroupLayout=e.createBindGroupLayout({label:"depthtexturebindgrouplayout",entries:[{binding:0,visibility:yd.FRAGMENT,sampler:{type:"non-filtering"}},{binding:1,visibility:yd.FRAGMENT,texture:{sampleType:"depth",viewDimension:"2d"}}]}),this._pipelineLayout=e.createPipelineLayout({bindGroupLayouts:[this._bufferBindGroupLayout,this._textureBindGroupLayout,this._backTextureBindGroupLayout,this._depthTextureBindGroupLayout]});const n=pd.Gfx.WebGPUShaderProgram,a=this.SupportsF16(),o=this.IsColorDataF16();this._defaultVertexModule=e.createShaderModule({label:"<default vertex module>",code:n._PreprocessVertexShaderCode(n.GetDefaultVertexShaderSource(o),a)}),this._defaultVertexModule.getCompilationInfo().then(e=>n.ReportShaderCompilationInfo("<default>","vertex",e)),this._normVertexModule=e.createShaderModule({label:"<normalized vertex module>",code:n._PreprocessVertexShaderCode(n.GetNormalizedVertexShaderSource(o),a)}),this._normVertexModule.getCompilationInfo().then(e=>n.ReportShaderCompilationInfo("<normalized>","vertex",e));const h=await Promise.all([n.Create(this,{name:"<default>",src:n.GetMultiTextureFillFragmentShaderSource(!1,o),srcFragDepth:n.GetMultiTextureFillFragmentShaderSource(!0,o),vertexSrc:n.GetTextureFillVertexShaderSource(o),normVertexSrc:n.GetNormalizedTextureFillVertexShaderSource(o)}),n.Create(this,{name:"<single-texture-fill>",src:n.GetSingleTextureFillFragmentShaderSource(!1,o),srcFragDepth:n.GetSingleTextureFillFragmentShaderSource(!0,o),vertexSrc:n.GetTextureFillVertexShaderSource(o),normVertexSrc:n.GetNormalizedTextureFillVertexShaderSource(o)}),n.Create(this,{name:"<generate-mipmap>",src:n._GetMipmapGeneratorFragmentSource(),vertexSrc:n._GetMipmapGeneratorVertexSource()}),n.Create(this,{name:"<point>",src:n._GetPointFragmentSource(!1),srcFragDepth:n._GetPointFragmentSource(!0),vertexSrc:n._GetPointVertexSource()}),n.Create(this,{name:"<tilemap>",src:n._GetTilemapFragmentShaderSource(!1),srcFragDepth:n._GetTilemapFragmentShaderSource(!0)}),n.Create(this,{name:"<fill>",src:n._GetColorFillFragmentShaderSource()}),n.Create(this,{name:"<lineargradient>",src:n._GetLinearGradientFillFragmentShaderSource()}),n.Create(this,{name:"<penumbra>",src:n._GetPenumbraFillFragmentShaderSource()}),n.Create(this,{name:"<hardellipse>",src:n._GetHardEllipseFillFragmentShaderSource()}),n.Create(this,{name:"<hardellipseoutline>",src:n._GetHardEllipseOutlineFragmentShaderSource()}),n.Create(this,{name:"<smoothellipse>",src:n._GetSmoothEllipseFillFragmentShaderSource()}),n.Create(this,{name:"<smoothellipseoutline>",src:n._GetSmoothEllipseOutlineFragmentShaderSource()}),n.Create(this,{name:"<tilerandomization>",src:n.GetTileRandomizationFragmentShaderSource(!1),srcFragDepth:n.GetTileRandomizationFragmentShaderSource(!0)}),n.Create(this,{name:"<smoothline>",src:n._GetSmoothLineFillFragmentShaderSource()})]);this._spTextureFill=h[0],this._spSingleTextureFill=h[1],this._mipmapGeneratorProgram=h[2],this._spPoints=h[3],this._spTilemapFill=h[4],this._spColorFill=h[5],this._spLinearGradientFill=h[6],this._spPenumbraFill=h[7],this._spHardEllipseFill=h[8],this._spHardEllipseOutline=h[9],this._spSmoothEllipseFill=h[10],this._spSmoothEllipseOutline=h[11],this._spTileRandomization=h[12],this._spSmoothLineFill=h[13];for(const e of h)this._AddShaderProgram(e);131072&this._flags?(this._flags|=786432,this._currentProgram=this._spTextureFill):this._currentProgram=this._spSingleTextureFill,this._mipmapGeneratorPipeline=this._mipmapGeneratorProgram._GetMipmapGeneratorPipeline(),this._vertexUniformBuffer=e.createBuffer({label:"vertexuniformbuffer",size:this._vertexUniformBufferSize,usage:Gd.UNIFORM|Gd.COPY_DST}),this._fragmentUniformBuffer=e.createBuffer({label:"fragmentuniformbuffer",size:this._fragUniformBufferSize,usage:Gd.UNIFORM|Gd.COPY_DST}),this._fragmentC3ParamsBuffer=e.createBuffer({label:"fragmentc3paramsuniformbuffer",size:this._fragC3ParamsSize,usage:Gd.UNIFORM|Gd.COPY_DST}),this._fragmentDefaultCustomParamsBuffer=e.createBuffer({label:"fragmentdefaultcustomparamsbuffer",size:16,usage:Gd.UNIFORM|Gd.COPY_DST}),this._vertexUniformUpdateStart=0,this._vertexUniformUpdateEnd=this._vertexUniformBufferSize,this._UpdateTransformUniform(),this._UpdatePointTexCoordsUniform(),this._UpdateZElevationUniform(),this._fragUniformUpdateStart=0,this._fragUniformUpdateEnd=this._fragUniformBufferSize,this._UpdateColor2Uniform(),this._UpdatePointColorUniform(),this._defaultBufferBindGroup=this._CreateBufferBindGroup(this._fragmentDefaultCustomParamsBuffer),this._currentBufferBindGroup=this._defaultBufferBindGroup;const l=pd.CreateCanvas(32,32);l.getContext("2d"),this._nullTexture=await this.CreateStaticTextureAsync(l),this._currentTexture=null,this._currentTextureBindGroup=this._nullTexture._GetOwnTextureBindGroup(),this._currentMultiTextureIndex=0,this._currentBackTexture=null,this._currentBackTextureBindGroup=this._nullTexture._GetBackTextureBindGroup(),this._nullTexture._DisableMultiTexture(),this._nullDepthBuffer=this._device.createTexture({label:"nulldepthbuffer",size:[8,8,1],format:this._GetDepthBufferFormat(),usage:Td.TEXTURE_BINDING}),this._nullDepthBufferView=this._nullDepthBuffer.createView({label:"nulldepthbufferview",aspect:"depth-only"}),this._nullDepthBufferBindGroup=this._device.createBindGroup({label:"nulldepthbufferbindgroup",layout:this._depthTextureBindGroupLayout,entries:[{binding:0,resource:this._GetSampler({sampling:"nearest"})},{binding:1,resource:this._nullDepthBufferView}]}),this._currentDepthTextureBindGroup=this._nullDepthBufferBindGroup,this._backbufferRenderTarget=pd.New(pd.Gfx.WebGPURenderTarget,this,!0),this._backbufferRenderTarget.GetTexture()._BackbufferTextureSetProperties(t,this._swapChainFormat),this._currentRenderTarget=this._backbufferRenderTarget,this._CreateCommandEncoder(),this._adapterInfo=this._adapter.info,this._presentCtx||(this._presentCtx=this._canvas.getContext("webgpu")),this._presentCtx.configure({device:e,format:this._swapChainFormat,usage:t,alphaMode:"premultiplied"})}_CreateBufferBindGroup(e){return this._device.createBindGroup({layout:this._bufferBindGroupLayout,entries:[{binding:0,resource:{buffer:this._vertexUniformBuffer}},{binding:1,resource:{buffer:this._fragmentUniformBuffer}},{binding:3,resource:{buffer:this._pointBuffer}},{binding:4,resource:{buffer:this._fragmentC3ParamsBuffer}},{binding:5,resource:{buffer:e}}]})}_FillPointsIndexBuffer(e){const t=new Uint16Array(e);let s=0,i=t.length,r=0;for(;s<i;)t[s++]=r,t[s++]=r+1,t[s++]=r+2,t[s++]=r,t[s++]=r+2,t[s++]=r+3,r+=4}_GetDevice(){return this._device}_GetDefaultVertexModule(){return this._defaultVertexModule}_GetNormalizedVertexModule(){return this._normVertexModule}async CreateShaderProgram(e){const t=await pd.Gfx.WebGPUShaderProgram.Create(this,e);return this._AddShaderProgram(t),t}GetDisplayName(){return"webgpu"}GetSwapChainFormat(){return this._swapChainFormat}_GetDepthBufferFormat(){return"depth24plus-stencil8"}_GetSwapChainTexture(){return this._swapChainTexture}_GetSwapChainTexView(){return this._swapChainTexView}_CanSampleBackbuffer(){return this._canSampleBackbuffer}UsesBackgroundBlending(){return this._usesBackgroundBlending}_GetPipelineLayout(){return this._pipelineLayout}_GetTextureBindGroupLayout(){return this._textureBindGroupLayout}_GetBackTextureBindGroupLayout(){return this._backTextureBindGroupLayout}_GetBackTextureSampling(){return this._backTextureSampling}GetTextureFormat(){return this._textureFormat}GetMaxTextureSize(){return this._maxTextureSize}IsContextLost(){return this._IsFlagSet(65536)}SupportsGPUProfiling(){return this._IsFlagSet(268435456)}SupportsF16(){return this._IsFlagSet(536870912)}IsColorDataF16(){return this._IsFlagSet(1073741824)}GetEstimatedBackBufferMemoryUsage(){const e=this.GetWidth()*this.GetHeight();let t=e*pd.Gfx.WebGPURendererTexture.GetFormatByteSize(this._swapChainFormat);return this.UsesDepthBuffer()&&(t+=e*pd.Gfx.WebGPURendererTexture.GetFormatByteSize(this._GetDepthBufferFormat())),t}GetEstimatedRenderBufferMemoryUsage(){let e=0;for(const t of pd.Gfx.WebGPURenderTarget.allRenderTargets())t.IsBackBuffer()||(e+=t.GetTexture().GetEstimatedMemoryUsage());return e}GetEstimatedTextureMemoryUsage(){let e=0;for(const t of pd.Gfx.WebGPURendererTexture.allTextures())t.IsRenderTarget()||(e+=t.GetEstimatedMemoryUsage());return e}SupportsNPOTTextures(){return!0}GetBufferManager(){return this._bufferManager}SetSize(e,t,s){(this._width!==e||this._height!==t||s)&&(this.EndBatch(),this._width=e,this._height=t,this._viewportWidth=e,this._viewportHeight=t,this._backbufferRenderTarget._CalculateProjection(),this.SetProjectionMatrix(this._backbufferRenderTarget.GetProjectionMatrix()),this._currentRenderTarget&&this._currentRenderTarget._Resize(this._width,this._height),this._IsFlagSet(1048576)&&this._IsFlagSet(134217728)&&this._SetDepthBufferSize(e,t))}_SetDepthBufferSize(e,t){if(this._depthBuffer){if(this._depthBufferWidth===e&&this._depthBufferHeight===t)return;this._depthBuffer.destroy()}let s=Td.RENDER_ATTACHMENT;this._canSampleDepth&&(s|=Td.TEXTURE_BINDING),this._depthBuffer=this._device.createTexture({label:"depthbuffer",size:[e,t,1],format:this._GetDepthBufferFormat(),usage:s}),this._depthBufferView=this._depthBuffer.createView({label:"depthbufferview"}),this._canSampleDepth&&(this._depthBufferBindGroup=this._device.createBindGroup({label:"depthbufferbindgroup",layout:this._depthTextureBindGroupLayout,entries:[{binding:0,resource:this._GetSampler({sampling:"nearest"})},{binding:1,resource:this._depthBuffer.createView({label:"depthbufferview",aspect:"depth-only"})}]})),this._depthBufferWidth=e,this._depthBufferHeight=t}SetFixedSizeDepthBuffer(e,t){this.UsesDepthBuffer()&&(this._SetFlag(134217728,!1),this._SetDepthBufferSize(e,t))}SetAutoSizeDepthBuffer(){this.UsesDepthBuffer()&&(this._SetFlag(134217728,!0),this._SetDepthBufferSize(this._width,this._height))}SetProjectionMatrix(e){gd.exactEquals(this._matP,e)||(gd.copy(this._matP,e),this._UpdateTransformUniform())}SetDefaultRenderTargetProjectionState(){this.SetProjectionMatrix(this._currentRenderTarget.GetProjectionMatrix())}SetModelViewMatrix(e){gd.exactEquals(this._matMV,e)||(gd.copy(this._matMV,e),this._UpdateTransformUniform())}ResetDidChangeTransformFlag(){this._SetFlag2(2,!1)}DidChangeTransform(){return this._IsFlagSet2(2)}CreateStaticTexture(e,t){if(e&&!pd.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(e)){const t=e.width||e.videoWidth,s=e.height||e.videoHeight,i=pd.CreateCanvas(t,s);i.getContext("2d").drawImage(e,0,0,t,s),e=i}this.EndBatch();const s=pd.New(pd.Gfx.WebGPURendererTexture,this);return s._Create(e,t),s}async CreateStaticTextureAsync(e,t){if(pd.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(e))return this.CreateStaticTexture(e,t);{if(!pd.Supports.ImageBitmapOptions)throw new Error("no support for ImageBitmapOptions");const s=await createImageBitmap(e,{premultiplyAlpha:"premultiply"});return this.CreateStaticTexture(s,t)}}_GetSampler(e){const t=e.wrapX||"clamp-to-edge",s=e.wrapY||"clamp-to-edge",i=e.sampling;let r=e.anisotropy||0;"trilinear"!==i&&(r=0);const n=`${t},${s},${i},${r}`;let a=this._samplerMap.get(n);if(a)return a;const o={addressModeU:t,addressModeV:s,magFilter:"nearest",minFilter:"nearest",mipmapFilter:"nearest"};return"bilinear"!==i&&"trilinear"!==i||(o.magFilter="linear",o.minFilter="linear"),"trilinear"===i&&(o.mipmapFilter="linear",r>1&&(o.maxAnisotropy=r)),a=this._device.createSampler(o),this._samplerMap.set(n,a),a}_GetMipmapGeneratorPipeline(){return this._mipmapGeneratorPipeline}CreateDynamicTexture(e,t,s){this.EndBatch();const i=pd.New(pd.Gfx.WebGPURendererTexture,this);return i._CreateDynamic(e,t,s),i}UpdateTexture(e,t,s){return t._Update(e,s)}DeleteTexture(e){e&&(e.SubtractReference(),e.GetReferenceCount()>0||(this.IsContextLost()||(this.EndBatch(),this._currentTexture===e&&this.SetTexture(null),this._currentBackTexture===e&&this.SetBackTexture(null)),e._Delete()))}_SetMultiTextureAvailable(e,t){this.IsContextLost()||(t?this._availableMultiTextures.add(e):this._availableMultiTextures.delete(e))}_SetMultiTextureGroupNonFull(e,t){t?this._nonFullMultiTexGroups.add(e):this._nonFullMultiTexGroups.delete(e)}_TryCreateMultiTextureGroup(e){const t=[e],s=pd.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(const e of this._nonFullMultiTexGroups)e.Release();for(const i of this._availableMultiTextures){if(t.length>=s)break;i!==e&&t.push(i)}t.length<2||pd.New(pd.Gfx.WebGPUMultiTextureGroup,this,t)}Start(){this._UpdateSwapChainTexture()}Restart(){this._UpdateSwapChainTexture()}_UpdateSwapChainTexture(){this._swapChainTexture=this._presentCtx.getCurrentTexture(),this._swapChainTexView=this._swapChainTexture.createView({label:"swapchaintextureview"}),this._backbufferRenderTarget.GetTexture()._BackbufferTextureStartFrame()}Finish(){null===this._currentRenderPass&&this._backbufferRenderTarget._IsAwaitingClear()&&this._BeginRenderPass(),super.Finish(),this._bufferManager.MaybeCollectUnusedBuffers(this._frameNumber),this._backbufferRenderTarget.GetTexture()._BackbufferTextureEndFrame(),this._swapChainTexture=null,this._swapChainTexView=null}_CreateCommandEncoder(){this._commandEncoder=this._device.createCommandEncoder(),this._flags&=-32769}StartFrameTiming(e){if(!this.SupportsGPUProfiling())throw new Error("GPU profiling not supported");this.#n=!1,this.#o.clear(),this.#l.clear(),this.#t.SetQueryCount(e)}FinishFrameTiming(){return this.#t.GetResult(new Set([...this.#l]))}StartMeasuringRenderPassTime(e,t){if(this.SupportsGPUProfiling()){if(e<0||t<0||e===t)throw new Error("invalid timestamp index");this._MaybeEndRenderPass(),this.#n=!0,this.#a=e,this.#d=t}}StopMeasuringRenderPassTime(){this.#n&&(this._MaybeEndRenderPass(),this.#n=!1)}#g(e,t){this.#v();const s=this.#s;if(s.CanFit(e,t)){if(1&this._flags)return void(this._drawIndexCount+=t)}else this.EndBatch();null===this._currentRenderPass&&this._BeginRenderPass(),this._flags|=1,this._drawFirstIndex=s.GetIndexPtr(),this._drawIndexCount=t}_MaybeEndDrawBatch(){const e=this._flags,t=this._flags2;if(!(1&e))return;const s=this._currentRenderPass;if(16&e){const t=this._currentRenderTarget;s.setViewport(0,0,t.GetWidth(),t.GetHeight(),0,1),50331648&e&&s.setStencilReference(1),4&e&&this._DoSetRenderPassScissorRect(s,this._scissorRect,t)}if(32&e&&(2&e?s.setIndexBuffer(this._pointsIndexBuffer,"uint16"):this.#i.WebGPUInitRenderPassIndexBuffer(s),this.#i.WebGPUInitRenderPassVertexBuffers(s)),64&e){let i=0;1&t?i=4:16777216&e?i=2:33554432&e?i=3:6291456&~e||(i=1),s.setPipeline(this._currentProgram.GetRenderPipelineForState(this._currentBlendMode,i,this._currentCullFace,this._currentFrontFaceWinding,this._currentMultisampleCount))}if(16384&e&&s.setBindGroup(0,this._currentBufferBindGroup),128&e&&s.setBindGroup(1,this._currentTextureBindGroup),256&e&&s.setBindGroup(2,this._currentBackTextureBindGroup),512&e&&s.setBindGroup(3,this._currentDepthTextureBindGroup),8&e){const t=this._currentRenderTarget;4&e?this._DoSetRenderPassScissorRect(s,this._scissorRect,t):s.setScissorRect(0,0,t.GetWidth(),t.GetHeight())}s.drawIndexed(this._drawIndexCount,1,this._drawFirstIndex,0,0),this._flags&=-17402}_DoSetRenderPassScissorRect(e,t,s){const i=s.GetWidth(),r=s.GetHeight();let n=pd.clamp(t.getLeft(),0,i),a=pd.clamp(t.getTop(),0,r),o=pd.clamp(t.getRight(),n,i),h=pd.clamp(t.getBottom(),a,r);Number.isNaN(n)&&(n=0),Number.isNaN(a)&&(a=0),Number.isNaN(o)&&(o=i),Number.isNaN(h)&&(h=r),e.setScissorRect(n,a,o-n,h-a)}_BeginRenderPass(){const e=this._flags;15360&e&&this._WriteUniformBuffers();let t=null;t=16777216&e?this._GetCoplanarStencilRenderPassOpts():33554432&e?this._GetCoplanarColorRenderPassOpts():this._GetStandardRenderPassOpts(),this._currentRenderPass=this._commandEncoder.beginRenderPass(t),this._flags|=50160}_GetStandardRenderPassOpts(){const e=this._flags,t=this._currentRenderTarget,s={colorAttachments:[{view:t._GetTextureView(),loadOp:t._IsAwaitingClear()?"clear":"load",clearValue:t._GetClearColor().toJSON(),storeOp:"store"}]};return this._MaybeSetTimestampRenderPassOption(s),t._SetIsAwaitingClear(!1),6291456&~e||(s.depthStencilAttachment={view:this._depthBufferView,depthLoadOp:8388608&e?"clear":"load",depthClearValue:1,depthStoreOp:"store",stencilLoadOp:"clear",stencilClearValue:0,stencilStoreOp:"discard"},this._flags&=-8388609),s}_GetCoplanarStencilRenderPassOpts(){const e=this._flags,t={colorAttachments:[],depthStencilAttachment:{view:this._depthBufferView,depthLoadOp:8388608&e?"clear":"load",depthClearValue:1,depthStoreOp:"store",stencilLoadOp:67108864&e?"clear":"load",stencilClearValue:0,stencilStoreOp:"store"}};return this._MaybeSetTimestampRenderPassOption(t),this._flags&=-75497473,t}_GetCoplanarColorRenderPassOpts(){const e=this._currentRenderTarget,t={colorAttachments:[{view:e._GetTextureView(),loadOp:e._IsAwaitingClear()?"clear":"load",clearValue:e._GetClearColor().toJSON(),storeOp:"store"}],depthStencilAttachment:{view:this._depthBufferView,depthReadOnly:!0,stencilReadOnly:!0}};return this._MaybeSetTimestampRenderPassOption(t),e._SetIsAwaitingClear(!1),t}_MaybeSetTimestampRenderPassOption(e){if(!this.#n)return;const t={querySet:this.#t._GetQuerySet(),endOfPassWriteIndex:this.#d};this.#l.add(this.#d),this.#o.has(this.#a)||(t.beginningOfPassWriteIndex=this.#a,this.#o.add(this.#a),this.#l.add(this.#a)),e.timestampWrites=t}_MaybeDoPendingClearRenderPass(e){e._IsAwaitingClear()&&(this._MaybeEndRenderPass(),this._commandEncoder.beginRenderPass({colorAttachments:[{view:e._GetTextureView(),loadOp:"clear",clearValue:e._GetClearColor().toJSON(),storeOp:"store"}]}).end(),this._flags|=32768,e._SetIsAwaitingClear(!1))}_MaybeEndRenderPass(){null!==this._currentRenderPass&&(this._MaybeEndDrawBatch(),this._currentRenderPass.end(),this._currentRenderPass=null)}EndBatch(e=!1){this._MaybeEndRenderPass(),this.#t&&this.#t.GetQueryCount()>0&&e&&(this.#t.Resolve(this._commandEncoder),this._flags|=32768),32768&this._flags&&(this._commandBuffers.push(this._commandEncoder.finish()),this._CreateCommandEncoder()),0!==this._commandBuffers.length&&(this._WriteBuffers(),this._device.queue.submit(this._commandBuffers),pd.clearArray(this._commandBuffers),this._bufferManager.AfterSubmit())}WaitForSubmittedWorkDone(){return this._device?this._device.queue.onSubmittedWorkDone():Promise.resolve()}_WriteBuffers(){const e=this._device.queue,t=!!(131072&this._flags);this.#s.WriteGPUData(t),this._pointPtr>0&&(e.writeBuffer(this._pointBuffer,0,this._pointData.buffer,0,4*this._pointPtr),this._pointPtr=0);for(const e of this.#h)e!==this.#r&&e.WriteGPUData(t);this.#h.clear()}_UpdateTransformUniform(){this._flags|=1024,this._flags2|=2,this._MarkVertexUniformBufferRangeChanged(this._vertexUniformBufferLayout.transform)}_UpdatePointTexCoordsUniform(){const e=this._vertexUniformBufferLayout.pointTex;this._currentPointTexCoords.writeToTypedArray(this._vertexUniformf32,e.offset/4),this._MarkVertexUniformBufferRangeChanged(e)}_UpdateZElevationUniform(){const e=this._vertexUniformBufferLayout.zElevation;this._vertexUniformf32[e.offset/4]=this._currentVertexZElevation,this._MarkVertexUniformBufferRangeChanged(e)}_MarkVertexUniformBufferRangeChanged(e){const t=e.offset,s=e.end;2048&this._flags?(this._vertexUniformUpdateStart=Math.min(this._vertexUniformUpdateStart,t),this._vertexUniformUpdateEnd=Math.max(this._vertexUniformUpdateEnd,s)):(this._flags|=2048,this._vertexUniformUpdateStart=t,this._vertexUniformUpdateEnd=s,this._MaybeEndRenderPass())}_UpdateColor2Uniform(){this._UpdateFragmentUniformColor(this._currentColor2,this._fragUniformBufferLayout.color2)}_UpdatePointColorUniform(){this._UpdateFragmentUniformColor(this._currentPointColor,this._fragUniformBufferLayout.pointColor)}_UpdateFragmentUniformColor(e,t){e.writeToTypedArray(this._fragUniformf32,t.offset/4),this._MarkFragUniformBufferRangeChanged(t)}_UpdateFragmentUniformVec2(e,t){e.writeToTypedArray(this._fragUniformf32,t.offset/4),this._MarkFragUniformBufferRangeChanged(t)}_MarkFragUniformBufferRangeChanged(e){const t=e.offset,s=e.end;4096&this._flags?(this._fragUniformUpdateStart=Math.min(this._fragUniformUpdateStart,t),this._fragUniformUpdateEnd=Math.max(this._fragUniformUpdateEnd,s)):(this._flags|=4096,this._fragUniformUpdateStart=t,this._fragUniformUpdateEnd=s,this._MaybeEndRenderPass())}_MaybeUpdateFragmentC3ParamsFloat(e,t){this._fragC3Paramsf32[t.offset/4]!==Math.fround(e)&&(this._fragC3Paramsf32[t.offset/4]=e,this._MarkFragC3ParamsRangeChanged(t))}_MaybeUpdateFragmentC3ParamsUint(e,t){this._fragC3Paramsu32[t.offset/4]!==e&&(this._fragC3Paramsu32[t.offset/4]=e,this._MarkFragC3ParamsRangeChanged(t))}_MaybeUpdateFragmentC3ParamsRect(e,t){e.equalsF32Array(this._fragC3Paramsf32,t.offset/4)||(e.writeToTypedArray(this._fragC3Paramsf32,t.offset/4),this._MarkFragC3ParamsRangeChanged(t))}_MarkFragC3ParamsRangeChanged(e){const t=e.offset,s=e.end;8192&this._flags?(this._fragC3ParamsUpdateStart=Math.min(this._fragC3ParamsUpdateStart,t),this._fragC3ParamsUpdateEnd=Math.max(this._fragC3ParamsUpdateEnd,s)):(this._flags|=8192,this._fragC3ParamsUpdateStart=t,this._fragC3ParamsUpdateEnd=s,this._MaybeEndRenderPass())}_WriteUniformBuffers(){const e=this._flags;1024&e&&(gd.multiply(this._matTransform,this._matP,this._matMV),this._vertexUniformf32.set(this._matTransform,this._vertexUniformBufferLayout.transform.offset/4)),2048&e&&this._bufferManager.UpdateBufferSubData(this._commandEncoder,this._vertexUniformBuffer,this._vertexUniformArrayBuffer,this._vertexUniformUpdateStart,this._vertexUniformUpdateEnd-this._vertexUniformUpdateStart),4096&e&&this._bufferManager.UpdateBufferSubData(this._commandEncoder,this._fragmentUniformBuffer,this._fragUniformArrayBuffer,this._fragUniformUpdateStart,this._fragUniformUpdateEnd-this._fragUniformUpdateStart),8192&e&&this._bufferManager.UpdateBufferSubData(this._commandEncoder,this._fragmentC3ParamsBuffer,this._fragC3ParamsArrayBuffer,this._fragC3ParamsUpdateStart,this._fragC3ParamsUpdateEnd-this._fragC3ParamsUpdateStart),this._flags=-15361&e|32768}CreateRenderTarget(e){let t=this._width,s=this._height,i=!0;if(e&&("number"==typeof e.width&&(t=Math.floor(e.width),i=!1),"number"==typeof e.height&&(s=Math.floor(e.height),i=!1)),t<=0||s<=0)throw new Error("invalid size");this.EndBatch();const r=pd.New(pd.Gfx.WebGPURenderTarget,this);return r._Create(t,s,Object.assign({isDefaultSize:i},e)),r}SetRenderTarget(e,t=!0){null===e&&(e=this._backbufferRenderTarget),this._currentRenderTarget!==e&&(this._MaybeEndRenderPass(),this._currentRenderTarget=e,this._SetFlag(4194304,e.HasDepthBuffer()),e.IsDefaultSize()&&!e.IsBackBuffer()&&e._Resize(this._width,this._height),t&&this.SetDefaultRenderTargetProjectionState(),this._currentTexture===e.GetTexture()&&this.SetTexture(null))}InvalidateRenderTarget(e){}GetRenderTarget(){return this._currentRenderTarget===this._backbufferRenderTarget?null:this._currentRenderTarget}GetRenderTargetSize(e){return null===e?[this._width,this._height]:[e.GetWidth(),e.GetHeight()]}GetBackbufferRenderTarget(){return this._backbufferRenderTarget}DeleteRenderTarget(e){this.EndBatch(),this._currentRenderTarget===e&&this.SetRenderTarget(null);const t=e.GetTexture();this._currentTexture===t&&this.SetTexture(null),this._currentBackTexture===t&&this.SetBackTexture(null),e._Delete()}async ReadBackRenderTargetToImageData(e,t,s){this._MaybeDoPendingClearRenderPass(e),this.EndBatch(),null===e&&(e=this._backbufferRenderTarget);const i=this._device,r=e.GetWidth(),n=e.GetHeight();let a=0,o=0,h=r,l=n;if(s){a=pd.clamp(Math.floor(s.getLeft()),0,r-1),o=pd.clamp(Math.floor(s.getTop()),0,n-1);let e=s.width();e=0===e?r-a:pd.clamp(Math.floor(e),0,r-a);let t=s.height();t=0===t?n-o:pd.clamp(Math.floor(t),0,n-o),h=e,l=t}const c=i.createCommandEncoder(),u=e.GetTexture();let d=u._GetTexture(),_=null;"rgba8unorm"===u._GetFormat()?u.CanReadPixels()||pd.NotYetImplemented():(_=this._ConvertTextureFormat(u,"rgba8unorm",c),d=_);const p=4*h,f=256*Math.ceil(p/256),m=i.createBuffer({size:f*l,usage:Gd.MAP_READ|Gd.COPY_DST});c.copyTextureToBuffer({texture:d,origin:[a,o,0]},{buffer:m,bytesPerRow:f},[h,l,1]);const g=c.finish();i.queue.submit([g]),_&&_.destroy(),await m.mapAsync(self.GPUMapMode.READ);const S=m.getMappedRange().slice(0);let G;if(f===p)G=new ImageData(new Uint8ClampedArray(S),h,l);else{const e=new ArrayBuffer(p*l),t=new Uint8Array(e);for(let e=0;e<l;++e){const s=e*f,i=e*p;t.set(new Uint8Array(S,s,p),i)}G=new ImageData(new Uint8ClampedArray(e),h,l)}return m.destroy(),G}_ConvertTextureFormat(e,t,s){const i=this._device,r=e.GetWidth(),n=e.GetHeight();if(e._GetFormat()===t)throw new Error("no conversion necessary");e.IsSampled()||pd.NotYetImplemented();const a=i.createTexture({size:[r,n,1],format:t,usage:Td.COPY_SRC|Td.RENDER_ATTACHMENT}),o=this._mipmapGeneratorProgram._GetMipmapGeneratorPipeline(t),h=o.getBindGroupLayout(0),l=this._GetSampler({sampling:"nearest"}),c=e._GetTexture().createView({baseMipLevel:0,mipLevelCount:1}),u=a.createView({baseMipLevel:0,mipLevelCount:1}),d=s.beginRenderPass({colorAttachments:[{view:u,loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}]}),_=i.createBindGroup({layout:h,entries:[{binding:0,resource:l},{binding:1,resource:c}]});return d.setPipeline(o),d.setBindGroup(0,_),d.draw(4),d.end(),a}SetDepthEnabled(e){1048576&this._flags&&(e=!!e,!!(2097152&this._flags)!==e&&(4194304&this._flags&&this._MaybeEndRenderPass(),this._SetFlag(2097152,e)))}IsDepthEnabled(){return this._IsFlagSet(2097152)}UsesDepthBuffer(){return this._IsFlagSet(1048576)}SetDepthSamplingEnabled(e){if(!this._canSampleDepth)return;if(e&&this.IsDepthEnabled())throw new Error("depth still enabled");const t=e?this._depthBufferBindGroup:this._nullDepthBufferBindGroup;this._currentDepthTextureBindGroup!==t&&(this._MaybeEndDrawBatch(),this._currentDepthTextureBindGroup=t,this._flags|=512)}Clear(e){this._MaybeEndRenderPass(),this._currentRenderTarget._SetIsAwaitingClear(!0),this._currentRenderTarget._GetClearColor().set(e)}ClearRgba(e,t,s,i){this._MaybeEndRenderPass(),this._currentRenderTarget._SetIsAwaitingClear(!0),this._currentRenderTarget._GetClearColor().setRgba(e,t,s,i)}ClearDepth(){5242880&~this._flags||(this._MaybeEndRenderPass(),this._flags|=8388608)}SetScissorRect(e,t,s,i){e=Math.floor(e),t=Math.floor(t),s=Math.floor(s),i=Math.floor(i),4&this._flags&&this._scissorRect.equalsWH(e,t,s,i)||(this._MaybeEndDrawBatch(),this._flags|=12,this._scissorRect.setWH(e,t,s,i))}RemoveScissorRect(){4&this._flags&&(this._MaybeEndDrawBatch(),this._flags&=-5,this._flags|=8)}GetTextureFillShaderProgram(){return 131072&this._flags?this._spTextureFill:this._spSingleTextureFill}SetTextureFillMode(){this.SetProgram(this.GetTextureFillShaderProgram())}SetProgram(e){if(this._currentProgram!==e){if(e===this._spTextureFill&&!(131072&this._flags))throw new Error("cannot set multitexture fill program when multitexturing not allowed");this._MaybeEndDrawBatch(),this._currentProgram=e,this._currentStateGroup=null,this._flags|=64,this._SetMultiTexturingEnabled(e===this._spTextureFill)}}GetProgram(){return this._currentProgram}_SetMultiTexturingEnabled(e){if(e=!!e,!!(262144&this._flags)===e)return;this._SetFlag(262144,e);const t=null===this._currentTexture?this._nullTexture:this._currentTexture;this._ApplyTextureBindGroup(t)}_SetMultiTexturingActive(e){e=!!e,!!(524288&this._flags)!==e&&(this._MaybeEndDrawBatch(),this._SetFlag(524288,e),this._SetFlag(64,!0))}SetNormalizedCoordsProgramVariant(e){e=!!e,!!(1&this._flags2)!==e&&(this._MaybeEndDrawBatch(),this._SetFlag2(1,e),this._flags|=64)}IsNormalizedCoordsProgramVariant(){return this._IsFlagSet2(1)}SetTexture(e){e!==this._currentTexture&&(this._currentTexture=e,null===e&&(e=this._nullTexture),this._ApplyTextureBindGroup(e))}_ApplyTextureBindGroup(e){if(262144&this._flags){const t=e._GetMultiTextureBindGroup();if(null!==t)return this._SetTextureBindGroup(t),this._currentMultiTextureIndex=e._GetMultiTextureIndex(),void this._SetMultiTexturingActive(!0)}this._SetTextureBindGroup(e._GetOwnTextureBindGroup()),this._currentMultiTextureIndex=0,this._SetMultiTexturingActive(!1)}_SetTextureBindGroup(e){e!==this._currentTextureBindGroup&&(this._MaybeEndDrawBatch(),this._currentTextureBindGroup=e,this._flags|=128)}_OnTextureBindGroupChanged(e){this._currentTexture===e&&(this._MaybeEndDrawBatch(),this._currentTextureBindGroup=e._GetOwnTextureBindGroup(),this._flags|=128)}_OnMultiTextureBindGroupReleased(e){if(this._currentTextureBindGroup!==e)return;this._MaybeEndDrawBatch();const t=null===this._currentTexture?this._nullTexture:this._currentTexture;this._currentTextureBindGroup=t._GetOwnTextureBindGroup(),this._currentMultiTextureIndex=0,this._flags|=128}SetBackTexture(e){e!==this._currentBackTexture&&(this._currentBackTexture=e,null===e&&(e=this._nullTexture),this._MaybeEndDrawBatch(),this._currentBackTextureBindGroup=e._GetBackTextureBindGroup(),this._flags|=256)}CopyTextureToTexture(e,t,s,i,r,n){const a=e._GetUsage(),o=t._GetUsage();if(0===(a&Td.COPY_SRC))throw new Error("source texture missing COPY_SRC usage");if(0===(o&Td.COPY_DST))throw new Error("destination texture missing COPY_DST usage");if(e===t)throw new Error("invalid destination");const h=Math.min(e.GetWidth(),t.GetWidth()),l=Math.min(e.GetHeight(),t.GetHeight());r=Math.min(r,h-s),n=Math.min(n,l-i),r<=0||n<=0||(this._MaybeEndRenderPass(),this._commandEncoder.copyTextureToTexture({texture:e._GetTexture(),origin:[s,i]},{texture:t._GetTexture(),origin:[s,i]},[r,n]),this._flags|=32768)}_ClampToSupportedMultisampleValues(e){return e>=2?4:1}SetRenderingToMultisampleCount(e){e=this._ClampToSupportedMultisampleValues(e),this._currentMultisampleCount!==e&&(this._MaybeEndDrawBatch(),this._currentMultisampleCount=e,this._flags|=64)}SetBlendMode(e){e!==this._currentBlendMode&&(this._MaybeEndDrawBatch(),this._currentBlendMode=e,this._currentStateGroup=null,this._flags|=64)}SetNamedBlendMode(e){this.SetBlendMode(this.NamedBlendToNumber(e))}SetAlphaBlend(){this.SetBlendMode(0)}SetCopyBlend(){this.SetBlendMode(3)}SetColorRgba(e,t,s,i){const r=this._currentColor;r.equalsRgba(e,t,s,i)||(r.setRgba(e,t,s,i),this._currentStateGroup=null)}SetOpacity(e){const t=this._currentColor;t.getA()!==e&&(t.setA(e),this._currentStateGroup=null)}GetOpacity(){return this._currentColor.getA()}SetColor(e){const t=this._currentColor;t.equals(e)||(t.set(e),this._currentStateGroup=null)}ResetColor(){this.SetColorRgba(1,1,1,1)}GetColor(){return this._currentColor}SetCullFaceMode(e){e!==this._currentCullFace&&(this._MaybeEndDrawBatch(),this._currentCullFace=e,this._currentStateGroup=null,this._flags|=64)}GetCullFaceMode(){return this._currentCullFace}SetFrontFaceWinding(e){e!==this._currentFrontFaceWinding&&(this._MaybeEndDrawBatch(),this._currentFrontFaceWinding=e,this._currentStateGroup=null,this._flags|=64)}GetFrontFaceWinding(){return this._currentFrontFaceWinding}Rect(e){this.Rect2(e.getLeft(),e.getTop(),e.getRight(),e.getBottom())}Rect2(e,t,s,i){this.Quad2(e,t,s,t,s,i,e,i)}Quad(e){this.Quad4(e,u_)}Quad2(e,t,s,i,r,n,a,o){this.#g(4,6);const h=this.#s.WriteQuad2(this._baseZ+this._currentZ,e,t,s,i,r,n,a,o);524288&this._flags&&this.#s.WriteTexIndicesForQuad(h,this._currentMultiTextureIndex)}Quad3(e,t){this.#g(4,6);const s=this.#s.WriteQuad3(this._baseZ+this._currentZ,e,t);524288&this._flags&&this.#s.WriteTexIndicesForQuad(s,this._currentMultiTextureIndex)}Quad4(e,t){this.#g(4,6);const s=this.#s.WriteQuad4(this._baseZ+this._currentZ,e,t);524288&this._flags&&this.#s.WriteTexIndicesForQuad(s,this._currentMultiTextureIndex)}Quad5(e,t,s){this.#g(4,6);const i=this.#s.WriteQuad5(this._baseZ+this._currentZ,e,t,s);524288&this._flags&&this.#s.WriteTexIndicesForQuad(i,this._currentMultiTextureIndex)}Quad3D(e,t,s,i,r,n,a,o,h,l,c,u,d){this.#g(4,6);const _=this.#s.WriteQuad3D(this._baseZ+this._currentZ,e,t,s,i,r,n,a,o,h,l,c,u,d);524288&this._flags&&this.#s.WriteTexIndicesForQuad(_,this._currentMultiTextureIndex)}Quad3D2(e,t,s,i,r,n,a,o,h,l,c,u,d){this.#g(4,6);const _=this.#s.WriteQuad3D2(this._baseZ+this._currentZ,e,t,s,i,r,n,a,o,h,l,c,u,d);524288&this._flags&&this.#s.WriteTexIndicesForQuad(_,this._currentMultiTextureIndex)}Quad3D3(e,t,s,i,r,n,a,o,h,l,c,u,d,_){this.#g(4,6);const p=this.#s.WriteQuad3D3(this._baseZ+this._currentZ,e,t,s,i,r,n,a,o,h,l,c,u,d,_);524288&this._flags&&this.#s.WriteTexIndicesForQuad(p,this._currentMultiTextureIndex)}CreateMeshData(e,t,s){s=Object.assign({},s,{texIndices:!0});const i=new pd.Gfx.MeshDataWebGPU(this,e,t,s);return this.#e.add(i),i}_ReleaseMeshData(e){this.EndBatch(),this.#e.delete(e)}DrawMesh(e,t,s,i){const r=pd.Gfx.DynamicMeshData.GetMaxVertices(),n=pd.Gfx.DynamicMeshData.GetMaxIndices();if(e.length%3!=0)throw new Error("vertex buffer length not multiple of 3");if(e.length>3*r)throw new Error(`too many vertices (${e.length/3}, limit ${r})`);if(s.length%3!=0)throw new Error("index buffer length not multiple of 3");if(s.length>n)throw new Error(`too many indices (${s.length}, limit ${n})`);this.#g(e.length,s.length);const a=this.#s.WriteMesh(e,t,s,i);524288&this._flags&&this.#s.FillTexIndices(a,Math.floor(e.length/3),this._currentMultiTextureIndex)}DrawMeshData(e,t=0,s=e.GetIndexCount()){if(e.IsSmall())if(0===t&&s===e.GetIndexCount()){this.#g(e.GetVertexCount(),e.GetIndexCount());const t=this.#s.WriteMesh(e.positions,e.texCoords,e.indices,e.colors);524288&this._flags&&this.#s.FillTexIndices(t,e.GetVertexCount(),this._currentMultiTextureIndex)}else{const{minIndex:i,maxIndex:r}=pd.Gfx.DynamicMeshData.CalculatePartialIndexRange(e.indices,t,s),n=i,a=r+1,o=a-n;this.#g(o,s);const h=this.#s.WriteMesh(e.positions.subarray(3*n,3*a),e.texCoords.subarray(2*n,2*a),e.indices.subarray(t,t+s),e.colors.subarray(4*n,4*a),i);524288&this._flags&&this.#s.FillTexIndices(h,o,this._currentMultiTextureIndex)}else 524288&this._flags&&e.FillTexIndices(this._currentMultiTextureIndex),this.#m(e),this.#h.add(e),null===this._currentRenderPass&&this._BeginRenderPass(),this._flags|=1,this._drawFirstIndex=t,this._drawIndexCount=s,this._MaybeEndDrawBatch()}#v(){this.#m(this.#r)}#m(e){this.#i!==e&&(this._MaybeEndDrawBatch(),this.#i=e,this._flags|=32)}_GetCurrentMeshData(){return this.#i}StartRenderingPoints(e){this._currentPointTexCoords.equals(e)||(this._currentPointTexCoords.copy(e),this._UpdatePointTexCoordsUniform());const t=this._baseZ+this._currentZ;this._currentVertexZElevation!==t&&(this._currentVertexZElevation=t,this._UpdateZElevationUniform()),this._currentPointColor.equals(this._currentColor)||(this._currentPointColor.copy(this._currentColor),this._UpdatePointColorUniform()),this.SetProgram(this.GetPointsRenderingProgram()),this._drawIndexCount=0,this._flags|=34}FinishRenderingPoints(){this._drawIndexCount>0&&this._MaybeEndDrawBatch(),this._flags&=-3,this._flags|=32}Point(e,t,s,i){let r=this._pointPtr;r>65520&&(this.EndBatch(),r=0),1&this._flags?this._drawIndexCount+=6:(null===this._currentRenderPass&&this._BeginRenderPass(),this._flags|=1,this._drawFirstIndex=r/4*6,this._drawIndexCount=6);const n=this._pointData;n[r++]=e,n[r++]=t,n[r++]=s,n[r++]=i,this._pointPtr=r}SetGradientColor(e){this._currentColor2.equals(e)||(this._currentColor2.copy(e),this._UpdateColor2Uniform())}SetEllipseParams(e,t,s=1){const i=this._fragUniformBufferLayout,r=this._fragUniformf32;d_.set(e,t),d_.equalsF32Array(r,i.pixelSize.offset/4)||this._UpdateFragmentUniformVec2(d_,i.pixelSize),r[i.outlineThickness.offset/4]!==Math.fround(s)&&(r[i.outlineThickness.offset/4]=s,this._MarkFragUniformBufferRangeChanged(i.outlineThickness))}SetTilemapInfo(e,t,s,i,r,n,a){const o=this._fragUniformBufferLayout,h=this._fragUniformf32;e.equalsF32Array(h,o.srcRect.offset/4)||(e.writeToTypedArray(h,o.srcRect.offset/4),this._MarkFragUniformBufferRangeChanged(o.srcRect)),d_.set(i/t,r/s),d_.equalsF32Array(h,o.tileSize.offset/4)||this._UpdateFragmentUniformVec2(d_,o.tileSize),d_.set(n/t,a/s),d_.equalsF32Array(h,o.tileSpacing.offset/4)||this._UpdateFragmentUniformVec2(d_,o.tileSpacing)}SetTileRandomizationInfo(e,t,s,i,r,n,a){const o=this._fragUniformBufferLayout,h=this._fragUniformf32;d_.set(s,i),d_.equalsF32Array(h,o.tileSize.offset/4)||this._UpdateFragmentUniformVec2(d_,o.tileSize),h[o.outlineThickness.offset/4]!==Math.fround(r)&&(h[o.outlineThickness.offset/4]=r,this._MarkFragUniformBufferRangeChanged(o.outlineThickness)),d_.set(n,a),d_.equalsF32Array(h,o.tileSpacing.offset/4)||this._UpdateFragmentUniformVec2(d_,o.tileSpacing)}SetProgramParameters(e,t,s,i,r,n,a,o,h,l,c){const u=this._fragC3ParamsLayout,d=this._currentProgram;c%=10800,d.BlendsBackground()&&this.SetBackTexture(e),d.UsesAnyC3ParamRect()&&(this._MaybeUpdateFragmentC3ParamsRect(t,u.destRect),this._MaybeUpdateFragmentC3ParamsRect(s,u.srcRect),this._MaybeUpdateFragmentC3ParamsRect(i,u.srcOriginRect),this._MaybeUpdateFragmentC3ParamsRect(r,u.layoutRect)),this._MaybeUpdateFragmentC3ParamsFloat(o,u.devicePixelRatio),this._MaybeUpdateFragmentC3ParamsFloat(h,u.layerScale),this._MaybeUpdateFragmentC3ParamsFloat(l,u.layerAngle),this._MaybeUpdateFragmentC3ParamsFloat(c,u.seconds),this._MaybeUpdateFragmentC3ParamsFloat(this.GetNearZ(),u.zNear),this._MaybeUpdateFragmentC3ParamsFloat(this.GetFarZ(),u.zFar)}SetProgramCustomParameters(e){e&&(e.IsChanged()&&(this._MaybeEndRenderPass(),e.UpdateBuffer(this._commandEncoder)),this._SetBufferBindGroup(e.GetBufferBindGroup()))}SetProgramParameter_IsSrcTexRotated(e){this._MaybeUpdateFragmentC3ParamsUint(e?1:0,this._fragC3ParamsLayout.isSrcTexRotated)}_SetBufferBindGroup(e){e!==this._currentBufferBindGroup&&(this._MaybeEndDrawBatch(),this._currentBufferBindGroup=e,this._flags|=16384)}_OnBufferBindGroupDestroyed(e){this._currentBufferBindGroup===e&&this._SetBufferBindGroup(this._defaultBufferBindGroup)}CopyRenderTarget(e){if(e._IsAwaitingClear())return this._currentRenderTarget._SetIsAwaitingClear(!0),void this._currentRenderTarget._GetClearColor().set(e._GetClearColor());e.GetMultisampling()>=2&&this._currentRenderTarget.GetMultisampling()<2?this._ResolveMultisampledRenderTarget(e):(this.ClearRgba(0,0,0,0),this.SetCopyBlend(),this.ResetColor(),this.DrawRenderTarget(e))}DrawRenderTarget(e){this._MaybeDoPendingClearRenderPass(e);const t=e.GetTexture();this.SetTexture(t),this.FullscreenQuad()}FullscreenQuad(){const e=this.IsNormalizedCoordsProgramVariant();e||this.SetNormalizedCoordsProgramVariant(!0),this.SetCurrentZ(0);const t=f_,s=__;t.set(0,-1,0,-1,2,1,0,1),s.set(0,-1,2,1),this.Quad3(t,s),e||this.SetNormalizedCoordsProgramVariant(!1)}_ResolveMultisampledRenderTarget(e){this._MaybeDoPendingClearRenderPass(e),this._MaybeEndRenderPass(),this._commandEncoder.beginRenderPass({colorAttachments:[{view:e.GetTexture()._GetTextureView(),resolveTarget:this._currentRenderTarget.GetTexture()._GetTextureView(),loadOp:"load",storeOp:"store"}]}).end(),this._flags|=32768}CoplanarStartStencilPass(){this._MaybeEndRenderPass(),this.SetDepthEnabled(!0),this._flags|=83886080}CoplanarStartColorPass(e=!1){this._MaybeEndRenderPass(),this.SetDepthEnabled(e),this._flags&=-16777217,this._flags|=33554432}IsCoplanarColorPass(){return this._IsFlagSet(33554432)}CoplanarRestoreStandardRendering(e=!0){this._MaybeEndRenderPass(),this.SetDepthEnabled(e),this._flags&=-33554433}_InitBlendModes(){this._InitBlendModeData([["normal",["one","one-minus-src-alpha"]],["additive",["one","one"]],["xor",["one","one-minus-src-alpha"]],["copy",["one","zero"]],["destination-over",["one-minus-dst-alpha","one"]],["source-in",["dst-alpha","zero"]],["destination-in",["zero","src-alpha"]],["source-out",["one-minus-dst-alpha","zero"]],["destination-out",["zero","one-minus-src-alpha"]],["source-atop",["dst-alpha","one-minus-src-alpha"]],["destination-atop",["one-minus-dst-alpha","src-alpha"]],["lighten",["one","one","one","one","max","max"]],["darken",["one","one","one","one","min","min"]],["multiply",["dst","one-minus-src-alpha","one","one-minus-src-alpha"]],["screen",["one","one-minus-src","one","one-minus-src-alpha"]]])}GetAvailableAdapterFeatures(){return this._adapter?[...this._adapter.features]:[]}GetAdapterInfo(){return this._adapterInfo}GetAdapterInfoString(){const e=this._adapterInfo;if(!e)return"unknown/unknown";const t=e.vendor||"unknown",s=e.architecture||"unknown",i=[];return e.device&&i.push(e.device),e.description&&i.push(e.description),e.type&&i.push(e.type),e.backend&&i.push(e.backend),t+"/"+s+(i.length>0?` (${i.join(", ")})`:"")}}}{const m_=self.C3,g_=!0;m_.Gfx.WebGPUBufferManager=class{constructor(e){this._renderer=e,this._buffers=new Map,this._recycleAfterSubmit=[],this._releaseAfterSubmit=[],this._destroyAfterSubmit=[],this._totalBufferCount=0,this._totalBufferSize=0,this._totalCreated=0,this._totalReleased=0,this._totalReturned=0,this._totalRecycled=0}GetRenderer(){return this._renderer}OnContextLost(){this._buffers.clear(),m_.clearArray(this._recycleAfterSubmit),m_.clearArray(this._releaseAfterSubmit),m_.clearArray(this._destroyAfterSubmit)}_RoundBufferSizeClass(e){return Math.max(m_.nextHighestPowerOfTwo(e),16)}GetRecyclableBuffer(e){this._totalReturned++;const t=this._RoundBufferSizeClass(e);{const e=this._buffers.get(t);if(void 0!==e&&e.length>0){const s=e.pop();return s.MarkInUse(),0===e.length&&this._buffers.delete(t),s}}return this._totalBufferCount++,this._totalBufferSize+=t,this._totalCreated++,m_.New(m_.Gfx.WebGPURecyclableBuffer,this,t)}_AddRecycledBuffer(e){this._totalRecycled++;const t=e.GetSize(),s=this._buffers.get(t);void 0===s?this._buffers.set(t,[e]):s.push(e)}_DestroyAfterSubmit(e){this._destroyAfterSubmit.push(e)}AfterSubmit(){for(const e of this._recycleAfterSubmit)e.Recycle();m_.clearArray(this._recycleAfterSubmit);for(const e of this._releaseAfterSubmit)this._totalBufferCount--,this._totalBufferSize-=e.GetSize(),e.Release();m_.clearArray(this._releaseAfterSubmit);for(const e of this._destroyAfterSubmit)e.destroy();m_.clearArray(this._destroyAfterSubmit)}MaybeCollectUnusedBuffers(e){e%30==0&&this._CollectUnusedBuffers(e)}_CollectUnusedBuffers(e){for(const[t,s]of this._buffers.entries()){let i=0;for(let t=0,r=s.length;t<r;++t){const r=s[t];r._ShouldCollect(e)?(this._totalBufferCount--,this._totalBufferSize-=r.GetSize(),r.Release(),this._totalReleased++):(s[i]=r,++i)}0===i?this._buffers.delete(t):m_.truncateArray(s,i)}this._DebugLogBufferMap()}UpdateBufferSubData(e,t,s,i,r){const n=this.GetRecyclableBuffer(r),a=n.GetBuffer(),o=a.getMappedRange(0,r);new Uint8Array(o).set(new Uint8Array(s,i,r)),a.unmap(),e.copyBufferToBuffer(a,0,t,i,r),this._recycleAfterSubmit.push(n)}_DebugLogBufferMap(){this._totalCreated=0,this._totalReleased=0,this._totalReturned=0,this._totalRecycled=0}}}{const S_=self.C3,G_=self.GPUBufferUsage,y_=self.GPUMapMode,I_=self.assert,T_=0,C_=1,b_=2;S_.Gfx.WebGPURecyclableBuffer=class{constructor(e,t){this._bufferManager=e,this._state=1,this._size=t,this._buffer=this.GetRenderer()._GetDevice().createBuffer({mappedAtCreation:!0,size:t,usage:G_.COPY_SRC|G_.MAP_WRITE}),this._recycledFrameNumber=0}GetRenderer(){return this._bufferManager.GetRenderer()}GetState(){return this._state}GetSize(){return this._size}GetBuffer(){return this._buffer}MarkInUse(){this._state=1}async Recycle(){this._state=2;try{await this._buffer.mapAsync(y_.WRITE)}catch(e){return void console.warn("[WebGPU] Error recycling buffer, assuming device was lost: ",e)}this.GetRenderer().IsContextLost()||(this._state=0,this._recycledFrameNumber=this.GetRenderer().GetFrameNumber(),this._bufferManager._AddRecycledBuffer(this))}Discard(){this._state=0}_ShouldCollect(e){return this._recycledFrameNumber<=e-25}Release(){this._buffer.destroy(),this._buffer=null,this._bufferManager=null}}}{const x_=self.C3,w_=self.assert,P_=self.GPUBufferUsage;x_.Gfx.WebGPUEffectCustomParamsBuffer=class{constructor(e){const t=e.GetRenderer();this._shaderProgram=e,this._byteSize=e.GetCustomParametersByteSize(),this._arrayBuffer=new ArrayBuffer(this._byteSize),this._f32arr=new Float32Array(this._arrayBuffer),this._isChanged=!1,this._buffer=t._GetDevice().createBuffer({size:this._byteSize,usage:P_.UNIFORM|P_.COPY_DST}),this._bufferBindGroup=t._CreateBufferBindGroup(this._buffer)}Release(){this.GetRenderer()._OnBufferBindGroupDestroyed(this._bufferBindGroup),this.GetRenderer().GetBufferManager()._DestroyAfterSubmit(this._buffer),this._buffer=null,this._shaderProgram=null,this._arrayBuffer=null,this._f32arr=null,this._bufferBindGroup=null}GetRenderer(){return this._shaderProgram.GetRenderer()}GetShaderProgram(){return this._shaderProgram}GetBufferBindGroup(){return this._bufferBindGroup}SetParameterValue(e,t){const s=this._shaderProgram._GetCustomParameterInfo(e),i=s.type,r=s.offset/4,n=this._f32arr;if("color"===i){if(t.equalsRGBF32Array(n,r))return;t.writeRGBToTypedArray(n,r),this._isChanged=!0}else{if("float"!==i&&"percent"!==i)throw new Error(`unexpected shader param type '${i}'`);if(n[r]===Math.fround(t))return;n[r]=t,this._isChanged=!0}}IsChanged(){return this._isChanged}UpdateBuffer(e){this.GetRenderer().GetBufferManager().UpdateBufferSubData(e,this._buffer,this._arrayBuffer,0,this._byteSize),this._isChanged=!1}}}{let R_=function(e){for(const t of Object.values(e))t.end=t.offset+t.size},v_=function(e){const t=[];for(let s=0;s<e;++s)t.push(null);return t},A_=function(e){return`\nstruct FragmentInput {\n\t@location(1) fragUV : vec2<f32>,\n\t@location(2) fragColor : vec4<${e?"f16":"f32"}>,\n\t@builtin(position) fragPos : vec4<f32>\n};\n\nfn c3_getBackUV(fragPos : vec2<f32>, texBack : texture_2d<f32>) -> vec2<f32>\n{\n\treturn fragPos / vec2<f32>(textureDimensions(texBack));\n}\n\nfn c3_getDepthUV(fragPos : vec2<f32>, texDepth : texture_depth_2d) -> vec2<f32>\n{\n\treturn fragPos / vec2<f32>(textureDimensions(texDepth));\n}\n`},M_=function(e,t,s,i,r){return e<<10|t<<7|s<<5|i<<4|r};UpdateLayoutEndValues=R_,makeNullFilledArray=v_,GetFragmentInputStructDeclaration=A_,HashPipelineState=M_;const D_=self.C3,E_=4,F_=2,O_=4,B_=8,k_=16,L_=64,N_="\nstruct Uniforms {\n\ttransform\t\t: mat4x4<f32>,\n\tpointTexStart\t: vec2<f32>,\n\tpointTexEnd\t\t: vec2<f32>,\n\tzElevation\t\t: f32\n};\n@binding(0) @group(0) var<uniform> uniforms : Uniforms;\n",W_={transform:{offset:0,size:64,end:0},pointTex:{offset:64,size:16,end:0},pointTexStart:{offset:64,size:8,end:0},pointTexEnd:{offset:72,size:8,end:0},zElevation:{offset:80,size:4,end:0}};R_(W_);const U_=W_.zElevation.end,V_="\nstruct Uniforms {\n\tcolor2\t\t\t\t: vec4<f32>,\n\tpointColor \t\t\t: vec4<f32>,\n\ttileSize\t\t\t: vec2<f32>,\n\ttileSpacing\t\t\t: vec2<f32>,\n\tsrcRectStart\t\t: vec2<f32>,\n\tsrcRectEnd\t\t\t: vec2<f32>,\n\tpixelSize\t\t\t: vec2<f32>,\n\toutlineThickness\t: f32\n};\n@binding(1) @group(0) var<uniform> uniforms : Uniforms;\n",H_={color2:{offset:0,size:16,end:0},pointColor:{offset:16,size:16,end:0},tileSize:{offset:32,size:8,end:0},tileSpacing:{offset:40,size:8,end:0},srcRect:{offset:48,size:16,end:0},srcRectStart:{offset:48,size:8,end:0},srcRectEnd:{offset:56,size:8,end:0},pixelSize:{offset:64,size:8,end:0},outlineThickness:{offset:72,size:4,end:0}};R_(H_);const j_=H_.outlineThickness.end,z_="\nstruct C3Params {\n\tsrcStart\t\t\t: vec2<f32>,\n\tsrcEnd\t\t\t\t: vec2<f32>,\n\tsrcOriginStart\t\t: vec2<f32>,\n\tsrcOriginEnd\t\t: vec2<f32>,\n\tlayoutStart\t\t\t: vec2<f32>,\n\tlayoutEnd\t\t\t: vec2<f32>,\n\tdestStart\t\t\t: vec2<f32>,\n\tdestEnd\t\t\t\t: vec2<f32>,\n\tdevicePixelRatio\t: f32,\n\tlayerScale\t\t\t: f32,\n\tlayerAngle\t\t\t: f32,\n\tseconds\t\t\t\t: f32,\n\tzNear\t\t\t\t: f32,\n\tzFar\t\t\t\t: f32,\n\tisSrcTexRotated\t\t: u32\n};\n@binding(4) @group(0) var<uniform> c3Params : C3Params;\n\nfn c3_srcToNorm(p : vec2<f32>) -> vec2<f32>\n{\n\treturn (p - c3Params.srcStart) / (c3Params.srcEnd - c3Params.srcStart);\n}\n\nfn c3_normToSrc(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p, c3Params.srcEnd - c3Params.srcStart, c3Params.srcStart);\n}\n\nfn c3_clampToSrc(p : vec2<f32>) -> vec2<f32>\n{\n\treturn clamp(p, min(c3Params.srcStart, c3Params.srcEnd), max(c3Params.srcStart, c3Params.srcEnd));\n}\n\nfn c3_srcOriginToNorm(p : vec2<f32>) -> vec2<f32>\n{\n\treturn (p - c3Params.srcOriginStart) / (c3Params.srcOriginEnd - c3Params.srcOriginStart);\n}\n\nfn c3_normToSrcOrigin(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p, c3Params.srcOriginEnd - c3Params.srcOriginStart, c3Params.srcOriginStart);\n}\n\nfn c3_clampToSrcOrigin(p : vec2<f32>) -> vec2<f32>\n{\n\treturn clamp(p, min(c3Params.srcOriginStart, c3Params.srcOriginEnd), max(c3Params.srcOriginStart, c3Params.srcOriginEnd));\n}\n\nfn c3_getLayoutPos(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p - c3Params.srcOriginStart, (c3Params.layoutEnd - c3Params.layoutStart) / (c3Params.srcOriginEnd - c3Params.srcOriginStart), c3Params.layoutStart);\n}\n\nfn c3_srcToDest(p : vec2<f32>) -> vec2<f32>\n{\n\treturn fma(p - c3Params.srcStart, (c3Params.destEnd - c3Params.destStart) / (c3Params.srcEnd - c3Params.srcStart), c3Params.destStart);\n}\n\nfn c3_clampToDest(p : vec2<f32>) -> vec2<f32>\n{\n\treturn clamp(p, min(c3Params.destStart, c3Params.destEnd), max(c3Params.destStart, c3Params.destEnd));\n}\n\nfn c3_linearizeDepth(depthSample : f32) -> f32\n{\n\treturn c3Params.zNear * c3Params.zFar / (c3Params.zFar + depthSample * (c3Params.zNear - c3Params.zFar));\n}\n",X_=["srcStart","srcEnd","srcOriginStart","srcOriginEnd","c3_srcToNorm","c3_normToSrc","c3_clampToSrc","c3_srcOriginToNorm","c3_normToSrcOrigin","c3_clampToSrcOrigin","c3_getLayoutPos","c3_srcToDest"],Y_=["layoutStart","layoutEnd","destStart","destEnd","c3_clampToDest"],q_={srcRect:{offset:0,size:16,end:0},srcStart:{offset:0,size:8,end:0},srcEnd:{offset:8,size:8,end:0},srcOriginRect:{offset:16,size:16,end:0},srcOriginStart:{offset:16,size:8,end:0},srcOriginEnd:{offset:24,size:8,end:0},layoutRect:{offset:32,size:16,end:0},layoutStart:{offset:32,size:8,end:0},layoutEnd:{offset:40,size:8,end:0},destRect:{offset:48,size:16,end:0},destStart:{offset:48,size:8,end:0},destEnd:{offset:56,size:8,end:0},devicePixelRatio:{offset:64,size:4,end:0},layerScale:{offset:68,size:4,end:0},layerAngle:{offset:72,size:4,end:0},seconds:{offset:76,size:4,end:0},zNear:{offset:80,size:4,end:0},zFar:{offset:84,size:4,end:0},isSrcTexRotated:{offset:88,size:4,end:0}};R_(q_);const K_=q_.isSrcTexRotated.end,$_="\nstruct FragmentOutput {\n\t@location(0) color : vec4<f32>\n};\n",J_=new Map([["float",4],["percent",4],["color",12]]),Z_=new Map([["float",4],["percent",4],["color",16]]),Q_="\nfn c3_premultiply(c : vec4<f32>) -> vec4<f32>\n{\n\treturn vec4<f32>(c.rgb * c.a, c.a);\n}\n\nfn c3_unpremultiply(c : vec4<f32>) -> vec4<f32>\n{\n\tif (c.a == 0.0)\n\t{\n\t\treturn vec4<f32>(0.0);\n\t}\n\t\n\treturn vec4<f32>(c.rgb / c.a, c.a);\n}\n\nfn c3_grayscale(rgb : vec3<f32>) -> f32\n{\n\treturn dot(rgb, vec3<f32>(0.299, 0.587, 0.114));\n}\n\nfn c3_getPixelSize(t : texture_2d<f32>) -> vec2<f32>\n{\n\treturn vec2<f32>(1.0) / vec2<f32>(textureDimensions(t));\n}\n\nfn c3_clamp2(v : vec2<f32>, l : f32, u : f32) -> vec2<f32>\n{\n\treturn clamp(v, vec2<f32>(l), vec2<f32>(u));\n}\n\nfn c3_mod(x : f32, y : f32) -> f32\n{\n\treturn x - y * floor(x / y);\n}\n\nfn c3_mod2(x : vec2<f32>, y : vec2<f32>) -> vec2<f32>\n{\n\treturn x - y * floor(x / y);\n}\n\nfn c3_RGBtoHSL(color : vec3<f32>) -> vec3<f32>\n{\n\tvar hsl : vec3<f32> = vec3<f32>(0.0);\n\t\n\tvar fmin : f32 = min(min(color.r, color.g), color.b);\n\tvar fmax : f32 = max(max(color.r, color.g), color.b);\n\tvar delta : f32 = fmax - fmin;\n\n\thsl.z = (fmax + fmin) / 2.0;\n\n\tif (delta == 0.0)\n\t{\n\t\thsl.x = 0.0;\n\t\thsl.y = 0.0;\n\t}\n\telse \n\t{\n\t\tif (hsl.z < 0.5)\n\t\t{\n\t\t\thsl.y = delta / (fmax + fmin);\n\t\t}\n\t\telse\n\t\t{\n\t\t\thsl.y = delta / (2.0 - fmax - fmin);\n\t\t}\n\t\t\n\t\tvar dR : f32 = (((fmax - color.r) / 6.0) + (delta / 2.0)) / delta;\n\t\tvar dG : f32 = (((fmax - color.g) / 6.0) + (delta / 2.0)) / delta;\n\t\tvar dB : f32 = (((fmax - color.b) / 6.0) + (delta / 2.0)) / delta;\n\n\t\tif (color.r == fmax)\n\t\t{\n\t\t\thsl.x = dB - dG;\n\t\t}\n\t\telse if (color.g == fmax)\n\t\t{\n\t\t\thsl.x = (1.0 / 3.0) + dR - dB;\n\t\t}\n\t\telse if (color.b == fmax)\n\t\t{\n\t\t\thsl.x = (2.0 / 3.0) + dG - dR;\n\t\t}\n\n\t\tif (hsl.x < 0.0)\n\t\t{\n\t\t\thsl.x = hsl.x + 1.0;\n\t\t}\n\t\telse if (hsl.x > 1.0)\n\t\t{\n\t\t\thsl.x = hsl.x - 1.0;\n\t\t}\n\t}\n\n\treturn hsl;\n}\n\nfn c3_hueToRGB(f1 : f32, f2 : f32, hue_ : f32) -> f32\n{\n\tvar hue : f32 = hue_;\n\tif (hue < 0.0)\n\t{\n\t\thue = hue + 1.0;\n\t}\n\telse if (hue > 1.0)\n\t{\n\t\thue = hue - 1.0;\n\t}\n\t\t\n\tvar ret : f32;\n\t\n\tif ((6.0 * hue) < 1.0)\n\t{\n\t\tret = f1 + (f2 - f1) * 6.0 * hue;\n\t}\n\telse if ((2.0 * hue) < 1.0)\n\t{\n\t\tret = f2;\n\t}\n\telse if ((3.0 * hue) < 2.0)\n\t{\n\t\tret = f1 + (f2 - f1) * ((2.0 / 3.0) - hue) * 6.0;\n\t}\n\telse\n\t{\n\t\tret = f1;\n\t}\n\t\n\treturn ret;\n}\n\nfn c3_HSLtoRGB(hsl : vec3<f32>) -> vec3<f32>\n{\n\tvar rgb : vec3<f32> = vec3<f32>(hsl.z);\n\t\n\tif (hsl.y != 0.0)\n\t{\n\t\tvar f2 : f32;\n\t\t\n\t\tif (hsl.z < 0.5)\n\t\t{\n\t\t\tf2 = hsl.z * (1.0 + hsl.y);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tf2 = (hsl.z + hsl.y) - (hsl.y * hsl.z);\n\t\t}\n\t\t\t\n\t\tvar f1 : f32 = 2.0 * hsl.z - f2;\n\t\t\n\t\trgb.r = c3_hueToRGB(f1, f2, hsl.x + (1.0 / 3.0));\n\t\trgb.g = c3_hueToRGB(f1, f2, hsl.x);\n\t\trgb.b = c3_hueToRGB(f1, f2, hsl.x - (1.0 / 3.0));\n\t}\n\t\n\treturn rgb;\n}\n";D_.Gfx.WebGPUShaderProgram=class extends D_.Gfx.ShaderProgramBase{constructor(e,t){if(super(e,t),this._fragmentModule=t.fragmentModule,this._fragmentModuleFragDepth=t.fragmentModuleFragDepth,this._vertexModule=t.vertexModule,this._normVertexModule=t.normVertexModule,this._renderPipelineMap=new Map,this._mipmapPipelineMap=new Map,this._usesAnyC3ParamRect=!1,this._usesIsSrcTexRotated=!1,this._parameters=[],this._customParamsByteSize=0,t.parameters){let e=0;for(const s of t.parameters){const t=s[2];if(!J_.has(t))throw new Error(`unrecognized effect param type '${t}'`);const i=J_.get(t),r=Z_.get(t),n=e%r;0!==n&&(e+=r-n),this._parameters.push({type:t,offset:e,size:i,end:e+i}),e+=i}this._customParamsByteSize=16*Math.ceil(e/16)}}static async Create(e,t){const s=e._GetDevice(),i=t.name,r=e.SupportsF16(),n=e.IsColorDataF16(),a=t.src,o=D_.Gfx.WebGPUShaderProgram._PreprocessFragmentShaderCode(a,r,n),h=s.createShaderModule({label:i,code:o});let l,c=null;if(t.srcFragDepth){const e=D_.Gfx.WebGPUShaderProgram._PreprocessFragmentShaderCode(t.srcFragDepth,r,n);c=s.createShaderModule({label:i,code:e})}h.getCompilationInfo().then(e=>D_.Gfx.WebGPUShaderProgram.ReportShaderCompilationInfo(i,"fragment",e));const u=D_.Gfx.WebGPUShaderProgram._PreprocessVertexShaderCode(t.vertexSrc,r);let d;u?(l=s.createShaderModule({label:i,code:u}),l.getCompilationInfo().then(e=>D_.Gfx.WebGPUShaderProgram.ReportShaderCompilationInfo(i,"vertex",e))):l=e._GetDefaultVertexModule();const _=D_.Gfx.WebGPUShaderProgram._PreprocessVertexShaderCode(t.normVertexSrc,r);_?(d=s.createShaderModule({label:i,code:_}),d.getCompilationInfo().then(e=>D_.Gfx.WebGPUShaderProgram.ReportShaderCompilationInfo(i,"vertex (norm)",e))):d=e._GetNormalizedVertexModule();const p=D_.New(D_.Gfx.WebGPUShaderProgram,e,Object.assign({fragmentModule:h,fragmentModuleFragDepth:c,vertexModule:l,normVertexModule:d},t));if(p._usesAnySrcRectOrPixelSize=a.includes("%%C3PARAMS_STRUCT%%")&&X_.some(e=>a.includes(e)),p._usesAnyC3ParamRect=p._usesAnySrcRectOrPixelSize||a.includes("%%C3PARAMS_STRUCT%%")&&Y_.some(e=>a.includes(e)),p._usesIsSrcTexRotated=a.includes("%%C3PARAMS_STRUCT%%")&&a.includes("isSrcTexRotated"),"<generate-mipmap>"!==i){const t=p._CreateRenderPipelineAsync(0,0,0,0,0);let s=null;e.UsesDepthBuffer()&&(s=p._CreateRenderPipelineAsync(0,1,0,0,0));const[i,r]=await Promise.all([t,s]);p._renderPipelineMap.set(M_(0,0,0,0,0),i),r&&p._renderPipelineMap.set(M_(0,1,0,0,0),r)}return p}static _PreprocessShaderCode(e,t){if(!e)return e;let s="";return s=t?"enable f16;\nalias f16or32 = f16;\n":"alias f16or32 = f32;\n",s+e}static _PreprocessFragmentShaderCode(e,t,s){return e=D_.Gfx.WebGPUShaderProgram._PreprocessShaderCode(e,t),D_.StringSubstituteMap(e,{"%%SAMPLERFRONT_BINDING%%":"@binding(0) @group(1)","%%TEXTUREFRONT_BINDING%%":"@binding(1) @group(1)","%%SAMPLERBACK_BINDING%%":"@binding(0) @group(2)","%%TEXTUREBACK_BINDING%%":"@binding(1) @group(2)","%%SAMPLERDEPTH_BINDING%%":"@binding(0) @group(3)","%%TEXTUREDEPTH_BINDING%%":"@binding(1) @group(3)","%%SHADERPARAMS_BINDING%%":"@binding(5) @group(0)","%%FRAGMENTINPUT_STRUCT%%":A_(s),"%%FRAGMENTOUTPUT_STRUCT%%":$_,"%%C3PARAMS_STRUCT%%":z_,"%%C3_UTILITY_FUNCTIONS%%":Q_})}static _PreprocessVertexShaderCode(e,t){return D_.Gfx.WebGPUShaderProgram._PreprocessShaderCode(e,t)}static ReportShaderCompilationInfo(e,t,s){for(const i of s.messages){const s=`[WebGPU] Message (${i.type}) compiling ${t} shader '${e}': ${i.message} (line ${i.lineNum}, pos ${i.linePos})`;"error"===i.type?console.error(s):"warning"===i.type?console.warn(s):console.log(s)}}Release(){this._fragmentModule=null,this._fragmentModuleFragDepth=null,this._vertexModule=null,this._normVertexModule=null,this._renderPipelineMap.clear(),this._mipmapPipelineMap.clear(),super.Release()}_GetDevice(){return this._renderer._GetDevice()}_GetPipelineLayout(){return this._renderer._GetPipelineLayout()}GetRenderer(){return this._renderer}UsesAnyC3ParamRect(){return this._usesAnyC3ParamRect}UsesIsSrcTexRotated(){return this._usesIsSrcTexRotated}GetParameterCount(){return this._parameters.length}GetParameterType(e){return e<0||e>=this._parameters.length?null:this._parameters[e].type}GetCustomParametersByteSize(){return this._customParamsByteSize}_GetCustomParameterInfo(e){return this._parameters[e]}_GetRenderPipelineDescriptor(e,t,s,i,r){const n=this._renderer,a=n.IsColorDataF16(),o=n._GetBlendParametersByIndex(e);let h=o[0],l=o[1],c=h,u=l,d="add",_="add";o.length>=4&&(c=o[2],u=o[3]),6===o.length&&(d=o[4],_=o[5]);let p="none";switch(s){case 1:p="back";break;case 2:p="front"}const f={label:`${this.GetName()} blendMode ${e} variant ${t} multisampleCount ${r}`,layout:this._GetPipelineLayout(),primitive:{cullMode:p,frontFace:0===i?"cw":"ccw"},vertex:{module:4===t?this._normVertexModule:this._vertexModule,entryPoint:"main",buffers:[{arrayStride:12,attributes:[{shaderLocation:0,offset:0,format:"float32x3"}]},{arrayStride:8,attributes:[{shaderLocation:1,offset:0,format:"float32x2"}]},{arrayStride:4*(a?2:4),attributes:[{shaderLocation:2,offset:0,format:a?"float16x4":"float32x4"}]},{arrayStride:4,attributes:[{shaderLocation:3,offset:0,format:"uint32"}]}]},fragment:{module:this._fragmentModule,entryPoint:"main",targets:[{format:n.GetSwapChainFormat(),blend:{color:{srcFactor:h,dstFactor:l,operation:d},alpha:{srcFactor:c,dstFactor:u,operation:_}}}]}};if(r>=2&&(f.multisample={count:r}),1===t)f.fragment.module=this._fragmentModuleFragDepth||this._fragmentModule,f.depthStencil={format:n._GetDepthBufferFormat(),depthWriteEnabled:!0,depthCompare:"less-equal"};else if(2===t){f.fragment.module=this._fragmentModuleFragDepth||this._fragmentModule,f.fragment.targets=[];const e={compare:"always",failOp:"keep",depthFailOp:"keep",passOp:"replace"};f.depthStencil={format:n._GetDepthBufferFormat(),depthWriteEnabled:!0,depthCompare:"less-equal",stencilFront:e,stencilBack:e,stencilReadMask:1,stencilWriteMask:1}}else if(3===t){f.fragment.module=this._fragmentModuleFragDepth||this._fragmentModule;const e={compare:"equal",failOp:"keep",depthFailOp:"keep",passOp:"keep"};f.depthStencil={format:n._GetDepthBufferFormat(),depthWriteEnabled:!1,depthCompare:"always",stencilFront:e,stencilBack:e,stencilReadMask:1,stencilWriteMask:0}}return f}_CreateRenderPipeline(e,t,s,i,r){return this._GetDevice().createRenderPipeline(this._GetRenderPipelineDescriptor(e,t,s,i,r))}_CreateRenderPipelineAsync(e,t,s,i,r){return this._GetDevice().createRenderPipelineAsync(this._GetRenderPipelineDescriptor(e,t,s,i,r))}GetRenderPipelineForState(e,t,s,i,r){const n=M_(e,t,s,i,r);let a=this._renderPipelineMap.get(n);return a||(a=this._CreateRenderPipeline(e,t,s,i,r),this._renderPipelineMap.set(n,a),a)}static GetVertexUniformBufferLayout(){return W_}static GetVertexUniformBufferSize(){return 16*Math.ceil(U_/16)}static GetFragmentUniformBufferLayout(){return H_}static GetFragmentUniformBufferSize(){return 16*Math.ceil(j_/16)}static GetFragmentC3ParamsBufferLayout(){return q_}static GetFragmentC3ParamsBufferSize(){return 16*Math.ceil(K_/16)}static GetDefaultVertexShaderSource(e){const t=e?"f16":"f32";return`\n\t\t${N_}\n\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${t}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\toutput.Position = uniforms.transform * vec4<f32>(input.position, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.fragColor = input.color;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\treturn output;\n\t\t}`}static GetNormalizedVertexShaderSource(e){const t=e?"f16":"f32";return`\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${t}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p = input.position;\n\t\t\tp.y = 1.0 - p.y;\n\t\t\toutput.Position = vec4<f32>(p.xy * 2.0 - 1.0, p.z, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\toutput.fragColor = input.color;\n\t\t\treturn output;\n\t\t}`}static GetTextureFillVertexShaderSource(e){const t=e?"f16":"f32";return`\n\t\t${N_}\n\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${t}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\toutput.Position = uniforms.transform * vec4<f32>(input.position, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.fragColor = input.color;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\treturn output;\n\t\t}`}static GetNormalizedTextureFillVertexShaderSource(e){const t=e?"f16":"f32";return`\n\t\tstruct VertexInput {\n\t\t\t@location(0) position : vec3<f32>,\n\t\t\t@location(1) uv : vec2<f32>,\n\t\t\t@location(2) color : vec4<${t}>,\n\t\t\t@location(3) texIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p = input.position;\n\t\t\tp.y = 1.0 - p.y;\n\t\t\toutput.Position = vec4<f32>(p.xy * 2.0 - 1.0, p.z, 1.0);\n\t\t\toutput.fragUV = input.uv;\n\t\t\toutput.fragColor = input.color;\n\t\t\toutput.texIndex = input.texIndex;\n\t\t\treturn output;\n\t\t}`}static GetMultiTextureFillFragmentShaderSource(e,t){return`\n\t\t@binding(0) @group(1) var sampler0 : sampler;\n\t\t@binding(1) @group(1) var texture0 : texture_2d<f32>;\n\t\t@binding(2) @group(1) var sampler1 : sampler;\n\t\t@binding(3) @group(1) var texture1 : texture_2d<f32>;\n\t\t@binding(4) @group(1) var sampler2 : sampler;\n\t\t@binding(5) @group(1) var texture2 : texture_2d<f32>;\n\t\t@binding(6) @group(1) var sampler3 : sampler;\n\t\t@binding(7) @group(1) var texture3 : texture_2d<f32>;\n\t\t@binding(8) @group(1) var sampler4 : sampler;\n\t\t@binding(9) @group(1) var texture4 : texture_2d<f32>;\n\t\t@binding(10) @group(1) var sampler5 : sampler;\n\t\t@binding(11) @group(1) var texture5 : texture_2d<f32>;\n\t\t@binding(12) @group(1) var sampler6 : sampler;\n\t\t@binding(13) @group(1) var texture6 : texture_2d<f32>;\n\t\t@binding(14) @group(1) var sampler7 : sampler;\n\t\t@binding(15) @group(1) var texture7 : texture_2d<f32>;\n\t\t@binding(16) @group(1) var sampler8 : sampler;\n\t\t@binding(17) @group(1) var texture8 : texture_2d<f32>;\n\t\t@binding(18) @group(1) var sampler9 : sampler;\n\t\t@binding(19) @group(1) var texture9 : texture_2d<f32>;\n\t\t@binding(20) @group(1) var sampler10 : sampler;\n\t\t@binding(21) @group(1) var texture10 : texture_2d<f32>;\n\t\t@binding(22) @group(1) var sampler11 : sampler;\n\t\t@binding(23) @group(1) var texture11 : texture_2d<f32>;\n\t\t@binding(24) @group(1) var sampler12 : sampler;\n\t\t@binding(25) @group(1) var texture12 : texture_2d<f32>;\n\t\t@binding(26) @group(1) var sampler13 : sampler;\n\t\t@binding(27) @group(1) var texture13 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t?"f16":"f32"}>,\n\t\t\t@location(3) @interpolate(flat, either) texIndex : u32,\n\t\t\t${e?"@builtin(position) fragPos: vec4<f32>":""}\n\t\t};\n\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${e?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar texXy : vec2<f32> = input.fragUV.xy;\n\t\t\tvar texIndex : u32 = input.texIndex;\n\t\t\tvar c : vec4<f32>;\n\n\t\t\tlet dx = dpdx(texXy);\n\t\t\tlet dy = dpdy(texXy);\n\t\t\t\n\t\t\tif (texIndex <= 6)\n\t\t\t{\n\t\t\t\tif (texIndex <= 2)\n\t\t\t\t{\n\t\t\t\t\tif (texIndex == 0)\t\t\t{\tc = textureSampleGrad(texture0, sampler0, texXy, dx, dy);\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 1)\t\t{\tc = textureSampleGrad(texture1, sampler1, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture2, sampler2, texXy, dx, dy);\t}\n\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (texIndex <= 4)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 3)\t\t{\tc = textureSampleGrad(texture3, sampler3, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture4, sampler4, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex <= 5)\t\t{\tc = textureSampleGrad(texture5, sampler5, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture6, sampler6, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (texIndex <= 9)\n\t\t\t\t{\n\t\t\t\t\tif (texIndex == 7)\t\t\t{\tc = textureSampleGrad(texture7, sampler7, texXy, dx, dy);\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 8)\t\t{\tc = textureSampleGrad(texture8, sampler8, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture9, sampler9, texXy, dx, dy);\t}\n\t\t\t\t\t}\t\t\t\t\t\t\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tif (texIndex <= 11)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 10)\t\t{\tc = textureSampleGrad(texture10, sampler10, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture11, sampler11, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tif (texIndex == 12)\t\t{\tc = textureSampleGrad(texture12, sampler12, texXy, dx, dy);\t}\n\t\t\t\t\t\telse\t\t\t\t\t{\tc = textureSampleGrad(texture13, sampler13, texXy, dx, dy);\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\toutput.color = c * vec4<f32>(input.fragColor);\n\t\t\t${e?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static GetSingleTextureFillFragmentShaderSource(e,t){return`\n\t\t@binding(0) @group(1) var sampler0 : sampler;\n\t\t@binding(1) @group(1) var texture0 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(1) fragUV : vec2<f32>,\n\t\t\t@location(2) fragColor : vec4<${t?"f16":"f32"}>,\n\t\t\t${e?"@builtin(position) fragPos: vec4<f32>":""}\n\t\t};\n\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${e?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = textureSample(texture0, sampler0, input.fragUV) * vec4<f32>(input.fragColor);\n\t\t\t${e?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static _GetMipmapGeneratorVertexSource(){return"\n\t\tstruct VertexInput {\n\t\t\t@builtin(vertex_index) VertexIndex : u32\n\t\t};\n\t\t\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(0) fragUV : vec2<f32>\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\n\t\t\tvar pos : array<vec2<f32>, 4> = array<vec2<f32>, 4>(\n\t\t\t\tvec2<f32>(-1.0, 1.0),\n\t\t\t\tvec2<f32>(1.0, 1.0),\n\t\t\t\tvec2<f32>(-1.0, -1.0),\n\t\t\t\tvec2<f32>(1.0, -1.0));\n\t\t\t\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p : vec2<f32> = pos[input.VertexIndex];\n\t\t\toutput.Position = vec4<f32>(p, 0.0, 1.0);\n\t\t\toutput.fragUV = p / 2.0 + 0.5;\n\t\t\treturn output;\n\t\t}"}static _GetMipmapGeneratorFragmentSource(){return"\n\t\t@binding(0) @group(0) var sampler0 : sampler;\n\t\t@binding(1) @group(0) var texture0 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(0) fragUV : vec2<f32>\n\t\t};\n\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>\n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = textureSample(texture0, sampler0, vec2<f32>(input.fragUV.x, 1.0 - input.fragUV.y));\n\t\t\treturn output;\n\t\t}"}_GetMipmapGeneratorPipeline(e){e||(e=this._renderer.GetTextureFormat());let t=this._mipmapPipelineMap.get(e);return t||(t=this._GetDevice().createRenderPipeline({label:"<mipmap generator>",layout:"auto",vertex:{module:this._vertexModule,entryPoint:"main"},primitive:{topology:"triangle-strip",stripIndexFormat:"uint16"},fragment:{module:this._fragmentModule,entryPoint:"main",targets:[{format:e,blend:{color:{srcFactor:"one",dstFactor:"zero"},alpha:{srcFactor:"one",dstFactor:"zero"}}}]}}),this._mipmapPipelineMap.set(e,t)),t}static _GetPointVertexSource(){return`\n\t\t${N_}\n\n\t\tstruct PointData {\n\t\t\tdata : array<vec4<f32>>\n\t\t};\n\t\t@binding(3) @group(0) var<storage> pointBuffer : PointData;\n\n\t\tstruct VertexInput {\n\t\t\t@builtin(vertex_index) VertexIndex : u32\n\t\t};\n\n\t\tstruct VertexOutput {\n\t\t\t@builtin(position) Position : vec4<f32>,\n\t\t\t@location(0) fragUV : vec2<f32>,\n\t\t\t@location(1) pointOpacity : f32\n\t\t};\n\n\t\t@vertex\n\t\tfn main(input : VertexInput) -> VertexOutput {\n\n\t\t\tvar normPos : array<vec2<f32>, 4> = array<vec2<f32>, 4>(\n\t\t\t\tvec2<f32>(-0.5, -0.5),\n\t\t\t\tvec2<f32>(0.5, -0.5),\n\t\t\t\tvec2<f32>(0.5, 0.5),\n\t\t\t\tvec2<f32>(-0.5, 0.5));\n\t\t\t\n\t\t\tvar output : VertexOutput;\n\t\t\tvar p : vec2<f32> = normPos[input.VertexIndex % u32(4)];\n\t\t\tvar pointData : vec4<f32> = pointBuffer.data[input.VertexIndex / u32(4)];\n\n\t\t\tvar size : f32 = pointData.z;\n\t\t\toutput.Position = uniforms.transform * vec4<f32>(p * size + pointData.xy, uniforms.zElevation, 1.0);\n\t\t\toutput.pointOpacity = pointData.w;\n\n\t\t\tvar pointTexMin : vec2<f32> = min(uniforms.pointTexStart, uniforms.pointTexEnd);\n\t\t\tvar pointTexMax : vec2<f32> = max(uniforms.pointTexStart, uniforms.pointTexEnd);\n\t\t\tvar pn : vec2<f32> = p + vec2<f32>(0.5, 0.5);\n\t\t\tvar pointCoord : vec2<f32> = select(vec2<f32>(1.0 - pn.y, pn.x), pn, uniforms.pointTexEnd.x > uniforms.pointTexStart.x);\n\n\t\t\toutput.fragUV = mix(pointTexMin, pointTexMax, pointCoord);\n\t\t\treturn output;\n\t\t}`}static _GetPointFragmentSource(e){return`\n\t\t${V_}\n\n\t\t%%SAMPLERFRONT_BINDING%% var sampler0 : sampler;\n\t\t%%TEXTUREFRONT_BINDING%% var texture0 : texture_2d<f32>;\n\n\t\tstruct FragmentInput {\n\t\t\t@location(0) fragUV : vec2<f32>,\n\t\t\t@location(1) pointOpacity : f32,\n\t\t\t@builtin(position) fragPos : vec4<f32>\n\t\t};\n\t\t\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${e?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = textureSample(texture0, sampler0, input.fragUV) * uniforms.pointColor * input.pointOpacity;\n\t\t\t${e?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static _GetTilemapFragmentShaderSource(e){return`\n\t\t${V_}\n\n\t\t%%SAMPLERFRONT_BINDING%% var sampler0 : sampler;\n\t\t%%TEXTUREFRONT_BINDING%% var texture0 : texture_2d<f32>;\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t\n\t\tstruct FragmentOutput {\n\t\t\t@location(0) color : vec4<f32>,\n\t\t\t${e?"@builtin(frag_depth) fragDepth: f32":""} \n\t\t};\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar halfPixelSize : vec2<f32> = vec2<f32>(0.5, 0.5) / vec2<f32>(textureDimensions(texture0));\n\n\t\t\tvar tile : vec2<f32> = floor(input.fragUV);\n\t\t\tvar tex : vec2<f32> = fract(input.fragUV);\n\t\t\tvar tileOrigin : vec2<f32> = uniforms.srcRectStart + tile * (uniforms.tileSize + uniforms.tileSpacing);\n\t\t\tvar lowerBound : vec2<f32> = tileOrigin + halfPixelSize;\n\t\t\tvar upperBound : vec2<f32> = tileOrigin + uniforms.tileSize - halfPixelSize;\n\n\t\t\toutput.color = textureSampleLevel(texture0, sampler0, clamp(tex, lowerBound, upperBound), 0.0) * vec4<f32>(input.fragColor);\n\t\t\t${e?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\t\t\treturn output;\n\t\t}`}static GetTileRandomizationFragmentShaderSource(e){return`\n${V_}\n\n%%SAMPLERFRONT_BINDING%% var sampler0 : sampler;\n%%TEXTUREFRONT_BINDING%% var texture0 : texture_2d<f32>;\n\n%%FRAGMENTINPUT_STRUCT%%\n\nstruct FragmentOutput {\n\t@location(0) color : vec4<f32>,\n\t${e?"@builtin(frag_depth) fragDepth: f32":""} \n};\n\n%%C3_UTILITY_FUNCTIONS%%\n\nconst PI : f32 = 3.1415926;\n\nfn cospVec4(a : vec4<f32>, b : vec4<f32>, x : f32) -> vec4<f32>\n{\n\treturn (a + b + (a - b) * cos(x * PI)) / 2.0;\n}\n\nfn randVec3(seed : vec2<f32>) -> vec3<f32>\n{\n\treturn vec3<f32>(\n\t\tfract(sin(dot(seed.xy, vec2<f32>(12.9898,78.233))) * 43758.5453),\n\t\tfract(sin(dot(seed.yx, vec2<f32>(12.9898,-78.233))) * 43758.5453),\n\t\tfract(sin(dot(seed.xy, vec2<f32>(-12.9898,-78.233))) * 43758.5453));\n}\n\nfn sampleTile(tile : vec2<f32>, uv : vec2<f32>, ddx : vec2<f32>, ddy : vec2<f32>) -> vec4<f32>\n{\n\tvar posRandom = uniforms.tileSize;\n\tvar angleRandom = uniforms.outlineThickness;\n\tvar pixelSize = c3_getPixelSize(texture0);\n\t\n\tvar rand = (randVec3(round(tile)) - 0.5) * 2.0;\n\t\n\tvar angle = angleRandom * rand.z * PI;\n\tvar sin_a = sin(angle);\n\tvar cos_a = cos(angle);\n\tvar aspect = pixelSize.x / pixelSize.y;\n\n\tvar mid = tile + vec2<f32>(0.5, 0.5);\n\tvar dp = uv - mid;\n\tdp.x /= aspect;\n\tvar r = vec2<f32>(dp.x * cos_a - dp.y * sin_a,\n\t\t\t\t\t  dp.y * cos_a + dp.x * sin_a);\n\tr.x *= aspect;\n\n\tvar p = mid + r + (posRandom * rand.xy / 2.0);\n\t\n\treturn textureSampleGrad(texture0, sampler0, p, ddx, ddy);\n}\n\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\n\tvar output : FragmentOutput;\n\t\n\tvar blendMarginX = uniforms.tileSpacing.x;\n\tvar blendMarginY = uniforms.tileSpacing.y;\n\t\n\tvar tile = floor(input.fragUV);\n\tvar tex = fract(input.fragUV);\n\tvar ddx = dpdx(input.fragUV);\n\tvar ddy = dpdy(input.fragUV);\n\t\n\tvar curTile = sampleTile(tile, input.fragUV, ddx, ddy);\n\t\n\tvar inLeftMargin = (tex.x < blendMarginX);\n\tvar inRightMargin = (tex.x > 1.0 - blendMarginX);\n\tvar inTopMargin = (tex.y < blendMarginY);\n\tvar inBottomMargin = (tex.y > 1.0 - blendMarginY);\n\t\n\tif (inLeftMargin)\n\t{\n\t\tvar leftTile = sampleTile(tile + vec2<f32>(-1.0, 0.0), input.fragUV, ddx, ddy);\n\t\tvar leftMix = (tex.x / (blendMarginX * 2.0)) + 0.5;\n\t\tvar leftMixedTile = cospVec4(leftTile, curTile, leftMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tvar topTile =     sampleTile(tile + vec2<f32>(0.0,  -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topLeftTile = sampleTile(tile + vec2<f32>(-1.0, -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topLeftMixedTile = cospVec4(topLeftTile, topTile, leftMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(topLeftMixedTile, leftMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tvar bottomTile =     sampleTile(tile + vec2<f32>(0.0,  1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomLeftTile = sampleTile(tile + vec2<f32>(-1.0, 1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomLeftMixedTile = cospVec4(bottomLeftTile, bottomTile, leftMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(leftMixedTile, bottomLeftMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutput.color = leftMixedTile;\n\t\t}\n\t}\n\telse if (inRightMargin)\n\t{\n\t\tvar rightTile = sampleTile(tile + vec2(1.0, 0.0), input.fragUV, ddx, ddy);\n\t\tvar rightMix = (tex.x - (1.0 - blendMarginX)) / (blendMarginX * 2.0);\n\t\tvar rightMixedTile = cospVec4(curTile, rightTile, rightMix);\n\t\t\n\t\tif (inTopMargin)\n\t\t{\n\t\t\tvar topTile =      sampleTile(tile + vec2<f32>(0.0, -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topRightTile = sampleTile(tile + vec2<f32>(1.0, -1.0), input.fragUV, ddx, ddy);\n\t\t\tvar topRightMixedTile = cospVec4(topTile, topRightTile, rightMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(topRightMixedTile, rightMixedTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t\t}\n\t\telse if (inBottomMargin)\n\t\t{\n\t\t\tvar bottomTile =      sampleTile(tile + vec2<f32>(0.0, 1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomRightTile = sampleTile(tile + vec2<f32>(1.0, 1.0), input.fragUV, ddx, ddy);\n\t\t\tvar bottomRightMixedTile = cospVec4(bottomTile, bottomRightTile, rightMix);\n\t\t\t\n\t\t\toutput.color = cospVec4(rightMixedTile, bottomRightMixedTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t\t}\n\t\telse\n\t\t{\n\t\t\toutput.color = rightMixedTile;\n\t\t}\n\t}\n\telse if (inTopMargin)\n\t{\n\t\tvar topTile = sampleTile(tile + vec2<f32>(0.0, -1.0), input.fragUV, ddx, ddy);\n\t\toutput.color = cospVec4(topTile, curTile, (tex.y / (blendMarginY * 2.0)) + 0.5);\n\t}\n\telse if (inBottomMargin)\n\t{\n\t\tvar bottomTile = sampleTile(tile + vec2<f32>(0.0, 1.0), input.fragUV, ddx, ddy);\n\t\toutput.color = cospVec4(curTile, bottomTile, (tex.y - (1.0 - blendMarginY)) / (blendMarginY * 2.0));\n\t}\n\telse\n\t{\n\t\toutput.color = curTile;\n\t}\n\t\n\toutput.color *= vec4<f32>(input.fragColor);\n\t${e?"output.fragDepth = select(input.fragPos.z, 1.0, output.color.a == 0.0);":""}\n\treturn output;\n}\n`}static _GetColorFillFragmentShaderSource(){return"\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\toutput.color = vec4<f32>(input.fragColor);\n\t\t\treturn output;\n\t\t}"}static _GetLinearGradientFillFragmentShaderSource(){return`\n\t\t${V_}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\tfn fromLinear(linearRGB : vec3<f32>) -> vec3<f32>\n\t\t{\n\t\t\tvar cutoff : vec3<bool> = (linearRGB < vec3<f32>(0.0031308));\n\t\t\tvar higher : vec3<f32> = vec3<f32>(1.055) * pow(abs(linearRGB), vec3<f32>(1.0/2.4)) - 0.055;\n\t\t\tvar lower : vec3<f32> = linearRGB * 12.92;\n\t\t\treturn select(higher, lower, cutoff);\n\t\t}\n\n\t\tfn toLinear(sRGB : vec3<f32>) -> vec3<f32>\n\t\t{\n\t\t\tvar cutoff : vec3<bool> = (sRGB < vec3<f32>(0.04045));\n\t\t\tvar higher : vec3<f32> = pow(abs((sRGB + 0.055) / 1.055), vec3<f32>(2.4));\n\t\t\tvar lower : vec3<f32> = sRGB / 12.92;\n\t\t\treturn select(higher, lower, cutoff);\n\t\t}\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar linearGrad : vec3<f32> = mix(toLinear(vec3<f32>(input.fragColor.rgb)), toLinear(uniforms.color2.rgb), vec3<f32>(input.fragUV.x));\n\n\t\t\tvar a : f32 = mix(f32(input.fragColor.a), uniforms.color2.a, input.fragUV.x);\n\t\t\toutput.color = vec4<f32>(fromLinear(linearGrad) * a, a);\n\t\t\treturn output;\n\t\t}\n\t\t`}static _GetPenumbraFillFragmentShaderSource(){return`\n\t\t${V_}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar grad : f32 = input.fragUV.x / (1.0 - input.fragUV.y);\n\t\t\toutput.color = vec4<f32>(input.fragColor) * (1.0 - (cos(grad * 3.141592653589793) + 1.0) / 2.0);\n\t\t\treturn output;\n\t\t}\n\t\t`}static _GetHardEllipseFillFragmentShaderSource(){return"\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\n\t\t\tvar f : f32 = step(diffSq.x + diffSq.y, 0.25);\n\n\t\t\toutput.color = vec4<f32>(input.fragColor) * f;\n\t\t\treturn output;\n\t\t}"}static _GetHardEllipseOutlineFragmentShaderSource(){return`\n\t\t${V_}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\t\t\tvar distSq : f32 = diffSq.x + diffSq.y;\n\t\t\tvar norm : vec2<f32> = normalize(diff);\n\t\t\tvar halfNorm : vec2<f32> = norm * 0.5;\n\n\t\t\tvar innerF : f32 = step(distSq, 0.25);\n\n\t\t\tvar innerEdge : vec2<f32> = halfNorm - uniforms.pixelSize * norm * uniforms.outlineThickness;\n\t\t\tvar innerEdgeSq : vec2<f32> = innerEdge * innerEdge;\n\t\t\tvar outerF : f32 = step(innerEdgeSq.x + innerEdgeSq.y, distSq);\n\t\t\t\n\t\t\toutput.color = vec4<f32>(input.fragColor) * innerF * outerF;\n\t\t\treturn output;\n\t\t}`}static _GetSmoothEllipseFillFragmentShaderSource(){return`\n\t\t${V_}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\t\t\tvar norm : vec2<f32> = normalize(diff);\n\t\t\tvar halfNorm : vec2<f32> = norm * 0.5;\n\t\t\tvar halfNormSq : vec2<f32> = halfNorm * halfNorm;\n\n\t\t\tvar innerEdge : vec2<f32> = halfNorm - uniforms.pixelSize * norm;\n\t\t\tvar innerEdgeSq : vec2<f32> = innerEdge * innerEdge;\n\n\t\t\tvar f : f32 = smoothstep(halfNormSq.x + halfNormSq.y, innerEdgeSq.x + innerEdgeSq.y, diffSq.x + diffSq.y);\n\n\t\t\toutput.color = vec4<f32>(input.fragColor) * f;\n\t\t\treturn output;\n\t\t}`}static _GetSmoothEllipseOutlineFragmentShaderSource(){return`\n\t\t${V_}\n\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar diff : vec2<f32> = input.fragUV - 0.5;\n\t\t\tvar diffSq : vec2<f32> = diff * diff;\n\t\t\tvar distSq : f32 = diffSq.x + diffSq.y;\n\t\t\tvar norm : vec2<f32> = normalize(diff);\n\t\t\tvar halfNorm : vec2<f32> = norm * 0.5;\n\t\t\tvar halfNormSq : vec2<f32> = halfNorm * halfNorm;\n\n\t\t\tvar pxNorm : vec2<f32> = uniforms.pixelSize * norm;\n\t\t\tvar innerEdge1 : vec2<f32> = halfNorm - pxNorm;\n\t\t\tvar innerEdge1Sq : vec2<f32> = innerEdge1 * innerEdge1;\n\n\t\t\tvar innerF : f32 = smoothstep(halfNormSq.x + halfNormSq.y, innerEdge1Sq.x + innerEdge1Sq.y, distSq);\n\n\t\t\tvar innerEdge2 : vec2<f32> = halfNorm - pxNorm * uniforms.outlineThickness;\n\t\t\tvar innerEdge2Sq : vec2<f32> = innerEdge2 * innerEdge2;\n\t\t\tvar innerEdge3 : vec2<f32> = halfNorm - pxNorm * (uniforms.outlineThickness + 1.0);\n\t\t\tvar innerEdge3Sq : vec2<f32> = innerEdge3 * innerEdge3;\n\n\t\t\tvar outerF : f32 = smoothstep(innerEdge3Sq.x + innerEdge3Sq.y, innerEdge2Sq.x + innerEdge2Sq.y, distSq);\n\t\t\t\n\t\t\toutput.color = vec4<f32>(input.fragColor) * innerF * outerF;\n\t\t\treturn output;\n\t\t}`}static _GetSmoothLineFillFragmentShaderSource(){return"\n\t\t%%FRAGMENTINPUT_STRUCT%%\n\t\t%%FRAGMENTOUTPUT_STRUCT%%\n\n\t\t@fragment\n\t\tfn main(input : FragmentInput) -> FragmentOutput {\n\t\t\tvar output : FragmentOutput;\n\t\t\tvar f : f32 = 1.0 - abs(input.fragUV.y - 0.5) * 2.0;\n\t\t\toutput.color = vec4<f32>(input.fragColor) * f;\n\t\t\treturn output;\n\t\t}"}}}{const ep=self.C3,tp=new Set(["nearest","bilinear","trilinear"]),sp=new Set(["clamp-to-edge","repeat","mirror-repeat"]),ip=self.GPUTextureUsage,rp={wrapX:"clamp-to-edge",wrapY:"clamp-to-edge",sampling:"trilinear",anisotropy:0,mipMap:!0,isRenderTarget:!1,isSampled:!1,canReadPixels:!1,canUpdate:!1,multisampling:0,isWebGPUFastUpdate:!1,width:-1,height:-1},np=[[1,["r8unorm","r8snorm","r8uint","r8sint","stencil8"]],[2,["r16uint","r16sint","r16float","rg8unorm","rg8snorm","rg8uint","rg8sint","depth16unorm"]],[3,["depth24plus"]],[4,["r32uint","r32sint","r32float","rg16uint","rg16sint","rg16float","rgba8unorm","rgba8unorm-srgb","rgba8snorm","rgba8uint","rgba8sint","bgra8unorm","bgra8unorm-srgb","rgb9e5ufloat","rgb10a2uint","rgb10a2unorm","rg11b10ufloat","depth24plus-stencil8","depth32float"]],[8,["rg32uint","rg32sint","rg32float","rgba16uint","rgba16sint","rgba16float"]],[16,["rgba32uint","rgba32sint","rgba32float"]],[5,["depth32float-stencil8"]]],ap=new Map;for(const[lp,cp]of np)for(const up of cp)ap.set(up,lp);const op=new Set,hp={premultiplyAlpha:!0,flipY:!1};ep.Gfx.WebGPURendererTexture=class{constructor(e,t){this._renderer=e,this._texture=null,this._format="",this._textureView=null,this._sampler=null,this._ownTextureBindGroup=null,this._backTextureBindGroup=null,this._width=0,this._height=0,this._isStatic=!0,this._wrapX="clamp-to-edge",this._wrapY="clamp-to-edge",this._sampling="trilinear",this._anisotropy=0,this._isMipMapped=!1,this._refCount=0,this._isRenderTarget=!1,this._isSampled=!1,this._canReadPixels=!1,this._canUpdate=!1,this._isFastUpdate=!1,this._multisampling=0,this._usage=0,this._multiTextureEnabled=!0,this._multiTextureGroup=null,this._multiTextureIndex=0,this._isForBackbuffer=!!t,this._isForBackbuffer&&(this._format=this._renderer.GetSwapChainFormat(),this._isRenderTarget=!0,this._isSampled=this._renderer._CanSampleBackbuffer(),this._sampling=this._renderer._GetBackTextureSampling(),this._sampler=this._renderer._GetSampler({sampling:this._sampling}))}_InitFromOpts(e){if(this._wrapX=e.wrapX,this._wrapY=e.wrapY,this._sampling=e.sampling,this._anisotropy=e.anisotropy,this._isMipMapped=!!e.mipMap&&this._renderer.AreMipmapsEnabled()&&"nearest"!==e.sampling,this._isRenderTarget=!!e.isRenderTarget,this._isSampled=!!e.isSampled,this._canReadPixels=!!e.canReadPixels,this._canUpdate=!!e.canUpdate,this._isFastUpdate=!!e.isWebGPUFastUpdate,this._multisampling=this._renderer._ClampToSupportedMultisampleValues(e.multisampling),!tp.has(this._sampling))throw new Error("invalid sampling");if(!sp.has(this._wrapX)||!sp.has(this._wrapY))throw new Error("invalid wrap mode");if(this._multisampling>=2&&this._isSampled)throw new Error("invalid use of multisampling");"nearest"===this._sampling&&(this._anisotropy=0),this._sampler=this._renderer._GetSampler({wrapX:this._wrapX,wrapY:this._wrapY,sampling:this._sampling,anisotropy:this._anisotropy}),this._CreateGPUResources(),this._refCount=1}_CreateGPUResources(){const e=this._renderer,t=e._GetDevice();this._usage=0,this._isRenderTarget?(this._usage=ip.RENDER_ATTACHMENT,this._isSampled&&(this._usage|=ip.TEXTURE_BINDING),this._canUpdate&&(this._usage|=ip.COPY_DST),this._format=this._renderer.GetSwapChainFormat()):(this._usage=ip.COPY_DST|ip.TEXTURE_BINDING,this._isFastUpdate&&(this._usage|=ip.RENDER_ATTACHMENT),this._format=this._renderer.GetTextureFormat()),this._canReadPixels&&(this._usage|=ip.COPY_SRC),this._texture=t.createTexture({size:[this._width,this._height,1],mipLevelCount:this._GetMipLevelCount(),format:this._format,usage:this._usage,sampleCount:this._multisampling>=2?this._multisampling:1}),this._textureView=this._texture.createView();const s=[],i=ep.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(let e=0;e<i;++e)s.push({binding:2*e,resource:this._sampler},{binding:2*e+1,resource:this._textureView});this._isRenderTarget&&!this._isSampled||(this._ownTextureBindGroup=t.createBindGroup({layout:e._GetTextureBindGroupLayout(),entries:s}),this._backTextureBindGroup=t.createBindGroup({layout:e._GetBackTextureBindGroupLayout(),entries:[{binding:0,resource:this._renderer._GetSampler({sampling:this._renderer._GetBackTextureSampling()})},{binding:1,resource:this._textureView}]})),this._CanMultiTexture()&&this._SetMultiTextureAvailable(!0),op.add(this)}_DeleteGPUResources(){op.delete(this),this._multiTextureGroup&&this._multiTextureGroup.Release(),this._SetMultiTextureAvailable(!1),this._texture.destroy(),this._texture=null,this._textureView=null,this._ownTextureBindGroup=null,this._backTextureBindGroup=null}static IsGPUImageCopyExternalImageSource(e){return e instanceof ImageBitmap||"undefined"!=typeof HTMLVideoElement&&e instanceof HTMLVideoElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas}static IsCreateImageBitmapDataSource(e){return"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||e instanceof ImageData}_GetDataSize(e){return[e.width||e.videoWidth,e.height||e.videoHeight]}_Create(e,t){if(e&&!ep.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(e))throw new TypeError("invalid texture source");if(t=Object.assign({},rp,t),this._texture)throw new Error("already created texture");if(this._isStatic=!0,e){const[t,s]=this._GetDataSize(e);this._width=t,this._height=s}else if(this._width=t.width,this._height=t.height,this._width<=0||this._height<=0)throw new Error("invalid texture size");if(this._InitFromOpts(t),this._isRenderTarget||this._isSampled)throw new Error("static texture cannot be render target");e&&this._UploadImage(e)}_UploadImage(e,t=!0){if(this._isMipMapped)this._GenerateMipmaps(e,this._GetMipLevelCount(),t);else if(this._isFastUpdate)this._CopyImageToMipLevel(this._texture,e,0,t);else{const s=this._renderer._GetDevice(),i=s.createCommandEncoder(),r=s.createTexture({size:[this._width,this._height,1],mipLevelCount:1,format:this._format,usage:ip.COPY_SRC|ip.COPY_DST|ip.RENDER_ATTACHMENT});this._CopyImageToMipLevel(r,e,0,t),i.copyTextureToTexture({texture:r,mipLevel:0},{texture:this._texture,mipLevel:0},[this._width,this._height,1]),s.queue.submit([i.finish()]),r.destroy()}}_CopyImageToMipLevel(e,t,s,i=!0){const[r,n]=this._GetDataSize(t);this._renderer._GetDevice().queue.copyExternalImageToTexture({source:t},{texture:e,mipLevel:s,premultipliedAlpha:!!i},[r,n,1])}_GetMipLevelCount(){return this._isMipMapped?Math.floor(Math.log2(Math.max(this._width,this._height))+1):1}_GenerateMipmaps(e,t,s=!0){const i=this._renderer._GetDevice(),r=i.createTexture({size:[this._width,this._height,1],mipLevelCount:this._GetMipLevelCount(),format:this._format,usage:ip.COPY_DST|ip.COPY_SRC|ip.TEXTURE_BINDING|ip.RENDER_ATTACHMENT}),n=this._renderer._GetMipmapGeneratorPipeline(),a=n.getBindGroupLayout(0),o=this._renderer._GetSampler({sampling:"bilinear"}),h=i.createCommandEncoder();this._CopyImageToMipLevel(r,e,0,s),h.copyTextureToTexture({texture:r,mipLevel:0},{texture:this._texture,mipLevel:0},[this._width,this._height,1]);const l=[];for(let e=0;e<t;++e)l.push(r.createView({baseMipLevel:e,mipLevelCount:1}));let c=this._width,u=this._height;for(let e=1;e<t;++e){c/=2,u/=2;const t=Math.max(Math.floor(c),1),s=Math.max(Math.floor(u),1),d=h.beginRenderPass({colorAttachments:[{view:l[e],loadOp:"clear",clearValue:[0,0,0,0],storeOp:"store"}]}),_=i.createBindGroup({layout:a,entries:[{binding:0,resource:o},{binding:1,resource:l[e-1]}]});d.setPipeline(n),d.setBindGroup(0,_),d.draw(4),d.end(),h.copyTextureToTexture({texture:r,mipLevel:e},{texture:this._texture,mipLevel:e},[t,s,1])}i.queue.submit([h.finish()]),r.destroy()}_CreateDynamic(e,t,s){if(s=Object.assign({},rp,s),this._texture)throw new Error("already created texture");this._isStatic=!1,this._width=e,this._height=t,this._InitFromOpts(s)}async _Update(e,t){if(!ep.Gfx.WebGPURendererTexture.IsGPUImageCopyExternalImageSource(e)&&!ep.Gfx.WebGPURendererTexture.IsCreateImageBitmapDataSource(e))throw new Error("invalid texture source");if(!this._texture||this._refCount<=0)throw new Error("texture not created");if(this._isStatic)throw new Error("cannot update static texture");if(t=Object.assign({},hp,t),(ep.Gfx.WebGPURendererTexture.IsCreateImageBitmapDataSource(e)||t.flipY||!t.premultiplyAlpha)&&(e=await createImageBitmap(e,{premultiplyAlpha:t.premultiplyAlpha?"premultiply":"none",imageOrientation:t.flipY?"flipY":"none"}),!this._texture))return;this._renderer.EndBatch();const[s,i]=this._GetDataSize(e);this._width===s&&this._height===i||(this._DeleteGPUResources(),this._width=s,this._height=i,this._CreateGPUResources(),this._renderer._OnTextureBindGroupChanged(this)),this._UploadImage(e,t.premultiplyAlpha)}_Delete(){if(this._refCount>0)throw new Error("texture still has references");if(!this._texture)throw new Error("already deleted texture");this._DeleteGPUResources()}_DisableMultiTexture(){this._multiTextureEnabled=!1,this._SetMultiTextureAvailable(!1)}_CanMultiTexture(){return this._isStatic&&this._multiTextureEnabled&&!this._isRenderTarget}_SetMultiTextureAvailable(e){this._renderer._SetMultiTextureAvailable(this,e)}_SetMultiTextureGroup(e,t){if(this._multiTextureGroup)throw new Error("already in a group");this._multiTextureGroup=e,this._multiTextureIndex=t,this._SetMultiTextureAvailable(!1)}_ClearMultiTextureGroup(){this._multiTextureGroup=null,this._multiTextureIndex=0,this._CanMultiTexture()&&this._SetMultiTextureAvailable(!0)}_GetOwnTextureBindGroup(){return this._ownTextureBindGroup}_GetBackTextureBindGroup(){return this._backTextureBindGroup}_GetMultiTextureBindGroup(){return null!==this._multiTextureGroup?this._multiTextureGroup._GetBindGroup():this._CanMultiTexture()?(this._renderer._TryCreateMultiTextureGroup(this),null!==this._multiTextureGroup?this._multiTextureGroup._GetBindGroup():null):null}_GetMultiTextureIndex(){return this._multiTextureIndex}GetWidth(){return this._isForBackbuffer?this._renderer.GetWidth():this._width}GetHeight(){return this._isForBackbuffer?this._renderer.GetHeight():this._height}GetRenderer(){return this._renderer}_GetTexture(){return this._texture}_GetTextureView(){return this._textureView}_GetFormat(){return this._format}_GetSampler(){return this._sampler}GetSampling(){return this._sampling}IsLinearSampling(){return"nearest"!==this._sampling}IsRenderTarget(){return this._isRenderTarget}IsSampled(){return this._isSampled}CanReadPixels(){return this._canReadPixels}AddReference(){this._refCount++}SubtractReference(){if(this._refCount<=0)throw new Error("no more references");this._refCount--}GetReferenceCount(){return this._refCount}_GetUsage(){return this._usage}_BackbufferTextureSetProperties(e,t){this._usage=e,this._format=t}_BackbufferTextureStartFrame(){const e=this._renderer,t=e._GetDevice();this._texture=e._GetSwapChainTexture(),this._textureView=e._GetSwapChainTexView(),e._CanSampleBackbuffer()&&(this._backTextureBindGroup=t.createBindGroup({layout:e._GetBackTextureBindGroupLayout(),entries:[{binding:0,resource:this._sampler},{binding:1,resource:this._textureView}]}))}_BackbufferTextureEndFrame(){this._texture=null,this._textureView=null,this._backTextureBindGroup=null}GetEstimatedMemoryUsage(){let e=this.GetWidth()*this.GetHeight()*ep.Gfx.WebGPURendererTexture.GetFormatByteSize(this._GetFormat());return this._isMipMapped&&(e+=Math.floor(e/3)),e}static OnContextLost(){}static allTextures(){return op.values()}static GetFormatByteSize(e){const t=ap.get(e);return"number"==typeof t?t:NaN}}}{const dp=self.C3;dp.Gfx.WebGPUMultiTextureGroup=class{constructor(e,t){if(t.length<2)throw new Error("invalid multi-texture group");this._renderer=e,this._textures=t,this._multiTextureBindGroup=null;for(let e=0,s=t.length;e<s;++e)t[e]._SetMultiTextureGroup(this,e);t.length<dp.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit()&&this._renderer._SetMultiTextureGroupNonFull(this,!0),this._CreateBindGroup()}Release(){this._renderer._SetMultiTextureGroupNonFull(this,!1);for(const e of this._textures)e._ClearMultiTextureGroup();this._DeleteBindGroup(),dp.clearArray(this._textures),this._renderer=null}_CreateBindGroup(){this._DeleteBindGroup();const e=this._renderer._GetDevice(),t=[],s=dp.Gfx.WebGPUMultiTextureGroup.GetMultiTextureLimit();for(let e=0;e<s;++e){const s=this._textures[Math.min(e,this._textures.length-1)];t.push({binding:2*e,resource:s._GetSampler()},{binding:2*e+1,resource:s._GetTextureView()})}this._multiTextureBindGroup=e.createBindGroup({layout:this._renderer._GetTextureBindGroupLayout(),entries:t})}_DeleteBindGroup(){null!==this._multiTextureBindGroup&&this._renderer._OnMultiTextureBindGroupReleased(this._multiTextureBindGroup),this._multiTextureBindGroup=null}_GetBindGroup(){return this._multiTextureBindGroup}static GetMultiTextureLimit(){return 14}}}{const _p=self.C3,pp=self.glMatrix,fp=pp.vec3,mp=pp.mat4,gp={sampling:"trilinear",alpha:!0,depth:!1,isSampled:!0,canReadPixels:!1,canUpdate:!1,isDefaultSize:!0,multisampling:0},Sp=new Set;_p.Gfx.WebGPURenderTarget=class{constructor(e,t){this._renderer=e,this._isBackBuffer=!!t,this._depth=!!t&&e.UsesDepthBuffer(),this._rendererTexture=null,this._isDefaultSize=!0,this._multisampling=0,this._isAwaitingClear=!1,this._clearColor=_p.New(_p.Color),this._projectionMatrix=mp.create(),this._lastFov=0,this._lastNearZ=0,this._lastFarZ=0,this._isBackBuffer&&(this._rendererTexture=_p.New(_p.Gfx.WebGPURendererTexture,e,!0))}_Create(e,t,s){if(s=Object.assign({},gp,s),this._rendererTexture)throw new Error("already created render target");if(this._depth=!!s.depth,this._isDefaultSize=!!s.isDefaultSize,this._multisampling=this._renderer._ClampToSupportedMultisampleValues(s.multisampling),this._multisampling>=2&&s.isSampled)throw new Error("invalid use of multisampling");this._rendererTexture=this._renderer.CreateDynamicTexture(e,t,{sampling:s.sampling,mipMap:!1,isRenderTarget:!0,isSampled:s.isSampled,canReadPixels:s.canReadPixels,canUpdate:s.canUpdate,multisampling:this._multisampling}),this._CalculateProjection(),Sp.add(this)}_Delete(){Sp.delete(this),this._rendererTexture._DeleteGPUResources(),this._rendererTexture=null,this._renderer=null}_Resize(e,t){if(e===this.GetWidth()&&t===this.GetHeight())return;const s=this._rendererTexture.GetSampling(),i=this._rendererTexture.IsSampled(),r=this._rendererTexture.CanReadPixels();this._rendererTexture._DeleteGPUResources(),this._rendererTexture=null,this._rendererTexture=this._renderer.CreateDynamicTexture(e,t,{sampling:s,mipMap:!1,isRenderTarget:!0,isSampled:i,canReadPixels:r}),this._CalculateProjection()}_GetTextureView(){return this._isBackBuffer?this._renderer._GetSwapChainTexView():this._rendererTexture._GetTextureView()}_CalculateProjection(){this._renderer.CalculatePerspectiveMatrix(this._projectionMatrix,this.GetWidth()/this.GetHeight()),this._lastFov=this._renderer.GetFovY(),this._lastNearZ=this._renderer.GetNearZ(),this._lastFarZ=this._renderer.GetFarZ()}IsDefaultSize(){return this._isDefaultSize}IsBackBuffer(){return this._isBackBuffer}HasDepthBuffer(){return this._depth}GetWidth(){return this._isBackBuffer?this._renderer.GetWidth():this._rendererTexture.GetWidth()}GetHeight(){return this._isBackBuffer?this._renderer.GetHeight():this._rendererTexture.GetHeight()}GetTexture(){if(this._rendererTexture)return this._rendererTexture;throw new Error("no texture")}GetRenderer(){return this._renderer}GetMultisampling(){return this._multisampling}GetProjectionMatrix(){return this._renderer.GetFovY()===this._lastFov&&this._renderer.GetNearZ()===this._lastNearZ&&this._renderer.GetFarZ()===this._lastFarZ||this._CalculateProjection(),this._projectionMatrix}IsLinearSampling(){return this._rendererTexture.IsLinearSampling()}IsSampled(){return this._rendererTexture.IsSampled()}CanReadPixels(){return this._rendererTexture.CanReadPixels()}IsCompatibleWithOptions(e){return"nearest"!==(e=Object.assign({},gp,e)).sampling===this.IsLinearSampling()&&!!e.isSampled===this.IsSampled()&&!!e.canReadPixels===this.CanReadPixels()&&!!e.depth===this.HasDepthBuffer()&&("number"==typeof e.width||"number"==typeof e.height?!this.IsDefaultSize()&&this.GetWidth()===Math.floor(e.width)&&this.GetHeight()===Math.floor(e.height):this.IsDefaultSize())}_SetIsAwaitingClear(e){this._isAwaitingClear=!!e}_IsAwaitingClear(){return this._isAwaitingClear}_GetClearColor(){return this._clearColor}static OnContextLost(){}static allRenderTargets(){return Sp.values()}}}{const Gp=self.C3;Gp.Gfx.WebGPUTimeQuerySet=class{#e;#r=0;#s=null;#t=null;#d=null;constructor(e){this.#e=e}SetQueryCount(e){if(e!==this.#r&&(this.#r=e,this.#s&&this.#s.destroy(),this.#t&&this.#t.destroy(),this.#d&&this.#d.destroy(),this.#r>0)){const e=this.#e._GetDevice();this.#s=e.createQuerySet({count:this.#r,type:"timestamp"});const t=globalThis.GPUBufferUsage;this.#t=e.createBuffer({size:this.#m(),usage:t.QUERY_RESOLVE|t.COPY_SRC}),this.#d=this.#i()}}GetQueryCount(){return this.#r}#i(){const e=this.#e._GetDevice(),t=globalThis.GPUBufferUsage;return e.createBuffer({size:this.#m(),usage:t.COPY_DST|t.MAP_READ})}#m(){return 8*this.#r}_GetQuerySet(){return this.#s}Resolve(e){e.resolveQuerySet(this.#s,0,this.#r,this.#t,0),e.copyBufferToBuffer(this.#t,0,this.#d,0,this.#m())}async GetResult(e){const t=this.#d;this.#d=this.#i();const s=this.#m();await t.mapAsync(globalThis.GPUMapMode.READ,0,s);const i=t.getMappedRange(0,s),r=new BigUint64Array(i.slice(0));t.destroy();for(let t=0,s=r.length;t<s;++t)e.has(t)||(r[t]=BigInt(0));return r}}}{const yp=globalThis.C3,Ip=globalThis.assert,Tp=globalThis.GPUBufferUsage,Cp=2,bp=4,xp=2,wp=4;yp.Gfx.MeshDataWebGPU=class extends yp.Gfx.MeshData{#e=null;#s=null;#m=null;#t=null;#r=null;WebGPUInitRenderPassVertexBuffers(e){e.setVertexBuffer(0,this.#e),e.setVertexBuffer(1,this.#s),e.setVertexBuffer(2,this.#t),e.setVertexBuffer(3,this.#m)}WebGPUInitRenderPassIndexBuffer(e){e.setIndexBuffer(this.#r,this.IsIndexTypeUint16()?"uint16":"uint32")}CreateGPUResources(){if(super.CreateGPUResources(),this.IsSmall())return;const e=this.GetRenderer()._GetDevice(),t=this.GetDebugLabel(),s=t?"-"+t:"";this.#e=e.createBuffer({label:"positionbuffer"+s,size:this.positions.byteLength,usage:Tp.VERTEX|Tp.COPY_DST}),this.#s=e.createBuffer({label:"texcoordbuffer"+s,size:this.texCoords.byteLength,usage:Tp.VERTEX|Tp.COPY_DST}),this.#m=e.createBuffer({label:"texindexbuffer"+s,size:this.texIndices.byteLength,usage:Tp.VERTEX|Tp.COPY_DST}),this.#t=e.createBuffer({label:"colorbuffer"+s,size:this.colors.byteLength,usage:Tp.VERTEX|Tp.COPY_DST}),this.#r=e.createBuffer({label:"indexbuffer"+s,size:4*Math.ceil(this.indices.byteLength/4),usage:Tp.INDEX|Tp.COPY_DST})}WriteGPUData(e){const t=this.GetRenderer(),s=t._GetDevice().queue;let i=this.GetPendingBufferUpdate("positions"),r=i.GetPendingChange();if(r){const e=r.end-r.start,t=12;s.writeBuffer(this.#e,r.start*t,this.positions.buffer,r.start*t,e*t),i.Reset()}if(i=this.GetPendingBufferUpdate("texCoords"),r=i.GetPendingChange(),r){const e=r.end-r.start,t=8;s.writeBuffer(this.#s,r.start*t,this.texCoords.buffer,r.start*t,e*t),i.Reset()}if(e&&(i=this.GetPendingBufferUpdate("texIndices"),r=i.GetPendingChange(),r)){const e=r.end-r.start;s.writeBuffer(this.#m,4*r.start,this.texIndices.buffer,4*r.start,4*e),i.Reset()}if(i=this.GetPendingBufferUpdate("colors"),r=i.GetPendingChange(),r){const e=r.end-r.start,n=4*(t.IsColorDataF16()?2:4);s.writeBuffer(this.#t,r.start*n,this.colors.buffer,r.start*n,e*n),i.Reset()}if(i=this.GetPendingBufferUpdate("indices"),r=i.GetPendingChange(),r){const e=this.IsIndexTypeUint16()?2:4;let t=r.start*e,n=(r.end-r.start)*e;t%4!=0&&(t-=t%4),n%4!=0&&(n+=4-n%4),s.writeBuffer(this.#r,t,this.indices.buffer,t,n),i.Reset()}}ReleaseGPUResources(){super.ReleaseGPUResources(),this.#e&&(this.#e.destroy(),this.#e=null),this.#s&&(this.#s.destroy(),this.#s=null),this.#m&&(this.#m.destroy(),this.#m=null),this.#t&&(this.#t.destroy(),this.#t=null),this.#r&&(this.#r.destroy(),this.#r=null)}OnContextLost(){this.#e=null,this.#s=null,this.#m=null,this.#t=null,this.#r=null}}}{const Pp=self.C3,Rp={getDrawSize:null,getRenderTarget:null,releaseRenderTarget:null,getTime:null,redraw:null};Pp.Gfx.EffectChainManager=class{constructor(e){e=Object.assign({},Rp,e),this._cbGetDrawSize=e.getDrawSize,this._cbGetRenderTarget=e.getRenderTarget,this._cbReleaseRenderTarget=e.releaseRenderTarget,this._cbGetTime=e.getTime,this._cbRedraw=e.redraw,this._webgpuBackTexture=null,this._allEffectChains=new Set}_AddEffectChain(e){this._allEffectChains.add(e)}_RemoveEffectChain(e){this._allEffectChains.delete(e)}OnContextLost(){this._webgpuBackTexture=null;for(const e of this._allEffectChains)e.OnContextLost()}GetDrawSize(e){return this._cbGetDrawSize?this._cbGetDrawSize(e):[e.GetWidth(),e.GetHeight()]}GetRenderTarget(e){return this._cbGetRenderTarget(e)}ReleaseRenderTarget(e,t){this._cbReleaseRenderTarget(e,t)}GetTime(){return this._cbGetTime()}Redraw(e){this._cbRedraw(e)}_GetWebGPUBackTexture(e,t,s){return t=Math.floor(t),s=Math.floor(s),!this._webgpuBackTexture||this._webgpuBackTexture.GetWidth()===t&&this._webgpuBackTexture.GetHeight()===s||(e.DeleteTexture(this._webgpuBackTexture),this._webgpuBackTexture=null),null===this._webgpuBackTexture&&(this._webgpuBackTexture=e.CreateStaticTexture(null,{width:t,height:s,sampling:"nearest",mipMap:!1})),this._webgpuBackTexture}}}{const vp=self.C3,Ap=self.assert,Mp=self.glMatrix,Dp=Mp.mat4,Ep=vp.New(vp.Rect),Fp=vp.New(vp.Rect),Op=vp.New(vp.Rect),Bp=vp.New(vp.Rect),kp=Dp.create(),Lp=Dp.create(),Np={drawContent:null,getSourceTextureInfo:null,getShaderParameters:null,invalidateRenderTargets:!1},Wp={indexMap:null,forcePreDraw:!1,forcePostDraw:!1,is3D:!1,isSourceTextureRotated:!1,isRotatedOrNegativeSizeInstance:!1,useFullSurface:!1};vp.Gfx.EffectChain=class{constructor(e,t){t=Object.assign({},Np,t),this._manager=e,this._cbDrawContent=t.drawContent,this._cbGetSourceTextureInfo=t.getSourceTextureInfo,this._cbGetShaderParameters=t.getShaderParameters,this._cbDrawContentHook=null,this._shaderProgramList=[],this._shaderProgramIndices=[],this._steps=[],this._needsRebuild=!1,this._blendMode=0,this._isAnyShaderAnimated=!1,this._isAnyShaderDepthSampling=!1,this._isAnyShaderBackgroundBlending=!1,this._isAnyShaderCrossSampling=!1,this._isAnyIsSrcTexRotated=!1,this._useCopyTextureBackgroundSampling=!1,this._didChangeTransform=!1,this._depthEnabledAtStart=!1,this._coplanarColorPassAtStart=!1,this._canUseFastPath=!1,this._useFullSurface=!1,this._isSourceTextureRotated=!1,this._numTempSurfacesRequired=0,this._renderTargets=[null,null,null],this._invalidateRenderTargets=!!t.invalidateRenderTargets,this._boxExtendHorizontal=0,this._boxExtendVertical=0,this._drawWidth=0,this._drawHeight=0,this._contentObject=null,this._contextObject=null,this._layoutRect=vp.New(vp.Rect),this._drawSurfaceRect=vp.New(vp.Rect),this._rcTexOriginal=vp.New(vp.Rect),this._rcTexBounce=vp.New(vp.Rect),this._rcTexDest=vp.New(vp.Rect),this._devicePixelRatio=1,this._layerScale=1,this._layerAngle=0,this._time=0,this._destRenderTarget=null,this._backTex=null,this._compositOffX=0,this._compositOffY=0,this._compositRtWidth=0,this._compositRtHeight=0,this._updateOwnProjection=!1,this._projectionMatrix=Dp.create(),this._modelViewMatrix=Dp.create(),this._manager._AddEffectChain(this)}Release(){this._manager._RemoveEffectChain(this),vp.clearArray(this._steps),vp.clearArray(this._shaderProgramList),vp.clearArray(this._shaderProgramIndices),this._contentObject=null,this._contextObject=null,this._cbDrawContent=null,this._cbGetSourceTextureInfo=null,this._cbGetShaderParameters=null}OnContextLost(){this._needsRebuild=!0,vp.clearArray(this._steps),vp.clearArray(this._shaderProgramList),vp.clearArray(this._shaderProgramIndices)}NeedsRebuild(){return this._needsRebuild}BuildSteps(e,t){if(t=Object.assign({},Wp,t),vp.clearArray(this._steps),this._boxExtendHorizontal=0,this._boxExtendVertical=0,this._isAnyShaderAnimated=!1,this._isAnyShaderDepthSampling=!1,this._isAnyShaderBackgroundBlending=!1,this._isAnyShaderCrossSampling=!1,this._isAnyIsSrcTexRotated=!1,this._useCopyTextureBackgroundSampling=!1,this._numTempSurfacesRequired=0,this._isSourceTextureRotated=!!t.isSourceTextureRotated,this._useFullSurface=!!t.useFullSurface,this._needsRebuild=!1,vp.shallowAssignArray(this._shaderProgramList,e),0===e.length)return;if(t.indexMap){if(t.indexMap.length!==e.length)throw new Error("incorrect indexMap length");vp.shallowAssignArray(this._shaderProgramIndices,t.indexMap)}else{vp.clearArray(this._shaderProgramIndices);for(let t=0,s=e.length;t<s;++t)this._shaderProgramIndices.push(t)}for(const t of e)this._boxExtendHorizontal+=t.GetBoxExtendHorizontal(),this._boxExtendVertical+=t.GetBoxExtendVertical(),t.IsAnimated()&&(this._isAnyShaderAnimated=!0),t.UsesDepth()&&(this._isAnyShaderDepthSampling=!0),t.BlendsBackground()&&(this._isAnyShaderBackgroundBlending=!0),t.UsesCrossSampling()&&(this._isAnyShaderCrossSampling=!0),t.UsesIsSrcTexRotated()&&(this._isAnyIsSrcTexRotated=!0);this._useCopyTextureBackgroundSampling=this._ShouldUseCopyTextureBackgroundSampling(e[0].GetRenderer());const s=this._ShouldPreDraw(e[0],t),i=this._ShouldPostDraw(e.at(-1),t);if(1===e.length&&!s&&!i)return void(this._canUseFastPath=!0);this._canUseFastPath=!1;let r=0;s&&(this._numTempSurfacesRequired=1,this._steps.push(vp.New(vp.Gfx.EffectChain.Step.PreDraw,this,-1,1)),r=1);for(let t=0,n=e.length;t<n;++t)if(0!==t||s){let e=1===r?2:1;t!==n-1||i||(e=0),this._numTempSurfacesRequired=Math.max(this._numTempSurfacesRequired,e),this._steps.push(vp.New(vp.Gfx.EffectChain.Step.Bounce,this,r,e,t)),r=e}else this._numTempSurfacesRequired=1,this._steps.push(vp.New(vp.Gfx.EffectChain.Step.FirstBounce,this,-1,1,t)),r=1;i&&this._steps.push(vp.New(vp.Gfx.EffectChain.Step.PostDraw,this,r,0))}_ShouldPreDraw(e,t){return!!(t.forcePreDraw||e.MustPreDraw()||t.is3D&&!e.Supports3DDirectRendering()||e.UsesDepth()&&!this._useFullSurface||0!==this._boxExtendHorizontal||0!==this._boxExtendVertical)||(e.GetRenderer().IsWebGL()?e.BlendsBackground()&&(t.isRotatedOrNegativeSizeInstance||t.isSourceTextureRotated)||e.UsesAnySrcRectOrPixelSize()&&t.isSourceTextureRotated:e.BlendsBackground()&&!this._useCopyTextureBackgroundSampling&&t.isRotatedOrNegativeSizeInstance)}_ShouldPostDraw(e,t){return!!t.forcePostDraw||(e.GetRenderer().IsWebGL()?e.BlendsBackground()||e.UsesCrossSampling():(e.BlendsBackground()||e.UsesCrossSampling())&&this._UseRenderTargetBackgroundSampling())}_ShouldUseCopyTextureBackgroundSampling(e){return e.IsWebGPU()&&this._isAnyShaderBackgroundBlending&&!this._isAnyShaderCrossSampling}Render(e,t,s){e.IsWebGPU()&&null===t&&(t=e.GetBackbufferRenderTarget()),this._destRenderTarget=t,this._contentObject=s.contentObject||null,this._contextObject=s.contextObject||null,this._blendMode=s.blendMode||0,this._devicePixelRatio=s.devicePixelRatio||1,this._layerScale=s.layerScale||1,this._layerAngle=s.layerAngle||0,this._time="number"==typeof s.time?s.time:this._manager.GetTime(),this._didChangeTransform=!1,e.ResetDidChangeTransformFlag(),this._isAnyShaderAnimated&&this._Redraw();let i=!1;if(this._UseCopyTextureBackgroundSampling()&&(this._CalculateDrawSizeAndRectangles(e,s),i=!0,this._backTex=this._manager._GetWebGPUBackTexture(e,this._drawWidth,this._drawHeight),Ep.copy(this._drawSurfaceRect),Ep.roundOuter(),e.IsWebGPU()&&e._MaybeDoPendingClearRenderPass(this._destRenderTarget),e.CopyTextureToTexture(this._destRenderTarget.GetTexture(),this._backTex,Ep.getLeft(),Ep.getTop(),Ep.width(),Ep.height())),this._canUseFastPath)this._Render_FastPath(e,s);else if(i||this._CalculateDrawSizeAndRectangles(e,s),0!==this._rcTexOriginal.width()||0!==this._rcTexOriginal.height()){e.SetAlphaBlend(),e.ResetCullState(),e.ResetColor(),e.SetBaseZ(0),e.SetCurrentZ(0),this._cbDrawContentHook=s.drawContentHook||null,this._compositOffX=s.compositOffX||0,this._compositOffY=s.compositOffY||0,this._compositRtWidth=s.compositRtWidth||0,this._compositRtHeight=s.compositRtHeight||0,this._updateOwnProjection=!!s.updateOwnProjection,this._OnBeforeStartEffectChain(e),this._renderTargets[0]=t,this._renderTargets[1]=this._numTempSurfacesRequired>=1?this._GetRenderTarget():null,this._renderTargets[2]=2===this._numTempSurfacesRequired?this._GetRenderTarget():null;for(const t of this._steps){const s=this._GetRenderTargetForId(t.GetSrcTargetId()),i=this._GetRenderTargetForId(t.GetDestTargetId());e.IsWebGPU()?t.Run_WebGPU(e,s,i):t.Run_WebGL(e,s,i)}e.SetTexture(null),this._renderTargets[1]&&this._ReleaseRenderTarget(this._renderTargets[1]),this._renderTargets[2]&&this._ReleaseRenderTarget(this._renderTargets[2]),this._renderTargets.fill(null),this._OnAfterEndEffectChain(e),this._destRenderTarget=null,this._backTex=null,this._contentObject=null,this._contextObject=null,this._cbDrawContentHook=null}}_CalculateDrawSizeAndRectangles(e,t){const[s,i]=this._manager.GetDrawSize(e);this._SetDrawSize(e,s,i),this._CalculateRectangles(t)}_SetDrawSize(e,t,s){if(t<=0||s<=0)throw new Error("invalid draw size");this._drawWidth===t&&this._drawHeight===s||this._CalculateDeviceTransformMatrices(e,t,s,0,0,this._projectionMatrix,this._modelViewMatrix),this._drawWidth=t,this._drawHeight=s}_CalculateDeviceTransformMatrices(e,t,s,i,r,n,a){const o=t/2+i,h=s/2+r;e.CalculatePerspectiveMatrix(n,t/s);const l=e.CalculateLookAtModelView2(o,h,e.GetDefaultCameraZ(s),o,h,0,s);Dp.copy(a,l)}_CalculateRectangles(e){if(this._layoutRect.copy(e.layoutRect),e.drawSurfaceRect?this._drawSurfaceRect.copy(e.drawSurfaceRect):this._drawSurfaceRect.set(0,0,this._drawWidth,this._drawHeight),this._canUseFastPath){const t=e.compositOffX??0,s=e.compositOffY??0;this._drawSurfaceRect.offset(-t,-s)}this._rcTexOriginal.copy(this._drawSurfaceRect),this._rcTexOriginal.divide(this._drawWidth,this._drawHeight);const t=this._layerScale*this._devicePixelRatio;this._drawSurfaceRect.inflate(this._boxExtendHorizontal*t,this._boxExtendVertical*t),this._rcTexDest.copy(this._drawSurfaceRect),this._rcTexDest.divide(this._drawWidth,this._drawHeight),this._drawSurfaceRect.clampBoth(0,0,this._drawWidth,this._drawHeight),this._rcTexBounce.copy(this._drawSurfaceRect),this._rcTexBounce.divide(this._drawWidth,this._drawHeight)}_OnBeforeStartEffectChain(e){if(this._depthEnabledAtStart=e.IsDepthEnabled(),this._coplanarColorPassAtStart=e.IsCoplanarColorPass(),this._useFullSurface)e.SetDepthEnabled(!1),this._isAnyShaderDepthSampling&&e.SetDepthSamplingEnabled(!0);else{if(Ep.copy(this._drawSurfaceRect),e.IsWebGL()){const e=this._layerScale*this._devicePixelRatio;Ep.inflate(Math.max(this._boxExtendHorizontal,1)*e,Math.max(this._boxExtendVertical,1)*e),Ep.roundOuter(),Ep.clamp(0,0,this._drawWidth,this._drawHeight)}else Ep.roundOuter();e.SetScissorRect(Ep.getLeft(),Ep.getTop(),Ep.width(),Ep.height(),this._drawHeight)}}_OnAfterEffectChainDrawContent(e){e.ResetColor(),this._useFullSurface||(this._coplanarColorPassAtStart?e.CoplanarRestoreStandardRendering(!1):e.SetDepthEnabled(!1),this._isAnyShaderDepthSampling&&e.SetDepthSamplingEnabled(!0)),e.IsWebGPU()&&e.SetNormalizedCoordsProgramVariant(!0)}_OnAfterEndEffectChain(e){e.SetDepthSamplingEnabled(!1),this._coplanarColorPassAtStart?e.CoplanarStartColorPass(this._depthEnabledAtStart):e.SetDepthEnabled(this._depthEnabledAtStart),this._useFullSurface||e.RemoveScissorRect(),e.IsWebGPU()&&e.SetNormalizedCoordsProgramVariant(!1),this._didChangeTransform=e.DidChangeTransform()}_ClampRcTexDest(){this._rcTexDest.clamp(0,0,1,1)}_GetRenderTargetForId(e){return e<0?null:this._renderTargets[e]}_GetRenderTarget(){return this._manager.GetRenderTarget(this)}_GetDestRenderTarget(){return this._destRenderTarget}_ReleaseRenderTarget(e){this._manager.ReleaseRenderTarget(e,this)}_GetShaderProgramAt(e){return this._shaderProgramList[e]}_DrawContent(e){this._cbDrawContentHook?this._cbDrawContentHook(this,e,()=>this._cbDrawContent(e,this)):this._cbDrawContent(e,this),this._canUseFastPath||this._OnAfterEffectChainDrawContent(e)}_IsRenderTargetSameSizeAndOffset(e){if(this._useFullSurface)return!0;if(0!==this._compositOffX||0!==this._compositOffY||0!==this._compositRtWidth||0!==this._compositRtHeight)return!1;const[t,s]=e.GetRenderTargetSize(e.GetRenderTarget());return t===this._drawWidth&&s===this._drawHeight}_SetDeviceTransform(e,t){let s=this._projectionMatrix,i=this._modelViewMatrix;if(t&&!this._IsRenderTargetSameSizeAndOffset(e)){let t,r;s=kp,i=Lp,0!==this._compositRtWidth&&0!==this._compositRtHeight?[t,r]=[this._compositRtWidth,this._compositRtHeight]:[t,r]=e.GetRenderTargetSize(e.GetRenderTarget()),this._CalculateDeviceTransformMatrices(e,t,r,this._compositOffX,this._compositOffY,s,i),this._useFullSurface||e.RemoveScissorRect()}e.SetProjectionMatrix(s),e.SetModelViewMatrix(i)}_Redraw(){this._manager.Redraw(this)}_GetShaderParameters(e,t){return this._cbGetShaderParameters(this._shaderProgramIndices[e],t)}_SetProgramParameters(e,t){let s=this._rcTexDest,i=this._rcTexBounce,r=this._rcTexOriginal;e.IsWebGL()&&(Fp.copy(s),Fp.flipAround(1),s=Fp,Op.copy(i),Op.flipAround(1),i=Op,Bp.copy(r),Bp.flipAround(1),r=Bp),this._DoSetProgramParameters(e,t,i,r,s,1/this._drawWidth,1/this._drawHeight)}_SetFirstBounceProgramParameters(e,t){let s=this._rcTexBounce,i=this._rcTexOriginal,r=1/this._drawWidth,n=1/this._drawHeight;if(this._cbGetSourceTextureInfo){let{srcTexRect:e,srcWidth:t,srcHeight:a}=this._cbGetSourceTextureInfo(this._contentObject);e||(Ep.set(0,0,0,0),e=Ep),t||(t=this._drawWidth),a||(a=this._drawHeight),s=e,i=e,r=1/t,n=1/a}else e.IsWebGL()&&(Op.copy(s),Op.flipAround(1),s=Op,Bp.copy(i),Bp.flipAround(1),i=Bp);let a=this._rcTexDest;e.IsWebGL()&&(a=Fp,a.copy(this._rcTexDest),a.flipAround(1)),this._DoSetProgramParameters(e,t,s,i,a,r,n),e.IsWebGPU()&&this._isAnyIsSrcTexRotated&&e.SetProgramParameter_IsSrcTexRotated(this._isSourceTextureRotated)}_GetBackTex(e){return this._isAnyShaderBackgroundBlending?e.IsWebGPU()?this._UseCopyTextureBackgroundSampling()?this._backTex:this._destRenderTarget.GetTexture():this._destRenderTarget:null}_DoSetProgramParameters(e,t,s,i,r,n,a){e.SetProgramParameters(this._GetBackTex(e),r,s,i,this._layoutRect,n,a,this._devicePixelRatio,this._layerScale,this._layerAngle,this._time),e.SetProgramCustomParameters(this._GetShaderParameters(t,e))}_Render_FastPath(e,t){const s=this._shaderProgramList[0],i=e.IsDepthEnabled(),r=s.UsesDepth();r&&(e.SetDepthEnabled(!1),e.SetDepthSamplingEnabled(!0),this._rcTexDest.set(0,0,1,1),this._rcTexOriginal.set(0,0,1,1)),e.SetProgram(s),e.SetBlendMode(this._blendMode),e.SetRenderTarget(this._destRenderTarget),e.ResetCullState();let n=0,a=1;if(this._rcTexOriginal.set(0,0,1,1),s.UsesAnySrcRectOrPixelSize()&&this._cbGetSourceTextureInfo){const{srcTexRect:e,srcWidth:t,srcHeight:s}=this._cbGetSourceTextureInfo(this._contentObject);e&&this._rcTexOriginal.copy(e),n=Number.isFinite(t)?1/t:0,a=Number.isFinite(s)?1/s:0}else{const[t,s]=this._manager.GetDrawSize(e);n=1/t,a=1/s}t.layoutRect?this._layoutRect.copy(t.layoutRect):this._layoutRect.set(0,0,0,0),e.SetProgramParameters(this._GetBackTex(e),this._rcTexDest,this._rcTexOriginal,this._rcTexOriginal,this._layoutRect,n,a,this._devicePixelRatio,this._layerScale,this._layerAngle,this._time),e.SetProgramCustomParameters(this._GetShaderParameters(0,e)),e.IsWebGPU()&&this._isAnyIsSrcTexRotated&&e.SetProgramParameter_IsSrcTexRotated(this._isSourceTextureRotated),e.SetBaseZ(0),this._DrawContent(e),r&&(e.SetDepthSamplingEnabled(!1),e.SetDepthEnabled(i))}_UseCopyTextureBackgroundSampling(){return this._useCopyTextureBackgroundSampling}_UseRenderTargetBackgroundSampling(){return!this._useCopyTextureBackgroundSampling}IsAnyShaderBackgroundBlending(){return this._isAnyShaderBackgroundBlending}CanSkipCalculatingDrawSurfaceRect(){return!!this._canUseFastPath&&!this._UseCopyTextureBackgroundSampling()}UseFullSurface(){return this._useFullSurface}GetContentObject(){return this._contentObject}GetContextObject(){return this._contextObject}_GetBlendMode(){return this._blendMode}_UpdateOwnProjection(){return this._updateOwnProjection}DidChangeTransform(){return this._didChangeTransform}_GetDrawSurfaceRect(){return this._drawSurfaceRect}_GetRcTexBounce(){return this._rcTexBounce}_ShouldInvalidateRenderTargets(){return this._invalidateRenderTargets}async DebugLogRenderTargetContents(e,t,s){}}}{const Up=self.C3;Up.Gfx.EffectChain.Step=class{constructor(e,t,s,i=-1){this._effectChain=e,this._srcTargetId=t,this._destTargetId=s,this._index=i}GetEffectChain(){return this._effectChain}GetSrcTargetId(){return this._srcTargetId}GetDestTargetId(){return this._destTargetId}GetIndex(){return this._index}GetShaderProgram(){return this.GetEffectChain()._GetShaderProgramAt(this.GetIndex())}Run_WebGL(e,t,s){}Run_WebGPU(e,t,s){}}}{const Vp=self.C3;Vp.Gfx.EffectChain.Step.PreDraw=class extends Vp.Gfx.EffectChain.Step{constructor(e,t,s,i){super(e,t,s,i)}Run_WebGL(e,t,s){const i=this.GetEffectChain();e.SetAlphaBlend(),e.ResetCullState(),e.SetTextureFillMode(),e.SetRenderTarget(s,i._UpdateOwnProjection()),e.ClearRgba(0,0,0,0),i._DrawContent(e),i._ClampRcTexDest()}Run_WebGPU(e,t,s){const i=this.GetEffectChain();e.SetAlphaBlend(),e.ResetCullState(),e.SetTextureFillMode(),e.SetRenderTarget(s,!1),e.ClearRgba(0,0,0,0),i._DrawContent(e),i._ClampRcTexDest()}}}{const Hp=self.C3,jp=Hp.New(Hp.Rect),zp=Hp.New(Hp.Quad);Hp.Gfx.EffectChain.Step.PostDraw=class extends Hp.Gfx.EffectChain.Step{constructor(e,t,s,i){super(e,t,s,i)}Run_WebGL(e,t,s){const i=this.GetEffectChain();e.SetTextureFillMode(),e.SetRenderTarget(s),i._SetDeviceTransform(e,!0),e.SetBlendMode(i._GetBlendMode()),e.SetTexture(t.GetTexture()),zp.setFromRect(i._GetDrawSurfaceRect()),jp.copy(i._GetRcTexBounce()),jp.flipAround(1),e.Quad3(zp,jp),i._ShouldInvalidateRenderTargets()&&e.InvalidateRenderTarget(t)}Run_WebGPU(e,t,s){const i=this.GetEffectChain();e.SetTextureFillMode(),e.SetRenderTarget(s,!1),i._IsRenderTargetSameSizeAndOffset(e)?zp.setFromRect(i._GetRcTexBounce()):(e.SetNormalizedCoordsProgramVariant(!1),i._SetDeviceTransform(e,!0),zp.setFromRect(i._GetDrawSurfaceRect())),e.SetBackTexture(null),e.SetBlendMode(i._GetBlendMode()),e.SetTexture(t.GetTexture()),i.UseFullSurface()?e.FullscreenQuad():e.Quad3(zp,i._GetRcTexBounce())}}}{const Xp=self.C3;Xp.Gfx.EffectChain.Step.FirstBounce=class extends Xp.Gfx.EffectChain.Step{constructor(e,t,s,i){super(e,t,s,i)}Run_WebGL(e,t,s){const i=this.GetEffectChain();e.SetRenderTarget(s,i._UpdateOwnProjection()),e.ClearRgba(0,0,0,0),e.SetCopyBlend(),e.SetProgram(this.GetShaderProgram()),i._SetFirstBounceProgramParameters(e,this.GetIndex()),i._DrawContent(e),i._ClampRcTexDest()}Run_WebGPU(e,t,s){const i=this.GetEffectChain();e.SetRenderTarget(s,!1),e.ClearRgba(0,0,0,0),e.SetCopyBlend(),e.SetProgram(this.GetShaderProgram()),i._SetFirstBounceProgramParameters(e,this.GetIndex()),i._DrawContent(e),i._ClampRcTexDest()}}}{const Yp=self.C3,qp=Yp.New(Yp.Rect),Kp=Yp.New(Yp.Quad);Yp.Gfx.EffectChain.Step.Bounce=class extends Yp.Gfx.EffectChain.Step{constructor(e,t,s,i){super(e,t,s,i)}Run_WebGL(e,t,s){const i=this.GetEffectChain();e.SetRenderTarget(s);const r=0===this.GetDestTargetId();r?e.SetBlendMode(i._GetBlendMode()):(e.ClearRgba(0,0,0,0),e.SetCopyBlend()),e.SetProgram(this.GetShaderProgram()),i._SetProgramParameters(e,this.GetIndex()),e.SetTexture(t.GetTexture()),i._SetDeviceTransform(e,r),Kp.setFromRect(i._GetDrawSurfaceRect()),qp.copy(i._GetRcTexBounce()),qp.flipAround(1),e.Quad3(Kp,qp),i._ShouldInvalidateRenderTargets()&&e.InvalidateRenderTarget(t)}Run_WebGPU(e,t,s){const i=this.GetEffectChain();e.SetRenderTarget(s,!1),0===this.GetDestTargetId()?(e.SetBlendMode(i._GetBlendMode()),e.SetBackTexture(null),i._IsRenderTargetSameSizeAndOffset(e)?Kp.setFromRect(i._GetRcTexBounce()):(e.SetNormalizedCoordsProgramVariant(!1),i._SetDeviceTransform(e,!0),Kp.setFromRect(i._GetDrawSurfaceRect()))):(e.ClearRgba(0,0,0,0),e.SetCopyBlend(),Kp.setFromRect(i._GetRcTexBounce())),e.SetProgram(this.GetShaderProgram()),i._SetProgramParameters(e,this.GetIndex()),e.SetTexture(t.GetTexture()),i.UseFullSurface()?e.FullscreenQuad():e.Quad3(Kp,i._GetRcTexBounce())}}}{let $p=function(e,t){const s=e[0]-t[0];return 0!==s?s:e[1]-t[1]};SortZOrderList=$p;const Jp=self.C3,Zp=self.C3X;let Qp=null;const ef=new Set,tf=[],sf=[];let rf=!1,nf=!1,af=!1;const of=new Set(["vsync","unlimited-tick","unlimited-frame"]);self.IRuntime=class{constructor(e){Qp=e,Object.defineProperties(this,{assets:{value:Qp.GetAssetManager().GetIAssetManager(),writable:!1},collisions:{value:Qp.GetCollisionEngine().GetICollisionEngine(),writable:!1},objects:{value:{},writable:!1},globalVars:{value:{},writable:!1},projectName:{value:Qp.GetProjectName(),writable:!1},projectVersion:{value:Qp.GetProjectVersion(),writable:!1},projectId:{value:Qp.GetAppId(),writable:!1},projectUniqueId:{value:Qp.GetProjectUniqueId(),writable:!1},exportDate:{value:new Date(Qp.GetExportTimestamp()),writable:!1},storage:{value:new self.IStorage(Qp),writable:!1},isInWorker:{value:Qp.IsInWorker(),writable:!1},viewportWidth:{value:Qp.GetOriginalViewportWidth(),writable:!1},viewportHeight:{value:Qp.GetOriginalViewportHeight(),writable:!1},sampling:{value:Qp.GetSampling(),writable:!1},platformInfo:{value:new self.IPlatformInfo(e),writable:!1},sdk:{value:new self.ISDKUtils(e),writable:!1}}),Qp.UserScriptDispatcher().addEventListener("keydown",e=>{ef.has(e.key)?e.stopPropagation():ef.add(e.key)}),Qp.UserScriptDispatcher().addEventListener("keyup",e=>ef.delete(e.key)),Qp.Dispatcher().addEventListener("window-blur",()=>ef.clear()),Qp.IsInWorker()&&(self.alert=e=>(rf||(rf=!0,console.warn("[Construct] alert() was called from a Web Worker, because the project 'Use worker' setting is enabled. This method is not normally available in a Web Worker. Construct has implemented the alert for you, but note that other features may be missing in worker mode. You may wish to disable 'Use worker', or use a more convenient function like console.log(). For more information please refer to the scripting section of the manual.")),this.alert(e)))}_InitObjects(e){Object.defineProperties(this.objects,e)}_InitGlobalVars(e){Object.defineProperties(this.globalVars,e)}addEventListener(e,t){Qp.UserScriptDispatcher().addEventListener(e,t)}removeEventListener(e,t){Qp.UserScriptDispatcher().removeEventListener(e,t)}callFunction(e,...t){Zp.RequireString(e);const s=Qp.GetEventSheetManager(),i=s.GetFunctionBlockByName(e);if(!i)throw new Error(`cannot find function name '${e}'`);if(!i.IsEnabled())return i.GetDefaultReturnValue();if(t.length<i.GetFunctionParameterCount())throw new Error(`not enough function parameters passed for '${e}' (${t.length} passed, ${i.GetFunctionParameterCount()} expected)`);const r=i.GetEventBlock();let n=r.GetSolModifiersIncludingParents();const a=s.GetCurrentEvent();if(a){n=n.slice(0);const e=new Set(n);for(const t of a.GetSolModifiersIncludingParents())e.has(t)||(n.push(t),e.add(t));for(const t of s.GetDynamicSolModifiersSet())e.has(t)||(n.push(t),e.add(t))}return r.RunAsExpressionOrJSFunctionCall(n,i.IsCopyPicked(),i.GetReturnType(),i.GetDefaultReturnValue(),null,...t)}setReturnValue(e){const t=Qp.GetEventStack().GetCurrentExpFuncStackFrame();if(!t)throw new Error("not in a function which returns a value");switch(t.GetFunctionReturnType()){case 1:"number"==typeof e&&t.SetFunctionReturnValue(e);break;case 2:"string"==typeof e&&t.SetFunctionReturnValue(e);break;case 3:"number"!=typeof e&&"string"!=typeof e||t.SetFunctionReturnValue(e)}}signal(e){Zp.RequireString(e),Qp.GetEventSheetManager().Signal(e)}waitForSignal(e){return Zp.RequireString(e),Qp.GetEventSheetManager().WaitForSignal(e)}getViewportSize(){return[Qp.GetOriginalViewportWidth(),Qp.GetOriginalViewportHeight()]}get isSuspended(){return Qp.IsSuspended()}get dt(){return Qp.GetDt()}get dtRaw(){return Qp.GetDtRaw()}get gameTime(){return Qp.GetGameTime()}get tickCount(){return Qp.GetTickCount()}get wallTime(){return Qp.GetWallTime()}get timeScale(){return Qp.GetTimeScale()}set timeScale(e){Zp.RequireFiniteNumber(e),Qp.SetTimeScale(e)}get fps(){return nf||(console.warn("IRuntime.fps is deprecated. Use IRuntime.framesPerSecond instead."),nf=!0),Qp.GetFramesPerSecond()}get framesPerSecond(){return Qp.GetFramesPerSecond()}get ticksPerSecond(){return Qp.GetTicksPerSecond()}get cpuUtilisation(){return Qp.GetMainThreadTime()}get gpuUtilisation(){return Qp.GetGPUUtilisation()}get framerateMode(){return Qp.GetFramerateMode()}set framerateMode(e){if(!of.has(e))throw new Error("invalid framerate mode");Qp._SetFramerateMode(e)}get minDt(){return Qp.GetMinDt()}set minDt(e){Zp.RequireFiniteNumber(e),Qp.SetMinDt(e)}get maxDt(){return Qp.GetMaxDt()}set maxDt(e){Qp.SetMaxDt(e)}set isPixelRoundingEnabled(e){Qp.SetPixelRoundingEnabled(!!e)}get isPixelRoundingEnabled(){return Qp.IsPixelRoundingEnabled()}get loadingProgress(){return Qp.GetAssetManager().GetLoadProgress()}get imageLoadingProgress(){return Qp.GetAssetManager().GetImageLoadProgress()}random(){return Qp.Random()}get layout(){const e=Qp.GetMainRunningLayout();if(!e)throw new Error("no layout is running - make sure a layout is loaded before accessing");return e.GetILayout()}getLayout(e){const t=Qp.GetLayoutManager();let s=null;if("number"!=typeof e&&"string"!=typeof e)throw new TypeError("expected string or number");if(s=t.GetLayout(e),!s)throw new Error("invalid layout");return s.GetILayout()}getAllLayouts(){return Qp.GetLayoutManager().GetAllLayouts().map(e=>e.GetILayout())}goToLayout(e){const t=Qp.GetLayoutManager();let s=null;if("number"!=typeof e&&"string"!=typeof e)throw new TypeError("expected string or number");if(s=t.GetLayout(e),!s)throw new Error("invalid layout");t.IsPendingChangeMainLayout()||t.ChangeMainLayout(s)}get keyboard(){const e=Qp._GetCommonScriptInterfaces().keyboard;if(!e)throw new Error("runtime.keyboard used but Keyboard object missing - add it to your project first");return e}get mouse(){const e=Qp._GetCommonScriptInterfaces().mouse;if(!e)throw new Error("runtime.mouse used but Mouse object missing - add it to your project first");return e}get touch(){const e=Qp._GetCommonScriptInterfaces().touch;if(!e)throw new Error("runtime.touch used but Touch object missing - add it to your project first");return e}get timelineController(){const e=Qp._GetCommonScriptInterfaces().timelineController;if(!e)throw new Error("runtime.timelineController used but Timeline Controller object missing - add it to your project first");return e}get renderer(){return Qp.GetCanvasManager().GetIRenderer()}invokeDownload(e,t){Zp.RequireString(e),Zp.RequireString(t),Qp.InvokeDownload(e,t)}getInstanceByUid(e){Zp.RequireFiniteNumber(e);const t=Qp.GetInstanceByUID(e);return t?t.GetInterfaceClass():null}sortZOrder(e,t){Zp.RequireFunction(t);const s=Qp.GetCurrentLayout();for(const t of e){const e=Qp._UnwrapIWorldInstance(t),s=e.GetWorldInfo();s.IsDestroyed()||(tf.push([s.GetLayer().GetIndex(),s.GetZIndex()]),sf.push(e))}if(0===tf.length)return;tf.sort($p),sf.sort((e,s)=>t(e.GetInterfaceClass(),s.GetInterfaceClass()));let i=!1;for(let e=0,t=tf.length;e<t;++e){const t=sf[e],r=s.GetLayerByIndex(tf[e][0]),n=tf[e][1],a=r._GetInstances();a[n]!==t&&(a[n]=t,t.GetWorldInfo()._SetLayer(r,!0),r.SetZIndicesChanged(t),i=!0)}i&&Qp.UpdateRender(),Jp.clearArray(tf),Jp.clearArray(sf)}destroyMultiple(e){for(const t of e){const e=Qp._UnwrapIWorldInstance(t);Qp.DestroyInstance(e)}Qp.GetEventSheetManager().IsInEventEngine()||Qp.GetLayoutManager().IsEndingLayout()||Qp.GetEventSheetManager().IsFlushingBlocked()||Qp.FlushPendingInstances()}async createWorker(e,t){af||(console.warn("IRuntime.createWorker() is deprecated. All modern browsers now support nested workers so this method is no longer needed."),af=!0);const s=new MessageChannel,i=s.port1,r=s.port2;return await Qp.PostComponentMessageToDOMAsync("runtime","script-create-worker",{url:e,opts:t,port2:r},[r]),i}alert(e){return Qp.PostComponentMessageToDOMAsync("runtime","alert",{message:e+(Qp.IsInWorker()?" [via Web Worker]":"")})}getHTMLLayer(e){return Zp.RequireFiniteNumber(e),Qp._GetHTMLLayerWrapElement(e)}addLoadPromise(e){Qp.AddLoadPromise(e)}async saveCanvasImage(e,t,s){Zp.RequireOptionalString(e),Zp.RequireOptionalNumber(t),Zp.RequireOptionalInstanceOf(s,DOMRect),s||(s=new DOMRect(0,0,0,0));const i=Qp.GetCanvasManager();if(!i)return;Qp.UpdateRender();const r=await i.SnapshotCanvas(e||"image/png",t,s.x,s.y,s.width,s.height);return await Qp.TriggerAsync(Jp.Plugins.System.Cnds.OnCanvasSnapshot,null),r}}}{const hf=self.C3,lf=self.C3X;let cf=null;self.IAssetManager=class{constructor(e){cf=e,Object.defineProperties(this,{isWebMOpusSupported:{value:!0,writable:!1}})}loadImageAsset(e){const t=self.IImageInfo._Unwrap(e);if(!t)throw new Error("invalid IImageInfo");t.LoadAsset(cf.GetRuntime())}fetchText(e){return cf.FetchText(e)}fetchJson(e){return cf.FetchJson(e)}fetchBlob(e){return cf.FetchBlob(e)}fetchArrayBuffer(e){return cf.FetchArrayBuffer(e)}getProjectFileUrl(e){return Promise.resolve(cf.GetProjectFileUrl(e))}getMediaFileUrl(e){return cf.GetMediaFileUrl(e)}get mediaFolder(){return cf.GetMediaSubfolder()}async decodeWebMOpus(e,t){throw new Error("decodeWebMOpus() is no longer supported - use Web Audio's decodeAudioData() directly as all supported platforms now support WebM Opus")}loadScripts(...e){return cf.LoadScripts(...e)}compileWebAssembly(e){return cf.CompileWebAssembly(e)}loadStyleSheet(e){return cf.LoadStyleSheet(e)}get projectFileList(){return cf.GetExportedFileList()}}}{const uf=self.C3,df=self.C3X;let _f=null;self.ICollisionEngine=class{constructor(e){_f=e,Object.defineProperties(this,{runtime:{value:_f.GetRuntime(),writable:!1}})}testOverlap(e,t){const s=_f.GetRuntime(),i=s._UnwrapIWorldInstance(e),r=s._UnwrapIWorldInstance(t);return _f.TestOverlap(i,r)}testOverlapAny(e,t){const s=_f.GetRuntime(),i=s._UnwrapIWorldInstance(e);for(const e of t){const t=s._UnwrapIWorldInstance(e);if(_f.TestOverlap(i,t))return e}return null}testOverlapSolid(e){const t=_f.GetRuntime()._UnwrapIWorldInstance(e),s=_f.TestOverlapSolid(t);return s?s.GetInterfaceClass():null}setCollisionCellSize(e,t){if(df.RequireFiniteNumber(e),df.RequireFiniteNumber(t),e=Math.floor(e),t=Math.floor(t),e<=0||t<=0)throw new Error("invalid cell size");_f.SetCollisionCellSize(e,t)}getCollisionCellSize(){return _f.GetCollisionCellSize()}getCollisionCandidates(e,t){const s=_f.GetRuntime();let i;i=Array.isArray(e)?e.map(e=>s._UnwrapIObjectClass(e)):[s._UnwrapIObjectClass(e)];const r=uf.Rect.FromObject(t),n=[];return _f.GetObjectClassesCollisionCandidates(null,i,r,n),n.map(e=>e.GetInterfaceClass())}}}{const pf=self.C3,ff=self.C3X;let mf=null;const gf=new Map([["Windows","windows"],["macOS","macos"],["Linux","linux"],["Chrome OS","chrome-os"],["Android","android"],["iOS","ios"]]),Sf=new Map([["Chrome","chrome"],["Chromium","chromium"],["Edge","edge"],["Opera","opera"],["Firefox","firefox"],["Safari","safari"]]),Gf=new Map([["Chromium","chromium"],["Gecko","gecko"],["WebKit","webkit"]]);self.IPlatformInfo=class{constructor(e){mf=e,Object.defineProperties(this,{isMobile:{value:pf.Platform.IsMobile,writable:!1},os:{value:gf.get(pf.Platform.OS)||"unknown",writable:!1},osVersion:{value:pf.Platform.OSVersion,writable:!1},browser:{value:Sf.get(pf.Platform.Browser)||"unknown",writable:!1},browserVersion:{value:pf.Platform.BrowserVersion,writable:!1},browserEngine:{value:Gf.get(pf.Platform.BrowserEngine)||"unknown",writable:!1}})}get exportType(){let e=mf.GetExportType();return mf.IsWindowsWebView2()?e="windows-webview2":"cordova"===e?e="Android"===pf.Platform.OS?"cordova-android":"cordova-ios":"playable-ad-single-file"!==e&&"playable-ad-zip"!==e||(e="playable-ad"),e}get renderer(){return mf.GetCanvasManager().GetRendererString()}get rendererDetail(){return mf.GetCanvasManager().GetRendererDetailString()}get canvasClientX(){return mf.GetCanvasManager().GetCanvasClientX()}get canvasClientY(){return mf.GetCanvasManager().GetCanvasClientY()}get canvasCssWidth(){return mf.GetCanvasManager().GetCssWidth()}get canvasCssHeight(){return mf.GetCanvasManager().GetCssHeight()}get canvasDeviceWidth(){return mf.GetCanvasManager().GetDeviceWidth()}get canvasDeviceHeight(){return mf.GetCanvasManager().GetDeviceHeight()}get devicePixelRatio(){return mf.GetDevicePixelRatio()}}}{const yf=self.C3,If=self.C3X;self.IStorage=class{constructor(e){this._storage=e._GetProjectStorage()}getItem(e){return If.RequireString(e),this._storage.getItem(e)}setItem(e,t){return If.RequireString(e),this._storage.setItem(e,t)}removeItem(e){return If.RequireString(e),this._storage.removeItem(e)}clear(){return this._storage.clear()}keys(){return this._storage.keys()}}}{const Tf=self.C3,Cf=self.C3X,bf=Tf._GetInternalAPIToken();self.IPlugin=class{#e;constructor(){const e=Tf.AddonManager._GetInitObject2(bf);this.#e=e,Object.defineProperties(this,{runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},id:{value:e.GetID(),writable:!1},isSingleGlobal:{value:e.IsSingleGlobal(),writable:!1},isWorldType:{value:e.IsWorldType(),writable:!1},isHTMLElementType:{value:e.IsHTMLElementType(),writable:!1},isRotatable:{value:e.IsRotatable(),writable:!1},hasEffects:{value:e.HasEffects(),writable:!1},is3d:{value:e.Is3D(),writable:!1},supportsHierarchies:{value:e.SupportsSceneGraph(),writable:!1},supportsMesh:{value:e.SupportsMesh(),writable:!1}}),e.GetRuntime()._MapScriptInterface(this,e)}static getByConstructor(e){if(!e)return null;const t=Tf.AddonManager.GetPluginByConstructorFunction(e);return t?t.GetIPlugin():null}getSingleGlobalObjectType(){return this.#e.GetSingleGlobalObjectClass().GetIObjectClass()}getSingleGlobalInstance(){return this.#e.GetSingleGlobalInstance().GetInterfaceClass()}}}{const xf=globalThis.C3,wf=globalThis.C3X,Pf=xf._GetInternalAPIToken();globalThis.IObjectClass=class{#e;constructor(){const e=xf.AddonManager._GetInitObject2(Pf);this.#e=e,Object.defineProperties(this,{name:{value:e.GetName(),writable:!1},runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},plugin:{value:e.GetPlugin().GetIPlugin(),writable:!1}}),e.GetRuntime()._MapScriptInterface(this,e)}addEventListener(e,t){wf.RequireString(e),wf.RequireFunction(t),this.#e.UserScriptDispatcher().addEventListener(e,t)}removeEventListener(e,t){wf.RequireString(e),wf.RequireFunction(t),this.#e.UserScriptDispatcher().removeEventListener(e,t)}getAllInstances(){return[...this.instances()]}getFirstInstance(){return xf.first(this.instances())}getPickedInstances(){return[...this.pickedInstances()]}getFirstPickedInstance(){return xf.first(this.pickedInstances())}getPairedInstance(e){const t=this.#e,s=t.GetRuntime()._UnwrapIInstance(e),i=t.GetPairedInstance(s);return i?i.GetInterfaceClass():null}*instances(){for(const e of this.#e.instancesIncludingPendingCreate())yield e.GetInterfaceClass()}*pickedInstances(){for(const e of this.#e.GetCurrentSol().GetInstances())yield e.GetInterfaceClass()}callCustomAction(e,t,...s){wf.RequireString(e);const i=this.#e,r=i.GetRuntime(),n=r.GetEventSheetManager(),a=n.GetCustomActionBlockByName(i,e);if(!a)throw new Error(`cannot find '${this.name}' custom action '${e}'`);if(!a.IsEnabled())return null;if(s.length<a.GetFunctionParameterCount())throw new Error(`not enough function parameters passed for '${this.name}' custom action '${e}' (${s.length} passed, ${a.GetFunctionParameterCount()} expected)`);const o=a.GetEventBlock();let h=o.GetSolModifiersIncludingParents();const l=n.GetCurrentEvent();if(l){h=h.slice(0);const e=new Set(h);for(const t of l.GetSolModifiersIncludingParents())e.has(t)||(h.push(t),e.add(t));for(const t of n.GetDynamicSolModifiersSet())e.has(t)||(h.push(t),e.add(t))}if(i.IsFamily()&&a.HasCustomACEOverrides()){const n=new Map,l=[];for(const s of t){const t=r._UnwrapIInstance(s),i=t.GetObjectClass();if(i.HasOwnCustomActionByName(e)){const e=n.get(i);Array.isArray(e)?e.push(t):n.set(i,[t])}else l.push(t)}const c=[];if(l.length>0){const e={pickObjectClass:i,pickInstances:l},t=o.RunAsExpressionOrJSFunctionCall(h,a.IsCopyPicked(),0,null,e,...s);c.push(t)}if(n.size>0)for(const[t,i]of n){const r=t.GetOwnCustomActionByName(e).GetEventBlock(),n=[...new Set([...h,...r.GetSolModifiers()])],o={pickObjectClass:t,pickInstances:i},l=r.RunAsExpressionOrJSFunctionCall(n,a.IsCopyPicked(),0,null,o,...s);c.push(l)}return Promise.all(c)}{const e={pickObjectClass:a.GetObjectClass(),pickInstances:(Array.isArray(t)?t:[...t]).map(e=>r._UnwrapIInstance(e))},i=o.RunAsExpressionOrJSFunctionCall(h,a.IsCopyPicked(),0,null,e,...s);return i instanceof Promise?i:Promise.resolve()}}}}{const Rf=globalThis.C3,vf=globalThis.C3X,Af=Rf._GetInternalAPIToken();globalThis.IObjectType=class extends globalThis.IObjectClass{#e;constructor(){super();const e=Rf.AddonManager._GetInitObject2(Af);this.#e=e}setInstanceClass(e){vf.RequireFunction(e);const t=this.#e;if(t.GetInstanceCount()>0)throw new Error("setInstanceClass() called too late, because instances have already been created - call in runOnStartup");t._SetUserScriptInstanceClass(e)}createInstance(e,t,s,i,r){if(vf.RequireNumber(t),vf.RequireNumber(s),"number"!=typeof e&&"string"!=typeof e)throw new TypeError("invalid layer parameter");const n=this.#e,a=n.GetRuntime(),o=a.GetMainRunningLayout().GetLayer(e);if(!o)throw new Error("invalid layer");const h=a.CreateInstance(n,o,t,s,i,r);i&&o.SortAndAddInstancesByZIndex(h);const l=a.GetEventSheetManager();return l.BlockFlushingInstances(!0),h._TriggerOnCreatedOnSelfAndRelated(),l.BlockFlushingInstances(!1),l.IsInEventEngine()||a.GetLayoutManager().IsEndingLayout()||a.FlushPendingInstances(),h.GetInterfaceClass()}getAllFamilies(){return this.#e.GetFamilies().map(e=>e.GetIObjectClass())}*families(){for(const e of this.#e.GetFamilies())yield e.GetIObjectClass()}isInFamily(e){return vf.RequireInstanceOf(e,globalThis.IFamily),e.hasObjectType(this)}}}{const Mf=globalThis.C3,Df=globalThis.C3X,Ef=globalThis.IObjectType,Ff=Mf._GetInternalAPIToken();globalThis.IFamily=class extends globalThis.IObjectClass{#e;constructor(){super();const e=Mf.AddonManager._GetInitObject2(Ff);this.#e=e}getAllObjectTypes(){return this.#e.GetFamilyMembers().map(e=>e.GetIObjectClass())}*objectTypes(){for(const e of this.#e.GetFamilyMembers())yield e.GetIObjectClass()}hasObjectType(e){Df.RequireInstanceOf(e,Ef);const t=this.#e,s=t.GetRuntime()._UnwrapIObjectClass(e);return t.FamilyHasMember(s)}}}{const Of=self.C3,Bf=self.C3X,kf=["above","below","top-sublayer","bottom-sublayer"];self.ILayout=class{#e;constructor(e){this.#e=e;const t=[],s=e.GetEffectList(),i=s.GetAllEffectTypes().length;for(let e=0;e<i;++e)t.push(new self.IEffectInstance(s,e));Object.defineProperties(this,{runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},name:{value:e.GetName(),writable:!1},index:{value:e.GetIndex(),writable:!1},effects:{value:t,writable:!1}})}addEventListener(e,t){Bf.RequireString(e),Bf.RequireFunction(t),this.#e.UserScriptDispatcher().addEventListener(e,t)}removeEventListener(e,t){Bf.RequireString(e),Bf.RequireFunction(t),this.#e.UserScriptDispatcher().removeEventListener(e,t)}get width(){return this.#e.GetWidth()}set width(e){Bf.RequireFiniteNumber(e),this.#e.SetWidth(e)}get height(){return this.#e.GetHeight()}set height(e){Bf.RequireFiniteNumber(e),this.#e.SetHeight(e)}setSize(e,t){Bf.RequireFiniteNumber(e),Bf.RequireFiniteNumber(t);const s=this.#e;s.SetWidth(e),s.SetHeight(t)}getSize(){const e=this.#e;return[e.GetWidth(),e.GetHeight()]}set scale(e){Bf.RequireFiniteNumber(e),this.#e.SetScale(e)}get scale(){return this.#e.GetScale()}set angle(e){Bf.RequireFiniteNumber(e),this.#e.SetAngle(e)}get angle(){return this.#e.GetAngle()}set scrollX(e){Bf.RequireNumber(e),this.#e.SetScrollX(e)}get scrollX(){return this.#e.GetScrollX()}set scrollY(e){Bf.RequireNumber(e),this.#e.SetScrollY(e)}get scrollY(){return this.#e.GetScrollY()}scrollTo(e,t){Bf.RequireNumber(e),Bf.RequireNumber(t);const s=this.#e;s.SetScrollX(e),s.SetScrollY(t)}getScrollPosition(){const e=this.#e;return[e.GetScrollX(),e.GetScrollY()]}get isUnboundedScrolling(){return this.#e.IsUnboundedScrolling()}getLayer(e){const t=this.#e;let s=null;if("number"!=typeof e&&"string"!=typeof e)throw new TypeError("expected string or number");return s=t.GetLayer(e),s?s.GetILayer():null}getAllLayers(){return this.#e.GetLayers().map(e=>e.GetILayer())}*allLayers(){for(const e of this.#e.allLayers())yield e.GetILayer()}addLayer(e,t,s){const i=this.#e,r=self.ILayer;Bf.RequireString(e),Bf.RequireOptionalInstanceOf(t,r);const n=t?i.GetRuntime()._UnwrapScriptInterface(t):null,a=kf.indexOf(s);if(a<0)throw new Error("invalid location");i.AddLayer(e,n,a)}moveLayer(e,t,s){const i=this.#e,r=i.GetRuntime(),n=self.ILayer;Bf.RequireInstanceOf(e,n);const a=r._UnwrapScriptInterface(e);if(!a)throw new Error("invalid layer");Bf.RequireOptionalInstanceOf(t,n);const o=t?r._UnwrapScriptInterface(t):null,h=kf.indexOf(s);if(h<0)throw new Error("invalid location");i.MoveLayer(a,o,h)}removeLayer(e){const t=this.#e,s=self.ILayer;Bf.RequireInstanceOf(e,s);const i=t.GetRuntime()._UnwrapScriptInterface(e);if(!i)throw new Error("invalid layer");const r=i.GetRuntime();t.RemoveLayer(i),r.GetEventSheetManager().IsInEventEngine()||r.FlushPendingInstances()}removeAllDynamicLayers(){const e=this.#e,t=e.GetRuntime();e.RemoveAllDynamicLayers(),t.GetEventSheetManager().IsInEventEngine()||t.FlushPendingInstances()}setVanishingPoint(e,t){Bf.RequireFiniteNumber(e),Bf.RequireFiniteNumber(t),this.#e.SetVanishingPointXY(e,t)}getVanishingPoint(){return this.#e.GetVanishingPoint()}set projection(e){Bf.RequireString(e);const t=this.#e;if("perspective"===e)t.SetPerspectiveProjection();else{if("orthographic"!==e)throw new Error("invalid projection");t.SetOrthographicProjection()}}get projection(){return this.#e.IsOrthographicProjection()?"orthographic":"perspective"}}}{const Lf=self.C3,Nf=self.C3X,Wf=new Map([["normal",0],["additive",1],["copy",3],["destination-over",4],["source-in",5],["destination-in",6],["source-out",7],["destination-out",8],["source-atop",9],["destination-atop",10],["lighten",11],["darken",12],["multiply",13],["screen",14]]),Uf=new Map([...Wf.entries()].map(e=>[e[1],e[0]])),Vf=new Set(["2d","3d"]),Hf=Lf.New(Lf.Color);self.ILayer=class{#e;constructor(e){this.#e=e;const t=[],s=e.GetEffectList(),i=s.GetAllEffectTypes().length;for(let e=0;e<i;++e)t.push(new self.IEffectInstance(s,e));Object.defineProperties(this,{runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},name:{value:e.GetName(),writable:!1},layout:{value:e.GetLayout().GetILayout(),writable:!1},effects:{value:t,writable:!1}}),e.GetRuntime()._MapScriptInterface(this,e)}addEventListener(e,t){this.#e.UserScriptDispatcher().addEventListener(e,t)}removeEventListener(e,t){this.#e.UserScriptDispatcher().removeEventListener(e,t)}get parentLayer(){const e=this.#e.GetParentLayer();return e?e.GetILayer():null}*parentLayers(){for(const e of this.#e.parentLayers())yield e.GetILayer()}*subLayers(){for(const e of this.#e.GetSubLayers())yield e.GetILayer()}*allSubLayers(){for(const e of this.#e.GetSubLayers())for(const t of e.selfAndAllSubLayers())yield t.GetILayer()}get index(){return this.#e.GetIndex()}get isVisible(){return this.#e._IsVisibleFlagSet()}set isVisible(e){this.#e.SetVisible(e)}get isSelfAndParentsVisible(){return this.#e.IsVisible()}get isInteractive(){return this.#e.IsInteractive()}set isInteractive(e){this.#e.SetInteractive(e)}get isHTMLElementsLayer(){return this.#e.IsHTMLElementsLayer()}set isHTMLElementsLayer(e){this.#e.SetIsHTMLElementsLayer(!!e)}get isSelfAndParentsInteractive(){return this.#e.IsSelfAndParentsInteractive()}get opacity(){return this.#e.GetOpacity()}set opacity(e){e=Lf.clamp(+e,0,1),isNaN(e)||this.#e.SetOpacity(e)}set scale(e){Nf.RequireFiniteNumber(e),this.#e.SetOwnScale(e)}get scale(){return this.#e.GetOwnScale()}set scaleRate(e){Nf.RequireFiniteNumber(e),this.#e.SetScaleRate(e)}get scaleRate(){return this.#e.GetScaleRate()}set angle(e){Nf.RequireFiniteNumber(e),this.#e.SetAngle(e)}get angle(){return this.#e.GetOwnAngle()}set parallaxX(e){Nf.RequireFiniteNumber(e),this.#e.SetParallaxX(e)}get parallaxX(){return this.#e.GetParallaxX()}set parallaxY(e){Nf.RequireFiniteNumber(e),this.#e.SetParallaxY(e)}get parallaxY(){return this.#e.GetParallaxY()}set zElevation(e){Nf.RequireFiniteNumber(e),this.#e.SetZElevation(e)}get zElevation(){return this.#e.GetZElevation()}set renderingMode(e){if(!Vf.has(e))throw TypeError("invalid rendering mode");this.#e.SetRenderAs3D("3d"===e)}get renderingMode(){return this.#e.IsRenderAs3D()?"3d":"2d"}set isTransparent(e){this.#e.SetTransparent(e)}get isTransparent(){return this.#e.IsTransparent()}set isForceOwnTexture(e){this.#e.SetForceOwnTexture(e)}get isForceOwnTexture(){return this.#e.IsForceOwnTexture()}set blendMode(e){Nf.RequireString(e);const t=Wf.get(e);if("number"!=typeof t)throw new Error("invalid blend mode");this.#e.SetBlendMode(t)}get blendMode(){return Uf.get(this.#e.GetBlendMode())}set backgroundColor(e){if(Nf.RequireArray(e),e.length<3)throw new Error("expected 3 elements");Hf.setRgb(e[0],e[1],e[2]);const t=this.#e,s=t.GetBackgroundColor();s.equalsIgnoringAlpha(Hf)||(s.copyRgb(Hf),t.GetRuntime().UpdateRender())}get backgroundColor(){const e=this.#e.GetBackgroundColor();return[e.getR(),e.getG(),e.getB()]}set scrollX(e){Nf.RequireNumber(e);const t=this.#e;t.SetOwnScrollPositionEnabled(!0),t.SetScrollX(e)}get scrollX(){return this.#e.GetScrollX()}set scrollY(e){Nf.RequireNumber(e);const t=this.#e;t.SetOwnScrollPositionEnabled(!0),t.SetScrollY(e)}get scrollY(){return this.#e.GetScrollY()}scrollTo(e,t){Nf.RequireNumber(e),Nf.RequireNumber(t);const s=this.#e;s.SetOwnScrollPositionEnabled(!0),s.SetScrollX(e),s.SetScrollY(t)}getScrollPosition(){const e=this.#e;return[e.GetScrollX(),e.GetScrollY()]}restoreScrollPosition(){this.#e.SetOwnScrollPositionEnabled(!1)}getViewport(){return this.#e.GetViewport().toDOMRect()}cssPxToLayer(e,t,s=0){Nf.RequireNumber(e),Nf.RequireNumber(t),Nf.RequireNumber(s);const i=this.#e,r=i.GetRuntime();return i.CanvasCssToLayer(e-r.GetCanvasClientX(),t-r.GetCanvasClientY(),s)}layerToCssPx(e,t,s=0){Nf.RequireNumber(e),Nf.RequireNumber(t),Nf.RequireNumber(s);const i=this.#e,r=i.GetRuntime(),[n,a]=i.LayerToCanvasCss(e,t,s);return[n+r.GetCanvasClientX(),a+r.GetCanvasClientY()]}drawSurfaceToLayer(e,t,s=0){return Nf.RequireNumber(e),Nf.RequireNumber(t),Nf.RequireNumber(s),this.#e.DrawSurfaceToLayer(e,t,s)}layerToDrawSurface(e,t,s=0){return Nf.RequireNumber(e),Nf.RequireNumber(t),Nf.RequireNumber(s),this.#e.LayerToDrawSurface(e,t,s)}get renderScale(){return this.#e.GetRenderScale()}}}{let jf=function(e){let t=Yf.get(e);return t||(t=zf.New(zf.Event.Dispatcher),Yf.set(e,t),t)};GetDispatcher=jf;const zf=self.C3,Xf=self.C3X,Yf=new WeakMap,qf=zf._GetInternalAPIToken();self.IInstance=class{#e;constructor(){const e=zf.AddonManager._GetInitObject2(qf);this.#e=e;const t={runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},objectType:{value:e.GetObjectClass().GetIObjectClass(),writable:!1},plugin:{value:e.GetPlugin().GetIPlugin(),writable:!1}};e._GetInstVarsScriptDescriptor(t),e._GetBehaviorsScriptDescriptor(t),Object.defineProperties(this,t),e.GetRuntime()._MapScriptInterface(this,e)}static _GetInitInst(){return zf.AddonManager._GetInitObject()}_release(){const e=Yf.get(this);e&&(e.Release(),Yf.delete(this))}addEventListener(e,t,s){Xf.RequireString(e),Xf.RequireFunction(t),jf(this).addEventListener(e,t,s)}removeEventListener(e,t,s){Xf.RequireString(e),Xf.RequireFunction(t),jf(this).removeEventListener(e,t,s)}dispatchEvent(e){jf(this).dispatchEvent(e)}destroy(){const e=this.#e,t=e.GetRuntime();t.DestroyInstance(e),t.GetEventSheetManager().IsInEventEngine()||t.GetLayoutManager().IsEndingLayout()||t.GetEventSheetManager().IsFlushingBlocked()||t.FlushPendingInstances()}getOtherContainerInstances(){const e=this.#e.GetSiblings();return e?e.map(e=>e.GetInterfaceClass()):[]}*otherContainerInstances(){const e=this.#e;if(e.IsInContainer())for(const t of e.siblings())yield t.GetInterfaceClass()}get uid(){return this.#e.GetUID()}get iid(){return this.#e.GetIID()}get templateName(){return this.#e.GetTemplateName()}set timeScale(e){Xf.RequireFiniteNumber(e),this.#e.SetTimeScale(e)}get timeScale(){return this.#e.GetActiveTimeScale()}restoreTimeScale(){this.#e.RestoreTimeScale()}get dt(){const e=this.#e;return e.GetRuntime().GetDt(e)}hasTag(e){return Xf.RequireString(e),this.#e.HasTag(e)}hasTags(...e){Xf.RequireArray(e);const t=new Set(e.map(e=>e.toLowerCase())),s=this.#e.GetLowercaseTagsSet();return t.isSubsetOf(s)}setAllTags(e){this.#e.SetTagsSet(zf.ensureSet(e))}getAllTags(){return new Set(this.#e.GetTagsSet())}signal(e){Xf.RequireString(e);const t=this.#e;t.GetRuntime().GetEventSheetManager().InstanceSignal(t,e)}waitForSignal(e){Xf.RequireString(e);const t=this.#e;return t.GetRuntime().GetEventSheetManager().WaitForInstanceSignal(t,e)}callCustomAction(e,...t){return this.objectType.callCustomAction(e,[this],...t)}}}{const Kf=self.C3,$f=self.C3X,Jf=Kf._GetInternalAPIToken();self.ISDKInstanceBase=class extends self.IInstance{#e;#s=!1;#n=null;#i=!1;#r=null;#t;#o;constructor(e){super(),this.#e=Kf.AddonManager._GetInitObject2(Jf),this.#s=!1,this.#n=null,this.#i=!1,this.#r=null,this.#t=e?.domComponentId,this.#o=e?.wrapperComponentId}_release(){this._setTicking(!1),this._setTicking2(!1),super._release()}_getInitProperties(){return Kf.AddonManager._GetInitProperties()}_trigger(e){const t=this.#e;t.GetRuntime().Trigger(e,t)}_triggerAsync(e){const t=this.#e;return t.GetRuntime().TriggerAsync(e,t)}_addDOMMessageHandler(e,t){if($f.RequireString(e),$f.RequireFunction(t),!this.#t)throw new Error("no DOM component id set");this.#e.GetRuntime().AddDOMComponentMessageHandler(this.#t,e,t)}_addDOMMessageHandlers(e){$f.RequireArray(e);for(const[t,s]of e)this._addDOMMessageHandler(t,s)}_postToDOM(e,t){if($f.RequireString(e),!this.#t)throw new Error("no DOM component id set");this.#e.GetRuntime().PostComponentMessageToDOM(this.#t,e,t)}_postToDOMAsync(e,t){if($f.RequireString(e),!this.#t)throw new Error("no DOM component id set");return this.#e.GetRuntime().PostComponentMessageToDOMAsync(this.#t,e,t)}_postToDOMMaybeSync(e,t){if(!this.#e.GetRuntime().IsInWorker())return window.c3_runtimeInterface._OnMessageFromRuntime({type:"event",component:this.#t,handler:e,data:t,responseId:null});this._postToDOM(e,t)}_setTicking(e){if(e=!!e,this.#s===e)return;this.#s=e;const t=this.#e.GetRuntime();if(e){if(!this.#n)if(this.#e.GetRuntime().IsDebug()){const e=globalThis.C3Debugger,t=this.plugin;this.#n=()=>{const s=performance.now();this._tick(),e.AddIndividualPluginTickTime(t,performance.now()-s)}}else this.#n=()=>this._tick();t.Dispatcher().addEventListener("tick",this.#n)}else t.Dispatcher().removeEventListener("tick",this.#n)}_isTicking(){return this.#s}_tick(){}_setTicking2(e){if(e=!!e,this.#i===e)return;this.#i=e;const t=this.#e.GetRuntime();if(e){if(!this.#r)if(this.#e.GetRuntime().IsDebug()){const e=globalThis.C3Debugger,t=this.plugin;this.#r=()=>{const s=performance.now();this._tick2(),e.AddIndividualPluginTickTime(t,performance.now()-s)}}else this.#r=()=>this._tick2();t.Dispatcher().addEventListener("tick2",this.#r)}else t.Dispatcher().removeEventListener("tick2",this.#r)}_isTicking2(){return this.#i}_tick2(){}_getDebuggerProperties(){return[]}_saveToJson(){return null}_loadFromJson(e){}_isWrapperExtensionAvailable(){if(!this.#o)throw new Error("no wrapper component id set");return this.#e.GetRuntime().HasWrapperComponentId(this.#o)}_addWrapperExtensionMessageHandler(e,t){if($f.RequireString(e),$f.RequireFunction(t),!this.#o)throw new Error("no wrapper component id set");this.#e.GetRuntime().AddWrapperExtensionMessageHandler(this.#o,e,t)}_addWrapperMessageHandlers(e){$f.RequireArray(e);for(const[t,s]of e)this._addWrapperExtensionMessageHandler(t,s)}_sendWrapperExtensionMessage(e,t){if(!this.#o)throw new Error("no wrapper component id set");this.runtime.sdk.sendWrapperExtensionMessage(this.#o,e,t)}_sendWrapperExtensionMessageAsync(e,t){if(!this.#o)throw new Error("no wrapper component id set");return this.runtime.sdk.sendWrapperExtensionMessageAsync(this.#o,e,t)}}}{let Zf=function(e){return class t extends e{#e;#s;constructor(e){super(e);const t=Qf.AddonManager._GetInitObject2(am),s=t.GetWorldInfo();this.#e=t,this.#s=s,nm.set(this,t);const i=[],r=s.GetInstanceEffectList();if(r){const e=s.GetObjectClass().GetEffectList().GetAllEffectTypes().length;for(let t=0;t<e;++t)i.push(new self.IEffectInstance(r,t))}const n={effects:{value:i,writable:!1}};Object.defineProperties(this,n)}get layout(){return this.#s.GetLayout().GetILayout()}get layer(){return this.#s.GetLayer().GetILayer()}get x(){return this.#s.GetX()}set x(e){e=+e;const t=this.#s;isNaN(e)||t.GetX()===e||(t.SetX(e),t.SetBboxChanged())}get y(){return this.#s.GetY()}set y(e){e=+e;const t=this.#s;isNaN(e)||t.GetY()===e||(t.SetY(e),t.SetBboxChanged())}setPosition(e,t){e=+e,t=+t;const s=this.#s;isNaN(e)||isNaN(t)||s.GetX()===e&&s.GetY()===t||(s.SetXY(e,t),s.SetBboxChanged())}getPosition(){const e=this.#s;return[e.GetX(),e.GetY()]}offsetPosition(e,t){if(e=+e,t=+t,isNaN(e)||isNaN(t)||0===e&&0===t)return;const s=this.#s;s.OffsetXY(e,t),s.SetBboxChanged()}set originX(e){e=+e;const t=this.#s;isNaN(e)||t.GetOriginX()===e||(t.SetOriginX(e),t.SetBboxChanged())}get originX(){return this.#s.GetOriginX()}set originY(e){e=+e;const t=this.#s;isNaN(e)||t.GetOriginY()===e||(t.SetOriginY(e),t.SetBboxChanged())}get originY(){return this.#s.GetOriginY()}setOrigin(e,t){e=+e,t=+t;const s=this.#s;isNaN(e)||isNaN(t)||s.GetOriginX()===e&&s.GetOriginY()===t||(s.SetOriginX(e),s.SetOriginY(t),s.SetBboxChanged())}getOrigin(){const e=this.#s;return[e.GetOriginX(),e.GetOriginY()]}get zElevation(){return this.#s.GetZElevation()}set zElevation(e){e=+e;const t=this.#e,s=this.#s;isNaN(e)||s.GetZElevation()===e||(s.SetZElevation(e),t.GetRuntime().UpdateRender())}get totalZElevation(){return this.#s.GetTotalZElevation()}get width(){return this.#s.GetWidth()}set width(e){e=+e;const t=this.#s;isNaN(e)||t.GetWidth()===e||(t.SetWidth(e),t.SetBboxChanged())}get height(){return this.#s.GetHeight()}set height(e){e=+e;const t=this.#s;isNaN(e)||t.GetHeight()===e||(t.SetHeight(e),t.SetBboxChanged())}setSize(e,t){e=+e,t=+t;const s=this.#s;isNaN(e)||isNaN(t)||s.GetWidth()===e&&s.GetHeight()===t||(s.SetSize(e,t),s.SetBboxChanged())}getSize(){const e=this.#s;return[e.GetWidth(),e.GetHeight()]}get angle(){return this.#s.GetAngle()}set angle(e){e=Qf.clampAngle(+e);const t=this.#s;isNaN(e)||t.GetAngle()===e||(t.SetAngle(e),t.SetBboxChanged())}get angleDegrees(){return Qf.toDegrees(this.angle)}set angleDegrees(e){this.angle=Qf.toRadians(e)}getBoundingBox(e){return e?(this.#s.CalculateBbox(im,rm,!1),im.toDOMRect()):this.#s.GetBoundingBox().toDOMRect()}getBoundingQuad(e){return e?(this.#s.CalculateBbox(im,rm,!1),rm.toDOMQuad()):this.#s.GetBoundingQuad().toDOMQuad()}isOnScreen(){return this.#s.IsInViewport2()}get isVisible(){return this.#s.IsVisible()}set isVisible(e){e=!!e;const t=this.#e,s=this.#s;s.IsVisible()!==e&&(s.SetVisible(e),t.GetRuntime().UpdateRender())}get opacity(){return this.#s.GetOpacity()}set opacity(e){e=Qf.clamp(+e,0,1);const t=this.#e,s=this.#s;isNaN(e)||s.GetOpacity()===e||(s.SetOpacity(e),t.GetRuntime().UpdateRender())}set colorRgb(e){if(em.RequireArray(e),e.length<3)throw new Error("expected 3 elements");lm.setRgb(e[0],e[1],e[2]);const t=this.#e,s=this.#s;s.GetUnpremultipliedColor().equalsIgnoringAlpha(lm)||(s.SetUnpremultipliedColor(lm),t.GetRuntime().UpdateRender())}get colorRgb(){const e=this.#s.GetUnpremultipliedColor();return[e.getR(),e.getG(),e.getB()]}set blendMode(e){em.RequireString(e);const t=om.get(e);if("number"!=typeof t)throw new Error("invalid blend mode");const s=this.#e;this.#s.SetBlendMode(t),s.GetRuntime().UpdateRender()}get blendMode(){return hm.get(this.#s.GetBlendMode())}moveToTop(){this.#s.ZOrderMoveToTop()}moveToBottom(){this.#s.ZOrderMoveToBottom()}moveToLayer(e){em.RequireInstanceOf(e,sm);const t=this.#e,s=t.GetRuntime()._UnwrapScriptInterface(e);if(!s)throw new Error("invalid layer");t.GetWorldInfo().ZOrderMoveToLayer(s)}moveAdjacentToInstance(e,s){em.RequireInstanceOf(e,t),this.#s.ZOrderMoveAdjacentToInstance(nm.get(e),s)}get zIndex(){return this.#s.GetZIndex()}get isCollisionEnabled(){return this.#s.IsCollisionEnabled()}set isCollisionEnabled(e){this.#s.SetCollisionEnabled(!!e)}containsPoint(e,t){return em.RequireNumber(e),em.RequireNumber(t),this.#s.ContainsPoint(+e,+t)}testOverlap(e){em.RequireInstanceOf(e,t);const s=this.#e,i=nm.get(e);return s.GetRuntime().GetCollisionEngine().TestOverlap(s,i)}testOverlapSolid(){const e=this.#e,t=e.GetRuntime().GetCollisionEngine().TestOverlapSolid(e);return t?t.GetInterfaceClass():null}getParent(){const e=this.#e.GetParent();return e?e.GetInterfaceClass():null}getTopParent(){const e=this.#e.GetTopParent();return e?e.GetInterfaceClass():null}*parents(){for(const e of this.#e.parents())yield e.GetInterfaceClass()}getChildCount(){return this.#e.GetChildCount()}getChildAt(e){const t=this.#e.GetChildAt(e);return t?t.GetInterfaceClass():null}*children(){for(const e of this.#e.children())yield e.GetInterfaceClass()}*allChildren(){for(const e of this.#e.allChildren())yield e.GetInterfaceClass()}addChild(e,s){em.RequireInstanceOf(e,t),em.RequireOptionalObject(s),s||(s={});const i=this.#e,r=nm.get(e);i.AddChild(r,s)}removeChild(e){em.RequireInstanceOf(e,t);const s=this.#e,i=nm.get(e);s.RemoveChild(i)}removeFromParent(){const e=this.#e;e.HasParent()&&e.GetParent().RemoveChild(e)}getHierarchyOpts(){const e=this.#s;return{transformX:e.GetTransformWithParentX(),transformY:e.GetTransformWithParentY(),transformWidth:e.GetTransformWithParentWidth(),transformHeight:e.GetTransformWithParentHeight(),transformAngle:e.GetTransformWithParentAngle(),transformZElevation:e.GetTransformWithParentZElevation(),transformOpacity:e.GetTransformWithParentOpacity(),transformVisibility:e.GetTransformWithParentVisibility(),destroyWithParent:e.GetDestroyWithParent()}}createMesh(e,t){em.RequireFiniteNumber(e),em.RequireFiniteNumber(t),this.#s.CreateMesh(e,t)}releaseMesh(){const e=this.#s;e.ReleaseMesh(),e.SetBboxChanged()}setMeshPoint(e,t,s){em.RequireFiniteNumber(e),em.RequireFiniteNumber(t),em.RequireObject(s);const i=this.#s;i.SetMeshPoint(e,t,s)&&i.SetBboxChanged()}getMeshPoint(e,t){let s=NaN,i=NaN,r=NaN,n=NaN,a=NaN;const o=this.#s;if(o.HasMesh()){const h=o.GetSourceMesh().GetMeshPointAt(e,t);null!==h&&(s=h.GetX(),i=h.GetY(),r=h.GetZElevation(),n=h.GetU(),a=h.GetV())}return{x:s,y:i,zElevation:r,u:n,v:a}}getMeshSize(){const e=this.#s;if(!e.HasMesh())return[0,0];const t=e.GetSourceMesh();return[t.GetHSize(),t.GetVSize()]}}};MakeIWorldInstanceClass=Zf;const Qf=self.C3,em=self.C3X,tm=self.IInstance,sm=self.ILayer,im=Qf.New(Qf.Rect),rm=Qf.New(Qf.Quad),nm=new WeakMap,am=Qf._GetInternalAPIToken(),om=new Map([["normal",0],["additive",1],["copy",3],["destination-over",4],["source-in",5],["destination-in",6],["source-out",7],["destination-out",8],["source-atop",9],["destination-atop",10],["lighten",11],["darken",12],["multiply",13],["screen",14]]),hm=new Map([...om.entries()].map(e=>[e[1],e[0]])),lm=Qf.New(Qf.Color);self.IWorldInstance=Zf(self.IInstance),self.IWorldInstanceSDKBase=Zf(self.ISDKInstanceBase)}{const cm=self.C3,um=self.C3X;self.IDOMInstance=class extends self.IWorldInstance{#e;constructor(){super(),this.#e=self.IInstance._GetInitInst()}getElement(){return this.#e.GetSdkInstance()._GetElementInDOMMode()}focus(){this.#e.GetSdkInstance().FocusElement()}blur(){this.#e.GetSdkInstance().BlurElement()}setCssStyle(e,t){um.RequireString(e),this.#e.GetSdkInstance().SetElementCSSStyle(e,t)}}}{let dm=function(e){let t=fm.get(e);return t||(t=_m.New(_m.Event.Dispatcher),fm.set(e,t),t)};GetDispatcher=dm;const _m=self.C3,pm=self.C3X,fm=new WeakMap,mm=_m._GetInternalAPIToken();self.IBehaviorInstance=class{#e;constructor(){const e=_m.AddonManager._GetInitObject2(mm);this.#e=e;const t={runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},behavior:{value:e.GetBehavior().GetIBehavior(),writable:!1},behaviorType:{value:e.GetBehaviorType().GetIBehaviorType(),writable:!1}};Object.defineProperties(this,t),e.GetRuntime()._MapScriptInterface(this,e)}static _GetInitInst(){return _m.AddonManager._GetInitObject()}get instance(){return this.#e.GetObjectInstance().GetInterfaceClass()}_release(){const e=fm.get(this);e&&(e.Release(),fm.delete(this))}addEventListener(e,t,s){pm.RequireString(e),pm.RequireFunction(t),dm(this).addEventListener(e,t,s)}removeEventListener(e,t,s){pm.RequireString(e),pm.RequireFunction(t),dm(this).removeEventListener(e,t,s)}dispatchEvent(e){dm(this).dispatchEvent(e)}}}{const gm=self.C3,Sm=self.C3X,Gm=gm._GetInternalAPIToken();self.IBehaviorType=class{constructor(){const e=gm.AddonManager._GetInitObject2(Gm),t={runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},behavior:{value:e.GetBehavior().GetIBehavior(),writable:!1},name:{value:e.GetName(),writable:!1}};Object.defineProperties(this,t)}}}{const ym=self.C3,Im=self.C3X,Tm=ym._GetInternalAPIToken();self.IBehavior=class{#s;constructor(){const e=ym.AddonManager._GetInitObject2(Tm);this.#s=e;const t={runtime:{value:e.GetRuntime().GetIRuntime(),writable:!1},id:{value:e.GetID(),writable:!1}};Object.defineProperties(this,t),e.GetRuntime()._MapScriptInterface(this,e)}getAllInstances(){return this.#s.GetInstances().map(e=>e.GetInterfaceClass())}static getByConstructor(e){if(!e)return null;const t=ym.AddonManager.GetBehaviorByConstructorFunction(e);return t?t.GetIBehavior():null}}}{const Cm=self.C3,bm=self.C3X,xm=Cm.New(Cm.Color);self.IEffectInstance=class{#e;constructor(e,t){this.#e=e;const s={index:{value:t,writable:!1}};Object.defineProperties(this,s)}get name(){return this.#e.GetAllEffectTypes()[this.index].GetName()}get isActive(){return this.#e.IsEffectIndexActive(this.index)}set isActive(e){e=!!e;const t=this.#e;t.IsEffectIndexActive(this.index)!==e&&(t.SetEffectIndexActive(this.index,e),t.UpdateActiveEffects(),t.GetRuntime().UpdateRender())}setParameter(e,t){bm.RequireFiniteNumber(e),e=Math.floor(+e);const s=this.#e,i=s.GetEffectParameter(this.index,e);if(null===i)throw new RangeError("invalid index");if(i instanceof Cm.Color){if(!Array.isArray(t)||t.length<3)throw new TypeError("expected array with 3 elements");xm.setRgb(t[0],t[1],t[2]),t=xm}else if("number"!=typeof t)throw new TypeError("expected number");s.SetEffectParameter(this.index,e,t)&&s.IsEffectIndexActive(this.index)&&s.GetRuntime().UpdateRender()}getParameter(e){bm.RequireFiniteNumber(e),e=Math.floor(+e);const t=this.#e.GetEffectParameter(this.index,e);if(null===t)throw new RangeError("invalid index");return t instanceof Cm.Color?[t.getR(),t.getG(),t.getB()]:t}}}{const wm=self.C3,Pm=self.C3X;self.IAnimation=class{#e;constructor(e){this.#e=e,Object.defineProperties(this,{name:{value:e.GetName(),writable:!1}})}get speed(){return this.#e.GetSpeed()}get isLooping(){return this.#e.IsLooping()}get repeatCount(){return this.#e.GetRepeatCount()}get repeatTo(){return this.#e.GetRepeatTo()}get isPingPong(){return this.#e.IsPingPong()}get frameCount(){return this.#e.GetFrameCount()}getFrames(){return this.#e.GetFrames().map(e=>e.GetIAnimationFrame())}*frames(){for(const e of this.#e.GetFrames())yield e.GetIAnimationFrame()}}}{const Rm=self.C3,vm=self.C3X;self.IImageInfo=class{#s;constructor(e){this.#s=e}static _Unwrap(e){return e.#s}get width(){return this.#s.GetWidth()}get height(){return this.#s.GetHeight()}getSize(){const e=this.#s;return[e.GetWidth(),e.GetHeight()]}getTexture(e){return e.getTextureForImageInfo(this)}getTexRect(){return this.#s.GetTexRect().toDOMRect()}}}{const Am=self.C3,Mm=self.C3X;self.IAnimationFrame=class extends self.IImageInfo{#s;constructor(e){super(e.GetImageInfo()),this.#s=e,Object.defineProperties(this,{duration:{value:e.GetDuration(),writable:!1},originX:{value:e.GetOriginX(),writable:!1},originY:{value:e.GetOriginY(),writable:!1}})}getOrigin(){const e=this.#s;return[e.GetOriginX(),e.GetOriginY()]}getImagePointCount(){return this.#s.GetImagePointCount()}getImagePointX(e){return this.getImagePoint(e)[0]}getImagePointY(e){return this.getImagePoint(e)[1]}getImagePoint(e){const t=this.#s;let s=null;if("number"==typeof e)s=t.GetImagePointByIndex(Math.floor(e));else{if("string"!=typeof e)throw new TypeError("expected string or number");s=t.GetImagePointByName(e)}return s?[s.GetX(),s.GetY()]:this.getOrigin()}getPolyPointCount(){const e=this.#s.GetCollisionPoly();return e?e.pointCount():0}getPolyPointX(e){return this.getPolyPoint(e)[0]}getPolyPointY(e){return this.getPolyPoint(e)[1]}getPolyPoint(e){Mm.RequireFiniteNumber(e),e=Math.floor(e);const t=this.#s.GetCollisionPoly();if(!t||e<0||e>=t.pointCount())return[0,0];const s=t.pointsArr();return[s[2*e],s[2*e+1]]}get tag(){return this.#s.GetTag()}}}{let Dm=function(e){const t=Om.get(e);if(t.IsReleased())throw new Error("timeline/tween was released and is no longer valid");return t};GetTimelineState=Dm;const Em=self.C3,Fm=self.C3X,Om=new WeakMap;self.ITimelineStateBase=class{constructor(e){Om.set(this,e),e.GetRuntime()._MapScriptInterface(this,e)}pause(){Dm(this).Stop()}resume(){Dm(this).Resume()}stop(){Dm(this).Reset()}hasTags(e){return Dm(this).HasTags(e)}set time(e){Fm.RequireFiniteNumber(e),Dm(this).SetTime(e)}get time(){return Dm(this).GetTime()}set totalTime(e){Fm.RequireFiniteNumber(e),Dm(this).SetTotalTime(e)}get totalTime(){return Dm(this).GetTotalTime()}set isLooping(e){Dm(this).SetLoop(!!e)}get isLooping(){return Dm(this).GetLoop()}set isPingPong(e){Dm(this).SetPingPong(!!e)}get isPingPong(){return Dm(this).GetPingPong()}set playbackRate(e){Fm.RequireFiniteNumber(e),Dm(this).SetPlaybackRate(e)}get playbackRate(){return Dm(this).GetPlaybackRate()}get progress(){const e=Dm(this);return e.GetTime()/e.GetTotalTime()}get tags(){return Dm(this).GetTags()}get finished(){return Dm(this).GetPlayPromise()}get isPlaying(){return Dm(this).IsPlaying()}get isPaused(){return Dm(this).IsPaused()}get isReleased(){return Om.get(this).IsReleased()}}}{let Bm=function(e){const t=Nm.get(e);if(t.IsReleased())throw new Error("timeline was released and is no longer valid");return t};GetTimelineState=Bm;const km=self.C3,Lm=self.C3X,Nm=new WeakMap;let Wm=null;self.ITimelineState=class extends self.ITimelineStateBase{constructor(e){super(e),Nm.set(this,e);const t={name:{value:e.GetName(),writable:!1}};Object.defineProperties(this,t)}}}{let Um=function(e){const t=jm.get(e);if(t.IsReleased())throw new Error("tween was released and is no longer valid");return t};GetTweenState=Um;const Vm=self.C3,Hm=self.C3X,jm=new WeakMap,zm=new WeakMap;let Xm=null;self.ITweenState=class extends self.ITimelineStateBase{constructor(e,t,s){super(e),Xm||(Xm=s.easeToIndexFunc),jm.set(this,e),t&&zm.set(this,t)}stop(){const e=Um(this);zm.get(this).ReleaseTween(e)}setEase(e){Hm.RequireString(e);const t=self.Ease.GetEaseFromIndex(Xm(e));Um(this).SetEase(t)}get instance(){const e=Um(this).GetInstance();return e?e.GetInterfaceClass():null}get isDestroyOnComplete(){return Um(this).GetDestroyInstanceOnComplete()}set isDestroyOnComplete(e){Um(this).SetDestroyInstanceOnComplete(!!e)}get finished(){const e=Um(this);return e.GetPlayPromise().then(()=>new Promise(t=>{e.IsComplete()&&t()}))}get released(){return Um(this).GetReleasePromise()}get value(){const e=Um(this);if("value"!==e.GetId())throw new Error("not a value tween");return e.GetPropertyTrack("value").GetSourceAdapterValue()}}}{const Ym=self.C3,qm=self.C3X;self.ISDKPluginBase=class extends self.IPlugin{constructor(){super()}}}{const Km=self.C3,$m=self.C3X,Jm=Km._GetInternalAPIToken();self.ISDKDOMPluginBase=class extends self.ISDKPluginBase{#e;#n;#s=0;#t=new Map;constructor(e){if(super(),this.#e=Km.AddonManager._GetInitObject2(Jm),!e?.domComponentId)throw new Error("no DOM component ID specified");this.#n=e.domComponentId,this._addElementMessageHandler("elem-focused",e=>e._onElemFocused()),this._addElementMessageHandler("elem-blurred",e=>{e&&e._onElemBlurred()})}_addElement(e){const t=this.#s++;return this.#t.set(t,e),t}_removeElement(e){this.#t.delete(e)}_addElementMessageHandler(e,t){this.#e.GetRuntime().AddDOMComponentMessageHandler(this.#n,e,e=>{const s=this.#t.get(e.elementId);t(s,e)})}_addElementMessageHandlers(e){$m.RequireArray(e);for(const[t,s]of e)this._addElementMessageHandlers(t,s)}}}{const Zm=self.C3,Qm=self.C3X,eg=new WeakMap,tg=Zm._GetInternalAPIToken();self.ISDKObjectTypeBase=class extends self.IObjectType{#e;constructor(){super(),this.#e=Zm.AddonManager._GetInitObject2(tg)}_onCreate(){}getImageInfo(){return this.#e.GetImageInfo().GetIImageInfo()}_loadTextures(e){}_releaseTextures(e){}_onDynamicTextureLoadComplete(){}_preloadTexturesWithInstances(e){}}}{const sg=self.C3,ig=self.C3X,rg=new WeakMap,ng=sg._GetInternalAPIToken();self.ISDKWorldInstanceBase=class extends self.IWorldInstanceSDKBase{#e;#r=null;#s=null;constructor(e){super(e),this.#e=sg.AddonManager._GetInitObject2(ng)}_release(){if(super._release(),this.#r){const e=this.#e.GetRuntime().Dispatcher();e.removeEventListener("renderercontextlost",this.#r),e.removeEventListener("renderercontextrestored",this.#s),this.#r=null,this.#s=null}}_handleRendererContextLoss(){if(this.#r)return;this.#r=()=>this._onRendererContextLost(),this.#s=()=>this._onRendererContextRestored();const e=this.#e.GetRuntime().Dispatcher();e.addEventListener("renderercontextlost",this.#r),e.addEventListener("renderercontextrestored",this.#s)}_onRendererContextLost(){}_onRendererContextRestored(){}_draw(e){}_rendersToOwnZPlane(){return!0}_mustPreDraw(){return!1}}}{const ag=self.C3,og=self.C3X,hg=ag.New(ag.Rect),lg=new WeakMap,cg=ag._GetInternalAPIToken();self.ISDKDOMInstanceBase=class extends self.ISDKWorldInstanceBase{#e=-1;#s=!0;#t=!1;#i=!1;#n=-.2;#o=ag.New(ag.Rect,0,0,-1,-1);#l=0;#h=0;#a=-1;#g=-1;#_=!1;constructor(e){if(!e?.domComponentId)throw new Error("no DOM component ID specified");super(e);const t=ag.AddonManager._GetInitObject2(cg);lg.set(this,t),this.#e=this.plugin._addElement(this);const s=t.GetRuntime().GetCanvasManager();this.#l=s.GetLastWidth(),this.#h=s.GetLastHeight(),this._setTicking(!0)}_release(){super._release(),this.plugin._removeElement(this.#e),this._postToDOMElement("destroy"),this.#e=-1,lg.delete(this)}_getElementInDOMMode(){if(lg.get(this).GetRuntime().IsInWorker())throw new Error("not valid in worker mode");return this._postToDOMElementMaybeSync("get-element")}_postToDOMElement(e,t){t||(t={}),t.elementId=this.#e,this._postToDOM(e,t)}_postToDOMElementMaybeSync(e,t){return t||(t={}),t.elementId=this.#e,this._postToDOMMaybeSync(e,t)}_postToDOMElementAsync(e,t){return t||(t={}),t.elementId=this.#e,this._postToDOMAsync(e,t)}_createElement(e){e||(e={});const t=lg.get(this).GetWorldInfo();e.elementId=this.#e,e.isVisible=t.IsVisible(),e.htmlIndex=t.GetLayer().GetHTMLIndex(),e.htmlZIndex=t.GetHTMLZIndex(),Object.assign(e,this._getElementState()),this.#s=!!e.isVisible,this._postToDOMMaybeSync("create",e),this._updatePosition(!0)}setElementVisible(e){e=!!e,this.#s!==e&&(this.#s=e,this._postToDOMElement("set-visible",{isVisible:e}))}_tick(){this._updatePosition(!1)}_shouldPreserveElement(){const e=lg.get(this).GetRuntime().GetCanvasManager().GetFullscreenMode();return"Android"===ag.Platform.OS&&("scale-inner"===e||"scale-outer"===e||"crop"===e)}_updatePosition(e){const t=lg.get(this);if(t.IsDestroyed())return;const s=t.GetWorldInfo(),i=s.GetLayer(),r=s.GetBoundingBox();let[n,a]=i.LayerToCanvasCss(r.getLeft(),r.getTop()),[o,h]=i.LayerToCanvasCss(r.getRight(),r.getBottom());const l=t.GetRuntime().GetCanvasManager(),c=l.GetCssWidth(),u=l.GetCssHeight();if(!s.IsVisible()||!i.IsVisible())return void this.setElementVisible(!1);if(!this._shouldPreserveElement()&&(o<=0||h<=0||n>=c||a>=u))return void this.setElementVisible(!1);hg.set(n,a,o,h);const d=l.GetLastWidth(),_=l.GetLastHeight(),p=i.GetHTMLIndex(),f=s.GetHTMLZIndex();if(!e&&hg.equals(this.#o)&&this.#l===d&&this.#h===_&&this.#a===p&&this.#g===f)return void this.setElementVisible(!0);this.#o.copy(hg),this.#l=d,this.#h=_,this.#a=p,this.#g=f,this.setElementVisible(!0);let m=null;this.#i&&(m=i.GetDisplayScale()+this.#n),this._postToDOMElement("update-position",{left:Math.round(this.#o.getLeft()),top:Math.round(this.#o.getTop()),width:Math.round(this.#o.width()),height:Math.round(this.#o.height()),htmlIndex:p,htmlZIndex:f,fontSize:m})}focusElement(){this._postToDOMElementMaybeSync("focus",{focus:!0})}blurElement(){this._postToDOMElementMaybeSync("focus",{focus:!1})}_onElemFocused(){this.#t=!0}_onElemBlurred(){this.#t=!1}isElementFocused(){return this.#t}setElementCSSStyle(e,t){this.postToDOMElement("set-css-style",{prop:ag.CSSToCamelCase(e),val:t})}setElementAttribute(e,t){this.postToDOMElement("set-attribute",{name:e,val:t})}removeElementAttribute(e){this.postToDOMElement("remove-attribute",{name:e})}_updateElementState(){this.#_||(this.#_=!0,Promise.resolve().then(()=>{this.#_=!1,this._postToDOMElement("update-state",this._getElementState())}))}_getElementState(){}_getElementId(){return this.#e}}}{const ug=self.C3,dg=self.C3X;self.ISDKBehaviorBase=class extends self.IBehavior{constructor(){super()}}}{const _g=self.C3,pg=self.C3X;self.ISDKBehaviorTypeBase=class extends globalThis.IBehaviorType{constructor(){super()}_onCreate(){}}}{const fg=self.C3,mg=self.C3X,gg=new WeakMap,Sg=fg._GetInternalAPIToken();self.ISDKBehaviorInstanceBase=class extends self.IBehaviorInstance{#i=!1;#s=!1;#e=!1;constructor(){super(),gg.set(this,fg.AddonManager._GetInitObject2(Sg))}_release(){super._release(),this._setTicking(!1),this._setTicking2(!1),this._setPostTicking(!1),gg.delete(this)}_getInitProperties(){return fg.AddonManager._GetInitProperties()}_postCreate(){}_trigger(e){const t=gg.get(this);t.GetRuntime().Trigger(e,t.GetObjectInstance(),t.GetBehaviorType())}_triggerAsync(e){const t=gg.get(this);return t.GetRuntime().TriggerAsync(e,t.GetObjectInstance(),t.GetBehaviorType())}_setTicking(e){if(e=!!e,this.#i===e)return;this.#i=e;const t=gg.get(this).GetRuntime();e?t._AddBehInstToTick(this):t._RemoveBehInstToTick(this)}_isTicking(){return this.#i}_tick(){}_setTicking2(e){if(e=!!e,this.#s===e)return;this.#s=e;const t=gg.get(this).GetRuntime();e?t._AddBehInstToTick2(this):t._RemoveBehInstToTick2(this)}_isTicking2(){return this.#s}_tick2(){}_setPostTicking(e){if(e=!!e,this.#e===e)return;this.#e=e;const t=gg.get(this).GetRuntime();e?t._AddBehInstToPostTick(this):t._RemoveBehInstToPostTick(this)}_isPostTicking(){return this.#e}_postTick(){}_getDebuggerProperties(){return[]}_saveToJson(){return null}_loadFromJson(e){}}}{const Gg=self.C3,yg=self.C3X;let Ig=null;self.ISDKUtils=class{constructor(e){Ig=e,Object.defineProperties(this,{constructVersionCode:{value:Ig.GetConstructVersionCode(),writable:!1}})}updateRender(){Ig.UpdateRender()}addLoadPromise(e){Ig.AddLoadPromise(e)}isWrapperExtensionAvailable(e){return yg.RequireString(e),Ig.HasWrapperComponentId(e)}sendWrapperExtensionMessage(e,t,s){yg.RequireString(e),yg.RequireString(t),yg.RequireOptionalArray(s),Ig.SendWrapperExtensionMessage(e,t,s)}sendWrapperExtensionMessageAsync(e,t,s){return yg.RequireString(e),yg.RequireString(t),yg.RequireOptionalArray(s),Ig.SendWrapperExtensionMessageAsync(e,t,s)}createLoopingConditionContext(e){return yg.RequireOptionalString(e),new self.ILoopingConditionContext(Ig,e)}set isAutoSuspendEnabled(e){Ig._SetAutoSuspendEnabled(!!e)}get isAutoSuspendEnabled(){return Ig._IsAutoSuspendEnabled()}setSuspended(e){Ig.SetSuspended(!!e)}getObjectClassBySid(e){yg.RequireNumber(e);const t=Ig.GetObjectClassBySID(e);return t?t.GetIObjectClass():null}}}{const Tg=self.C3,Cg=self.C3X;self.ILoopingConditionContext=class{#e;#s;#o;#n;#t;#r;constructor(e,t){this.#e=e;const s=e.GetEventSheetManager(),i=e.GetCurrentEvent();this.#s=i,this.#o=i.GetSolModifiers();const r=e.GetEventStack();this.#n=r.GetCurrentStackFrame(),this.#t=r.Push(i);const n=s.GetLoopStack().Push();this.#r=n,t&&n.SetName(t),e.SetDebuggingEnabled(!1)}retrigger(){const e=this.#e.GetEventSheetManager(),t=this.#o,s=this.#r;e.PushCopySol(t),this.#s.Retrigger(this.#n,this.#t),e.PopSol(t),s.SetIndex(s.GetIndex()+1)}get isStopped(){return this.#r.IsStopped()}release(){const e=this.#e,t=e.GetEventStack(),s=e.GetEventSheetManager().GetLoopStack();e.SetDebuggingEnabled(!0),s.Pop(),t.Pop()}}}{let bg=function(e){return e instanceof ImageBitmap||"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas};IsStaticTextureDataType=bg;const xg=globalThis.C3,wg=globalThis.C3X,Pg=["none","back","front"],Rg=["cw","ccw"],vg={debugLabel:""};globalThis.IRenderer=class{#e;#r;constructor(e,t){this.#e=e,this.#r=t}setAlphaBlendMode(){this.#r.SetAlphaBlend()}setBlendMode(e){this.#r.SetNamedBlendMode(e)}setColorFillMode(){this.#r.SetColorFillMode()}setTextureFillMode(){this.#r.SetTextureFillMode()}setSmoothLineFillMode(){this.#r.SetSmoothLineFillMode()}setColor(e){this.#r.SetColorRgba(e[0],e[1],e[2],e[3])}setColorRgba(e,t,s,i){this.#r.SetColorRgba(e,t,s,i)}resetColor(){this.#r.ResetColor()}setOpacity(e){this.#r.SetOpacity(e)}setCurrentZ(e){this.#r.SetCurrentZ(e)}getCurrentZ(){return this.#r.GetCurrentZ()}setCullFaceMode(e){const t=Pg.indexOf(e);if(-1===t)throw new Error("invalid cull mode");this.#r.SetCullFaceMode(t)}getCullFaceMode(){return Pg[this.#r.GetCullFaceMode()]}setFrontFaceWinding(e){const t=Rg.indexOf(e);if(-1===t)throw new Error("invalid front face winding");this.#r.SetFrontFaceWinding(t)}getFrontFaceWinding(){return this.#r.GetFrontFaceWinding()}rect(e){this.#r.Rect2(e.left,e.top,e.right,e.bottom)}rect2(e,t,s,i){this.#r.Rect2(e,t,s,i)}quad(e){this.#r.Quad(xg.Quad.fromDOMQuad(e))}quad2(e,t,s,i,r,n,a,o){this.#r.Quad2(e,t,s,i,r,n,a,o)}quad3(e,t){this.#r.Quad3(xg.Quad.fromDOMQuad(e),xg.Rect.fromDOMRect(t))}quad4(e,t){this.#r.Quad4(xg.Quad.fromDOMQuad(e),xg.Quad.fromDOMQuad(t))}quad5(e,t,s){this.#r.Quad5(xg.Quad.fromDOMQuad(e),xg.Quad.fromDOMQuad(t),s)}quad3D(e,t,s,i,r,n,a,o,h,l,c,u,d){this.#r.Quad3D(e,t,s,i,r,n,a,o,h,l,c,u,xg.Rect.fromDOMRect(d))}quad3D2(e,t,s,i,r,n,a,o,h,l,c,u,d){this.#r.Quad3D2(e,t,s,i,r,n,a,o,h,l,c,u,xg.Quad.fromDOMQuad(d))}quad3D3(e,t,s,i,r,n,a,o,h,l,c,u,d,_){this.#r.Quad3D3(e,t,s,i,r,n,a,o,h,l,c,u,xg.Quad.fromDOMQuad(d),_)}drawMesh(e,t,s,i){this.#r.DrawMesh(e,t,s,i)}convexPoly(e){this.#r.ConvexPoly(e)}line(e,t,s,i){this.#r.Line(e,t,s,i)}texturedLine(e,t,s,i,r,n){this.#r.TexturedLine(e,t,s,i,r,n)}lineRect(e,t,s,i){this.#r.LineRect(e,t,s,i)}lineRect2(e){this.#r.LineRect2(xg.Rect.fromDOMRect(e))}lineQuad(e){this.#r.LineQuad(xg.Quad.fromDOMQuad(e))}pushLineWidth(e){this.#r.PushLineWidth(e)}popLineWidth(){this.#r.PopLineWidth()}pushLineCap(e){this.#r.PushLineCap(e)}popLineCap(){this.#r.PopLineCap()}setTexture(e){wg.RequireOptionalInstanceOf(e,globalThis.ITexture);const t=e?this.#e._UnwrapScriptInterface(e):null;this.#r.SetTexture(t)}loadTextureForImageInfo(e,t){const s=globalThis.IImageInfo._Unwrap(e);if(!s)throw new Error("invalid IImageInfo");return s.LoadStaticTexture(this.#r,{wrapX:t?.wrapX??"clamp-to-edge",wrapY:t?.wrapY??"clamp-to-edge",sampling:t?.sampling??"trilinear",mipMap:t?.mipMap??!0})}releaseTextureForImageInfo(e){const t=globalThis.IImageInfo._Unwrap(e);if(!t)throw new Error("invalid IImageInfo");t.ReleaseTexture()}getTextureForImageInfo(e){const t=globalThis.IImageInfo._Unwrap(e);if(!t)throw new Error("invalid IImageInfo");const s=t.GetTexture();return globalThis.ITexture.GetInterface(this.#e,s)}createStaticTexture(e,t){if(!bg(e))throw new TypeError("invalid texture data");const s=this.#r.CreateStaticTexture(e,{wrapX:t?.wrapX??"clamp-to-edge",wrapY:t?.wrapY??"clamp-to-edge",sampling:t?.sampling??"trilinear",mipMap:t?.mipMap??!0});return globalThis.ITexture.GetInterface(this.#e,s)}createDynamicTexture(e,t,s){wg.RequireFiniteNumber(e),wg.RequireFiniteNumber(t);const i=this.#r.CreateDynamicTexture(e,t,{wrapX:s?.wrapX??"clamp-to-edge",wrapY:s?.wrapY??"clamp-to-edge",sampling:s?.sampling??"trilinear",mipMap:s?.mipMap??!0});return globalThis.ITexture.GetInterface(this.#e,i)}updateTexture(e,t,s){wg.RequireInstanceOf(t,globalThis.ITexture);const i=this.#e._UnwrapScriptInterface(t);this.#r.UpdateTexture(e,i,{premultiplyAlpha:s?.premultiplyAlpha??!0})}deleteTexture(e){wg.RequireInstanceOf(e,globalThis.ITexture);const t=this.#e._UnwrapScriptInterface(e);this.#r.DeleteTexture(t)}createRendererText(){const e=this.#r.CreateRendererText();return new globalThis.IRendererText(this.#e,e)}createMeshData(e,t,s){wg.RequireFiniteNumber(e),wg.RequireFiniteNumber(t),s=Object.assign({},vg,s);const i=this.#r.CreateMeshData(e,t,{debugLabel:s.debugLabel});i.CreateGPUResources();const r=new globalThis.IMeshData(i);return this.#e._MapScriptInterface(r,i),r}drawMeshData(e,t=0,s=e.indexCount){const i=this.#e._UnwrapScriptInterface(e);this.#r.DrawMeshData(i,t,s)}setDeviceTransform(){this.#e.GetCanvasManager().SetDeviceTransform(this.#r)}setLayerTransform(e){wg.RequireInstanceOf(e,globalThis.ILayer),this.#e._UnwrapScriptInterface(e)._SetTransform(this.#r)}}}{const Ag=globalThis.C3,Mg=globalThis.C3X,Dg=new WeakMap;globalThis.ITexture=class{#e;#s;constructor(e,t){this.#e=e,this.#s=t,Dg.set(t,this),e._MapScriptInterface(this,t),Object.defineProperties(this,{width:{value:t.GetWidth(),writable:!1},height:{value:t.GetHeight(),writable:!1}})}static GetInterface(e,t){if(!t)return null;return Dg.get(t)||new globalThis.ITexture(e,t)}}}{const Eg=globalThis.C3,Fg=globalThis.C3X;globalThis.IRendererText=class{#e;#s;constructor(e,t){this.#e=e,this.#s=t,e._MapScriptInterface(this,t)}release(){this.#s.Release()}set fontFace(e){Fg.RequireString(e),this.#s.SetFontName(e)}get fontFace(){return this.#s.GetFontName()}set sizePt(e){Fg.RequireFiniteNumber(e),this.#s.SetFontSize(e)}get sizePt(){return this.#s.GetFontSize()}set lineHeight(e){Fg.RequireFiniteNumber(e),this.#s.SetLineHeight(e)}get lineHeight(){return this.#s.GetLineHeight()}set isBold(e){this.#s.SetBold(e)}get isBold(){return this.#s.IsBold()}set isItalic(e){this.#s.SetItalic(e)}get isItalic(){return this.#s.IsItalic()}setColor(e){Fg.RequireArray(e),this.setColorRgb(e[0],e[1],e[2])}setColorRgb(e,t,s){this.#s.SetColorRgb(e,t,s)}setCssColor(e){Fg.RequireString(e),this.#s.SetColor(e)}set horizontalAlign(e){this.#s.SetHorizontalAlignment(e)}get horizontalAlign(){return this.#s.GetHorizontalAlignment()}set verticalAlign(e){this.#s.SetVerticalAlignment(e)}get verticalAlign(){return this.#s.GetVerticalAlignment()}set wordWrapMode(e){this.#s.SetWordWrapMode(e)}get wordWrapMode(){return this.#s.GetWordWrapMode()}set textDirection(e){this.#s.SetTextDirection(e)}get textDirection(){return this.#s.GetTextDirection()}set text(e){Fg.RequireString(e),this.#s.SetText(e)}get text(){return this.#s.GetText()}setSize(e,t,s){Fg.RequireFiniteNumber(e),Fg.RequireFiniteNumber(t),Fg.RequireFiniteNumber(s),this.#s.SetSize(e,t,s)}getTexture(){const e=this.#s.GetTexture();return globalThis.ITexture.GetInterface(this.#e,e)}getTexRect(){return this.#s.GetTexRect().toDOMRect()}setTextureUpdateCallback(e){Fg.RequireFunction(e),this.#s.ontextureupdate=e}releaseTexture(){this.#s.ReleaseTexture()}get textWidth(){return this.#s.GetTextWidth()}get textHeight(){return this.#s.GetTextHeight()}}}{const Og=globalThis.C3,Bg=globalThis.C3X;globalThis.IMeshData=class{#e;constructor(e){this.#e=e,Object.defineProperties(this,{vertexCount:{value:e.GetVertexCount(),writable:!1},indexCount:{value:e.GetIndexCount(),writable:!1},positions:{value:e.positions,writable:!1},texCoords:{value:e.texCoords,writable:!1},colors:{value:e.colors,writable:!1},indices:{value:e.indices,writable:!1},debugLabel:{value:e.GetDebugLabel(),writable:!1}})}markDataChanged(e,t,s){this.#e.MarkDataChanged(e,t,s)}markAllVertexDataChanged(e=0,t=this.vertexCount){this.#e.MarkAllVertexDataChanged(e,t)}markIndexDataChanged(e=0,t=this.indexCount){this.#e.MarkIndexDataChanged(e,t)}fillColor(e,t,s,i){this.#e.FillColor(e,t,s,i)}release(){this.#e.Release()}}}{let kg=function(e){if(!e)return"";const t=e.split(".");if(t.length<2)return"";const s=t.at(-1).toLowerCase();return Ug.get(s)||""},Lg=function(e){return new Promise((t,s)=>{const i=document.createElement("script");i.onload=t,i.onerror=s,i.async=!1,i.type="module",i.src=e,document.head.appendChild(i)})};GetTypeFromFileExtension=kg,AddScript=Lg;const Ng=self.C3,Wg=new Set(["local","remote"]),Ug=new Map([["mp4","video/mp4"],["webm","video/webm"],["m4a","audio/mp4"],["mp3","audio/mpeg"],["js","application/javascript"],["wasm","application/wasm"],["svg","image/svg+xml"],["html","text/html"]]);Ng.AssetManager=class extends Ng.DefendedBase{constructor(e,t){super();const s=t.exportType;this._runtime=e,this._cordovaBlobUrlCache=new Map,this._isCordova="cordova"===s,this._isiOSCordova=!!t.isiOSCordova,this._swClientId=t.swClientId,this._supportedAudioFormats=t.supportedAudioFormats||{},this._audioFiles=new Map,this._preloadSounds=!1,this._scriptSubfolder=t.scriptFolder,this._mediaSubfolder="",this._fontsSubfolder="",this._iconsSubfolder="",this._fileMap=t.fileMap||new Map,this._fileMapBlobUrls=new Map,this._exportedFileList=[];const i="html5"===s||"scirra-arcade"===s||"instant-games"===s;this._defaultLoadPolicy=i?"remote":"local",this._imageAssetsMap=new Map,this._webFonts=[],this._loadPromises=[],this._hasFinishedInitialLoad=!1,this._totalAssetSizeToLoad=0,this._assetSizeLoaded=0,this._lastLoadProgress=0,this._hasHadErrorLoading=!1,this._loadingRateLimiter=Ng.New(Ng.RateLimiter,()=>this._FireLoadingProgressEvent(),50),this._localPromiseThrottle=Ng.New(Ng.PromiseThrottle,Math.max(Ng.hardwareConcurrency,8)),this._remotePromiseThrottle=Ng.New(Ng.PromiseThrottle,20),this._iAssetManager=new self.IAssetManager(this)}Release(){for(const e of this._imageAssetsMap.values())e.Release();this._imageAssetsMap.clear(),Ng.clearArray(this._loadPromises),this._runtime=null}GetRuntime(){return this._runtime}GetScriptSubfolder(){return this._scriptSubfolder}_SetMediaSubfolder(e){this._mediaSubfolder=e}GetMediaSubfolder(){return this._mediaSubfolder}_SetFontsSubfolder(e){this._fontsSubfolder=e}GetFontsSubfolder(){return this._fontsSubfolder}_SetIconsSubfolder(e){this._iconsSubfolder=e}GetIconsSubfolder(){return this._iconsSubfolder}_SetExportedFileList(e){this._exportedFileList=e}GetExportedFileList(){return this._exportedFileList}FetchBlob(e,t){return t=t||this._defaultLoadPolicy,Ng.IsRelativeURL(e)?"playable-ad-single-file"===this._runtime.GetExportType()?self.c3_runtimeInterface._PlayableAdFetchBlob(e):"local"===t?this._localPromiseThrottle.Add(()=>Ng.FetchBlob(e)):this._remotePromiseThrottle.Add(()=>Ng.FetchBlob(e)):Ng.FetchBlob(e)}FetchArrayBuffer(e){return Ng.IsRelativeURL(e)?"playable-ad-single-file"===this._runtime.GetExportType()?Ng.BlobToArrayBuffer(self.c3_runtimeInterface._PlayableAdFetchBlob(e)):"local"===this._defaultLoadPolicy?this._localPromiseThrottle.Add(()=>Ng.FetchArrayBuffer(e)):this._remotePromiseThrottle.Add(()=>Ng.FetchArrayBuffer(e)):Ng.FetchArrayBuffer(e)}FetchText(e){return Ng.IsRelativeURL(e)?"playable-ad-single-file"===this._runtime.GetExportType()?Ng.BlobToString(self.c3_runtimeInterface._PlayableAdFetchBlob(e)):"local"===this._defaultLoadPolicy?this._localPromiseThrottle.Add(()=>Ng.FetchText(e)):this._remotePromiseThrottle.Add(()=>Ng.FetchText(e)):Ng.FetchText(e)}async FetchJson(e){const t=await this.FetchText(e);return JSON.parse(t)}GetMediaFileUrl(e){let t=this._mediaSubfolder+e;return"Gecko"===Ng.Platform.BrowserEngine&&"preview"===this._runtime.GetExportType()&&(t=this._GetLocalBlobURLFromFileMap(t)),t}GetProjectFileUrl(e){return"playable-ad-single-file"===this._runtime.GetExportType()&&Ng.IsRelativeURL(e)?URL.createObjectURL(self.c3_runtimeInterface._PlayableAdFetchBlob(e)):e}GetProjectFileIframeUrl(e){if(Ng.IsAbsoluteURL(e)||"preview"!==this._runtime.GetExportType()||!this._swClientId||!e)return e;try{const t=new URL(e,location.href);return t.searchParams.set("__c3_client_id",this._swClientId),t.toString()}catch(t){return console.warn("Invalid iframe URL: "+e),e}}_GetImageAssetKey(e,t){return(t?"true":"false")+"|"+e}LoadImage(e){const t=!!e.isTiled;if(e.loadPolicy&&!Wg.has(e.loadPolicy))throw new Error("invalid load policy");const s=this._GetImageAssetKey(e.url,t);let i=this._imageAssetsMap.get(s);return i||(i=Ng.New(Ng.ImageAsset,this,{url:e.url,size:e.size||0,loadPolicy:e.loadPolicy||this._defaultLoadPolicy,isTiled:t}),this._imageAssetsMap.set(s,i),this._hasFinishedInitialLoad||(this._totalAssetSizeToLoad+=i.GetSize(),this._loadPromises.push(i.Load().then(()=>this._AddLoadedSize(i.GetSize())))),i)}_ReleaseImageAsset(e){const t=this._GetImageAssetKey(e.GetURL(),e.IsTiled());this._imageAssetsMap.delete(t)}async WaitForAllToLoad(e){try{await Promise.all(this._loadPromises),this._lastLoadProgress=1,e&&0===this._totalAssetSizeToLoad&&this._FireLoadingProgressEvent()}catch(e){console.error("Error loading: ",e),this._hasHadErrorLoading=!0,this._FireLoadingProgressEvent()}}SetInitialLoadFinished(){this._hasFinishedInitialLoad=!0}HasHadErrorLoading(){return this._hasHadErrorLoading}_AddLoadedSize(e){this._assetSizeLoaded+=e,this._loadingRateLimiter.Call()}_FireLoadingProgressEvent(){const e=Ng.New(Ng.Event,"loadingprogress");0===this._totalAssetSizeToLoad?this._lastLoadProgress=1:this._lastLoadProgress=Ng.clamp(this._assetSizeLoaded/this._totalAssetSizeToLoad,0,1),e.progress=this._lastLoadProgress,this._runtime.Dispatcher().dispatchEvent(e),this._runtime.DispatchUserScriptEvent(Ng.New(Ng.Event,"loadingprogress"))}GetLoadProgress(){return this._lastLoadProgress}GetImageLoadProgress(){return this._runtime.GetSystemPlugin().GetImageLoadingProgress()}_SetWebFonts(e){Ng.shallowAssignArray(this._webFonts,e),this._webFonts.length&&this._loadPromises.push(this._LoadWebFonts())}async _LoadWebFonts(){const e=[],t=[];for(const[s,i,r]of this._webFonts)this._totalAssetSizeToLoad+=r,e.push(this._LoadWebFont(s,i,t).then(()=>this._AddLoadedSize(r)));await Promise.all(e),this._runtime.IsInWorker()&&t.length>0&&await this._runtime.PostComponentMessageToDOMAsync("runtime","load-webfonts",{webfonts:t})}async _LoadWebFont(e,t,s){try{let i=this.GetProjectFileUrl(t);"Gecko"===Ng.Platform.BrowserEngine&&(e=`'${e}'`),("Gecko"===Ng.Platform.BrowserEngine&&"preview"===this._runtime.GetExportType()||"playable-ad-single-file"===this._runtime.GetExportType())&&(i=this._GetLocalBlobURLFromFileMap(i));const r=new FontFace(e,`url('${i}')`);this._runtime.IsInWorker()?self.fonts.add(r):document.fonts.add(r),await r.load(),this._runtime.IsInWorker()&&s.push({name:e,url:i})}catch(t){console.warn(`[C3 runtime] Failed to load web font '${e}': `,t)}}IsAudioFormatSupported(e){return!!this._supportedAudioFormats[e]}_SetAudioFiles(e,t){this._preloadSounds=!!t;for(const[t,s,i]of e)this._audioFiles.set(t,{fileName:t,formats:s.map(e=>({type:e[0],fileExtension:e[1],fullName:t+e[1],fileSize:e[2]})),isMusic:i})}GetPreferredAudioFile(e){const t=this._audioFiles.get(e);if(!t)return null;let s=null;for(const e of t.formats)if(s||"audio/webm; codecs=opus"!==e.type||(s=e),this.IsAudioFormatSupported(e.type))return e;return s}GetProjectAudioFileUrl(e){const t=this.GetPreferredAudioFile(e);return t?{url:this.GetMediaFileUrl(t.fullName),type:t.type}:null}GetAudioToPreload(){if(this._preloadSounds){const e=[];for(const t of this._audioFiles.values()){if(t.isMusic)continue;const s=this.GetPreferredAudioFile(t.fileName);s&&e.push({originalUrl:t.fileName,url:this.GetMediaFileUrl(s.fullName),type:s.type,fileSize:s.fileSize})}return e}return[]}_GetLocalBlobFromFileMap(e){return"preview"===this._runtime.GetExportType()&&(e=new URL(e,location.href).toString()),this._fileMap.get(e)||null}_GetLocalBlobURLFromFileMap(e){let t=this._fileMapBlobUrls.get(e);if(t)return t;const s=this._GetLocalBlobFromFileMap(e);return s?(t=URL.createObjectURL(s),this._fileMapBlobUrls.set(e,t),t):e}GetIAssetManager(){return this._iAssetManager}async LoadScripts(...e){const t=e.map(e=>this.GetProjectFileUrl(e));if(this._runtime.IsInWorker())if(1===e.length){const t=e[0];await import(new URL(t,location.href).toString())}else{const t=e.map(e=>`import "${new URL(e,location.href).toString()}";`).join("\n"),s=URL.createObjectURL(new Blob([t],{type:"application/javascript"}));await import(s)}else await Promise.all(t.map(e=>Lg(e)))}async CompileWebAssembly(e){if(WebAssembly.compileStreaming){const t=this.GetProjectFileUrl(e);return await WebAssembly.compileStreaming(fetch(t))}{const t=await Ng.FetchArrayBuffer(e);return await WebAssembly.compile(t)}}async LoadStyleSheet(e){const t=this.GetProjectFileUrl(e);return await this._runtime.PostComponentMessageToDOMAsync("runtime","add-stylesheet",{url:t})}}}{const Vg=self.C3;Vg.Asset=class extends Vg.DefendedBase{constructor(e,t){super(),this._assetManager=e,this._runtime=e.GetRuntime(),this._url=t.url||"",this._size=t.size,this._loadPolicy=t.loadPolicy,this._blob=t.blob||null,this._isLoaded=!!this._blob,this._loadPromise=null}Release(){this._loadPromise=null,this._assetManager=null,this._runtime=null,this._blob=null}GetURL(){return this._url}GetSize(){return this._size}Load(){return"local"===this._loadPolicy||this._blob?(this._isLoaded=!0,Promise.resolve()):(this._loadPromise||(this._loadPromise=this._assetManager.FetchBlob(this._url,this._loadPolicy).then(e=>(this._isLoaded=!0,this._loadPromise=null,this._blob=e,e)).catch(e=>{console.error("Error loading resource: ",e),this._loadPromise=null})),this._loadPromise)}IsLoaded(){return this._isLoaded}GetBlob(){return this._blob?Promise.resolve(this._blob):this._loadPromise?this._loadPromise:this._assetManager.FetchBlob(this._url,this._loadPolicy)}}}{const Hg=self.C3,jg=new Hg.PromiseThrottle,zg=new Set;Hg.ImageAsset=class extends Hg.Asset{constructor(e,t){super(e,t),this._texturePromise=null,this._webglTexture=null,this._refCount=0,this._imageWidth=-1,this._imageHeight=-1,this._isTiled=!!t.isTiled,zg.add(this)}Release(){if(0!==this._refCount)throw new Error("released image asset which still has references");this._assetManager._ReleaseImageAsset(this),this._texturePromise=null,zg.delete(this),super.Release()}static OnRendererContextLost(){for(const e of zg)e._texturePromise=null,e._webglTexture=null,e._refCount=0}LoadStaticTexture(e,t){return t=t||{},this._refCount++,this._webglTexture?Promise.resolve(this._webglTexture):(this._texturePromise||(t.anisotropy=this._runtime.GetCanvasManager().GetTextureAnisotropy(),this._texturePromise=this._DoLoadStaticTexture(e,t)),this._texturePromise)}async _DoLoadStaticTexture(e,t){try{const s=await this.GetBlob();return 0===this._refCount?(this._texturePromise=null,null):await jg.Add(async()=>{const i=await e.CreateStaticTextureAsync(s,t);return this._texturePromise=null,0===this._refCount?(e.DeleteTexture(i),null):(this._webglTexture=i,this._imageWidth=i.GetWidth(),this._imageHeight=i.GetHeight(),this._webglTexture)})}catch(e){throw console.error("Failed to load texture: ",e),e}}ReleaseTexture(){if(this._refCount<=0)throw new Error("texture released too many times");this._refCount--,0===this._refCount&&this._webglTexture&&(this._webglTexture.GetRenderer().DeleteTexture(this._webglTexture),this._webglTexture=null)}IncRefCount(){this._refCount++}GetRefCount(){return this._refCount}DecRefCount(){this._refCount--}GetTexture(){return this._webglTexture}GetWidth(){return this._imageWidth}GetHeight(){return this._imageHeight}IsTiled(){return this._isTiled}async LoadToDrawable(){const e=await this.GetBlob();return Hg.Supports.ImageBitmap?await createImageBitmap(e):await Hg.BlobToImage(e)}}}{let Xg=function(e,t){return e.GetWorldInfo()._GetLastCachedZIndex()-t.GetWorldInfo()._GetLastCachedZIndex()};SortByInstLastCachedZIndex=Xg;const Yg=self.C3,qg=self.assert;Yg.RenderCell=class extends Yg.DefendedBase{constructor(e,t,s){super(),this._grid=e,this._x=t,this._y=s,this._instances=[],this._isSorted=!0,this._pendingRemoval=new Set,this._isAnyPendingRemoval=!1}Release(){Yg.clearArray(this._instances),this._pendingRemoval.clear(),this._grid=null}Reset(){Yg.clearArray(this._instances),this._isSorted=!0,this._pendingRemoval.clear(),this._isAnyPendingRemoval=!1}SetChanged(){this._isSorted=!1}IsEmpty(){return!this._instances.length||!(this._instances.length>this._pendingRemoval.size)&&(this._FlushPending(),!0)}Insert(e){if(this._pendingRemoval.has(e))return this._pendingRemoval.delete(e),void(0===this._pendingRemoval.size&&(this._isAnyPendingRemoval=!1));this._instances.push(e),this._isSorted=1===this._instances.length}Remove(e){this._pendingRemoval.add(e),this._isAnyPendingRemoval=!0,this._pendingRemoval.size>=50&&this._FlushPending()}_FlushPending(){this._isAnyPendingRemoval&&(this._instances.length!==this._pendingRemoval.size?(Yg.arrayRemoveAllInSet(this._instances,this._pendingRemoval),this._pendingRemoval.clear(),this._isAnyPendingRemoval=!1):this.Reset())}_EnsureSorted(){this._isSorted||(this._instances.sort(Xg),this._isSorted=!0)}Dump(e){this._FlushPending(),this._EnsureSorted(),this._instances.length&&e.push(this._instances)}}}{const Kg=self.C3;Kg.RenderGrid=class extends Kg.DefendedBase{constructor(e,t){super(),this._cellWidth=e,this._cellHeight=t,this._cells=Kg.New(Kg.PairMap)}Release(){this._cells.Release(),this._cells=null}GetCell(e,t,s){let i=this._cells.Get(e,t);return i||(s?(i=Kg.New(Kg.RenderCell,this,e,t),this._cells.Set(e,t,i),i):null)}XToCell(e){return Math.floor(e/this._cellWidth)}YToCell(e){return Math.floor(e/this._cellHeight)}Update(e,t,s){if(t)for(let i=t.getLeft(),r=t.getRight();i<=r;++i)for(let r=t.getTop(),n=t.getBottom();r<=n;++r){if(s&&s.containsPoint(i,r))continue;const t=this.GetCell(i,r,!1);t&&(t.Remove(e),t.IsEmpty()&&this._cells.Delete(i,r))}if(s)for(let i=s.getLeft(),r=s.getRight();i<=r;++i)for(let r=s.getTop(),n=s.getBottom();r<=n;++r)t&&t.containsPoint(i,r)||this.GetCell(i,r,!0).Insert(e)}QueryRange(e,t){let s=this.XToCell(e.getLeft());const i=this.YToCell(e.getTop()),r=this.XToCell(e.getRight()),n=this.YToCell(e.getBottom());for(;s<=r;++s)for(let e=i;e<=n;++e){const i=this.GetCell(s,e,!1);i&&i.Dump(t)}}MarkRangeChanged(e){let t=e.getLeft();const s=e.getTop(),i=e.getRight(),r=e.getBottom();for(;t<=i;++t)for(let e=s;e<=r;++e){const s=this.GetCell(t,e,!1);s&&s.SetChanged()}}}}{let $g=function(e,t){return e.GetWorldInfo()._GetLastCachedZIndex()-t.GetWorldInfo()._GetLastCachedZIndex()},Jg=function(e,t){return e.GetWorldInfo().GetZElevation()-t.GetWorldInfo().GetZElevation()};SortByInstLastCachedZIndex=$g,SortByInstZElevation=Jg;const Zg=self.C3,Qg=self.assert,eS=new Zg.Rect,tS=new Zg.Quad,sS=[],iS=new Zg.Rect,rS=new Zg.Rect,nS=self.glMatrix,aS=nS.vec3,oS=nS.vec4,hS=nS.mat4,lS=hS.create(),cS=aS.create(),uS=oS.create(),dS=aS.create(),_S=aS.create(),pS=aS.create(),fS=Zg.New(Zg.Vector2),mS=Zg.New(Zg.Rect),gS=[],SS=[],GS=[],yS={name:"",sid:-1,isDynamic:!1,isVisible:!0,isInteractive:!0,isHTMLElementsLayer:!1,backgroundColor:[1,1,1,1],isTransparent:!0,parallax:[1,1],opacity:1,isForceOwnTexture:!1,renderAs3d:!1,useCameraDistanceDrawOrder:!1,useRenderCells:!1,scaleRate:1,blendMode:0,zElevation:0,initialInstancesData:[],effectListData:[],subLayersData:[]},IS=new Map,TS=e=>{if(!e.instance.GetObjectClass().IsGlobal())return;const t=e.instance.GetUID();IS.has(t)&&(IS.delete(t),IS.size||e.instance.GetRuntime().Dispatcher().removeEventListener("instancedestroy",TS))};Zg.Layer=class extends Zg.DefendedBase{constructor(e,t,s){super(),s=Object.assign({},yS,s),this._layout=e,this._runtime=e.GetRuntime(),this._parentLayer=t,this._name=s.name,this._index=-1,this._isHTMLElementsLayer=!!s.isHTMLElementsLayer,this._htmlIndex=-1,this._sid=s.sid,this._isDynamic=!!s.isDynamic,this._isVisible=!!s.isVisible,this._isInteractive=!!s.isInteractive,this._backgroundColor=Zg.New(Zg.Color),this._backgroundColor.setFromJSON(s.backgroundColor),this._isTransparent=!!s.isTransparent,this._parallaxX=s.parallax[0],this._parallaxY=s.parallax[1],this._color=Zg.New(Zg.Color,1,1,1,s.opacity),this._premultipliedColor=Zg.New(Zg.Color),this._isForceOwnTexture=!!s.isForceOwnTexture,this._renderAs3d=!!s.renderAs3d,this._useCameraDistanceDrawOrder=!!s.useCameraDistanceDrawOrder,this._useRenderCells=!!s.useRenderCells,this._scaleRate=s.scaleRate,this._blendMode=s.blendMode,this._curRenderTarget=null,this._scale=1,this._zElevation=s.zElevation,this._angle=0,this._scrollX=0,this._scrollY=0,this._hasOwnScrollPosition=!1,this._viewport=Zg.New(Zg.Rect),this._viewportZ0=Zg.New(Zg.Rect),this._viewport3D=Zg.New(Zg.Rect),this._isViewportChanged=!0,this._projectionMatrix=hS.create(),this._isProjectionMatrixChanged=!0,this._modelViewMatrix=hS.create(),this._isMVMatrixChanged=!0,this._viewFrustum=Zg.New(Zg.Gfx.ViewFrustum),this._isViewFrustumChanged=!0,this._startupInitialInstances=[],this._initialInstancesData=s.initialInstancesData,this._initialInstances=[],this._createdGlobalUids=[],this._initialUIDsToInstanceData=new Map,this._instances=[],this._zIndicesUpToDate=!1,this._htmlZIndicesUpToDate=!1,this._anyInstanceZElevated=!1;const i=this._runtime.GetCanvasManager();this._effectList=Zg.New(Zg.EffectList,this,s.effectListData),this._effectChain=Zg.New(Zg.Gfx.EffectChain,i.GetEffectChainManager(),{drawContent:(e,t)=>{const s=t.GetContentObject(),r=s.GetRenderTarget();e.SetColor(s.GetPremultipliedColor()),e.DrawRenderTarget(r),e.InvalidateRenderTarget(r),i.ReleaseAdditionalRenderTarget(r)},getShaderParameters:e=>this.GetEffectList()._GetEffectChainShaderParametersForIndex(e)}),this._needsRebuildEffectChainSteps=!0,this._wasDefaultColor=!0,this._renderGrid=null,this._lastRenderList=[],this._isRenderListUpToDate=!1,this._lastRenderCells=Zg.New(Zg.Rect,0,0,-1,-1),this._curRenderCells=Zg.New(Zg.Rect,0,0,-1,-1),this._iLayer=new self.ILayer(this),this._userScriptDispatcher=Zg.New(Zg.Event.Dispatcher),this._UpdatePremultipliedColor(),this.UsesRenderCells()&&(this._renderGrid=Zg.New(Zg.RenderGrid,this._runtime.GetOriginalViewportWidth(),this._runtime.GetOriginalViewportHeight())),this._subLayers=s.subLayersData.map(e=>Zg.Layer.CreateFromExportData(this._layout,this,e))}_InitInitialInstances(){for(const e of this._initialInstancesData){const t=this._runtime.GetObjectClassByIndex(e[1]);this._layout._AddInitialObjectClass(t),t.GetDefaultInstanceData()||(t.SetDefaultInstanceData(e),t._SetDefaultLayerIndex(this._index)),this._initialInstances.push(e),this._initialUIDsToInstanceData.set(e[2],e)}Zg.shallowAssignArray(this._startupInitialInstances,this._initialInstances),this._initialInstancesData=null}static CreateFromExportData(e,t,s){return Zg.New(Zg.Layer,e,t,{name:s[0],sid:s[2],isVisible:s[3],isInteractive:s[13],isHTMLElementsLayer:s[19],backgroundColor:s[4].map(e=>e/255),isTransparent:s[5],parallax:[s[6],s[7]],opacity:s[8],isForceOwnTexture:s[9],renderAs3d:s[17],useCameraDistanceDrawOrder:s[18],useRenderCells:s[10],scaleRate:s[11],blendMode:s[12],zElevation:s[16],initialInstancesData:s[14],effectListData:s[15],subLayersData:s[20]})}Release(){for(const e of this._subLayers)e.Release();Zg.clearArray(this._subLayers);for(const e of this._instances)this._runtime.DestroyInstance(e);Zg.clearArray(this._instances),this._effectList.Release(),this._effectList=null,this._effectChain.Release(),this._effectChain=null,this._iLayer=null,this._parentLayer=null,this._layout=null,this._runtime=null}WasReleased(){return!this._layout}GetInitialInstanceData(e){return this._initialUIDsToInstanceData.get(e)}CreateInitialInstances(e){const t=this._layout.IsFirstVisit(),s=this._initialInstances;let i=0;for(let r=0,n=s.length;r<n;++r){const n=s[r],a=this._runtime.GetObjectClassByIndex(n[1]);let o=!0;if(!a.HasPersistBehavior()||t)if(a.IsGlobal()&&IS.has(n[2]))o=!1;else{const t=this._runtime.CreateInstanceFromData(n,this,!0);e.push(t),a.IsGlobal()&&(IS.size||this._runtime.Dispatcher().addEventListener("instancedestroy",TS),IS.set(t.GetUID(),t),o=!1,this._createdGlobalUids.push(t.GetUID()))}o&&(s[i]=s[r],++i)}Zg.truncateArray(s,i),this._runtime.FlushPendingInstances(),this.SetZIndicesChanged()}_AddInstance(e,t){if(!e.GetPlugin().IsWorldType())throw new Error("instance is not of world type");const s=e.GetWorldInfo();if(s.GetLayer()!==this)throw new Error("instance added to wrong layer");this._instances.push(e),0!==s.GetZElevation()&&(this._anyInstanceZElevated=!0),t&&this.UsesRenderCells()&&e.GetWorldInfo().SetBboxChanged(),this.SetZIndicesChanged(e)}_MaybeAddInstance(e){this._instances.includes(e)||(this._instances.push(e),0!==e.GetWorldInfo().GetZElevation()&&(this._anyInstanceZElevated=!0),this.SetZIndicesChanged(e))}_PrependInstance(e,t){const s=e.GetWorldInfo();if(s.GetLayer()!==this)throw new Error("instance added to wrong layer");this._instances.unshift(e),0!==s.GetZElevation()&&(this._anyInstanceZElevated=!0),this.SetZIndicesChanged(e),t&&this.UsesRenderCells()&&e.GetWorldInfo().SetBboxChanged()}_RemoveInstance(e,t){const s=this._instances.indexOf(e);s<0||(t&&this.UsesRenderCells()&&e.GetWorldInfo()._RemoveFromRenderCells(),this._instances.splice(s,1),this.SetZIndicesChanged(e),this._MaybeResetAnyInstanceZElevatedFlag())}_SetAnyInstanceZElevated(){this._anyInstanceZElevated=!0}_MaybeResetAnyInstanceZElevatedFlag(){0===this._instances.length&&(this._anyInstanceZElevated=!1)}_SortInstancesByLastCachedZIndex(e){if(e){const e=new Set;for(const t of this._instances){const s=t.GetWorldInfo()._GetLastCachedZIndex();s>=0&&e.add(s)}let t=-1;for(const s of this._instances){const i=s.GetWorldInfo();if(!(i._GetLastCachedZIndex()>=0)){for(++t;e.has(t);)++t;i._SetZIndex(t)}}}this._instances.sort($g)}_Start(){}_End(){for(const e of this._instances)e.GetObjectClass().IsGlobal()||this._runtime.DestroyInstance(e);this._runtime.FlushPendingInstances(),Zg.clearArray(this._instances),this._anyInstanceZElevated=!1,this.SetZIndicesChanged()}RecreateInitialObjects(e,t,s,i,r,n){const a=this._runtime.GetEventSheetManager(),o=this._runtime.GetAllObjectClasses(),h=e.IsFamily(),l=[];for(const c of this._initialInstances){const u=c[0],d=u[0],_=u[1];if(!t.containsPoint(d,_))continue;const p=o[c[1]];if(p!==e){if(!h)continue;if(!e.FamilyHasMember(p))continue}let f=r;if(!f){const e=this._runtime.GetCurrentLayout();this.GetLayout()===e?f=this:(f=e.GetLayerByName(this.GetName()),f||(f=e.GetLayerByIndex(this.GetIndex())))}const m=this._runtime.CreateInstanceFromData(c,f,!1,void 0,void 0,!1,n,void 0,n);n&&f.SortAndAddInstancesByZIndex(m);const g=m.GetWorldInfo();g.OffsetXY(s,i),g.SetBboxChanged(),a.BlockFlushingInstances(!0),m._TriggerOnCreatedOnSelfAndRelated(),a.BlockFlushingInstances(!1),l.push(m)}return l}GetInstanceCount(){return this._instances.length}GetLayout(){return this._layout}GetName(){return this._name}_SetIndex(e){this._index=e}GetIndex(){return this._index}_SetHTMLIndex(e){this._htmlIndex=e}GetHTMLIndex(){return this._htmlIndex}IsHTMLElementsLayer(){return this._isHTMLElementsLayer}SetIsHTMLElementsLayer(e){e=!!e,this._isHTMLElementsLayer!==e&&(this._isHTMLElementsLayer=e,this._layout._ReindexAndUpdateAllLayers(),this._runtime.UpdateRender())}_GetSiblingIndex(){let e=-1;const t=this.GetParentLayer();return e=t?t.GetSubLayers().indexOf(this):this.GetLayout()._GetRootLayers().indexOf(this),e}GetSID(){return this._sid}GetRuntime(){return this._runtime}IsDynamic(){return this._isDynamic}HasAnyDynamicParentLayer(){for(const e of this.parentLayers())if(e.IsDynamic())return!0;return!1}GetDevicePixelRatio(){return this._runtime.GetDevicePixelRatio()}GetEffectList(){return this._effectList}GetEffectChain(){return this._MaybeRebuildEffectChainSteps(),this._effectChain}_MaybeRebuildEffectChainSteps(){const e=this.HasDefaultColor();if(!this._needsRebuildEffectChainSteps&&e===this._wasDefaultColor&&!this._effectChain.NeedsRebuild())return;const t=this.GetEffectList().GetActiveEffectTypes();this._effectChain.BuildSteps(t.map(e=>e.GetShaderProgram()),{indexMap:t.map(e=>e.GetIndex()),forcePreDraw:!e,useFullSurface:!0}),this._needsRebuildEffectChainSteps=!1,this._wasDefaultColor=e}UpdateActiveEffects(){this.GetEffectList().UpdateActiveEffects(),this._needsRebuildEffectChainSteps=!0}UsesRenderCells(){return this._useRenderCells&&!this._useCameraDistanceDrawOrder}GetRenderGrid(){return this._renderGrid}SetRenderListStale(){this._isRenderListUpToDate=!1}IsVisible(){for(const e of this.selfAndParentLayers())if(!e._IsVisibleFlagSet())return!1;return!0}_IsVisibleFlagSet(){return this._isVisible}SetVisible(e){e=!!e,this._isVisible!==e&&(this._isVisible=e,this._runtime.UpdateRender())}SetInteractive(e){this._isInteractive=!!e}IsInteractive(){return this._isInteractive}IsSelfAndParentsInteractive(){for(const e of this.selfAndParentLayers())if(!e.IsInteractive())return!1;return!0}SetOwnScrollPositionEnabled(e){if(e=!!e,this._hasOwnScrollPosition!==e){if(this._hasOwnScrollPosition=e,e){const e=this.GetLayout();this._scrollX=e.GetScrollX(),this._scrollY=e.GetScrollY()}this._SetMVMatrixChanged(),this._runtime.UpdateRender()}}IsOwnScrollPositionEnabled(){return this._hasOwnScrollPosition}SetScrollX(e){const t=this.GetLayout(),s=t.GetScrollLeftBound(),i=t.GetScrollRightBound();e>i&&(e=i),e<s&&(e=s),this._scrollX!==e&&(this._scrollX=e,this.IsOwnScrollPositionEnabled()&&(this._SetMVMatrixChanged(),this._runtime.UpdateRender()))}SetScrollY(e){const t=this.GetLayout(),s=t.GetScrollTopBound(),i=t.GetScrollBottomBound();e>i&&(e=i),e<s&&(e=s),this._scrollY!==e&&(this._scrollY=e,this.IsOwnScrollPositionEnabled()&&(this._SetMVMatrixChanged(),this._runtime.UpdateRender()))}GetScrollX(){return this.IsOwnScrollPositionEnabled()?this._scrollX:this.GetLayout().GetScrollX()}GetScrollY(){return this.IsOwnScrollPositionEnabled()?this._scrollY:this.GetLayout().GetScrollY()}GetViewport(){return this._MaybeUpdateViewport(),this._viewport}_GetViewportZ0(){return this._MaybeUpdateViewport(),this._viewportZ0}GetViewport3D(){return this._MaybeUpdateViewport(),this._viewport3D}_GetVanishingPoint(){return this.GetLayout().GetVanishingPoint()}GetDefaultCameraZ(e){return this._runtime.GetDefaultCameraZ(e)}GetViewportForZ(e,t){const s=this._GetViewportZ0();if(0===e)t.copy(s);else{let i=s.midX(),r=s.midY();const n=this.Get2DScaleFactorToZ(e),a=s.width()/n,o=s.height()/n,[h,l]=this._GetVanishingPoint();if(.5!==h||.5!==l){const t=this.Get2DCameraZ(),s=this._runtime,n=this.GetDefaultCameraZ()/t;let a=(h-.5)*s.GetViewportWidth()/n,o=(l-.5)*s.GetViewportHeight()/n;const c=this.GetAngle();0!==c&&(fS.set(a,o),fS.rotate(c),a=fS.getX(),o=fS.getY());const u=Zg.unlerp(t,0,e);i+=Zg.lerp(a,0,u),r+=Zg.lerp(o,0,u)}t.set(i-a/2,r-o/2,i+a/2,r+o/2)}}GetOpacity(){return this._color.getA()}SetOpacity(e){e=Zg.clamp(e,0,1),this._color.getA()!==e&&(this._color.setA(e),this._UpdatePremultipliedColor(),this._runtime.UpdateRender())}_UpdatePremultipliedColor(){this._premultipliedColor.copy(this._color),this._premultipliedColor.premultiply()}GetPremultipliedColor(){return this._premultipliedColor}HasDefaultColor(){return this._color.equalsRgba(1,1,1,1)}GetScaleRate(){return this._scaleRate}SetScaleRate(e){this._scaleRate!==e&&(this._scaleRate=e,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}GetParallaxX(){return this._parallaxX}GetParallaxY(){return this._parallaxY}SetParallax(e,t){this._parallaxX===e&&this._parallaxY===t||(this._parallaxX=e,this._parallaxY=t,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}SetParallaxX(e){this.SetParallax(e,this.GetParallaxY())}SetParallaxY(e){this.SetParallax(this.GetParallaxX(),e)}SetZElevation(e){this._zElevation!==e&&(this._zElevation=e,this._runtime.UpdateRender())}GetZElevation(){return this._zElevation}SetAngle(e){e=Zg.clampAngle(e),this._angle!==e&&(this._angle=e,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}GetAngle(){return Zg.clampAngle(this._layout.GetAngle()+this._angle)}GetOwnAngle(){return this._angle}HasInstances(){return this._instances.length>0}_GetInstances(){return this._instances}_GetInstancesInDrawOrder(){return this.RendersIn3DMode()&&this._useCameraDistanceDrawOrder?(Zg.shallowAssignArray(GS,this._GetInstances()),GS.sort((e,t)=>this._SortInstancesByCameraDistance(e,t)),GS):this._GetInstances()}_AppendAllInstancesIncludingSubLayersInDrawOrder(e){Zg.appendArray(e,this._GetInstancesInDrawOrder());for(const t of this._subLayers)t.IsVisible()&&t.GetOpacity()>0&&t._AppendAllInstancesIncludingSubLayersInDrawOrder(e)}_SortInstancesByCameraDistance(e,t){const s=this.GetLayout().Get3DCameraPosition(),i=s[0],r=s[1],n=s[2],a=e.GetWorldInfo(),o=t.GetWorldInfo(),h=a.GetX()-i,l=a.GetY()-r,c=a.GetZElevation()-n,u=o.GetX()-i,d=o.GetY()-r,_=o.GetZElevation()-n;return u*u+d*d+_*_-(h*h+l*l+c*c)}GetBackgroundColor(){return this._backgroundColor}IsTransparent(){return this._isTransparent}SetTransparent(e){e=!!e,this._isTransparent!==e&&(this._isTransparent=e,this._runtime.UpdateRender())}IsForceOwnTexture(){return this._isForceOwnTexture}SetForceOwnTexture(e){e=!!e,this._isForceOwnTexture!==e&&(this._isForceOwnTexture=e,this._runtime.UpdateRender())}SetRenderAs3D(e){e=!!e,this._renderAs3d!==e&&(this._renderAs3d=e,this._SetMVMatrixChanged(),this._runtime.UpdateRender())}IsRenderAs3D(){return this._renderAs3d}RendersIn2DMode(){return!this.GetRuntime().Uses3DFeatures()||!this._renderAs3d}RendersIn3DMode(){return!this.RendersIn2DMode()}Has3DCamera(){return this.RendersIn3DMode()&&this.GetLayout().Is3DCameraEnabled()}SelfAndAllSubLayersHave3DCamera(){if(!this.Has3DCamera())return!1;for(const e of this._subLayers)if(!e.SelfAndAllSubLayersHave3DCamera())return!1;return!0}SetBlendMode(e){this._blendMode!==e&&(this._blendMode=e,this._runtime.UpdateRender())}GetBlendMode(){return this._blendMode}IsRootLayer(){return!this._parentLayer}GetParentLayer(){return this._parentLayer}_SetParentLayer(e){this._parentLayer=e}GetSubLayers(){return this._subLayers}HasAnySubLayers(){return this._subLayers.length>0}_AddSubLayer(e,t=!0){t?this._subLayers.push(e):this._subLayers.unshift(e)}_InsertSubLayer(e,t,s){let i=this._subLayers.indexOf(t);if(-1===i)throw new Error("cannot find layer to insert by");s&&++i,this._subLayers.splice(i,0,e)}_RemoveSubLayer(e){const t=this._subLayers.indexOf(e);if(-1===t)throw new Error("cannot find layer to remove");this._subLayers.splice(t,1)}HasAnyVisibleSubLayer(){for(const e of this._subLayers)if(e.ShouldDraw())return!0;return!1}*selfAndAllSubLayers(){for(const e of this._subLayers)yield*e.selfAndAllSubLayers();yield this}*parentLayers(){let e=this.GetParentLayer();for(;e;)yield e,e=e.GetParentLayer()}*selfAndParentLayers(){yield this,yield*this.parentLayers()}HasParentLayer(e){for(const t of this.parentLayers())if(t===e)return!0;return!1}IsTransformCompatibleWith(e){return this===e||this._parallaxX===e._parallaxX&&this._parallaxY===e._parallaxY&&this._scale===e._scale&&this._scaleRate===e._scaleRate&&this._angle===e._angle&&this.GetScrollX()===e.GetScrollX()&&this.GetScrollY()===e.GetScrollY()}SaveTransform(){return{parallaxX:this.GetParallaxX(),parallaxY:this.GetParallaxY(),scale:this.GetOwnScale(),scaleRate:this.GetScaleRate(),angle:this.GetOwnAngle(),hasOwnScroll:this.IsOwnScrollPositionEnabled(),scrollX:this.GetScrollX(),scrollY:this.GetScrollY()}}RestoreTransform(e){this.SetParallax(e.parallaxX,e.parallaxY),this.SetOwnScale(e.scale),this.SetScaleRate(e.scaleRate),this.SetAngle(e.angle),this.SetOwnScrollPositionEnabled(e.hasOwnScroll),this.SetScrollX(e.scrollX),this.SetScrollY(e.scrollY),this._MaybeUpdateViewport()}_RemoveAllInstancesInSet(e){0!==e.size&&Zg.arrayRemoveAllInSet(this._instances,e)>0&&(this._MaybeResetAnyInstanceZElevatedFlag(),this.SetZIndicesChanged())}SetZIndicesChanged(e){this._zIndicesUpToDate=!1,this._isRenderListUpToDate=!1,e&&!e.GetObjectClass().GetPlugin().IsHTMLElementType()||(this._htmlZIndicesUpToDate=!1)}_UpdateZIndices(){if(!this._zIndicesUpToDate){if(this._instances.sort(Jg),this.UsesRenderCells())for(let e=0,t=this._instances.length;e<t;++e){const t=this._instances[e].GetWorldInfo();t._SetZIndex(e),this._renderGrid.MarkRangeChanged(t.GetRenderCellRange())}else for(let e=0,t=this._instances.length;e<t;++e)this._instances[e].GetWorldInfo()._SetZIndex(e);this._zIndicesUpToDate=!0}}_UpdateHTMLZIndices(){if(this._htmlZIndicesUpToDate)return;const e=this._layout.GetRootLayersForHTMLLayer(this.GetHTMLIndex()).map(e=>[...e.selfAndAllSubLayers()]).flat();let t=0;for(const s of e){for(const e of s._GetInstances())e.GetObjectClass().GetPlugin().IsHTMLElementType()&&e.GetWorldInfo()._SetHTMLZIndex(t++);s._SetHTMLZIndicesUpToDate()}}_SetHTMLZIndicesUpToDate(){this._htmlZIndicesUpToDate=!0}_GetHTMLLayerDOMState(){return{isVisible:this.IsVisible(),opacity:this.GetOpacity(),isInteractive:this.IsInteractive()}}MoveInstanceAdjacent(e,t,s){const i=e.GetWorldInfo(),r=t.GetWorldInfo();if(i.GetLayer()!==this||r.GetLayer()!==this)throw new Error("can't arrange Z order unless both objects on this layer");const n=i.GetZIndex();let a=r.GetZIndex();return n!==a+(s?1:-1)&&(Zg.arrayRemove(this._instances,n),n<a&&a--,s&&a++,a===this._instances.length?this._instances.push(e):this._instances.splice(a,0,e),this.SetZIndicesChanged(e),!0)}_MergeSortedZArrays(e,t){const s=[];let i=0,r=0,n=e.length,a=t.length;for(;i<n&&r<a;){const n=e[i],a=t[r];n.GetWorldInfo()._GetLastCachedZIndex()<a.GetWorldInfo()._GetLastCachedZIndex()?(s.push(n),++i):(s.push(a),++r)}for(;i<n;++i)s.push(e[i]);for(;r<a;++r)s.push(t[r]);return s}_MergeAllSortedZArrays_pass(e){const t=[],s=e.length;for(let i=0;i<s-1;i+=2){const s=e[i],r=e[i+1];t.push(this._MergeSortedZArrays(s,r))}return s%2==1&&t.push(e[s-1]),t}_MergeAllSortedZArrays(e){for(;e.length>1;)e=this._MergeAllSortedZArrays_pass(e);return e[0]}_GetRenderCellInstancesToDraw(){return this._UpdateZIndices(),Zg.clearArray(sS),this._renderGrid.QueryRange(this.GetViewport(),sS),sS.length?1===sS.length?sS[0]:this._MergeAllSortedZArrays(sS):[]}ShouldDraw(){return this.IsVisible()&&this.GetOpacity()>0&&this._DrawsAnyContentInSelfOrSubLayers()}_DrawsAnyContentInSelfOrSubLayers(){if(this.HasInstances()||!this.IsTransparent()||this._userScriptDispatcher.HasAnyHandlerFor("beforedraw")||this._userScriptDispatcher.HasAnyHandlerFor("afterdraw"))return!0;for(const e of this._subLayers)if(e._DrawsAnyContentInSelfOrSubLayers())return!0;return!1}UsesOwnTexture(){return this.IsForceOwnTexture()||!this.HasDefaultColor()||0!==this.GetBlendMode()||this._effectList.HasAnyActiveEffect()}SelfOrAnySubLayerUsesOwnTexture(){if(this.UsesOwnTexture())return!0;for(const e of this._subLayers)if(e.SelfOrAnySubLayerUsesOwnTexture())return!0;return!1}GetRenderTarget(){return this._curRenderTarget}Get2DScaleFactorToZ(e){if(this._layout.IsOrthographicProjection())return 1;{const t=this.Get3DCameraZ();return t/(t-e)}}GetResolutionScaleFactorToZ(e){const t=this._runtime.GetRenderScale();if(this._layout.IsOrthographicProjection())return t;{const s=this.Get3DCameraZ();return this.GetDefaultCameraZ()/Math.abs(s-e)*t}}_SetMVMatrixChanged(){this._isMVMatrixChanged=!0,this._isViewFrustumChanged=!0,this._isViewportChanged=!0}_GetModelViewMatrix(e){return this._isMVMatrixChanged&&(this._CalculateModelViewMatrix(e,this._modelViewMatrix,0,0,null),this._isMVMatrixChanged=!1),this._modelViewMatrix}Get2DCameraZ(e){return this.GetDefaultCameraZ(e)/this.GetNormalScale()}Get3DCameraZ(){return this.Has3DCamera()?this.GetLayout().Get3DCameraPosition()[2]:this.Get2DCameraZ()}GetCameraPosition(){if(this.Has3DCamera()){const e=this.GetLayout().Get3DCameraPosition();return[e[0],e[1],e[2]]}return this._Get2DCameraPosition()}_Get2DCameraPosition(e=0,t=0,s=0){const i=this._runtime,r=this.GetLayout(),n=i.GetParallaxXOrigin(),a=i.GetParallaxYOrigin();let o=(this.GetScrollX()-n)*this._parallaxX+n,h=(this.GetScrollY()-a)*this._parallaxY+a;i.IsPixelRoundingEnabled()&&(o=Math.round(o),h=Math.round(h));let l=o+e,c=h+t;const u=r.IsOrthographicProjection()?this.GetDefaultCameraZ(s):this.Get2DCameraZ(s),[d,_]=this._GetVanishingPoint();if(.5!==d||.5!==_){const e=this.GetDefaultCameraZ(s)/u;let t=(d-.5)*i.GetViewportWidth()/e,r=(_-.5)*i.GetViewportHeight()/e;const n=this.GetAngle();0!==n&&(fS.set(t,r),fS.rotate(n),t=fS.getX(),r=fS.getY()),l+=t,c+=r}return[l,c,u]}_CalculateModelViewMatrix(e,t,s,i,r){const n=this._runtime,a=this.GetLayout();if(this.Has3DCamera()){aS.copy(dS,a.Get3DCameraPosition()),aS.copy(_S,a.Get3DCameraLookAt()),aS.copy(pS,a.Get3DCameraUpVector());const e=n.GetParallaxXOrigin(),t=n.GetParallaxYOrigin(),s=_S[0]-dS[0],i=_S[1]-dS[1],r=_S[2]-dS[2];dS[0]=(dS[0]-e)*this._parallaxX+e,dS[1]=(dS[1]-t)*this._parallaxY+t,dS[2]*=Math.max(this._parallaxX,this._parallaxY),_S[0]=dS[0]+s,_S[1]=dS[1]+i,_S[2]=dS[2]+r}else{const[e,t,n]=this._Get2DCameraPosition(s,i,r);aS.set(dS,e,t,n),aS.set(_S,e,t,n-100);const a=this.GetAngle();0===a?aS.set(pS,0,1,0):aS.set(pS,Math.sin(a),Math.cos(a),0)}e.CalculateLookAtModelView(t,dS,_S,pS,r||n.GetViewportHeight())}_SetProjectionMatrixChanged(){this._isProjectionMatrixChanged=!0,this._isViewFrustumChanged=!0,this._isViewportChanged=!0}_GetProjectionMatrix(e){return this._isProjectionMatrixChanged&&(this._CalculateProjectionMatrix(e),this._isProjectionMatrixChanged=!1),this._projectionMatrix}_CalculateProjectionMatrix(e){const t=this._runtime.GetCanvasManager(),[s,i]=this._GetVanishingPoint();if(this._layout.IsOrthographicProjection())e.CalculateOrthographicMatrix(this._projectionMatrix,t.GetDrawWidth(),t.GetDrawHeight());else if(.5===s&&.5===i)hS.copy(this._projectionMatrix,t.GetDefaultProjectionMatrix());else{const r=t.GetDrawWidth(),n=t.GetDrawHeight();e.CalculatePerspectiveMatrix(this._projectionMatrix,r/n,s,i)}}_SetTransform(e,t=!0,s=0,i=0,r=0){t&&e.SetProjectionMatrix(this._GetProjectionMatrix(e));let n=null;0===s&&0===i&&0===r?n=this._GetModelViewMatrix(e):(this._CalculateModelViewMatrix(e,lS,s,i,r),n=lS),e.SetModelViewMatrix(n)}PrepareForDraw(e){this._SetTransform(e),e.SetBaseZ(this.GetZElevation())}_MaybeStartWebGLProfiling(e){let t=null;if(e.IsWebGL()&&this._runtime.IsGPUProfiling()){const s=this._runtime.GetCanvasManager().GetLayerTimingsBuffer(this);s&&(t=s.AddTimeElapsedQuery(),e.StartQuery(t))}return t}_MaybeStartWebGPUProfiling(e){if(e.IsWebGPU()&&this._runtime.IsGPUProfiling()){const t=2*(this.GetIndex()+1);e.StartMeasuringRenderPassTime(t,t+1)}}_FireDrawEvent(e,t){if(this._userScriptDispatcher.HasAnyHandlerFor(t)){e.SetTextureFillMode(),e.SetTexture(null),e.SetAlphaBlend(),e.ResetCullState(),e.SetColorRgba(1,1,1,1),e.SetBaseZ(this.GetZElevation()),e.SetCurrentZ(0);const s=new Zg.Event(t);s.renderer=this._runtime.GetCanvasManager().GetIRenderer(),this.DispatchUserScriptEvent(s)}}Draw(e,t,s){const i=this._runtime.GetCanvasManager(),r=this.UsesOwnTexture();let n=null;const a=this._MaybeStartWebGLProfiling(e);if(this._MaybeStartWebGPUProfiling(e),r){const t={sampling:this._runtime.GetSampling(),isSampled:!0,canReadPixels:!!e.IsWebGPU()&&this._runtime.UsesAnyBackgroundBlending()};"low"===i.GetCurrentFullscreenScalingQuality()&&(t.width=i.GetDrawWidth(),t.height=i.GetDrawHeight()),n=this._runtime.GetAdditionalRenderTarget(t),this._curRenderTarget=n,e.SetRenderTarget(n),this.IsTransparent()&&e.ClearRgba(0,0,0,0)}else this._curRenderTarget=t,e.SetRenderTarget(t);if(this.IsTransparent()||e.Clear(this._backgroundColor),this._layout._DrawLayerList(e,this._curRenderTarget,this._subLayers,r&&this.IsTransparent()),this._MaybeStartWebGPUProfiling(e),this._SetTransform(e),e.SetBaseZ(this.GetZElevation()),e.SetDepthEnabled(this.RendersIn3DMode()),this._FireDrawEvent(e,"beforedraw"),this.GetNormalScale()>Number.EPSILON){this._UpdateZIndices();const t=this.UsesRenderCells()&&0===this.GetZElevation()&&!this._anyInstanceZElevated;this.Has3DCamera()?this._DrawInstances_3DCamera(e):t?this._DrawInstances_RenderCells(e):this._DrawInstances(e,this._GetInstancesInDrawOrder())}this._FireDrawEvent(e,"afterdraw"),e.SetBaseZ(0),e.SetCurrentZ(0),r&&(e.SetDepthEnabled(!1),this._DrawLayerOwnTextureToRenderTarget(e,n,t,s)),a&&e.EndQuery(a),this._curRenderTarget=null}_DrawInstances(e,t){const s=this.GetViewport(),i=this._curRenderTarget,r=this.GetLayout().IsOrthographicProjection(),n=this.GetLayout().HasVanishingPointOutsideViewport();let a=null;for(let o=0,h=t.length;o<h;++o){const h=t[o];if(h===a)continue;a=h;const l=h.GetWorldInfo();l.IsVisible()&&l.IsInViewport(s,n,r)&&this._DrawInstanceMaybeWithEffects(h,l,e,i)}}_DrawInstances_3DCamera(e){const t=this._curRenderTarget,s=this._GetViewFrustum(),i=gS,r=SS,n=this._GetInstancesInDrawOrder();for(let a=0,o=n.length;a<o;){const h=n[a],l=h.GetWorldInfo();if(!l.IsVisible()||!l.IsInViewport3D(s)){++a;continue}(!h.RendersToOwnZPlane()||l.GetDepth()>0)&&r.push(h);const c=h.GetWorldInfo().GetTotalZElevation();i.push(h);let u=a+1;for(;u<o;++u){const e=n[u],t=e.GetWorldInfo();if(t.IsVisible()&&t.IsInViewport3D(s)){if(t.GetTotalZElevation()!==c)break;e.RendersToOwnZPlane()?(t.GetDepth()>0&&r.push(e),i.push(e)):r.push(e)}}if(1!==i.length||i[0].MustMitigateZFighting()){this._DrawCoplanarInstances_3DCamera(e,i);for(let s=0,i=r.length;s<i;++s){const i=r[s],n=i.GetWorldInfo();n._SetDrawNonBackFacesOnly(!0),this._DrawInstanceMaybeWithEffects(i,n,e,t),n._SetDrawNonBackFacesOnly(!1)}}else{this._DrawInstanceMaybeWithEffects(h,l,e,t);for(let s=0,i=r.length;s<i;++s){const i=r[s];if(i===h)continue;const n=i.GetWorldInfo();n.GetLayer()._DrawInstanceMaybeWithEffects(i,n,e,t)}}a=u,Zg.clearArray(i),Zg.clearArray(r)}}_DrawCoplanarInstances_3DCamera(e,t){const s=this._curRenderTarget;e.CoplanarStartStencilPass();for(let s=0,i=t.length;s<i;++s){const i=t[s],r=i.GetWorldInfo();r._SetDrawBackFaceOnly(!0),this._DrawInstance(i,r,e)}e.CoplanarStartColorPass();for(let i=0,r=t.length;i<r;++i){const r=t[i],n=r.GetWorldInfo();this._DrawInstanceMaybeWithEffects(r,n,e,s),n._SetDrawBackFaceOnly(!1)}e.CoplanarRestoreStandardRendering()}_DrawInstances_RenderCells(e){const t=this._renderGrid,s=this._curRenderCells,i=this._lastRenderCells,r=this.GetViewport();let n;s.set(t.XToCell(r.getLeft()),t.YToCell(r.getTop()),t.XToCell(r.getRight()),t.YToCell(r.getBottom())),this._isRenderListUpToDate&&s.equals(i)?n=this._lastRenderList:(n=this._GetRenderCellInstancesToDraw(),this._isRenderListUpToDate=!0,i.copy(s)),this._DrawInstances(e,n),n!==this._lastRenderList&&Zg.shallowAssignArray(this._lastRenderList,n)}_DrawInstanceMaybeWithEffects(e,t,s,i){t.HasAnyActiveEffect()?this._DrawInstanceWithEffectsAndRestore(e,t,s,i):this._DrawInstance(e,t,s)}_DrawInstance(e,t,s){const i=t.GetRendererStateGroup();s.GetCurrentStateGroup()!==i&&i.Apply(),e.Draw(s)}_DrawInstanceWithEffectsAndRestore(e,t,s,i){this._DrawInstanceWithEffects(e,t,s,i,null)&&this._SetTransform(s)}_DrawInstanceWithEffects(e,t,s,i,r){const n=t.GetInstanceEffectList().GetEffectChain();return n.Render(s,i,{contentObject:e,blendMode:t.GetBlendMode(),devicePixelRatio:this._runtime.GetEffectDevicePixelRatioParam(),time:e.GetInstanceGameTime(),layerScale:this._runtime.GetEffectLayerScaleParam()*this.GetNormalScale(),layerAngle:this.GetAngle(),layoutRect:t.GetBoundingBox(),drawSurfaceRect:n.CanSkipCalculatingDrawSurfaceRect()?null:this._InstanceBoxToDrawSurface(t),drawContentHook:r&&r.drawContentHook,compositOffX:r&&r.compositOffX,compositOffY:r&&r.compositOffY,compositRtWidth:r&&r.compositRtWidth,compositRtHeight:r&&r.compositRtHeight,updateOwnProjection:r&&r.updateOwnProjection}),s.SetBaseZ(this.GetZElevation()),n.DidChangeTransform()}_DrawLayerOwnTextureToRenderTarget(e,t,s,i){const r=this._effectList.GetActiveEffectTypes(),n=this._runtime;0===r.length?(e.SetRenderTarget(s),e.SetTextureFillMode(),i&&0===this._blendMode&&this.HasDefaultColor()?e.CopyRenderTarget(t):(e.SetBlendMode(this._blendMode),e.SetColor(this._premultipliedColor),e.DrawRenderTarget(t)),e.InvalidateRenderTarget(t),n.ReleaseAdditionalRenderTarget(t)):this.GetEffectChain().Render(e,s,{contentObject:this,blendMode:this.GetBlendMode(),devicePixelRatio:n.GetEffectDevicePixelRatioParam(),layerScale:n.GetEffectLayerScaleParam()*this.GetNormalScale(),layerAngle:this.GetAngle(),layoutRect:this.GetViewport(),drawSurfaceRect:null,invalidateRenderTargets:!0})}GetOwnScale(){return this._scale}SetOwnScale(e){this._scale!==e&&(this._scale=e,this._layout.BoundScrolling(),this._SetMVMatrixChanged(),this._runtime.UpdateRender())}GetRenderScale(){return this.GetNormalScale()*this._runtime.GetRenderScale()}GetDisplayScale(){return this.GetNormalScale()*this._runtime.GetDisplayScale()}GetNormalScale(){return(this._scale*this._layout.GetScale()-1)*this._scaleRate+1}_MaybeUpdateViewport(){if(!this._isViewportChanged)return;this._isViewportChanged=!1;const e=this._runtime.GetParallaxXOrigin(),t=this._runtime.GetParallaxYOrigin(),s=(this.GetScrollX()-e)*this._parallaxX+e,i=(this.GetScrollY()-t)*this._parallaxY+t,r=this.GetNormalScale(),n=this._runtime.GetViewportWidth()/r,a=this._runtime.GetViewportHeight()/r;let o=s-n/2,h=i-a/2;this._runtime.IsPixelRoundingEnabled()&&(o=Math.round(o),h=Math.round(h));const l=this._viewportZ0;l.set(o,h,o+n,h+a);const c=this.GetAngle();0!==c&&(eS.copy(l),eS.offset(-l.midX(),-l.midY()),tS.setFromRotatedRect(eS,c),tS.getBoundingBox(eS),eS.offset(l.midX(),l.midY()),l.copy(eS));const u=this._zElevation;this.GetViewportForZ(u,this._viewport),this.Has3DCamera()?this.CalculateViewport3D(u,this._viewport3D):this._viewport3D.copy(this._viewport)}CalculateViewport3D(e,t){const s=this._runtime.GetCanvasManager(),i=s.GetCssWidth(),r=s.GetCssHeight(),[n,a]=this.CanvasCssToLayer(0,0,e),[o,h]=this.CanvasCssToLayer(i,0,e),[l,c]=this.CanvasCssToLayer(i,r,e),[u,d]=this.CanvasCssToLayer(0,r,e);let _=Math.min(n,o,l,u),p=Math.min(a,h,c,d),f=Math.max(n,o,l,u),m=Math.max(a,h,c,d);isFinite(_)||(_=-1/0),isFinite(p)||(p=-1/0),isFinite(f)||(f=1/0),isFinite(m)||(m=1/0),t.set(_,p,f,m)}CanvasCssToLayer(e,t,s=0){return this._CanvasToLayer(e,t,s,this.GetDisplayScale())}DrawSurfaceToLayer(e,t,s=0){return this._CanvasToLayer(e,t,s,this.GetRenderScale()*this.GetDevicePixelRatio())}_CanvasToLayer(e,t,s,i){const r=this._runtime,n=r.GetRenderer(),a=this.GetNormalScale(),o=r.GetViewportWidth()/a,h=r.GetViewportHeight()/a,l=uS;oS.set(l,0,0,o,h),e/=i,t=l[3]-t/i;const c=this._GetProjectionMatrix(n),u=this._GetModelViewMatrix(n),d=cS;return Zg.Gfx.UnprojectScreenToWorldZ(e,t,s,u,c,l,d)?[d[0],d[1]]:[NaN,NaN]}CanvasCssToLayer_DefaultTransform(e,t){const s=this._scale,i=this._scaleRate,r=this._parallaxX,n=this._parallaxY,a=this._angle,o=this.Has3DCamera();o&&this.GetLayout().Set3DCameraEnabled(!1),this._scale=1,this._scaleRate=1,this._parallaxX=1,this._parallaxY=1,this._angle=0,this._SetMVMatrixChanged();const h=this.CanvasCssToLayer(e,t);return this._scale=s,this._scaleRate=i,this._parallaxX=r,this._parallaxY=n,this._angle=a,this._SetMVMatrixChanged(),o&&this.GetLayout().Set3DCameraEnabled(!0),h}LayerToCanvasCss(e,t,s=0){return this._LayerToCanvas(e,t,s,this.GetDisplayScale())}LayerToDrawSurface(e,t,s=0){return this._LayerToCanvas(e,t,s,this.GetRenderScale()*this.GetDevicePixelRatio())}_LayerToCanvas(e,t,s,i){const r=this._runtime,n=r.GetRenderer(),a=this.GetNormalScale(),o=r.GetViewportWidth()/a,h=r.GetViewportHeight()/a,l=uS;oS.set(l,0,0,o,h);const c=this._GetProjectionMatrix(n),u=this._GetModelViewMatrix(n),d=cS;return Zg.Gfx.Project(e,t,s,u,c,l,d)?[d[0]*i,(l[3]-d[1])*i]:[NaN,NaN]}_GetLayerToDrawSurfaceScale(e,t){return e*=this.GetRenderScale()*this.GetDevicePixelRatio(),0!==t&&(e*=this.Get2DScaleFactorToZ(t)),e}_InstanceBoxToDrawSurface(e){const t=e.GetBoundingBox(),s=e.GetTotalZElevation(),i=e.GetDepth(),r=s+i,n=t.getLeft(),a=t.getTop(),o=t.getRight(),h=t.getBottom();if(this.Has3DCamera()){if(this._IsPointBehindNearPlane(n,a,s)||this._IsPointBehindNearPlane(o,a,s)||this._IsPointBehindNearPlane(o,h,s)||this._IsPointBehindNearPlane(n,h,s))return null;if(i>0&&(this._IsPointBehindNearPlane(n,a,r)||this._IsPointBehindNearPlane(o,a,r)||this._IsPointBehindNearPlane(o,h,r)||this._IsPointBehindNearPlane(n,h,r)))return null}else if(r>=this.Get2DCameraZ())return null;let[l,c]=this.LayerToDrawSurface(n,a,s),[u,d]=this.LayerToDrawSurface(o,h,s);if(0!==this.GetAngle()||i>0||this.Has3DCamera()){const[e,t]=this.LayerToDrawSurface(o,a,s),[_,p]=this.LayerToDrawSurface(n,h,s);if(i>0){const[s,i]=this.LayerToDrawSurface(n,a,r),[f,m]=this.LayerToDrawSurface(o,a,r),[g,S]=this.LayerToDrawSurface(o,h,r),[G,y]=this.LayerToDrawSurface(n,h,r);let I=Math.min(l,u,e,_,s,f,g,G);u=Math.max(l,u,e,_,s,f,g,G),l=I,I=Math.min(c,d,t,p,i,m,S,y),d=Math.max(c,d,t,p,i,m,S,y),c=I}else{let s=Math.min(l,u,e,_);u=Math.max(l,u,e,_),l=s,s=Math.min(c,d,t,p),d=Math.max(c,d,t,p),c=s}}return eS.set(l,c,u,d),eS}_GetViewFrustum(){return this._isViewFrustumChanged&&(this._UpdateViewFrustum(),this._isViewFrustumChanged=!1),this._viewFrustum}_UpdateViewFrustum(){const e=this._runtime.GetRenderer(),t=this._GetProjectionMatrix(e),s=this._GetModelViewMatrix(e);this._viewFrustum.CalculatePlanes(s,t)}_IsPointBehindNearPlane(e,t,s){return this._GetViewFrustum().IsBehindNearPlane(e,t,s)}_SaveToJson(){return{d:this.IsDynamic(),s:this.GetOwnScale(),a:this.GetOwnAngle(),v:this._IsVisibleFlagSet(),i:this.IsInteractive(),html:this.IsHTMLElementsLayer(),bc:this._backgroundColor.toJSON(),t:this.IsTransparent(),sx:this._scrollX,sy:this._scrollY,hosp:this._hasOwnScrollPosition,px:this.GetParallaxX(),py:this.GetParallaxY(),c:this._color.toJSON(),sr:this.GetScaleRate(),fx:this._effectList.SaveToJson(),cg:this._createdGlobalUids}}_LoadFromJson(e){this._isDynamic=!!e.d,this._scale=e.s,this._angle=e.a,this._isVisible=!!e.v,this._isInteractive=!e.hasOwnProperty("i")||e.i,this._isHTMLElementsLayer=!!e.html,this._backgroundColor.setFromJSON(e.bc),this._isTransparent=!!e.t,e.hasOwnProperty("sx")&&(this._scrollX=e.sx),e.hasOwnProperty("sy")&&(this._scrollY=e.sy),e.hasOwnProperty("hosp")&&(this._hasOwnScrollPosition=!!e.hosp),this._parallaxX=e.px,this._parallaxY=e.py,this._color.setFromJSON(e.c),this._UpdatePremultipliedColor(),this._scaleRate=e.sr,Zg.shallowAssignArray(this._createdGlobalUids,e.cg),Zg.shallowAssignArray(this._initialInstances,this._startupInitialInstances);const t=new Set(this._createdGlobalUids);let s=0;for(let e=0,i=this._initialInstances.length;e<i;++e)t.has(this._initialInstances[e][2])||(this._initialInstances[s]=this._initialInstances[e],++s);Zg.truncateArray(this._initialInstances,s),this._effectList.LoadFromJson(e.fx),this._needsRebuildEffectChainSteps=!0}_LoadFromJsonAfterInstances(){this._SortInstancesByLastCachedZIndex(!1),this.SetZIndicesChanged(),this._SetMVMatrixChanged(),this._SetProjectionMatrixChanged()}GetILayer(){return this._iLayer}UserScriptDispatcher(){return this._userScriptDispatcher}DispatchUserScriptEvent(e){e.layer=this.GetILayer(),this._userScriptDispatcher.dispatchEvent(e)}SortAndAddInstancesByZIndex(e,t=!1,s=!1){if(this._instances.includes(e))return t&&this._instances.sort((e,t)=>(e.GetWorldInfo().GetSceneGraphZIndex()??0)-(t.GetWorldInfo().GetSceneGraphZIndex()??0)),void(s&&this._instances.forEach((e,t)=>e.GetWorldInfo()._SetZIndex(t)));if(e.HasChildren()){const t=[...e.allChildren()];t.push(e),t.sort((e,t)=>(e.GetWorldInfo().GetSceneGraphZIndex()??0)-(t.GetWorldInfo().GetSceneGraphZIndex()??0));for(const e of t)if(e.IsInContainer())for(const s of e.siblings()){if(t.includes(s))continue;const e=[...s.allChildren()];e.push(s),e.sort((e,t)=>(e.GetWorldInfo().GetSceneGraphZIndex()??0)-(t.GetWorldInfo().GetSceneGraphZIndex()??0)),e&&e.length&&t.splice(t.length,0,...e)}for(const e of t)e.GetPlugin().IsWorldType()&&this._AddInstance(e,!0);s&&this._instances.forEach((e,t)=>e.GetWorldInfo()._SetZIndex(t))}else{if(e.GetPlugin().IsWorldType()&&this._AddInstance(e,!0),!e.IsInContainer())return void(s&&this._instances.forEach((e,t)=>e.GetWorldInfo()._SetZIndex(t)));for(const t of e.siblings()){const e=[...t.allChildren()];if(e.push(t),e.sort((e,t)=>(e.GetWorldInfo().GetSceneGraphZIndex()??0)-(t.GetWorldInfo().GetSceneGraphZIndex()??0)),e&&e.length)for(const t of e)t.GetPlugin().IsWorldType()&&this._AddInstance(t,!0)}s&&this._instances.forEach((e,t)=>e.GetWorldInfo()._SetZIndex(t))}}}}{let CS=function(e,t,s,i){return e[0]===Math.fround(t)&&e[1]===Math.fround(s)&&e[2]===Math.fround(i)},bS=function(e,t){LS!==e&&(e.PrepareForDraw(t),LS=e)};vec3EqualsXYZ=CS,MaybePrepareLayerDraw=bS;const xS=self.C3,wS=self.C3Debugger,PS=self.assert,RS=xS.New(xS.Rect),vS=xS.New(xS.Rect),AS=xS.New(xS.Rect),MS=xS.New(xS.Color),DS=self.glMatrix,ES=DS.vec3,FS=[],OS=[],BS=[],kS=[];let LS=null;xS.Layout=class extends xS.DefendedBase{constructor(e,t,s){super(),this._layoutManager=e,this._runtime=e.GetRuntime(),this._name=s[0],this._originalWidth=s[1],this._originalHeight=s[2],this._width=s[1],this._height=s[2],this._isUnboundedScrolling=!!s[3],this._isOrthographicProjection=!!s[4],this._vanishingPointX=s[5],this._vanishingPointY=s[6],this._eventSheetName=s[7],this._eventSheet=null,this._sid=s[8],this._index=t,this._scrollX=0,this._scrollY=0,this._scale=1,this._angle=0,this._initialObjectClasses=new Set,this._textureLoadedTypes=new Set,this._textureLoadPendingPromises=new Set,this._createdInstances=[],this._createdPersistedInstances=[],this._createdPersistedInstancesToDataMap=new Map,this._createdPersistedIndexToInstanceMap=new Map,this._initialNonWorld=[],this._is3dCameraEnabled=!1,this._cam3dposition=ES.create(),this._cam3dlook=ES.create(),this._cam3dup=ES.create(),this._rootLayers=[],this._allLayersFlat=[],this._layersByName=new Map,this._layersBySid=new Map,this._pendingSetHTMLLayerCount=-1;const i=this._runtime.GetCanvasManager();this._effectList=xS.New(xS.EffectList,this,s[11]),this._effectChain=xS.New(xS.Gfx.EffectChain,i.GetEffectChainManager(),{drawContent:(e,t)=>{const s=t.GetContentObject().GetRenderTarget();e.ResetColor(),e.DrawRenderTarget(s),e.InvalidateRenderTarget(s),i.ReleaseAdditionalRenderTarget(s)},getShaderParameters:e=>this.GetEffectList()._GetEffectChainShaderParametersForIndex(e)}),this._needsRebuildEffectChainSteps=!0,this._wasFullScreenQualityLow=!1,this._curRenderTarget=null,this._persistData={},this._persistedIntances=new Map,this._isFirstVisit=!0,this._iLayout=new self.ILayout(this),this._userScriptDispatcher=xS.New(xS.Event.Dispatcher);for(const e of s[9])this._rootLayers.push(xS.Layer.CreateFromExportData(this,null,e));this._ReindexLayers();for(const e of this.allLayers())e._InitInitialInstances();for(const e of s[10]){const t=this._runtime.GetObjectClassByIndex(e[1]);if(!t)throw new Error("missing nonworld object class");t.GetDefaultInstanceData()||t.SetDefaultInstanceData(e),this._initialNonWorld.push(e),this._AddInitialObjectClass(t)}}Release(){for(const e of this._allLayersFlat)e.Release();xS.clearArray(this._allLayersFlat),this._textureLoadPendingPromises.clear(),this._eventSheet=null,this._layoutManager=null,this._runtime=null}GetRuntime(){return this._runtime}GetName(){return this._name}GetSID(){return this._sid}GetIndex(){return this._index}GetEffectList(){return this._effectList}GetEffectChain(){return this._MaybeRebuildEffectChainSteps(),this._effectChain}_MaybeRebuildEffectChainSteps(){const e="low"===this._runtime.GetCanvasManager().GetCurrentFullscreenScalingQuality();if(!this._needsRebuildEffectChainSteps&&this._wasFullScreenQualityLow===e&&!this._effectChain.NeedsRebuild())return;const t=this.GetEffectList().GetActiveEffectTypes();this._effectChain.BuildSteps(t.map(e=>e.GetShaderProgram()),{indexMap:t.map(e=>e.GetIndex()),forcePostDraw:e,useFullSurface:!0}),this._needsRebuildEffectChainSteps=!1,this._wasFullScreenQualityLow=e}UpdateActiveEffects(){this.GetEffectList().UpdateActiveEffects(),this._needsRebuildEffectChainSteps=!0}GetMinLayerScale(){let e=this._allLayersFlat[0].GetNormalScale();for(let t=1,s=this._allLayersFlat.length;t<s;++t){const s=this._allLayersFlat[t];0===s.GetParallaxX()&&0===s.GetParallaxY()||(e=Math.min(e,s.GetNormalScale()))}return e}_GetScrollBoundMarginHorizontal(){return.5*this._runtime.GetViewportWidth()/this.GetMinLayerScale()}_GetScrollBoundMarginVertical(){return.5*this._runtime.GetViewportHeight()/this.GetMinLayerScale()}GetScrollLeftBound(){return this.IsUnboundedScrolling()?-1/0:this._GetScrollBoundMarginHorizontal()}GetScrollRightBound(){return this.IsUnboundedScrolling()?1/0:this.GetWidth()-this._GetScrollBoundMarginHorizontal()}GetScrollTopBound(){return this.IsUnboundedScrolling()?-1/0:this._GetScrollBoundMarginVertical()}GetScrollBottomBound(){return this.IsUnboundedScrolling()?1/0:this.GetHeight()-this._GetScrollBoundMarginVertical()}SetScrollX(e){const t=this.GetScrollLeftBound(),s=this.GetScrollRightBound();e>s&&(e=s),e<t&&(e=t),this._scrollX!==e&&(this._scrollX=e,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}GetScrollX(){return this._scrollX}SetScrollY(e){const t=this.GetScrollTopBound(),s=this.GetScrollBottomBound();e>s&&(e=s),e<t&&(e=t),this._scrollY!==e&&(this._scrollY=e,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}GetScrollY(){return this._scrollY}IsUnboundedScrolling(){return this._isUnboundedScrolling}BoundScrolling(){this.SetScrollX(this.GetScrollX()),this.SetScrollY(this.GetScrollY());for(const e of this._allLayersFlat)e.IsOwnScrollPositionEnabled()&&(e.SetScrollX(e.GetScrollX()),e.SetScrollY(e.GetScrollY()))}SetVanishingPointXY(e,t){this._vanishingPointX===e&&this._vanishingPointY===t||(this._vanishingPointX=e,this._vanishingPointY=t,this.IsPerspectiveProjection()&&(this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._runtime.UpdateRender()))}GetVanishingPointX(){return this.IsOrthographicProjection()?.5:this._vanishingPointX}GetVanishingPointY(){return this.IsOrthographicProjection()?.5:this._vanishingPointY}GetVanishingPoint(){return[this.GetVanishingPointX(),this.GetVanishingPointY()]}HasVanishingPointOutsideViewport(){const e=this.GetVanishingPointX(),t=this.GetVanishingPointY();return e<0||e>1||t<0||t>1}SetPerspectiveProjection(){this._isOrthographicProjection&&(this._isOrthographicProjection=!1,this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}SetOrthographicProjection(){this._isOrthographicProjection||(this._isOrthographicProjection=!0,this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}IsOrthographicProjection(){return this._isOrthographicProjection}IsPerspectiveProjection(){return!this.IsOrthographicProjection()}Set3DCameraEnabled(e){e=!!e,this._is3dCameraEnabled!==e&&(this._is3dCameraEnabled=e,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}Is3DCameraEnabled(){return this._is3dCameraEnabled}Set3DCameraOrientation(e,t,s,i,r,n,a,o,h){CS(this._cam3dposition,e,t,s)&&CS(this._cam3dlook,i,r,n)&&CS(this._cam3dup,a,o,h)||(ES.set(this._cam3dposition,e,t,s),ES.set(this._cam3dlook,i,r,n),ES.set(this._cam3dup,a,o,h),this.Set3DCameraChanged())}Set3DCameraChanged(){this._SetAllLayersMVChanged(),this._runtime.UpdateRender()}Get3DCameraPosition(){return this._cam3dposition}Get3DCameraLookAt(){return this._cam3dlook}Get3DCameraUpVector(){return this._cam3dup}GetScale(){return this._scale}SetScale(e){this._scale!==e&&(this._scale=e,this._SetAllLayersMVChanged(),this.BoundScrolling(),this._runtime.UpdateRender())}SetAngle(e){e=xS.clampAngle(e),this._angle!==e&&(this._angle=e,this._SetAllLayersMVChanged(),this._runtime.UpdateRender())}GetAngle(){return this._angle}GetWidth(){return this._width}SetWidth(e){!isFinite(e)||e<1||(this._width=e)}GetHeight(){return this._height}SetHeight(e){!isFinite(e)||e<1||(this._height=e)}GetEventSheet(){return this._eventSheet}_GetRootLayers(){return this._rootLayers}*allLayers(){for(const e of this._rootLayers)yield*e.selfAndAllSubLayers()}GetLayers(){return this._allLayersFlat}GetLayerCount(){return this._allLayersFlat.length}GetLayer(e){return"number"==typeof e?this.GetLayerByIndex(e):this.GetLayerByName(e.toString())}GetLayerByIndex(e){return e=xS.clamp(Math.floor(e),0,this._allLayersFlat.length-1),this._allLayersFlat[e]}GetLayerByName(e){return this._layersByName.get(e.toLowerCase())||null}HasLayerByName(e){return!!this.GetLayerByName(e)}GetLayerBySID(e){return this._layersBySid.get(e)||null}_SetAllLayersProjectionChanged(){for(const e of this._allLayersFlat)e._SetProjectionMatrixChanged()}_SetAllLayersMVChanged(){for(const e of this._allLayersFlat)e._SetMVMatrixChanged()}AddLayer(e,t,s){if(this.HasLayerByName(e))throw new Error(`layer name '${e}' already in use`);if(!t&&s<2)throw new Error("invalid insert position");const i=s>=2?t:t.GetParentLayer(),r=xS.New(xS.Layer,this,i,{name:e,sid:Math.floor(1e15*Math.random()),isDynamic:!0});this._InsertLayer(r,t,s),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers()}MoveLayer(e,t,s){if(!t&&s<2)throw new Error("invalid insert position");e===t&&s<2||(this._RemoveLayer(e),this._InsertLayer(e,t,s),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers())}RemoveLayer(e){if(this._RemoveLayer(e)){const t=this._runtime.GetEventSheetManager();t.BlockFlushingInstances(!0),e.Release(),t.BlockFlushingInstances(!1),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers()}}RemoveAllDynamicLayers(){const e=new Set;for(const t of this.allLayers())t.IsDynamic()&&!t.HasAnyDynamicParentLayer()&&e.add(t);if(0===e.size)return;const t=this._runtime.GetEventSheetManager();t.BlockFlushingInstances(!0);for(const t of e)this._RemoveLayer(t),t.Release();t.BlockFlushingInstances(!1),this.GetRuntime().UpdateRender(),this._ReindexAndUpdateAllLayers()}_InsertLayer(e,t,s){if(s>=2)if(t){if(t===e||t.HasParentLayer(e))throw new Error(`cannot move layer '${e.GetName()}' to sub-layer of itself`);t._AddSubLayer(e,2===s),e._SetParentLayer(t)}else 2===s?this._rootLayers.push(e):this._rootLayers.unshift(e),e._SetParentLayer(null);else{const i=t.GetParentLayer();if(i){if(t.HasParentLayer(e))throw new Error(`cannot move layer '${e.GetName()}' to sub-layer of itself`);i._InsertSubLayer(e,t,0===s),e._SetParentLayer(i)}else{let i=this._rootLayers.indexOf(t);if(-1===i)throw new Error("cannot find layer to insert by");0===s&&++i,this._rootLayers.splice(i,0,e),e._SetParentLayer(null)}}}_RemoveLayer(e){const t=e.GetParentLayer();if(t)return t._RemoveSubLayer(e),!0;if(this._rootLayers.length>1){const t=this._rootLayers.indexOf(e);if(-1===t)throw new Error("cannot find layer to remove");return this._rootLayers.splice(t,1),!0}return!1}_ReindexLayers(){this._allLayersFlat=[...this.allLayers()],this._layersByName.clear(),this._layersBySid.clear();for(let e=0,t=this._allLayersFlat.length;e<t;++e){const t=this._allLayersFlat[e];t._SetIndex(e),this._layersByName.set(t.GetName().toLowerCase(),t),this._layersBySid.set(t.GetSID(),t)}}_ReindexHTMLLayers(){let e=0;for(const t of this._rootLayers){for(const s of t.selfAndAllSubLayers())s._SetHTMLIndex(e);t.IsHTMLElementsLayer()&&e++}}GetHTMLLayerCount(){return this._rootLayers.at(-1).GetHTMLIndex()+1}async _ReindexAndUpdateAllLayers(){this._ReindexLayers(),this._ReindexHTMLLayers(),this._pendingSetHTMLLayerCount=this.GetHTMLLayerCount()}_GetPendingSetHTMLLayerCount(){return this._pendingSetHTMLLayerCount}_ResetPendingHTMLLayerCount(){this._pendingSetHTMLLayerCount=-1}GetRootLayersForHTMLLayer(e){const t=[];for(const s of this._rootLayers){const i=s.GetHTMLIndex();if(i===e)t.push(s);else if(i>e)break}return t}SaveTransform(){return{scrollX:this.GetScrollX(),scrollY:this.GetScrollY(),scale:this.GetScale(),angle:this.GetAngle(),vpX:this.GetVanishingPointX(),vpY:this.GetVanishingPointY()}}RestoreTransform(e){this.SetScrollX(e.scrollX),this.SetScrollY(e.scrollY),this.SetScale(e.scale),this.SetAngle(e.angle),this.SetVanishingPointXY(e.vpX,e.vpY)}GetLayoutBackgroundColor(){let e=this._rootLayers.filter(e=>e.ShouldDraw())[0];for(;e;){if(!e.IsTransparent())return MS.copyRgb(e.GetBackgroundColor()),MS.setA(1),MS;if(e.UsesOwnTexture())return MS.setRgba(0,0,0,0),MS;e=e.GetSubLayers().filter(e=>e.ShouldDraw())[0]}return MS.setRgba(0,0,0,0),MS}IsFirstVisit(){return this._isFirstVisit}_GetInitialObjectClasses(){return[...this._initialObjectClasses]}_AddInitialObjectClass(e){if(e.IsInContainer())for(const t of e.GetContainer().GetObjectTypes())this._initialObjectClasses.add(t);else this._initialObjectClasses.add(e)}_GetTextureLoadedObjectTypes(){return[...this._textureLoadedTypes]}_Load(e,t){if(e===this||!t)return Promise.resolve();e&&(xS.CopySet(this._textureLoadedTypes,e._textureLoadedTypes),e._textureLoadedTypes.clear());const s=[];for(const e of this._initialObjectClasses)this._textureLoadedTypes.has(e)||(s.push(e.LoadTextures(t)),this._textureLoadedTypes.add(e));return Promise.all(s)}async MaybeLoadTexturesFor(e){if(e.IsFamily())throw new Error("cannot load textures for family");const t=this._runtime.GetRenderer();if(!t||t.IsContextLost()||this._textureLoadedTypes.has(e))return;this._textureLoadedTypes.add(e);const s=e.LoadTextures(t);this._AddPendingTextureLoadPromise(s),await s,e.OnDynamicTextureLoadComplete(),this._runtime.UpdateRender()}_AddPendingTextureLoadPromise(e){this._textureLoadPendingPromises.add(e),e.then(()=>this._textureLoadPendingPromises.delete(e)).catch(()=>this._textureLoadPendingPromises.delete(e))}WaitForPendingTextureLoadsToComplete(){return Promise.all([...this._textureLoadPendingPromises])}MaybeUnloadTexturesFor(e){if(e.IsFamily()||e.GetInstanceCount()>0)throw new Error("cannot unload textures");const t=this._runtime.GetRenderer();t&&this._textureLoadedTypes.has(e)&&(this._textureLoadedTypes.delete(e),e.ReleaseTextures(t))}_Unload(e,t){if(e!==this&&t)for(const t of this._textureLoadedTypes)t.IsGlobal()||e._initialObjectClasses.has(t)||(t.ReleaseTextures(),this._textureLoadedTypes.delete(t))}_OnRendererContextLost(){this._textureLoadedTypes.clear()}async _StartRunning(e){const t=this._runtime,s=this._layoutManager,i=t.GetEventSheetManager();this._eventSheetName&&(this._eventSheet=i.GetEventSheetByName(this._eventSheetName),this._eventSheet._UpdateDeepIncludes()),s._SetMainRunningLayout(this),this._width=this._originalWidth,this._height=this._originalHeight,this._scrollX=t.GetOriginalViewportWidth()/2,this._scrollY=t.GetOriginalViewportHeight()/2,this.BoundScrolling(),this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged(),this._ReindexHTMLLayers(),await this._runtime.GetCanvasManager().SetHTMLLayerCount(this.GetHTMLLayerCount(),!0),this._MoveGlobalObjectsToThisLayout(e),this._runtime.SetUsingCreatePromises(!0),this._CreateInitialInstances(),this._isFirstVisit||this._CreatePersistedInstances(),this._CreateAndLinkContainerInstances(this._createdInstances),this._CreateAndLinkContainerInstances(this._createdPersistedInstances),this._CreateInitialNonWorldInstances(),s.ClearPendingChangeLayout(),t.FlushPendingInstances(),this._runtime.SetUsingCreatePromises(!1);const r=this._runtime.GetCreatePromises();if(await Promise.all(r),xS.clearArray(r),!t.IsLoadingState()){for(const e of this._createdInstances)e.SetupInitialSceneGraphConnections();for(const e of this._createdPersistedInstances)e.SetupPersistedSceneGraphConnections(this._createdPersistedInstancesToDataMap,this._createdPersistedIndexToInstanceMap);for(const[e,t]of Object.entries(this._persistData)){const s=this._runtime.GetObjectClassBySID(parseInt(e,10));s&&!s.IsFamily()&&s.HasPersistBehavior()&&xS.clearArray(t)}for(const e of this._createdInstances)e._TriggerOnCreated();for(const e of this._createdPersistedInstances)e._TriggerOnCreated();for(const e of this._createdInstances)e.HasParent()||e._OnHierarchyReady();for(const e of this._createdPersistedInstances)e.HasParent()||e._OnHierarchyReady()}xS.clearArray(this._createdInstances),xS.clearArray(this._createdPersistedInstances),this._createdPersistedInstancesToDataMap.clear(),this._createdPersistedIndexToInstanceMap.clear(),await Promise.all([...this._initialObjectClasses].map(e=>e.PreloadTexturesWithInstances(this._runtime.GetRenderer()))),e&&(t.Dispatcher().dispatchEvent(new xS.Event("beforefirstlayoutstart")),await t.DispatchUserScriptEventAsyncWait(new xS.Event("beforeprojectstart"))),await this.DispatchRuntimeUserScriptEventAsyncWait(new xS.Event("beforeanylayoutstart")),t.Dispatcher().dispatchEvent(new xS.Event("beforelayoutstart")),await this.DispatchUserScriptEventAsyncWait(new xS.Event("beforelayoutstart")),t.IsLoadingState()||await t.TriggerAsync(xS.Plugins.System.Cnds.OnLayoutStart,null,null),t.Dispatcher().dispatchEvent(new xS.Event("afterlayoutstart")),await this.DispatchUserScriptEventAsyncWait(new xS.Event("afterlayoutstart")),await this.DispatchRuntimeUserScriptEventAsyncWait(new xS.Event("afteranylayoutstart")),e&&(t.Dispatcher().dispatchEvent(new xS.Event("afterfirstlayoutstart")),await t.DispatchUserScriptEventAsyncWait(new xS.Event("afterprojectstart"))),i._RunQueuedTriggers(s),await this.WaitForPendingTextureLoadsToComplete(),this._isFirstVisit=!1}_MoveGlobalObjectsToThisLayout(e){for(const e of this._runtime.GetAllObjectClasses())if(!e.IsFamily()&&e.IsWorldType())for(const t of e.GetInstances()){const e=t.GetWorldInfo(),s=e.GetLayer(),i=s.GetName(),r=this.GetLayerByName(i);if(r)e._SetLayer(r,!0),r._MaybeAddInstance(t);else{const i=xS.clamp(s.GetIndex(),0,this._allLayersFlat.length-1),r=this._allLayersFlat[i];e._SetLayer(r,!0),r._MaybeAddInstance(t)}}if(!e)for(const e of this._allLayersFlat)e._SortInstancesByLastCachedZIndex(!1)}_CreateInitialInstances(){for(const e of this._allLayersFlat)e.CreateInitialInstances(this._createdInstances),e._Start()}_CreatePersistedInstances(){let e=!1;for(const[t,s]of Object.entries(this._persistData)){const i=this._runtime.GetObjectClassBySID(parseInt(t,10));if(i&&!i.IsFamily()&&i.HasPersistBehavior())for(const t of s){let s=null;if(i.IsWorldType()&&(s=t.hasOwnProperty("instJson")?this.GetLayerBySID(t.instJson.w.l):this.GetLayerBySID(t.w.l),!s))continue;const r=this._runtime.CreateInstanceFromData(i,s,!1,0,0,!0);t.hasOwnProperty("instJson")?r.LoadFromJson(t.instJson):r.LoadFromJson(t),e=!0,this._createdPersistedInstances.push(r),t.hasOwnProperty("instJson")&&(this._createdPersistedInstancesToDataMap.set(r,t),this._createdPersistedIndexToInstanceMap.set(t.index,r))}}for(const e of this._allLayersFlat)e._SortInstancesByLastCachedZIndex(!0),e.SetZIndicesChanged();e&&(this._runtime.FlushPendingInstances(),this._runtime._RefreshUidMap())}_CreateAndLinkContainerInstances(e){for(const t of e){if(!t.IsInContainer())continue;const s=t.GetWorldInfo(),i=t.GetIID();for(const r of t.GetObjectClass().GetContainer().objectTypes()){if(r===t.GetObjectClass())continue;const n=r.GetInstances();if(n.length>i)t._AddSibling(n[i]);else{let i;i=s?this._runtime.CreateInstanceFromData(r,s.GetLayer(),!0,s.GetX(),s.GetY(),!0):this._runtime.CreateInstanceFromData(r,null,!0,0,0,!0),this._runtime.FlushPendingInstances(),r._UpdateIIDs(),t._AddSibling(i),e.push(i)}}}}_CreateInitialNonWorldInstances(){for(const e of this._initialNonWorld)this._runtime.GetObjectClassByIndex(e[1]).IsInContainer()||this._runtime.CreateInstanceFromData(e,null,!0)}_CreateGlobalNonWorlds(){const e=[],t=this._initialNonWorld;let s=0;for(let i=0,r=t.length;i<r;++i){const r=t[i],n=this._runtime.GetObjectClassByIndex(r[1]);n.IsGlobal()?n.IsInContainer()&&n.GetContainer().HasAnyWorldType()||e.push(this._runtime.CreateInstanceFromData(r,null,!0)):(t[s]=r,++s)}xS.truncateArray(t,s),this._runtime.FlushPendingInstances(),this._CreateAndLinkContainerInstances(e)}RecreateInitialObjects(e,t,s,i,r,n,a){if(s)return s.RecreateInitialObjects(e,t,r,n,i,a);{const s=[];for(const o of this._allLayersFlat)s.push(o.RecreateInitialObjects(e,t,r,n,i,a));return s.flat()}}async _StopRunning(){const e=this._layoutManager;this._runtime.IsLoadingState()||(await this.DispatchRuntimeUserScriptEventAsyncWait(new xS.Event("beforeanylayoutend")),await this.DispatchUserScriptEventAsyncWait(new xS.Event("beforelayoutend")),await this._runtime.TriggerAsync(xS.Plugins.System.Cnds.OnLayoutEnd,null,null),await this.DispatchUserScriptEventAsyncWait(new xS.Event("afterlayoutend")),await this.DispatchRuntimeUserScriptEventAsyncWait(new xS.Event("afteranylayoutend"))),e.SetIsEndingLayout(!0),this._runtime.GetEventSheetManager().ClearAllScheduledWaits(),this._isFirstVisit||this._SavePersistData();for(const e of this._allLayersFlat)e._End();for(const e of this._runtime.GetAllObjectClasses())if(!(e.IsGlobal()||e.IsWorldType()||e.GetPlugin().IsSingleGlobal()||e.IsFamily())){for(const t of e.GetInstances())this._runtime.DestroyInstance(t);this._runtime.FlushPendingInstances()}e.SetIsEndingLayout(!1),e.GetMainRunningLayout()===this&&e._SetMainRunningLayout(null)}_SaveInstanceToPersist(e,t){const s=e.GetObjectClass().GetSID().toString();this._persistData.hasOwnProperty(s)||(this._persistData[s]=[]);const i=this._persistData[s],r={index:t,instJson:e.SaveToJson(),sceneGraphJson:{children:[]}};i.push(r),this._persistedIntances.set(e,r)}_SaveSceneGraphInfoToPersist(e){const t=this._persistedIntances.get(e);for(const s of e.GetChildren()){const e=this._persistedIntances.get(s);e&&t.sceneGraphJson.children.push({index:e.index,flags:xS.SceneGraphInfo._GetFlagsNumber(s.GetWorldInfo())})}}_SavePersistData(){this._persistedIntances.clear();let e=0;for(const t of this._allLayersFlat){t._UpdateZIndices();for(const s of t._GetInstances()){const t=s.GetObjectClass();!t.IsGlobal()&&t.HasPersistBehavior()&&(this._SaveInstanceToPersist(s,e),e++)}}for(const e of this._allLayersFlat)for(const t of e._GetInstances()){const e=t.GetObjectClass();!e.IsGlobal()&&e.HasPersistBehavior()&&this._SaveSceneGraphInfoToPersist(t)}this._persistedIntances.clear()}ResetPersistData(){this._persistData={},this._isFirstVisit=!0}GetRenderTarget(){return this._curRenderTarget}UsesOwnTexture(){const e=this._runtime,t=e.GetRenderer().IsWebGL();return"low"===e.GetCanvasManager().GetCurrentFullscreenScalingQuality()||t&&e.UsesAnyBackgroundBlending()||this._effectList.HasAnyActiveEffect()||t&&e.Uses3DFeatures()}_MaybeStartDrawToOwnTexture(e){const t=this._runtime.GetCanvasManager();if(this.UsesOwnTexture()){e.SetRenderTarget(null),e.ClearRgba(0,0,0,0);const s={sampling:this._runtime.GetSampling(),isSampled:e.IsWebGPU()||this._runtime.UsesAnyBackgroundBlending()||this._effectList.HasAnyActiveEffect(),canReadPixels:!!e.IsWebGPU()&&this._runtime.UsesAnyBackgroundBlending()};"low"===t.GetCurrentFullscreenScalingQuality()&&(s.width=t.GetDrawWidth(),s.height=t.GetDrawHeight()),this._curRenderTarget=this._runtime.GetAdditionalRenderTarget(s)}else this._curRenderTarget=null}_MaybeCopyOwnTextureToBackbuffer(e){this._runtime._NeedsHTMLLayerCompositing(e)&&(e.SetDepthEnabled(!1),e.SetRenderTarget(null),e.SetTextureFillMode(),e.CopyRenderTarget(this._curRenderTarget))}_MaybeEndDrawToOwnTexture(e){this.UsesOwnTexture()&&(e.SetDepthEnabled(!1),this._DrawLayoutOwnTextureToRenderTarget(e,this._curRenderTarget))}DrawMain(e){e.SetRenderTarget(this._curRenderTarget),e.Clear(this.GetLayoutBackgroundColor()),this._runtime.Uses3DFeatures()&&e.ClearDepth();const t=this.GetRootLayersForHTMLLayer(0);this._DrawLayerList(e,this._curRenderTarget,t,!0),e.IsWebGPU()&&e.StartMeasuringRenderPassTime(0,1),this._MaybeEndDrawToOwnTexture(e),this._curRenderTarget=null}DrawForHTMLLayerIndex(e,t){let s=null;this._runtime._NeedsHTMLLayerCompositing(e)&&(s=this._curRenderTarget),e.SetRenderTarget(s),e.ClearRgba(0,0,0,0),this._runtime.Uses3DFeatures()&&e.ClearDepth();const i=this.GetRootLayersForHTMLLayer(t);this._DrawLayerList(e,s,i,!0),this._MaybeCopyOwnTextureToBackbuffer(e),e.EndBatch(),this._runtime.GetCanvasManager().BlitMainCanvasToHTMLLayerCanvas(t)}_DrawLayerList(e,t,s,i){const r=s.filter(e=>e.ShouldDraw());for(let s=0,n=r.length;s<n;){const a=r[s];if(a.SelfAndAllSubLayersHave3DCamera()&&!a.SelfOrAnySubLayerUsesOwnTexture()){FS.push(a);for(let e=s+1;e<n;++e){const t=r[e];if(!t.SelfAndAllSubLayersHave3DCamera()||t.SelfOrAnySubLayerUsesOwnTexture())break;FS.push(r[e])}if(FS.length>=2||1===FS.length&&FS[0].HasAnyVisibleSubLayer()){this._Draw3DLayers(e,t,FS),s+=FS.length,xS.clearArray(FS);continue}xS.clearArray(FS)}a.Draw(e,t,i&&0===s),++s}}_DrawLayoutOwnTextureToRenderTarget(e,t){const s=this._effectList.GetActiveEffectTypes(),i=this._runtime;0===s.length?(e.SetRenderTarget(null),e.SetTextureFillMode(),e.CopyRenderTarget(t),e.InvalidateRenderTarget(t),i.ReleaseAdditionalRenderTarget(t)):(AS.set(0,0,i.GetViewportWidth(),i.GetViewportHeight()),this.GetEffectChain().Render(e,null,{contentObject:this,blendMode:3,devicePixelRatio:this._runtime.GetEffectDevicePixelRatioParam(),layerScale:this._runtime.GetEffectLayerScaleParam()*this.GetScale(),layerAngle:this.GetAngle(),layoutRect:AS,drawSurfaceRect:null,invalidateRenderTargets:!0}))}_Draw3DLayers(e,t,s){const i=s[0],r=i._MaybeStartWebGLProfiling(e);i._MaybeStartWebGPUProfiling(e),s[0].IsTransparent()||(MS.copyRgb(s[0].GetBackgroundColor()),MS.setA(1),e.Clear(MS)),e.SetDepthEnabled(!0);const n=OS,a=BS,o=kS;for(const t of s)t._UpdateZIndices(),t._AppendAllInstancesIncludingSubLayersInDrawOrder(n),t._FireDrawEvent(e,"beforedraw");for(let s=0,i=n.length;s<i;){const r=n[s],h=r.GetWorldInfo(),l=h.GetLayer();if(!h.IsVisible()||!h.IsInViewport3D(l._GetViewFrustum())){++s;continue}(!r.RendersToOwnZPlane()||h.GetDepth()>0)&&o.push(r);const c=r.GetWorldInfo().GetTotalZElevation();a.push(r);let u=s+1;for(;u<i;++u){const e=n[u],t=e.GetWorldInfo();if(t.IsVisible()&&t.IsInViewport3D(t.GetLayer()._GetViewFrustum())){if(t.GetTotalZElevation()!==c)break;e.RendersToOwnZPlane()?(t.GetDepth()>0&&o.push(e),a.push(e)):o.push(e)}}if(1!==a.length||a[0].MustMitigateZFighting()){this._Draw3DLayersCoplanarInstances(e,t,a);for(let s=0,i=o.length;s<i;++s){const i=o[s],r=i.GetWorldInfo(),n=r.GetLayer();r._SetDrawNonBackFacesOnly(!0),bS(n,e),n._DrawInstanceMaybeWithEffects(i,r,e,t),r._SetDrawNonBackFacesOnly(!1)}}else{bS(l,e),l._DrawInstanceMaybeWithEffects(r,h,e,t);for(let s=0,i=o.length;s<i;++s){const i=o[s];if(i===r)continue;const n=i.GetWorldInfo(),a=n.GetLayer();bS(a,e),a._DrawInstanceMaybeWithEffects(i,n,e,t)}}s=u,xS.clearArray(a),xS.clearArray(o)}for(const t of s)t._FireDrawEvent(e,"afterdraw");r&&e.EndQuery(r),xS.clearArray(n),LS=null}_Draw3DLayersCoplanarInstances(e,t,s){e.CoplanarStartStencilPass();for(let t=0,i=s.length;t<i;++t){const i=s[t],r=i.GetWorldInfo(),n=r.GetLayer();r._SetDrawBackFaceOnly(!0),bS(n,e),n._DrawInstance(i,r,e)}e.CoplanarStartColorPass();for(let i=0,r=s.length;i<r;++i){const r=s[i],n=r.GetWorldInfo(),a=n.GetLayer();bS(a,e),a._DrawInstanceMaybeWithEffects(r,n,e,t),n._SetDrawBackFaceOnly(!1)}e.CoplanarRestoreStandardRendering()}_SaveToJson(){const e={sx:this.GetScrollX(),sy:this.GetScrollY(),s:this.GetScale(),a:this.GetAngle(),w:this.GetWidth(),h:this.GetHeight(),ortho:this.IsOrthographicProjection(),vpX:this.GetVanishingPointX(),vpY:this.GetVanishingPointY(),fv:this._isFirstVisit,persist:this._persistData,fx:this._effectList.SaveToJson(),layers:{},dynamicLayers:[]};for(const t of this._allLayersFlat)if(t.IsDynamic()){const s=t.GetParentLayer();e.dynamicLayers.push({sid:t.GetSID(),name:t.GetName(),parentSid:s?s.GetSID():null,siblingIndex:t._GetSiblingIndex(),data:t._SaveToJson()})}else e.layers[t.GetSID().toString()]=t._SaveToJson();return e}_LoadFromJson(e){this._scrollX=e.sx,this._scrollY=e.sy,this._scale=e.s,this._angle=e.a,this._width=e.w,this._height=e.h,this._isOrthographicProjection=!!e.ortho,e.hasOwnProperty("vpX")&&(this._vanishingPointX=e.vpX),e.hasOwnProperty("vpY")&&(this._vanishingPointY=e.vpY),this._isFirstVisit=!!e.fv,this._persistData=e.persist,this._effectList.LoadFromJson(e.fx),this._needsRebuildEffectChainSteps=!0;for(const[t,s]of Object.entries(e.layers)){const e=parseInt(t,10),i=this.GetLayerBySID(e);i&&i._LoadFromJson(s)}if(e.hasOwnProperty("dynamicLayers")){this.RemoveAllDynamicLayers(),this._runtime.FlushPendingInstances();const t=new Map,s=e.dynamicLayers;for(let e=s.length-1;e>=0;--e){const i=s[e],r=i.sid,n=i.name,a=i.parentSid,o=i.siblingIndex,h=i.data;if(this._ReindexLayers(),this.HasLayerByName(n)||this.GetLayerBySID(r))continue;let l,c;if(null===a)l=null,c=this._rootLayers;else{if(l=this.GetLayerBySID(a),!l)continue;c=l.GetSubLayers()}const u=xS.New(xS.Layer,this,l,{name:n,sid:r,isDynamic:!0});c.push(u);let d=t.get(c);d||(d=[],t.set(c,d)),d.push({layer:u,siblingIndex:o}),u._LoadFromJson(h)}for(const[e,s]of t){s.sort((e,t)=>e.siblingIndex-t.siblingIndex);for(const t of s){const s=t.layer,i=t.siblingIndex;let r=e.indexOf(s);e.splice(r,1),e.splice(i,0,s)}}}this._ReindexAndUpdateAllLayers(),this._SetAllLayersProjectionChanged(),this._SetAllLayersMVChanged()}GetILayout(){return this._iLayout}UserScriptDispatcher(){return this._userScriptDispatcher}DispatchUserScriptEvent(e){e.layout=this.GetILayout();const t=this._runtime,s=t.IsDebug()&&!t.GetEventSheetManager().IsInEventEngine();s&&wS.StartMeasuringScriptTime(),this._userScriptDispatcher.dispatchEvent(e),s&&wS.AddScriptTime()}DispatchUserScriptEventAsyncWait(e){return e.layout=this.GetILayout(),this._userScriptDispatcher.dispatchEventAndWaitAsync(e)}DispatchRuntimeUserScriptEventAsyncWait(e){return e.layout=this.GetILayout(),this._runtime.DispatchUserScriptEventAsyncWait(e)}_LogLayerTree(){this._LogLayerList(this._rootLayers)}_LogLayerList(e,t=0){const s=e.slice(0);s.reverse();for(const e of s)console.log(`${"\t".repeat(t)}- ${e.GetName()}`),this._LogLayerList(e.GetSubLayers(),t+1)}}}{const NS=self.C3;NS.LayoutManager=class extends NS.DefendedBase{#s;#n=[];#d=new Map;#h=new Map;#i=null;#e=[];#t=null;#o=0;#I=null;constructor(e){super(),this.#s=e}Release(){this.#s=null,this.#i=null,this.#t=null,this.#I=null,NS.clearArray(this.#n),this.#d.clear(),this.#h.clear(),NS.clearArray(this.#e)}Create(e){const t=NS.New(NS.Layout,this,this.#n.length,e);this.#n.push(t),this.#d.set(t.GetName().toLowerCase(),t),this.#h.set(t.GetSID(),t)}GetRuntime(){return this.#s}SetFirstLayout(e){this.#t=e}GetFirstLayout(){if(this.#t)return this.#t;if(this.#n.length)return this.#n[0];throw new Error("no first layout")}GetLayoutByName(e){return this.#d.get(e.toLowerCase())||null}GetLayoutBySID(e){return this.#h.get(e)||null}GetLayoutByIndex(e){return e=NS.clamp(Math.floor(e),0,this.#n.length-1),this.#n[e]}GetLayout(e){return"number"==typeof e?this.GetLayoutByIndex(e):this.GetLayoutByName(e.toString())}GetAllLayouts(){return this.#n}_SetMainRunningLayout(e){this.#i=e}GetMainRunningLayout(){return this.#i}_AddRunningSubLayout(e){if(this.#e.includes(e))throw new Error("layout already running");this.#e.push(e)}_RemoveRunningSubLayout(e){const t=this.#e.indexOf(e);if(-1===t)throw new Error("layout not running");this.#e.splice(t,1)}*runningLayouts(){this.#i&&(yield this.#i),this.#e.length&&(yield*this.#e)}IsLayoutRunning(e){return this.#i===e||this.#e.includes(e)}SetIsEndingLayout(e){if(e)this.#o++;else{if(this.#o<=0)throw new Error("already unset");this.#o--}}IsEndingLayout(){return this.#o>0}ChangeMainLayout(e){this.#I=e}ClearPendingChangeLayout(){this.#I=null}IsPendingChangeMainLayout(){return!!this.#I}GetPendingChangeMainLayout(){return this.#I}SetAllLayerProjectionChanged(){const e=this.GetMainRunningLayout();e&&e._SetAllLayersProjectionChanged()}SetAllLayerMVChanged(){const e=this.GetMainRunningLayout();e&&e._SetAllLayersMVChanged()}}}{const WS=self.C3,US=new RegExp("<(.+?)>","g");WS.TimelineManager=class extends WS.DefendedBase{constructor(e){super(),this._runtime=e,this._timelineDataManager=WS.New(WS.TimelineDataManager),this._pluginInstance=null,this._timelines=[],this._timelinesByName=new Map,this._objectClassToTimelineMap=new Map,this._timelinesCreatedByTemplate=new Map,this._scheduledTimelines=[],this._playingTimelines=[],this._markedForRemovalTimelines=[],this._hasRuntimeListeners=!1,this._changingLayout=!1,this._isTickingTimelines=!1,this._tickFunc=()=>this._OnTick(),this._tick2Func=()=>this._OnTick2(),this._beforeLayoutChange=()=>this._OnBeforeChangeLayout(),this._layoutChange=()=>this._OnAfterChangeLayout(),this._instanceDestroy=e=>this._OnInstanceDestroy(e.instance),this._beforeLoad=e=>this._OnBeforeLoad(),this._afterLoad=e=>this._OnAfterLoad(),this._afterLayoutStart=e=>this._OnAfterLayoutStart(),this._destroyedWhileLoadingState=[],this._renderChange=0}Release(){this.RemoveRuntimeListeners(),this._tickFunc=null,this._tick2Func=null,this._beforeLayoutChange=null,this._layoutChange=null,this._instanceDestroy=null,this._afterLoad=null;for(const e of this._timelines)e.Stop(),e.Release();WS.clearArray(this._timelines),this._timelines=null,this._timelineDataManager.Release(),this._timelineDataManager=null,WS.clearArray(this._scheduledTimelines),this._scheduledTimelines=null,WS.clearArray(this._playingTimelines),this._playingTimelines=null,WS.clearArray(this._markedForRemovalTimelines),this._markedForRemovalTimelines=null,this._timelinesByName.clear(),this._timelinesByName=null,this._objectClassToTimelineMap.clear(),this._objectClassToTimelineMap=null,this._timelinesCreatedByTemplate.clear(),this._timelinesCreatedByTemplate=null,WS.clearArray(this._destroyedWhileLoadingState),this._destroyedWhileLoadingState=null,this._runtime=null}AddRuntimeListeners(){const e=this._runtime.Dispatcher();e.addEventListener("pretick",this._tickFunc),e.addEventListener("tick2",this._tick2Func),e.addEventListener("beforelayoutchange",this._beforeLayoutChange),e.addEventListener("layoutchange",this._layoutChange),e.addEventListener("instancedestroy",this._instanceDestroy),e.addEventListener("beforeload",this._beforeLoad),e.addEventListener("afterload",this._afterLoad),e.addEventListener("afterlayoutstart",this._afterLayoutStart)}RemoveRuntimeListeners(){const e=this._runtime.Dispatcher();e.removeEventListener("pretick",this._tickFunc),e.removeEventListener("tick2",this._tick2Func),e.removeEventListener("beforelayoutchange",this._beforeLayoutChange),e.removeEventListener("layoutchange",this._layoutChange),e.removeEventListener("instancedestroy",this._instanceDestroy),e.removeEventListener("beforeload",this._beforeLoad),e.removeEventListener("afterload",this._afterLoad),e.removeEventListener("afterlayoutstart",this._afterLayoutStart)}Create(e){this._timelineDataManager.Add(e);const t=WS.TimelineState.CreateInitial(e,this);this.Add(t),this.SetTimelineObjectClassesToMap(t),this._timelinesCreatedByTemplate.set(t.GetName(),0)}CreateFromTemplate(e){const t=this.GetTimelineDataManager(),s=e.GetTemplateName(),i=t.Get(s),r=WS.TimelineState.CreateFromTemplate(`${s}:${this._timelinesCreatedByTemplate.get(s)}`,i,this);return this._IncreaseTemplateTimelinesCount(s),this.Add(r),this._runtime.IsDebug()&&globalThis.C3Debugger.TimelineCreated(r),r}GetCreatedTemplateTimelinesCount(e){return this._timelinesCreatedByTemplate.get(e)}_IncreaseTemplateTimelinesCount(e){this._timelinesCreatedByTemplate.set(e,this._timelinesCreatedByTemplate.get(e)+1)}_SetCreatedTemplateTimelinesCount(){for(const e of this._timelines){if(e.IsTemplate())continue;const t=e.GetTemplateName();this._IncreaseTemplateTimelinesCount(t)}}_ClearCreatedTemplateTimelinesCount(){for(const e of this._timelinesCreatedByTemplate.keys())this._timelinesCreatedByTemplate.set(e,0)}Add(e){this._timelines.push(e),this._timelinesByName.set(e.GetName().toLowerCase(),e)}Remove(e){e.Removed(),e.IsTemplate()||(WS.arrayFindRemove(this._timelines,e),WS.arrayFindRemove(this._scheduledTimelines,e),WS.arrayFindRemove(this._playingTimelines,e),WS.arrayFindRemove(this._markedForRemovalTimelines,e),this._timelinesByName.delete(e.GetName().toLowerCase()),this.RemoveTimelineFromObjectClassMap(e),this._runtime.IsDebug()&&globalThis.C3Debugger.TimelineDestroyed(e),e.IsReleased()||e.Release())}Trigger(e){this._runtime.Trigger(e,this._pluginInstance,null)}GetRuntime(){return this._runtime}GetTimelineDataManager(){return this._timelineDataManager}SetPluginInstance(e){this._pluginInstance=e}GetPluginInstance(){return this._pluginInstance}*GetTimelines(){for(const e of this._timelines)yield e}*GetPlayingTimelines(){for(const e of this._playingTimelines)yield e}SetTimelineObjectClassToMap(e,t){this._objectClassToTimelineMap.has(e)||this._objectClassToTimelineMap.set(e,new Set),this._objectClassToTimelineMap.get(e).add(t)}SetTimelineObjectClassesToMap(e){for(const t of e.GetObjectClasses())this.SetTimelineObjectClassToMap(t,e)}RemoveTimelineFromObjectClassMap(e){for(const[t,s]of this._objectClassToTimelineMap.entries())s.has(e)&&(s.delete(e),0===s.size&&this._objectClassToTimelineMap.delete(t))}GetTimelinesForObjectClass(e){if(this._objectClassToTimelineMap.has(e))return this._objectClassToTimelineMap.get(e)}GetTimelineOfTemplateForInstances(e,t){if(t)for(const s of this._timelines)if(t.every(e=>s.HasTrackInstance(e.instance,e.trackId))&&s.GetName().includes(e.GetName()))return s}GetTimelineByName(e){return this._timelinesByName.get(e.toLowerCase())||null}GetScheduledOrPlayingTimelineByName(e){for(const t of this._scheduledTimelines)if(t.GetName()===e)return t;for(const t of this._playingTimelines)if(t.GetName()===e)return t;return null}*GetTimelinesByName(e){if(US.test(e)){let t;US.lastIndex=0;const s=new Set;do{if(t=US.exec(e),t){const e=t[1].split(",");for(const t of e)s.add(t)}}while(t);for(const e of s.values()){const t=this.GetTimelineByName(e);t&&(yield t)}s.clear()}else{const t=this.GetTimelineByName(e);t&&(yield t)}}*GetTimelinesByTags(e){for(const t of this._timelines)t.HasTags(e)&&(yield t)}AddScheduledTimeline(e){this._scheduledTimelines.includes(e)||this._scheduledTimelines.push(e),this._MaybeEnableRuntimeListeners()}RemovePlayingTimeline(e){WS.arrayFindRemove(this._playingTimelines,e),this._MaybeDisableRuntimeListeners()}ScheduleTimeline(e){this._playingTimelines.includes(e)?(e.SetPlaying(!0),e.SetScheduled(!1),e.SetMarkedForRemoval(!1)):(e.SetPlaying(!1),e.SetScheduled(!0),e.SetMarkedForRemoval(!1),this._scheduledTimelines.includes(e)||this._scheduledTimelines.push(e)),this._MaybeEnableRuntimeListeners()}DeScheduleTimeline(e){e.SetPlaying(!1),e.SetScheduled(!1),e.ResolvePlayPromise(),WS.arrayFindRemove(this._scheduledTimelines,e),this._MaybeDisableRuntimeListeners()}CompleteTimeline(e){e.SetPlaying(!1),e.SetScheduled(!1),this._playingTimelines.includes(e)&&(e.SetMarkedForRemoval(!0),this._markedForRemovalTimelines.push(e),WS.arrayFindRemove(this._playingTimelines,e)),this._scheduledTimelines.includes(e)&&e.SetMarkedForRemoval(!0)}CompleteTimelineBeforeChangeOfLayout(e){e.SetPlaying(!1),e.SetScheduled(!1),e.SetMarkedForRemoval(!1),e.SetPlaybackRate(1),WS.arrayFindRemove(this._playingTimelines,e)}CompleteTimelineAndResolve(e){this.CompleteTimeline(e),e.ResolvePlayPromise()}_OnTick(){const e=this.GetRuntime();if(e.IsLoadingState())return;if(!this._hasRuntimeListeners)return;if(this._changingLayout)return;let t=0;for(e.IsDebug()&&(t=performance.now()),this._isTickingTimelines=!0;this._scheduledTimelines.length;){const e=this._scheduledTimelines.pop();e.IsMarkedForRemoval()?(e.SetInitialStateForce(),this._markedForRemovalTimelines.push(e)):(e.SetInitialState(),this._playingTimelines.push(e)),0!==e.GetRenderChange()&&(this._renderChange=1)}const s=this._runtime._GetDtFast(),i=this._runtime.GetDt1(),r=this._runtime.GetTimeScale();for(let e=this._playingTimelines.length-1;e>=0;e--){const t=this._playingTimelines[e];t&&t.Tick(s,r,i)}this._isTickingTimelines=!1,e.IsDebug()&&globalThis.C3Debugger.AddTweensAndTimelinesTime(performance.now()-t),0!==this._renderChange&&e.UpdateRender()}_OnTick2(){const e=this.GetRuntime();if(e.IsLoadingState())return;if(!this._hasRuntimeListeners)return;if(this._changingLayout)return;let t,s=0;e.IsDebug()&&(s=performance.now());for(let e=0,s=this._markedForRemovalTimelines.length;e<s;e++){const s=this._markedForRemovalTimelines[e];t||(t=new Set),s.Removed(),this._MaybeExecuteTimelineFinishTriggers(s),t.add(s)}if(t){WS.arrayRemoveAllInSet(this._markedForRemovalTimelines,t),this._renderChange=0;for(let e=0,t=this._playingTimelines.length;e<t;e++)if(0!==this._playingTimelines[e].GetRenderChange()){this._renderChange=1;break}}this._MaybeDisableRuntimeListeners(),e.IsDebug()&&globalThis.C3Debugger.AddTweensAndTimelinesTime(performance.now()-s)}_MaybeExecuteTimelineFinishTriggers(e){e.IsReleased()||e.HasValidTracks()&&e.IsComplete()&&e.InitialStateSet()&&e.FinishTriggers()}_MaybeEnableRuntimeListeners(){this._hasRuntimeListeners||(this._hasRuntimeListeners=!0)}_MaybeDisableRuntimeListeners(){this._markedForRemovalTimelines.length||this._playingTimelines.length||this._scheduledTimelines.length||this._isTickingTimelines||(this._hasRuntimeListeners=!1)}_OnBeforeChangeLayout(){for(this._changingLayout=!0;this._scheduledTimelines.length;)this.DeScheduleTimeline(this._scheduledTimelines.pop());const e=new Set;for(const t of this._playingTimelines)t._OnBeforeChangeLayout()&&(t.Removed(),e.add(t));WS.arrayRemoveAllInSet(this._playingTimelines,e),e.clear();for(const t of this._markedForRemovalTimelines)t._OnBeforeChangeLayout()&&(t.Removed(),e.add(t));WS.arrayRemoveAllInSet(this._markedForRemovalTimelines,e),this._MaybeDisableRuntimeListeners();for(const e of this._timelines)e.CleanCaches()}_OnAfterChangeLayout(){this._changingLayout=!1}_OnInstanceDestroy(e){const t=e.GetObjectClass(),s=this.GetTimelinesForObjectClass(t);if(s)if(this._runtime.IsLoadingState())this._destroyedWhileLoadingState.push(e);else for(const e of s)e.IsTemplate()||(e.IsReleased()?this.Remove(e):e.HasValidTracks()||(this._MaybeExecuteTimelineFinishTriggers(e),this.Remove(e)))}_OnBeforeLoad(){for(const e of this._scheduledTimelines.map(e=>e))this._MaybeExecuteTimelineFinishTriggers(e),this.Remove(e);for(const e of this._playingTimelines.map(e=>e))this._MaybeExecuteTimelineFinishTriggers(e),this.Remove(e)}_OnAfterLoad(){for(const e of this._destroyedWhileLoadingState)this._OnInstanceDestroy(e);WS.clearArray(this._destroyedWhileLoadingState);for(const e of this._timelines)e._OnAfterLoad()}_OnAfterLayoutStart(){const e=this._runtime.GetLayoutManager().GetMainRunningLayout();if(e)for(const t of this._timelines){const s=t.GetStartOnLayout();s&&e.GetName()===s&&this.ScheduleTimeline(t)}}_SaveToJson(){return{timelinesJson:this._SaveTimelinesToJson(),scheduledTimelinesJson:this._SaveScheduledTimelinesToJson(),playingTimelinesJson:this._SavePlayingTimelinesToJson(),markedForRemovalTimelinesJson:this._SaveMarkedForRemovalTimelinesToJson(),hasRuntimeListeners:this._hasRuntimeListeners,changingLayout:this._changingLayout,isTickingTimelines:this._isTickingTimelines}}_LoadFromJson(e){e&&(this._ClearCreatedTemplateTimelinesCount(),this._LoadTimelinesFromJson(e.timelinesJson),this._LoadScheduledTimelinesFromJson(e.scheduledTimelinesJson),this._LoadPlayingTimelinesFromJson(e.playingTimelinesJson),this._LoadMarkedForRemovalTimelinesFromJson(e.markedForRemovalTimelinesJson),this._hasRuntimeListeners=!e.hasRuntimeListeners,this._changingLayout=!!e.changingLayout,this._isTickingTimelines=!!e.isTickingTimelines,this._SetCreatedTemplateTimelinesCount(),this._MaybeEnableRuntimeListeners(),this._MaybeDisableRuntimeListeners())}_SaveTimelinesToJson(){return this._timelines.map(e=>e._SaveToJson())}_LoadTimelinesFromJson(e){for(const t of e){let e=this.GetTimelineByName(t.name);if(e)e._LoadFromJson(t);else{const s=this._GetTemplateNameFromJson(t);if(!s)continue;const i=this.GetTimelineByName(s);e=this.CreateFromTemplate(i),e._LoadFromJson(t)}e.HasTracks()||this.Remove(e)}}_GetTemplateNameFromJson(e){const t=e.name.split(":");return t&&2===t.length?t[0]:null}_SaveScheduledTimelinesToJson(){return this._SaveTimelines(this._scheduledTimelines)}_LoadScheduledTimelinesFromJson(e){this._LoadTimelines(e,this._scheduledTimelines)}_SavePlayingTimelinesToJson(){return this._SaveTimelines(this._playingTimelines)}_LoadPlayingTimelinesFromJson(e){this._LoadTimelines(e,this._playingTimelines)}_SaveMarkedForRemovalTimelinesToJson(){return this._SaveTimelines(this._markedForRemovalTimelines)}_LoadMarkedForRemovalTimelinesFromJson(e){this._LoadTimelines(e,this._markedForRemovalTimelines)}_IsTimelineInJson(e,t){if(!t)return!1;for(const s of t)if(s===e.GetName())return!0;return!1}_SaveTimelines(e){return e.map(e=>e.GetName())}_LoadTimelines(e,t){const s=new Set;for(const i of t)this._IsTimelineInJson(i,e)||s.add(i);if(WS.arrayRemoveAllInSet(t,s),e){const s=e=>t=>t.GetName()===e;for(const i of e){const e=this.GetTimelineByName(i);e&&(t.find(s(i))||t.push(e))}}}}}{const VS=self.C3,HS=100,jS=.01,zS=25,XS=20,YS=5,qS=[0,0],KS=[0,0],$S=[0,0],JS=[0,0,0,0,0],ZS=new Array(4),QS=[{x:0,y:0,t:0,distance:0},{x:0,y:0,t:0,distance:0},{x:0,y:0,t:0,distance:0}],eG={x:0,y:0,t:0,distance:0};VS.TimelineInfo=class{constructor(e,t){this._initialized=!1,this._timeline=e,this._segments=[];let s=null;if(s=t?this._timeline.GetTrackById(t):VS.first(this._timeline.GetTracks()),!s)return;const i=s.GetPropertyTrack("offsetX"),r=s.GetPropertyTrack("offsetY");if(!i||!r)return;this._xTrack=i,this._yTrack=r;const n=i.GetPropertyKeyframeDataItemArrayIncludingDisabled(),a=r.GetPropertyKeyframeDataItemArrayIncludingDisabled();for(let e=1,t=Math.min(n.length,a.length);e<t;++e){const t=n[e],s=(t.GetNext(),t.GetPrevious()),i=a[e],r=(i.GetNext(),i.GetPrevious());s&&"cubic-bezier"===s.GetPathMode()&&r&&"cubic-bezier"===r.GetPathMode()?this._segments.push(VS.New(VS.TimelineCubicBezierSegmentInfo,s,r,t,i,this._segments.length)):(s&&"line"===s.GetPathMode()&&r&&r.GetPathMode(),this._segments.push(VS.New(VS.TimelineLineSegmentInfo,t,i,this._segments.length)))}this._initialized=!0}Release(){for(const e of this._segments)e.Release();VS.clearArray(this._segments),this._segments=null,this._timeline=null,this._xTrack=null,this._yTrack=null}WasInitialized(){return this._initialized}segments(){return this._segments}SetOrigin(e){const t="relative"===this._xTrack.GetResultMode()?e.GetX():0,s="relative"===this._yTrack.GetResultMode()?e.GetY():0;for(const e of this._segments)e.SetOrigin(t,s)}Project(e,t,s){let i=NaN,r=this._segments.length;for(let s=0;s<r;s++){const r=this._segments[s];if("cubic-bezier"===r.GetType()){const s=r.Project(e,t);(isNaN(i)||s[3]<i)&&(i=s[3],$S[0]=s[2],$S[1]=r.GetIndex())}}return $S}ProjectWithOptions(e,t,s){const i=s.tRange;VS.IsFiniteNumber(i[0])||(i[0]=0),VS.IsFiniteNumber(i[1])||(i[1]=1);let r=NaN,n=this._segments.length;for(let s=0;s<n;s++){const n=this._segments[s];if("cubic-bezier"===n.GetType()){const s=n.ProjectWithRange(e,t,i);(isNaN(r)||s[3]<r)&&(r=s[3],$S[0]=s[2],$S[1]=n.GetIndex())}}return $S}Tangent(e,t){return this._segments[t].Tangent(e)}TangentAngle(e,t){return this._segments[t].TangentAngle(e)}},VS.TimelineCubicBezierSegmentInfo=class{constructor(e,t,s,i,r){this._index=r;const n=e.GetAddOn("cubic-bezier"),a=s.GetAddOn("cubic-bezier"),o=t.GetAddOn("cubic-bezier"),h=i.GetAddOn("cubic-bezier");this._aX=e.GetValueWithResultMode(),this._aY=t.GetValueWithResultMode(),this._bX=e.GetValueWithResultMode()+n.GetStartAnchor(),this._bY=t.GetValueWithResultMode()+o.GetStartAnchor(),this._cX=s.GetValueWithResultMode()+a.GetEndAnchor(),this._cY=i.GetValueWithResultMode()+h.GetEndAnchor(),this._dX=s.GetValueWithResultMode(),this._dY=i.GetValueWithResultMode(),this._aXO=0,this._aYO=0,this._bXO=0,this._bYO=0,this._cXO=0,this._cYO=0,this._dXO=0,this._dYO=0,this._d0x=0,this._d0y=0,this._d1x=0,this._d1y=0,this._d2x=0,this._d2y=0,this._x1Factor=0,this._x2Factor=0,this._x3Factor=0,this._y1Factor=0,this._y2Factor=0,this._y3Factor=0,this._lutIndex=NaN,this._initialized=!1,this._len=100,this._arcLengths=new Array(this._len+1),this._arcLengths[0]=0,this._length=0,this._lut=[],this._lutObjects=[];for(let e=0;e<100;e++)this._lutObjects.push({x:0,y:0,t:0,distance:0});this._CalculateLength()}Release(){VS.clearArray(this._arcLengths),this._arcLengths=null,VS.clearArray(this._lut),this._lut=null,VS.clearArray(this._lutObjects),this._lutObjects=null}GetType(){return"cubic-bezier"}GetIndex(){return this._index}GetStepCount(){return Math.floor(this._length/25)}GetStepIncrement(){return 1/this.GetStepCount()}SetOrigin(e,t){this._originX=e,this._originY=t,this._arcLengths=new Array(this._len+1),this._arcLengths[0]=0,this._CalculateLength(),this._aXO=this._aX+this._originX,this._aYO=this._aY+this._originY,this._bXO=this._bX+this._originX,this._bYO=this._bY+this._originY,this._cXO=this._cX+this._originX,this._cYO=this._cY+this._originY,this._dXO=this._dX+this._originX,this._dYO=this._dY+this._originY,this._d0x=3*(this._bXO-this._aXO),this._d0y=3*(this._bYO-this._aYO),this._d1x=3*(this._cXO-this._bXO),this._d1y=3*(this._cYO-this._bYO),this._d2x=3*(this._dXO-this._cXO),this._d2y=3*(this._dYO-this._cYO),this._x1Factor=3*(this._bXO-this._aXO),this._x2Factor=3*(this._aXO+this._cXO-2*this._bXO),this._x3Factor=this._dXO-this._aXO+3*(this._bXO-this._cXO),this._y1Factor=3*(this._bYO-this._aYO),this._y2Factor=3*(this._aYO+this._cYO-2*this._bYO),this._y3Factor=this._dYO-this._aYO+3*(this._bYO-this._cYO)}Map(e){if(!this._initialized)return NaN;const t=this._Map(e);return KS[0]=this._X(t),KS[1]=this._Y(t),KS}Project(e,t){const s=this._GenerateLUT(100),i=this._FindClosestFromLUT(e,t,s),r=this._RefineProjection(e,t,s,i);return JS[0]=r.x,JS[1]=r.y,JS[2]=r.t,JS[3]=r.distance,JS}ProjectWithRange(e,t,s){const i=this._GenerateLUT(100),r=this._FindClosestFromLUTWithRange(e,t,i,s),n=this._RefineProjection(e,t,i,r);return JS[0]=n.x,JS[1]=n.y,JS[2]=n.t,JS[3]=n.distance,JS}Tangent(e){const t=1-e,s=t*t,i=2*t*e,r=e*e,n=s*this._d0x+i*this._d1x+r*this._d2x,a=s*this._d0y+i*this._d1y+r*this._d2y,o=VS.hypot2DFast(n,a);return qS[0]=n/o,qS[1]=a/o,qS}TangentAngle(e){const t=1-e,s=t*t,i=2*t*e,r=e*e,n=s*this._d0x+i*this._d1x+r*this._d2x,a=s*this._d0y+i*this._d1y+r*this._d2y;return Math.atan2(a,n)}_Map(e){if(!this._initialized)return;let t=e*this._arcLengths[this._len],s=0,i=this._len,r=0;for(;s<i;)r=s+((i-s)/2|0),this._arcLengths[r]<t?s=r+1:i=r;this._arcLengths[r]>t&&r--;const n=this._arcLengths[r];return n===t?r/this._len:(r+(t-n)/(this._arcLengths[r+1]-n))/this._len}_X(e){return this._initialized?self.Ease.GetRuntimeEase("cubicbezier")(e,this._aX+this._originX,this._bX+this._originX,this._cX+this._originX,this._dX+this._originX):NaN}_Y(e){return this._initialized?self.Ease.GetRuntimeEase("cubicbezier")(e,this._aY+this._originY,this._bY+this._originY,this._cY+this._originY,this._dY+this._originY):NaN}_GenerateLUT(e){if(e=e||100,this._lut.length>=e)return this._lut;this._lut=new Array(e),e++;for(let t=0;t<e-1;t++){const s=t/(e-1),i=s**2,r=s**3,n=this._x1Factor*s,a=this._x2Factor*i,o=this._x3Factor*r,h=this._y1Factor*s,l=this._y2Factor*i,c=this._y3Factor*r,u=this._aXO+n+a+o,d=this._aYO+h+l+c;this._lutObjects[t].x=u,this._lutObjects[t].y=d,this._lutObjects[t].t=s,this._lutObjects[t].distance=0,this._lut[t]=this._lutObjects[t]}return this._lut}_FindClosestFromLUT(e,t,s,i=null,r=Number.MAX_SAFE_INTEGER){let n=0;if(isNaN(this._lutIndex))for(let i=0;i<100;i++){const a=s[i],o=a.x-e,h=a.y-t;a.distance=o*o+h*h,a.distance<r&&(r=a.distance,n=i)}else{for(let i=this._lutIndex;i<this._lutIndex+5&&!(i>=s.length);i++){const a=s[i],o=a.x-e,h=a.y-t;a.distance=o*o+h*h,a.distance<r&&(r=a.distance,n=i)}for(let i=this._lutIndex;i>this._lutIndex-5&&!(i<0);i--){const a=s[i],o=a.x-e,h=a.y-t;a.distance=o*o+h*h,a.distance<r&&(r=a.distance,n=i)}}return this._lutIndex=n,n}_FindClosestFromLUTWithRange(e,t,s,i,r=Number.MAX_SAFE_INTEGER){let n=0;if(isNaN(this._lutIndex))for(let a=0;a<100;a++){const o=s[a],h=o.x-e,l=o.y-t;o.distance=h*h+l*l,o.t>=i[0]&&o.t<=i[1]&&o.distance<r&&(r=o.distance,n=a)}else{for(let a=this._lutIndex;a<this._lutIndex+5&&!(a>=s.length);a++){const o=s[a],h=o.x-e,l=o.y-t;o.distance=h*h+l*l,o.t>=i[0]&&o.t<=i[1]&&o.distance<r&&(r=o.distance,n=a)}for(let a=this._lutIndex;a>this._lutIndex-5&&!(a<0);a--){const o=s[a],h=o.x-e,l=o.y-t;o.distance=h*h+l*l,o.t>=i[0]&&o.t<=i[1]&&o.distance<r&&(r=o.distance,n=a)}}return this._lutIndex=n,n}_RefineProjection(e,t,s,i){let r=s[i],n=1,a=Number.MAX_SAFE_INTEGER;e:do{const n=s.length;let o=0===i?0:i-1,h=i===n-1?n-1:i+1,l=s[o].t,c=(s[h].t-l)/4;if(c<.001)break;ZS[0]=s[o];for(let s=1;s<=2;s++){const n=l+s*c,o=n**2,h=n**3,u=this._x1Factor*n,d=this._x2Factor*o,_=this._x3Factor*h,p=this._y1Factor*n,f=this._y2Factor*o,m=this._y3Factor*h,g=this._aXO+u+d+_,S=this._aYO+p+f+m,G=g-e,y=S-t,I=G*G+y*y;if(I<a){a=I,i=s,eG.x=g,eG.y=S,eG.t=n,eG.distance=I,r=eG;break e}const T=QS[s-1];T.x=g,T.y=S,T.t=n,T.distance=I,ZS[s]=T}ZS[3]=s[h],s=ZS}while(n++<20);return r}_CalculateLength(){this._initialized=!0;let e=this._X(0),t=this._Y(0),s=0;for(let i=1;i<=this._len;i++){const r=this._X(.01*i),n=this._Y(.01*i),a=e-r,o=t-n;s+=VS.hypot2DFast(a,o),this._arcLengths[i]=s,e=r,t=n}this._length=s}},VS.TimelineLineSegmentInfo=class{constructor(e,t,s){this._index=s,this._targetX=e.GetValueWithResultMode(),this._targetY=t.GetValueWithResultMode(),this._originX=0,this._originY=0}Release(){}GetType(){return"line"}GetIndex(){return this._index}SetOrigin(e,t){this._originX=e,this._originY=t}GetX(){return this._targetX+this._originX}GetY(){return this._targetY+this._originY}}}{const tG=self.C3,sG=0,iG=1;tG.TimelineState=class extends tG.DefendedBase{constructor(e,t,s){super(),this._runtime=s.GetRuntime(),this._timelineManager=s,this._timelineDataItem=t,this._name=e,this._tracks=[],this._tracksLength=0,this._beforeAndAfterTracks=null,this._beforeAndAfterTracksLength=0,this.CreateTrackStates(),this._playPromise=null,this._playResolve=null,this._playheadTime=0,this._overshoot=0,this._playbackRate=1,this._pingPongState=0,this._resumePingPongState=-1,this._currentRepeatCount=1,this._isPlaying=!1,this._isScheduled=!1,this._initialStateSet=!1,this._complete=!0,this._released=!1,this._markedForRemoval=!1,this._completedTick=-1,this._implicitPause=!1,this._isTemplate=!1,this._finishedTriggers=!1,this._firstTick=!1,this._lastDelta=NaN,this._tags=[""],this._stringTags="",this._tagsChanged=!1,this._renderChange=0,this._hasNestedContent=0,this._stoppedKeyframeDataItem=null,this._iTimelineState=null}static CreateInitial(e,t){const s=t.GetTimelineDataManager(),i=s.GetNameId(),r=s.Get(e[i]),n=tG.New(tG.TimelineState,e[i],r,t);return n.SetIsTemplate(!0),n}static CreateFromTemplate(e,t,s){return tG.New(tG.TimelineState,e,t,s)}Release(){if(this.IsReleased())return;const e=this._runtime.Dispatcher();this._timelineManager.DeScheduleTimeline(this),this._timelineManager.CompleteTimelineAndResolve(this);for(const e of this._tracks)e.Release();tG.clearArray(this._tracks),this._tracks=null,this._runtime=null,this._timelineManager=null,this._timelineDataItem=null,this._released=!0,this._playPromise=null,this._playResolve=null,this.FireReleaseEvent(e)}FireReleaseEvent(e){const t=tG.New(tG.Event,"timelinestatereleased");t.timelineState=this,e.dispatchEvent(t)}GetType(){return 0}CreateTrackStates(){for(const e of this._timelineDataItem.GetTrackData().trackDataItems())this._tracksLength=this._tracks.push(tG.TrackState.Create(this,e))}GetTimelineManager(){return this._timelineManager}GetRuntime(){return this._runtime}GetTracks(){return this._tracks}GetSimilarPropertyTracks(e,t,s,i){if(!this._hasNestedContent)return;let r;for(let n=0;n<this._tracks.length;n++){let a=this._tracks[n];if(e!==a.GetInstance())continue;const o=a.GetPropertyTrack(s);o&&t.constructor===o.GetSourceAdapter().constructor&&o.GetResultMode()===i.GetResultMode()&&(r||(r=[]),r.push(o))}return r}HasTracks(){return!!this._tracks.length}GetTrackById(e){for(const t of this._tracks)if(tG.equalsNoCase(t.GetId(),e))return t;return null}GetTrackByName(e){for(const t of this._tracks)if(!t.IsInstanceTrack()&&tG.equalsNoCase(t.GetName(),e))return t;return null}SetName(e){this._name=e}GetName(){return this._name}GetTimelineDataItem(){return this._timelineDataItem}GetTemplateName(){return this._timelineDataItem.GetName()}GetTotalTime(){return this._timelineDataItem.GetTotalTime()}SetTotalTime(e){this._timelineDataItem.SetTotalTime(e)}GetStep(){return this._timelineDataItem.GetStep()}SetStep(e){this._timelineDataItem.SetStep(e)}GetInterpolationMode(){return this._timelineDataItem.GetInterpolationMode()}SetInterpolationMode(e){this._timelineDataItem.SetInterpolationMode(e)}GetResultMode(){return this._timelineDataItem.GetResultMode()}SetResultMode(e){this._timelineDataItem.GetResultMode(e)}SetEase(e){for(const t of this.GetTracks())t.SetEase(e)}GetLoop(){return this._timelineDataItem.GetLoop()}SetLoop(e){return this._timelineDataItem.SetLoop(e)}GetPingPong(){return this._timelineDataItem.GetPingPong()}SetPingPong(e){return this._timelineDataItem.SetPingPong(e)}GetRepeatCount(){return this._timelineDataItem.GetRepeatCount()}GetCurrentRepeatCount(){return this._currentRepeatCount}SetRepeatCount(e){return this._timelineDataItem.SetRepeatCount(e)}SetPlaybackRate(e){if(e=Number(e),tG.IsFiniteNumber(e))return this._playbackRate=e}GetPlaybackRate(){return this._playbackRate}GetStartOnLayout(){return this._timelineDataItem.GetStartOnLayout()}GetTransformWithSceneGraph(){return this._timelineDataItem.GetTransformWithSceneGraph()}GetUseSystemTimescale(){return this._timelineDataItem.GetUseSystemTimescale()}GetPingPongState(){return this._pingPongState}IsForwardPlayBack(){return!this.IsPlaying()||this._playbackRate>0}GetStatus(){return this.IsPlaying()?"playing":this.IsPaused()?"paused":this.IsComplete()?"complete":"other"}GetPlayPromise(){return this._playPromise||(this._playPromise=new Promise(e=>{this._playResolve=e})),this._playPromise}ResolvePlayPromise(){this._playPromise&&(this._playResolve(),this._playPromise=null,this._playResolve=null)}SetTags(e){this._tags=tG.TimelineState._GetTagArray(e),this._tagsChanged=!0}GetTags(){return this._tags}GetStringTags(){return this._tagsChanged&&(this._stringTags=this._tags.join(" ")),this._tagsChanged=!1,this._stringTags}HasTags(e){if(!this._tags)return!1;if(!this._tags.length)return!1;const t=tG.TimelineState._GetTagArray(e);return!!t&&!!t.length&&t.every(tG.TimelineState._HasTag,this)}OnStarted(){tG.Plugins.Timeline&&this.constructor===tG.TimelineState&&(tG.Plugins.Timeline.Cnds.PushTriggerTimeline(this),this._timelineManager.Trigger(tG.Plugins.Timeline.Cnds.OnTimelineStarted),this._timelineManager.Trigger(tG.Plugins.Timeline.Cnds.OnTimelineStartedByName),this._timelineManager.Trigger(tG.Plugins.Timeline.Cnds.OnTimelineStartedByTags),this._timelineManager.Trigger(tG.Plugins.Timeline.Cnds.OnAnyTimelineStarted),tG.Plugins.Timeline.Cnds.PopTriggerTimeline())}OnCompleted(){this._completedTick=this._runtime.GetTickCount()}FinishTriggers(){this._finishedTriggers||(this._finishedTriggers=!0,tG.Plugins.Timeline&&this.constructor===tG.TimelineState&&(tG.Plugins.Timeline.Cnds.PushTriggerTimeline(this),this._timelineManager.Trigger(tG.Plugins.Timeline.Cnds.OnTimelineFinished),this._timelineManager.Trigger(tG.Plugins.Timeline.Cnds.OnTimelineFinishedByName),this._timelineManager.Trigger(tG.Plugins.Timeline.Cnds.OnTimelineFinishedByTags),this._timelineManager.Trigger(tG.Plugins.Timeline.Cnds.OnAnyTimelineFinished),tG.Plugins.Timeline.Cnds.PopTriggerTimeline()))}SetPlaying(e){this._isPlaying=e}IsCompletedTick(){return this._completedTick===this._runtime.GetTickCount()}IsPlaying(e=!1){return!!this.IsCompletedTick()||!(!this.IsScheduled()||e)||this._isPlaying}_IsPlaying(){return this.IsPlaying(!0)}IsPaused(){return this._IsPaused()}_IsPaused(){return!(this.IsReleased()||this.IsScheduled()||this._IsPlaying()||this.IsComplete())}SetScheduled(e){this._isScheduled=e}IsScheduled(){return this._isScheduled}SetComplete(e){this._complete=e;const t=this.GetLoop(),s=this.GetPingPong();if(t||s){if(t&&!s);else if(!t&&s){const e=this.GetTime();1===this._pingPongState&&(e<=0||e>=this.GetTotalTime())&&(this._complete=!0)}}else{const e=this.GetTime();(e<=0||e>=this.GetTotalTime())&&(this._complete=!0)}}IsComplete(){return this._complete}IsReleased(){return this._released}SetMarkedForRemoval(e){this._markedForRemoval=e}IsMarkedForRemoval(){return this._markedForRemoval}SetImplicitPause(e){this._implicitPause=e}IsImplicitPause(){return this._implicitPause}SetIsTemplate(e){this._isTemplate=!!e}IsTemplate(){return this._isTemplate}InitialStateSet(){return this._initialStateSet}GetTime(){return this._playheadTime}SetTime(e){if(e=Number(e),!tG.IsFiniteNumber(e))return;const t=this.GetTime();this._SetTime(e),this.SetComplete(!1),this.IsComplete()||this.SetImplicitPause(!0),(this._IsPlaying()||this.IsScheduled()||!this._initialStateSet)&&(this._IsPlaying()||this.IsScheduled()||this._initialStateSet?this._IsPlaying()?this.Stop():this.IsScheduled()&&(this._timelineManager.DeScheduleTimeline(this),this.SetInitialStateFromSetTime()):this.SetInitialStateFromSetTime()),this._SetUpdateStateBefore(),this._Interpolate(this.GetTime(),!1,!0,!0,t),this._SetUpdateStateAfter(),this._renderChange&&this.GetRuntime().UpdateRender(),this._OnSetTime()}_SetTime(e){tG.IsFiniteNumber(e)||(e=this.GetTotalTime()),e<0?this._playheadTime=0:e>=this.GetTotalTime()?this._playheadTime=this.GetTotalTime():this._playheadTime=e}_SetTimeAndReset(e){tG.IsFiniteNumber(e)||(e=this.GetTotalTime()),e<0?this._playheadTime=0:e>=this.GetTotalTime()?this._playheadTime=this.GetTotalTime():this._playheadTime=e;for(const e of this._tracks)e.SetResetState()}_OnSetTime(){tG.Plugins.Timeline&&this.constructor===tG.TimelineState&&(tG.Plugins.Timeline.Cnds.PushTriggerTimeline(this),this._timelineManager.Trigger(tG.Plugins.Timeline.Cnds.OnTimeSet),this._timelineManager.Trigger(tG.Plugins.Timeline.Cnds.OnTimeSetByName),this._timelineManager.Trigger(tG.Plugins.Timeline.Cnds.OnTimeSetByTags),tG.Plugins.Timeline.Cnds.PopTriggerTimeline())}_CanResume(){if(this.GetLoop())return!0;if(this.GetPingPong()&&1===this._pingPongState){if(this.IsForwardPlayBack()){if(this.GetTime()>=this.GetTotalTime())return!1}else if(this.GetTime()<=0)return!1}else if(!this.GetLoop()&&!this.GetPingPong())if(this.IsForwardPlayBack()){if(this.GetTime()>=this.GetTotalTime())return!1}else if(this.GetTime()<=0)return!1;return!0}Resume(){this.IsReleased()||this._CanResume()&&this.Play(!0)}Play(e=!1){return!this.IsReleased()&&!this.IsScheduled()&&(this._IsPlaying()&&this.IsCompletedTick()?this._SchedulePlayingTimeline():!this._IsPlaying()&&!!(this.IsComplete()||e||this.IsImplicitPause())&&this._ScheduleStoppedTimeline())}_SchedulePlayingTimeline(){return this.SetImplicitPause(!1),this._timelineManager.RemovePlayingTimeline(this),this._timelineManager.ScheduleTimeline(this),this.GetPlayPromise(),!0}_ScheduleStoppedTimeline(){return this.SetImplicitPause(!1),this._timelineManager.ScheduleTimeline(this),this.GetPlayPromise(),!0}Stop(e=!1){this.IsReleased()||(this.SetComplete(e),this._timelineManager.CompleteTimeline(this),this.IsComplete()&&this.ResolvePlayPromise())}Reset(e=!0,t=!1){if(this.IsReleased())return;if(!this._IsPlaying()&&this.IsScheduled())return this._timelineManager.DeScheduleTimeline(this);if(this.IsComplete())return;this.Stop(!0),this.IsForwardPlayBack()?this._SetTime(0):this._SetTime(this.GetTotalTime());const s=this.GetTime();this._SetUpdateStateBefore(),t?this._InterpolateBeforeChangeLayout(s):this._Interpolate(s,!1,!1,!0),e&&this._OnSetTime(),this._SetUpdateStateAfter(),this._renderChange&&e&&this.GetRuntime().UpdateRender()}ResetBeforeChangeLayout(){this.Reset(!1,!0)}_InterpolateBeforeChangeLayout(e){this._Interpolate(e,!1,!1,!0,NaN,!1,!0)}_OnBeforeChangeLayout(){return!!this.IsReleased()||!(!this.GetRuntime().IsLoadingState()&&this.HasValidGlobalTracks())&&(this._timelineManager.CompleteTimelineBeforeChangeOfLayout(this),this.GetRuntime().IsLoadingState()||this.ResetBeforeChangeLayout(),!0)}SetInitialStateFromSetTime(){this.SetInitialState(!0)}SetInitialStateForce(){this.SetInitialState(!1,!0),this.SetPlaying(!1),this.SetScheduled(!1)}SetInitialState(e=!1,t=!1){if(!this.IsMarkedForRemoval()||t)if(e){this._finishedTriggers=!1,this._initialStateSet=!0,this._firstTick=!0,this._SetUpdateStateBefore();for(const e of this._tracks)e.SetInitialState();this._SetUpdateStateAfter()}else if(this.SetPlaying(!0),this.SetScheduled(!1),this.OnStarted(),this.IsComplete()){this._completedTick=-1,0!==this._pingPongState&&(this._playbackRate=Math.abs(this._playbackRate)),this._pingPongState=0,this._resumePingPongState=-1,this._currentRepeatCount=1,this._complete=!1,this._finishedTriggers=!1,this._initialStateSet=!0,this._firstTick=!0,this.IsForwardPlayBack()?this._SetTime(0):this._SetTime(this.GetTotalTime()),this._SetUpdateStateBefore();for(const e of this._tracks)e.SetInitialState();this._SetUpdateStateAfter()}else{-1!==this._resumePingPongState&&(this._pingPongState=this._resumePingPongState),this._firstTick=!0,this._finishedTriggers=!1,this._SetUpdateStateBefore();for(const e of this._tracks)e.SetResumeState();this._SetUpdateStateAfter()}}GetRenderChange(){return this._renderChange}_SetUpdateStateBefore(){this._hasNestedContent=0;for(const e of this._tracks)e.IsNested()&&(this._hasNestedContent=1)}_SetUpdateStateAfter(){this._renderChange=0;for(const e of this._tracks)e._SetUpdateState(),0===this._renderChange&&1===e.GetRenderChange()&&(this._renderChange=1),this._beforeAndAfterTracks||1!==e.GetNeedsBeforeAndAfter()||(this._beforeAndAfterTracks||(this._beforeAndAfterTracks=[]),this._beforeAndAfterTracksLength=this._beforeAndAfterTracks.push(e))}Tick(e,t,s){if(this.GetUseSystemTimescale()){if(0===e&&0===this._lastDelta)return;this._lastDelta=e,e=s}else{if(0===s&&0===this._lastDelta)return;this._lastDelta=s,e=s,t=1}const i=this._playheadTime+this._overshoot,r=i+e*t*this._playbackRate,n=this._timelineDataItem._totalTime;r<0?(this._playheadTime=0,this._overshoot=-r):r>=n?(this._playheadTime=n,this._overshoot=this._playheadTime-r):(this._playheadTime=r,this._overshoot=0);let a=!1,o=!1;const h=this.GetLoop(),l=this.GetPingPong();let c;h||l?h&&!l?this._playbackRate>0?this._playheadTime>=n&&(this._SetTimeAndReset(0),o=!0):this._playheadTime<=0&&(this._SetTimeAndReset(n),o=!0):!h&&l?this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._pingPongState=0):a=!0:0===this._pingPongState&&(this._pingPongState=1)):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._pingPongState=0):a=!0:0===this._pingPongState&&(this._pingPongState=1)):h&&l&&(this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,this._pingPongState++,tG.wrap(this._pingPongState,0,2)):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,this._pingPongState++,tG.wrap(this._pingPongState,0,2))):this._playbackRate>0?this._playheadTime>=n&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(0),o=!0):(this._SetTime(n),a=!0)):this._playheadTime<=0&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(n),o=!0):(this._SetTime(0),a=!0));const u=this._tracksLength;if(a){for(c=0;c<u;c++)this._tracks[c].SetEndState();return this.Stop(!0),void this.OnCompleted()}const d=this._beforeAndAfterTracksLength;for(c=0;c<d;c++){const e=this._beforeAndAfterTracks[c],t=e.GetStartOffset();this._playheadTime-t<0&&i-t>0?e.BeforeInterpolate(t):e.BeforeInterpolate(this._playheadTime)}if(1===this._hasNestedContent)for(c=0;c<u;c++){const e=this._tracks[c],t=e.GetStartOffset();this._playheadTime-t<0&&i-t>0?e.Interpolate(t,!0,!1,o,this._firstTick,!1):e.Interpolate(this._playheadTime,!0,!1,o,this._firstTick,!1)}else for(c=0;c<u;c++)this._tracks[c].Interpolate(this._playheadTime,!0,!1,o,this._firstTick,!1);if(!this.IsPlaying()&&this._stoppedKeyframeDataItem){const e=this._stoppedKeyframeDataItem.GetTime()+this._stoppedKeyframeDataItem.GetKeyframeData().GetTrackDataItem().GetStartOffset(),t=this._playheadTime-e;this._playheadTime-=t,0!==this._overshoot&&(this._overshoot-=t),this._stoppedKeyframeDataItem=null}for(c=0;c<d;c++){const e=this._beforeAndAfterTracks[c],t=e.GetStartOffset();this._playheadTime-t<0&&i-t>0?e.AfterInterpolate(t):e.AfterInterpolate(this._playheadTime)}this._firstTick&&(this._firstTick=!1)}SetStoppedOnKeyframe(e){this._stoppedKeyframeDataItem=e}GetStoppedOnKeyframe(){return this._stoppedKeyframeDataItem}_GetTrackStartTime(e,t,s,i=!1){let r=e;if("number"==typeof t&&!isNaN(t)){const e=this.GetTime()-s.GetStartOffset(),n=t-s.GetStartOffset();e<0&&n>0&&(r=s.GetStartOffset(),i&&this._SetTime(r))}return r}_Interpolate(e,t=!1,s=!1,i=!1,r=NaN,n=!1,a=!1){for(const t of this._tracks){const i=this._GetTrackStartTime(e,r,t);t.BeforeInterpolate(i,s)}for(const n of this._tracks){const o=this._GetTrackStartTime(e,r,n,!0);n.Interpolate(o,t,s,i,this._firstTick,a)}for(const t of this._tracks){const i=this._GetTrackStartTime(e,r,t);t.AfterInterpolate(i,s)}this._firstTick&&n&&(this._firstTick=!1)}AddTrack(){const e=this._timelineDataItem.GetTrackData().AddEmptyTrackDataItem(),t=tG.TrackState.Create(this,e);return this._tracksLength=this._tracks.push(t),t}Removed(){if(!this.IsReleased())for(const e of this._tracks)e.TimelineRemoved()}CleanCaches(){for(const e of this._tracks)e.CleanCaches()}*GetInstances(){for(const e of this._tracks)e.GetInstance()&&(yield e.GetInstance())}ClearTrackInstances(){for(const e of this._tracks)e.ClearInstance()}SetTrackInstance(e,t,s){if(t){if("number"==typeof s&&s>=0){const e=this._tracks[s];if(!e)return;return e.SetInstance(t),void this._timelineManager.SetTimelineObjectClassToMap(t.GetObjectClass(),this)}for(const s of this._tracks)if(s.IsInstanceTrack()){if(e){if(s.GetId()!==e)continue;s.SetInstance(t),this._timelineManager.SetTimelineObjectClassToMap(t.GetObjectClass(),this);break}if(!s.HasInstance()){s.SetInstance(t),this._timelineManager.SetTimelineObjectClassToMap(t.GetObjectClass(),this);break}}}}HasTrackInstance(e,t){for(const s of this._tracks)if(s.IsInstanceTrack())if(t){if(t===s.GetId()&&e===s.GetInstance())return!0}else if(e===s.GetInstance())return!0;return!1}HasValidTracks(){return this._tracks.some(e=>!e.IsInstanceTrack()||e.CanInstanceBeValid())}HasValidGlobalTracks(){return this._tracks.some(e=>{if(e.IsInstanceTrack()){if(!e.CanInstanceBeValid())return!1;const t=e.GetObjectClass();return!!t&&t.IsGlobal()}return!1})}GetPropertyTrack(e){for(const t of this.GetTracks())for(const s of t.GetPropertyTracks())if(s.GetPropertyName()===e)return s}GetTrackFromInstance(e){for(const t of this._tracks)if(e===t.GetInstance())return t;return null}GetKeyframeWithTags(e){let t=e?e.split(" "):[];const s=new Set(t.map(e=>e.toLowerCase().trim()));t=[...s.values()];for(const e of this.GetTracks())for(const s of e.GetKeyframeDataItems())if(t.every(e=>s.HasTag(e)))return s}GetObjectClasses(){const e=[];for(const t of this.GetTracks())e.push(t.GetObjectClass());return e.filter(e=>e)}_OnAfterLoad(){for(const e of this.GetTracks())e._OnAfterLoad()}_SaveToJson(){return{tracksJson:this._SaveTracksToJson(),name:this._name,playheadTime:this.GetTime(),playbackRate:this._playbackRate,pingPongState:this._pingPongState,resumePingPongState:this._resumePingPongState,currentRepeatCount:this._currentRepeatCount,isPlaying:this._isPlaying,isScheduled:this._isScheduled,initialStateSet:this._initialStateSet,finishedTriggers:this._finishedTriggers,complete:this._complete,released:this._released,markedForRemoval:this._markedForRemoval,completedTick:this._completedTick,implicitPause:this._implicitPause,isTemplate:this._isTemplate,tags:this._tags.join(" "),stringTags:this._stringTags,tagsChanged:this._tagsChanged,firstTick:this._firstTick}}_LoadFromJson(e){e&&(this._LoadTracksFromJson(e.tracksJson),this._name=e.name,this._playheadTime=e.playheadTime,this._playbackRate=e.playbackRate,this._pingPongState=e.pingPongState,this._resumePingPongState=e.hasOwnProperty("resumePingPongState")?e.resumePingPongState:-1,this._currentRepeatCount=e.currentRepeatCount,this._isPlaying=!!e.isPlaying,this._isScheduled=!!e.isScheduled,this._initialStateSet=!!e.initialStateSet,this._finishedTriggers=!!e.hasOwnProperty("finishedTriggers")&&!!e.finishedTriggers,this._complete=!!e.complete,this._released=!!e.released,this._markedForRemoval=!!e.markedForRemoval,this._completedTick=e.completedTick,this._implicitPause=!!e.implicitPause,this._isTemplate=!!e.isTemplate,this._tags=e.tags.split(" "),this._stringTags=e.stringTags,this._tagsChanged=!!e.tagsChanged,this._firstTick=!!e.firstTick)}_SaveTracksToJson(){return this._tracks.map(e=>e._SaveToJson())}_LoadTracksFromJson(e){this.ClearTrackInstances(),e.forEach((e,t)=>{this._tracks[t]._LoadFromJson(e)}),this._tracks.filter(e=>e.CanInstanceBeValid())}static _HasTag(e){const t=this.GetTags();return""===e?1===t.length&&""===t[0]:t.map(e=>e.toLowerCase()).includes(e.toLowerCase())}static _GetTagArray(e){if(tG.IsArray(e))return e.slice(0);if(tG.IsString(e))return e.split(" ");throw new Error("invalid tags")}GetITimelineState(){return this._iTimelineState||(this._iTimelineState=tG.New(self.ITimelineState,this)),this._iTimelineState}}}{const rG=self.C3,nG=0,aG=1,oG=2;rG.TrackState=class extends rG.DefendedBase{constructor(e,t){super(),this._timeline=e,this._trackDataItem=t,this._trackData=t.GetTrackData(),this._instanceUid=NaN,this._objectClassIndex=NaN,this._instance=null,this._worldInfo=null,this._cleared=!1,this._isNested=t.GetStartOffset()>0,this._initialStateOfNestedSet=!1,this._endStateOfNestedSet=!1,this._instanceUidToLoad=NaN,this._lastKeyframeDataItem=null,this._keyframeDataItems=this._trackDataItem.GetKeyframeData().GetKeyframeDataItemArray(),this._propertyTracks=[],this.CreatePropertyTrackStates(),this._worldInfoChange=0,this._renderChange=0,this._needsBeforeAndAfter=0,this._keyframeReachedOnCurrentTick=null}static Create(e,t){return rG.New(rG.TrackState,e,t)}Release(){this._keyframeDataItems=null;for(const e of this._propertyTracks)e.Release();rG.clearArray(this._propertyTracks),this._propertyTracks=null,this._timeline=null,this._instance=null,this._worldInfo=null,this._trackDataItem=null,this._lastKeyframeDataItem=null}CreatePropertyTrackStates(){for(const e of this._trackDataItem.GetPropertyTrackData().propertyTrackDataItems())this._propertyTracks.push(rG.PropertyTrackState.Create(this,e))}TimelineRemoved(){for(const e of this._propertyTracks)e.TimelineRemoved()}CleanCaches(){for(const e of this._propertyTracks)e.CleanCaches();this._instance=null,this._worldInfo=null}GetTimeline(){return this._timeline}GetRuntime(){return this._timeline.GetRuntime()}GetKeyframeDataItems(){return this._keyframeDataItems||(this._keyframeDataItems=this._trackDataItem.GetKeyframeData().GetKeyframeDataItemArray()),this._keyframeDataItems}GetPropertyTracks(){return this._propertyTracks}GetPropertyTrack(e){for(let t=0;t<this._propertyTracks.length;t++){const s=this._propertyTracks[t];if(s.GetPropertyName()===e)return s}}MaybeGetInstance(){this._instance||this.GetInstance()}IsInstanceValid(){return!!this._instance&&!this._instance.IsDestroyed()}CanInstanceBeValid(){if(!this.IsInstanceTrack())return!1;if(this._cleared)return!1;const e=this.GetInstanceUID(),t=this.GetRuntime().GetInstanceByUID(e);return!!t&&!t.IsDestroyed()}GetObjectClass(){if(!this.IsInstanceTrack())return;const e=this.GetObjectClassIndex();return-1!==e?this.GetRuntime().GetObjectClassByIndex(e):void 0}GetTrackIndexInTimeline(){return this._timeline.GetTracks().indexOf(this)}ClearInstance(){this._instance=null,this._instanceUid=NaN,this._worldInfo=null,this._objectClassIndex=NaN,this._cleared=!0}HasInstance(){return!!this._instance}GetInstance(){if(this._cleared)return;if(this._instance&&this.IsInstanceValid())return this._instance;const e=this.GetInstanceUID();return this._instance=this.GetRuntime().GetInstanceByUID(e),this._instance}SetInstance(e){if(this._cleared=!1,this._instance!==e){this.CleanCaches(),this._instance=e,this._objectClassIndex=e.GetObjectClass().GetIndex(),this._instanceUid=e.GetUID(),this._worldInfo=e.GetWorldInfo();for(const t of this.propertyTrackItems()){const s=t.propertyTrack,i=t.sourceAdapter;switch(s.GetSourceAdapterId()){case"instance-variable":{i.GetEditorIndex();const s=e.GetObjectClass(),r=s.GetInstanceVariableIndexByName(t.name),n=s.GetInstanceVariableName(r),a=s.GetInstanceVariableType(r);n===t.name&&a===t.type&&i.UpdateInstanceVariableIndex(r);break}case"behavior":{const s=t.behaviorType,r=this.GetObjectClass(),n=e.GetObjectClass(),a=i.GetBehaviorType(n);if(s&&a){const e=s.GetName();r.GetBehaviorIndexByName(e),n.GetBehaviorIndexByName(e),i.GetEditorIndex(),i.UpdateBehaviorTypeSid(a.GetSID())}break}}}}}*propertyTrackItems(){for(const e of this._propertyTracks){const t=e.GetSourceAdapter(),s=this.GetObjectClass(),i={propertyTrack:e,sourceAdapter:t};switch(e.GetSourceAdapterId()){case"world-instance":i.property=e.GetPropertyName();break;case"instance-variable":{const e=t.GetEditorIndex();i.name=s.GetInstanceVariableName(e),i.type=s.GetInstanceVariableType(e);break}case"effect":{const e=s.GetEffectList(),r=t.GetEffectType(e);i.effectType=r;break}case"behavior":{const e=t.GetBehaviorType(s);i.behaviorType=e;break}case"plugin":i.plugin=s.GetPlugin()}yield i}}GetWorldInfo(){if(this._worldInfo&&this.IsInstanceValid())return this._worldInfo;const e=this.GetInstance();return e&&(this._worldInfo=e.GetWorldInfo()),this._worldInfo}GetTrackDataItem(){return this._trackDataItem}GetInstanceUID(){return isNaN(this._instanceUid)?this._trackDataItem.GetInstanceUID():this._instanceUid}SetInstanceUID(e){this._trackDataItem.SetInstanceUID(e)}GetInterpolationMode(){return this._trackDataItem.GetInterpolationMode()}SetInterpolationMode(e){this._trackDataItem.SetInterpolationMode(e)}GetResultMode(){return this._trackDataItem.GetResultMode()}GetId(){return this._trackDataItem.GetId()}GetStartOffset(){return this._trackDataItem.GetStartOffset()}GetLocalTotalTime(){return this._trackDataItem.GetLocalTotalTime()}SetLocalTotalTime(e){this._trackDataItem.SetLocalTotalTime(e)}SetResultMode(e){this._trackDataItem.SetResultMode(e)}SetEase(e){for(const t of this.GetKeyframeDataItems())t.SetEase(e);for(const t of this.GetPropertyTracks())t.SetEase(e)}GetEnable(){return this._trackDataItem.GetEnable()}SetEnable(e){this._trackDataItem.SetEnable(e)}GetObjectClassIndex(){return isNaN(this._objectClassIndex)?this._trackDataItem.GetObjectClassIndex():this._objectClassIndex}SetObjectClassIndex(e){this._trackDataItem.SetObjectClassIndex(e)}SetOriginalWidth(e){this._trackDataItem.SetOriginalWidth(e)}GetOriginalWidth(){const e=this.GetInstance();return e&&e.GetSdkInstance().IsOriginalSizeKnown()?e.GetSdkInstance().GetOriginalWidth():this._trackDataItem.GetOriginalWidth()}SetOriginalHeight(e){this._trackDataItem.SetOriginalHeight(e)}GetOriginalHeight(){const e=this.GetInstance();return e&&e.GetSdkInstance().IsOriginalSizeKnown()?e.GetSdkInstance().GetOriginalHeight():this._trackDataItem.GetOriginalHeight()}GetType(){return this._trackDataItem.GetType()}GetName(){return this._trackDataItem.GetName()}IsInstanceTrack(){return 0===this.GetType()}IsValueTrack(){return 1===this.GetType()}IsAudioTrack(){return 2===this.GetType()}GetWorldInfoChange(){return this._worldInfoChange}GetRenderChange(){return this._renderChange}GetNeedsBeforeAndAfter(){return this._needsBeforeAndAfter}IsNested(){return this._isNested}SetResetState(){for(const e of this._propertyTracks)e.SetResetState();const e=this.GetTimeline(),t=e.GetTime();e.IsForwardPlayBack()?this._lastKeyframeDataItem=this._GetLastKeyFrameBeforeTime(t):this._lastKeyframeDataItem=this._GetFirstKeyFrameAfterTime(t)}SetInitialState(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;const e=this.GetTimeline().IsForwardPlayBack(),t=e?0:this.GetLocalTotalTime();for(const e of this._propertyTracks)e.SetInitialState(t),0===this._worldInfoChange&&1===e.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===e.GetRenderChange()&&(this._renderChange=1);this._needsBeforeAndAfter=0,this._propertyTracks.some(e=>e.GetNeedsBeforeAndAfter())&&(this._needsBeforeAndAfter=1),this._lastKeyframeDataItem=e?this._GetLastKeyFrameBeforeTime(t):this._GetFirstKeyFrameAfterTime(t),this._initialStateOfNestedSet=!1,this._endStateOfNestedSet=!1,this.Interpolate(t),this.OnInitialKeyframeReached(this._lastKeyframeDataItem)}GetCurrentKeyframeInterval(){const e=this.GetLastKeyframe(),t=this.GetNextKeyframe();let s,i;return this._timeline.IsForwardPlayBack()?(s={GetTime:()=>e.GetTime()+this.GetStartOffset(),GetTags:()=>e.GetTagsString()||"<no tags>"},i={GetTime:()=>t?t.GetTime()+this.GetStartOffset():this.GetLocalTotalTime(),GetTags:()=>t?.GetTagsString()||"<no tags>"}):(s={GetTime:()=>t?t.GetTime()+this.GetStartOffset():this.GetLocalTotalTime(),GetTags:()=>t?.GetTagsString()||"<no tags>"},i={GetTime:()=>e.GetTime()+this.GetStartOffset(),GetTags:()=>e.GetTagsString()||"<no tags>"}),[s,i]}GetLastKeyframe(){const e=this._timeline.GetTime()-this.GetStartOffset();return this._timeline.IsForwardPlayBack()?this._GetLastKeyFrameBeforeTime(e):this._GetFirstKeyFrameAfterTime(e)}GetNextKeyframe(){return this._timeline.IsForwardPlayBack()?this.GetLastKeyframe().GetNext():this.GetLastKeyframe().GetLast()}SetResumeState(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;const e=this._timeline.IsForwardPlayBack(),t=this._timeline.GetTime()-this.GetStartOffset();this._lastKeyframeDataItem=e?this._GetLastKeyFrameBeforeTime(t):this._GetFirstKeyFrameAfterTime(t);for(const e of this._propertyTracks)e.SetResumeState(t)}SetEndState(){if(!this.GetTimeline().IsComplete()&&(this.MaybeGetInstance(),(this.IsInstanceValid()||!this.IsInstanceTrack())&&!this._isNested)){const e=this._timeline.GetTime();e>=this.GetStartOffset()+this.GetLocalTotalTime()?this.Interpolate(this.GetLocalTotalTime(),!0,!1,!0,!1,!1,!0):e<=0&&this.Interpolate(0,!0,!1,!0,!1,!1,!0)}}_SetUpdateState(){for(let e=0,t=this._propertyTracks.length;e<t;e++){const t=this._propertyTracks[e];t._SetUpdateState(),0===this._worldInfoChange&&1===t.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===t.GetRenderChange()&&(this._renderChange=1)}}BeforeInterpolate(e,t=!1){const s=this._propertyTracks.length;for(let i=0;i<s;i++)this._propertyTracks[i].BeforeInterpolate(e,t)}Interpolate(e,t=!1,s=!1,i=!1,r=!1,n=!1,a=!1){this._instance||this.GetInstance();const o=this._instance&&!this._instance.IsDestroyed(),h=0===this._trackDataItem._type;if((o||!h)&&!(n&&h&&this.GetObjectClass().IsGlobal()||(e-=this.GetStartOffset())<0)){this.MaybeSetInitialStateOfNestedTrack(e,t),this.MaybeTriggerKeyframeReachedConditions(e,t,r),!this.GetTimeline().IsPlaying()&&this.GetTimeline().GetStoppedOnKeyframe()&&(e=this.GetTimeline().GetStoppedOnKeyframe().GetTime());for(let t=0,r=this._propertyTracks.length;t<r;t++)this._propertyTracks[t].Interpolate(e,s,i,a);this.MaybeSetEndStateOfNestedTrack(e,t),0!==this._worldInfoChange&&(this._worldInfo||(this._worldInfo=this._instance.GetWorldInfo()),this._worldInfo&&this._worldInfo.SetBboxChanged())}}AfterInterpolate(e,t=!1){const s=this._propertyTracks.length;for(let i=0;i<s;i++)this._propertyTracks[i].AfterInterpolate(e,t)}MaybeSetInitialStateOfNestedTrack(e,t){if(t&&this._isNested&&!this._initialStateOfNestedSet){if(this.GetTimeline().IsForwardPlayBack()){if(e<0)return}else if(e>this.GetLocalTotalTime())return;for(const e of this._propertyTracks)e.SetInitialState();this._initialStateOfNestedSet=!0}}MaybeSetEndStateOfNestedTrack(e,t){if(t&&this._isNested&&!this._endStateOfNestedSet)if(this.GetTimeline().IsForwardPlayBack()){if(e>=this.GetLocalTotalTime()){for(const e of this._propertyTracks)e.Interpolate(this.GetLocalTotalTime(),!1,!0);this._endStateOfNestedSet=!0}}else if(e<=0){for(const e of this._propertyTracks)e.Interpolate(0,!1,!0);this._endStateOfNestedSet=!0}}MaybeTriggerKeyframeReachedConditions(e,t,s){if(this._keyframeReachedOnCurrentTick=null,s)return;if(!t)return;if(!rG.Plugins.Timeline)return;const i=this.GetTimeline();if(i.IsForwardPlayBack()){const t=this._lastKeyframeDataItem.GetNext(),s=this._lastKeyframeDataItem.GetTime(),r=t?t.GetTime():i.GetTotalTime();(e<=s||e>=r)&&(this._lastKeyframeDataItem=this._trackData.GetFirstKeyFrameDataItemLowerOrEqualThan(e,this._trackDataItem),t&&this.OnKeyframeReached(this._lastKeyframeDataItem))}else{if(!this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(e,this._trackDataItem))return;this._lastKeyframeDataItem||(this._lastKeyframeDataItem=this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(e,this._trackDataItem));const t=this._lastKeyframeDataItem.GetLast(),s=this._lastKeyframeDataItem.GetTime(),i=t?t.GetTime():0;(e>=s||e<=i)&&(this._lastKeyframeDataItem=this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(e,this._trackDataItem),this._lastKeyframeDataItem&&this.OnKeyframeReached(this._lastKeyframeDataItem))}}_GetLastKeyFrameBeforeTime(e){return this._trackData.GetKeyFrameDataItemAtTime(e,this._trackDataItem)||this._trackData.GetFirstKeyFrameDataItemLowerOrEqualThan(e,this._trackDataItem)}_GetFirstKeyFrameAfterTime(e){return this._trackData.GetKeyFrameDataItemAtTime(e,this._trackDataItem)||this._trackData.GetFirstKeyFrameDataItemHigherOrEqualThan(e,this._trackDataItem)}OnKeyframeReached(e,t=!1){if(!rG.Plugins.Timeline)return;const s=this.GetTimeline(),i=s.GetTimelineManager();rG.Plugins.Timeline.Cnds.PushTriggerTimeline(s),rG.Plugins.Timeline.Cnds.PushTriggerKeyframe(e),i.Trigger(rG.Plugins.Timeline.Cnds.OnAnyKeyframeReached),i.Trigger(rG.Plugins.Timeline.Cnds.OnKeyframeReached),s.IsPlaying()||t||s.SetStoppedOnKeyframe(e),rG.Plugins.Timeline.Cnds.PopTriggerTimeline(s),rG.Plugins.Timeline.Cnds.PopTriggerKeyframe(e),this._keyframeReachedOnCurrentTick=e}WasKeyframeReachedOnCurrentTick(){return this._keyframeReachedOnCurrentTick}OnInitialKeyframeReached(e){this.OnKeyframeReached(e,!0)}AddKeyframe(){return this._trackDataItem.GetKeyframeData().AddEmptyKeyframeDataItem()}AddPropertyTrack(){const e=this._trackDataItem.GetPropertyTrackData().AddEmptyPropertyTrackDataItem(),t=rG.PropertyTrackState.Create(this,e);return this._propertyTracks.push(t),t}DeleteKeyframes(e){this._trackDataItem.GetKeyframeData().DeleteKeyframeDataItems(e)}DeletePropertyKeyframes(e){for(const t of this._propertyTracks)t.DeletePropertyKeyframes(e)}SaveState(){for(const e of this._propertyTracks)e.SaveState()}CompareInitialStateWithCurrent(){if(this.MaybeGetInstance(),this.IsInstanceValid()||!this.IsInstanceTrack())for(const e of this._propertyTracks)e.CompareInitialStateWithCurrent()}CompareSaveStateWithCurrent(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;let e=!1;for(const t of this._propertyTracks){const s=t.CompareSaveStateWithCurrent();!e&&s&&(e=!0)}if(e){const e=this.AddKeyframe();e.SetTime(this.GetTimeline().GetTime()),e.SetEase("noease"),e.SetEnable(!0),e.SetTags("")}}_OnAfterLoad(){isNaN(this._instanceUidToLoad)||this._LoadInstanceFromJson(this._instanceUidToLoad),this._instanceUidToLoad=NaN}_SaveToJson(){const e=this.GetInstance(),t=e?e.GetUID():this.GetInstanceUID();return{propertyTracksJson:this._SavePropertyTracksToJson(),lastKeyframeDataItemJson:this._SaveLastKeyframeDataItemToJson(),initialStateOfNestedSet:this._initialStateOfNestedSet,endStateOfNestedSet:this._endStateOfNestedSet,instanceUid:t,cleared:this._cleared}}_LoadFromJson(e){if(e){this._LoadPropertyTracksFromJson(e.propertyTracksJson),this._LoadLastKeyframeDataItemFromJson(e.lastKeyframeDataItemJson),this._instanceUidToLoad=e.instanceUid,this._initialStateOfNestedSet=!1,e.hasOwnProperty.initialStateOfNestedSet&&(this._initialStateOfNestedSet=e.initialStateOfNestedSet),this._endStateOfNestedSet=!1,e.hasOwnProperty.endStateOfNestedSet&&(this._endStateOfNestedSet=e.endStateOfNestedSet),this._cleared=!!e.hasOwnProperty("cleared")&&e.cleared;for(const e of this._propertyTracks)0===this._worldInfoChange&&1===e.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===e.GetRenderChange()&&(this._renderChange=1);this._needsBeforeAndAfter=0,this._propertyTracks.some(e=>e.GetNeedsBeforeAndAfter())&&(this._needsBeforeAndAfter=1)}}_SaveLastKeyframeDataItemToJson(){return this._trackDataItem.GetKeyframeData().GetKeyframeDataItemIndex(this._lastKeyframeDataItem)}_SavePropertyTracksToJson(){return this._propertyTracks.map(e=>e._SaveToJson())}_LoadPropertyTracksFromJson(e){e.forEach((e,t)=>{this._propertyTracks[t]._LoadFromJson(e)})}_LoadInstanceFromJson(e){if(!rG.IsFiniteNumber(e))return;const t=this.GetRuntime().GetInstanceByUID(e);t&&this.GetTimeline().SetTrackInstance(this._trackDataItem.GetId(),t,this.GetTrackIndexInTimeline())}_LoadLastKeyframeDataItemFromJson(e){const t=this._trackDataItem.GetKeyframeData();this._lastKeyframeDataItem=t.GetKeyframeDataItemFromIndex(e)}}}{const hG=self.C3;hG.PropertyTrackState=class extends hG.DefendedBase{constructor(e,t){super(),this._track=e,this._propertyTrackDataItem=t,this._propertyTrackData=t.GetPropertyTrackData(),this._worldInfoChange=0,this._renderChange=0,this._needsBeforeAndAfter=0,this._sourceAdapter=this.GetSourceAdapter(),this._propertyKeyframeDataItems=this._propertyTrackDataItem.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),this._lastPropertyKeyframeDataItem=null,this._absoluteValueObject=null}static Create(e,t){return hG.New(hG.PropertyTrackState,e,t)}Release(){this._track=null,this._sourceAdapter&&(this._sourceAdapter.Release(),this._sourceAdapter=null),this._propertyKeyframeDataItems=null,this._propertyTrackDataItem=null,this._propertyTrackData=null}GetWorldInfoChange(){return this._worldInfoChange}GetRenderChange(){return this._renderChange}GetNeedsBeforeAndAfter(){return this._needsBeforeAndAfter}HasAbsoluteValueObject(){return!!this._absoluteValueObject}SetAbsoluteValueObject(e){this._absoluteValueObject=e}GetAbsoluteValueObject(){return this._absoluteValueObject}GetTrack(){return this._track}GetPropertyTrackDataItem(){return this._propertyTrackDataItem}GetPropertyTrackData(){return this._propertyTrackData}GetTimeline(){return this._track.GetTimeline()}GetRuntime(){return this._track.GetRuntime()}GetInstance(){return this._track.GetInstance()}GetSourceAdapter(){if(this._sourceAdapter)return this._sourceAdapter;let e;switch(this._propertyTrackDataItem.GetSourceAdapterId()){case"behavior":e=new hG.PropertyTrackState.BehaviorSourceAdapter(this);break;case"effect":e=new hG.PropertyTrackState.EffectSourceAdapter(this),this._renderChange=1;break;case"instance-variable":e=new hG.PropertyTrackState.InstanceVariableSourceAdapter(this);break;case"plugin":e=new hG.PropertyTrackState.PluginSourceAdapter(this),this._renderChange=1;break;case"world-instance":e=new hG.PropertyTrackState.PropertySourceAdapter(this),this._renderChange=1,this._worldInfoChange=1;break;case"value":e=new hG.PropertyTrackState.ValueSourceAdapter(this);break;case"audio":e=new hG.PropertyTrackState.AudioSourceAdapter(this)}return this._sourceAdapter=e,this._sourceAdapter}GetSourceAdapterId(){return this._propertyTrackDataItem.GetSourceAdapterId()}SetSourceAdapterId(e){this._propertyTrackDataItem.SetSourceAdapterId(e)}GetSourceAdapterArgs(){return this._propertyTrackDataItem.GetSourceAdapterArguments()}SetSourceAdapterArgs(e){this._propertyTrackDataItem.SetSourceAdapterArguments(e)}GetSourceAdapterValue(){return this.GetSourceAdapter().GetValue()}GetPropertyName(){return this._propertyTrackDataItem.GetProperty()}SetPropertyName(e){this._propertyTrackDataItem.SetProperty(e)}GetPropertyType(){return this._propertyTrackDataItem.GetType()}SetPropertyType(e){this._propertyTrackDataItem.SetType(e)}GetPropertyKeyframeType(){return this.GetPropertyTrackData().GetFirstPropertyKeyframeDataItem(this._propertyTrackDataItem).GetType()}GetMin(){return this._propertyTrackDataItem.GetMin()}SetMin(e){this._propertyTrackDataItem.SetMin(e)}GetMax(){return this._propertyTrackDataItem.GetMax()}SetMax(e){this._propertyTrackDataItem.SetMax(e)}GetEnable(){return this._propertyTrackDataItem.GetEnable()}SetEnable(e){this._propertyTrackDataItem.SetEnable(e)}GetInterpolationMode(){return this._propertyTrackDataItem.GetInterpolationMode()}SetInterpolationMode(e){this._propertyTrackDataItem.SetInterpolationMode(e)}GetResultMode(){return this._propertyTrackDataItem.GetResultMode()}SetResultMode(e){this._propertyTrackDataItem.SetResultMode(e)}SetEase(e){for(const t of this.GetPropertyKeyframeDataItems())t.SetEase(e)}CanHavePropertyKeyframes(){return this._propertyTrackDataItem.CanHavePropertyKeyframes()}GetPropertyKeyframeDataItems(){return this._propertyKeyframeDataItems||(this._propertyKeyframeDataItems=this._propertyTrackDataItem.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray()),this._propertyKeyframeDataItems}GetPropertyKeyframeDataItemArrayIncludingDisabled(){return this._propertyTrackDataItem.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArrayIncludingDisabled()}GetPropertyKeyFrameDataItemAtTime(e){return this._propertyTrackData.GetPropertyKeyFrameDataItemAtTime(e,this._propertyTrackDataItem)}GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e){return this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem)}GetPropertyKeyframeDataItemPairForTime(e){let t,s=this._propertyTrackData.GetPropertyKeyFrameDataItemAtTime(e,this._propertyTrackDataItem);return s?t=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherThan(e,this._propertyTrackDataItem):(s=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem),t=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(e,this._propertyTrackDataItem)),{start:s,end:t}}*GetPropertyKeyframeValues(){for(const e of this.GetPropertyKeyframeDataItems())yield e.GetValueWithResultMode()}*GetPropertyKeyframeTimes(){for(const e of this.GetPropertyKeyframeDataItems())yield e.GetTime()}TimelineRemoved(){this.GetSourceAdapter().TimelineRemoved()}CleanCaches(){this.GetSourceAdapter().CleanCaches()}GetCurrentState(){return this.GetSourceAdapter().GetCurrentState()}SetResetState(){this.GetSourceAdapter().SetResetState()}SetInitialState(e){this.GetSourceAdapter().SetInitialState(),this._lastPropertyKeyframeDataItem=this._GetLastPropertyKeyFrameBeforeTime(e),this._SetUpdateState()}SetResumeState(e){this.GetSourceAdapter().SetResumeState(),this._lastPropertyKeyframeDataItem=this._GetLastPropertyKeyFrameBeforeTime(e)}_SetUpdateState(){const e=this.GetTrack();if(this._needsBeforeAndAfter=0,e.IsInstanceTrack()){const t=this.GetTimeline(),s=e.GetInstance(),i=this.GetSourceAdapter(),r=this.GetPropertyName();if(i.MayNeedBeforeAndAfterInterpolate()){const e=t.GetSimilarPropertyTracks(s,i,r,this);e&&e.length&&(this._needsBeforeAndAfter=1)}else this._needsBeforeAndAfter=0}}_GetLastPropertyKeyFrameBeforeTime(e){const t=this.GetTimeline();return this._propertyTrackData.GetPropertyKeyFrameDataItemAtTime(e,this._propertyTrackDataItem)||(t.IsForwardPlayBack()?this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem):this._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(e,this._propertyTrackDataItem))}BeforeInterpolate(e,t){let s,i;if(t)s=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem);else{if(this._lastPropertyKeyframeDataItem){const t=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():t.GetTotalTime();(e<=i||e>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem))}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem);s=this._lastPropertyKeyframeDataItem}s&&(i=s.GetNext()),this._sourceAdapter.BeforeInterpolate(s,i)}Interpolate(e,t=!1,s=!1,i=!1){let r,n,a=!1;if(t)r=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem);else{if(this._lastPropertyKeyframeDataItem){const t=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():t.GetTotalTime();(e<=i||e>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem),a=!0)}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem),a=!0;r=this._lastPropertyKeyframeDataItem}r&&(n=r.GetNext()),this._sourceAdapter.Interpolate(e,r,n,t,s,i,a)}GetInterpolatedValue(e){if(this._lastPropertyKeyframeDataItem){const t=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():t.GetTotalTime();(e<=i||e>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem))}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem);const t=this._lastPropertyKeyframeDataItem,s=t.GetNext();return this._sourceAdapter.GetInterpolatedValue(e,t,s)}GetInterpolatedValueFast(e,t,s){return this._sourceAdapter.GetInterpolatedValue(e,t,s)}AfterInterpolate(e,t){let s,i;if(t)s=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem);else{if(this._lastPropertyKeyframeDataItem){const t=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():t.GetTotalTime();(e<=i||e>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem))}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem);s=this._lastPropertyKeyframeDataItem}s&&(i=s.GetNext()),this._sourceAdapter.AfterInterpolate(s,i)}static GetStartPropertyKeyframeForTime(e,t){const s=t.GetPropertyTrackDataItem();return t._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,s)}static GetEndPropertyKeyframeForTime(e,t){const s=t.GetPropertyTrackDataItem();return t._propertyTrackData.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(e,s)}static GetPropertyKeyframeValueWithPlaybackDirection(e,t,s){return t?s.GetTimeline().IsForwardPlayBack()?e.GetValueWithResultMode():t.GetValueWithResultMode():e.GetValueWithResultMode()}AddPropertyKeyframe(){const e=this._propertyTrackDataItem.GetPropertyKeyframeData().AddEmptyPropertyKeyframeDataItem();return this._lastPropertyKeyframeDataItem=null,e}DeletePropertyKeyframes(e){this._lastPropertyKeyframeDataItem=null,this._propertyTrackDataItem.GetPropertyKeyframeData().DeletePropertyKeyframeDataItems(e)}SaveState(){this.GetSourceAdapter().SaveState()}CompareInitialStateWithCurrent(){if(this.GetSourceAdapter().CompareInitialStateWithCurrent()){const e=this._propertyTrackData.GetFirstPropertyKeyframeDataItem(this._propertyTrackDataItem),t=this.GetSourceAdapter().GetCurrentState();e.SetAbsoluteValue(t)}}CompareSaveStateWithCurrent(){const e=this.GetSourceAdapter().CompareSaveStateWithCurrent();return e&&this.AddPropertyKeyframeAtCurrentTime(),this.GetSourceAdapter().ClearSaveState(),e}AddPropertyKeyframeAtCurrentTime(){const e=this.GetTimeline().GetTime(),t=this.GetSourceAdapter(),s=hG.PropertyTrackState.GetStartPropertyKeyframeForTime(e,this),i=this.AddPropertyKeyframe();i.SetType(s.GetType()),i.SetTime(e),i.SetEase(s.GetEase()),i.SetEnable(!0),i.SetValue(t.GetValueAtTime()),i.SetAbsoluteValue(t.GetCurrentState())}_SaveToJson(){return{sourceAdapterJson:this.GetSourceAdapter()._SaveToJson()}}_LoadFromJson(e){e&&this.GetSourceAdapter()._LoadFromJson(e.sourceAdapterJson)}}}{const lG=self.C3,cG=lG.PropertyTrackState;cG.PropertySourceAdapter=class{constructor(e){this._propertyTrack=e,this._propertyAdapter=null,this.GetPropertyAdapter()}Release(){this._propertyAdapter&&(this._propertyAdapter.Release(),this._propertyAdapter=null),this._propertyTrack=null}MayNeedBeforeAndAfterInterpolate(){return this._propertyAdapter.MayNeedBeforeAndAfterInterpolate()}GetPropertyTrack(){return this._propertyTrack}TimelineRemoved(){this._propertyAdapter&&this._propertyAdapter.TimelineRemoved()}CleanCaches(){this._propertyAdapter&&this._propertyAdapter.CleanCaches()}GetPropertyAdapter(){return this._propertyAdapter||(this._propertyAdapter=this._CreatePropertyAdapter()),this._propertyAdapter}GetEditorIndex(){}GetIndex(){return this.GetEditorIndex()}GetTarget(){}SetResetState(){this.GetPropertyAdapter().SetResetState()}SetInitialState(){this.GetPropertyAdapter().SetInitialState()}SetResumeState(){this.GetPropertyAdapter().SetResumeState()}BeforeInterpolate(e,t){this._propertyAdapter.BeforeChangeProperty(e,t)}Interpolate(e,t,s,i,r,n,a){let o;switch(this._propertyTrack.GetPropertyKeyframeType()){case"numeric":o=cG.NumericTypeAdapter.Interpolate(e,t,s,this._propertyTrack);break;case"angle":o=cG.AngleTypeAdapter.Interpolate(e,t,s,this._propertyTrack);break;case"boolean":o=cG.BooleanTypeAdapter.Interpolate(e,t,s,this._propertyTrack);break;case"color":o=cG.ColorTypeAdapter.Interpolate(e,t,s,this._propertyTrack);break;case"text":o=cG.TextTypeAdapter.Interpolate(e,t,s,this._propertyTrack)}this._propertyAdapter.ChangeProperty(e,o,t,s,i,r,n,a)}GetInterpolatedValue(e,t,s){switch(this._propertyTrack.GetPropertyKeyframeType()){case"numeric":return cG.NumericTypeAdapter.Interpolate(e,t,s,this._propertyTrack);case"angle":return cG.AngleTypeAdapter.Interpolate(e,t,s,this._propertyTrack);case"boolean":return cG.BooleanTypeAdapter.Interpolate(e,t,s,this._propertyTrack);case"color":return cG.ColorTypeAdapter.Interpolate(e,t,s,this._propertyTrack);case"text":return cG.TextTypeAdapter.Interpolate(e,t,s,this._propertyTrack)}}AfterInterpolate(e,t){this._propertyAdapter.AfterChangeProperty(e,t)}SaveState(){this.GetPropertyAdapter().SetSaveState()}ClearSaveState(){this.GetPropertyAdapter().ClearSaveState()}GetCurrentState(){return this.GetPropertyAdapter().GetCurrentState()}CompareInitialStateWithCurrent(){return this.GetPropertyAdapter().CompareInitialStateWithCurrent()}CompareSaveStateWithCurrent(){return this.GetPropertyAdapter().CompareSaveStateWithCurrent()}GetValueAtTime(){const e=this._propertyTrack,t=e.GetTrack().GetTimeline().GetTime(),s=cG.GetStartPropertyKeyframeForTime(t,e),i=s.GetNext();switch(e.GetPropertyKeyframeType()){case"numeric":return cG.NumericTypeAdapter.Interpolate(t,s,i,e);case"angle":return cG.AngleTypeAdapter.Interpolate(t,s,i,e);case"boolean":return cG.BooleanTypeAdapter.Interpolate(t,s,i,e);case"color":return cG.ColorTypeAdapter.Interpolate(t,s,i,e);case"text":return cG.TextTypeAdapter.Interpolate(t,s,i,e)}}_CreatePropertyAdapter(){const e=this._propertyTrack;switch(e.CanHavePropertyKeyframes()?e.GetPropertyKeyframeType():""){case"combo":case"boolean":case"text":case"string":return new cG.PropertyInterpolationAdapter.NoInterpolationAdapter(this);case"numeric":case"number":case"angle":return"combo"===this._propertyTrack.GetPropertyType()?new cG.PropertyInterpolationAdapter.NoInterpolationAdapter(this):new cG.PropertyInterpolationAdapter.NumericInterpolationAdapter(this);case"color":case"offsetColor":return new cG.PropertyInterpolationAdapter.ColorInterpolationAdapter(this);default:return new cG.PropertyInterpolationAdapter.NumericInterpolationAdapter(this)}}_SaveToJson(){return{propertyAdapterJson:this.GetPropertyAdapter()._SaveToJson()}}_LoadFromJson(e){e&&this.GetPropertyAdapter()._LoadFromJson(e.propertyAdapterJson)}}}{const uG=self.C3,dG=0;class _G extends uG.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e),this._updatedIndex=NaN}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]}GetIndex(){return this._updatedIndex?this._updatedIndex:super.GetIndex()}GetTarget(){return this._propertyTrack.GetTrack().GetInstance()}UpdateInstanceVariableIndex(e){this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]!==e&&(this._updatedIndex=e)}Interpolate(e,t,s,i,r,n,a){this.GetPropertyAdapter().CanChange(t.GetValue())&&super.Interpolate(e,t,s,i,r,n,a)}GetInterpolatedValue(e,t,s){if(this.GetPropertyAdapter().CanChange(t.GetValue()))return super.GetInterpolatedValue(e,t,s)}_SaveToJson(){return Object.assign(super._SaveToJson(),{index:this._updatedIndex})}_LoadFromJson(e){e&&(super._LoadFromJson(e),this._updatedIndex=e.index)}}uG.PropertyTrackState.InstanceVariableSourceAdapter=_G}{const pG=self.C3,fG=0,mG=1,gG=2;class SG extends pG.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e),this._sid=NaN}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[1]}GetTarget(){const e=this._propertyTrack.GetPropertyTrackDataItem(),t=this._propertyTrack.GetTrack(),s=this._sid?this._sid:e.GetSourceAdapterArguments()[0],i=t.GetInstance(),r=i.GetBehaviorIndexBySID(s);return i.GetBehaviorInstances()[r].GetSdkInstance()}GetBehaviorType(e){const t=this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[2];return e.GetBehaviorTypeByName(t)}UpdateBehaviorTypeSid(e){this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]!==e&&(this._sid=e)}Interpolate(e,t,s,i,r,n,a){const o=this._propertyTrack.GetTrack().GetInstance();this.GetBehaviorType(o.GetObjectClass())&&super.Interpolate(e,t,s,i,r,n,a)}GetInterpolatedValue(e,t,s){const i=this._propertyTrack.GetTrack().GetInstance();if(this.GetBehaviorType(i.GetObjectClass()))return super.GetInterpolatedValue(e,t,s)}_SaveToJson(){return Object.assign(super._SaveToJson(),{sid:this._sid})}_LoadFromJson(e){e&&(super._LoadFromJson(e),this._sid=e.sid)}}pG.PropertyTrackState.BehaviorSourceAdapter=SG}{const GG=self.C3,yG=0,IG=1;class TG extends GG.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e)}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[1]}GetTarget(){const e=this._propertyTrack.GetTrack().GetWorldInfo().GetInstanceEffectList(),t=e.GetEffectList(),s=this.GetEffectType(t).GetIndex();return e.IsEffectIndexActive(s)?e.GetEffectParametersForIndex(s):null}GetEffectType(e){const t=this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0];return e.GetEffectTypeByName(t)}Interpolate(e,t,s,i,r,n,a){this._IsEffectActive()&&super.Interpolate(e,t,s,i,r,n,a)}GetInterpolatedValue(e,t,s){if(this._IsEffectActive())return super.GetInterpolatedValue(e,t,s)}_IsEffectActive(){const e=this._propertyTrack.GetTrack().GetWorldInfo().GetInstanceEffectList(),t=e.GetEffectList(),s=this.GetEffectType(t);if(!s)return;const i=s.GetIndex();return e.IsEffectIndexActive(i)}}GG.PropertyTrackState.EffectSourceAdapter=TG}{const CG=self.C3,bG=0,xG=1,wG=0;class PG extends CG.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e),this._optionalCallbacksRelative=null,this._optionalCallbacksAbsolute=null,this._forceNextChange=!1}GetEditorIndex(){return this._propertyTrack.GetPropertyTrackDataItem().GetSourceAdapterArguments()[0]}GetTarget(){return this._propertyTrack.GetTrack().GetInstance().GetSdkInstance()}Interpolate(e,t,s,i,r,n,a){const o=this._propertyTrack.GetTrack();o.GetObjectClass().GetPlugin()===o.GetInstance().GetObjectClass().GetPlugin()&&super.Interpolate(e,t,s,i,r,n,a)}GetInterpolatedValue(e,t,s){const i=this._propertyTrack.GetTrack();if(i.GetObjectClass().GetPlugin()===i.GetInstance().GetObjectClass().GetPlugin())return super.GetInterpolatedValue(e,t,s)}_IsTimelineChunkDiscreteLike(e,t){if(!t)return!0;if(e?.GetValueWithResultMode()===t?.GetValueWithResultMode())return!0;const s=this._propertyTrack?.GetInterpolationMode();return"discrete"===s}_WasKeyframeReached(e,t,s){const i=e.WasKeyframeReachedOnCurrentTick();return!!i&&(this._propertyTrack.GetTimeline().IsForwardPlayBack()?i.GetTime()===t.GetTime():i.GetTime()===s.GetTime())}SetResetState(){this.GetPropertyAdapter().SetResetState();const e=this._propertyTrack.GetTrack().GetObjectClass().GetPlugin();this._forceNextChange=!1,CG.Plugins.Sprite&&e instanceof CG.Plugins.Sprite&&"initial-animation"===this._propertyTrack.GetPropertyName()&&(this._forceNextChange=!0)}ForceChanges(){const e=this._forceNextChange;return this._forceNextChange=!1,e}GetOptionalCallbacks(e,t){const s=this._propertyTrack.GetTrack(),i=s.GetObjectClass().GetPlugin();if(CG.Plugins.Sprite&&i instanceof CG.Plugins.Sprite&&("initial-frame"===this._propertyTrack.GetPropertyName()||"initial-animation"===this._propertyTrack.GetPropertyName()))switch(this._propertyTrack.GetResultMode()){case"relative":return this._optionalCallbacksRelative?(this._optionalCallbacksRelative.startFrom=e.GetAddOn("initial-animation")?.GetStartFrom()??0,this._optionalCallbacksRelative.keyframeReached=this._WasKeyframeReached(s,e,t),this._optionalCallbacksRelative.isChunkDiscreteLike=this._IsTimelineChunkDiscreteLike(e,t),this._optionalCallbacksRelative):(this._optionalCallbacksRelative={onFrameChange:(e,t,i,r,n)=>{if(t!==r){const i=r/t,n=s.GetPropertyTrack("offsetWidth"),a=s.GetPropertyTrack("offsetScaleX");if(n||a){const o=n?.GetSourceAdapter()?.GetPropertyAdapter(),h=a?.GetSourceAdapter()?.GetPropertyAdapter();if(e.HasParent()&&e.GetTransformWithParentWidth())h&&h.SetOriginalSizeProperty(r),e.SetWidth(this.GetNewWidth(r,t,e,s,o,h));else{const t=r*((e._GetSceneGraphInfo()?._GetStartWidth()??this.GetInstanceOriginalWidth(e,s))/this.GetInstanceOriginalWidth(e,s));h&&h.SetOriginalSizeProperty(r);const n=o?.GetChangeAccumulatorProperty()??0,a=h?.GetChangeAccumulatorProperty()??0;e.SetWidth(t+(n+a*i))}}else e.SetWidth(e.GetWidth()*i)}if(i!==n){const t=n/i,r=s.GetPropertyTrack("offsetHeight"),a=s.GetPropertyTrack("offsetScaleY");if(r||a){const o=r?.GetSourceAdapter()?.GetPropertyAdapter(),h=a?.GetSourceAdapter()?.GetPropertyAdapter();if(e.HasParent()&&e.GetTransformWithParentHeight())h&&h.SetOriginalSizeProperty(n),e.SetHeight(this.GetNewHeight(n,i,e,s,o,h));else{const i=n*((e._GetSceneGraphInfo()?._GetStartHeight()??this.GetInstanceOriginalHeight(e,s))/this.GetInstanceOriginalHeight(e,s));h&&h.SetOriginalSizeProperty(n);const r=o?.GetChangeAccumulatorProperty()??0,a=h?.GetChangeAccumulatorProperty()??0;e.SetHeight(i+(r+a*t))}}else e.SetHeight(e.GetHeight()*t)}},startFrom:e.GetAddOn("initial-animation")?.GetStartFrom()??0,keyframeReached:this._WasKeyframeReached(s,e,t),isChunkDiscreteLike:this._IsTimelineChunkDiscreteLike(e,t)},this._optionalCallbacksRelative);case"absolute":return this._optionalCallbacksAbsolute?(this._optionalCallbacksAbsolute.startFrom=e.GetAddOn("initial-animation")?.GetStartFrom()??0,this._optionalCallbacksAbsolute.keyframeReached=this._WasKeyframeReached(s,e,t),this._optionalCallbacksAbsolute.isChunkDiscreteLike=this._IsTimelineChunkDiscreteLike(e,t),this._optionalCallbacksAbsolute):(this._optionalCallbacksAbsolute={startFrom:e.GetAddOn("initial-animation")?.GetStartFrom()??0,keyframeReached:this._WasKeyframeReached(s,e,t),isChunkDiscreteLike:this._IsTimelineChunkDiscreteLike(e,t)},this._optionalCallbacksAbsolute)}}GetLastPropertyKeyframeValue(e,t,s,i=0){const r=t.GetTimeline().GetTrackFromInstance(e.GetInstance());if(!r)return i;const n=r.GetPropertyTrack(s);if(!n)return i;const a=n.GetPropertyTrackDataItem().GetPropertyKeyframeData();if(!a)return i;const o=a.GetLastPropertyKeyframeDataItem();return o?o.GetValue():i}GetInstanceOriginalWidth(e,t){const s=t.GetTimeline().GetTrackFromInstance(e.GetInstance());if(s)return s.GetOriginalWidth();const i=e.GetInstance().GetSdkInstance();return i.IsOriginalSizeKnown()?i.GetOriginalWidth():e._GetSceneGraphInfo()._GetStartWidth()}GetInstanceOriginalHeight(e,t){const s=t.GetTimeline().GetTrackFromInstance(e.GetInstance());if(s)return s.GetOriginalHeight();const i=e.GetInstance().GetSdkInstance();return i.IsOriginalSizeKnown()?i.GetOriginalHeight():e._GetSceneGraphInfo()._GetStartHeight()}GetNewWidth(e,t,s,i,r,n){const a=s._GetSceneGraphInfo()._GetStartWidth(),o=a/s.GetParent()._GetSceneGraphInfo()._GetStartWidth();let h=1;const l=n?.GetAbsoluteScaleXOffsetProperty()??0;if(0!==l){const e=a/this.GetInstanceOriginalWidth(s,i);h=(e+l)/(0===e?Number.EPSILON:e)}const c=a*(e/t);let u=r?.GetAbsoluteWidthOffsetProperty()??0;u+=c-a;const d=(a+u)/(0===a?Number.EPSILON:a);return s.GetParent().GetWidth()*o*h*d}GetNewHeight(e,t,s,i,r,n){const a=s._GetSceneGraphInfo()._GetStartHeight(),o=a/s.GetParent()._GetSceneGraphInfo()._GetStartHeight();let h=1;const l=n?.GetAbsoluteScaleYOffsetProperty()??0;if(0!==l){const e=a/this.GetInstanceOriginalHeight(s,i);h=(e+l)/(0===e?Number.EPSILON:e)}const c=a*(e/t);let u=r?.GetAbsoluteHeightOffsetProperty()??0;u+=c-a;const d=(a+u)/(0===a?Number.EPSILON:a);return s.GetParent().GetHeight()*o*h*d}}CG.PropertyTrackState.PluginSourceAdapter=PG}{const RG=self.C3;class vG extends RG.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e),this._value=0,this._init=!1}MayNeedBeforeAndAfterInterpolate(){return!1}SetInitialState(){const e=this._propertyTrack.GetPropertyTrackData();let t=this._propertyTrack.GetPropertyTrackDataItem();t=e.GetFirstPropertyKeyframeDataItem(t),this._value=t.GetValueWithResultMode()}SetResumeState(){}GetValue(){return this._init||this._propertyTrack.Interpolate(0),this._value}Interpolate(e,t,s,i,r,n,a){this._value=RG.PropertyTrackState.NumericTypeAdapter.Interpolate(e,t,s,this._propertyTrack),this._init=!0}SaveState(){}ClearSaveState(){}GetCurrentState(){return this._value}CompareInitialStateWithCurrent(){return!1}CompareSaveStateWithCurrent(){return!1}_SaveToJson(){return{value:this._value,init:this._init}}_LoadFromJson(e){e&&(this._value=e.value,this._init=!e.hasOwnProperty("init")||e.init)}}RG.PropertyTrackState.ValueSourceAdapter=vG}{const AG=self.C3,MG=0,DG=0,EG=1,FG=1,OG=2,BG=3;class kG extends AG.PropertyTrackState.PropertySourceAdapter{constructor(e){super(e),this._audioPlaybackStarted=!1,this._sdkInstance=null,this._actions=null,this._expressions=null,this._timeline=this._propertyTrack.GetTimeline(),this._track=this._propertyTrack.GetTrack(),this._sourceAdapterArgs=this._propertyTrack.GetSourceAdapterArgs(),this._fileArgs=this._sourceAdapterArgs[0],this._startOffsetTime=this._sourceAdapterArgs[1],this._sourceAdapterArgs[3]?this._audioTag=this._sourceAdapterArgs[3]:this._audioTag=Math.random().toString(36).slice(2),this._pauseTime=NaN,this._pauseVolume=NaN,this._volume=NaN,this._audioSource=null,this._Initialize()}Release(){super.Release(),this._sdkInstance=null,this._actions=null,this._expressions=null,this._timeline=null,this._track=null,this._sourceAdapterArgs=null,this._fileArgs=null,this._audioSource=null}_Initialize(){if(!self.C3.Plugins.Audio)return;const e=this._propertyTrack.GetRuntime().GetSingleGlobalObjectClassByCtor(self.C3.Plugins.Audio);e&&(this._sdkInstance=e.GetSingleGlobalInstance().GetSdkInstance()),this._actions=self.C3.Plugins.Audio.Acts,this._expressions=self.C3.Plugins.Audio.Exps}_MaybeSetAudioSource(){if(this._audioSource)return;const e=this._propertyTrack.GetTrack().GetPropertyTrack("audioSource");e&&(this._audioSource=e.GetSourceAdapter())}_GetPauseVolume(){const e=this._propertyTrack.GetTrack().GetPropertyTrack("volume");return e?e.GetSourceAdapter()._pauseVolume:this._pauseVolume}TimelineRemoved(){super.TimelineRemoved(),this._audioPlaybackStarted=!1,this._sdkInstance&&(this._expressions&&(this._pauseTime=this._expressions.PlaybackTime.call(this._sdkInstance,this._audioTag),this._pauseVolume=this._expressions.Volume.call(this._sdkInstance,this._audioTag)),this._actions&&this._actions.Stop.call(this._sdkInstance,this._audioTag))}GetAudioTag(){return this._audioTag}GetVolume(){return this._volume}SetVolume(e){this._volume=e}SetInitialState(){super.SetInitialState(),this._pauseTime=NaN,this._audioPlaybackStarted=!1}SetResumeState(){super.SetResumeState();const e=this._propertyTrack.GetTimeline().GetTime();switch(this._pauseTime=e-this._startOffsetTime,this._propertyTrack.GetPropertyName()){case"audioSource":break;case"volume":this._pauseVolume=this._propertyTrack.GetInterpolatedValue(e)}this._audioPlaybackStarted=!1}Interpolate(e,t,s,i,r,n,a){if(this._sdkInstance)switch(this._propertyTrack.GetPropertyName()){case"audioSource":{if(!this._timeline.IsForwardPlayBack())return;if(i)return void(this._actions&&this._actions.Stop.call(this._sdkInstance,this._audioTag));if(e<this._startOffsetTime)return void(this._audioPlaybackStarted=!1);const t=this._expressions.PlaybackRate.call(this._sdkInstance,this._audioTag),s=this._timeline.GetPlaybackRate();if(s!==t&&this._actions.SetPlaybackRate.call(this._sdkInstance,this._audioTag,s),this._audioPlaybackStarted)return;if(!this._propertyTrack.GetTimeline().IsPlaying())return;if(this._audioPlaybackStarted=!0,isNaN(this._pauseTime)){const t=self.performance.now(),s=e-this._startOffsetTime;if("suspended"===this._sdkInstance.GetAudioContextState())return void(this._audioPlaybackStarted=!1);const i=s+(self.performance.now()-t)/1e3;if(this._actions){let e=this.GetVolume();isNaN(e)?(this.SetVolume(0),e=0):this.SetVolume(e),this._actions.PlayFromTimeline.call(this._sdkInstance,this._fileArgs,e,this._audioTag,i)}}else{const e=this._pauseTime;this._pauseTime=NaN;const t=this._GetPauseVolume();if(this._pauseVolume=NaN,"suspended"===this._sdkInstance.GetAudioContextState())return void(this._audioPlaybackStarted=!1);this._actions&&(this.SetVolume(t),this._actions.PlayFromTimeline.call(this._sdkInstance,this._fileArgs,t,this._audioTag,e))}break}case"volume":this._MaybeSetAudioSource(),super.Interpolate(e,t,s,i,r,n,a)}}GetInterpolatedValue(e,t,s){if(this._sdkInstance)switch(this._propertyTrack.GetPropertyName()){case"audioSource":return;case"volume":return this._MaybeSetAudioSource(),super.GetInterpolatedValue(e,t,s)}}Getter(e,t){return this._audioSource?this._audioSource.GetVolume():0}Setter(e,t,s,i){this._audioSource&&this._audioSource.SetVolume(this.Getter()+t),this._actions&&this._audioSource&&this._actions.SetVolume.call(this._sdkInstance,this._audioSource.GetAudioTag(),this._audioSource.GetVolume())}AbsoluteSetter(e,t,s){this._audioSource&&this._audioSource.SetVolume(t),this._actions&&this._audioSource&&this._actions.SetVolume.call(this._sdkInstance,this._audioSource.GetAudioTag(),this._audioSource.GetVolume())}DoesRounding(){return!0}_SaveToJson(){return{audioPlaybackStarted:this._audioPlaybackStarted,audioTag:this._audioTag,pauseTime:this._pauseTime,pauseVolume:this._pauseVolume,volume:this._volume}}_LoadFromJson(e){e&&(this._audioPlaybackStarted=e.audioPlaybackStarted,this._audioTag=e.audioTag,this._pauseTime=e.pauseTime,this._pauseVolume=e.pauseVolume,this._volume=e.volume,this._Initialize())}}AG.PropertyTrackState.AudioSourceAdapter=kG}{const LG=self.C3;LG.PropertyTrackState.PropertyInterpolationAdapter=class{constructor(e){this._sourceAdapter=e,this._propertyTrack=e.GetPropertyTrack(),this._worldInfo=this._propertyTrack.GetTrack().GetWorldInfo(),this._property=this._propertyTrack.GetPropertyName(),this._firstAbsoluteUpdate=!1,this._saveState=null,this._target=null}Release(){this._sourceAdapter=null,this._propertyTrack=null,this._worldInfo=null,this._saveState=null,this._target=null}MayNeedBeforeAndAfterInterpolate(){return!1}TimelineRemoved(){}CleanCaches(){this._worldInfo=null,this._saveState=null,this._target=null}GetSourceAdapter(){return this._sourceAdapter}GetPropertyTrack(){return this._propertyTrack}GetWorldInfo(){return this._worldInfo||(this._worldInfo=this._propertyTrack.GetTrack().GetWorldInfo()),this._worldInfo}SetFirstAbsoluteUpdate(e){this._firstAbsoluteUpdate=!!e}GetFirstAbsoluteUpdate(){return this._firstAbsoluteUpdate}SetResetState(){}SetInitialState(){}SetResumeState(){}SetSaveState(){this._saveState=this.GetCurrentState()}ClearSaveState(){this._saveState=null}GetCurrentState(){}CompareInitialStateWithCurrent(){}CompareSaveStateWithCurrent(){}CanChange(e){return typeof this._Getter()==typeof e}BeforeChangeProperty(e,t){}ChangeProperty(e,t,s,i,r,n,a,o){}AfterChangeProperty(e,t){}_FirstKeyframeGetter(){return this._PickTimelinePlaybackMode(()=>{const e=this._propertyTrack.GetPropertyTrackDataItem();return this._propertyTrack.GetPropertyTrackData().GetFirstPropertyKeyframeDataItem(e)},()=>{const e=this._propertyTrack.GetPropertyTrackDataItem();return this._propertyTrack.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e)}).GetAbsoluteValue()}_CurrentKeyframeGetter(){const e=this._propertyTrack.GetTimeline().GetTime()-this._propertyTrack.GetTrack().GetStartOffset();return this._PickTimelinePlaybackMode(()=>{const t=this._propertyTrack.GetPropertyTrackDataItem();return this._propertyTrack.GetPropertyTrackData().GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,t)},()=>{const t=this._propertyTrack.GetPropertyTrackDataItem(),s=this._propertyTrack.GetPropertyTrackData();return s.GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(e,t)||s.GetLastPropertyKeyframeDataItem(t)}).GetAbsoluteValue()}_PickTimelinePlaybackMode(e,t){return this._propertyTrack.GetTimeline().IsForwardPlayBack()?e():t()}_PickResultMode(e,t){return"relative"===this._propertyTrack.GetResultMode()?e():t()}_PickFirstAbsoluteUpdate(e,t){return this.GetFirstAbsoluteUpdate()?(this.SetFirstAbsoluteUpdate(!1),e()):t()}_GetAbsoluteInitialValue(e){}_GetIndex(){return this._sourceAdapter.GetIndex()}_GetTarget(){return this._target||(this._target=this._sourceAdapter.GetTarget()),this._target}_PickSource(e,t,s,i,r,n){switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":return e();case"effect":return t();case"instance-variable":return s();case"plugin":return i();case"world-instance":return r();case"audio":return n()}}_SaveToJson(){return{firstAbsoluteUpdate:this._firstAbsoluteUpdate,saveState:this._saveState}}_LoadFromJson(e){e&&(this._firstAbsoluteUpdate=e.firstAbsoluteUpdate,this._saveState=e.saveState)}_GetPropertyKeyframeStubs(e,t=!1){const s=[];for(const i of e){const e=i.GetTrack().GetStartOffset();for(const r of i.GetPropertyKeyframeDataItems())t&&0===r.GetTime()?s.push({time:e+r.GetTime(),value:r.GetAbsoluteValue()}):t||s.push({time:e+r.GetTime(),value:r.GetAbsoluteValue()})}return s.sort((e,t)=>e.time-t.time)}_GetLastPropertyKeyframeStub(e,t,s){return this._GetPropertyKeyframeStubLowerThanPlayhead(t,s)}_GetPropertyKeyframeStubLowerThanPlayhead(e,t){for(let s=t.length-1;s>=0;s--)if(t[s].time<=e)return t[s];return null}}}{const NG=self.C3,WG=new Map,UG=[0,0,0];class VG extends NG.PropertyTrackState.PropertyInterpolationAdapter{constructor(e){super(e)}SetResetState(){}SetInitialState(){}SetResumeState(){}GetCurrentState(){const e=this._propertyTrack.GetSourceAdapterId(),t=this._GetTarget(),s=this._GetIndex();switch(e){case"behavior":case"plugin":return this._ToColorArray(t.GetPropertyValueByIndex(s));case"effect":return this._ToColorArray(t[s]);case"world-instance":return this._ToColorArray(this._Getter())}}CompareInitialStateWithCurrent(){const e=this._FirstKeyframeGetter();return!this._CompareColors(e,this._Getter())}CompareSaveStateWithCurrent(){return!NG.IsNullOrUndefined(this._saveState)&&!this._CompareColors(this._saveState,this._Getter())}_CompareColors(e,t){return e=this._GetColorFromArray(e),t=this._GetColorFromArray(t),e.equalsIgnoringAlpha(t)}_FirstKeyframeGetter(){const e=super._FirstKeyframeGetter();return this._GetColorFromArray(e)}_CurrentKeyframeGetter(){const e=super._CurrentKeyframeGetter();return this._GetColorFromArray(e)}_GetAbsoluteInitialValue(e){}_ToColorArray(e){return NG.IsInstanceOf(e,NG.Color)?e.toArray().slice(0,3):e.slice(0,3)}_GetColorFromArray(e){return NG.IsInstanceOf(e,NG.Color)?e:new NG.Color(e[0],e[1],e[2],1)}CanChange(e){return!0}MayNeedBeforeAndAfterInterpolate(){return!0}BeforeChangeProperty(){const e=this._propertyTrack.GetTimeline(),t=this._propertyTrack.GetInstance(),s=this._propertyTrack.GetSourceAdapter(),i=e.GetSimilarPropertyTracks(t,s,this._property,this._propertyTrack);if(i&&i.length>1){WG.has(t)||WG.set(t,new Map);const e=WG.get(t),s=this._propertyTrack.GetSourceAdapterId();e.has(s)||e.set(s,new Map);const i=e.get(s);i.has(this._property)||i.set(this._property,{used:!1,color:new NG.Color(0,0,0,1)})}}_GetTmpColor(e,t,s){const i=WG.get(e).get(t).get(s);return i.used=!0,i.color}ChangeProperty(e,t,s,i,r,n,a,o){const h=this._propertyTrack.GetTimeline(),l=this._propertyTrack.GetTrack(),c=this._propertyTrack.GetInstance(),u=this._propertyTrack.GetSourceAdapter(),d=this._propertyTrack.GetSourceAdapterId(),_=this._property,p=h.GetSimilarPropertyTracks(c,u,_,this._propertyTrack);if(p&&p.length>1){const e=this._GetPropertyKeyframeStubs(p,!0),s=this._GetLastPropertyKeyframeStub(h,h.GetTime(),e);if(s){const e=l.GetStartOffset(),i=s.time-e;if(0===i)this._GetTmpColor(c,d,this._property).addRgb(t[0],t[1],t[2]);else{if(i<0)return;const e=t[0],s=t[1],r=t[2],n=this._propertyTrack.Interpolate(i,!1,!0),a=NG.Color.DiffChannel(e,n[0]),o=NG.Color.DiffChannel(s,n[1]),h=NG.Color.DiffChannel(r,n[2]);this._GetTmpColor(c,d,this._property).addRgb(a,o,h)}}}else this._Setter(t[0],t[1],t[2])}AfterChangeProperty(){const e=this._propertyTrack.GetInstance();if(!WG.has(e))return;const t=WG.get(e),s=this._propertyTrack.GetSourceAdapterId();if(!t.has(s))return;const i=t.get(s);if(!i.has(this._property))return;const r=i.get(this._property),n=r.used,a=r.color;n&&this._Setter(a.getR(),a.getG(),a.getB()),0===i.size&&t.delete(s),0===t.size&&WG.delete(e)}_Getter(){const e=this._propertyTrack.GetSourceAdapterId(),t=this._GetTarget(),s=this._GetIndex();switch(e){case"behavior":case"plugin":return this._GetColorFromArray(t.GetPropertyValueByIndex(s));case"effect":return t[s].clone();case"world-instance":return this.GetWorldInfo().GetUnpremultipliedColor().clone()}}_Setter(e,t,s){const i=this._propertyTrack.GetSourceAdapterId(),r=this._GetTarget(),n=this._GetIndex();switch(i){case"behavior":case"plugin":UG[0]=e,UG[1]=t,UG[2]=s,r.SetPropertyValueByIndex(n,UG);break;case"effect":r[n].setRgb(e,t,s);break;case"world-instance":this.GetWorldInfo().SetUnpremultipliedColorRGB(e,t,s)}}_SaveToJson(){}_LoadFromJson(e){}}NG.PropertyTrackState.PropertyInterpolationAdapter.ColorInterpolationAdapter=VG}{const HG=self.C3,jG=HG.PropertyTrackState;class zG extends HG.PropertyTrackState.PropertyInterpolationAdapter{constructor(e){super(e)}SetResetState(){}SetInitialState(){}SetResumeState(){}GetCurrentState(){return this._Getter()}CompareInitialStateWithCurrent(){return this._FirstKeyframeGetter()!==this.GetCurrentState()}CompareSaveStateWithCurrent(){return!HG.IsNullOrUndefined(this._saveState)&&this._saveState!==this.GetCurrentState()}MayNeedBeforeAndAfterInterpolate(){return!1}ChangeProperty(e,t,s,i,r,n,a,o){const h=this._propertyTrack,l=h.GetTrack(),c=h.GetSourceAdapterId(),u=h.GetTimeline(),d=l.GetInstance(),_=h.GetSourceAdapter(),p=this._property,f=u.GetSimilarPropertyTracks(d,_,p,h);if(f&&f.length>1){const s=this._GetPropertyKeyframeStubs(f),i=e+l.GetStartOffset(),r=this._GetLastPropertyKeyframeStub(u,i,s);r&&(t=r.value)}switch(h.GetPropertyKeyframeType()){case"numeric":if(!jG.NumericTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),t,c))return;this._Setter(t,s,i);break;case"angle":if(!jG.AngleTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),t,c))return;this._Setter(t,s,i);break;case"boolean":if(!jG.BooleanTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),t,c))return;this._Setter(t,s,i);break;case"color":if(!jG.ColorTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),t,c))return;this._Setter(t,s,i);break;case"text":{const e=this._ForceChanges();if(!jG.TextTypeAdapter.WillChange(this._GetIndex(),this._GetTarget(),t,c)&&!e)return;this._Setter(t,s,i);break}}}_ForceChanges(){switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":case"effect":case"instance-variable":return!1;case"plugin":return this.GetSourceAdapter().ForceChanges()}return!1}_Getter(){const e=this._propertyTrack.GetSourceAdapterId(),t=this._GetTarget(),s=this._GetIndex();switch(e){case"behavior":case"plugin":return t.GetPropertyValueByIndex(s);case"effect":return t[s];case"instance-variable":return t.GetInstanceVariableValue(s)}}_Setter(e,t,s){const i=this._propertyTrack.GetSourceAdapterId(),r=this._GetTarget(),n=this._GetIndex();switch(i){case"behavior":r.SetPropertyValueByIndex(n,e);break;case"effect":r[n]=e;break;case"instance-variable":r.SetInstanceVariableValue(n,e);break;case"plugin":r.SetPropertyValueByIndex(n,e,this.GetSourceAdapter().GetOptionalCallbacks(t,s))}}}HG.PropertyTrackState.PropertyInterpolationAdapter.NoInterpolationAdapter=zG}{const XG=self.C3,YG=XG.PropertyTrackState.PropertyInterpolationAdapter,qG=new Map,KG=(e,t,s,i,r,n=!1,a=null,o=null)=>{qG.set(e,{setter:t,absolute_setter:s,getter:i,round:r,fRound:n,init:a,reset:o})},$G=(e,t)=>{const s=t.GetTimeline().GetTrackFromInstance(e.GetInstance());if(s)return s.GetOriginalWidth();const i=e.GetInstance().GetSdkInstance();return i.IsOriginalSizeKnown()?i.GetOriginalWidth():e._GetSceneGraphInfo()._GetStartWidth()},JG=(e,t,s,i=0)=>{const r=t.GetTimeline().GetTrackFromInstance(e.GetInstance());if(!r)return i;const n=r.GetPropertyTrack(s);if(!n)return i;const a=n.GetPropertyTrackDataItem().GetPropertyKeyframeData();if(!a)return i;const o=a.GetLastPropertyKeyframeDataItem();return o?o.GetValue():i},ZG=e=>{const t=[];let s=e.GetParent();for(;s;)t.push(s),s=s.GetParent();return t.reverse(),t};KG("offsetX",(e,t,s,i)=>{"relative"===i._propertyTrack.GetResultMode()?e.OffsetX(t,s.GetTimeline().GetTransformWithSceneGraph()):e.OffsetX(t)},(e,t)=>e.SetX(t),e=>e.GetX(),!0),KG("offsetY",(e,t,s,i)=>{"relative"===i._propertyTrack.GetResultMode()?e.OffsetY(t,s.GetTimeline().GetTransformWithSceneGraph()):e.OffsetY(t)},(e,t)=>e.SetY(t),e=>e.GetY(),!0),KG("offsetWidth",(e,t,s,i,r=!1,n=!0)=>{if(0===t)return;const a="relative"===i._propertyTrack.GetResultMode(),o=1===i._typeAdapter.GetType();if((a||o)&&e.HasParent()&&e.GetTransformWithParentWidth()){if(isNaN(i._absoluteToFactor)){const t=ZG(e);let s;s=o?t[t.length-1].GetWidth():t[t.length-1]._GetSceneGraphInfo()._GetStartWidth(),i._absoluteToFactor=0===s?Number.EPSILON:s}if(r)return;i._absoluteWidthOffset+=t;const s=t/i._absoluteToFactor;e.OffsetWidth(s,n),i._changeAccumulator+=s}else e.OffsetWidth(t),i._changeAccumulator+=t},(e,t)=>e.SetWidth(t),e=>e.GetWidth(),!0,!1,null,e=>{e._changeAccumulator=0,e._absoluteWidthOffset=0}),KG("offsetHeight",(e,t,s,i,r=!1,n=!0)=>{if(0===t)return;const a="relative"===i._propertyTrack.GetResultMode(),o=1===i._typeAdapter.GetType();if((a||o)&&e.HasParent()&&e.GetTransformWithParentHeight()){if(isNaN(i._absoluteToFactor)){const t=ZG(e);let s;s=o?t[t.length-1].GetHeight():t[t.length-1]._GetSceneGraphInfo()._GetStartHeight(),i._absoluteToFactor=0===s?Number.EPSILON:s}if(r)return;i._absoluteHeightOffset+=t;const s=t/i._absoluteToFactor;e.OffsetHeight(s,n),i._changeAccumulator+=s}else e.OffsetHeight(t),i._changeAccumulator+=t},(e,t)=>e.SetHeight(t),e=>e.GetHeight(),!0,!1,null,e=>{e._changeAccumulator=0,e._absoluteHeightOffset=0}),KG("offsetAngle",(e,t,s,i,r)=>{e.OffsetAngle(t)},(e,t)=>e.SetAngle(t),e=>e.GetAngle(),!1,!0),KG("offsetOpacity",(e,t,s,i,r)=>{t/=i._opacityFactor?i._opacityFactor:1;const n=e.GetOpacity()+t;if(0===i._clampAccumulator)n>1?i._clampAccumulator+=n-1:n<0&&(i._clampAccumulator+=n),e.OffsetOpacity(t);else{const s=e.GetOpacity()+t;t>0&&i._clampAccumulator>0?s>1&&(i._clampAccumulator+=s-1):t>0&&i._clampAccumulator<0?(i._clampAccumulator+=t,i._clampAccumulator>0&&(e.OffsetOpacity(i._clampAccumulator),i._clampAccumulator=0)):t<0&&i._clampAccumulator>0?(i._clampAccumulator+=t,i._clampAccumulator<0&&(e.OffsetOpacity(i._clampAccumulator),i._clampAccumulator=0)):t<0&&i._clampAccumulator<0&&s<0&&(i._clampAccumulator+=s)}},(e,t)=>{e.SetOpacity(t)},e=>e.GetOpacity(),!1,!0,(e,t,s)=>{switch(e._clampAccumulator=0,e._propertyTrack.GetResultMode()){case"relative":{e._propertyTrack.GetPropertyTrackData();const t=e._propertyTrack.GetPropertyTrackDataItem().GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray();let s=e.GetWorldInfo().GetOpacity(),i=s;for(const r of t){const t=r.GetTime();i=s+e._propertyTrack.GetInterpolatedValue(t),i=XG.clamp(i,0,1)}e._totalForewardOpacityDelta=s-i,e._totalForewardOpacityDelta=Math.round(100*(e._totalForewardOpacityDelta+Number.EPSILON))/100,i=s;for(let s=t.length-1;s>=0;s--){const r=t[s].GetTime();i-=e._propertyTrack.GetInterpolatedValue(r),i=XG.clamp(i,0,1)}e._totalBackwardOpacityDelta=i,e._totalBackwardOpacityDelta=Math.round(100*(e._totalBackwardOpacityDelta+Number.EPSILON))/100;break}}const i="relative"===e._propertyTrack.GetResultMode(),r=1===e._typeAdapter.GetType();if((i||r)&&t.HasParent()&&t.GetTransformWithParentOpacity()){const i=ZG(t);let r=i[0]._GetSceneGraphInfo().GetStartOpacity();r+=JG(i[0],s,"offsetOpacity");for(let e=1;e<i.length;e++)r+=JG(i[e],s,"offsetOpacity");e._opacityFactor=0===r?1:r}},e=>{switch(e._propertyTrack.GetResultMode()){case"relative":{e._clampAccumulator=0;const t=e.GetWorldInfo();let s=t.GetOpacity();s=Math.round(100*(s+Number.EPSILON))/100,e._propertyTrack.GetTimeline().IsForwardPlayBack()?(t.SetOpacity(s+e._totalForewardOpacityDelta),e._lastValue=0):(t.SetOpacity(s-e._totalBackwardOpacityDelta),e._lastValue=e.GetSourceAdapter().GetValueAtTime());break}}}),KG("offsetOriginX",(e,t)=>e.OffsetOriginX(t),(e,t)=>e.SetOriginX(t),e=>e.GetOriginX(),!1),KG("offsetOriginY",(e,t)=>e.OffsetOriginY(t),(e,t)=>e.SetOriginY(t),e=>e.GetOriginY(),!1),KG("offsetZElevation",(e,t)=>e.OffsetZElevation(t),(e,t)=>e.SetZElevation(t),e=>e.GetZElevation(),!0),KG("offsetScaleX",(e,t,s,i)=>{if(0===t)return;const r=e.GetWidth()<0?-1:1;if(i._absoluteScaleXOffset+=t,"relative"===i._propertyTrack.GetResultMode()&&e.HasParent()&&e.GetTransformWithParentWidth()){const n=JG(e,s,"offsetWidth"),a=isNaN(i._originalSize)?s.GetOriginalWidth():i._originalSize,o=(a+n/(e._GetSceneGraphInfo()._GetStartWidth()/a))*r*t;isNaN(i._absoluteToFactor)&&qG.get("offsetWidth").setter(e,1,s,i,!0);const h=o/i._absoluteToFactor;e.OffsetWidth(h,!0),i._changeAccumulator+=h}else{const n=(isNaN(i._originalSize)?s.GetOriginalWidth():i._originalSize)*r*t;e.OffsetWidth(n),i._changeAccumulator+=n}},(e,t,s)=>{e.SetWidth(s.GetOriginalWidth()*t)},(e,t)=>{const s=e.GetWidth()<0?-1:1;if(e.GetTransformWithParentWidth()){const i=e.GetParent(),r=t.GetTimeline().GetTrackFromInstance(i.GetInstance());let n=NaN;if(r)n=i.GetWidth()/r.GetOriginalWidth();else{const e=i.GetInstance().GetSdkInstance();n=e.IsOriginalSizeKnown()?i.GetWidth()/e.GetOriginalWidth():1}return e.GetWidth()*s/(t.GetOriginalWidth()*n)}return e.GetWidth()*s/t.GetOriginalWidth()},!1,!1,null,e=>{e._changeAccumulator=0,e._originalSize=NaN,e._absoluteScaleXOffset=0}),KG("offsetScaleY",(e,t,s,i)=>{if(0===t)return;const r=e.GetHeight()<0?-1:1;if(i._absoluteScaleYOffset+=t,"relative"===i._propertyTrack.GetResultMode()&&e.HasParent()&&e.GetTransformWithParentHeight()){const n=JG(e,s,"offsetHeight"),a=isNaN(i._originalSize)?s.GetOriginalHeight():i._originalSize,o=(a+n/(e._GetSceneGraphInfo()._GetStartHeight()/a))*r*t;isNaN(i._absoluteToFactor)&&qG.get("offsetHeight").setter(e,1,s,i,!0);const h=o/i._absoluteToFactor;e.OffsetHeight(h,!0),i._changeAccumulator+=h}else{const n=(isNaN(i._originalSize)?s.GetOriginalHeight():i._originalSize)*r*t;e.OffsetHeight(n),i._changeAccumulator+=n}},(e,t,s)=>{e.SetHeight(s.GetOriginalHeight()*t)},(e,t)=>{const s=e.GetHeight()<0?-1:1;if(e.GetTransformWithParentHeight()){const i=e.GetParent(),r=t.GetTimeline().GetTrackFromInstance(i.GetInstance());let n=NaN;if(r)n=i.GetHeight()/r.GetOriginalHeight();else{const e=i.GetInstance().GetSdkInstance();n=e.IsOriginalSizeKnown()?i.GetHeight()/e.GetOriginalHeight():1}return e.GetHeight()*s/(t.GetOriginalHeight()*n)}return e.GetHeight()*s/t.GetOriginalHeight()},!1,!1,null,e=>{e._changeAccumulator=0,e._originalSize=NaN,e._absoluteScaleYOffset=0});class QG extends XG.PropertyTrackState.PropertyInterpolationAdapter{constructor(e){super(e),this._lastValue=0,this._clampAccumulator=0,this._totalForewardOpacityDelta=0,this._totalBackwardOpacityDelta=0,this._opacityFactor=NaN,this._absoluteToFactor=NaN,this._changeAccumulator=0,this._originalSize=NaN,this._absoluteWidthOffset=0,this._absoluteScaleXOffset=0,this._absoluteHeightOffset=0,this._absoluteScaleYOffset=0,this._angleReflectMirrorOrFlip=void 0,this._angleReflectMirrorAndFlip=void 0,this._instance_getter=null,this._instance_setter=null,this._instance_absolute_setter=null,this._reset_action=null,this._init_action=null,this._source_adapter_getter=null,this._source_adapter_setter=null,this._source_adapter_absolute_setter=null,this._round=!1,this._fRound=!1,XG.IsInstanceOf(this._propertyTrack.GetTimeline(),XG.TweenState)?this._typeAdapter=new XG.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTween(this):this._typeAdapter=new XG.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTimeline(this);const t=this._propertyTrack.GetPropertyName();switch(this._propertyTrack.GetSourceAdapterId()){case"world-instance":{const e=qG.get(t);this._instance_getter=e.getter,this._instance_setter=e.setter,this._instance_absolute_setter=e.absolute_setter,this._round=e.round,this._fRound=e.fRound,this._init_action=e.init,this._reset_action=e.reset;break}case"audio":this._source_adapter_getter=e.Getter,this._source_adapter_setter=e.Setter,this._source_adapter_absolute_setter=e.AbsoluteSetter,this._round=!!e.DoesRounding(),this._fRound=!1}}Release(){this._typeAdapter=null,this._instance_getter=null,this._instance_setter=null,this._instance_absolute_setter=null,this._reset_action=null,this._init_action=null,this._source_adapter_getter=null,this._source_adapter_setter=null,this._source_adapter_absolute_setter=null,super.Release()}MayNeedBeforeAndAfterInterpolate(){return this._typeAdapter.MayNeedBeforeAndAfterInterpolate()}GetLastValue(){return this._lastValue}SetLastValue(e){this._lastValue=e}SetResetState(){this._reset_action&&this._reset_action(this)}SetInitialState(){const e=this._typeAdapter.SetInitialState();if("number"==typeof e&&(this._lastValue=e),this._init_action){const e=this.GetWorldInfo(),t=this._propertyTrack.GetTrack();this._init_action(this,e,t)}}SetResumeState(){const e=this._typeAdapter.SetResumeState();"number"==typeof e&&(this._lastValue=e)}GetCurrentState(){return this._Getter()}CompareInitialStateWithCurrent(){return this._FirstKeyframeGetter()!==this.GetCurrentState()}CompareSaveStateWithCurrent(){return!XG.IsNullOrUndefined(this._saveState)&&this._saveState!==this.GetCurrentState()}BeforeChangeProperty(e,t){this._typeAdapter.BeforeChangeProperty(e,t)}ChangeProperty(e,t,s,i,r,n,a,o){return this._typeAdapter.ChangeProperty(e,t,s,i,r,n,a,o)}AfterChangeProperty(e,t){this._typeAdapter.AfterChangeProperty(e,t)}_Getter(){const e=this._GetTarget(),t=this._GetIndex(),s=this.GetWorldInfo(),i=this._propertyTrack.GetTrack();switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":case"plugin":return e.GetPropertyValueByIndex(t);case"effect":return e[t];case"instance-variable":return e.GetInstanceVariableValue(t);case"world-instance":return this._instance_getter(s,i);case"audio":return this._source_adapter_getter.call(this.GetSourceAdapter(),s,i)}}_Setter(e,t,s,i=!0){const r=this._GetTarget(),n=this._GetIndex(),a=this.GetWorldInfo(),o=this._propertyTrack.GetTrack();switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":r.OffsetPropertyValueByIndex(n,e);break;case"effect":r[n]+=e;break;case"instance-variable":r.SetInstanceVariableOffset(n,e);break;case"plugin":r.OffsetPropertyValueByIndex(n,e,this.GetSourceAdapter().GetOptionalCallbacks(t,s));break;case"world-instance":this._instance_setter(a,e,o,this,!1,i);break;case"audio":this._source_adapter_setter.call(this.GetSourceAdapter(),a,e,o,this)}}_SetterAbsolute(e,t,s,i,r){let n=this._propertyTrack.GetInterpolationMode();if(n="default"===n?"continuous":n,"discrete"===n&&!t)return;if("discrete"===n&&s){const e=this._propertyTrack.GetTimeline().GetTime();if(!this._propertyTrack.GetPropertyKeyFrameDataItemAtTime(e))return}const a=this._GetTarget(),o=this._GetIndex(),h=this.GetWorldInfo(),l=this._propertyTrack.GetTrack();switch(this._propertyTrack.GetSourceAdapterId()){case"behavior":a.SetPropertyValueByIndex(o,e);break;case"effect":a[o]=e;break;case"instance-variable":a.SetInstanceVariableValue(o,e);break;case"plugin":a.SetPropertyValueByIndex(o,e,this.GetSourceAdapter().GetOptionalCallbacks(i,r));break;case"world-instance":this._instance_absolute_setter(h,e,l);break;case"audio":this._source_adapter_absolute_setter.call(this.GetSourceAdapter(),h,e,l)}}_MaybeEnsureValue(e,t,s,i,r,n,a,o){this._typeAdapter._MaybeEnsureValue(e,t,s,i,r,n,a,o)}_AddDelta(e,t,s,i,r){"angle"===this._propertyTrack.GetPropertyType()&&(e=XG.toDegrees(e));const n=(e.toString().split(".")[1]||"").length,a=this._Getter();let o;switch(o=0===n?this._round?Math.round(a):this._fRound?"angle"===this._propertyTrack.GetPropertyType()?XG.toRadians(Math.round(XG.toDegrees(a))):Number(XG.toFixed(a,2)):a:this._round?Number(XG.toFixed(a,n)):(this._fRound,a),this._Setter(o-a,t,s,!1),this._propertyTrack.GetPropertyName()){case"offsetWidth":case"offsetScaleX":{const e=this.GetWorldInfo(),t=e.GetWidth(),s=Number(XG.toFixed(t,2));e.OffsetWidth(s-t);break}case"offsetHeight":case"offsetScaleY":{const e=this.GetWorldInfo(),t=e.GetHeight(),s=Number(XG.toFixed(t,2));e.OffsetHeight(s-t);break}}}_SaveToJson(){return Object.assign(super._SaveToJson(),{v:this._lastValue,a:this._clampAccumulator,fod:this._totalForewardOpacityDelta,bod:this._totalBackwardOpacityDelta,of:this._opacityFactor,sf:this._absoluteToFactor,armorf:this._angleReflectMirrorOrFlip,armandf:this._angleReflectMirrorAndFlip,ca:this._changeAccumulator,os:this._originalSize,awo:this._absoluteWidthOffset,aho:this._absoluteHeightOffset,asxo:this._absoluteScaleXOffset,asyo:this._absoluteScaleYOffset})}_LoadFromJson(e){e&&(super._LoadFromJson(e),this._lastValue=e.v,this._clampAccumulator=e.a,this._totalForewardOpacityDelta=XG.IsFiniteNumber(e.fod)?e.fod:0,this._totalBackwardOpacityDelta=XG.IsFiniteNumber(e.bod)?e.bod:0,this._opacityFactor=XG.IsFiniteNumber(e.of)?e.of:NaN,this._absoluteToFactor=XG.IsFiniteNumber(e.sf)?e.sf:NaN,this._angleReflectMirrorOrFlip=XG.IsFiniteNumber(e.armorf)?e.armorf:void 0,this._angleReflectMirrorAndFlip=XG.IsFiniteNumber(e.armandf)?e.armandf:void 0,this._changeAccumulator=XG.IsFiniteNumber(e.ca)?e.ca:0,this._originalSize=XG.IsFiniteNumber(e.os)?e.os:NaN,this._absoluteWidthOffset=XG.IsFiniteNumber(e.awo)?e.awo:0,this._absoluteHeightOffset=XG.IsFiniteNumber(e.aho)?e.aho:0,this._absoluteScaleXOffset=XG.IsFiniteNumber(e.asxo)?e.asxo:0,this._absoluteScaleYOffset=XG.IsFiniteNumber(e.asyo)?e.asyo:0)}SetOriginalSizeProperty(e){this._originalSize=e}GetChangeAccumulatorProperty(){return this._changeAccumulator}GetAbsoluteWidthOffsetProperty(){return this._absoluteWidthOffset}GetAbsoluteHeightOffsetProperty(){return this._absoluteHeightOffset}GetAbsoluteScaleXOffsetProperty(){return this._absoluteScaleXOffset}GetAbsoluteScaleYOffsetProperty(){return this._absoluteScaleYOffset}}XG.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapter=QG}{const ey=self.C3;class ty{constructor(e){this._used=!1,this._value=0,this._propertyKeyframeReached=!1,this._endState=!1,this._propertyTracks=e;for(let e=0,t=this._propertyTracks.length;e<t;e++)this._propertyTracks[e].SetAbsoluteValueObject(this)}GetPropertyTracks(){return this._propertyTracks}SetUsed(){this._used=!0}GetUsed(){return this._used}SetValue(e){this._value=e}GetValue(){return this._value}SetPropertyKeyframeReached(e){this._propertyKeyframeReached=e}GetPropertyKeyframeReached(){return this._propertyKeyframeReached}SetEndState(e){this._endState=e}GetEndState(){return this._endState}Reset(){this._used=!1,this._value=0,this._propertyKeyframeReached=!1,this._endState=!1}}class sy{constructor(e){this._numericInterpolationAdapter=e}Release(){this._numericInterpolationAdapter=null}GetType(){return 0}SetInitialState(){const e=this._numericInterpolationAdapter;return this._numericInterpolationAdapter.GetPropertyTrack(),e._PickResultMode(()=>e._PickTimelinePlaybackMode(()=>0,()=>e.GetSourceAdapter().GetValueAtTime()),()=>{})}SetResumeState(){}MayNeedBeforeAndAfterInterpolate(){switch(this._numericInterpolationAdapter,this._numericInterpolationAdapter.GetPropertyTrack().GetResultMode()){case"relative":return!1;case"absolute":return!0}}BeforeChangeProperty(e,t){this._numericInterpolationAdapter;const s=this._numericInterpolationAdapter.GetPropertyTrack(),i=s.GetPropertyName();switch(s.GetResultMode()){case"relative":break;case"absolute":if(s.HasAbsoluteValueObject())s.GetAbsoluteValueObject().Reset();else{const e=s.GetTimeline(),t=s.GetInstance(),r=s.GetSourceAdapter(),n=e.GetSimilarPropertyTracks(t,r,i,s);n&&n.length>1&&new ty(n)}}}ChangeProperty(e,t,s,i,r,n,a,o){const h=this._numericInterpolationAdapter,l=this._numericInterpolationAdapter.GetPropertyTrack();switch(l.GetResultMode()){case"relative":{const a=h.GetLastValue();h._Setter(t-a,s,i),n&&this._MaybeEnsureValue(e,s,i,r,a,t),h.SetLastValue(t);break}case"absolute":{const e=l.GetTimeline(),r=l.GetTrack();if(l.GetInstance(),l.GetSourceAdapter(),l.HasAbsoluteValueObject()){const s=l.GetAbsoluteValueObject(),i=s.GetPropertyTracks(),n=h._GetPropertyKeyframeStubs(i,!0),c=h._GetLastPropertyKeyframeStub(e,e.GetTime(),n);if(c){const e=r.GetStartOffset(),i=c.time-e;if(0===i)s.SetEndState(a),s.SetPropertyKeyframeReached(o),s.SetUsed(),s.SetValue(s.GetValue()+t);else{if(i<0)return;const e=l.GetInterpolatedValue(i);s.SetEndState(a),s.SetPropertyKeyframeReached(o),s.SetUsed(),s.SetValue(s.GetValue()+(t-e))}}}else h._SetterAbsolute(t,o,a,s,i);break}}}AfterChangeProperty(e,t){const s=this._numericInterpolationAdapter,i=this._numericInterpolationAdapter.GetPropertyTrack();switch(i.GetResultMode()){case"relative":break;case"absolute":if(i.HasAbsoluteValueObject()){const r=i.GetAbsoluteValueObject();r.GetUsed()&&s._SetterAbsolute(r.GetValue(),r.GetPropertyKeyframeReached(),r.GetEndState(),e,t)}}}_MaybeEnsureValue(e,t,s,i,r,n){const a=this._numericInterpolationAdapter;i||(t&&e===t.GetTime()?a._AddDelta(t.GetValueWithResultMode(),t,s):s&&e===s.GetTime()?a._AddDelta(s.GetValueWithResultMode(),t,s):n-r===0&&a._AddDelta(t.GetValueWithResultMode(),t,s))}}ey.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTimeline=sy}{const iy=self.C3;class ry{constructor(e){this._numericInterpolationAdapter=e}Release(){this._numericInterpolationAdapter=null}GetType(){return 1}SetInitialState(){const e=this._numericInterpolationAdapter;return e.SetFirstAbsoluteUpdate(!0),this._GetAbsoluteInitialValue(e._FirstKeyframeGetter())}SetResumeState(){const e=this._numericInterpolationAdapter;if(e._FirstKeyframeGetter()!==e._CurrentKeyframeGetter())return e.SetFirstAbsoluteUpdate(!0),this._GetAbsoluteInitialValue(e._CurrentKeyframeGetter())}MayNeedBeforeAndAfterInterpolate(){return!1}BeforeChangeProperty(){}ChangeProperty(e,t,s,i,r,n,a,o){const h=this._numericInterpolationAdapter,l=h.GetLastValue();switch(h.GetPropertyTrack().GetResultMode()){case"relative":h._Setter(t-l,s,i),n&&this._MaybeEnsureValue(e,s,i,r,l,t,!1,a);break;case"absolute":h.GetFirstAbsoluteUpdate()?(h.SetFirstAbsoluteUpdate(!1),h._Setter(l,s,i)):0===e&&0===h.GetPropertyTrack().GetTimeline().GetTotalTime()?h._SetterAbsolute(t,!0,!1,s,i):(h._Setter(t-l,s,i),n&&this._MaybeEnsureValue(e,s,i,r,l,t,this._ForceEndValue(),a))}h.SetLastValue(t)}AfterChangeProperty(){}_GetAbsoluteInitialValue(e){return e-this._numericInterpolationAdapter.GetCurrentState()}_ForceEndValue(){const e=this._numericInterpolationAdapter,t=e.GetWorldInfo().GetInstance(),s=e.GetPropertyTrack().GetRuntime().GetTimelineManager();let i=0;for(const e of s.GetPlayingTimelines())0===e.GetType()?e.HasTrackInstance(t)&&i++:1===e.GetType()&&e.GetInstance()===t&&i++;return i<=1}_MaybeEnsureValue(e,t,s,i,r,n,a,o){const h=this._numericInterpolationAdapter;i?t&&e===t.GetTime()?h._AddDelta(t.GetValueWithResultMode(),t,s,a,o):s&&e===s.GetTime()?h._AddDelta(s.GetValueWithResultMode(),t,s,a,o):s||h._AddDelta(t.GetValueWithResultMode(),t,s,a,o):t&&e===t.GetTime()?h._AddDelta(t.GetValueWithResultMode(),t,s,a,o):s&&e===s.GetTime()?h._AddDelta(s.GetValueWithResultMode(),t,s,a,o):n-r===0&&h._AddDelta(t.GetValueWithResultMode(),t,s,a,o)}}iy.PropertyTrackState.PropertyInterpolationAdapter.NumericInterpolationAdapterForTween=ry}{const ny=self.C3,ay=self.Ease;ny.PropertyTrackState.NumericTypeAdapter=class{constructor(){}static WillChange(e,t,s,i){let r;switch(i){case"behavior":case"plugin":r=t.GetPropertyValueByIndex(e);break;case"effect":r=t[e];break;case"instance-variable":r=t.GetInstanceVariableValue(e)}return r!==s}static Interpolate(e,t,s,i){if(!s){const e=i.GetPropertyTrackDataItem();return i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e).GetValueWithResultMode()}let r=i.GetInterpolationMode();if("default"===r&&(r="continuous"),"combo"===i.GetPropertyType()&&(r="discrete"),"discrete"===r)return ny.PropertyTrackState.GetPropertyKeyframeValueWithPlaybackDirection(t,s,i);if("continuous"===r||"step"===r){const n=i.GetTimeline().GetStep();if("step"===r&&0!==n){const t=1/n;e=Math.floor(e*t)/t}const a=t.GetValueWithResultMode(),o=s.GetValueWithResultMode(),h=t.GetAddOn("cubic-bezier"),l=s.GetAddOn("cubic-bezier"),c=h&&h.GetStartEnable()&&l&&l.GetEndEnable();if(!c&&a===o)return a;const u=t.GetTime(),d=s.GetTime();"step"===r&&0!==n&&(e=ny.clamp(e,u,d));const _=ny.normalize(e,u,d),p=t.GetEase();let f;if(c){const e=d-u;f=ay.GetRuntimeEase(p)(e*_,0,1,e),f=ay.GetRuntimeEase("cubicbezier")(f,a,a+h.GetStartAnchor(),o+l.GetEndAnchor(),o)}else f=ay.GetRuntimeEase(p)((d-u)*_,a,o-a,d-u);return"integer"===i.GetPropertyType()?Math.floor(f):f}}}}{const oy=self.C3;oy.PropertyTrackState.AngleTypeAdapter=class{constructor(){}static WillChange(e,t,s,i){let r;switch(i){case"behavior":case"plugin":r=t.GetPropertyValueByIndex(e);break;case"effect":r=t[e];break;case"instance-variable":r=t.GetInstanceVariableValue(e)}return r!==s}static Interpolate(e,t,s,i){if(!s){const e=i.GetPropertyTrackDataItem();return i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e).GetValueWithResultMode()}let r=i.GetInterpolationMode();if("default"===r&&(r="continuous"),"combo"===i.GetPropertyType()&&(r="discrete"),"discrete"===r)return oy.PropertyTrackState.GetPropertyKeyframeValueWithPlaybackDirection(t,s,i);if("continuous"===r||"step"===r){const n=i.GetTimeline().GetStep();if("step"===r&&0!==n){const t=1/n;e=Math.floor(e*t)/t}const a=t.GetTime(),o=s.GetTime(),h=t.GetValueWithResultMode(),l=s.GetValueWithResultMode();"step"===r&&0!==n&&(e=oy.clamp(e,a,o));const c=t.GetAddOn("angle");if(!c){if(h===l)return h;const s=oy.normalize(e,a,o),i=self.Ease.GetRuntimeEase(t.GetEase());return oy.angleLerp(h,l,i(s,0,1,1))}{const s=c.GetRevolutions();if(h===l&&0===s)return h;const i=oy.normalize(e,a,o),r=self.Ease.GetRuntimeEase(t.GetEase())(i,0,1,1);switch(c.GetDirection()){case"closest":return oy.angleLerp(h,l,r,s);case"clockwise":return oy.angleLerpClockwise(h,l,r,s);case"anti-clockwise":return oy.angleLerpAntiClockwise(h,l,r,s)}}}}}}{const hy=self.C3;hy.PropertyTrackState.BooleanTypeAdapter=class{constructor(){}static WillChange(e,t,s,i){let r;switch(i){case"behavior":case"plugin":r=t.GetPropertyValueByIndex(e);break;case"effect":r=t[e];break;case"instance-variable":r=t.GetInstanceVariableValue(e)}return!!r!=!!s}static Interpolate(e,t,s,i){if(!s){const e=i.GetPropertyTrackDataItem();return i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e).GetValueWithResultMode()?1:0}return hy.PropertyTrackState.GetPropertyKeyframeValueWithPlaybackDirection(t,s,i)?1:0}}}{const ly=self.C3,cy=[0,0,0],uy=[0,0,0],dy=[0,0,0];ly.PropertyTrackState.ColorTypeAdapter=class{constructor(){}static WillChange(e,t,s,i){let r;switch(i){case"behavior":case"plugin":r=t.GetPropertyValueByIndex(e);break;case"effect":r=t[e];break;case"instance-variable":r=t.GetInstanceVariableValue(e)}return Array.isArray(s)?(cy[0]=s[0],cy[1]=s[1],cy[2]=s[2]):(dy.parseCommaSeparatedRgb(s),cy[0]=Math.floor(255*dy.getR()),cy[1]=Math.floor(255*dy.getG()),cy[2]=Math.floor(255*dy.getB())),Array.isArray(r)?(uy[0]=r[0],uy[1]=r[1],uy[2]=r[2]):(dy.parseCommaSeparatedRgb(r),uy[0]=Math.floor(255*dy.getR()),uy[1]=Math.floor(255*dy.getG()),uy[2]=Math.floor(255*dy.getB())),cy[0]!==uy[0]||cy[1]!==uy[1]||cy[2]!==uy[2]}static Interpolate(e,t,s,i){if(!s){const e=i.GetPropertyTrackDataItem(),t=i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e).GetValueWithResultMode();return cy[0]=t[0],cy[1]=t[1],cy[2]=t[2],cy}let r=i.GetInterpolationMode();if("default"===r&&(r="continuous"),"discrete"===r){const e=ly.PropertyTrackState.GetPropertyKeyframeValueWithPlaybackDirection(t,s,i);return cy[0]=e[0],cy[1]=e[1],cy[2]=e[2],cy}if("continuous"===r||"step"===r){const n=i.GetTimeline().GetStep();if("step"===r&&0!==n){const t=1/n;e=Math.floor(e*t)/t}const a=t.GetTime(),o=s.GetTime(),h=t.GetValueWithResultMode(),l=s.GetValueWithResultMode();"step"===r&&0!==n&&(e=ly.clamp(e,a,o));const c=ly.normalize(e,a,o),u=t.GetEase(),d=h[0],_=h[1],p=h[2],f=l[0],m=l[1],g=l[2],S=self.Ease.GetRuntimeEase(u),G=o-a,y=G*c;return cy[0]=d===f?d:S(y,d,f-d,G),cy[1]=_===m?_:S(y,_,m-_,G),cy[2]=p===g?p:S(y,p,g-p,G),cy}}}}{const _y=self.C3;_y.PropertyTrackState.TextTypeAdapter=class{constructor(){}static WillChange(e,t,s,i){let r;switch(i){case"behavior":case"plugin":r=t.GetPropertyValueByIndex(e);break;case"effect":r=t[e];break;case"instance-variable":r=t.GetInstanceVariableValue(e)}return r!==s}static Interpolate(e,t,s,i){if(!s){const e=i.GetPropertyTrackDataItem();return i.GetPropertyTrackData().GetLastPropertyKeyframeDataItem(e).GetValueWithResultMode()}return _y.PropertyTrackState.GetPropertyKeyframeValueWithPlaybackDirection(t,s,i)}}}{const py=self.C3;py.TimelineDataManager=class{constructor(){this._timelineDataItems=new Map}Release(){for(const e of this._timelineDataItems.values())e.Release();this._timelineDataItems.clear(),this._timelineDataItems=null}Add(e){const t=new py.TimelineDataItem(e),s=t.GetName();this._timelineDataItems.set(s,t)}Get(e){return this._timelineDataItems.get(e)}GetNameId(){return 0}static _CreateDataItems(e,t,s,i){if(t)for(const r of t)py.TimelineDataManager._CreateDataItem("create",r,e,s,i)}static _CreateDataItemsIncludingDisabled(e,t,s,i){if(t)for(const r of t)py.TimelineDataManager._CreateDataItem("create-including-disabled",r,e,s,i)}static _LoadDataItemsFromJson(e,t,s,i){e.length?t.forEach((t,s)=>{e[s]._LoadFromJson(t)}):t.forEach(t=>{py.TimelineDataManager._CreateDataItem("load",t,e,s,i)})}static _CreateDataItem(e,t,s,i,r){let n;if("function"==typeof i)switch(e){case"load":n=new i(null,r);break;case"create":case"create-including-disabled":n=new i(t,r)}else if("object"==typeof i){const s=t[i.prop],a=i.map.get(s);switch(e){case"load":n=new a(null,r);break;case"create":case"create-including-disabled":n=new a(t,r)}}switch(e){case"load":n._LoadFromJson(t),s.push(n);break;case"create":if("function"==typeof n.GetEnable&&!n.GetEnable())return n.Release();s.push(n);break;case"create-including-disabled":s.push(n)}}}}{const fy=self.C3,my=0,gy=1,Sy=2,Gy=3,yy=4,Iy=5,Ty=6,Cy=7,by=8,xy=9,wy=10,Py=11;fy.TimelineDataItem=class{constructor(e){this._name="",this._totalTime=NaN,this._step=0,this._interpolationMode="default",this._resultMode="default",this._loop=!1,this._pingPong=!1,this._repeatCount=1,this._trackData=null,this._startOnLayout="",this._transformWithSceneGraph=!1,this._useSystemTimescale=!0,e&&(this._name=e[0],this._totalTime=e[1],this._step=e[2],this._interpolationMode=e[3],this._resultMode=e[4],this._loop=!!e[6],this._pingPong=!!e[7],this._repeatCount=e[8],this._startOnLayout=e[9],this._transformWithSceneGraph=!!e[10],this._useSystemTimescale=!!e[11],this._trackData=new fy.TrackData(e[5],this))}Release(){this._trackData.Release(),this._trackData=null}GetTrackData(){return this._trackData||(this._trackData=new fy.TrackData(null,this)),this._trackData}GetName(){return this._name}SetName(e){this._name=e}GetTotalTime(){return this._totalTime}SetTotalTime(e){this._totalTime=e}GetStep(){return this._step}SetStep(e){this._step=e}GetInterpolationMode(){return this._interpolationMode}SetInterpolationMode(e){this._interpolationMode=e}GetResultMode(){return this._resultMode}SetResultMode(e){this._resultMode=e}GetLoop(){return this._loop}SetLoop(e){this._loop=e}GetPingPong(){return this._pingPong}SetPingPong(e){this._pingPong=e}GetRepeatCount(){return this._repeatCount}SetRepeatCount(e){this._repeatCount=e}GetStartOnLayout(){return this._startOnLayout}GetTransformWithSceneGraph(){return this._transformWithSceneGraph}GetUseSystemTimescale(){return this._useSystemTimescale}_SaveToJson(){return{trackDataJson:this._trackData._SaveToJson(),name:this._name,totalTime:this._totalTime,step:this._step,interpolationMode:this._interpolationMode,resultMode:this._resultMode,loop:this._loop,pingPong:this._pingPong,repeatCount:this._repeatCount,startOnLayout:this._startOnLayout,transformWithSceneGraph:!!this._transformWithSceneGraph,useSystemTimescale:this._useSystemTimescale}}_LoadFromJson(e){e&&(this.GetTrackData()._LoadFromJson(e.trackDataJson),this._name=e.name,this._totalTime=e.totalTime,this._step=e.step,this._interpolationMode=e.interpolationMode,this._resultMode=e.resultMode,this._loop=e.loop,this._pingPong=e.pingPong,this._repeatCount=e.repeatCount,this._startOnLayout=e.startOnLayout,this._transformWithSceneGraph=!!e.transformWithSceneGraph,this._useSystemTimescale=!!e.useSystemTimescale)}}}{const Ry=self.C3,vy=0,Ay=1,My=2,Dy=1,Ey=2,Fy=3,Oy=4,By=5,ky=6,Ly=7,Ny=0,Wy=1,Uy=8,Vy=0,Hy=1,jy=9,zy=10;class Xy{constructor(e,t){this._trackData=t,this._instanceData=null,this._additionalInstanceData=null,this._instanceUid=NaN,this._objectClassIndex=NaN,this._interpolationMode="default",this._resultMode="default",this._enabled=!1,this._keyframeData=null,this._propertyTrackData=null,this._id="",this._nestedData=null,this._startOffset=0,this._localTotalTime=this._trackData.GetTimelineDataItem().GetTotalTime(),this._type=0,this._name="",e&&(e[0]&&(this._instanceData=e[0],this._instanceUid=e[0][2],this._objectClassIndex=e[0][1]),this._interpolationMode=e[1],this._resultMode=e[2],this._enabled=!!e[3],e[6]&&(this._id=e[6]),e[7]&&(this._nestedData=e[7],this._startOffset=e[7][0],this._localTotalTime=e[7][1]),e[8]&&(this._additionalInstanceData=e[8]),e[8]&&(this._additionalInstanceData=e[8]),e[9]&&(this._type=e[9]),e[10]&&(this._name=e[10]),this._keyframeData=new Ry.KeyframeData(e[4],this),this._propertyTrackData=new Ry.PropertyTrackData(e[5],this))}Release(){this._instanceData=null,this._trackData=null,this._keyframeData&&(this._keyframeData.Release(),this._keyframeData=null),this._propertyTrackData&&(this._propertyTrackData.Release(),this._propertyTrackData=null),this._nestedData=null}GetTrackData(){return this._trackData}GetKeyframeData(){return this._keyframeData||(this._keyframeData=new Ry.KeyframeData(null,this)),this._keyframeData}GetPropertyTrackData(){return this._propertyTrackData||(this._propertyTrackData=new Ry.PropertyTrackData(null,this)),this._propertyTrackData}GetInstanceData(){return this._instanceData}GetObjectClassIndex(){return this._objectClassIndex}SetObjectClassIndex(e){this._objectClassIndex=e}GetInstanceUID(){return this._instanceUid}SetInstanceUID(e){this._instanceUid=e}GetInterpolationMode(){return this._interpolationMode}SetInterpolationMode(e){this._interpolationMode=e}GetResultMode(){return this._resultMode}SetResultMode(e){this._resultMode=e}GetEnable(){return this._enabled}SetEnable(e){this._enabled=!!e}GetId(){return this._id}GetStartOffset(){return this._startOffset}GetLocalTotalTime(){return this._localTotalTime}SetLocalTotalTime(e){this._localTotalTime=e}GetOriginalWidth(){return this._additionalInstanceData[0]}SetOriginalWidth(e){this._additionalInstanceData||(this._additionalInstanceData=[]),this._additionalInstanceData[0]=e}GetOriginalHeight(){return this._additionalInstanceData||(this._additionalInstanceData=[]),this._additionalInstanceData[1]}SetOriginalHeight(e){this._additionalInstanceData||(this._additionalInstanceData=[]),this._additionalInstanceData[1]=e}GetType(){return this._type}GetName(){return this._name}_SaveToJson(){return{keyframeDataJson:this._keyframeData._SaveToJson(),propertyTrackDataJson:this._propertyTrackData._SaveToJson(),instanceData:this._instanceData,additionalInstanceData:this._additionalInstanceData,instanceUid:this._instanceUid,objectClassIndex:this._objectClassIndex,interpolationMode:this._interpolationMode,resultMode:this._resultMode,enabled:this._enabled,id:this._id,nestedData:this._nestedData,type:this._type,name:this._name}}_LoadFromJson(e){e&&(this._instanceData=e.instanceData,this._instanceUid=e.instanceUid,this._objectClassIndex=e.objectClassIndex,this._interpolationMode=e.interpolationMode,this._resultMode=e.resultMode,this._enabled=e.enabled,this._id=e.id,this._type=e.type?e.type:0,this._name=e.name?e.name:"",this._localTotalTime=this._trackData.GetTimelineDataItem().GetTotalTime(),e.nestedData&&(this._nestedData=e.nestedData,this._startOffset=this._nestedData[0],this._localTotalTime=this._nestedData[1]),e.additionalInstanceData&&(this._additionalInstanceData=e.additionalInstanceData),this.GetKeyframeData()._LoadFromJson(e.keyframeDataJson),this.GetPropertyTrackData()._LoadFromJson(e.propertyTrackDataJson))}}Ry.TrackData=class{constructor(e,t){this._timelineDataItem=t,this._trackDataItems=[],Ry.TimelineDataManager._CreateDataItems(this._trackDataItems,e,Xy,this)}Release(){this._timelineDataItem=null;for(const e of this._trackDataItems)e.Release();Ry.clearArray(this._trackDataItems),this._trackDataItems=null}GetTimelineDataItem(){return this._timelineDataItem}AddEmptyTrackDataItem(){const e=new Xy(null,this);return this._trackDataItems.push(e),e}GetFirstKeyframeDataItem(e){return e.GetKeyframeData().GetKeyframeDataItemArray()[0]}GetLastKeyframeDataItem(e){return e.GetKeyframeData().GetKeyframeDataItemArray().at(-1)}GetKeyFrameDataItemAtTime(e,t){const s=t.GetKeyframeData().GetKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()===e)return i}}GetFirstKeyFrameDataItemHigherThan(e,t){const s=t.GetKeyframeData().GetKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()>e)return i}}GetFirstKeyFrameDataItemHigherOrEqualThan(e,t){const s=t.GetKeyframeData().GetKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()>=e)return i}}GetFirstKeyFrameDataItemLowerOrEqualThan(e,t){const s=t.GetKeyframeData().GetKeyframeDataItemArray();for(let t=s.length-1;t>=0;t--){const i=s[t];if(i.GetTime()<=e)return i}}*trackDataItems(){for(const e of this._trackDataItems)yield e}_SaveToJson(){return{trackDataItemsJson:this._trackDataItems.map(e=>e._SaveToJson())}}_LoadFromJson(e){e&&Ry.TimelineDataManager._LoadDataItemsFromJson(this._trackDataItems,e.trackDataItemsJson,Xy,this)}}}{const Yy=self.C3,qy=0,Ky=0,$y=1,Jy=2,Zy=3,Qy=4,eI=5,tI=6,sI=7,iI=8,rI=9;class nI{constructor(e,t){this._propertyTrackData=t,this._sourceAdapterId="",this._sourceAdapterArguments=null,this._property=null,this._type=null,this._min=NaN,this._max=NaN,this._interpolationMode="default",this._resultMode="default",this._enabled=!1,this._propertyKeyframeData=null,this._canHavePropertyKeyframes=!0,e&&(this._sourceAdapterId=e[0][0],this._sourceAdapterArguments=e[0].slice(1),this._property=e[1],this._type=e[2],this._min=e[3],this._max=e[4],this._interpolationMode=e[5],this._resultMode=e[6],this._enabled=!!e[7],this._propertyKeyframeData=new Yy.PropertyKeyframeData(e[8],this),this._canHavePropertyKeyframes=e[9])}Release(){this._propertyKeyframeData.Release(),this._propertyKeyframeData=null,this._propertyTrackData=null,this._sourceAdapterArguments=null}GetPropertyTrackData(){return this._propertyTrackData}GetPropertyKeyframeData(){return this._propertyKeyframeData||(this._propertyKeyframeData=new Yy.PropertyKeyframeData(null,this)),this._propertyKeyframeData}GetSourceAdapterId(){return this._sourceAdapterId}SetSourceAdapterId(e){this._sourceAdapterId=e}GetSourceAdapterArguments(){return this._sourceAdapterArguments}SetSourceAdapterArguments(e){this._sourceAdapterArguments=e}GetProperty(){return this._property}SetProperty(e){this._property=e}GetType(){return this._type}SetType(e){this._type=e}GetMin(){return this._min}SetMin(e){this._min=e}GetMax(){return this._max}SetMax(e){this._max=e}GetInterpolationMode(){return this._interpolationMode}SetInterpolationMode(e){this._interpolationMode=e}GetResultMode(){return this._resultMode}SetResultMode(e){this._resultMode=e}GetEnable(){return this._enabled}SetEnable(e){this._enabled=!!e}CanHavePropertyKeyframes(){return!!this._canHavePropertyKeyframes}_SaveToJson(){return{propertyKeyframeDataJson:this._propertyKeyframeData._SaveToJson(),sourceAdapterId:this._sourceAdapterId,sourceAdapterArguments:this._sourceAdapterArguments,property:this._property,type:this._type,min:this._min,max:this._max,interpolationMode:this._interpolationMode,resultMode:this._resultMode,enabled:this._enabled,canHavePropertyKeyframes:this._canHavePropertyKeyframes}}_LoadFromJson(e){e&&(this._sourceAdapterId=e.sourceAdapterId,this._sourceAdapterArguments=e.sourceAdapterArguments,this._property=e.property,this._type=e.type,this._min=e.min,this._max=e.max,this._interpolationMode=e.interpolationMode,this._resultMode=e.resultMode,this._enabled=e.enabled,this._canHavePropertyKeyframes=e.canHavePropertyKeyframes,this.GetPropertyKeyframeData()._LoadFromJson(e.propertyKeyframeDataJson))}}Yy.PropertyTrackData=class{constructor(e,t){this._trackDataItem=t,this._propertyTrackDataItems=[],Yy.TimelineDataManager._CreateDataItems(this._propertyTrackDataItems,e,nI,this)}Release(){this._trackDataItem=null;for(const e of this._propertyTrackDataItems)e.Release();Yy.clearArray(this._propertyTrackDataItems),this._propertyTrackDataItems=null}GetTrackDataItem(){return this._trackDataItem}AddEmptyPropertyTrackDataItem(){const e=new nI(null,this);return this._propertyTrackDataItems.push(e),e}GetFirstPropertyKeyframeDataItem(e){return e.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray()[0]}GetLastPropertyKeyframeDataItem(e){return e.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray().at(-1)}GetPropertyKeyFrameDataItemAtTime(e,t){const s=t.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()===e)return i}}GetFirstPropertyKeyFrameDataItemHigherThan(e,t){const s=t.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()>e)return i}}GetFirstPropertyKeyFrameDataItemHigherOrEqualThan(e,t){const s=t.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray(),i=s.length;for(let t=0;t<i;t++){const i=s[t];if(i.GetTime()>=e)return i}}GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,t){const s=t.GetPropertyKeyframeData().GetPropertyKeyframeDataItemArray();for(let t=s.length-1;t>=0;t--){const i=s[t];if(i.GetTime()<=e)return i}}*propertyTrackDataItems(){for(const e of this._propertyTrackDataItems)yield e}_SaveToJson(){return{propertyTrackDataItemsJson:this._propertyTrackDataItems.map(e=>e._SaveToJson())}}_LoadFromJson(e){e&&Yy.TimelineDataManager._LoadDataItemsFromJson(this._propertyTrackDataItems,e.propertyTrackDataItemsJson,nI,this)}}}{const aI=self.C3,oI=0,hI=1,lI=2,cI=3;class uI{constructor(e,t){if(this._keyframeData=t,this._time=-1,this._ease="noease",this._enable=!1,this._tags=null,this._lowerTags=null,!e)return;this._time=e[0],this._ease=e[1],this._enable=!!e[2];const s=e[3];this._tags=s?s.split(" "):[],this._lowerTags=new Set(this._tags.map(e=>e.toLowerCase())),this._next=null,this._last=null}Release(){this._keyframeData=null,aI.clearArray(this._tags),this._tags=null,this._lowerTags.clear(),this._lowerTags=null,this._next=null}GetKeyframeData(){return this._keyframeData}GetNext(){return this._next}SetNext(e){this._next=e}GetLast(){return this._last}SetLast(e){this._last=e}GetTime(){return this._time}SetTime(e){this._time=e,this._keyframeData._LinkKeyframeDataItems()}GetEase(){return this._ease}SetEase(e){this._ease=e}GetEnable(){return this._enable}SetEnable(e){this._enable=!!e}GetTags(){return this._tags}SetTags(e){this._tags=e?e.split(" "):[],this._lowerTags=new Set(this._tags.map(e=>e.toLowerCase()))}GetLowerTags(){return this._lowerTags}GetTagsString(){return Array.from(this._lowerTags).join(",").trim()}HasTag(e){return this._lowerTags.has(e.toLowerCase())}_SaveToJson(){return{time:this._time,ease:this._ease,enable:this._enable,tags:this._tags}}_LoadFromJson(e){e&&(this._time=e.time,this._ease=e.ease,this._enable=e.enable,this._tags=e.tags,this._lowerTags=new Set(this._tags.map(e=>e.toLowerCase())))}}aI.KeyframeData=class{constructor(e,t){this._trackDataItem=t,this._keyframeDataItems=[],aI.TimelineDataManager._CreateDataItems(this._keyframeDataItems,e,uI,this),this._LinkKeyframeDataItems()}Release(){this._trackDataItem=null;for(const e of this._keyframeDataItems)e.Release();aI.clearArray(this._keyframeDataItems),this._keyframeDataItems=null}_LinkKeyframeDataItems(){this._keyframeDataItems.sort((e,t)=>e.GetTime()-t.GetTime());for(let e=0;e<this._keyframeDataItems.length;e++){const t=this._keyframeDataItems[e];t.SetNext(this._keyframeDataItems[e+1]),t.SetLast(this._keyframeDataItems[e-1])}}GetTrackDataItem(){return this._trackDataItem}GetKeyframeDataItemCount(){return this._keyframeDataItems.length}GetKeyframeDataItemArray(){return this._keyframeDataItems}AddEmptyKeyframeDataItem(){const e=new uI(null,this);return this._keyframeDataItems.push(e),this._LinkKeyframeDataItems(),e}DeleteKeyframeDataItems(e){for(const t of this._keyframeDataItems){if(!e(t))continue;const s=this._keyframeDataItems.indexOf(t);-1!==s&&(t.Release(),this._keyframeDataItems.splice(s,1))}this.SortKeyframeDataItems(),this._LinkKeyframeDataItems()}SortKeyframeDataItems(){this._keyframeDataItems.sort((e,t)=>e.GetTime()-t.GetTime())}GetKeyframeDataItemIndex(e){return this._keyframeDataItems.indexOf(e)}GetKeyframeDataItemFromIndex(e){return this._keyframeDataItems[e]}*keyframeDataItems(){for(const e of this._keyframeDataItems)yield e}*keyframeDataItemsReverse(){for(let e=this._keyframeDataItems.length-1;e>=0;e--)yield this._keyframeDataItems[e]}_SaveToJson(){return{keyframeDataItemsJson:this._keyframeDataItems.map(e=>e._SaveToJson())}}_LoadFromJson(e){e&&(aI.TimelineDataManager._LoadDataItemsFromJson(this._keyframeDataItems,e.keyframeDataItemsJson,uI,this),this._LinkKeyframeDataItems())}}}{const dI=self.C3,_I=0,pI=0,fI=1,mI=2,gI=1,SI=2,GI=3,yI=4,II=5;class TI{constructor(e,t){this._propertyKeyframeData=t,this._value=null,this._aValue=null,this._type="",this._time=NaN,this._ease="noease",this._enable=!1,this._addonData=null,this._addonInstance=void 0,this._pathMode="line",e&&(this._value=e[0][0],this._aValue=e[0][1],this._type=e[0][2],this._time=e[1],this._ease=e[2],this._enable=!!e[3],this._pathMode=e[5],this._addonData=null,e[4]&&(this._addonData=new dI.AddonData(e[4],this)),this._next=null,this._prev=null)}Release(){this._propertyKeyframeData=null,this._addonData&&(this._addonData.Release(),this._addonData=null),this._next=null,this._prev=null}GetAddonData(){return this._addonData}SetNext(e){this._next=e}GetNext(){return this._next}SetPrevious(e){this._prev=e}GetPrevious(){return this._prev}GetValue(){return this._value}SetValue(e){"color"===this._type&&dI.IsFiniteNumber(e)?(this._value[0]=dI.GetRValue(e),this._value[1]=dI.GetGValue(e),this._value[2]=dI.GetBValue(e)):this._value=e}GetAbsoluteValue(){return this._aValue}SetAbsoluteValue(e){"color"===this._type&&dI.IsFiniteNumber(e)?(this._aValue[0]=dI.GetRValue(e),this._aValue[1]=dI.GetGValue(e),this._aValue[2]=dI.GetBValue(e)):this._aValue=e}GetValueWithResultMode(){const e=this._propertyKeyframeData.GetPropertyTrackDataItem().GetResultMode();return"relative"===e?this.GetValue():"absolute"===e?this.GetAbsoluteValue():void 0}GetType(){return this._type}SetType(e){this._type=e}GetTime(){return this._time}SetTime(e){this._time=e,this._propertyKeyframeData._LinkPropertyKeyframeDataItems()}GetEase(){return this._ease}SetEase(e){this._ease=e}GetEnable(){return this._enable}SetEnable(e){this._enable=!!e}GetPathMode(){return this._pathMode}GetAddOn(e){if(!this._addonData)return;if(this._addonInstance||null===this._addonInstance)return this._addonInstance;const t=this._addonData.GetAddDataItemArray();if(!t)return this._addonInstance=null,this._addonInstance;const s=t.length;for(let i=0;i<s;i++){const s=t[i];if(s.GetId()===e)return this._addonInstance=s,this._addonInstance}return this._addonInstance=null,this._addonInstance}_SaveToJson(){const e=this._addonData;return{addonDataJson:e?e._SaveToJson():e,value:this._value,aValue:this._aValue,type:this._type,time:this._time,ease:this._ease,enable:this._enable}}_LoadFromJson(e){e&&(e.addonDataJson&&this._addonData._SetFromJson(e.addonDataJson),this._value=e.value,this._aValue=e.aValue,this._type=e.type,this._time=e.time,this._ease=e.ease,this._enable=e.enable)}}dI.PropertyKeyframeData=class{constructor(e,t){this._propertyTrackDataItem=t,this._propertyKeyframeDataItems=[],this._propertyKeyframeDataItemsIncludingDisabled=[],dI.TimelineDataManager._CreateDataItems(this._propertyKeyframeDataItems,e,TI,this),dI.TimelineDataManager._CreateDataItemsIncludingDisabled(this._propertyKeyframeDataItemsIncludingDisabled,e,TI,this),this._LinkPropertyKeyframeDataItems()}Release(){this._propertyTrackDataItem=null;for(const e of this._propertyKeyframeDataItems)e.Release();dI.clearArray(this._propertyKeyframeDataItems),this._propertyKeyframeDataItems=null;for(const e of this._propertyKeyframeDataItemsIncludingDisabled)e.Release();dI.clearArray(this._propertyKeyframeDataItemsIncludingDisabled),this._propertyKeyframeDataItemsIncludingDisabled=null}_LinkPropertyKeyframeDataItems(){let e=this._propertyKeyframeDataItems;e.sort((e,t)=>e.GetTime()-t.GetTime());for(let t=0;t<e.length;t++){const s=e[t];t+1<e.length&&s.SetNext(e[t+1]),t-1>=0&&s.SetPrevious(e[t-1])}e=this._propertyKeyframeDataItemsIncludingDisabled,e.sort((e,t)=>e.GetTime()-t.GetTime());for(let t=0;t<e.length;t++){const s=e[t];t+1<e.length&&s.SetNext(e[t+1]),t-1>=0&&s.SetPrevious(e[t-1])}}AddEmptyPropertyKeyframeDataItem(){const e=new TI(null,this);return this._propertyKeyframeDataItems.push(e),this._LinkPropertyKeyframeDataItems(),e}DeletePropertyKeyframeDataItems(e){for(const t of this._propertyKeyframeDataItems){if(!e(t))continue;const s=this._propertyKeyframeDataItems.indexOf(t);-1!==s&&(t.Release(),this._propertyKeyframeDataItems.splice(s,1))}this.SortPropertyKeyFrameDataItems(),this._LinkPropertyKeyframeDataItems()}SortPropertyKeyFrameDataItems(){this._propertyKeyframeDataItems.sort((e,t)=>e.GetTime()-t.GetTime())}GetPropertyTrackDataItem(){return this._propertyTrackDataItem}GetPropertyKeyframeDataItemCount(){return this._propertyKeyframeDataItems.length}GetLastPropertyKeyframeDataItem(){return this._propertyKeyframeDataItems[this._propertyKeyframeDataItems.length-1]}GetPropertyKeyframeDataItemArray(){return this._propertyKeyframeDataItems}GetPropertyKeyframeDataItemArrayIncludingDisabled(){return this._propertyKeyframeDataItemsIncludingDisabled}*propertyKeyframeDataItems(){for(const e of this._propertyKeyframeDataItems)yield e}*propertyKeyframeDataItemsReverse(){for(let e=this._propertyKeyframeDataItems.length-1;e>=0;e--)yield this._propertyKeyframeDataItems[e]}_SaveToJson(){const e=this._propertyKeyframeDataItems,t=this._propertyKeyframeDataItemsIncludingDisabled;return{propertyKeyframeDataItemsJson:e.map(e=>e._SaveToJson()),propertyKeyframeDataItemsIncludingDisabledJson:t.map(e=>e._SaveToJson())}}_LoadFromJson(e){e&&(dI.TimelineDataManager._LoadDataItemsFromJson(this._propertyKeyframeDataItems,e.propertyKeyframeDataItemsJson,TI,this),dI.TimelineDataManager._LoadDataItemsFromJson(this._propertyKeyframeDataItemsIncludingDisabled,e.propertyKeyframeDataItemsIncludingDisabledJson,TI,this),this._LinkPropertyKeyframeDataItems())}}}{const CI=self.C3,bI=0,xI=1;class wI{constructor(e,t){this._addonData=t,this._id=e[0],this._data=e[1]}Release(){this._addonData=null,this._data=null}GetAddonData(){return this._addonData}GetId(){return this._id}_SaveToJson(){return{id:this._id,data:this._data}}_LoadFromJson(e){e&&(this._id=e.id,this._data=e.data)}}const PI=0,RI=1,vI=2,AI=3;class MI extends wI{constructor(e,t){super(e,t),this._startAnchor=this._data[0],this._startEnable=!!this._data[1],this._endAnchor=this._data[2],this._endEnable=!!this._data[3]}Release(){super.Release()}GetStartAnchor(){return this._startAnchor}GetStartEnable(){return this._startEnable}GetEndAnchor(){return this._endAnchor}GetEndEnable(){return this._endEnable}_SaveToJson(){return Object.assign(super._SaveToJson(),{startAnchor:this._startAnchor,startEnable:!!this._startEnable,endAnchor:this._endAnchor,endEnable:!!this._endEnable})}_LoadFromJson(e){e&&(super._LoadFromJson(e),this._startAnchor=e.startAnchor,this._startEnable=!!e.startEnable,this._endAnchor=e.endAnchor,this._endEnable=!!e.endEnable)}}const DI=0,EI=1;class FI extends wI{constructor(e,t){super(e,t),this._direction=this._data[0],this._revolutions=this._data[1]}Release(){super.Release()}GetDirection(){return this._direction}GetRevolutions(){return this._revolutions}_SaveToJson(){return Object.assign(super._SaveToJson(),{direction:this._direction,revolutions:this._revolutions})}_LoadFromJson(e){e&&(super._LoadFromJson(e),this._direction=e.direction,this._revolutions=e.revolutions)}}const OI=0;class BI extends wI{constructor(e,t){super(e,t),this._startFrom=this._data[0]}Release(){super.Release()}GetStartFrom(){return this._startFrom}_SaveToJson(){return Object.assign(super._SaveToJson(),{startFrom:this._startFrom})}_LoadFromJson(e){e&&(super._LoadFromJson(e),this._startFrom=e.startFrom)}}CI.AddonData=class{constructor(e,t){this._propertyKeyframeDataItem=t,this._addonDataItems=[],CI.TimelineDataManager._CreateDataItems(this._addonDataItems,e,{prop:0,map:new Map([["cubic-bezier",MI],["angle",FI],["initial-animation",BI]])},this)}Release(){this._propertyKeyframeDataItem=null;for(const e of this._addonDataItems)e.Release();CI.clearArray(this._addonDataItems),this._addonDataItems=null}GetPropertyKeyframeDataItem(){return this._propertyKeyframeDataItem}GetAddDataItemArray(){return this._addonDataItems}*addonDataItems(){for(const e of this._addonDataItems)yield e}_SaveToJson(){return{addonDataItemsJson:this._addonDataItems.map(e=>e._SaveToJson())}}_LoadFromJson(e){e&&CI.TimelineDataManager._LoadDataItemsFromJson(this._addonDataItems,e.addonDataItemsJson,{prop:"id",map:new Map([["cubic-bezier",MI],["angle",FI],["initial-animation",BI]])},this)}}}{const kI=self.C3,LI="start-value",NI="current-state",WI=0,UI=1;let VI=0;kI.TweenState=class extends kI.TimelineState{constructor(e,t){super("tween-"+VI++,e,t),this._id="",this._destroyInstanceOnComplete=!1,this._initialValueMode="start-value",this._instance=null,this._on_completed_callbacks=null,this._on_started_callbacks=null,this._releasePromise=null,this._releaseResolve=null,this._behInst=null,this._track=null,this._iTweenState=null}Release(){this.IsReleased()||(this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensReleased),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweensReleased),this.ResolveReleasePromise(),super.Release(),this._instance=null,this._on_completed_callbacks=null,this._on_started_callbacks=null,this._behInst=null,this._track=null,this._releasePromise=null,this._releaseResolve=null)}FireReleaseEvent(e){const t=kI.New(kI.Event,"tweenstatereleased");t.tweenState=this,e.dispatchEvent(t)}GetType(){return 1}CreateTrackStates(){for(const e of this._timelineDataItem.GetTrackData().trackDataItems())this._tracks.push(kI.TweenTrackState.Create(this,e));this._track=this._tracks[0]}AddTrack(){const e=this._timelineDataItem.GetTrackData().AddEmptyTrackDataItem(),t=kI.TweenTrackState.Create(this,e);return this._tracks.push(t),this._CacheTrack(),t}_CacheTrack(){this._track=this._tracks[0]}GetPropertyTrack(e){return this._track.GetPropertyTracks()[0]}SetPropertyType(e){this._propertyType=e}GetInstance(){const e=this.GetTracks();if(!e||!e.length)return;const t=e[0];if(this._track=t,!t)return;const s=t.GetInstance();return t.IsInstanceValid()?s:void 0}SetBehaviorInstance(e){this._behInst=e}GetReleasePromise(){return this._releasePromise||(this._releasePromise=new Promise(e=>{this._releaseResolve=e})),this._releasePromise}ResolveReleasePromise(){this._releasePromise&&(this._releaseResolve&&this._releaseResolve(),this._releasePromise=null,this._releaseResolve=null)}AddStartedCallback(e){this._on_started_callbacks||(this._on_started_callbacks=[]),this._on_started_callbacks.push(e)}AddCompletedCallback(e){this._on_completed_callbacks||(this._on_completed_callbacks=[]),this._on_completed_callbacks.push(e)}RemoveStartedCallback(e){if(!this._on_started_callbacks)return;const t=this._on_started_callbacks.indexOf(e);-1!==t&&this._on_started_callbacks.splice(t,1)}RemoveCompletedCallback(e){if(!this._on_completed_callbacks)return;const t=this._on_completed_callbacks.indexOf(e);-1!==t&&this._on_completed_callbacks.splice(t,1)}SetStartValue(e,t){for(const s of this._tracks)for(const i of s._propertyTracks){if(i.GetPropertyName()!==t)continue;const s=i.GetPropertyTrackData(),r=i.GetPropertyTrackDataItem(),n=s.GetFirstPropertyKeyframeDataItem(r);n.SetValue(e),n.SetAbsoluteValue(e)}}_GetPropertyTrackState(e){for(const t of this._tracks)for(const s of t._propertyTracks)if(s.GetPropertyName()===e)return s}BeforeSetEndValues(e){let t=!1;for(const s of e){const e=this._GetPropertyTrackState(s);e&&(this.SetStartValue(e.GetCurrentState(),s),t=!0)}if(t){if(this.IsForwardPlayBack()){const e=this.GetTotalTime()-this.GetTime();this.SetTotalTime(e);for(const t of this._tracks)t.SetLocalTotalTime(e);this._SetTime(0)}else{const e=this.GetTime();this.SetTotalTime(e);for(const t of this._tracks)t.SetLocalTotalTime(e);this._SetTime(e)}this.SetInitialStateFromSetTime()}}SetEndValue(e,t){const s=this._GetPropertyTrackState(t);if(!s)return;const i=s.GetPropertyTrackData(),r=s.GetPropertyTrackDataItem(),n=i.GetLastPropertyKeyframeDataItem(r);n.SetTime(this.GetTotalTime()),n.SetValue(e),n.SetAbsoluteValue(e)}SetId(e){this._id=e}GetId(){return this._id}SetInitialValueMode(e){this._initialValueMode=e}GetInitialValueMode(){return this._initialValueMode}SetDestroyInstanceOnComplete(e){this._destroyInstanceOnComplete=e}GetDestroyInstanceOnComplete(){return this._destroyInstanceOnComplete}OnStarted(){if(this._on_started_callbacks)for(const e of this._on_started_callbacks)e(this);if(!this.IsComplete())for(const e of this._tracks)e.CompareSaveStateWithCurrent()}OnCompleted(){this._completedTick=this._runtime.GetTickCount()}FinishTriggers(){if(!this._finishedTriggers&&(this._finishedTriggers=!0,this._on_completed_callbacks))for(const e of this._on_completed_callbacks)e(this)}SetTime(e){this._DeleteIntermediateKeyframes(),super.SetTime(e)}_SetTimeAndReset(e){kI.IsFiniteNumber(e)||(e=this.GetTotalTime()),e<0?this._playheadTime=0:e>=this.GetTotalTime()?this._playheadTime=this.GetTotalTime():this._playheadTime=e,this._track.SetResetState()}SetInitialState(e){if(!this.InitialStateSet()&&"current-state"===this.GetInitialValueMode())for(const e of this._tracks)e.CompareInitialStateWithCurrent();super.SetInitialState(e)}Stop(e=!1){if(super.Stop(e),!this.IsComplete())for(const e of this._tracks)e.SaveState()}Reset(e=!0,t=!1){this._DeleteIntermediateKeyframes(),super.Reset(e,t)}_DeleteIntermediateKeyframes(){for(const e of this._tracks){const t=e=>{const t=e.GetTime(),s=this.GetTotalTime();return 0!==t&&t!==s};e.DeleteKeyframes(t),e.DeletePropertyKeyframes(t)}}_OnBeforeChangeLayout(){if(this.IsReleased())return!0;const e=this.GetInstance();return!(e&&e.GetObjectClass().IsGlobal()||(this._timelineManager.CompleteTimelineBeforeChangeOfLayout(this),this.ResetBeforeChangeLayout(),0))}Tick(e,t,s){if(this._instance||(this._instance=this.GetInstance()),!this._instance||this._instance.IsDestroyed())return this.Stop(!0),void this.OnCompleted();const i=this._instance.GetTimeScale();if(-1!==i&&(e=s*i),0===e&&0===this._lastDelta)return;this._lastDelta=e;const r=this._playheadTime+this._overshoot+e*this._playbackRate,n=this._timelineDataItem._totalTime;r<0?(this._playheadTime=0,this._overshoot=-r):r>=n?(this._playheadTime=n,this._overshoot=this._playheadTime-r):(this._playheadTime=r,this._overshoot=0);let a=!1,o=!1;const h=this.GetLoop(),l=this.GetPingPong();if(h||l?h&&!l?this._playbackRate>0?this._playheadTime>=n&&(this._SetTimeAndReset(0),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):this._playheadTime<=0&&(this._SetTimeAndReset(n),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):!h&&l?this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=0:this._resumePingPongState=0):(this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensPingPong),a=!0):0===this._pingPongState&&(this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=1:this._resumePingPongState=1)):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,1===this._pingPongState?this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=0:this._resumePingPongState=0):(a=!0,this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensPingPong)):0===this._pingPongState&&(this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensPingPong),this.IsPlaying()?this._pingPongState=1:this._resumePingPongState=1)):h&&l&&(this._playbackRate>0?this._playheadTime>=n&&(this._SetTime(n),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,0===this._pingPongState&&(this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensPingPong)),1===this._pingPongState&&(this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensPingPong)),this.IsPlaying()?(this._pingPongState++,this._pingPongState=kI.wrap(this._pingPongState,0,2)):(this._resumePingPongState=this._pingPongState+1,this._resumePingPongState=kI.wrap(this._resumePingPongState,0,2))):this._playheadTime<=0&&(this._SetTime(0),this.SetPlaybackRate(-1*this.GetPlaybackRate()),o=!0,0===this._pingPongState&&(this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensPingPong)),1===this._pingPongState&&(this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenPingPong),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensPingPong)),this.IsPlaying()?(this._pingPongState++,this._pingPongState=kI.wrap(this._pingPongState,0,2)):(this._resumePingPongState=this._pingPongState+1,this._resumePingPongState=kI.wrap(this._resumePingPongState,0,2)))):this._playbackRate>0?this._playheadTime>=n&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(0),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):(this._SetTime(n),a=!0)):this._playheadTime<=0&&(this._currentRepeatCount<this.GetRepeatCount()?(this._currentRepeatCount++,this._SetTimeAndReset(n),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnAnyTweenLoop),this._TweenTrigger(kI.Behaviors.Tween.Cnds.OnTweensLoop),o=!0):(this._SetTime(0),a=!0)),!this.IsReleased()&&this.IsPlaying()){if(a)return this._track.SetEndState(),this.Stop(!0),void this.OnCompleted();this._track.Interpolate(this._playheadTime,!0,!1,o,this._firstTick,!1),this._firstTick&&(this._firstTick=!1)}}_TweenTrigger(e){const t=this.GetInstance();this._behInst.PushTriggerTween(this),this._runtime.Trigger(e,t,this._behInst.GetBehaviorType()),this._behInst.PopTriggerTween()}_SaveToJson(){const e=super._SaveToJson(),t=this.GetTimelineDataItem();return Object.assign(e,{tweenDataItemJson:t._SaveToJson(),id:this._id,destroyInstanceOnComplete:this._destroyInstanceOnComplete,initialValueMode:this._initialValueMode})}_LoadFromJson(e){e&&(this.GetTimelineDataItem()._LoadFromJson(e.tweenDataItemJson),super._LoadFromJson(e),this._id=e.id,this._destroyInstanceOnComplete=e.destroyInstanceOnComplete,this._initialValueMode=e.initialValueMode,this._CacheTrack())}static IsPlaying(e){return e.IsPlaying()}static IsPaused(e){return e.IsPaused()}static IsPing(e){return!!e.GetPingPong()&&0===e.GetPingPongState()}static IsPong(e){return!!e.GetPingPong()&&1===e.GetPingPongState()}static Build(e){const t=e.runtime.GetTimelineManager(),s=new kI.TimelineDataItem;if(e.json){s._LoadFromJson(e.json.tweenDataItemJson);const i=new kI.TweenState(s,t);return i._LoadFromJson(e.json),i}{const i=new kI.TweenState(s,t);kI.IsArray(e.propertyTracksConfig)||(e.propertyTracksConfig=[e.propertyTracksConfig]),i.SetId(e.id),i.SetTags(e.tags),i.SetInitialValueMode(e.initialValueMode),i.SetDestroyInstanceOnComplete(e.releaseOnComplete),i.SetLoop(e.loop),i.SetPingPong(e.pingPong),i.SetTotalTime(e.time),i.SetStep(0),i.SetInterpolationMode("default"),i.SetResultMode(e.propertyTracksConfig[0].resultMode),i.SetRepeatCount(e.repeatCount);const r=i.AddTrack();r.SetInstanceUID(e.instance.GetUID()),r.SetInterpolationMode("default"),r.SetResultMode(e.propertyTracksConfig[0].resultMode),r.SetEnable(!0),r.SetObjectClassIndex(e.instance.GetObjectClass().GetIndex());const n=e.instance.GetSdkInstance(),a=n.IsOriginalSizeKnown()?n.GetOriginalWidth():e.instance.GetWorldInfo().GetWidth(),o=n.IsOriginalSizeKnown()?n.GetOriginalHeight():e.instance.GetWorldInfo().GetHeight();r.SetOriginalWidth(a),r.SetOriginalHeight(o);const h=r.AddKeyframe();h.SetTime(0),h.SetEase("noease"),h.SetEnable(!0),h.SetTags("");const l=r.AddKeyframe();l.SetTime(e.time),l.SetEase("noease"),l.SetEnable(!0),l.SetTags("");for(const t of e.propertyTracksConfig){const s=r.AddPropertyTrack();s.SetSourceAdapterId(t.sourceId),s.SetSourceAdapterArgs(t.sourceArgs),s.SetPropertyName(t.property),s.SetPropertyType(t.type),s.SetMin(NaN),s.SetMax(NaN),s.SetInterpolationMode("default"),s.SetResultMode(t.resultMode),s.SetEnable(!0);const i=s.AddPropertyKeyframe();i.SetType(t.valueType),i.SetTime(0),i.SetEase(t.ease),i.SetEnable(!0),i.SetValue(t.startValue),i.SetAbsoluteValue(t.startValue);const n=s.AddPropertyKeyframe();n.SetType(t.valueType),n.SetTime(e.time),n.SetEase(t.ease),n.SetEnable(!0),n.SetValue(t.endValue),n.SetAbsoluteValue(t.endValue),s.GetSourceAdapter()}return i}}static SetInstanceUID(e,t){if(!isNaN(t))for(const s of e.GetTracks())s.SetInstanceUID(t)}static SetBehaviorInstance(e,t){e.SetBehaviorInstance(t)}GetITweenState(e,t){return this._iTweenState||(this._iTweenState=kI.New(self.ITweenState,this,e,t)),this._iTweenState}}}{const HI=self.C3;HI.TweenTrackState=class extends HI.TrackState{constructor(e,t){super(e,t),this._firstPropertyTrack=null,this._secondPropertyTrack=null}static Create(e,t){return HI.New(HI.TweenTrackState,e,t)}_CachePropertyTracks(){1===this._propertyTracks.length?this._firstPropertyTrack=this._propertyTracks[0]:(this._firstPropertyTrack=this._propertyTracks[0],this._secondPropertyTrack=this._propertyTracks[1])}CreatePropertyTrackStates(){for(const e of this._trackDataItem.GetPropertyTrackData().propertyTrackDataItems())this._propertyTracks.push(HI.TweenPropertyTrackState.Create(this,e));this._CachePropertyTracks()}AddPropertyTrack(){const e=this._trackDataItem.GetPropertyTrackData().AddEmptyPropertyTrackDataItem(),t=HI.TweenPropertyTrackState.Create(this,e);return this._propertyTracks.push(t),this._CachePropertyTracks(),t}SetInitialState(){if(this.MaybeGetInstance(),!this.IsInstanceValid()&&this.IsInstanceTrack())return;const e=this.GetTimeline().IsForwardPlayBack()?0:this.GetLocalTotalTime();for(const t of this._propertyTracks)t.SetInitialState(e),0===this._worldInfoChange&&1===t.GetWorldInfoChange()&&(this._worldInfoChange=1),0===this._renderChange&&1===t.GetRenderChange()&&(this._renderChange=1);this._needsBeforeAndAfter=0,this._propertyTracks.some(e=>e.GetNeedsBeforeAndAfter())&&(this._needsBeforeAndAfter=1),this._lastKeyframeDataItem=this._GetLastKeyFrameBeforeTime(e),this._initialStateOfNestedSet=!1,this._endStateOfNestedSet=!1,this.Interpolate(e)}BeforeInterpolate(){}Interpolate(e,t=!1,s=!1,i=!1,r=!1,n=!1,a=!1){if(this._instance||this.GetInstance(),this._instance)return!this._instance.IsDestroyed()&&(!n||!this.GetObjectClass().IsGlobal())&&(this._secondPropertyTrack?(this._firstPropertyTrack.Interpolate(e,s,i,a),this._secondPropertyTrack.Interpolate(e,s,i,a)):this._firstPropertyTrack.Interpolate(e,s,i,a),void(0!==this._firstPropertyTrack.GetWorldInfoChange()&&(this._worldInfo||(this._worldInfo=this._instance.GetWorldInfo()),this._worldInfo&&this._worldInfo.SetBboxChanged())))}AfterInterpolate(){}_LoadFromJson(e){super._LoadFromJson(e),this._CachePropertyTracks()}}}{const jI=self.C3;jI.TweenPropertyTrackState=class extends jI.PropertyTrackState{constructor(e,t){super(e,t),this._basic=!1}static Create(e,t){return jI.New(jI.TweenPropertyTrackState,e,t)}Interpolate(e,t=!1,s=!1,i=!1){let r,n;if(this._basic)r=this._propertyKeyframeDataItems[0],n=this._propertyKeyframeDataItems[1];else if(t)r=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem),n=r.GetNext();else{if(this._lastPropertyKeyframeDataItem){const t=this.GetTimeline(),s=this._lastPropertyKeyframeDataItem.GetNext(),i=this._lastPropertyKeyframeDataItem.GetTime(),r=s?s.GetTime():t.GetTotalTime();(e<=i||e>=r)&&(this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem))}else this._lastPropertyKeyframeDataItem=this._propertyTrackData.GetFirstPropertyKeyFrameDataItemLowerOrEqualThan(e,this._propertyTrackDataItem);r=this._lastPropertyKeyframeDataItem,n=r.GetNext()}this._sourceAdapter.Interpolate(e,r,n,t,s,i)}AddPropertyKeyframe(){const e=this._propertyTrackDataItem.GetPropertyKeyframeData().AddEmptyPropertyKeyframeDataItem();return this._lastPropertyKeyframeDataItem=null,this._basic=this.GetPropertyKeyframeDataItems().length<=2,e}DeletePropertyKeyframes(e){this._lastPropertyKeyframeDataItem=null,this._propertyTrackDataItem.GetPropertyKeyframeData().DeletePropertyKeyframeDataItems(e),this._basic=this.GetPropertyKeyframeDataItems().length<=2}_SaveToJson(){return{sourceAdapterJson:this.GetSourceAdapter()._SaveToJson(),basic:this._basic}}_LoadFromJson(e){e&&(this.GetSourceAdapter()._LoadFromJson(e.sourceAdapterJson),this._basic=e.basic)}}}{const zI=self.C3,XI=self.Ease,YI=0,qI=1,KI=2;zI.Transition=class extends zI.DefendedBase{constructor(e,t=!0){super(),this._name=e[0],this._linear=e[2],this._transitionKeyframes=[];for(const t of e[1]){const e=zI.TransitionKeyframe.Create(this,t);this._transitionKeyframes.push(e)}for(let e=0;e<this._transitionKeyframes.length;e++){const t=this._transitionKeyframes[e],s=this._transitionKeyframes[e+1],i=this._transitionKeyframes[e-1];t.SetNext(s),t.SetPrevious(i)}this._precalculatedSamples=new Map,this._transitionKeyframeCache=new Map,this._PreCalcSamples(),t&&XI.AddCustomEase(this._name,(e,t,s,i)=>this.Interpolate(e,t,s,i),null,{transition:this})}static Create(e){return zI.New(zI.Transition,e)}Release(){for(const e of this._transitionKeyframes)e.Release();zI.clearArray(this._transitionKeyframes),this._transitionKeyframes=null,this._precalculatedSamples.clear(),this._precalculatedSamples=null,this._transitionKeyframeCache.clear(),this._transitionKeyframeCache=null}MakeLinear(e){this._linear=!!e}GetTransitionKeyFrameAt(e){const t=this._transitionKeyframeCache.get(e);if(t)return t;for(const t of this._transitionKeyframes)if(t.GetValueX()===e)return this._transitionKeyframeCache.set(e,t),t}GetFirstTransitionKeyFrameLowerOrEqualThan(e){for(let t=this._transitionKeyframes.length-1;t>=0;t--){const s=this._transitionKeyframes[t],i=s.GetValueX();if(i<=e){let t=s;if(i<e)return t;if(i===e){for(;t;){const e=t.GetPrevious();if(!e)break;if(e.GetValueX()!==t.GetValueX())break;t=e}return t}}}}Interpolate(e,t,s,i){let r=e/i;if(this._linear){const r=this.GetTransitionKeyFrameAt(0),n=this.GetTransitionKeyFrameAt(1),a=t+(t+s)*r.GetValueY(),o=(t+s)*n.GetValueY()-a;return 0===i?a+o:XI.NoEase(e,a,o,i)}0===i&&(r=1);let n=this.GetFirstTransitionKeyFrameLowerOrEqualThan(r),a=n.GetNext();if(!a){const e=n.GetPrevious(),t=n;n=e,a=t}const o=a.GetValueX()-n.GetValueX(),h=zI.mapToRange(r,n.GetValueX(),a.GetValueX(),0,o);if(n.IsSegmentLinear()||0===o){const e=t+(t+s)*n.GetValueY(),i=(t+s)*a.GetValueY()-e;return 0===o?1===h?e+i:e:XI.NoEase(h,e,i,o)}const l=n.GetValueX(),c=n.GetValueY(),u=n.GetValueX()+n.GetStartAnchorX(),d=n.GetValueY()+n.GetStartAnchorY(),_=a.GetValueX()+a.GetEndAnchorX(),p=a.GetValueY()+a.GetEndAnchorY(),f=a.GetValueX(),m=a.GetValueY();let g=XI.GetRuntimeEase("spline")(h,l,c,u,d,_,p,f,m,this._precalculatedSamples.get(n));return g+=n.GetValueY(),(1-g)*t+g*(t+s)}_PreCalcSamples(){this._precalculatedSamples.clear();for(let e=0;e<this._transitionKeyframes.length-1;e++){const t=this._transitionKeyframes[e];if(!t.GetStartEnable())continue;const s=t,i=this._transitionKeyframes[e+1];if(!i.GetEndEnable())continue;const r=s.GetValueX(),n=s.GetValueX()+s.GetStartAnchorX(),a=i.GetValueX()+i.GetEndAnchorX(),o=i.GetValueX();this._precalculatedSamples.set(s,XI.GetBezierSamples(r,n,a,o))}}}}{const $I=self.C3,JI=0,ZI=1,QI=2,eT=3,tT=4,sT=5,iT=6,rT=7,nT=8;$I.TransitionKeyframe=class extends $I.DefendedBase{constructor(e,t){super(),this._transition=e,this._valueX=t[0],this._valueY=t[1],this._startAnchorX=t[2],this._startAnchorY=t[3],this._endAnchorX=t[4],this._endAnchorY=t[5],this._startEnable=t[6],this._endEnable=t[7],this._segmentMode=t[8],this._next=null,this._prev=null}Release(){this._transition=null}static Create(e,t){return $I.New($I.TransitionKeyframe,e,t)}SetNext(e){this._next=e}GetNext(){return this._next}SetPrevious(e){this._prev=e}GetPrevious(){return this._prev}GetValueX(){return this._valueX}GetValueY(){return this._valueY}GetStartAnchorX(){return this._startAnchorX}GetStartAnchorY(){return this._startAnchorY}GetEndAnchorX(){return this._endAnchorX}GetEndAnchorY(){return this._endAnchorY}GetStartEnable(){return this._startEnable}GetEndEnable(){return this._endEnable}IsSegmentLinear(){return"linear"===this._segmentMode}IsSegmentCubic(){return"cubic"===this._segmentMode}}}{const aT=self.C3;aT.TransitionManager=class extends aT.DefendedBase{constructor(e){super(),this._runtime=e,this._transitions=[]}Release(){for(const e of this._transitions)e.Release();aT.clearArray(this._transitions),this._transitions=null}Create(e){this._transitions.push(aT.Transition.Create(e))}}}{const oT=self.C3;oT.TemplateManager=class extends oT.DefendedBase{constructor(e){super(),this._runtime=e,this._templateDataMap=null,this._instanceToTemplateNameMap=null,this._instanceDestroy=e=>this._OnInstanceDestroy(e.instance)}Release(){if(this.RemoveRuntimeListeners(),this._templateDataMap){for(const e of this._templateDataMap.values())e.clear();this._templateDataMap.clear()}this._templateDataMap=null,this._runtime=null}Create(e){if(this._templateDataMap||(this._templateDataMap=new Map),!e)return;const t=e[0][16][0],s=e[1];this._templateDataMap.has(s)||this._templateDataMap.set(s,new Map),this._templateDataMap.get(s).set(t,e)}AddRuntimeListeners(){const e=this._runtime.Dispatcher();e&&e.addEventListener("instancedestroy",this._instanceDestroy)}RemoveRuntimeListeners(){const e=this._runtime.Dispatcher();e&&e.removeEventListener("instancedestroy",this._instanceDestroy)}HasTemplates(){return!!this._templateDataMap&&0!==this._templateDataMap.size}GetTemplateData(e,t){let s=0;if(s=e instanceof oT.ObjectClass?e.GetIndex():e,!this._templateDataMap.has(s))return;const i=this._templateDataMap.get(s).get(t);return i?JSON.parse(JSON.stringify(i)):void 0}MapInstanceToTemplateName(e,t){this._instanceToTemplateNameMap||(this._instanceToTemplateNameMap=new WeakMap),this._instanceToTemplateNameMap.has(e)||this._instanceToTemplateNameMap.set(e,t)}GetInstanceTemplateName(e){if(!this._instanceToTemplateNameMap)return"";return this._instanceToTemplateNameMap.get(e)||""}_OnInstanceDestroy(e){this._instanceToTemplateNameMap&&this._instanceToTemplateNameMap.has(e)&&this._instanceToTemplateNameMap.delete(e)}}}{const hT=self.C3;hT.FlowchartManager=class{constructor(e){this._runtime=e,this._flowchartDataManager=new hT.FlowchartDataManager}Release(){this._flowchartDataManager.Release(),this._flowchartDataManager=null,this._runtime=null}GetRuntime(){return this._runtime}Create(e){this._flowchartDataManager.Add(e)}GetFlowchartDataItemByName(e){return this._flowchartDataManager.Get(e)}HasFlowcharts(){return this._flowchartDataManager.HasFlowcharts()}}}{const lT=self.C3;lT.FlowchartState=class{constructor(e,t,s,i,r,n,a){this._runtime=r.GetRuntime(),this._flowchartManager=r,this._flowchartName=e,this._startNodeTag=s,this._flowchartDataItem=i,this._tag=t,this._pluginInstance=n,this._pluginUID=a??n.GetInstance().GetUID(),this._SetStartFlowchartNode(),this._currentFlowchartNodeId=this._startFlowchartNode?.GetFlowchartId()??-1,this._previousFlowchartNodeIds=[],this._previousFlowchartState=null,this._previousFlowchartStateStartNodeId=NaN,this._referenceFlowchartStates=null,this._currentReferenceFlowchartState=null,this._rootFlowchartState=null,this._previousFlowchartStateTag="",this._referenceFlowchartStatesJson=null,this._currentReferenceFlowchartStateTag="",this._rootFlowchartStateTag="",this._triggerCount=0,this._markForRelease=!1,this._released=!1}Release(){this._released||(lT.clearArray(this._previousFlowchartNodeIds),this._previousFlowchartNodeIds=null,this._runtime=null,this._flowchartManager=null,this._flowchartDataItem=null,this._pluginInstance=null,this._previousFlowchartState=null,this._previousFlowchartStateStartNodeId=NaN,this._referenceFlowchartStates&&this._referenceFlowchartStates.clear(),this._referenceFlowchartStates=null,this._currentReferenceFlowchartState=null,this._rootFlowchartState=null,this._previousFlowchartStateTag="",this._referenceFlowchartStatesJson=null,this._currentReferenceFlowchartStateTag="",this._rootFlowchartStateTag="",this._released=!0)}WasReleased(){return this._released}GetFlowchartManager(){return this._flowchartManager}GetRuntime(){return this._runtime}GetName(){return this._flowchartName}GetFlowchartDataItem(){return this._flowchartDataItem}GetTag(){return this._tag}GetPluginInstance(){return this._pluginInstance||(this._pluginInstance=this._runtime.GetInstanceByUID(this._pluginUID).GetSdkInstance()),this._pluginInstance}GetCurrentNode(){return this.GetFlowchartElementById(this._currentFlowchartNodeId)}GetCurrentNodeTag(){const e=this.GetCurrentNode();return e?e.GetTag():""}GetCurrentNodeTags(){const e=this.GetCurrentNode();return e?e.GetTags():[]}CurrentNodeHasTags(e){const t=this.GetCurrentNodeTags();if(!t)return!1;if(!t.length)return!1;const s=lT.FlowchartState._GetTagArray(e);return!(!s||!s.length)&&s.every(lT.FlowchartState._HasTag,t)}CurrentNodeCompareTags(e,t){const s=this.GetCurrentNodeTags();if(!s)return!1;if(!s.length)return!1;const i=lT.FlowchartState._GetTagArray(e);return!(!i||!i.length)&&i.every(e=>lT.FlowchartState._CompareTag.call(s,e,t))}static _HasTag(e){const t=this;return""===e?1===t.length&&""===t[0]:t.map(e=>e.trim().toLowerCase()).includes(e.trim().toLowerCase())}static _GetTagArray(e){return e.trim().split(" ")}static _CompareTag(e,t){const s=this;return""===e?1===s.length&&""===s[0]:s.some(s=>lT.compare(s.trim(),t,e.trim()))}GetCurrentNodeParent(e){const t=this.GetCurrentNode();if(t){if(lT.IsFiniteNumber(e)){const s=t.GetParentFlowchartIds(),i=s?s[e]:void 0;if(lT.IsFiniteNumber(i))return this.GetFlowchartElementById(i)}if("string"==typeof e)for(const s of t.GetParentFlowchartIds()){const t=this.GetFlowchartElementById(s);if(t.HasTags(e))return this.GetFlowchartElementById(t.GetFlowchartId())}}}GetCurrentNodeParentTag(e){const t=this.GetCurrentNodeParent(e);return t?t.GetTag():""}GetCurrentNodeParentTags(e){const t=this.GetCurrentNodeParent(e);return t?t.GetTags():""}GetCurrentNodeParentIndex(e){const t=this.GetCurrentNode();if(!t)return-1;const s=t.GetParentFlowchartIds();if(!s)return-1;const i=this.GetCurrentNodeParent(e);return i?s.indexOf(i.GetFlowchartId()):-1}GetCurrentNodeParentCount(){const e=this.GetCurrentNode();if(!e)return 0;const t=e.GetParentFlowchartIds();return t?t.length:0}GetFlowchartElementById(e){return this._flowchartDataItem.GetFlowchartElementById(e)}Reset(){this._GetRootFlowchartState()._Reset(!0)}_Reset(e){if(this._GetReferenceFlowchartStates()){for(const[e,t]of this._GetReferenceFlowchartStates().entries())t._Reset(!1);this._GetReferenceFlowchartStates().clear()}if(this._referenceFlowchartStates=null,this._previousFlowchartState=null,this._previousFlowchartStateStartNode=null,this._currentReferenceFlowchartState=null,this._previousFlowchartStateTag="",this._referenceFlowchartStatesJson=null,this._currentReferenceFlowchartStateTag="",this._rootFlowchartStateTag="",this._previousFlowchartNodeIds=[],e){this._flowchartManager.SetCurrentFlowchartState(this);const e=this._startFlowchartNode.GetFlowchartId();e!==this._currentFlowchartNodeId&&this._GotoFlowchartNode(e)}else this._currentFlowchartNodeId=this._startFlowchartNode.GetFlowchartId()}GetCurrentNodeOutputCount(){const e=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);return e?e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItemCount():0}IsIndexOfDefaultOutput(e){return!(e<0)&&e===this.GetDefaultOutputIndex()}GetDefaultOutputIndex(){const e=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);if(!e)return-1;let t=e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault();return t?e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems().indexOf(t):-1}GetCurrentNodeOutputNameAt(e){const t=this._GetFlowchartNodeOutputAt(e);return t?t.GetName():""}GetCurrentNodeOutputValueAt(e){let t;return lT.IsFiniteNumber(e)&&(t=this._GetFlowchartNodeOutputAt(e)),"string"==typeof e&&(t=this._GetFlowchartNodeOutputByName(e)),"number"!=typeof e&&"string"!=typeof e&&console.warn("[Flowcharts] unexpected argument type in GetCurrentNodeOutputValueAt expression"),t?t.GetValue():""}_MaybeByPassNodes(e,t){if(e.GetEnable())return e.GetFlowchartId();{const s=e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault();if(!s)return t.GetFlowchartId();const i=s.GetConnectedFlowchartNodeFlowchartId();if(!lT.IsFiniteNumber(i))return t.GetFlowchartId();const r=this.GetFlowchartElementById(i);return r?this._MaybeByPassNodes(r,t):t.GetFlowchartId()}}_MaybeByPassNodesInReferenceFlowchart(e,t){if(e.GetEnable()){if("reference"===e.GetType()){const t=e.GetReferenceFlowchartName(),s=e.GetReferenceFlowchartStartNodeTag(),i=this._flowchartManager.GetFlowchartDataItemByName(t);if(!i)return[-1,null];const r=i.GetFlowchartNodeByTags(s);return r?this._MaybeByPassNodesInReferenceFlowchart(r,i):this._MaybeByPassNodesInReferenceFlowchart(i.GetFlowchartStartNode(),i)}return[e.GetFlowchartId(),t]}{const s=e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault();if(!s)return[-1,null];const i=s.GetConnectedFlowchartNodeFlowchartId();if(!lT.IsFiniteNumber(i))return[-1,null];const r=t.GetFlowchartElementById(i);return r?this._MaybeByPassNodesInReferenceFlowchart(r,t):[-1,null]}}_ProcessAllByPasses(e,t){let s=this.GetFlowchartElementById(e);if(s){if(!s.GetEnable()){const t=this.GetFlowchartElementById(this._currentFlowchartNodeId);e=this._MaybeByPassNodes(s,t)}if(lT.IsFiniteNumber(e)&&e!==this._currentFlowchartNodeId)if(s=this.GetFlowchartElementById(e),"reference"===s.GetType()){const i=s.GetReferenceFlowchartName(),r=s.GetReferenceFlowchartStartNodeTag(),n=this._flowchartManager.GetFlowchartDataItemByName(i);let a=n.GetFlowchartNodeByTags(r);if(a){const s=this._MaybeByPassNodesInReferenceFlowchart(a,n);if(-1===s[0])return;t(this._currentFlowchartNodeId,e,s[1],s[0])}else t(this._currentFlowchartNodeId,e)}else t(this._currentFlowchartNodeId,e)}}GotoNextFlowchartNode(e){let t;if(lT.IsFiniteNumber(e)&&(t=this._GetFlowchartNodeOutputAt(e)),"string"==typeof e&&(t=this._GetFlowchartNodeOutputByName(e)),!t)return;let s=t.GetConnectedFlowchartNodeFlowchartId();lT.IsFiniteNumber(s)&&this._ProcessAllByPasses(s,(e,t,s,i)=>{this._previousFlowchartNodeIds.push(e),this._GotoFlowchartNode(t,s,i)})}GotoNextFlowchartNodeDefault(){const e=this._GetFlowchartNodeOutputDefault();if(!e)return;const t=e.GetConnectedFlowchartNodeFlowchartId();lT.IsFiniteNumber(t)&&this._ProcessAllByPasses(t,(e,t,s,i)=>{this._previousFlowchartNodeIds.push(e),this._GotoFlowchartNode(t,s,i)})}GotoAnyFlowchartNode(e){const t=this._flowchartDataItem.GetFlowchartNodeByTags(e);if(!t)return;const s=t.GetFlowchartId();lT.IsFiniteNumber(s)&&this._ProcessAllByPasses(s,(e,t,s,i)=>{this._previousFlowchartNodeIds.push(e),this._GotoFlowchartNode(t,s,i)})}GotoPreviousFlowchartNode(){const e=this._previousFlowchartNodeIds.pop();lT.IsFiniteNumber(e)?this._GotoFlowchartNode(e):this._GetPreviousFlowchartState()&&(this._flowchartManager.SetCurrentFlowchartState(this._GetPreviousFlowchartState(),!0,!1,!1),this._GetPreviousFlowchartState()._GotoFlowchartNode(this._GetPreviousFlowchartStateStartNodeId()),this._GetRootFlowchartState()._SetCurrentReferenceFlowchart(this._GetPreviousFlowchartState()))}GotoParentFlowchartNode(e){if(!this.GetCurrentNode())return;const t=this.GetCurrentNodeParent(e);if(t){if(!t.GetEnable())return;const e=t.GetFlowchartId();if(!lT.IsFiniteNumber(e))return;this._previousFlowchartNodeIds.push(this._currentFlowchartNodeId),this._GotoFlowchartNode(t.GetFlowchartId())}}HasOutput(e){if(lT.IsFiniteNumber(e))return!!this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId).GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems()[e];if("string"==typeof e){const t=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId).GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems();for(let s=0;s<t.length;s++)if(t[s].GetName()===e)return!0;return!1}return!1}MarkForRelease(){this._markForRelease=!0}IsInTriggerState(){return this._triggerCount>0}PushIsTriggerState(){this._triggerCount++}PopIsTriggerState(){this._triggerCount--,0===this._triggerCount&&this._markForRelease&&this._flowchartManager.RemoveFlowchartState(this)}_GotoFlowchartNode(e,t,s){const i=this._currentFlowchartNodeId,r=this.GetPluginInstance().GetInstance();this.PushIsTriggerState(),this._flowchartManager.PushFlowchartState(this),this._runtime.Trigger(lT.Plugins.Flowchart.Cnds.OnBeforeAnyNodeChange,r),this._runtime.Trigger(lT.Plugins.Flowchart.Cnds.OnBeforeTaggedNodeChange,r),this._runtime.Trigger(lT.Plugins.Flowchart.Cnds.OnBeforeAnyNodeChangeInFlowchart,r),this._runtime.Trigger(lT.Plugins.Flowchart.Cnds.OnBeforeTaggedNodeChangeInFlowchart,r),this._currentFlowchartNodeId=e;let n=this.GetFlowchartElementById(this._currentFlowchartNodeId);if("dictionary"===n.GetType()&&(this._runtime.Trigger(lT.Plugins.Flowchart.Cnds.OnAnyNodeChange,r),this._runtime.Trigger(lT.Plugins.Flowchart.Cnds.OnTaggedNodeChange,r),this._runtime.Trigger(lT.Plugins.Flowchart.Cnds.OnAnyNodeChangeInFlowchart,r),this._runtime.Trigger(lT.Plugins.Flowchart.Cnds.OnTaggedNodeChangeInFlowchart,r)),this._flowchartManager.PopFlowchartState(),this.PopIsTriggerState(),!this.WasReleased()&&(n=this.GetFlowchartElementById(this._currentFlowchartNodeId),"reference"===n.GetType())){const e=t?t.GetName():n.GetReferenceFlowchartName();if(this._HasReferenceFlowchartState(n)){this._previousFlowchartNodeIds.pop();const e=this._GetReferenceFlowchartState(n);this._flowchartManager.SetCurrentFlowchartState(e,!0,!0,!1),e._SetPreviousFlowchart(this,i),this._GetRootFlowchartState()._SetCurrentReferenceFlowchart(e)}else{const t="number"==typeof s?s:n.GetReferenceFlowchartStartNodeTag();if(e){this._previousFlowchartNodeIds.pop();let s=n.GetReferenceFlowchartTag();if(s){let e=this._flowchartManager.GetFlowchartState(s);for(;e;)s=lT.IncrementNumberAtEndOf(s),e=this._flowchartManager.GetFlowchartState(s)}else{s=`${e}-ref`;let t=this._flowchartManager.GetFlowchartState(s);for(;t;)s=lT.IncrementNumberAtEndOf(s),t=this._flowchartManager.GetFlowchartState(s)}const r=this._flowchartManager.AddFlowchartState(e,t,s,this._pluginInstance,!0);r._SetPreviousFlowchart(this,i),this._SetReferenceFlowchartState(n,r);const a=this._GetRootFlowchartState();r._SetRootFlowchartState(a),a._SetCurrentReferenceFlowchart(r)}}}}_GetFlowchartNodeOutputDefault(){const e=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);return e?e.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDefault():null}_GetFlowchartNodeOutputAt(e){const t=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);if(!t)return null;const s=t.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItems();if(!s)return null;return s[e]||null}_GetFlowchartNodeOutputByName(e){const t=this._flowchartDataItem.GetFlowchartElementById(this._currentFlowchartNodeId);if(!t)return null;return t.GetFlowchartNodeOutputData().GetFlowchartNodeOutputDataItemByName(e)||null}_SetStartFlowchartNode(e){if("number"==typeof e){let t=this.GetFlowchartElementById(e);t||(t=this._flowchartDataItem.GetFlowchartStartNode()),this._startFlowchartNode=t}else if("number"==typeof this._startNodeTag){let e=this.GetFlowchartElementById(this._startNodeTag);e||(e=this._flowchartDataItem.GetFlowchartStartNode()),this._startFlowchartNode=e}else{let e=this._flowchartDataItem.GetFlowchartNodeByTags(this._startNodeTag);e||(e=this._flowchartDataItem.GetFlowchartStartNode()),this._startFlowchartNode=e}}_SaveToJson(){return this._markForRelease?null:{flowchartName:this._flowchartName,flowchartTag:this._tag,startNodeTag:this._startNodeTag,currentNodeId:this._currentFlowchartNodeId,previousNodeIds:this._previousFlowchartNodeIds,pluginUID:this._pluginInstance.GetInstance().GetUID(),reference:{previousFlowchartTag:this._GetPreviousFlowchartState()?this._GetPreviousFlowchartState().GetTag():"",previousStartNodeId:lT.IsFiniteNumber(this._GetPreviousFlowchartStateStartNodeId())?this._GetPreviousFlowchartStateStartNodeId():NaN,referencesJson:this._GetFlowchartReferencesJson(),currentReferenceFlowchartTag:this.GetCurrentReferenceFlowchart()?this.GetCurrentReferenceFlowchart().GetTag():"",rootFlowchartTag:this._GetRootFlowchartState()?this._GetRootFlowchartState().GetTag():""}}}_GetFlowchartReferencesJson(){if(!this._HasReferenceFlowchartStates())return null;const e=[];for(const[t,s]of this._GetReferenceFlowchartStates().entries())e.push({flowchartElementId:t.GetFlowchartId(),flowchartStateTag:s.GetTag()});return e.length?e:null}_LoadFromJson(e){if(e){if(this._flowchartName=e.flowchartName,this._tag=e.flowchartTag,this._startNodeTag=e.startNodeTag,this._currentFlowchartNodeId=e.currentNodeId,this._previousFlowchartNodeIds=e.previousNodeIds,this._pluginUID=e.pluginUID,e.hasOwnProperty("reference")){const t=e.reference;this._previousFlowchartStateTag=t.previousFlowchartTag,this._previousFlowchartStateStartNodeId=t.previousStartNodeId,this._referenceFlowchartStatesJson=t.referencesJson,this._currentReferenceFlowchartStateTag=t.currentReferenceFlowchartTag,this._rootFlowchartStateTag=t.rootFlowchartTag}this._SetStartFlowchartNode()}}_GetPreviousFlowchartState(){return"string"==typeof this._previousFlowchartStateTag&&this._previousFlowchartStateTag&&(this._previousFlowchartState=this._flowchartManager.GetFlowchartState(this._previousFlowchartStateTag),this._previousFlowchartStateTag=""),this._previousFlowchartState}_GetPreviousFlowchartStateStartNodeId(){return this._previousFlowchartStateStartNodeId}_SetPreviousFlowchart(e,t){this._previousFlowchartState=e,this._previousFlowchartStateStartNodeId=t}GetCurrentReferenceFlowchart(){return"string"==typeof this._currentReferenceFlowchartStateTag&&this._currentReferenceFlowchartStateTag&&(this._currentReferenceFlowchartState=this._flowchartManager.GetFlowchartState(this._currentReferenceFlowchartStateTag),this._currentReferenceFlowchartStateTag=""),this._currentReferenceFlowchartState}_SetCurrentReferenceFlowchart(e){this._currentReferenceFlowchartState=e,this._currentReferenceFlowchartState===this&&(this._currentReferenceFlowchartState=null)}_GetRootFlowchartState(){return"string"==typeof this._rootFlowchartStateTag&&this._rootFlowchartStateTag&&(this._rootFlowchartState=this._flowchartManager.GetFlowchartState(this._rootFlowchartStateTag),this._rootFlowchartStateTag=""),this._rootFlowchartState?this._rootFlowchartState:this}_SetRootFlowchartState(e){this._rootFlowchartState=e}_HasReferenceFlowchartStates(){return this._RebuildReferenceFlowchartStates(),!!this._referenceFlowchartStates}_HasReferenceFlowchartState(e){return this._RebuildReferenceFlowchartStates(),this._referenceFlowchartStates&&this._referenceFlowchartStates.has(e)}_RebuildReferenceFlowchartStates(){if(this._referenceFlowchartStatesJson){this._referenceFlowchartStates&&this._referenceFlowchartStates.clear(),this._referenceFlowchartStates||(this._referenceFlowchartStates=new Map);for(const e of this._referenceFlowchartStatesJson){const t=this._flowchartManager.GetFlowchartState(e.flowchartStateTag),s=t.GetFlowchartElementById(e.flowchartElementId);this._referenceFlowchartStates.set(s,t)}this._referenceFlowchartStatesJson=null}}_GetReferenceFlowchartStates(){return this._RebuildReferenceFlowchartStates(),this._referenceFlowchartStates}_GetReferenceFlowchartState(e){return this._RebuildReferenceFlowchartStates(),this._referenceFlowchartStates.get(e)}_SetReferenceFlowchartState(e,t){this._referenceFlowchartStates||(this._referenceFlowchartStates=new Map),this._referenceFlowchartStates.set(e,t)}}}{const cT=self.C3;cT.FlowchartStateManager=class{constructor(e){this._runtime=e,this._flowchartStates=new Map,this._currentFlowchartState=null,this._flowchartStateStack=[],this._on_after_load=()=>this._OnAfterLoad(),this._loadJson=null}Release(){cT.clearArray(this._flowchartStateStack),this._flowchartStateStack=null,this._flowchartStates.clear(),this._flowchartStates=null,this._currentFlowchartState=null,this._runtime=null,this._loadJson=null}GetRuntime(){return this._runtime}GetFlowchartDataItemByName(e){return this._runtime.GetFlowchartManager().GetFlowchartDataItemByName(e)}AddFlowchartState(e,t,s,i,r,n){const a=this._runtime.GetFlowchartManager().GetFlowchartDataItemByName(e);if(!a)return void console.warn(`[Flowcharts] no flowchart found with name '${e}'`);if(this._flowchartStates.has(s)){const e=this._flowchartStates.get(s);e&&this.RemoveFlowchartState(e)}const o=new cT.FlowchartState(e,s,t,a,this,i,n);return this._flowchartStates.set(s,o),r&&this.SetCurrentFlowchartState(o,!0),o}RemoveFlowchartState(e){if(e.MarkForRelease(),e.IsInTriggerState())return;const t=e.GetTag();this._flowchartStates.delete(t),e.Release(),this._currentFlowchartState===e&&(this._currentFlowchartState=null)}ResetFlowchartState(e){e.Reset()}GetFlowchartState(e){return this._flowchartStates.get(e)}PushFlowchartState(e){this._flowchartStateStack.push(e)}PopFlowchartState(){this._flowchartStateStack.pop()}SetCurrentFlowchartState(e,t=!1,s=!1,i=!0){if(i){const t=e.GetCurrentReferenceFlowchart();e=t||e}e!==this._currentFlowchartState&&(this._TriggerBeforeFlowchartChange(),this._TriggerAfterFlowchartChange(e,t,s))}GetCurrentFlowchartState(e){return"string"==typeof e?this.GetFlowchartState(e):this._flowchartStateStack.length?this._flowchartStateStack[this._flowchartStateStack.length-1]:this._currentFlowchartState}_TriggerBeforeFlowchartChange(){if(!this._currentFlowchartState)return;if(this._currentFlowchartState.WasReleased())return;const e=this._currentFlowchartState.GetPluginInstance().GetInstance();this._currentFlowchartState.PushIsTriggerState(),this.PushFlowchartState(this._currentFlowchartState),this._runtime.Trigger(cT.Plugins.Flowchart.Cnds.OnBeforeFlowchartChange,e),this.PopFlowchartState(),this._currentFlowchartState.PopIsTriggerState()}_TriggerAfterFlowchartChange(e,t=!1,s=!1){if(this._currentFlowchartState=e,!this._currentFlowchartState)return;if(this._currentFlowchartState.WasReleased())return;const i=this._currentFlowchartState.GetPluginInstance().GetInstance();this._currentFlowchartState.PushIsTriggerState(),this.PushFlowchartState(this._currentFlowchartState),this._runtime.Trigger(cT.Plugins.Flowchart.Cnds.OnFlowchartChange,i),!0!==s&&"number"!=typeof s||this._currentFlowchartState._SetStartFlowchartNode(s),t&&(this._runtime.Trigger(cT.Plugins.Flowchart.Cnds.OnAnyNodeChange,i),this._runtime.Trigger(cT.Plugins.Flowchart.Cnds.OnTaggedNodeChange,i),this._runtime.Trigger(cT.Plugins.Flowchart.Cnds.OnAnyNodeChangeInFlowchart,i),this._runtime.Trigger(cT.Plugins.Flowchart.Cnds.OnTaggedNodeChangeInFlowchart,i)),this.PopFlowchartState(),this._currentFlowchartState.PopIsTriggerState()}_SaveToJson(){return{flowchartJsonObjects:[...this._flowchartStates.values()].map(e=>e._SaveToJson()),currentFlowchartTag:this._currentFlowchartState?this._currentFlowchartState.GetTag():null}}_LoadFromJson(e){if(!e)return;this._loadJson=e;const t=new Map;for(const e of this._loadJson.flowchartJsonObjects){const s=e.flowchartTag;if(this._flowchartStates.has(s)){const i=this._flowchartStates.get(s);i._LoadFromJson(e),t.set(s,i)}else{const s=this.AddFlowchartState(e.flowchartName,e.startNodeTag,e.flowchartTag,null,!1,e.pluginUID);s._LoadFromJson(e),t.set(e.flowchartTag,s)}}for(const[e,s]of this._flowchartStates.entries())t.has(e)||s.Release();this._flowchartStates.clear(),this._flowchartStates=t,this._runtime.IsLoadingState()?this._runtime.Dispatcher().addEventListener("afterload",this._on_after_load):this._OnAfterLoad()}_OnAfterLoad(){this._runtime.Dispatcher().removeEventListener("afterload",this._on_after_load);const e=this._flowchartStates.get(this._loadJson.currentFlowchartTag);e&&this.SetCurrentFlowchartState(e,!0),this._loadJson=null}}}{const uT=self.C3;uT.FlowchartDataManager=class{constructor(){this._flowchartDataItems=new Map}Release(){for(const e of this._flowchartDataItems.values())e.Release();this._flowchartDataItems.clear(),this._flowchartDataItems=null}Add(e){const t=new uT.FlowchartDataItem(e),s=t.GetName();this._flowchartDataItems.set(s,t)}Get(e){return this._flowchartDataItems.get(e)}HasFlowcharts(){return!!this._flowchartDataItems.size}static CreateDataItems(e,t,s,i){if(t)for(const r of t){const t=new s(r,i);e.push(t)}}}}{const dT=self.C3,_T=0,pT=1;dT.FlowchartDataItem=class{constructor(e){this._name=e[0],this._flowchartNodeData=new dT.FlowchartNodeData(e[1],this)}Release(){this._flowchartNodeData.Release(),this._flowchartNodeData=null}GetFlowchartNodeData(){return this._flowchartNodeData}GetFlowchartElementById(e){return this._flowchartNodeData.GetFlowchartElementById(e)}GetFlowchartNodeByTags(e){return this._flowchartNodeData.GetFlowchartNodeByTags(e)}GetFlowchartStartNode(){return this._flowchartNodeData.GetFlowchartStartNode()}GetName(){return this._name}}}{const fT=self.C3,mT=0,gT=1,ST=2,GT=3,yT=4,IT=5,TT=6,CT=7,bT=8,xT=8,wT=9,PT=10,RT=11;class vT{constructor(e,t){this._flowchartNodeData=t,this._type=e[7],this._flowchartId=e[0],this._tag=e[1],this._tag?this._tags=this._tag.trim().split(" ").map(e=>e.trim()):this._tags=[],this._parentFlowchartIds=e[2],this._parentOutputFlowchartIds=null,this._childrenFlowchartIds=null,this._enable=!1,"dictionary"===this._type&&(this._parentOutputFlowchartIds=e[3],this._childrenFlowchartIds=e[4],this._enable=e[8]),this._isStart=e[6],this._referenceFlowchartName=null,this._referenceFlowchartStartNodeTag=null,this._referenceFlowchartTag=null,"reference"===this._type&&(this._referenceFlowchartName=e[8],this._referenceFlowchartStartNodeTag=e[9],this._referenceFlowchartTag=e[10],this._enable=e[11]),this._flowchartNodeOutputData=new fT.FlowchartNodeOutputData(e[5],this)}Release(){this._flowchartNodeData=null}GetFlowchartNodeData(){return this._flowchartNodeData}GetFlowchartNodeOutputData(){return this._flowchartNodeOutputData}GetFlowchartId(){return this._flowchartId}GetTag(){return this._tag}GetTags(){return this._tags}HasTags(e){if(!this._tags)return!1;if(!this._tags.length)return!1;const t=fT.FlowchartState._GetTagArray(e);return!(!t||!t.length)&&t.every(fT.FlowchartState._HasTag,this._tags)}GetIsStart(){return this._isStart}SetIsStart(e){this._isStart=!!e}CanBeStartNode(){if("dictionary"===this._type)return!0;if("reference"===this._type)return!1;throw new Error(`unexpected flowchart node type: ${this._type}`)}GetParentFlowchartIds(){return this._parentFlowchartIds}GetParentOutputFlowchartIds(){return this._parentOutputFlowchartIds}GetChildrenFlowchartIds(){return this._childrenFlowchartIds}GetType(){return this._type}GetEnable(){return this._enable}GetReferenceFlowchartName(){return this._referenceFlowchartName}GetReferenceFlowchartStartNodeTag(){return this._referenceFlowchartStartNodeTag}GetReferenceFlowchartTag(){return this._referenceFlowchartTag}}fT.FlowchartNodeData=class{constructor(e,t){this._flowchartDataItem=t,this._flowchartNodeItems=[],this._flowchartNodeItemsIdMap=new Map,this._flowchartNodeItemsTagMap=new Map,this._flowchartNodeStartItem=null,fT.FlowchartDataManager.CreateDataItems(this._flowchartNodeItems,e,vT,this);for(const e of this._flowchartNodeItems){const t=e.GetFlowchartId(),s=e.GetTag(),i=e.GetTags(),r=e.GetIsStart();if(this._flowchartNodeItemsIdMap.set(t,e),s)for(const t of i)this._flowchartNodeItemsTagMap.has(t)||this._flowchartNodeItemsTagMap.set(t,new Set),this._flowchartNodeItemsTagMap.get(t).add(e);r&&(this._flowchartNodeStartItem=e);const n=e.GetFlowchartNodeOutputData();for(const e of n.flowchartNodeOutputDataItems()){const t=e.GetFlowchartId();this._flowchartNodeItemsIdMap.set(t,e)}}this._flowchartNodeStartItem||this._SetStartNodeIfMissing()}Release(){this._flowchartDataItem=null;for(const e of this._flowchartNodeItems)e.Release();fT.clearArray(this._flowchartNodeItems),this._flowchartNodeItems=null}GetFlowchartDataItem(){return this._flowchartDataItem}GetFlowchartElementById(e){return this._flowchartNodeItemsIdMap.get(e)}GetFlowchartNodeByTags(e){if(!e||!e.length)return null;const t=[];for(const s of e.trim().split(" ")){let e=this._flowchartNodeItemsTagMap.get(s.trim())??new Set;if(0===e.size)return null;t.push(e)}return[...t.reduce((e,t)=>t.size<e.size?t:e)].filter(e=>t.every(t=>t.has(e)))[0]}GetFlowchartStartNode(){return this._flowchartNodeStartItem}*flowchartNodeDataItems(){for(const e of this._flowchartNodeItems)yield e}_SetStartNodeIfMissing(){let e=0;for(const t of this.flowchartNodeDataItems())t.GetIsStart()&&e++;if(0===e){for(const e of this.flowchartNodeDataItems())if(e.CanBeStartNode()&&!e.GetIsStart())return void e.SetIsStart(!0)}else{if(1===e)return;if(e>1){let e=!0;for(const t of this.flowchartNodeDataItems())t.CanBeStartNode()&&(t.GetIsStart()&&e?e=!1:t.GetIsStart()&&!e&&t.SetIsStart(!1))}}for(const e of this.flowchartNodeDataItems())if(e.CanBeStartNode()&&e.GetIsStart())return void(this._flowchartNodeStartItem=e)}}}{const AT=self.C3,MT=0,DT=1,ET=2,FT=3,OT=4,BT=5;class kT{constructor(e,t){this._flowchartNodeOutputData=t,this._flowchartId=e[0],this._name=e[1],this._value=e[2],this._connectedFlowchartNodeFlowchartId=e[3],this._enable=e[4],this._default=e[5]}Release(){this._flowchartNodeOutputData=null}GetFlowchartNodeOutputData(){return this._flowchartNodeOutputData}GetFlowchartId(){return this._flowchartId}GetName(){return this._name}GetValue(){return this._value}GetConnectedFlowchartNodeFlowchartId(){return this._connectedFlowchartNodeFlowchartId}GetEnable(){return this._enable}GetDefault(){return this._default}}AT.FlowchartNodeOutputData=class{constructor(e,t){this._flowchartDataNodeItem=t,this._flowchartNodeOutputItems=[],this._flowchartNodeOutputItemsNameMap=new Map,AT.FlowchartDataManager.CreateDataItems(this._flowchartNodeOutputItems,e,kT,this),this._enabledFlowchartNodeOutputItems=this._flowchartNodeOutputItems.filter(e=>e.GetEnable());for(const e of this._enabledFlowchartNodeOutputItems)this._flowchartNodeOutputItemsNameMap.set(e.GetName(),e)}Release(){this._flowchartDataNodeItem=null;for(const e of this._flowchartNodeOutputItems)e.Release();AT.clearArray(this._flowchartNodeOutputItems),this._flowchartNodeOutputItems=null,AT.clearArray(this._enabledFlowchartNodeOutputItems),this._enabledFlowchartNodeOutputItems=null}GetFlowchartNodeDataItem(){return this._flowchartDataNodeItem}GetFlowchartNodeOutputDataItemCount(){return this._enabledFlowchartNodeOutputItems.length}GetFlowchartNodeOutputDataItems(){return this._enabledFlowchartNodeOutputItems}GetFlowchartNodeOutputDataItemByName(e){return this._flowchartNodeOutputItemsNameMap.get(e)}GetFlowchartNodeOutputDefault(){for(const e of this._enabledFlowchartNodeOutputItems)if(e.GetDefault())return e}*flowchartNodeOutputDataItems(){for(const e of this._enabledFlowchartNodeOutputItems)yield e}}}{const LT=self.C3;LT.SolStack=class extends LT.DefendedBase{constructor(e){super(),this._objectClass=e,this._stack=[],this._stack.push(LT.New(LT.Sol,this)),this._index=0,this._current=this._stack[0]}Release(){for(const e of this._stack)e.Release();LT.clearArray(this._stack),this._current=null,this._objectClass=null}GetObjectClass(){return this._objectClass}GetCurrentSol(){return this._current}GetOneBelowCurrentSol(){return this._stack[this._index-1]}Clear(){this.GetCurrentSol().Clear()}PushClean(){const e=this._stack,t=++this._index;if(t===e.length){const t=LT.New(LT.Sol,this);e.push(t),this._current=t}else{const s=e[t];s.Reset(),this._current=s}}PushCopy(){const e=this._stack,t=++this._index;t===e.length&&e.push(LT.New(LT.Sol,this));const s=e[t];s.Copy(e[t-1]),this._current=s}Pop(){this._current=this._stack[--this._index]}RemoveInstances(e){const t=this._stack;for(let s=0,i=t.length;s<i;++s)t[s].RemoveInstances(e)}}}{const NT=self.C3;NT.Sol=class extends NT.DefendedBase{constructor(e){super(),this._stack=e,this._objectClass=this._stack.GetObjectClass(),this._eventStack=this._objectClass.GetRuntime().GetEventStack(),this._selectAll=!0,this._instances=[],this._elseInstances=[]}Release(){this.ClearArrays(),this._stack=null,this._objectClass=null,this._eventStack=null}ClearArrays(){NT.clearArray(this._instances),NT.clearArray(this._elseInstances)}GetObjectClass(){return this._objectClass}IsSelectAll(){return this._selectAll}HasAnyInstances(){return this._selectAll?!!this._objectClass.GetInstanceCount():!!this._instances.length}GetInstances(){return this._selectAll?this._objectClass.GetInstances():this._instances}HasAnyElseInstances(){return!!this._elseInstances.length}GetElseInstances(){return this._elseInstances}GetExpressionInstances(){const e=this.GetInstances();return e.length?e:this._elseInstances}Reset(){this._selectAll=!0,NT.clearArray(this._elseInstances)}Clear(){this._selectAll=!0}Copy(e){e.IsSelectAll()?this.Reset():(this._selectAll=!1,NT.shallowAssignArray(this._instances,e._instances),NT.clearArray(this._elseInstances))}_PushInstance(e){this._instances.push(e)}_PushElseInstance(e){this._elseInstances.push(e)}_SetSelectAll(e){this._selectAll=!!e}_GetOwnInstances(){return this._instances}_GetOwnElseInstances(){return this._elseInstances}SetSinglePicked(e){this._selectAll=!1,NT.clearArray(this._instances),this._instances.push(e)}SetArrayPicked(e){this._selectAll=!1,NT.shallowAssignArray(this._instances,e)}SetSetPicked(e){this._selectAll=!1,NT.clearArray(this._instances);for(const t of e)this._instances.push(t)}AddElseInstances(e,t){for(const s of t)e.has(s)||this._elseInstances.push(s)}TransferElseInstancesToOwn(e){for(const t of e)this._instances.push(t);NT.arrayRemoveAllInSet(this._elseInstances,e)}ClearElseInstances(){NT.clearArray(this._elseInstances)}PickOne(e){if(e)if(this._eventStack.GetCurrentStackFrame().GetCurrentEvent().IsOrBlock()){this.IsSelectAll()&&(NT.clearArray(this._instances),NT.shallowAssignArray(this._elseInstances,e.GetObjectClass().GetInstances()),this._selectAll=!1);const t=this._elseInstances.indexOf(e);-1!==t&&(this._instances.push(this._elseInstances[t]),this._elseInstances.splice(t,1))}else this.SetSinglePicked(e)}RemoveInstances(e){NT.arrayRemoveAllInSet(this._instances,e),NT.arrayRemoveAllInSet(this._elseInstances,e)}}}{const WT=self.C3;WT.EventStack=class extends WT.DefendedBase{constructor(e){super(),this._eventSheetManager=e,this._runtime=this._eventSheetManager.GetRuntime(),this._stack=[],this._stack.push(WT.New(WT.EventStackFrame,this,null)),this._index=0,this._expFuncStack=[]}Release(){for(const e of this._stack)e.Release();WT.clearArray(this._stack),WT.clearArray(this._expFuncStack),this._eventSheetManager=null,this._runtime=null}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}GetCurrentStackFrame(){return this._stack[this._index]}GetAllStackFrames(){return this._stack}GetCurrentStackFrameIndex(){return this._index}Push(e){const t=this._stack,s=++this._index;if(s===t.length){const s=WT.New(WT.EventStackFrame,this,e);return t.push(s),s}{const i=t[s];return i.Reset(e),i}}Pop(){--this._index}PushExpFunc(e){this._expFuncStack.push(e)}PopExpFunc(){this._expFuncStack.pop()}GetCurrentExpFuncStackFrame(){const e=this._expFuncStack;return 0===e.length?null:e.at(-1)}}}{const UT=self.C3;UT.EventStackFrame=class extends UT.DefendedBase{constructor(e,t){super(),this._stack=e,this._runtime=this._stack.GetRuntime(),this._currentEvent=t,this._cndIndex=0,this._actIndex=0,this._lastEventTrue=!1,this._elseBranchRan=!1,this._expressionObjectClass=null,this._functionReturnType=0,this._functionReturnValue=0,this._dynamicSolModifiers=null}Release(){this.Reset(null),this._stack=null,this._runtime=null}Reset(e){this._currentEvent=e,this._cndIndex=0,this._actIndex=0,this._lastEventTrue=!1,this._elseBranchRan=!1,this._dynamicSolModifiers=null}_Restore(e,t){this._currentEvent=e,this._cndIndex=0,this._actIndex=t}ResetQuick(){this._cndIndex=0,this._actIndex=0}GetCurrentEvent(){return this._currentEvent}SetCurrentEvent(e){this._currentEvent=e}GetConditionIndex(){return this._cndIndex}SetConditionIndex(e){this._cndIndex=e}GetActionIndex(){return this._actIndex}SetActionIndex(e){this._actIndex=e}SetLastEventTrue(e){this._lastEventTrue=!!e}GetLastEventTrue(){return this._lastEventTrue}SetElseBranchRan(e){this._elseBranchRan=!!e}GetElseBranchRan(){return this._elseBranchRan}SetExpressionObjectClass(e){this._expressionObjectClass=e}GetExpressionObjectClass(){return this._expressionObjectClass}InitCallFunctionExpression(e,t){this._functionReturnType=e,this._functionReturnValue=t}GetFunctionReturnType(){return this._functionReturnType}SetFunctionReturnValue(e){this._functionReturnValue=e}GetFunctionReturnValue(){return this._functionReturnValue}IsSolModifierAfterCnds(){const e=this._currentEvent;return!!e.IsSolWriterAfterCnds()||this._cndIndex<e.GetConditionCount()-1&&!!e.GetSolModifiers().length}SetDynamicSolModifiers(e){this._dynamicSolModifiers=e}GetDynamicSolModifiers(){return this._dynamicSolModifiers}}}{const VT=self.C3;VT.LocalVarStack=class extends VT.DefendedBase{constructor(e){super(),this._eventSheetManager=e,this._runtime=this._eventSheetManager.GetRuntime(),this._stack=[],this._index=-1,this._current=null,this._initialValues=[]}Release(){VT.clearArray(this._stack),this._eventSheetManager=null,this._runtime=null}_SetInitialValues(e){this._initialValues=e;const t=this._initialValues.slice(0);this._stack.push(t),this._index=0,this._current=t}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}GetCurrent(){return this._current}Push(){const e=++this._index,t=this._stack;e===t.length?t.push(this._initialValues.slice(0)):VT.shallowAssignArray(t[e],this._initialValues),this._current=t[e]}Pop(){this._current=this._stack[--this._index]}}}{const HT=self.C3;HT.LoopStack=class extends HT.DefendedBase{constructor(e){super(),this._eventSheetManager=e,this._runtime=this._eventSheetManager.GetRuntime(),this._stack=[],this._index=-1}Release(){HT.clearArray(this._stack),this._eventSheetManager=null,this._runtime=null}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}IsInLoop(){return this._index>=0}GetCurrent(){return this._stack[this._index]}Push(){if(++this._index,this._index===this._stack.length){const e=HT.New(HT.Loop,this);return this._stack.push(e),e}{const e=this._stack[this._index];return e.Reset(),e}}Pop(){--this._index}FindByName(e){const t=this._stack;for(let s=this._index;s>=0;--s){const i=t[s];if(i.GetName()===e)return i}return null}_GetStack(){return this._stack.slice(0,this._index+1)}}}{const jT=self.C3;jT.Loop=class extends jT.DefendedBase{constructor(e){super(),this._loopStack=e,this._name="",this._index=0,this._isStopped=!1,this._end=NaN}Reset(){this._name="",this._index=0,this._isStopped=!1,this._end=NaN}SetName(e){this._name=e}GetName(){return this._name}SetIndex(e){this._index=e}GetIndex(){return this._index}Stop(){this._isStopped=!0}IsStopped(){return this._isStopped}SetEnd(e){this._end=e}GetEnd(){return this._end}}}{const zT=self.C3;zT.ArrayStack=class extends zT.DefendedBase{constructor(){super(),this._stack=[],this._index=-1}Release(){zT.clearArray(this._stack)}GetCurrent(){return this._stack[this._index]}Push(){if(++this._index,this._index===this._stack.length){const e=[];return this._stack.push(e),e}return this._stack[this._index]}Pop(){--this._index}}}{let XT=function(e,t){return e.GetIndex()-t.GetIndex()},YT=function(e,t){for(let s=0,i=e.length;s<i;++s)if(e[s]!==t[s])return!1;return!0};SortSolArray=XT,IsSolArrayIdentical=YT;const qT=self.C3,KT=self.assert;qT.EventSheetManager=class extends qT.DefendedBase{constructor(e){super(),this._runtime=e,this._allSheets=[],this._sheetsByName=new Map,this._allGroups=[],this._groupsByName=new Map,this._blocksBySid=new Map,this._cndsBySid=new Map,this._actsBySid=new Map,this._allUniqueSolModifiers=new Map,this._eventVarsBySid=new Map,this._nextLocalVarIndex=0,this._allGlobalVars=[],this._allLocalVars=[],this._localVarInitialValues=[],this._functionBlocksByName=new Map,this._customActionBlocksMap=new Map,this._eventStack=qT.New(qT.EventStack,this),this._localVarStack=qT.New(qT.LocalVarStack,this),this._loopStack=qT.New(qT.LoopStack,this),this._triggersToPostInit=[],this._queuedTriggers=[],this._queuedDebugTriggers=[],this._runningEventsDepth=0,this._executingTriggerDepth=0,this._blockFlushingDepth=0,this._scheduledWaits=[],this._asyncActionPromises=[],this._signalTags=[],this._signalPromises=new Map,this._instSignals=new Map,self.c3_callFunction=(e,t)=>this._InvokeFunctionFromJS(e,t)}Release(){this.ClearAllScheduledWaits(),this._eventStack.Release(),this._eventStack=null,this._localVarStack.Release(),this._localVarStack=null,qT.clearArray(this._queuedTriggers),qT.clearArray(this._queuedDebugTriggers),this._runtime=null,qT.clearArray(this._allSheets),this._sheetsByName.clear()}Create(e){const t=qT.New(qT.EventSheet,this,e);this._allSheets.push(t),this._sheetsByName.set(t.GetName().toLowerCase(),t)}_AddTriggerToPostInit(e){this._triggersToPostInit.push(e)}_PostInit(){for(const e of this._customActionBlocksMap.values())e._CheckOverrideState();for(const e of this._functionBlocksByName.values())e._PostInit();for(const e of this._customActionBlocksMap.values())e._PostInit();for(const e of this._allSheets)e._PostInit();for(const e of this._allSheets)e._UpdateDeepIncludes();for(const e of this._triggersToPostInit)e._PostInit(!1);qT.clearArray(this._triggersToPostInit),this._localVarStack._SetInitialValues(this._localVarInitialValues)}GetRuntime(){return this._runtime}GetEventSheetByName(e){return this._sheetsByName.get(e.toLowerCase())||null}_RegisterGroup(e){this._allGroups.push(e),this._groupsByName.set(e.GetGroupName(),e)}_RegisterEventBlock(e){this._blocksBySid.set(e.GetSID(),e)}_RegisterCondition(e){this._cndsBySid.set(e.GetSID(),e)}_RegisterAction(e){this._actsBySid.set(e.GetSID(),e)}_RegisterFunctionBlock(e){switch(e.GetFunctionType()){case 0:this._functionBlocksByName.set(e.GetFunctionName().toLowerCase(),e);break;case 1:this._customActionBlocksMap.set(e.GetFunctionName().toLowerCase(),e)}}_RegisterEventVariable(e){this._eventVarsBySid.set(e.GetSID(),e),e.IsGlobal()?this._allGlobalVars.push(e):this._allLocalVars.push(e)}_DeduplicateSolModifierList(e){e.length>=2&&e.sort(XT);let t=this._allUniqueSolModifiers.get(e.length);t||(t=[],this._allUniqueSolModifiers.set(e.length,t));for(let s=0,i=t.length;s<i;++s){const i=t[s];if(YT(e,i))return i}return t.push(e),e}_GetNextLocalVarIndex(e){return this._localVarInitialValues.push(e.GetInitialValue()),this._nextLocalVarIndex++}GetEventStack(){return this._eventStack}GetCurrentEventStackFrame(){return this.GetEventStack().GetCurrentStackFrame()}GetCurrentEvent(){return this.GetCurrentEventStackFrame().GetCurrentEvent()}GetCurrentCondition(){const e=this.GetCurrentEventStackFrame();return e.GetCurrentEvent().GetConditionAt(e.GetConditionIndex())}GetCurrentAction(){const e=this.GetCurrentEventStackFrame();return e.GetCurrentEvent().GetActionAt(e.GetActionIndex())}GetLocalVarStack(){return this._localVarStack}GetLoopStack(){return this._loopStack}GetAllLocalVariablesInScope(e){const t=[];for(e=e.GetScopeParent();e;)qT.appendArray(t,e._GetAllLocalVariablesInScope()),e=e.GetScopeParent();return t}_GetLocalVariablesScriptInterface(e){const t={};for(const s of this.GetAllLocalVariablesInScope(e))t[s.GetJsPropName()]=s._GetScriptInterfaceDescriptor();return Object.create(Object.prototype,t)}GetEventVariableBySID(e){return this._eventVarsBySid.get(e)||null}GetEventBlockBySID(e){return this._blocksBySid.get(e)||null}GetConditionBySID(e){return this._cndsBySid.get(e)||null}GetActionBySID(e){return this._actsBySid.get(e)||null}GetFunctionBlockByName(e){return this._functionBlocksByName.get(e.toLowerCase())||null}GetCustomActionBlockByName(e,t){let s=this._customActionBlocksMap.get((e.GetName()+"."+t).toLowerCase());if(s)return s;if(!e.IsFamily())for(const i of e.GetFamilies())if(s=this._customActionBlocksMap.get((i.GetName()+"."+t).toLowerCase()),s)return s;return null}GetAllGlobalVariables(){return this._allGlobalVars}GetAllLocalVariables(){return this._allLocalVars}ResetAllGlobalsToInitialValue(e){for(const e of this._allGlobalVars)e.ResetToInitialValue();if(e)for(const e of this._allLocalVars)e.IsStatic()&&e.ResetToInitialValue()}GetEventGroupByName(e){return this._groupsByName.get(e.toLowerCase())||null}GetEventGroupBySID(e){const t=this._blocksBySid.get(e);return t&&t.IsGroup()?t:null}GetAllGroups(){return this._allGroups}ResetAllGroupsInitialActivation(){for(const e of this._allGroups)e.ResetInitialActivation()}_ResetAllHasRunFlags(){for(const e of this._allSheets)e._ResetHasRunFlag()}RunEvents(e){this._ResetAllHasRunFlags(),this._runningEventsDepth++;for(const t of e.runningLayouts()){const e=t.GetEventSheet();e&&(this._runtime.PushCurrentLayout(t),e.Run(),this._runtime.PopCurrentLayout())}this._runningEventsDepth--}async DebugRunEvents(e){this._ResetAllHasRunFlags(),this._runningEventsDepth++;for(const t of this._DebugRunEventsGen(e))await this._runtime.DebugBreak(t);this._runningEventsDepth--}*_DebugRunEventsGen(e){for(const t of e.runningLayouts()){const e=t.GetEventSheet();e&&(this._runtime.PushCurrentLayout(t),yield*e.DebugRun(),this._runtime.PopCurrentLayout())}}_Trigger(e,t,s,i){let r=!1;if(!e.GetMainRunningLayout())return this.QueueTrigger(t,s,i);this._executingTriggerDepth++;for(const n of e.runningLayouts()){const e=n.GetEventSheet();if(!e)continue;this._runtime.PushCurrentLayout(n);for(const n of e.deepIncludes()){const e=n._Trigger(t,s,i);r=r||e}const a=e._Trigger(t,s,i);r=r||a,this._runtime.PopCurrentLayout()}return this._executingTriggerDepth--,r}*_DebugTrigger(e,t,s,i){let r=!1;if(!e.GetMainRunningLayout())return this.QueueTrigger(t,s,i);this._executingTriggerDepth++;for(const n of e.runningLayouts()){const e=n.GetEventSheet();if(!e)continue;this._runtime.PushCurrentLayout(n);for(const n of e.deepIncludes()){const e=yield*n._DebugTrigger(t,s,i);r=r||e}const a=yield*e._DebugTrigger(t,s,i);r=r||a,this._runtime.PopCurrentLayout()}return this._executingTriggerDepth--,r}QueueTrigger(e,t,s){return this._queuedTriggers.push([e,t,s]),!1}QueueDebugTrigger(e,t,s){let i=null;const r=new Promise(e=>i=e);return this._queuedDebugTriggers.push([e,t,s,i]),r}*_RunQueuedDebugTriggersGen(){if(this._runtime.HitBreakpoint())throw new Error("should not be in breakpoint");const e=this._runtime.GetLayoutManager();for(;this._queuedDebugTriggers.length;){const[t,s,i,r]=this._queuedDebugTriggers.shift();r(yield*this._DebugTrigger(e,t,s,i))}}async RunQueuedDebugTriggersAsync(){for(const e of this._RunQueuedDebugTriggersGen())await this._runtime.DebugBreak(e)}_FastTrigger(e,t,s,i){let r=!1;const n=e.GetMainRunningLayout(),a=n.GetEventSheet();if(!a)return;this._executingTriggerDepth++,this._runtime.PushCurrentLayout(n);const o=a.deepIncludes();for(let e=0,n=o.length;e<n;++e){const n=o[e]._FastTrigger(t,s,i);r=r||n}const h=a._FastTrigger(t,s,i);return r=r||h,this._runtime.PopCurrentLayout(),this._executingTriggerDepth--,r}*_DebugFastTrigger(e,t,s,i){let r=!1;const n=e.GetMainRunningLayout(),a=n.GetEventSheet();if(!a)return;this._executingTriggerDepth++,this._runtime.PushCurrentLayout(n);const o=a.deepIncludes();for(let e=0,n=o.length;e<n;++e){const n=yield*o[e]._DebugFastTrigger(t,s,i);r=r||n}const h=yield*a._DebugFastTrigger(t,s,i);return r=r||h,this._runtime.PopCurrentLayout(),this._executingTriggerDepth--,r}GetTriggerDepth(){return this._executingTriggerDepth}IsInTrigger(){return this.GetTriggerDepth()>0}_IncTriggerDepth(){return++this._executingTriggerDepth}_DecTriggerDepth(){--this._executingTriggerDepth}IsRunningEvents(){return this._runningEventsDepth>0}IsInEventEngine(){return this.IsRunningEvents()||this.IsInTrigger()}_RunQueuedTriggers(e){for(const[t,s,i]of this._queuedTriggers)this._Trigger(e,t,s,i);qT.clearArray(this._queuedTriggers)}BlockFlushingInstances(e){e?this._blockFlushingDepth++:this._blockFlushingDepth--}IsFlushingBlocked(){return this._blockFlushingDepth>0}ClearSol(e){for(let t=0,s=e.length;t<s;++t)e[t].GetSolStack().Clear()}PushCleanSol(e){for(let t=0,s=e.length;t<s;++t)e[t].GetSolStack().PushClean()}PushCopySol(e){for(let t=0,s=e.length;t<s;++t)e[t].GetSolStack().PushCopy()}PopSol(e){for(let t=0,s=e.length;t<s;++t)e[t].GetSolStack().Pop()}GetDynamicSolModifiersSet(){const e=new Set,t=this._eventStack.GetAllStackFrames(),s=this._eventStack.GetCurrentStackFrameIndex();for(let i=0;i<=s;++i){const s=t[i].GetDynamicSolModifiers();if(s)for(const t of s)e.add(t)}return e}PushCleanSolDynamic(e){const t=this.GetDynamicSolModifiersSet();if(0===t.size)return null;const s=t.difference(qT.ensureSet(e));if(0===s.size)return null;for(const e of s)e.GetSolStack().PushClean();return[...s]}AddScheduledWait(){const e=qT.New(qT.ScheduledWait,this);return this._scheduledWaits.push(e),e}scheduledWaits(){return this._scheduledWaits}RunScheduledWaits(){if(!this._scheduledWaits.length)return;const e=this.GetCurrentEventStackFrame();let t=!1;this._runningEventsDepth++;for(let s=0,i=this._scheduledWaits.length;s<i;++s){const i=this._scheduledWaits[s];i._ShouldRun()&&i._Run(e),i.ShouldRelease()&&(t=!0)}t&&(this._FilterScheduledWaitsToRelease(),e.Reset(null)),this._runningEventsDepth--}async DebugRunScheduledWaits(){if(!this._scheduledWaits.length)return;const e=this.GetCurrentEventStackFrame();let t=!1;this._runningEventsDepth++;for(let s=0,i=this._scheduledWaits.length;s<i;++s){const i=this._scheduledWaits[s];i._ShouldRun()&&await i._DebugRun(e),i.ShouldRelease()&&(t=!0)}t&&(this._FilterScheduledWaitsToRelease(),e.Reset(null)),this._runningEventsDepth--}_FilterScheduledWaitsToRelease(){const e=qT.arrayFilterOut(this._scheduledWaits,e=>e.ShouldRelease());for(const t of e)t.Release()}ClearAllScheduledWaits(){for(const e of this._scheduledWaits)e.Release();qT.clearArray(this._scheduledWaits)}_OnInstancesReleased(e){for(const t of this._scheduledWaits)t.RemoveInstances(e);for(const t of e){const e=this._instSignals.get(t);if(this._instSignals.delete(t),e)for(const{resolve:t}of e.signalPromises.values())t(!0)}}AddAsyncActionPromise(e){this._asyncActionPromises.push({promise:e,triggerDepth:this.GetTriggerDepth()})}ClearAsyncActionPromises(){qT.clearArray(this._asyncActionPromises)}GetPromiseForAllAsyncActions(){const e=this.GetTriggerDepth(),t=Promise.all(this._asyncActionPromises.filter(t=>t.triggerDepth===e).map(e=>e.promise));return this._asyncActionPromises=this._asyncActionPromises.filter(t=>t.triggerDepth<e),t}Signal(e){const t=e.toLowerCase();this._signalTags.push(t),this._runtime.Trigger(qT.Plugins.System.Cnds.OnSignal,null),this._signalTags.pop();for(const e of this._runtime.GetEventSheetManager().scheduledWaits())e.IsSignal()&&e.GetSignalTag()===t&&e.SetSignalled();const s=this._signalPromises.get(t);s&&(s.resolve(),this._signalPromises.delete(t))}WaitForSignal(e){const t=e.toLowerCase(),s=this._signalPromises.get(t);if(s)return s.promise;{let e=null;const s=new Promise(t=>e=t);return this._signalPromises.set(t,{promise:s,resolve:e}),s}}GetCurrentSignalTag(){if(0===this._signalTags.length)throw new Error("not in a signal");return this._signalTags.at(-1)}_GetInstanceSignalState(e){let t=this._instSignals.get(e);return t||(t={signalTags:[],signalPromises:new Map},this._instSignals.set(e,t)),t}InstanceSignal(e,t){const s=this._GetInstanceSignalState(e),i=t.toLowerCase();s.signalTags.push(i),this._runtime.Trigger(e.GetPlugin().GetConstructor().Cnds.OnInstanceSignal,e),s.signalTags.pop();for(const t of this._runtime.GetEventSheetManager().scheduledWaits())t.IsInstanceSignals()&&t.GetSignalTag()===i&&t.SetInstanceSignalled(e);const r=s.signalPromises.get(i);r&&(r.resolve(!1),s.signalPromises.delete(i)),0===s.signalTags.length&&0===s.signalPromises.size&&this._instSignals.delete(e)}WaitForInstanceSignal(e,t){const s=this._GetInstanceSignalState(e),i=t.toLowerCase(),r=s.signalPromises.get(i);if(r)return r.promise;{let e=null;const t=new Promise(t=>e=t);return s.signalPromises.set(i,{promise:t,resolve:e}),t}}GetCurrentInstanceSignalTag(e){const t=this._GetInstanceSignalState(e);if(!t||0===t.signalTags.length)throw new Error("not in a signal");return t.signalTags.at(-1)}_SaveToJson(){return{groups:this._SaveGroupsToJson(),cnds:this._SaveCndsToJson(),acts:this._SaveActsToJson(),vars:this._SaveVarsToJson(),waits:this._SaveScheduledWaitsToJson()}}_LoadFromJson(e){this._LoadGroupsFromJson(e.groups),this._LoadCndsFromJson(e.cnds),this._LoadActsFromJson(e.acts),this._LoadVarsFromJson(e.vars),this._LoadScheduledWaitsFromJson(e.waits)}_SaveGroupsToJson(){const e={};for(const t of this.GetAllGroups())e[t.GetSID().toString()]=t.IsGroupActive();return e}_LoadGroupsFromJson(e){for(const[t,s]of Object.entries(e)){const e=parseInt(t,10),i=this.GetEventGroupBySID(e);i&&i.SetGroupActive(s)}}_SaveCndsToJson(){const e={};for(const[t,s]of this._cndsBySid){const i=s._SaveToJson();i&&(e[t.toString()]=i)}return e}_LoadCndsFromJson(e){const t=new Map;for(const[s,i]of Object.entries(e))t.set(parseInt(s,10),i);for(const[e,s]of this._cndsBySid)s._LoadFromJson(t.get(e)||null)}_SaveActsToJson(){const e={};for(const[t,s]of this._actsBySid){const i=s._SaveToJson();i&&(e[t.toString()]=i)}return e}_LoadActsFromJson(e){const t=new Map;for(const[s,i]of Object.entries(e))t.set(parseInt(s,10),i);for(const[e,s]of this._actsBySid)s._LoadFromJson(t.get(e)||null)}_SaveVarsToJson(){const e={};for(const[t,s]of this._eventVarsBySid)s.IsConstant()||!s.IsGlobal()&&!s.IsStatic()||(e[t.toString()]=s.GetValue());return e}_LoadVarsFromJson(e){for(const[t,s]of Object.entries(e)){const e=parseInt(t,10),i=this.GetEventVariableBySID(e);i&&i.SetValue(s)}}_SaveScheduledWaitsToJson(){return this._scheduledWaits.filter(e=>!e.IsPromise()).map(e=>e._SaveToJson())}_LoadScheduledWaitsFromJson(e){this.ClearAllScheduledWaits();for(const t of e){const e=qT.ScheduledWait._CreateFromJson(this,t);e&&this._scheduledWaits.push(e)}}_GetPerfRecords(){return[...this._runtime.GetLayoutManager().runningLayouts()].map(e=>e.GetEventSheet()).filter(e=>e).map(e=>e._GetPerfRecord())}FindFirstFunctionBlockParent(e){for(;e;){const t=e.GetScopeParent();if(t instanceof qT.FunctionBlock)return t;e=t}return null}_InvokeFunctionFromJS(e,t){Array.isArray(t)||(t=[]);const s=this.GetFunctionBlockByName(e.toLowerCase());if(!s)return null;if(!s.IsEnabled())return s.GetDefaultReturnValue();const i=s.GetFunctionParameters();if(t.length<i.length){t=t.slice(0);do{t.push(i[t.length].GetInitialValue())}while(t.length<i.length)}const r=s.GetEventBlock();return r.RunAsExpressionOrJSFunctionCall(r.GetSolModifiersIncludingParents(),!1,s.GetReturnType(),s.GetDefaultReturnValue(),null,...t)}}}{const $T=self.C3;$T.EventSheet=class extends $T.DefendedBase{constructor(e,t){super(),this._eventSheetManager=e,this._runtime=e.GetRuntime(),this._name=t[0],this._events=[],this._triggers=new Map,this._fastTriggers=new Map,this._eventsByDisplayNumber=new Map,this._hasRun=!1,this._shallowIncludes=[],this._deepIncludes=[],this._alreadyIncludedSheets=new Set;for(const e of t[1])this._CreateEvent(e,null,this._events);this._perfRecord=this._runtime.IsDebug()?{type:"sheet",name:this._name,totalTimeCounter:0,children:[]}:null}Release(){this._eventSheetManager=null,this._runtime=null}_CreateEvent(e,t,s){switch(e[0]){case 0:case 3:this._CreateEventBlock(e,t,s);break;case 1:this._CreateEventVariable(e,t,s);break;case 2:this._CreateInclude(e,t,s);break;case 4:this._CreateFunctionBlock(e,t);break;case 5:this._CreateScriptBlock(e,t,s);break;case 6:this._CreateCustomACEBlock(e,t);break;default:throw new Error("invalid event type")}}_CreateEventBlock(e,t,s){const i=$T.EventBlock.Create(this,t,e);if(i.IsOrBlock()){s.push(i);const e=i.GetConditions();for(let t=0,s=e.length;t<s;++t)e[t].IsTrigger()&&this._InitTrigger(i,t)}else i.IsTrigger()?this._InitTrigger(i,0):s.push(i)}_CreateFunctionBlock(e,t){const s=$T.FunctionBlock.CreateFunctionBlock(this,t,e);this._eventSheetManager._RegisterFunctionBlock(s)}_CreateCustomACEBlock(e,t){const s=$T.FunctionBlock.CreateCustomACEBlock(this,t,e);this._eventSheetManager._RegisterFunctionBlock(s)}_CreateEventVariable(e,t,s){const i=$T.EventVariable.Create(this,t,e);s.push(i)}_CreateInclude(e,t,s){const i=$T.EventInclude.Create(this,t,e);s.push(i)}_CreateScriptBlock(e,t,s){const i=$T.EventScript.Create(this,t,e);s.push(i)}_InitTrigger(e,t){e.IsOrBlock()||this._eventSheetManager._AddTriggerToPostInit(e);const s=e.GetConditionAt(t),i=s._GetFunc(),r=s.GetObjectClass();if(s.IsFastTrigger()){let n=this._fastTriggers.get(r);n||(n=new Map,this._fastTriggers.set(r,n));const a=s.GetFastTriggerValue().toLowerCase();let o=n.get(i);o||(o=new Map,n.set(i,o));let h=o.get(a);h||(h=[],o.set(a,h)),h.push([e,t])}else{let n=this._triggers.get(r);n||(n={methodMap:new Map,behaviors:new Map},this._triggers.set(r,n));const a=s.GetBehaviorType();let o;a?(o=n.behaviors.get(a),o||(o=new Map,n.behaviors.set(a,o))):o=n.methodMap;let h=o.get(i);h||(h=[],o.set(i,h)),h.push([e,t])}}_PostInit(){const e=this._events;for(let t=0,s=e.length;t<s;++t){const i=t<s-1&&e[t+1]instanceof $T.EventBlock&&e[t+1].IsElseBlock();e[t]._PostInit(i)}}_AddShallowInclude(e){this._shallowIncludes.push(e)}_UpdateDeepIncludes(){$T.clearArray(this._deepIncludes),this._AddDeepIncludes(this),this._alreadyIncludedSheets.clear()}_AddDeepIncludes(e){const t=e._deepIncludes,s=e._alreadyIncludedSheets;for(const i of this._shallowIncludes){const r=i.GetIncludeSheet();i.IsActive()&&e!==r&&!s.has(r)&&(s.add(r),r._AddDeepIncludes(e),t.push(r))}}deepIncludes(){return this._deepIncludes}GetEventSheetManager(){return this._eventSheetManager}GetRuntime(){return this._runtime}GetName(){return this._name}_RegisterEventByDisplayNumber(e,t){this._eventsByDisplayNumber.set(t,e)}_GetEventByDisplayNumber(e){return this._eventsByDisplayNumber.get(e)||null}_ResetHasRunFlag(){this._hasRun=!1}Run(){if(this._hasRun)return;const e=this._runtime,t=e.IsCPUProfiling(),s=t?performance.now():0;this._hasRun=!0;const i=this.GetEventSheetManager(),r=i.GetCurrentEventStackFrame();for(const t of this._events)t.Run(r),i.ClearSol(t.GetSolModifiers()),i.ClearAsyncActionPromises(),e.FlushPendingInstances();r.Reset(null),t&&(this._perfRecord.totalTimeCounter+=performance.now()-s)}*DebugRun(){if(this._hasRun)return;this._hasRun=!0;const e=this._runtime,t=this.GetEventSheetManager(),s=t.GetCurrentEventStackFrame();for(const i of this._events)yield*i.DebugRun(s),t.ClearSol(i.GetSolModifiers()),t.ClearAsyncActionPromises(),e.FlushPendingInstances();s.Reset(null)}_Trigger(e,t,s){if(!t)return this._TriggerForClass(e,t,null,null);{const i=t.GetObjectClass();let r=!1,n=this._TriggerForClass(e,t,i,s);r=r||n;for(const a of i.GetFamilies())n=this._TriggerForClass(e,t,a,s),r=r||n}}_TriggerForClass(e,t,s,i){const r=this._triggers.get(s);if(!r)return!1;const n=i?r.behaviors.get(i):r.methodMap;if(!n)return!1;const a=n.get(e);if(!a)return!1;let o=!1;for(const[e,s]of a){const i=this._ExecuteTrigger(t,e,s);o=o||i}return o}*_DebugTrigger(e,t,s){if(!t)return yield*this._DebugTriggerForClass(e,t,null,null);{const i=t.GetObjectClass();let r=!1,n=yield*this._DebugTriggerForClass(e,t,i,s);r=r||n;for(const a of i.GetFamilies())n=yield*this._DebugTriggerForClass(e,t,a,s),r=r||n}}*_DebugTriggerForClass(e,t,s,i){const r=this._triggers.get(s);if(!r)return!1;const n=i?r.behaviors.get(i):r.methodMap;if(!n)return!1;const a=n.get(e);if(!a)return!1;let o=!1;for(const[e,s]of a){let i;i=e.DebugCanRunFast()?this._ExecuteTrigger(t,e,s):yield*this._DebugExecuteTrigger(t,e,s),o=o||i}return o}_FastTrigger(e,t,s){const i=t.GetObjectClass(),r=this._fastTriggers.get(i);if(!r)return!1;const n=r.get(e);if(!n)return!1;const a=n.get(s);if(!a)return!1;let o=!1;for(let e=0,t=a.length;e<t;++e){const t=a[e],s=this._ExecuteTrigger(null,t[0],t[1]);o=o||s}return o}*_DebugFastTrigger(e,t,s){const i=t.GetObjectClass(),r=this._fastTriggers.get(i);if(!r)return!1;const n=r.get(e);if(!n)return!1;const a=n.get(s);if(!a)return!1;let o=!1;for(let e=0,t=a.length;e<t;++e){const t=a[e],s=t[0],i=t[1];let r;r=s.DebugCanRunFast()?this._ExecuteTrigger(null,s,i):yield*this._DebugExecuteTrigger(null,s,i),o=o||r}return o}_ExecuteTrigger(e,t,s){const i=this._runtime,r=this._eventSheetManager,n=r.GetCurrentEvent(),a=r.GetEventStack(),o=r.GetTriggerDepth();let h=!1,l=null,c=null;if(n){const e=new Set(t.GetSolModifiersIncludingParents());for(const t of n.GetSolModifiersIncludingParents())e.add(t);l=[...e],c=r.PushCleanSolDynamic(e)}else l=t.GetSolModifiersIncludingParents();r.PushCleanSol(l);const u=o>1;u&&r.GetLocalVarStack().Push();const d=a.Push(t);e&&(t.GetConditions()[s].GetObjectClass().GetCurrentSol().SetSinglePicked(e),e.IsInContainer()&&e.SetSiblingsSinglePicked());let _=!0;if(t.GetParent()){const e=t.GetTriggerParents();for(let t=0,s=e.length;t<s;++t)if(!e[t].RunPreTrigger(d)){_=!1;break}}return _&&(t.IsOrBlock()?t.RunOrBlockTrigger(d,s):t.Run(d),h=d.GetLastEventTrue()),a.Pop(),u&&r.GetLocalVarStack().Pop(),r.PopSol(l),c&&r.PopSol(c),n||1!==o||(r.ClearAsyncActionPromises(),r.IsFlushingBlocked()||i.FlushPendingInstances()),h}*_DebugExecuteTrigger(e,t,s){const i=this._runtime,r=this._eventSheetManager,n=r.GetCurrentEvent(),a=r.GetEventStack(),o=r.GetTriggerDepth();let h=!1;n&&r.PushCleanSol(n.GetSolModifiersIncludingParents()),r.PushCleanSol(t.GetSolModifiersIncludingParents());const l=o>1;l&&r.GetLocalVarStack().Push();const c=a.Push(t);e&&(t.GetConditions()[s].GetObjectClass().GetCurrentSol().SetSinglePicked(e),e.IsInContainer()&&e.SetSiblingsSinglePicked());let u=!0;if(t.GetParent()){const e=t.GetTriggerParents();for(let t=0,s=e.length;t<s;++t)if(!(yield*e[t].DebugRunPreTrigger(c))){u=!1;break}}return u&&(t.IsOrBlock()?yield*t.DebugRunOrBlockTrigger(c,s):yield*t.DebugRun(c),h=c.GetLastEventTrue()),a.Pop(),l&&r.GetLocalVarStack().Pop(),r.PopSol(t.GetSolModifiersIncludingParents()),n&&r.PopSol(n.GetSolModifiersIncludingParents()),n||1!==o||(r.ClearAsyncActionPromises(),r.IsFlushingBlocked()||i.FlushPendingInstances()),h}_GetPerfRecord(){return this._perfRecord}}}{let JT=function(e,t){return!0};NoActions=JT;const ZT=self.C3,QT=[];function*eC(e,t){return!0}ZT.EventBlock=class extends ZT.DefendedBase{constructor(e,t,s){super(),this._eventSheet=e,this._runtime=e.GetRuntime(),this._parent=t,this._scopeParent=null,this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._solModifiers=[],this._solModifiersIncludingParents=[],this._hasGotSolModifiersIncludingParents=!1,this._isSolWriterAfterCnds=!1,this._isTopLevelGroup=!1,this._hasElseBlock=!1,this._isOrBlock=!!s[2],this._isElseBlock=!1,this._triggerParents=null,this._conditions=[],this._actions=[],this._subEvents=[],this._RunActions=JT,this._DebugRunActions=eC,this._isGroup=!1,this._isInitiallyActive=!1,this._groupName="",this._isGroupActive=!1,this._containedIncludes=null,this._perfRecord=null,this._sid=s[4],this._displayNumber=s[5],this._eventSheet._RegisterEventByDisplayNumber(this,this._displayNumber),this._debugData=this._runtime.IsDebug()?{isBreakpoint:s[3][0],isBreakable:s[3][1],canRunAllConditionsFast:!1,canRunAllActionsFast:!1,canRunAllSubEventsFast:!1,canRunSelfFast:!1}:null,this.GetEventSheetManager()._RegisterEventBlock(this),3===s[0]&&this._InitGroup(s[1]);let i=0;for(const e of s[6]){const t=ZT.Condition.Create(this,e,i++);this._conditions.push(t),this._AddSolModifier(t.GetObjectClass())}i=0;for(const e of s[7]){const t=ZT.Action.Create(this,e,i++);this._actions.push(t)}if(9===s.length){const e=s[8];for(const t of e)this._eventSheet._CreateEvent(t,this,this._subEvents)}this._conditions.length&&(this._isElseBlock=null===this._conditions[0].GetObjectClass()&&this._conditions[0]._GetFunc()===ZT.Plugins.System.Cnds.Else),0===this._conditions.length&&(this._conditions=QT),0===this._actions.length&&(this._actions=QT),0===this._subEvents.length&&(this._subEvents=QT)}static Create(e,t,s){return ZT.New(ZT.EventBlock,e,t,s)}_InitGroup(e){this._isGroup=!0,this._isInitiallyActive=!!e[0],this._isGroupActive=this._isInitiallyActive,this._groupName=e[1].toLowerCase(),this._containedIncludes=[],this.GetEventSheetManager()._RegisterGroup(this),this._runtime.IsDebug()&&(this._perfRecord={type:"group",name:e[1],totalTimeCounter:0,children:[]})}_AddContainedInclude(e){this._containedIncludes.push(e)}_AddContainerSolModifierToList(e,t){for(const s of e.GetContainer().objectTypes())t.includes(s)||t.push(s)}_AddSolModifierToList(e,t){if(e)if(t.includes(e)||t.push(e),e.IsFamily())for(const s of e.GetFamilyMembers())s.IsInContainer()&&this._AddContainerSolModifierToList(s,t);else e.IsInContainer()&&this._AddContainerSolModifierToList(e,t)}_AddSolModifier(e){this._AddSolModifierToList(e,this._solModifiers)}_AddParentSolModifier(e){this._AddSolModifierToList(e,this._solModifiersIncludingParents)}SetAllSolModifiers(){this._solModifiers=this._runtime.GetAllObjectClasses()}_PostInit(e){this._hasElseBlock=!!e,this._IdentifyTopLevelGroup(),this._IdentifyTriggerParents();for(const e of this._conditions)e._PostInit();if(this._actions.length>0){let e=!1;for(const t of this._actions)t._PostInit(),t.HasReturnType()&&(e=!0);e?(this._RunActions=this._RunActions_ReturnValue,this._DebugRunActions=this._DebugRunActions_ReturnValue):(this._RunActions=this._RunActions_Fast,this._DebugRunActions=this._DebugRunActions_Fast)}const t=this._subEvents;for(let e=0,s=t.length;e<s;++e){const i=e<s-1&&t[e+1]instanceof ZT.EventBlock&&t[e+1].IsElseBlock();t[e]._PostInit(i)}this._debugData&&this._UpdateCanRunFast(),this._perfRecord&&this._GetPerfRecordParent()._GetPerfRecord().children.push(this._perfRecord)}_GetPerfRecord(){return this._perfRecord}_GetPerfRecordParent(){let e=this.GetParent();for(;e;){if(e.IsGroup())return e;e=e.GetParent()}return this._eventSheet}_UpdateCanRunFast(){const e=this._debugData;e.canRunAllConditionsFast=this._conditions.every(e=>e.DebugCanRunFast()),e.canRunAllActionsFast=this._actions.every(e=>e.DebugCanRunFast()),e.canRunAllSubEventsFast=this._subEvents.every(e=>e.DebugCanRunFast()),e.canRunSelfFast=e.canRunAllConditionsFast&&e.canRunAllActionsFast&&e.canRunAllSubEventsFast}_UpdateCanRunFastRecursive(){let e=this;do{e._UpdateCanRunFast(),e=e.GetParent()}while(e)}_IdentifyTopLevelGroup(){if(!this.IsGroup())return;let e=this.GetParent();for(this._isTopLevelGroup=!0;e;){if(!e.IsGroup()){this._isTopLevelGroup=!1;break}e=e.GetParent()}}_IdentifySolModifiersIncludingParents(){const e=this._runtime.GetAllObjectClasses();if(this._solModifiers===e)this._solModifiersIncludingParents=e;else{this._solModifiersIncludingParents=ZT.cloneArray(this._solModifiers);let e=this.GetParent();for(;e;){for(const t of e._solModifiers)this._AddParentSolModifier(t);e=e.GetParent()}const t=this.GetEventSheetManager();this._solModifiers=t._DeduplicateSolModifierList(this._solModifiers),this._solModifiersIncludingParents=t._DeduplicateSolModifierList(this._solModifiersIncludingParents)}}_IdentifyTriggerParents(){if(!this.HasAnyTriggeredCondition())return;this._triggerParents=[];let e=this.GetParent();for(;e;)this._triggerParents.push(e),e=e.GetParent();this._triggerParents.reverse()}SetSolWriterAfterCnds(){this._isSolWriterAfterCnds=!0,this._parent&&this._parent.SetSolWriterAfterCnds()}IsSolWriterAfterCnds(){return this._isSolWriterAfterCnds}GetSolModifiers(){return this._solModifiers}GetSolModifiersIncludingParents(){return this._hasGotSolModifiersIncludingParents||(this._hasGotSolModifiersIncludingParents=!0,this._IdentifySolModifiersIncludingParents()),this._solModifiersIncludingParents}HasSolModifier(e){return this._solModifiers.includes(e)}GetTriggerParents(){return this._triggerParents}GetEventSheet(){return this._eventSheet}GetEventSheetManager(){return this._eventSheet.GetEventSheetManager()}GetRuntime(){return this._runtime}GetParent(){return this._parent}_SetScopeParent(e){this._scopeParent=e}GetScopeParent(){return this._scopeParent||this._parent}GetDisplayNumber(){return this._displayNumber}IsDebugBreakable(){return this._debugData&&this._debugData.isBreakable}IsDebugBreakpoint(){return this.IsDebugBreakable()&&this._debugData.isBreakpoint}_SetDebugBreakpoint(e){this._debugData.isBreakpoint=!!e,this._UpdateCanRunFastRecursive()}IsGroup(){return this._isGroup}IsTopLevelGroup(){return this._isTopLevelGroup}IsElseBlock(){return this._isElseBlock}HasElseBlock(){return this._hasElseBlock}GetGroupName(){return this._groupName}IsGroupActive(){return this._isGroupActive}ResetInitialActivation(){this.SetGroupActive(this._isInitiallyActive)}SetGroupActive(e){if(e=!!e,!this._isGroup)throw new Error("not a group");if(this._isGroupActive!==e){this._isGroupActive=e;for(const e of this._containedIncludes)e.UpdateActive();if(this._containedIncludes.length){const e=this._runtime.GetCurrentLayout().GetEventSheet();e&&e._UpdateDeepIncludes()}}}GetSID(){return this._sid}IsOrBlock(){return this._isOrBlock}IsTrigger(){return this._conditions.length&&this._conditions[0].IsTrigger()}IsForFunctionBlock(){return this._scopeParent&&this._scopeParent instanceof ZT.FunctionBlock}HasAnyTriggeredCondition(){return this.IsForFunctionBlock()||this._conditions.some(e=>e.IsTrigger())}GetConditions(){return this._conditions}GetConditionCount(){return this._conditions.length}GetConditionAt(e){if((e=Math.floor(e))<0||e>=this._conditions.length)throw new RangeError("invalid condition index");return this._conditions[e]}GetConditionByDebugIndex(e){return this.GetConditionAt(e)}IsFirstConditionOfType(e){let t=e.GetIndex();if(0===t)return!0;--t;const s=e.IsSystemOrSingleGlobalCondition()?e.GetFirstObjectParameterObjectClass():e.GetObjectClass();for(;t>=0;--t){const e=this._conditions[t];if(s===e.GetObjectClass()||e.IsSystemOrSingleGlobalCondition()&&e.GetFirstObjectParameterObjectClass()===s)return!1}return!0}GetActions(){return this._actions}GetActionCount(){return this._actions.length}GetActionAt(e){if((e=Math.floor(e))<0||e>=this._actions.length)throw new RangeError("invalid action index");return this._actions[e]}GetActionByDebugIndex(e){e=Math.floor(e);const t=this._actions.find(t=>t.GetDebugIndex()===e);if(!t)throw new RangeError("invalid action debug index");return t}_HasActionIndex(e){return(e=Math.floor(e))>=0&&e<this._actions.length}GetSubEvents(){return this._subEvents}_GetAllLocalVariablesInScope(){return this._subEvents.filter(e=>e instanceof ZT.EventVariable)}RunPreTrigger(e){e.SetCurrentEvent(this);const t=this._conditions;let s=0===t.length;for(let i=0,r=t.length;i<r;++i){const r=t[i];if(e.SetConditionIndex(i),r.IsLooping())throw new Error("trigger cannot be used as sub-event to a loop");if(r.Run())s=!0;else if(!this._isOrBlock)return!1}return!this._isOrBlock||s}RunOrBlockTrigger(e,t){e.SetCurrentEvent(this),e.SetConditionIndex(t),this._conditions[t].Run()&&(this._RunActions(e,0)&&this._RunSubEvents(e),e.SetLastEventTrue(!0))}*DebugRunPreTrigger(e){e.SetCurrentEvent(this);const t=this._conditions;let s=0===t.length;for(let i=0,r=t.length;i<r;++i){const r=t[i];if(e.SetConditionIndex(i),r.IsLooping())throw new Error("trigger cannot be used as sub-event to a loop");let n;if(n=r.DebugCanRunFast()?r.Run():yield*r.DebugRun(),n)s=!0;else if(!this._isOrBlock)return!1}return!this._isOrBlock||s}*DebugRunOrBlockTrigger(e,t){e.SetCurrentEvent(this),e.SetConditionIndex(t);const s=this._conditions[t];let i;if(i=s.DebugCanRunFast()?s.Run():yield*s.DebugRun(),i){let t;t=this.DebugCanRunActionsFast()?this._RunActions(e,0):yield*this._DebugRunActions(e,0),t&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),e.SetLastEventTrue(!0)}}Run(e){e.SetCurrentEvent(this),this._isElseBlock||e.SetElseBranchRan(!1),this._isOrBlock?this._RunOrBlock(e):this._RunAndBlock(e)}*DebugRun(e){(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),e.SetCurrentEvent(this),this._isElseBlock||e.SetElseBranchRan(!1),this._isOrBlock?yield*this._DebugRunOrBlock(e):yield*this._DebugRunAndBlock(e)}_RunOrBlock(e){const t=this._conditions;let s=0===t.length;for(let i=0,r=t.length;i<r;++i){const r=t[i];if(r.IsTrigger())continue;e.SetConditionIndex(i);const n=r.Run();s=s||n}e.SetLastEventTrue(s),s&&(this._RunActions(e,0)&&this._RunSubEvents(e),this._hasElseBlock&&e.SetElseBranchRan(!0))}*_DebugRunOrBlock(e){const t=this._conditions;let s=0===t.length;for(let i=0,r=t.length;i<r;++i){const r=t[i];if(r.IsTrigger())continue;let n;e.SetConditionIndex(i),n=r.DebugCanRunFast()?r.Run():yield*r.DebugRun(),s=s||n}if(e.SetLastEventTrue(s),s){let t;t=this.DebugCanRunActionsFast()?this._RunActions(e,0):yield*this._DebugRunActions(e,0),t&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),this._hasElseBlock&&e.SetElseBranchRan(!0)}}_RunAndBlock(e){const t=this._conditions;for(let s=0,i=t.length;s<i;++s){const i=t[s];if(e.SetConditionIndex(s),!i.Run())return void e.SetLastEventTrue(!1)}e.SetLastEventTrue(!0),this._RunActions(e,0)&&this._RunSubEvents(e),e.GetLastEventTrue()&&this._hasElseBlock&&e.SetElseBranchRan(!0)}*_DebugRunAndBlock(e){const t=this._conditions;for(let s=0,i=t.length;s<i;++s){const i=t[s];let r;if(e.SetConditionIndex(s),r=i.DebugCanRunFast()?i.Run():yield*i.DebugRun(),!r)return void e.SetLastEventTrue(!1)}let s;e.SetLastEventTrue(!0),s=this.DebugCanRunActionsFast()?this._RunActions(e,0):yield*this._DebugRunActions(e,0),s&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),e.GetLastEventTrue()&&this._hasElseBlock&&e.SetElseBranchRan(!0)}_RunActions_Fast(e,t){const s=this._actions;for(let i=t,r=s.length;i<r;++i){const t=s[i];e.SetActionIndex(i),t.Run()}return!0}*_DebugRunActions_Fast(e,t){const s=this._actions;for(let i=t,r=s.length;i<r;++i){const t=s[i];e.SetActionIndex(i),t.DebugCanRunFast()?t.Run():yield*t.DebugRun()}return!0}_RunActions_ReturnValue(e,t){const s=this.GetEventSheetManager(),i=this._actions;for(let r=t,n=i.length;r<n;++r){const t=i[r];e.SetActionIndex(r);const n=t.Run();if(t.CanBailOut()&&!0===n)return!1;t.IsAsync()&&n instanceof Promise&&s.AddAsyncActionPromise(n)}return!0}*_DebugRunActions_ReturnValue(e,t){const s=this.GetEventSheetManager(),i=this._actions;for(let r=t,n=i.length;r<n;++r){const t=i[r];let n;if(e.SetActionIndex(r),n=t.DebugCanRunFast()?t.Run():yield*t.DebugRun(),t.CanBailOut()&&!0===n)return!1;t.IsAsync()&&n instanceof Promise&&s.AddAsyncActionPromise(n)}return!0}_ResumeActionsAndSubEvents(e){this._RunActions(e,e.GetActionIndex())&&this._RunSubEvents()}*_DebugResumeActionsAndSubEvents(e){(yield*this._DebugRunActions(e,e.GetActionIndex()))&&(yield*this._DebugRunSubEvents())}_RunSubEvents(){if(!this._subEvents.length)return;const e=this.IsGroup()&&this._runtime.IsCPUProfiling(),t=e?performance.now():0,s=this._eventStack,i=s.Push(this);this._isSolWriterAfterCnds?this._RunSubEvents_SolWriterAfterCnds(i):this._RunSubEvents_Fast(i),s.Pop(),e&&(this._perfRecord.totalTimeCounter+=performance.now()-t)}_RunSubEvents_SolWriterAfterCnds(e){const t=this._isGroup,s=this._isTopLevelGroup,i=this.GetEventSheetManager(),r=this._subEvents;for(let n=0,a=r.length,o=a-1;n<a;++n){const a=r[n],h=a.GetSolModifiers(),l=!s||!t&&n<o;l&&i.PushCopySol(h),a.Run(e),l?i.PopSol(h):i.ClearSol(h)}}_RunSubEvents_Fast(e){const t=this._subEvents;for(let s=0,i=t.length;s<i;++s)t[s].Run(e)}*_DebugRunSubEvents(){if(!this._subEvents.length)return;const e=this._eventStack,t=e.Push(this);this._isSolWriterAfterCnds?yield*this._DebugRunSubEvents_SolWriterAfterCnds(t):yield*this._DebugRunSubEvents_Fast(t),e.Pop()}*_DebugRunSubEvents_SolWriterAfterCnds(e){const t=this._isGroup,s=this._isTopLevelGroup,i=this.GetEventSheetManager(),r=this._subEvents;for(let n=0,a=r.length,o=a-1;n<a;++n){const a=r[n],h=a.GetSolModifiers(),l=!s||!t&&n<o;l&&i.PushCopySol(h),yield*a.DebugRun(e),l?i.PopSol(h):i.ClearSol(h)}}*_DebugRunSubEvents_Fast(e){const t=this._subEvents;for(let s=0,i=t.length;s<i;++s)yield*t[s].DebugRun(e)}Retrigger(e,t){t.ResetQuick();const s=this._conditions;if(!this.IsOrBlock())for(let i=e.GetConditionIndex()+1,r=s.length;i<r;++i){const e=s[i];if(t.SetConditionIndex(i),!e.Run())return!1}return this._RunActions(t,0)&&this._RunSubEvents(t),!0}*DebugRetrigger(e,t){t.ResetQuick();const s=this._conditions;if(!this.IsOrBlock())for(let i=e.GetConditionIndex()+1,r=s.length;i<r;++i){const e=s[i];let r;if(t.SetConditionIndex(i),r=e.DebugCanRunFast()?e.Run():yield*e.DebugRun(),!r)return!1}let i;return i=this.DebugCanRunActionsFast()?this._RunActions(t,0):yield*this._DebugRunActions(t,0),i&&(this.DebugCanRunSubEventsFast()?this._RunSubEvents():yield*this._DebugRunSubEvents()),!0}DebugCanRunFast(){return!this.IsDebugBreakpoint()&&!this._runtime.DebugBreakNext()&&this._debugData.canRunSelfFast}DebugCanRunActionsFast(){return!this._runtime.DebugBreakNext()&&this._debugData.canRunAllActionsFast}DebugCanRunSubEventsFast(){return!this._runtime.DebugBreakNext()&&this._debugData.canRunAllSubEventsFast}_CheckParentsOKToRun(e){if(this.GetParent()){const t=this.GetTriggerParents();for(let s=0,i=t.length;s<i;++s)if(!t[s].RunPreTrigger(e))return!1}return!0}*_DebugCheckParentsOKToRun(e){if(this.GetParent()){const t=this.GetTriggerParents();for(let s=0,i=t.length;s<i;++s)if(!(yield*t[s].DebugRunPreTrigger(e)))return!1}return!0}_EvaluateFunctionCallParameters(e,t,s){if(t.length>0)if(s){const s=t.map(e=>e.Get(0));e.GetLocalVarStack().Push(),this._scopeParent.SetFunctionParameters(s)}else this._scopeParent.EvaluateFunctionParameters(t);else s&&e.GetLocalVarStack().Push()}#s(e,t,s,i){let r=null;if(t.copyFromObjectClass){const e=s?t.copyFromObjectClass.GetCurrentSol():t.copyFromObjectClass.GetSolStack().GetOneBelowCurrentSol(),i=t.copyToObjectClass.GetCurrentSol();i.SetArrayPicked(e.GetInstances()),i.ClearElseInstances(),s||t.copyToObjectClass.ApplySolToContainer()}else if(t.pickObjectClass){const e=t.pickObjectClass.GetCurrentSol();e.SetArrayPicked(t.pickInstances),e.ClearElseInstances()}return t.pushCleanSolDynamic&&(r=e.PushCleanSolDynamic(i)),r}RunAsFunctionCall(e,t,s,i){let r,n;const a=e.length>0;let o=null;const h=this._runtime,l=this._eventStack,c=h.GetEventSheetManager(),u=this._scopeParent,d=u.IsAsync(),_=c._IncTriggerDepth()>1;this._EvaluateFunctionCallParameters(c,t,_),a&&(s?c.PushCopySol(e):c.PushCleanSol(e)),null!==i&&(o=this.#s(c,i,s,e));const p=l.Push(this);return s&&p.SetDynamicSolModifiers(e),this._CheckParentsOKToRun(p)&&(p.SetCurrentEvent(this),d&&([n,r]=u.StartAsyncFunctionCall()),this._RunAndBlock(p),d&&u.MaybeFinishAsyncFunctionCall(n)),l.Pop(),_&&c.GetLocalVarStack().Pop(),null!==o&&c.PopSol(o),a&&c.PopSol(e),c._DecTriggerDepth(),r}*DebugRunAsFunctionCall(e,t,s,i){let r,n;(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this);const a=e.length>0;let o=null;const h=this._runtime,l=this._eventStack,c=h.GetEventSheetManager(),u=this._scopeParent,d=u.IsAsync(),_=c._IncTriggerDepth()>1;this._EvaluateFunctionCallParameters(c,t,_),a&&(s?c.PushCopySol(e):c.PushCleanSol(e)),null!==i&&(o=this.#s(c,i,s,e));const p=l.Push(this);return s&&p.SetDynamicSolModifiers(e),(yield*this._DebugCheckParentsOKToRun(p))&&(p.SetCurrentEvent(this),d&&([n,r]=u.StartAsyncFunctionCall()),yield*this._DebugRunAndBlock(p),d&&u.MaybeFinishAsyncFunctionCall(n)),l.Pop(),_&&c.GetLocalVarStack().Pop(),null!==o&&c.PopSol(o),a&&c.PopSol(e),c._DecTriggerDepth(),r}RunAsMappedFunctionCall(e,t){const s=this.GetSolModifiersIncludingParents(),i=s.length>0,r=this._runtime,n=this._eventStack,a=r.GetEventSheetManager(),o=a._IncTriggerDepth()>1;o&&a.GetLocalVarStack().Push(),this._scopeParent.SetFunctionParameters(e),i&&(t?a.PushCopySol(s):a.PushCleanSol(s));const h=n.Push(this);this._CheckParentsOKToRun(h)&&(h.SetCurrentEvent(this),this._RunAndBlock(h)),n.Pop(),o&&a.GetLocalVarStack().Pop(),i&&a.PopSol(s),a._DecTriggerDepth()}*DebugRunAsMappedFunctionCall(e,t){(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this);const s=this.GetSolModifiersIncludingParents(),i=s.length>0,r=this._runtime,n=this._eventStack,a=r.GetEventSheetManager(),o=a._IncTriggerDepth()>1;o&&a.GetLocalVarStack().Push(),this._scopeParent.SetFunctionParameters(e),i&&(t?a.PushCopySol(s):a.PushCleanSol(s));const h=n.Push(this);(yield*this._DebugCheckParentsOKToRun(h))&&(h.SetCurrentEvent(this),yield*this._DebugRunAndBlock(h)),n.Pop(),o&&a.GetLocalVarStack().Pop(),i&&a.PopSol(s),a._DecTriggerDepth()}RunAsExpressionOrJSFunctionCall(e,t,s,i,r,...n){let a,o;const h=e.length>0;let l=null;const c=this._runtime,u=this._eventStack,d=c.GetEventSheetManager(),_=this._scopeParent,p=_.IsAsync(),f=d._IncTriggerDepth()>1;f&&d.GetLocalVarStack().Push(),n.length>0&&this._scopeParent.SetFunctionParameters(n),h&&(t?d.PushCopySol(e):d.PushCleanSol(e)),null!==r&&(l=this.#s(d,r,t,e));const m=u.Push(this);return m.InitCallFunctionExpression(s,i),t&&m.SetDynamicSolModifiers(e),u.PushExpFunc(m),c.SetDebuggingEnabled(!1),this._CheckParentsOKToRun(m)&&(m.SetCurrentEvent(this),p&&([o,a]=_.StartAsyncFunctionCall()),this._RunAndBlock(m),p&&_.MaybeFinishAsyncFunctionCall(o)),c.SetDebuggingEnabled(!0),u.Pop(),u.PopExpFunc(),f&&d.GetLocalVarStack().Pop(),null!==l&&d.PopSol(l),h&&d.PopSol(e),d._DecTriggerDepth(),a||m.GetFunctionReturnValue()}}}{const tC=self.C3,sC=[];let iC=!1;tC.EventScript=class extends tC.DefendedBase{constructor(e,t,s){super();const i=e.GetRuntime(),r=e.GetEventSheetManager();this._eventSheet=e,this._eventSheetManager=r,this._runtime=e.GetRuntime(),this._parent=t;const n=i.GetObjectReference(s[1]);this._func=n,this._displayNumber=s[2],this._eventSheet._RegisterEventByDisplayNumber(this,this._displayNumber),this._debugData=i.IsDebug()?{isBreakpoint:s[3][0],isBreakable:s[3][1]}:null}static Create(e,t,s){return tC.New(tC.EventScript,e,t,s)}_PostInit(){const e=this._func,t=this._runtime.GetEventSheetManager()._GetLocalVariablesScriptInterface(this);this._func=e.bind(null,this._runtime.GetIRuntime(),t)}GetParent(){return this._parent}GetScopeParent(){return this._parent}GetEventSheet(){return this._eventSheet}GetDisplayNumber(){return this._displayNumber}IsDebugBreakable(){return this._debugData&&this._debugData.isBreakable}IsDebugBreakpoint(){return this.IsDebugBreakable()&&this._debugData.isBreakpoint}_SetDebugBreakpoint(e){this._debugData.isBreakpoint=!!e}IsElseBlock(){return!1}GetSolModifiers(){return sC}GetSolModifiersIncludingParents(){return this._parent?this._parent.GetSolModifiersIncludingParents():sC}Run(e){e.SetCurrentEvent(this),this._eventSheetManager.AddAsyncActionPromise(this._RunUserScript())}async _RunUserScript(){try{await this._func()}catch(e){console.error(`Unhandled exception running script %c${this.GetEventSheet().GetName()}, event ${this.GetDisplayNumber()}:`,"font-size: 1.2em; font-weight: bold;",e),self.C3Debugger&&self.C3Debugger._SetLastErrorScript(this),iC||(console.info("%cTip:%c run this to highlight in Construct the last script that had an error: %cgoToLastErrorScript()","font-weight: bold; text-decoration: underline","","font-weight: bold"),iC=!0)}}*DebugRun(e){e.SetCurrentEvent(this),(this.IsDebugBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this.Run(e)}DebugCanRunFast(){return!this.IsDebugBreakpoint()&&!this._runtime.DebugBreakNext()}static HadUserScriptException(){return iC}static SetHadUserScriptException(){iC=!0}}}{const rC=self.C3,nC=self.assert;rC.FunctionBlock=class extends rC.DefendedBase{constructor(e,t,s){super(),this._eventSheet=e,this._runtime=e.GetRuntime(),this._parent=t,this._functionType=0,this._functionName="",this._returnType=0,this._functionParameters=[],this._isEnabled=!0,this._aceName="",this._objectClass=null,this._hasOverrides=!1,this._innerLocalVariables=[],this._isCopyPicked=!1,this._isAsync=!1,this._nextAsyncId=0,this._currentAsyncId=-1,this._asyncMap=new Map,this._eventBlock=rC.EventBlock.Create(e,t,s),this._eventBlock._SetScopeParent(this)}InitFunctionBlock(e){this._functionType=0,this._functionName=e[0],this._returnType=e[1],this._functionParameters=e[2].map(e=>rC.EventVariable.Create(this._eventSheet,this,e)),this._isEnabled=e[3],this._isAsync=e[4],this._isCopyPicked=e[5]}InitCustomACEBlock(e){this._functionType=1,this._aceName=e[1],this._objectClass=this._runtime.GetObjectClassByIndex(e[2]),this._eventBlock._AddSolModifier(this._objectClass),this._functionName=this._objectClass.GetName()+"."+this._aceName,this._returnType=e[3],this._functionParameters=e[4].map(e=>rC.EventVariable.Create(this._eventSheet,this,e)),this._isEnabled=e[5],this._isAsync=e[6],this._isCopyPicked=e[7],this._objectClass.AddCustomAction(this)}static CreateFunctionBlock(e,t,s){const i=rC.New(rC.FunctionBlock,e,t,s),r=s[1];return i.InitFunctionBlock(r),i}static CreateCustomACEBlock(e,t,s){const i=rC.New(rC.FunctionBlock,e,t,s),r=s[1];return i.InitCustomACEBlock(r),i}_CheckOverrideState(){if(this._objectClass&&this._objectClass.IsFamily())for(const e of this._objectClass.GetFamilyMembers())if(e.HasOwnCustomActionByName(this._aceName)){this._hasOverrides=!0;break}}_PostInit(){for(const e of this._functionParameters)e._PostInit();this._eventBlock._PostInit(!1)}GetFunctionType(){return this._functionType}_GetAllLocalVariablesInScope(){return this._functionParameters}GetFunctionParameters(){return this._functionParameters}GetFunctionParameterCount(){return this._functionParameters.length}_RegisterLocalVariable(e){this._innerLocalVariables.push(e)}_GetAllInnerLocalVariables(){return this._innerLocalVariables}EvaluateFunctionParameters(e){const t=this._functionParameters;for(let s=0,i=t.length;s<i;++s)t[s].SetValue(e[s].Get(0))}SetFunctionParameters(e){const t=this._functionParameters;for(let s=0,i=t.length;s<i;++s)t[s].SetValue(e[s])}CaptureFunctionParameters(){return this._functionParameters.map(e=>e.GetValue())}GetParent(){return this._parent}GetScopeParent(){return this._parent}GetFunctionName(){return this._functionName}GetACEName(){return this._aceName}HasCustomACEOverrides(){return this._hasOverrides}GetReturnType(){return this._returnType}GetObjectClass(){return this._objectClass}IsEnabled(){return this._isEnabled}GetDefaultReturnValue(){switch(this._returnType){case 0:return null;case 2:return"";default:return 0}}GetEventBlock(){return this._eventBlock}IsCopyPicked(){return this._isCopyPicked}IsAsync(){return this._isAsync}StartAsyncFunctionCall(){const e=this._nextAsyncId++;let t;this._currentAsyncId=e;const s=new Promise(e=>t=e);return this._asyncMap.set(e,{resolve:t,pauseCount:0}),[e,s]}MaybeFinishAsyncFunctionCall(e){const t=this._asyncMap.get(e);0===t.pauseCount&&(t.resolve(),this._asyncMap.delete(e)),this._currentAsyncId=-1}PauseCurrentAsyncFunction(){return this._asyncMap.get(this._currentAsyncId).pauseCount++,this._currentAsyncId}ResumeAsyncFunction(e){this._currentAsyncId=e,this._asyncMap.get(e).pauseCount--}RunAsFamilyCustomActionWithOverrides(e,t){const s=new Map,i=[];for(const e of this._objectClass.GetCurrentSol().GetInstances()){const t=e.GetObjectClass();if(t.HasOwnCustomActionByName(this._aceName)){const i=s.get(t);Array.isArray(i)?i.push(e):s.set(t,[e])}else i.push(e)}if(i.length>0&&this._eventBlock.RunAsFunctionCall(e,t,this._isCopyPicked,{pickObjectClass:this._objectClass,pickInstances:i}),s.size>0)for(const[i,r]of s){const s=i.GetOwnCustomActionByName(this._aceName).GetEventBlock(),n=[...new Set([...e,...s.GetSolModifiers()])];s.RunAsFunctionCall(n,t,this._isCopyPicked,{pickObjectClass:i,pickInstances:r})}}*DebugRunAsFamilyCustomActionWithOverrides(e,t){const s=new Map,i=[];for(const e of this._objectClass.GetCurrentSol().GetInstances()){const t=e.GetObjectClass();if(t.HasOwnCustomActionByName(this._aceName)){const i=s.get(t);Array.isArray(i)?i.push(e):s.set(t,[e])}else i.push(e)}if(i.length>0&&(yield*this._eventBlock.DebugRunAsFunctionCall(e,t,this._isCopyPicked,{pickObjectClass:this._objectClass,pickInstances:i})),s.size>0)for(const[i,r]of s){const s=i.GetOwnCustomActionByName(this._aceName).GetEventBlock(),n=[...new Set([...e,...s.GetSolModifiers()])];yield*s.DebugRunAsFunctionCall(n,t,this._isCopyPicked,{pickObjectClass:i,pickInstances:r})}}}}{const aC=self.C3,oC=[];aC.EventVariable=class extends aC.DefendedBase{constructor(e,t,s){super();const i=e.GetEventSheetManager();this._eventSheet=e,this._eventSheetManager=i,this._runtime=e.GetRuntime(),this._parent=t,this._localVarStack=i.GetLocalVarStack(),this._name=s[1],this._type=s[2],this._initialValue=s[3],this._isStatic=!!s[4],this._isConstant=!!s[5],this._isFunctionParameter=t instanceof aC.FunctionBlock,this._sid=s[6],this._jsPropName=this._runtime.GetJsPropName(s[8]),this._scriptSetter=e=>this._ScriptSetValue(e),this._scriptGetter=()=>this.GetTypedValue(),this._hasSingleValue=!this._parent||this._isStatic||this._isConstant,this._value=this._initialValue,this._localIndex=-1,this.IsBoolean()&&(this._value=this._value?1:0),!this.IsLocal()||this.IsStatic()||this.IsConstant()||(this._localIndex=i._GetNextLocalVarIndex(this)),i._RegisterEventVariable(this)}static Create(e,t,s){return aC.New(aC.EventVariable,e,t,s)}_PostInit(){if(this.IsLocal()&&!this.IsStatic()&&!this.IsConstant()&&!this.IsFunctionParameter()){const e=this._eventSheetManager.FindFirstFunctionBlockParent(this);e&&e._RegisterLocalVariable(this)}}GetName(){return this._name}GetJsPropName(){return this._jsPropName}GetParent(){return this._parent}GetScopeParent(){return this.GetParent()}IsGlobal(){return!this.GetParent()}IsLocal(){return!this.IsGlobal()}IsFunctionParameter(){return this._isFunctionParameter}IsStatic(){return this._isStatic}IsConstant(){return this._isConstant}IsNumber(){return 0===this._type}IsString(){return 1===this._type}IsBoolean(){return 2===this._type}IsElseBlock(){return!1}GetSID(){return this._sid}GetInitialValue(){return this._initialValue}GetSolModifiers(){return oC}Run(e){!this.IsLocal()||this.IsStatic()||this.IsConstant()||this.SetValue(this.GetInitialValue())}DebugCanRunFast(){return!0}*DebugRun(e){this.Run(e)}SetValue(e){this.IsNumber()?"number"!=typeof e&&(e=parseFloat(e)):this.IsString()?"string"!=typeof e&&(e=e.toString()):this.IsBoolean()&&(e=e?1:0),this._hasSingleValue?this._value=e:this._localVarStack.GetCurrent()[this._localIndex]=e}_ScriptSetValue(e){if(this.IsConstant())throw new Error(`assignment to constant event variable '${this.GetName()}'`);this.SetValue(e)}GetValue(){return this._hasSingleValue?this._value:this._localVarStack.GetCurrent()[this._localIndex]}GetTypedValue(){let e=this.GetValue();return this.IsBoolean()&&(e=!!e),e}ResetToInitialValue(){this._value=this._initialValue}_GetScriptInterfaceDescriptor(){return{configurable:!1,enumerable:!0,get:this._scriptGetter,set:this._scriptSetter}}}}{const hC=self.C3,lC=self.assert,cC=[];hC.EventInclude=class extends hC.DefendedBase{constructor(e,t,s){super();const i=e.GetEventSheetManager();this._eventSheet=e,this._eventSheetManager=i,this._runtime=e.GetRuntime(),this._parent=t,this._includeSheet=null,this._includeSheetName=s[1],this._isActive=!0}static Create(e,t,s){return hC.New(hC.EventInclude,e,t,s)}_PostInit(){this._includeSheet=this._eventSheetManager.GetEventSheetByName(this._includeSheetName),this._eventSheet._AddShallowInclude(this);let e=this.GetParent();for(;e;)e instanceof hC.EventBlock&&e.IsGroup()&&e._AddContainedInclude(this),e=e.GetParent();this.UpdateActive(),this._runtime.IsDebug()&&this._eventSheet._GetPerfRecord().children.push(this._includeSheet._GetPerfRecord())}GetParent(){return this._parent}GetSolModifiers(){return cC}GetIncludeSheet(){return this._includeSheet}Run(e){const t=!!this.GetParent(),s=this._runtime.GetAllObjectClasses();t&&this._eventSheetManager.PushCleanSol(s),this._includeSheet.Run(),t&&this._eventSheetManager.PopSol(s)}*DebugRun(e){const t=!!this.GetParent(),s=this._runtime.GetAllObjectClasses();t&&this._eventSheetManager.PushCleanSol(s),yield*this._includeSheet.DebugRun(),t&&this._eventSheetManager.PopSol(s)}DebugCanRunFast(){return!1}IsActive(){return this._isActive}UpdateActive(){let e=this.GetParent();for(;e;){if(e instanceof hC.EventBlock&&e.IsGroup()&&!e.IsGroupActive())return void(this._isActive=!1);e=e.GetParent()}this._isActive=!0}}}{let uC=function(e,t){return e>=t?e%t:e<0?(e<=-t&&(e%=t),e<0&&(e+=t),e):e};WrapIndex=uC;const dC=self.C3,_C=self.assert;dC.ExpNode=class extends dC.DefendedBase{constructor(e){super(),this._owner=e,this._runtime=e.GetRuntime()}_PostInit(){}static CreateNode(e,t){const s=t[0],i=[SC,mC,gC,GC,pC,fC];return dC.New(i[s],e,t)}};class pC extends dC.ExpNode{constructor(e,t){super(e),this._systemPlugin=this._runtime.GetSystemPlugin(),this._func=this._runtime.GetObjectReference(t[1]),this._func!==dC.Plugins.System.Exps.random&&this._func!==dC.Plugins.System.Exps.choose||this._owner.SetVariesPerInstance()}GetBoundMethod(){return this._systemPlugin._GetBoundACEMethod(this._func,this._systemPlugin)}}class fC extends dC.ExpNode{constructor(e,t){super(e),this._functionBlock=null,this._functionName=t[1],this._owner.SetVariesPerInstance()}_PostInit(){const e=this._runtime.GetEventSheetManager();this._functionBlock=e.GetFunctionBlockByName(this._functionName),this._functionName=null;const t=this._owner.GetEventBlock(),s=this._functionBlock.GetEventBlock();this._combinedSolModifiers=[...new Set([...t.GetSolModifiersIncludingParents(),...s.GetSolModifiersIncludingParents()])],this._combinedSolModifiers=e._DeduplicateSolModifierList(this._combinedSolModifiers)}GetBoundMethod(){const e=this._functionBlock;if(e.IsEnabled()){const t=e.GetEventBlock();return dC.EventBlock.prototype.RunAsExpressionOrJSFunctionCall.bind(t,this._combinedSolModifiers,e.IsCopyPicked(),e.GetReturnType(),e.GetDefaultReturnValue(),null)}{const t=e.GetDefaultReturnValue();return()=>t}}}class mC extends dC.ExpNode{constructor(e,t){super(e),this._objectClass=this._runtime.GetObjectClassByIndex(t[1]),this._func=this._runtime.GetObjectReference(t[2]),this._returnsString=!!t[3],this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._owner._MaybeVaryFor(this._objectClass)}GetBoundMethod(){return this._objectClass.GetPlugin()._GetBoundACEMethod(this._func,this._objectClass.GetSingleGlobalInstance().GetSdkInstance())}ExpObject(...e){const t=this._objectClass,s=t.GetCurrentSol().GetExpressionInstances(),i=s.length;if(0===i)return this._returnsString?"":0;const r=uC(this._owner.GetSolIndex(),i);return this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(t),this._func.apply(s[r].GetSdkInstance(),e)}ExpObject_InstExpr(e,...t){const s=this._objectClass,i=s.GetInstances(),r=i.length;if(0===r||"number"!=typeof e)return this._returnsString?"":0;const n=uC(e,r);return this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(s),this._func.apply(i[n].GetSdkInstance(),t)}}class gC extends dC.ExpNode{constructor(e,t){super(e),this._objectClass=this._runtime.GetObjectClassByIndex(t[1]),this._varIndex=t[3],this._returnsString=!!t[2],this._owner._MaybeVaryFor(this._objectClass)}ExpInstVar(){const e=this._objectClass.GetCurrentSol().GetExpressionInstances(),t=e.length;return 0===t?this._returnsString?"":0:e[uC(this._owner.GetSolIndex(),t)]._GetInstanceVariableValueUnchecked(this._varIndex)}ExpInstVar_Family(){const e=this._objectClass,t=e.GetCurrentSol().GetExpressionInstances(),s=t.length;if(0===s)return this._returnsString?"":0;const i=t[uC(this._owner.GetSolIndex(),s)],r=i.GetObjectClass().GetFamilyInstanceVariableOffset(e.GetFamilyIndex());return i._GetInstanceVariableValueUnchecked(this._varIndex+r)}ExpInstVar_InstExpr(e){const t=this._objectClass,s=t.GetInstances(),i=s.length;if(0===i||"number"!=typeof e)return this._returnsString?"":0;const r=s[uC(e,i)];let n=0;return t.IsFamily()&&(n=r.GetObjectClass().GetFamilyInstanceVariableOffset(t.GetFamilyIndex())),r._GetInstanceVariableValueUnchecked(this._varIndex+n)}}class SC extends dC.ExpNode{constructor(e,t){super(e),this._objectClass=this._runtime.GetObjectClassByIndex(t[1]),this._behaviorType=this._objectClass.GetBehaviorTypeByName(t[2]),this._behaviorIndex=this._objectClass.GetBehaviorIndexByName(t[2]),this._func=this._runtime.GetObjectReference(t[3]),this._returnsString=!!t[4],this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._owner._MaybeVaryFor(this._objectClass)}ExpBehavior(...e){const t=this._objectClass,s=t.GetCurrentSol().GetExpressionInstances(),i=s.length;if(0===i)return this._returnsString?"":0;const r=uC(this._owner.GetSolIndex(),i);this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(t);const n=s[r];let a=0;return t.IsFamily()&&(a=n.GetObjectClass().GetFamilyBehaviorOffset(t.GetFamilyIndex())),this._func.apply(n.GetBehaviorInstances()[this._behaviorIndex+a].GetSdkInstance(),e)}ExpBehavior_InstExpr(e,...t){const s=this._objectClass,i=s.GetInstances(),r=i.length;if(0===r||"number"!=typeof e)return this._returnsString?"":0;const n=uC(e,r);this._eventStack.GetCurrentStackFrame().SetExpressionObjectClass(s);const a=i[n];let o=0;return s.IsFamily()&&(o=a.GetObjectClass().GetFamilyBehaviorOffset(s.GetFamilyIndex())),this._func.apply(a.GetBehaviorInstances()[this._behaviorIndex+o].GetSdkInstance(),t)}}class GC extends dC.ExpNode{constructor(e,t){super(e),this._eventVar=null,this._eventVarSid=t[1]}_PostInit(){this._eventVar=this._runtime.GetEventSheetManager().GetEventVariableBySID(this._eventVarSid)}GetVar(){return this._eventVar}}}{let yC=function(e){const t=self.C3_ExpressionFuncs[e];if(!t)throw new Error("invalid expression number");return t};GetExpressionFunc=yC;const IC=self.C3,TC=self.assert;IC.Parameter=class extends IC.DefendedBase{constructor(e,t,s){super(),this._owner=e,this._index=s,this._type=t,this.Get=null,this._variesPerInstance=!1,this._isConstant=!1}static Create(e,t,s){const i=t[0],r=[CC,bC,MC,wC,RC,xC,vC,CC,wC,wC,DC,EC,MC,OC,bC,AC,PC,FC,BC,kC,LC,NC,WC];return IC.New(r[i],e,i,s,t)}_PostInit(){}SetVariesPerInstance(){this._variesPerInstance=!0}_MaybeVaryFor(e){this._variesPerInstance||e&&(e.GetPlugin().IsSingleGlobal()||(this._variesPerInstance=!0))}VariesPerInstance(){return this._variesPerInstance}GetIndex(){return this._index}GetRuntime(){return this._owner.GetRuntime()}GetEventBlock(){return this._owner.GetEventBlock()}IsConstant(){return this._isConstant}IsObjectParameter(){return 4===this._type}};class CC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._solIndex=0;const r=i[1];this._expressionNumber=r[0],this._numberedNodes=[],this._expressionFunc=null;for(let e=1,t=r.length;e<t;++e)this._numberedNodes.push(IC.ExpNode.CreateNode(this,r[e]));this._numberedNodes.length?this.Get=this.GetExpression:(this.Get=yC(this._expressionNumber),this._isConstant=!0)}_GetNode(e){if(e<0||e>=this._numberedNodes.length)throw new RangeError("invalid numbered node");return this._numberedNodes[e]}_PostInit(){for(const e of this._numberedNodes)e._PostInit();const e=yC(this._expressionNumber);this._numberedNodes.length?this._expressionFunc=e(this):this._expressionFunc=e}GetSolIndex(){return this._solIndex}GetExpression(e){return this._solIndex=e,this._expressionFunc()}}class bC extends CC{constructor(e,t,s,i){super(e,t,s,i),this.Get=this.GetStringExpression,14===t&&(this.GetEventBlock().SetAllSolModifiers(),this._owner instanceof IC.Action&&this.GetEventBlock().SetSolWriterAfterCnds())}GetStringExpression(e){this._solIndex=e;const t=this._expressionFunc();return"string"==typeof t?t:""}_GetFastTriggerValue(){return yC(this._expressionNumber)()}}class xC extends CC{constructor(e,t,s,i){super(e,t,s,i),e.GetImplementationSdkVersion()>=2?this.Get=this.GetILayer:this.Get=this.GetLayer,this._isConstant=!1}GetLayer(e){this._solIndex=e;const t=this._expressionFunc();return this.GetRuntime().GetCurrentLayout().GetLayer(t)}GetILayer(e){const t=this.GetLayer(e);return t?t.GetILayer():null}}class wC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._combo=i[1],this.Get=this.GetCombo,this._isConstant=!0}GetCombo(){return this._combo}}class PC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._bool=i[1],this.Get=this.GetBoolean,this._isConstant=!0}GetBoolean(){return this._bool}}class RC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._objectClass=this.GetRuntime().GetObjectClassByIndex(i[1]),e.GetImplementationSdkVersion()>=2?this.Get=this.GetIObjectClass:this.Get=this.GetObjectClass;const r=this.GetEventBlock();r._AddSolModifier(this._objectClass),this._owner instanceof IC.Action?r.SetSolWriterAfterCnds():r.GetParent()&&r.GetParent().SetSolWriterAfterCnds(),this._isConstant=!0}GetObjectClass(){return this._objectClass}GetIObjectClass(){return this._objectClass?this._objectClass.GetIObjectClass():null}}class vC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._layout=this.GetRuntime().GetLayoutManager().GetLayoutByName(i[1]),e.GetImplementationSdkVersion()>=2?this.Get=this.GetILayout:this.Get=this.GetLayout,this._isConstant=!0}GetLayout(){return this._layout}GetILayout(){return this._layout?this._layout.GetILayout():null}}class AC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._timeline=this.GetRuntime().GetTimelineManager().GetTimelineByName(i[1]),e.GetImplementationSdkVersion()>=2?this.Get=this.GetITimelineState:this.Get=this.GetTimeline,this._isConstant=!0}GetTimeline(){return this._timeline}GetITimelineState(){return this._timeline?this._timeline.GetITimelineState():null}}class MC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._fileInfo=i[1],this.Get=this.GetFile,this._isConstant=!0}GetFile(){return this._fileInfo}}class DC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._instVarIndex=i[1];const r=this._owner.GetObjectClass();this._owner instanceof IC.Condition&&this._owner.IsStatic()?(this.Get=this.GetInstanceVariable,this._isConstant=!0):r&&r.IsFamily()?(this.Get=this.GetFamilyInstanceVariable,this.SetVariesPerInstance()):(this.Get=this.GetInstanceVariable,this._isConstant=!0)}GetInstanceVariable(){return this._instVarIndex}GetFamilyInstanceVariable(e){e=e||0;const t=this._owner.GetObjectClass(),s=t.GetCurrentSol(),i=s.GetInstances();let r=null;if(i.length)r=i[e%i.length].GetObjectClass();else if(s.HasAnyElseInstances()){const t=s.GetElseInstances();r=t[e%t.length].GetObjectClass()}else{if(!(t.GetInstanceCount()>0))return 0;{const s=t.GetInstances();r=s[e%s.length].GetObjectClass()}}return this._instVarIndex+r.GetFamilyInstanceVariableOffset(t.GetFamilyIndex())}}class EC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._eventVarSid=i[1],this._eventVar=null,e.GetImplementationSdkVersion()>=2?this.Get=this.GetIEventVariable:this.Get=this.GetEventVariable,this._isConstant=!0}_PostInit(){this._eventVar=this.GetRuntime().GetEventSheetManager().GetEventVariableBySID(this._eventVarSid)}GetEventVariable(){return this._eventVar}GetIEventVariable(){return null}}class FC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._functionBlockName=i[1],this._functionBlock=null,e.GetImplementationSdkVersion()>=2?this.Get=this.GetIFunction:this.Get=this.GetFunction,this._isConstant=!0}_PostInit(){this._functionBlock=this.GetRuntime().GetEventSheetManager().GetFunctionBlockByName(this._functionBlockName),this._functionBlockName=null}GetFunction(){return this._functionBlock}GetIFunction(){return null}}class OC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._subParams=[],this._variadicRet=[],this._isConstant=!0;for(let e=1,t=i.length;e<t;++e){const t=IC.Parameter.Create(this._owner,i[e],0);this._subParams.push(t),this._variadicRet.push(0),t.IsConstant()||(this._isConstant=!1)}this.Get=this.GetVariadic}_PostInit(){for(const e of this._subParams)e._PostInit()}GetVariadic(){const e=this._subParams,t=this._variadicRet;for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(0);return t}}class BC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._easeIndex=i[1],this.Get=this.GetEase,this._isConstant=!0}GetEase(){return this._easeIndex}}class kC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._brushIndex=i[1],this.Get=this.GetTilemapBrush,this._isConstant=!0}GetTilemapBrush(){return this._brushIndex}}class LC extends CC{constructor(e,t,s,i){super(e,t,s,i),this.Get=this.GetTemplateName,this._isConstant=!1}GetTemplateName(){return this._expressionFunc()}}class NC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._flowchartDataItem=this.GetRuntime().GetFlowchartManager().GetFlowchartDataItemByName(i[1]),this.Get=this.GetFlowchartName,this._isConstant=!0}GetFlowchartName(){return this._flowchartDataItem.GetName()}}class WC extends IC.Parameter{constructor(e,t,s,i){super(e,t,s),this._model3dDataItem=this.GetRuntime().GetModel3dManager().GetModel3dDataItemByName(i[1]),this.Get=this.GetModel3dName,this._isConstant=!0}GetModel3dName(){return this._model3dDataItem.GetName()}}}{let UC=function(e,t){for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(0)};EvalParams=UC;const VC=self.C3,HC=self.assert,jC=[],zC=function(){};VC.Condition=class extends VC.DefendedBase{constructor(e,t,s){if(super(),this._eventBlock=e,this._runtime=e.GetRuntime(),this._index=s,this._func=this._runtime.GetObjectReference(t[1]),this._isTrigger=t[3]>0,this._isFastTrigger=2===t[3],this._isLooping=!!t[4],this._isInverted=!!t[5],this._isStatic=!!t[6],this._sid=t[7],this._isInOrBlock=this._eventBlock.IsOrBlock(),this._objectClass=null,this._behaviorType=null,this._behaviorIndex=-1,this._systemPlugin=null,this.Run=zC,this.DebugRun=zC,this._parameters=[],this._results=[],this._anyParamVariesPerInstance=!1,this._savedData=null,this._unsavedData=null,this._debugData=this._runtime.IsDebug()?{isBreakpoint:t[8][0],canDebug:t[8][1]}:null,-1===t[0]?this._systemPlugin=this._runtime.GetSystemPlugin():(this._objectClass=this._runtime.GetObjectClassByIndex(t[0]),t[2]&&(this._behaviorType=this._objectClass.GetBehaviorTypeByName(t[2]),this._behaviorIndex=this._objectClass.GetBehaviorIndexByName(t[2])),this._eventBlock.GetParent()&&this._eventBlock.GetParent().SetSolWriterAfterCnds()),10===t.length){let e=t[9];for(let t of e)this._parameters.push(VC.Parameter.Create(this,t,this._parameters.length)),this._results.push(0)}0===this._parameters.length&&(this._parameters=jC,this._results=jC),this._eventBlock.GetEventSheetManager()._RegisterCondition(this)}static Create(e,t,s){return VC.New(VC.Condition,e,t,s)}_PostInit(){for(const e of this._parameters)e._PostInit(),e.VariesPerInstance()&&(this._anyParamVariesPerInstance=!0);this._isFastTrigger?(this.Run=this._RunFastTrigger,this.DebugRun=this._DebugRunFastTrigger):this._systemPlugin?(this._SetSystemRunMethod(),this.DebugRun=this._DebugRunSystem):this._objectClass.GetPlugin().IsSingleGlobal()?(this._SetSingleGlobalRunMethod(),this.DebugRun=this._DebugRunSingleGlobal):this._isStatic?(this.Run=this._RunStatic,this.DebugRun=this._DebugRunStatic):(this.Run=this._RunObject,this.DebugRun=this._DebugRunObject)}_SetSystemRunMethod(){const e=this._systemPlugin,t=this._systemPlugin;this._SetRunMethodForBoundFunc(e,t,this._RunSystem)}_SetSingleGlobalRunMethod(){const e=this._objectClass.GetPlugin(),t=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();this._SetRunMethodForBoundFunc(e,t,this._RunSingleGlobal)}_SetRunMethodForBoundFunc(e,t,s){const i=this._func,r=this._isInverted,n=this._parameters;if(0===n.length){const s=e._GetBoundACEMethod(i,t);this.Run=r?function(){return VC.xor(s(),r)}:s}else if(1===n.length){const s=n[0];if(!r&&s.IsConstant())this.Run=e._GetBoundACEMethod_1param(i,t,s.Get(0));else{const n=e._GetBoundACEMethod(i,t);this.Run=function(){return VC.xor(n(s.Get(0)),r)}}}else if(2===n.length){const s=n[0],a=n[1];if(!r&&s.IsConstant()&&a.IsConstant())this.Run=e._GetBoundACEMethod_2params(i,t,s.Get(0),a.Get(0));else{const n=e._GetBoundACEMethod(i,t);this.Run=function(){return VC.xor(n(s.Get(0),a.Get(0)),r)}}}else if(3===n.length){const s=n[0],a=n[1],o=n[2];if(!r&&s.IsConstant()&&a.IsConstant()&&o.IsConstant())this.Run=e._GetBoundACEMethod_3params(i,t,s.Get(0),a.Get(0),o.Get(0));else{const n=e._GetBoundACEMethod(i,t);this.Run=function(){return VC.xor(n(s.Get(0),a.Get(0),o.Get(0)),r)}}}else this.Run=s}GetSID(){return this._sid}_GetFunc(){return this._func}GetObjectClass(){return this._objectClass}GetBehaviorType(){return this._behaviorType}GetImplementationAddon(){return this._behaviorType?this._behaviorType.GetBehavior():this._objectClass?this._objectClass.GetPlugin():null}GetImplementationSdkVersion(){const e=this.GetImplementationAddon();return e?e.GetSdkVersion():1}GetEventBlock(){return this._eventBlock}GetRuntime(){return this._runtime}GetIndex(){return this._index}GetDebugIndex(){return this.GetIndex()}IsTrigger(){return this._isTrigger}IsFastTrigger(){return this._isFastTrigger}IsInverted(){return this._isInverted}IsLooping(){return this._isLooping}IsStatic(){return this._isStatic}IsBreakpoint(){return this._debugData.isBreakpoint}IsSystemCondition(){return!!this._systemPlugin}IsSystemOrSingleGlobalCondition(){return this.IsSystemCondition()||this._objectClass.GetPlugin().IsSingleGlobal()}GetFirstObjectParameterObjectClass(){for(const e of this._parameters)if(e.IsObjectParameter())return e.GetObjectClass();return null}_SetBreakpoint(e){this._debugData.isBreakpoint=!!e,this._eventBlock._UpdateCanRunFastRecursive()}_DebugReturnsGenerator(){return this._debugData.canDebug}DebugCanRunFast(){return!this.IsBreakpoint()&&!this._runtime.DebugBreakNext()&&!this._DebugReturnsGenerator()}GetSavedDataMap(){return this._savedData||(this._savedData=new Map),this._savedData}GetUnsavedDataMap(){return this._unsavedData||(this._unsavedData=new Map),this._unsavedData}_RunSystem(){const e=this._results;return UC(this._parameters,e),VC.xor(this._func.apply(this._systemPlugin,e),this._isInverted)}*_DebugRunSystem(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;UC(this._parameters,e);let t=this._func.apply(this._systemPlugin,e);return VC.IsIterator(t)&&(t=yield*t),VC.xor(t,this._isInverted)}return this.Run()}_RunSingleGlobal(){const e=this._results;UC(this._parameters,e);const t=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();return VC.xor(this._func.apply(t,e),this._isInverted)}*_DebugRunSingleGlobal(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;UC(this._parameters,e);const t=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();let s=this._func.apply(t,e);return VC.IsIterator(s)&&(s=yield*s),VC.xor(s,this._isInverted)}return this.Run()}_RunFastTrigger(){return!0}*_DebugRunFastTrigger(){return(this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),!0}_GetStaticConditionThis(){return this._behaviorType?this._behaviorType.GetBehavior().GetSdkVersion()>=2?this._behaviorType.GetIBehaviorType():this._behaviorType:this._objectClass.GetPlugin().GetSdkVersion()>=2?this._objectClass.GetIObjectClass():this._objectClass}_RunStatic(){const e=this._results;UC(this._parameters,e);const t=this._func.apply(this._GetStaticConditionThis(),e);return this._objectClass.ApplySolToContainer(),t}*_DebugRunStatic(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;UC(this._parameters,e);let t=this._func.apply(this._GetStaticConditionThis(),e);return VC.IsIterator(t)&&(t=yield*t),this._objectClass.ApplySolToContainer(),t}return this.Run()}_RunObject(){const e=this._parameters,t=this._results,s=this._objectClass.GetCurrentSol();for(let s=0,i=e.length;s<i;++s){const i=e[s];i.VariesPerInstance()||(t[s]=i.Get(0))}return s.IsSelectAll()?this._RunObject_FirstFilter(s):this._RunObject_NextFilter(s)}*_DebugRunObject(){return(this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._RunObject()}_EvaluateVaryingParameters(e){const t=this._parameters,s=this._results;for(let i=0,r=t.length;i<r;++i){const r=t[i];r.VariesPerInstance()&&(s[i]=r.Get(e))}}_RunObject_FirstFilter(e){const t=this._objectClass,s=t.IsFamily(),i=t.GetFamilyIndex(),r=this._behaviorIndex,n=r>=0,a=t.GetInstances(),o=this._anyParamVariesPerInstance,h=this._results,l=this._func,c=this._isInverted,u=this._isInOrBlock&&!this._isTrigger;e.ClearArrays();for(let t=0,d=a.length;t<d;++t){const d=a[t];let _;if(o&&this._EvaluateVaryingParameters(t),n){const e=s?d.GetObjectClass().GetFamilyBehaviorOffset(i):0;_=l.apply(d.GetBehaviorInstances()[r+e].GetSdkInstance(),h)}else _=l.apply(d.GetSdkInstance(),h);VC.xor(_,c)?e._PushInstance(d):u&&e._PushElseInstance(d)}return t.FinishCondition(!0),e._SetSelectAll(!1),t.ApplySolToContainer(),e.HasAnyInstances()}_RunObject_NextFilter(e){const t=this._objectClass,s=t.IsFamily(),i=t.GetFamilyIndex(),r=t.IsInContainer(),n=this._behaviorIndex,a=n>=0,o=this._anyParamVariesPerInstance,h=this._results,l=this._func,c=this._isInverted,u=this._isInOrBlock&&!this._isTrigger,d=e._GetOwnInstances(),_=e._GetOwnElseInstances(),p=u&&!this._eventBlock.IsFirstConditionOfType(this),f=p?_:d;let m=0,g=!1;for(let e=0,t=f.length;e<t;++e){const t=f[e];let S;if(o&&this._EvaluateVaryingParameters(e),a){const e=s?t.GetObjectClass().GetFamilyBehaviorOffset(i):0;S=l.apply(t.GetBehaviorInstances()[n+e].GetSdkInstance(),h)}else S=l.apply(t.GetSdkInstance(),h);VC.xor(S,c)?(g=!0,p?(d.push(t),r&&t._PushSiblingsToSolInstances()):(f[m]=t,r&&t._SetSiblingsToSolInstancesIndex(m),++m)):p?(f[m]=t,r&&t._SetSiblingsToSolElseInstancesIndex(m),++m):u&&(_.push(t),r&&t._PushSiblingsToSolElseInstances())}VC.truncateArray(f,m),r&&t._TruncateContainerSols(p,m);const S=g;return p&&!g&&(g=this._OrBlockCheckInstances(d)),t.FinishCondition(S||u),u?g:e.HasAnyInstances()}_OrBlockCheckInstances(e){const t=this._objectClass,s=t.IsFamily(),i=t.GetFamilyIndex(),r=this._anyParamVariesPerInstance,n=this._behaviorIndex,a=n>=0,o=this._results,h=this._func,l=this._isInverted;for(let t=0,c=e.length;t<c;++t){const c=e[t];let u;if(r&&this._EvaluateVaryingParameters(t),a){const e=s?c.GetObjectClass().GetFamilyBehaviorOffset(i):0;u=h.apply(c.GetBehaviorInstances()[n+e].GetSdkInstance(),o)}else u=h.apply(c.GetSdkInstance(),o);if(VC.xor(u,l))return!0}return!1}ReevaluateParameter(e,t){return this._parameters[e].Get(t)}GetFastTriggerValue(){const e=this._parameters;if(!e.length)throw new Error("no parameters");return e[0]._GetFastTriggerValue()}_SaveToJson(){if(!this._savedData||!this._savedData.size)return null;const e={};for(const[t,s]of this._savedData.entries()){let i=s;"collmemory"===t&&(i=[...s.entries()].map(e=>[e[0].GetUID(),e[1].GetUID(),e[2]])),e[t]=i}return{ex:e}}_LoadFromJson(e){if(this._savedData&&(this._savedData.clear(),this._savedData=null),!e)return;const t=this._runtime,s=e.ex;if(s){const e=this.GetSavedDataMap();e.clear();for(const[i,r]of Object.entries(s)){let s=r;"collmemory"===i&&(s=VC.New(VC.PairMap,r.map(e=>[t.GetInstanceByUID(e[0]),t.GetInstanceByUID(e[1]),e[2]]).filter(e=>e[0]&&e[1]))),e.set(i,s)}}}}}{let XC=function(e,t){for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(0)};EvalParams=XC;const YC=self.C3,qC=self.assert,KC=[],$C=function(){},JC=function*(){},ZC=1,QC=2,eb=4,tb=8,sb=16;YC.Action=class extends YC.DefendedBase{constructor(e,t,s){super(),this._eventBlock=e;const i=e.GetRuntime();this._runtime=i,this._index=s,this._sid=t.length>=4?t[3]:-1,this._actionType=t.length>=5?255&t[4]:0,this._flags=t.length>=5?t[4]>>8:0,this._func=null,this._objectClass=null,this._behaviorType=null,this._behaviorIndex=-1,this._systemPlugin=null,this._callFunctionName="",this._callCustomAceObjectClass=null,this._callEventBlock=null,this.Run=$C,this.DebugRun=$C,this._parameters=[],this._results=[],this._anyParamVariesPerInstance=!1;const r=-3===t[0],n=r?t[2]:t[5];if(this._debugData=i.IsDebug()||r?{isBreakpoint:n[0],canDebug:n[1],index:n[2]}:null,-1===t[0])this._systemPlugin=i.GetSystemPlugin(),this._func=i.GetObjectReference(t[1]);else if(-2===t[0])this._callFunctionName=t[1];else if(r){const e=i.GetObjectReference(t[1]);this._func=e,this.Run=this.RunUserScript,this.DebugRun=this.DebugRunUserScript,this._flags|=8}else this._objectClass=i.GetObjectClassByIndex(t[0]),4&this._flags?(this._callFunctionName=t[1],this._callCustomAceObjectClass=i.GetObjectClassByIndex(t[2])):(t[2]&&(this._behaviorType=this._objectClass.GetBehaviorTypeByName(t[2]),this._behaviorIndex=this._objectClass.GetBehaviorIndexByName(t[2])),this._func=i.GetObjectReference(t[1]));if(7===t.length){const e=t[6];for(const t of e)this._parameters.push(YC.Parameter.Create(this,t,this._parameters.length)),this._results.push(0)}0===this._parameters.length&&(this._parameters=KC,this._results=KC),this.CanPickAnyObjectClass()&&(this._eventBlock.SetAllSolModifiers(),this._eventBlock.SetSolWriterAfterCnds()),this._eventBlock.GetEventSheetManager()._RegisterAction(this)}static Create(e,t,s){return YC.New(YC.Action,e,t,s)}_PostInit(){for(const e of this._parameters)e._PostInit(),e.VariesPerInstance()&&(this._anyParamVariesPerInstance=!0);if(this._systemPlugin)this._SetSystemRunMethod(),this.DebugRun=this._DebugRunSystem;else if(this._callFunctionName)4&this._flags?this._SetCallCustomActionRunMethod():this._SetCallFunctionRunMethod(),this._callFunctionName="",this._callCustomAceObjectClass=null;else if(this.Run===this.RunUserScript){const e=this._func,t=this._runtime.GetEventSheetManager()._GetLocalVariablesScriptInterface(this._eventBlock);this._func=e.bind(null,this._runtime.GetIRuntime(),t)}else this._behaviorType?this.IsAsync()?(this.Run=this._RunBehavior_Async,this.DebugRun=this._DebugRunBehavior_Async):(this.Run=this._RunBehavior,this.DebugRun=this._DebugRunBehavior):this._objectClass.GetPlugin().IsSingleGlobal()?(this._SetSingleGlobalRunMethod(),this.DebugRun=this._DebugRunSingleGlobal):this.IsStatic()?(this.Run=this._RunObject_Static,this.DebugRun=this._DebugRunObject_Static):this.IsAsync()?(this.Run=this._RunObject_Async,this.DebugRun=this._DebugRunObject_Async):this.CallBeforeAfterHooks()?(this.Run=this._RunObject_BeforeAfterHooks,this.DebugRun=this._DebugRunObject_BeforeAfterHooks):this._parameters.length?this._parameters.every(e=>e.VariesPerInstance())?(this.Run=this._RunObject_AllParamsVary,this.DebugRun=this._DebugRunObject_AllParamsVary):this._anyParamVariesPerInstance?(this.Run=this._RunObject_SomeParamsVary,this.DebugRun=this._DebugRunObject_SomeParamsVary):this._parameters.every(e=>e.IsConstant())?(XC(this._parameters,this._results),this.Run=this._RunObject_ParamsConst,this.DebugRun=this._DebugRunObject_ParamsConst):(this.Run=this._RunObject_ParamsDontVary,this.DebugRun=this._DebugRunObject_ParamsDontVary):(this.Run=this._RunObject_ParamsConst,this.DebugRun=this._DebugRunObject_ParamsConst)}_SetSystemRunMethod(){const e=this._systemPlugin,t=this._systemPlugin;this._SetRunMethodForBoundFunc(e,t,this._RunSystem)}_SetSingleGlobalRunMethod(){const e=this._objectClass.GetPlugin(),t=this._objectClass.GetSingleGlobalInstance().GetSdkInstance();this._SetRunMethodForBoundFunc(e,t,this._RunSingleGlobal)}_SetCallFunctionRunMethod(){const e=this._eventBlock.GetEventSheetManager(),t=e.GetFunctionBlockByName(this._callFunctionName);if(t.IsEnabled()){const s=!!(2&this._flags);this._callEventBlock=t.GetEventBlock();let i=[...new Set([...this._eventBlock.GetSolModifiersIncludingParents(),...this._callEventBlock.GetSolModifiersIncludingParents()])];i=e._DeduplicateSolModifierList(i);const r=!t.IsCopyPicked()&&this._HasCopyPickedParent()?{pushCleanSolDynamic:!0}:null;if(this.Run=YC.EventBlock.prototype.RunAsFunctionCall.bind(this._callEventBlock,i,this._parameters,s,r),this._runtime.IsDebug()){const e=this;this.DebugRun=function*(){return(e.IsBreakpoint()||e._runtime.DebugBreakNext())&&(yield e),yield*e._callEventBlock.DebugRunAsFunctionCall(i,e._parameters,s,r)}}else this.DebugRun=JC}else this.Run=$C,this.DebugRun=JC}_SetCallCustomActionRunMethod(){const e=this._eventBlock.GetEventSheetManager(),t=e.GetCustomActionBlockByName(this._callCustomAceObjectClass,this._callFunctionName);if(t.IsEnabled()){const s=!!(2&this._flags);this._callEventBlock=t.GetEventBlock();let i=[...new Set([...this._eventBlock.GetSolModifiersIncludingParents(),...this._callEventBlock.GetSolModifiersIncludingParents(),this._objectClass,t.GetObjectClass()])];i=e._DeduplicateSolModifierList(i);const r=!this._objectClass.IsFamily()&&!t.GetObjectClass().IsFamily(),n=!this._objectClass.IsFamily()&&t.GetObjectClass().IsFamily(),a=this._objectClass.IsFamily();let o=null;if(!t.IsCopyPicked()&&this._HasCopyPickedParent()&&(o=o||{},o.pushCleanSolDynamic=!0),!n&&s||(o=o||{},o.copyFromObjectClass=this._objectClass,o.copyToObjectClass=t.GetObjectClass()),r||n||a&&!t.HasCustomACEOverrides()?this.Run=YC.EventBlock.prototype.RunAsFunctionCall.bind(this._callEventBlock,i,this._parameters,s,o):a&&(this.Run=YC.FunctionBlock.prototype.RunAsFamilyCustomActionWithOverrides.bind(t,i,this._parameters)),this._runtime.IsDebug()){const e=this;r||n||a&&!t.HasCustomACEOverrides()?this.DebugRun=function*(){return(e.IsBreakpoint()||e._runtime.DebugBreakNext())&&(yield e),yield*e._callEventBlock.DebugRunAsFunctionCall(i,e._parameters,s,o)}:a&&(this.DebugRun=function*(){return(e.IsBreakpoint()||e._runtime.DebugBreakNext())&&(yield e),yield*t.DebugRunAsFamilyCustomActionWithOverrides(i,e._parameters)})}else this.DebugRun=JC}else this.Run=$C,this.DebugRun=JC}_SetRunMethodForBoundFunc(e,t,s){const i=this._func,r=this._parameters;if(0===r.length)this.Run=e._GetBoundACEMethod(i,t);else if(1===r.length){const s=r[0];if(s.IsConstant())this.Run=e._GetBoundACEMethod_1param(i,t,s.Get(0));else{const r=e._GetBoundACEMethod(i,t);this.Run=function(){return r(s.Get(0))}}}else if(2===r.length){const s=r[0],n=r[1];if(s.IsConstant()&&n.IsConstant())this.Run=e._GetBoundACEMethod_2params(i,t,s.Get(0),n.Get(0));else{const r=e._GetBoundACEMethod(i,t);this.Run=function(){return r(s.Get(0),n.Get(0))}}}else if(3===r.length){const s=r[0],n=r[1],a=r[2];if(s.IsConstant()&&n.IsConstant()&&a.IsConstant())this.Run=e._GetBoundACEMethod_3params(i,t,s.Get(0),n.Get(0),a.Get(0));else{const r=e._GetBoundACEMethod(i,t);this.Run=function(){return r(s.Get(0),n.Get(0),a.Get(0))}}}else this.Run=s}GetSID(){return this._sid}IsAsync(){return!!(8&this._flags)}CanBailOut(){return!!(16&this._flags)}CallBeforeAfterHooks(){return 1===this._actionType}IsStatic(){return 2===this._actionType}CanPickAnyObjectClass(){return!!(1&this._flags)}HasReturnType(){return this.IsAsync()||this.CanBailOut()}GetObjectClass(){return this._objectClass}GetImplementationAddon(){return this._behaviorType?this._behaviorType.GetBehavior():this._objectClass?this._objectClass.GetPlugin():null}GetImplementationSdkVersion(){const e=this.GetImplementationAddon();return e?e.GetSdkVersion():1}GetEventBlock(){return this._eventBlock}_HasCopyPickedParent(){let e=this._eventBlock;do{if(e instanceof YC.FunctionBlock&&e.IsCopyPicked())return!0;e=e.GetScopeParent()}while(e);return!1}GetRuntime(){return this._runtime}GetIndex(){return this._index}GetDebugIndex(){return this._debugData.index}IsBreakpoint(){return this._debugData.isBreakpoint}_SetBreakpoint(e){this._debugData.isBreakpoint=!!e,this._eventBlock._UpdateCanRunFastRecursive()}_DebugReturnsGenerator(){return this._debugData.canDebug}DebugCanRunFast(){return!this.IsBreakpoint()&&!this._runtime.DebugBreakNext()&&!this._DebugReturnsGenerator()}_RunSystem(){const e=this._results;return XC(this._parameters,e),this._func.apply(this._systemPlugin,e)}*_DebugRunSystem(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;return XC(this._parameters,e),yield*this._func.apply(this._systemPlugin,e)}return this.Run()}_RunSingleGlobal(){const e=this._results;return XC(this._parameters,e),this._func.apply(this._objectClass.GetSingleGlobalInstance().GetSdkInstance(),e)}*_DebugRunSingleGlobal(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;return XC(this._parameters,e),yield*this._func.apply(this._objectClass.GetSingleGlobalInstance().GetSdkInstance(),e)}return this.Run()}_RunObject_ParamsConst(){const e=this._results,t=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=t.length;s<i;++s)this._func.apply(t[s].GetSdkInstance(),e)}*_DebugRunObject_ParamsConst(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results,t=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=t.length;s<i;++s)yield*this._func.apply(t[s].GetSdkInstance(),e)}else this._RunObject_ParamsConst()}_RunObject_ParamsDontVary(){const e=this._results;XC(this._parameters,e);const t=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=t.length;s<i;++s)this._func.apply(t[s].GetSdkInstance(),e)}*_DebugRunObject_ParamsDontVary(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;XC(this._parameters,e);const t=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=t.length;s<i;++s)yield*this._func.apply(t[s].GetSdkInstance(),e)}else this._RunObject_ParamsDontVary()}_RunObject_AllParamsVary(){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(r);s.apply(n.GetSdkInstance(),t)}}*_DebugRunObject_AllParamsVary(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(r);yield*s.apply(n.GetSdkInstance(),t)}}else this._RunObject_AllParamsVary()}_RunObject_SomeParamsVary(){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=e.length;s<i;++s){const i=e[s];i.VariesPerInstance()||(t[s]=i.Get(0))}for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=e.length;s<i;++s){const i=e[s];i.VariesPerInstance()&&(t[s]=i.Get(r))}s.apply(n.GetSdkInstance(),t)}}*_DebugRunObject_SomeParamsVary(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances();for(let s=0,i=e.length;s<i;++s){const i=e[s];i.VariesPerInstance()||(t[s]=i.Get(0))}for(let r=0,n=i.length;r<n;++r){const n=i[r];for(let s=0,i=e.length;s<i;++s){const i=e[s];i.VariesPerInstance()&&(t[s]=i.Get(r))}yield*s.apply(n.GetSdkInstance(),t)}}else this._RunObject_SomeParamsVary()}_RunObject_BeforeAfterHooks(){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass,r=i.GetSdkType(),n=i.GetCurrentSol().GetInstances();r.BeforeRunAction(s);for(let i=0,r=n.length;i<r;++i){const r=n[i];for(let s=0,r=e.length;s<r;++s)t[s]=e[s].Get(i);s.apply(r.GetSdkInstance(),t)}r.AfterRunAction(s)}*_DebugRunObject_BeforeAfterHooks(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass,r=i.GetSdkType(),n=i.GetCurrentSol().GetInstances();r.BeforeRunAction(s);for(let i=0,r=n.length;i<r;++i){const r=n[i];for(let s=0,r=e.length;s<r;++s)t[s]=e[s].Get(i);yield*s.apply(r.GetSdkInstance(),t)}r.AfterRunAction(s)}else this._RunObject_BeforeAfterHooks()}_GetStaticActionThis(){return this._behaviorType?this._behaviorType.GetBehavior().GetSdkVersion()>=2?this._behaviorType.GetIBehaviorType():this._behaviorType:this._objectClass.GetPlugin().GetSdkVersion()>=2?this._objectClass.GetIObjectClass():this._objectClass}_RunObject_Static(){const e=this._results;return XC(this._parameters,e),this._func.apply(this._GetStaticActionThis(),e)}*_DebugRunObject_Static(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._results;XC(this._parameters,e);let t=this._func.apply(this._GetStaticActionThis(),e);return YC.IsIterator(t)&&(t=yield*t),t}return this._RunObject_Static()}_RunBehavior(){const e=this._objectClass,t=e.IsFamily(),s=e.GetFamilyIndex(),i=this._parameters,r=this._anyParamVariesPerInstance,n=this._results,a=this._func,o=this._behaviorIndex,h=e.GetCurrentSol().GetInstances();for(let e=0,t=i.length;e<t;++e){const t=i[e];t.VariesPerInstance()||(n[e]=t.Get(0))}for(let e=0,l=h.length;e<l;++e){const l=h[e];if(r)for(let t=0,s=i.length;t<s;++t){const s=i[t];s.VariesPerInstance()&&(n[t]=s.Get(e))}const c=t?l.GetObjectClass().GetFamilyBehaviorOffset(s):0;a.apply(l.GetBehaviorInstances()[o+c].GetSdkInstance(),n)}}*_DebugRunBehavior(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._objectClass,t=e.IsFamily(),s=e.GetFamilyIndex(),i=this._parameters,r=this._anyParamVariesPerInstance,n=this._results,a=this._func,o=this._behaviorIndex,h=e.GetCurrentSol().GetInstances();for(let e=0,t=i.length;e<t;++e){const t=i[e];t.VariesPerInstance()||(n[e]=t.Get(0))}for(let e=0,l=h.length;e<l;++e){const l=h[e];if(r)for(let t=0,s=i.length;t<s;++t){const s=i[t];s.VariesPerInstance()&&(n[t]=s.Get(e))}const c=t?l.GetObjectClass().GetFamilyBehaviorOffset(s):0;yield*a.apply(l.GetBehaviorInstances()[o+c].GetSdkInstance(),n)}}else this._RunBehavior()}_RunObject_Async(){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances(),r=[];for(let n=0,a=i.length;n<a;++n){const a=i[n];for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(n);r.push(s.apply(a.GetSdkInstance(),t))}return Promise.all(r)}*_DebugRunObject_Async(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._parameters,t=this._results,s=this._func,i=this._objectClass.GetCurrentSol().GetInstances(),r=[];for(let n=0,a=i.length;n<a;++n){const a=i[n];for(let s=0,i=e.length;s<i;++s)t[s]=e[s].Get(n);r.push(yield*s.apply(a.GetSdkInstance(),t))}return Promise.all(r)}return this._RunObject_Async()}_RunBehavior_Async(){const e=this._objectClass,t=e.IsFamily(),s=e.GetFamilyIndex(),i=this._parameters,r=this._results,n=this._func,a=this._behaviorIndex,o=e.GetCurrentSol().GetInstances(),h=[];for(let e=0,l=o.length;e<l;++e){const l=o[e];for(let t=0,s=i.length;t<s;++t)r[t]=i[t].Get(e);const c=t?l.GetObjectClass().GetFamilyBehaviorOffset(s):0;h.push(n.apply(l.GetBehaviorInstances()[a+c].GetSdkInstance(),r))}return Promise.all(h)}*_DebugRunBehavior_Async(){if((this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this._DebugReturnsGenerator()){const e=this._objectClass,t=e.IsFamily(),s=e.GetFamilyIndex(),i=this._parameters,r=this._results,n=this._func,a=this._behaviorIndex,o=e.GetCurrentSol().GetInstances(),h=[];for(let e=0,l=o.length;e<l;++e){const l=o[e];for(let t=0,s=i.length;t<s;++t)r[t]=i[t].Get(e);const c=t?l.GetObjectClass().GetFamilyBehaviorOffset(s):0;h.push(yield*n.apply(l.GetBehaviorInstances()[a+c].GetSdkInstance(),r))}return Promise.all(h)}return this._RunBehavior_Async()}async RunUserScript(){try{await this._func()}catch(e){console.error(`Unhandled exception running script %c${this._eventBlock.GetEventSheet().GetName()}, event ${this._eventBlock.GetDisplayNumber()}, action ${this.GetDebugIndex()+1}:`,"font-size: 1.2em; font-weight: bold;",e),self.C3Debugger&&self.C3Debugger._SetLastErrorScript(this),YC.EventScript.HadUserScriptException()||(console.info("%cTip:%c run this to highlight in Construct the last script that had an error: %cgoToLastErrorScript()","font-weight: bold; text-decoration: underline","","font-weight: bold"),YC.EventScript.SetHadUserScriptException())}}*DebugRunUserScript(){return(this.IsBreakpoint()||this._runtime.DebugBreakNext())&&(yield this),this.RunUserScript()}_SaveToJson(){return this._savedData&&this._savedData.size?{ex:YC.ToSuperJSON(this._savedData)}:null}_LoadFromJson(e){if(this._savedData&&(this._savedData.clear(),this._savedData=null),!e)return;const t=e.ex;t&&(this._savedData=YC.FromSuperJSON(t))}}}{let ib=function(e){return e instanceof bb?Cb._UnwrapScriptInterface(e):e.GetInstance()},rb=function(e){return ib(e).GetWorldInfo()},nb=function(e){return Cb._UnwrapScriptInterface(e)},ab=function(e){return nb(e).GetWorldInfo()},ob=function(e){return e instanceof xb?Cb._UnwrapScriptInterface(e):e},hb=function(e){return e instanceof wb?Cb._UnwrapScriptInterface(e):e},lb=function(e,t,s,i){t.GetUID()<s.GetUID()?e.Set(t,s,i):e.Set(s,t,i)},cb=function(e,t,s){t.GetUID()<s.GetUID()?e.Delete(t,s):e.Delete(s,t)},ub=function(e,t){e.DeleteEither(t)},db=function(e,t,s){return t.GetUID()<s.GetUID()?e.Get(t,s):e.Get(s,t)},_b=function(e,t,s,i){if(!t)return!1;const r=0!==s||0!==i,n=e.GetWorldInfo(),a=Cb.GetCollisionEngine(),o=Cb.GetCurrentCondition(),h=o.GetEventBlock().IsOrBlock(),l=o.GetObjectClass(),c=o.IsInverted(),u=t.GetCurrentSol(),d=l!==t;let _;Mb=t,Ab=d&&!c,Db=!1;let p=0,f=0,m=!1;u.IsSelectAll()?(Pb.copy(n.GetBoundingBox()),Pb.offset(s,i),a.GetCollisionCandidates(n.GetLayer(),t,Pb,vb),_=vb):h?Cb.IsCurrentConditionFirst()&&!u._GetOwnElseInstances().length&&u._GetOwnInstances().length?_=u._GetOwnInstances():(_=u._GetOwnElseInstances(),Db=!0):_=u._GetOwnInstances(),r&&(p=n.GetX(),f=n.GetY(),n.OffsetXY(s,i),n.SetBboxChanged());for(const t of _)if(a.TestOverlap(e,t)){if(m=!0,c)break;d&&Eb.add(t)}return r&&(n.SetXY(p,f),n.SetBboxChanged()),Sb.clearArray(vb),m},pb=function(e){const t=Cb.GetCurrentEvent().IsOrBlock(),s=Mb.GetCurrentSol(),i=s._GetOwnInstances(),r=s._GetOwnElseInstances();s.IsSelectAll()?(s.SetSetPicked(Eb),t&&(Sb.clearArray(r),s.AddElseInstances(Eb,Mb.GetInstances()))):t?Db?s.TransferElseInstancesToOwn(Eb):(s.AddElseInstances(Eb,i),s.SetSetPicked(Eb)):s.SetSetPicked(Eb),Mb.ApplySolToContainer()},fb=function(e,t){Ab&&(t&&pb(e),Eb.clear(),Mb=null,Ab=!1)},mb=function(e,t){const s=Cb.GetInstanceByUID(t);if(!s)return!1;const i=e.GetCurrentSol();if(!i.IsSelectAll()&&!i._GetOwnInstances().includes(s))return!1;if(e.IsFamily()){if(s.GetObjectClass().BelongsToFamily(e))return i.PickOne(s),e.ApplySolToContainer(),!0}else if(s.GetObjectClass()===e)return i.PickOne(s),e.ApplySolToContainer(),!0;return!1},gb=function(e,t){const s=e.GetCurrentSol();if(s.IsSelectAll()){s._SetSelectAll(!1),s.ClearArrays();const i=e.GetInstances();for(let e=0,r=i.length;e<r;++e){const r=i[e];r.GetUID()===t?s._PushElseInstance(r):s._PushInstance(r)}return e.ApplySolToContainer(),!!s._GetOwnInstances().length}{const i=s._GetOwnInstances();let r=0;for(let e=0,n=i.length;e<n;++e){const n=i[e];i[r]=n,n.GetUID()===t?s._PushElseInstance(n):++r}return Sb.truncateArray(i,r),e.ApplySolToContainer(),!!i.length}};GetInst=ib,GetWorldInfo=rb,GetInst_SDKv2=nb,GetWorldInfo_SDKv2=ab,GetObjectClass=ob,GetLayer=hb,CollMemory_Add=lb,CollMemory_Remove=cb,CollMemory_RemoveInstance=ub,CollMemory_Get=db,DoOverlapCondition=_b,FinishCollisionConditionPicking=pb,FinishCollisionCondition=fb,PickByUID_Normal=mb,PickByUID_Inverted=gb;const Sb=self.C3,Gb=new Sb.Color,yb={},Ib={},Tb={};let Cb=null;Sb.CommonACES_SetRuntime=function(e){Cb=e};const bb=self.IInstance,xb=self.IObjectClass,wb=self.ILayer;Ib.CompareX=function(e,t){return Sb.compare(this.GetWorldInfo().GetX(),e,t)},Tb.CompareX=function(e,t){return Sb.compare(this.x,e,t)},Ib.CompareY=function(e,t){return Sb.compare(this.GetWorldInfo().GetY(),e,t)},Tb.CompareY=function(e,t){return Sb.compare(this.y,e,t)},Ib.IsOnScreen=function(){return this.GetWorldInfo().IsInViewport2()},Tb.IsOnScreen=function(){return this.isOnScreen()},yb.IsOutsideLayout=function(){const e=rb(this),t=e.GetLayout(),s=e.GetBoundingBox();return s.getRight()<0||s.getBottom()<0||s.getLeft()>t.GetWidth()||s.getTop()>t.GetHeight()},yb.PickDistance=function(e,t,s,i){const r=ob(this).GetCurrentSol(),n=r.GetInstances();if(0===n.length)return!1;const a=[];let o=0;for(let r=0,h=n.length;r<h;++r){const h=n[r],l=h.GetWorldInfo(),c=Sb.distanceSquared(l.GetX(),l.GetY(),t,s);0===a.length||0===e&&c<o||1===e&&c>o?(o=c,Sb.clearArray(a),a.push(h)):i&&c===o&&a.push(h)}return i?r.SetArrayPicked(a):r.PickOne(a[0]),!0},Ib.SetX=function(e){const t=this.GetWorldInfo();t.GetX()!==e&&(t.SetX(e),t.SetBboxChanged())},Tb.SetX=function(e){this.x=+e},Ib.SetY=function(e){const t=this.GetWorldInfo();t.GetY()!==e&&(t.SetY(e),t.SetBboxChanged())},Tb.SetY=function(e){this.y=+e},Ib.SetPos=function(e,t){const s=this.GetWorldInfo();s.EqualsXY(e,t)||(s.SetXY(e,t),s.SetBboxChanged())},Tb.SetPos=function(e,t){this.setPosition(e,t)},yb.SetPosToObject=function(e,t){if(!(e=ob(e)))return;const s=ib(this),i=e.GetPairedInstance(s);if(!i)return;const[r,n]=i.GetImagePoint(t),a=s.GetWorldInfo();a.GetX()===r&&a.GetY()===n||(a.SetXY(r,n),a.SetBboxChanged())},yb.MoveForward=function(e){if(0===e)return;const t=rb(this);t.OffsetXY(t.GetCosAngle()*e,t.GetSinAngle()*e),t.SetBboxChanged()},Ib.MoveAtAngle=function(e,t){if(0===t)return;const s=this.GetWorldInfo();e=Sb.toRadians(e),s.OffsetXY(Math.cos(e)*t,Math.sin(e)*t),s.SetBboxChanged()},Tb.MoveAtAngle=function(e,t){0!==t&&(e=Sb.toRadians(e),this.offsetPosition(Math.cos(e)*t,Math.sin(e)*t))},Ib.GetX=function(){return this.GetWorldInfo().GetX()},Tb.GetX=function(){return this.x},Ib.GetY=function(){return this.GetWorldInfo().GetY()},Tb.GetY=function(){return this.y},yb.GetDt=function(){return Cb.GetDt(ib(this))},Ib.CompareWidth=function(e,t){return Sb.compare(this.GetWorldInfo().GetWidth(),e,t)},Tb.CompareWidth=function(e,t){return Sb.compare(this.width,e,t)},Ib.CompareHeight=function(e,t){return Sb.compare(this.GetWorldInfo().GetHeight(),e,t)},Tb.CompareHeight=function(e,t){return Sb.compare(this.height,e,t)},Ib.SetWidth=function(e){const t=this.GetWorldInfo();t.GetWidth()!==e&&(t.SetWidth(e),t.SetBboxChanged())},Tb.SetWidth=function(e){this.width=e},Ib.SetHeight=function(e){const t=this.GetWorldInfo();t.GetHeight()!==e&&(t.SetHeight(e),t.SetBboxChanged())},Tb.SetHeight=function(e){this.height=e},Ib.SetSize=function(e,t){const s=rb(this);s.GetWidth()===e&&s.GetHeight()===t||(s.SetSize(e,t),s.SetBboxChanged())},Tb.SetSize=function(e,t){this.setSize(e,t)},Ib.GetWidth=function(){return this.GetWorldInfo().GetWidth()},Tb.GetWidth=function(){return this.width},Ib.GetHeight=function(){return this.GetWorldInfo().GetHeight()},Tb.GetHeight=function(){return this.height},yb.GetBboxLeft=function(){return rb(this).GetBoundingBox().getLeft()},yb.GetBboxTop=function(){return rb(this).GetBoundingBox().getTop()},yb.GetBboxRight=function(){return rb(this).GetBoundingBox().getRight()},yb.GetBboxBottom=function(){return rb(this).GetBoundingBox().getBottom()},yb.GetBboxMidX=function(){const e=rb(this).GetBoundingBox();return(e.getLeft()+e.getRight())/2},yb.GetBboxMidY=function(){const e=rb(this).GetBoundingBox();return(e.getTop()+e.getBottom())/2},yb.IsAngleWithin=function(e,t){return Sb.angleDiff(rb(this).GetAngle(),Sb.toRadians(t))<=Sb.toRadians(e)},yb.IsAngleClockwiseFrom=function(e){return Sb.angleClockwise(rb(this).GetAngle(),Sb.toRadians(e))},yb.IsBetweenAngles=function(e,t){const s=Sb.toRadians(e),i=Sb.toRadians(t),r=rb(this).GetAngle();return Sb.angleClockwise(i,s)?Sb.angleClockwise(r,s)&&!Sb.angleClockwise(r,i):!(!Sb.angleClockwise(r,s)&&Sb.angleClockwise(r,i))},Ib.SetAngle=function(e){const t=this.GetWorldInfo(),s=Sb.clampAngle(Sb.toRadians(e));isNaN(s)||t.GetAngle()===s||(t.SetAngle(s),t.SetBboxChanged())},Tb.SetAngle=function(e){this.angleDegrees=e},yb.RotateClockwise=function(e){if(isNaN(e)||0===e)return;const t=rb(this);t.SetAngle(t.GetAngle()+Sb.toRadians(e)),t.SetBboxChanged()},yb.RotateCounterclockwise=function(e){if(isNaN(e)||0===e)return;const t=rb(this);t.SetAngle(t.GetAngle()-Sb.toRadians(e)),t.SetBboxChanged()},yb.RotateTowardAngle=function(e,t){const s=rb(this),i=s.GetAngle(),r=Sb.angleRotate(i,Sb.toRadians(t),Sb.toRadians(e));isNaN(r)||i===r||(s.SetAngle(r),s.SetBboxChanged())},yb.RotateTowardPosition=function(e,t,s){const i=rb(this),r=i.GetAngle(),n=t-i.GetX(),a=s-i.GetY(),o=Math.atan2(a,n),h=Sb.angleRotate(r,o,Sb.toRadians(e));isNaN(h)||r===h||(i.SetAngle(h),i.SetBboxChanged())},yb.SetTowardPosition=function(e,t){const s=rb(this),i=s.GetAngle(),r=e-s.GetX(),n=t-s.GetY(),a=Math.atan2(n,r);isNaN(a)||i===a||(s.SetAngle(a),s.SetBboxChanged())},Ib.GetAngle=function(){return Sb.toDegrees(this.GetWorldInfo().GetAngle())},Tb.GetAngle=function(){return this.angleDegrees},yb.CompareOpacity=function(e,t){return Sb.compare(Sb.roundToDp(100*rb(this).GetOpacity(),6),e,t)},Ib.IsVisible=function(){return this.GetWorldInfo().IsVisible()},Tb.IsVisible=function(){return this.isVisible},yb.SetVisible=function(e){const t=rb(this);e=2===e?!t.IsVisible():0!==e,t.IsVisible()!==e&&(t.SetVisible(e),Cb.UpdateRender())},yb.SetOpacity=function(e){const t=Sb.clamp(e/100,0,1),s=rb(this);if(s.GetTransformWithParentOpacity()){if(s._GetSceneGraphInfo().GetOwnOpacity()===t)return}else if(s.GetOpacity()===t)return;s.SetOpacity(t),Cb.UpdateRender()},yb.SetDefaultColor=function(e){Gb.setFromRgbValue(e);const t=rb(this);t.GetUnpremultipliedColor().equalsIgnoringAlpha(Gb)||(t.SetUnpremultipliedColor(Gb),Cb.UpdateRender())},yb.GetColor=function(){const e=rb(this).GetUnpremultipliedColor();return Sb.PackRGBAEx(e.getR(),e.getG(),e.getB(),e.getA())},yb.GetOpacity=function(){return Sb.roundToDp(100*rb(this).GetOpacity(),6)},yb.IsOnLayer=function(e){return!!(e=hb(e))&&rb(this).GetLayer()===e},yb.PickTopBottom=function(e){const t=ob(this).GetCurrentSol(),s=t.GetInstances();if(!s.length)return!1;let i=s[0];for(let t=1,r=s.length;t<r;++t){const r=s[t],n=r.GetWorldInfo(),a=i.GetWorldInfo(),o=n.GetLayer().GetIndex(),h=a.GetLayer().GetIndex();0===e?(o>h||o===h&&n.GetZIndex()>a.GetZIndex())&&(i=r):(o<h||o===h&&n.GetZIndex()<a.GetZIndex())&&(i=r)}return t.PickOne(i),!0},Ib.CompareZElevation=function(e,t,s){const i=this.GetWorldInfo(),r=0===e?i.GetZElevation():i.GetTotalZElevation();return Sb.compare(r,t,s)},Tb.CompareZElevation=function(e,t,s){const i=0===e?this.zElevation:this.totalZElevation;return Sb.compare(i,t,s)},Ib.MoveToTop=function(){this.GetWorldInfo().ZOrderMoveToTop()},Tb.MoveToTop=function(){this.moveToTop()},Ib.MoveToBottom=function(){this.GetWorldInfo().ZOrderMoveToBottom()},Tb.MoveToBottom=function(){this.moveToBottom()},yb.MoveToLayer=function(e){(e=hb(e))&&rb(this).ZOrderMoveToLayer(e)},yb.ZMoveToObject=function(e,t){const s=0===e;if(!(t=ob(t)))return;const i=ib(this),r=t.GetFirstPicked(i);r&&i.GetWorldInfo().ZOrderMoveAdjacentToInstance(r,s)},Ib.SetZElevation=function(e){const t=this.GetWorldInfo();t.GetZElevation()!==e&&(t.SetZElevation(e),Cb.UpdateRender())},Tb.SetZElevation=function(e){this.zElevation=e},yb.LayerNumber=function(){return rb(this).GetLayer().GetIndex()},yb.LayerName=function(){return rb(this).GetLayer().GetName()},Ib.ZIndex=function(){return this.GetWorldInfo().GetZIndex()},Tb.ZIndex=function(){return this.zIndex},Ib.ZElevation=function(){return this.GetWorldInfo().GetZElevation()},Tb.ZElevation=function(){return this.zElevation},Ib.TotalZElevation=function(){return this.GetWorldInfo().GetTotalZElevation()},Tb.TotalZElevation=function(){return this.totalZElevation},yb.IsEffectEnabled=function(e){const t=ib(this),s=t.GetObjectClass().GetEffectList().GetEffectTypeByName(e);if(!s)return;const i=s.GetIndex();return t.GetWorldInfo().GetInstanceEffectList().IsEffectIndexActive(i)},yb.SetEffectEnabled=function(e,t){const s=ib(this),i=s.GetObjectClass().GetEffectList().GetEffectTypeByName(t);if(!i)return;const r=i.GetIndex(),n=1===e,a=s.GetWorldInfo().GetInstanceEffectList();a.IsEffectIndexActive(r)!==n&&(a.SetEffectIndexActive(r,n),a.UpdateActiveEffects(),Cb.UpdateRender())},yb.SetEffectParam=function(e,t,s){const i=ib(this),r=i.GetObjectClass().GetEffectList().GetEffectTypeByName(e);if(!r)return;t=Math.floor(t);const n=r.GetShaderProgram().GetParameterType(t);if(!n)return;"color"===n?(Gb.setFromRgbValue(s),s=Gb):"percent"===n&&(s/=100);const a=r.GetIndex(),o=i.GetWorldInfo().GetInstanceEffectList();o.SetEffectParameter(a,t,s)&&o.IsEffectIndexActive(a)&&Cb.UpdateRender()};const Pb=Sb.New(Sb.Rect),Rb=[],vb=[];let Ab=!1,Mb=null,Db=!1;const Eb=new Set;function*Fb(e){if(!e)return!1;const t=this.GetRuntime(),s=t.GetCollisionEngine(),i=t.GetEventSheetManager(),r=i.GetEventStack(),n=i.GetCurrentCondition(),a=n.GetObjectClass(),o=n.GetSavedDataMap(),h=n.GetUnsavedDataMap(),l=r.GetCurrentStackFrame(),c=t.GetTickCount(),u=c-1,d=l.GetCurrentEvent(),_=r.Push(d);let p=o.get("collmemory");p||(p=Sb.New(Sb.PairMap),o.set("collmemory",p)),h.get("collisionCreatedDestroyCallback")||(h.set("collisionCreatedDestroyCallback",!0),t.Dispatcher().addEventListener("instancedestroy",e=>ub(p,e.instance)));const f=a.GetCurrentSol(),m=e.GetCurrentSol(),g=f.GetInstances();let S=null;for(let t=0;t<g.length;++t){const r=g[t];m.IsSelectAll()?(s.GetCollisionCandidates(r.GetWorldInfo().GetLayer(),e,r.GetWorldInfo().GetBoundingBox(),Rb),S=Rb,s.AddRegisteredCollisionCandidates(r,e,S)):S=m.GetInstances();for(let t=0;t<S.length;++t){const n=S[t];if(s.TestOverlap(r,n)||s.CheckRegisteredCollision(r,n)){const t=db(p,r,n);let s=!1,o=-2;"number"==typeof t&&(s=!0,o=t);const h=!s||o<u;if(lb(p,r,n,c),h){const t=d.GetSolModifiers();i.PushCopySol(t);const s=a.GetCurrentSol(),o=e.GetCurrentSol();if(s._SetSelectAll(!1),o._SetSelectAll(!1),a===e){const e=s._GetOwnInstances();Sb.clearArray(e),e.push(r),e.push(n),a.ApplySolToContainer()}else{const t=s._GetOwnInstances(),i=o._GetOwnInstances();Sb.clearArray(t),Sb.clearArray(i),t.push(r),i.push(n),a.ApplySolToContainer(),e.ApplySolToContainer()}yield*d.DebugRetrigger(l,_),i.PopSol(t)}}else cb(p,r,n)}Sb.clearArray(Rb)}return r.Pop(),!1}yb.OnCollision=function(e){const t=ob(this);e=ob(e);const s=t.GetRuntime();if(s.IsDebugging())return Fb.call(t,e);if(!e)return!1;const i=s.GetCollisionEngine(),r=s.GetEventSheetManager(),n=r.GetEventStack(),a=r.GetCurrentCondition(),o=a.GetObjectClass(),h=a.GetSavedDataMap(),l=a.GetUnsavedDataMap(),c=n.GetCurrentStackFrame(),u=s.GetTickCount(),d=u-1,_=c.GetCurrentEvent(),p=n.Push(_);let f=h.get("collmemory");f||(f=Sb.New(Sb.PairMap),h.set("collmemory",f)),l.get("collisionCreatedDestroyCallback")||(l.set("collisionCreatedDestroyCallback",!0),s.Dispatcher().addEventListener("instancedestroy",e=>ub(f,e.instance)));const m=o.GetCurrentSol(),g=e.GetCurrentSol(),S=m.GetInstances();let G=null;for(let t=0;t<S.length;++t){const s=S[t];g.IsSelectAll()?(i.GetCollisionCandidates(s.GetWorldInfo().GetLayer(),e,s.GetWorldInfo().GetBoundingBox(),Rb),G=Rb,i.AddRegisteredCollisionCandidates(s,e,G)):G=g.GetInstances();for(let t=0;t<G.length;++t){const n=G[t];if(i.TestOverlap(s,n)||i.CheckRegisteredCollision(s,n)){const t=db(f,s,n);let i=!1,a=-2;"number"==typeof t&&(i=!0,a=t);const h=!i||a<d;if(lb(f,s,n,u),h){const t=_.GetSolModifiers();r.PushCopySol(t);const i=o.GetCurrentSol(),a=e.GetCurrentSol();if(i._SetSelectAll(!1),a._SetSelectAll(!1),o===e){const e=i._GetOwnInstances();Sb.clearArray(e),e.push(s),e.push(n),o.ApplySolToContainer()}else{const t=i._GetOwnInstances(),r=a._GetOwnInstances();Sb.clearArray(t),Sb.clearArray(r),t.push(s),r.push(n),o.ApplySolToContainer(),e.ApplySolToContainer()}_.Retrigger(c,p),r.PopSol(t)}}else cb(f,s,n)}Sb.clearArray(Rb)}return n.Pop(),!1},yb.IsOverlapping=function(e){return e=ob(e),_b(ib(this),e,0,0)},yb.IsOverlappingOffset=function(e,t,s){return e=ob(e),_b(ib(this),e,t,s)},yb.OnHierarchyReady=function(){return!0},yb.HasParent=function(){return rb(this).HasParent()},yb.HasChildren=function(){return rb(this).HasChildren()},yb.PickParent=function(e,t){const s=ob(this);e=ob(e);const i=s.GetRuntime(),r=this.GetCurrentSol().GetInstances();if(0===r.length)return!1;const n=e.GetCurrentSol();let a=n.GetInstances();if(n.IsSelectAll()){const t=[...i.instancesPendingCreateForObjectClass(e)];t.length>0&&(a=a.concat(t))}if(0===a.length)return!1;const o=n.IsSelectAll()?null:new Set(a),h=new Set;for(let s=0,i=r.length;s<i;++s){const i=r[s];if(1===t)for(const t of i.parents())t.BelongsToObjectClass(e)&&(null===o||o.has(t))&&h.add(t);else{let s;if(0===t){if(s=i.GetParent(),null===s)continue}else s=i.GetTopParent();s.BelongsToObjectClass(e)&&(null===o||o.has(s))&&h.add(s)}}return 0!==h.size&&(n.SetSetPicked(h),e.ApplySolToContainer(),!0)},yb.PickChildren=function(e,t){const s=ob(this);e=ob(e);const i=s.GetRuntime(),r=s.GetCurrentSol().GetInstances();if(0===r.length)return!1;const n=e.GetCurrentSol();let a=n.GetInstances();if(n.IsSelectAll()){const t=[...i.instancesPendingCreateForObjectClass(e)];t.length>0&&(a=a.concat(t))}if(0===a.length)return!1;const o=n.IsSelectAll()?null:new Set(a),h=new Set;for(let s=0,i=r.length;s<i;++s){const i=r[s];2!==t||i.HasChildren()||!i.BelongsToObjectClass(e)||null!==o&&!o.has(i)||h.add(i);for(const s of 0===t?i.children():i.allChildren())2===t&&s.HasChildren()||s.BelongsToObjectClass(e)&&(null===o||o.has(s))&&h.add(s)}return 0!==h.size&&(n.SetSetPicked(h),e.ApplySolToContainer(),!0)},yb.PickNthChild=function(e,t,s){const i=ob(this);e=ob(e);const r=i.GetRuntime(),n=i.GetCurrentSol().GetInstances();if(0===n.length)return!1;const a=e.GetCurrentSol();let o=a.GetInstances();if(a.IsSelectAll()){const t=[...r.instancesPendingCreateForObjectClass(e)];t.length>0&&(o=o.concat(t))}if(0===o.length)return!1;const h=a.IsSelectAll()?null:new Set(o),l=[];for(let i=0,r=n.length;i<r;++i){const r=n[i];if(0===t){const t=r.GetChildAt(s);null!==t&&t.BelongsToObjectClass(e)&&(null===h||h.has(t))&&l.push(t)}else if(1===t)for(const t of r.children())if(t.BelongsToObjectClass(e)){if(0===s){(null===h||h.has(t))&&l.push(t);break}--s}}return 0!==l.length&&(a.SetArrayPicked(l),e.ApplySolToContainer(),!0)},yb.CompareChildCount=function(e,t,s){const i=ib(this);switch(e){case 0:default:return Sb.compare(i.GetChildCount(),t,s);case 1:return Sb.compare(i.GetAllChildCount(),t,s)}},yb.AddChild=function(e,t,s,i,r,n,a,o,h,l){e=ob(e);const c=ib(this),u=Cb.GetCurrentAction().GetObjectClass();for(const d of e.allCorrespondingInstances(c,u)){if(!d.GetPlugin().SupportsSceneGraph())return;c.AddChild(d,{transformX:t,transformY:s,transformWidth:i,transformHeight:r,transformAngle:n,transformOpacity:a,transformZElevation:o,transformVisibility:h,destroyWithParent:l})}},yb.RemoveChild=function(e){e=ob(e);const t=ib(this),s=Cb.GetCurrentAction().GetObjectClass();for(const i of e.allCorrespondingInstances(t,s))t.RemoveChild(i)},yb.RemoveFromParent=function(){const e=ib(this);e.HasParent()&&e.GetParent().RemoveChild(e)},yb.ParentUID=function(){const e=ib(this).GetParent();return e?e.GetUID():-1},yb.ChildCount=function(){return ib(this).GetChildCount()},yb.AllChildCount=function(){return ib(this).GetAllChildCount()},yb.SetMeshSize=function(e,t){e=Math.floor(e),t=Math.floor(t);const s=rb(this);e<2||t<2||!isFinite(e)||!isFinite(t)?(s.ReleaseMesh(),s.SetBboxChanged()):s.CreateMesh(e,t)},yb.SetMeshPoint=function(e,t,s,i,r,n,a,o){const h=rb(this);h.SetMeshPoint(e,t,{mode:0===s?"absolute":"relative",x:i,y:r,zElevation:n,u:a,v:o})&&h.SetBboxChanged()},yb.MeshColumns=function(){const e=rb(this);return e.HasMesh()?e.GetSourceMesh().GetHSize():0},yb.MeshRows=function(){const e=rb(this);return e.HasMesh()?e.GetSourceMesh().GetVSize():0},yb.SetElementVisible=function(e){const t=rb(this);e=2===e?!t.IsVisible():0!==e,t.IsVisible()!==e&&t.SetVisible(e)},yb.SetElementCSSStyle=function(e,t){this instanceof self.IInstance?this.setElementCSSStyle(e,t):this.SetElementCSSStyle(e,t)},yb.SetElementAttribute=function(e,t){this instanceof self.IInstance?this.setElementAttribute(e,""+t):this.SetElementAttribute(e,""+t)},yb.RemoveElementAttribute=function(e){this instanceof self.IInstance?this.removeElementAttribute(e):this.RemoveElementAttribute(e)},yb.SetElementFocus=function(){this instanceof self.IInstance?this.focusElement():this.FocusElement()},yb.SetElementBlur=function(){this instanceof self.IInstance?this.blurElement():this.BlurElement()},yb.IsElementFocused=function(){return this instanceof self.IInstance?this.isElementFocused():this.IsElementFocused()},yb.SetElementEnabled=function(e){this instanceof self.IInstance?this._setEnabled(0!==e):this._SetEnabled(0!==e)},yb.IsElementEnabled=function(){return this instanceof self.IInstance?this._isEnabled():this._IsEnabled()},Ib.CompareInstanceVar=function(e,t,s){return Sb.compare(this.GetInstance().GetInstanceVariableValue(e),t,s)},Tb.CompareInstanceVar=function(e,t,s){return Sb.compare(nb(this).GetInstanceVariableValue(e),t,s)},Ib.IsBoolInstanceVarSet=function(e){return!!this.GetInstance().GetInstanceVariableValue(e)},Tb.IsBoolInstanceVarSet=function(e){return!!nb(this).GetInstanceVariableValue(e)},yb.PickInstVarHiLow=function(e,t,s){const i=ob(this),r=i.GetCurrentSol(),n=r.GetInstances();if(0===n.length)return!1;const a=i.IsFamily(),o=[];let h=0;for(let r=0,l=n.length;r<l;++r){const l=n[r],c=a?l.GetObjectClass().GetFamilyInstanceVariableOffset(i.GetFamilyIndex()):0,u=l.GetInstanceVariableValue(c+t);0===o.length||0===e&&u<h||1===e&&u>h?(h=u,Sb.clearArray(o),o.push(l)):s&&u===h&&o.push(l)}return s?r.SetArrayPicked(o):r.PickOne(o[0]),!0},yb.PickByUID=function(e){const t=ob(this);return t.GetRuntime().GetCurrentCondition().IsInverted()?gb(t,e):mb(t,e)},yb.HasTags=function(e){const t=ib(this);return e.includes(" ")?new Set(Sb.splitStringAndNormalize(e.toLowerCase())).isSubsetOf(t.GetLowercaseTagsSet()):!e||t.HasTag(e)},yb.Tags=function(){return ib(this).GetTagsString()},yb.TagsCount=function(){return ib(this).GetTagsSet().size},yb.TagAt=function(e){return ib(this).GetTagAt(e)},yb.ChangeTags=function(e,t){const s=Sb.splitStringAndNormalize(t),i=ib(this);if(2===e)return void i.SetTagsSet(new Set(s));if(0===s.length)return;const r=new Set(i.GetTagsSet());if(0===e)for(const e of s)r.add(e);else if(1===e)for(const e of s)if(!r.delete(e)){const t=e.toLowerCase();for(const e of r)if(e.toLowerCase()===t){r.delete(e);break}}i.SetTagsSet(r)},yb.Destroy=function(){Cb.DestroyInstance(ib(this))},yb.OnCreated=function(){return!0},yb.OnDestroyed=function(){return!0},Ib.SetInstanceVar=function(e,t){this.GetInstance().SetInstanceVariableValue(e,t)},Tb.SetInstanceVar=function(e,t){nb(this).SetInstanceVariableValue(e,t)},Ib.AddInstanceVar=function(e,t){const s=this.GetInstance(),i=s.GetInstanceVariableValue(e);"number"==typeof i&&"number"!=typeof t?t=parseFloat(t):"string"==typeof i&&"string"!=typeof t&&(t=t.toString()),s.SetInstanceVariableValue(e,i+t)},Tb.AddInstanceVar=function(e,t){const s=nb(this),i=s.GetInstanceVariableValue(e);"number"==typeof i&&"number"!=typeof t?t=parseFloat(t):"string"==typeof i&&"string"!=typeof t&&(t=t.toString()),s.SetInstanceVariableValue(e,i+t)},Ib.SubInstanceVar=function(e,t){const s=this.GetInstance(),i=s.GetInstanceVariableValue(e);"number"==typeof i&&("number"!=typeof t&&(t=parseFloat(t)),s.SetInstanceVariableValue(e,i-t))},Tb.SubInstanceVar=function(e,t){const s=nb(this),i=s.GetInstanceVariableValue(e);"number"==typeof i&&("number"!=typeof t&&(t=parseFloat(t)),s.SetInstanceVariableValue(e,i-t))},Ib.SetBoolInstanceVar=function(e,t){this.GetInstance().SetInstanceVariableValue(e,t?1:0)},Tb.SetBoolInstanceVar=function(e,t){nb(this).SetInstanceVariableValue(e,t?1:0)},Ib.ToggleBoolInstanceVar=function(e){const t=this.GetInstance();t.SetInstanceVariableValue(e,0===t.GetInstanceVariableValue(e)?1:0)},Tb.ToggleBoolInstanceVar=function(e){const t=nb(this);t.SetInstanceVariableValue(e,0===t.GetInstanceVariableValue(e)?1:0)},yb.LoadFromJsonString=function(e){let t;try{t=JSON.parse(e)}catch(e){return void console.error("Failed to load from JSON string: ",e)}const s=ib(this),i="state";Cb.ClearIntancesNeedingAfterLoad(),s._OnBeforeLoad(i),s.LoadFromJson(t,i),Cb.DoAfterLoad(i,{setFromJson:!0})},yb.AsJSON=function(){return JSON.stringify(ib(this).SaveToJson("state"))},yb.ObjectTypeName=function(){return ib(this).GetObjectClass().GetName()},yb.Count=function(){const e=Cb.GetCurrentEventStackFrame().GetExpressionObjectClass();let t=e.GetInstanceCount();for(const s of Cb.instancesPendingCreateForObjectClass(e))++t;return t},yb.PickedCount=function(){return Cb.GetCurrentEventStackFrame().GetExpressionObjectClass().GetCurrentSol().GetInstances().length},Ib.GetIID=function(){return this.GetInstance().GetIID()},Tb.GetIID=function(){return nb(this).GetIID()},Ib.GetUID=function(){return this.GetInstance().GetUID()},Tb.GetUID=function(){return nb(this).GetUID()},yb.OnInstanceSignal=function(e){const t=ib(this);return e.toLowerCase()===Cb.GetEventSheetManager().GetCurrentInstanceSignalTag(t)},yb.InstanceSignal=function(e){const t=ib(this);Cb.GetEventSheetManager().InstanceSignal(t,e)},yb.InstanceWaitForSignal=function(e){const t=ob(this);return Cb.GetEventSheetManager().AddScheduledWait().InitInstanceSignals(t.GetCurrentSol().GetInstances(),e),!0},yb.TemplateName=function(){return ib(this).GetTemplateName()},Sb.AddCommonACEs=function(e,t,s){const i=e[1],r=e[3],n=e[4],a=e[5],o=e[6],h=e[7],l=e[8],c=e[10],u=e[11],d=e[12],_=e[13],p=e[14],f=e[15],m=e[16],g=t.Cnds,S=t.Acts,G=t.Exps,y=Object.assign({},yb,s>=2?Tb:Ib);r&&(g.CompareX=y.CompareX,g.CompareY=y.CompareY,g.IsOnScreen=y.IsOnScreen,g.IsOutsideLayout=y.IsOutsideLayout,g.PickDistance=y.PickDistance,S.SetX=y.SetX,S.SetY=y.SetY,S.SetPos=y.SetPos,S.SetPosToObject=y.SetPosToObject,S.MoveForward=y.MoveForward,S.MoveAtAngle=y.MoveAtAngle,G.X=y.GetX,G.Y=y.GetY,G.dt=y.GetDt),n&&(g.CompareWidth=y.CompareWidth,g.CompareHeight=y.CompareHeight,S.SetWidth=y.SetWidth,S.SetHeight=y.SetHeight,S.SetSize=y.SetSize,G.Width=y.GetWidth,G.Height=y.GetHeight,G.BBoxLeft=y.GetBboxLeft,G.BBoxTop=y.GetBboxTop,G.BBoxRight=y.GetBboxRight,G.BBoxBottom=y.GetBboxBottom,G.BBoxMidX=y.GetBboxMidX,G.BBoxMidY=y.GetBboxMidY),a&&(g.AngleWithin=y.IsAngleWithin,g.IsClockwiseFrom=y.IsAngleClockwiseFrom,g.IsBetweenAngles=y.IsBetweenAngles,S.SetAngle=y.SetAngle,S.RotateClockwise=y.RotateClockwise,S.RotateCounterclockwise=y.RotateCounterclockwise,S.RotateTowardAngle=y.RotateTowardAngle,S.RotateTowardPosition=y.RotateTowardPosition,S.SetTowardPosition=y.SetTowardPosition,G.Angle=y.GetAngle),o&&(g.IsVisible=y.IsVisible,g.CompareOpacity=y.CompareOpacity,S.SetVisible=y.SetVisible,S.SetOpacity=y.SetOpacity,S.SetDefaultColor=y.SetDefaultColor,G.Opacity=y.GetOpacity,G.ColorValue=y.GetColor),h&&(g.IsOnLayer=y.IsOnLayer,g.PickTopBottom=y.PickTopBottom,g.CompareZElevation=y.CompareZElevation,S.MoveToTop=y.MoveToTop,S.MoveToBottom=y.MoveToBottom,S.MoveToLayer=y.MoveToLayer,S.ZMoveToObject=y.ZMoveToObject,S.SetZElevation=y.SetZElevation,G.LayerNumber=y.LayerNumber,G.LayerName=y.LayerName,G.ZIndex=y.ZIndex,G.ZElevation=y.ZElevation,G.TotalZElevation=y.TotalZElevation),l&&(g.IsEffectEnabled=y.IsEffectEnabled,S.SetEffectEnabled=y.SetEffectEnabled,S.SetEffectParam=y.SetEffectParam),_&&(g.OnHierarchyReady=y.OnHierarchyReady,g.HasParent=y.HasParent,g.HasChildren=y.HasChildren,g.PickParent=y.PickParent,g.PickChildren=y.PickChildren,g.PickNthChild=y.PickNthChild,g.CompareChildCount=y.CompareChildCount,S.AddChild=y.AddChild,S.RemoveChild=y.RemoveChild,S.RemoveFromParent=y.RemoveFromParent,G.ParentUID=y.ParentUID,G.ChildCount=y.ChildCount,G.AllChildCount=y.AllChildCount),p&&(S.SetMeshSize=y.SetMeshSize,S.SetMeshPoint=y.SetMeshPoint,G.MeshColumns=y.MeshColumns,G.MeshRows=y.MeshRows),c&&(g.IsVisible=y.IsVisible,S.SetVisible=y.SetElementVisible,S.SetCSSStyle=y.SetElementCSSStyle,S.SetElemAttribute=y.SetElementAttribute,S.RemoveElemAttribute=y.RemoveElementAttribute),u&&(g.IsFocused=y.IsElementFocused,S.SetFocus=y.SetElementFocus,S.SetBlur=y.SetElementBlur),d&&(g.IsEnabled=y.IsElementEnabled,S.SetEnabled=y.SetElementEnabled),f&&(g.OnCollision=y.OnCollision,g.IsOverlapping=y.IsOverlapping,g.IsOverlappingOffset=y.IsOverlappingOffset,t.FinishCollisionCondition=fb),i||(g.CompareInstanceVar=y.CompareInstanceVar,g.IsBoolInstanceVarSet=y.IsBoolInstanceVarSet,g.PickInstVarHiLow=y.PickInstVarHiLow,g.PickByUID=y.PickByUID,g.HasTags=y.HasTags,S.SetInstanceVar=y.SetInstanceVar,S.AddInstanceVar=y.AddInstanceVar,S.SubInstanceVar=y.SubInstanceVar,S.SetBoolInstanceVar=y.SetBoolInstanceVar,S.ToggleBoolInstanceVar=y.ToggleBoolInstanceVar,S.ChangeTags=y.ChangeTags,g.OnCreated=y.OnCreated,g.OnDestroyed=y.OnDestroyed,S.Destroy=y.Destroy,S.LoadFromJsonString||(S.LoadFromJsonString=y.LoadFromJsonString),G.AsJSON||(G.AsJSON=y.AsJSON),G.Count=y.Count,G.PickedCount=y.PickedCount,G.IID=y.GetIID,G.UID=y.GetUID,G.ObjectTypeName=y.ObjectTypeName,G.Tags=y.Tags,G.TagsCount=y.TagsCount,G.TagAt=y.TagAt,g.OnInstanceSignal=y.OnInstanceSignal,S.InstanceSignal=y.InstanceSignal,S.InstanceWaitForSignal=y.InstanceWaitForSignal),m&&(G.TemplateName=y.TemplateName)}}{const Ob=self.C3;Ob.ScheduledWait=class extends Ob.DefendedBase{constructor(e){super(),this._eventSheetManager=e,this._type="",this._time=-1,this._signalTag="",this._isSignalled=!1,this._event=null,this._actIndex=0,this._solModifiers=[],this._dynamicSolModifiers=null,this._sols=new Map,this._pendingInstances=null,this._callingFunctionBlock=null,this._asyncId=-1,this._functionParameters=null,this._functionInnerLocalVars=null,this._shouldRelease=!1}Release(){this._type="",this._time=-1,this._signalTag="",this._event=null,this._callingFunctionBlock=null,this._functionParameters=null,this._functionInnerLocalVars=null,this._asyncId=-1,Ob.clearArray(this._solModifiers),this._dynamicSolModifiers&&(this._dynamicSolModifiers.clear(),this._dynamicSolModifiers=null);for(const e of this._sols.values())e.Release();this._sols.clear(),this._pendingInstances=null}_Init(){const e=this._eventSheetManager,t=e.GetRuntime().GetAllObjectClasses(),s=e.GetCurrentEventStackFrame();this._event=s.GetCurrentEvent(),this._actIndex=s.GetActionIndex()+1;const i=e.FindFirstFunctionBlockParent(this._event);i&&(this._callingFunctionBlock=i,this._functionParameters=i.CaptureFunctionParameters(),this._functionInnerLocalVars=i._GetAllInnerLocalVariables().map(e=>e.GetValue()),i.IsAsync()&&(this._asyncId=i.PauseCurrentAsyncFunction()));for(const e of t){const t=e.GetCurrentSol();t.IsSelectAll()&&!this._event.HasSolModifier(e)||(this._solModifiers.push(e),this._sols.set(e,Ob.New(Ob.SolState,t)))}const r=e.GetDynamicSolModifiersSet();this._dynamicSolModifiers=r.size>0?r:null}InitTimer(e){this._type="timer",this._Init(),this._time=this._eventSheetManager.GetRuntime().GetGameTime()+e}InitWallTimer(e){this._type="walltimer",this._Init(),this._time=this._eventSheetManager.GetRuntime().GetWallTime()+e}InitSignal(e){this._type="signal",this._Init(),this._signalTag=e.toLowerCase()}InitInstanceSignals(e,t){this._type="instance-signals",this._Init(),this._signalTag=t.toLowerCase(),this._pendingInstances=new Set(e)}InitPromise(e){this._type="promise",this._Init(),e.then(()=>this.SetSignalled()).catch(e=>{console.warn("[C3 runtime] Promise rejected in 'Wait for previous actions to complete': ",e),this.SetSignalled()})}IsTimer(){return"timer"===this._type}IsWallTimer(){return"walltimer"===this._type}IsSignal(){return"signal"===this._type}IsInstanceSignals(){return"instance-signals"===this._type}IsPromise(){return"promise"===this._type}GetSignalTag(){return this._signalTag}IsSignalled(){return this._isSignalled}SetSignalled(){this._isSignalled=!0}SetInstanceSignalled(e){this._pendingInstances.delete(e),0===this._pendingInstances.size&&this.SetSignalled()}_ShouldRun(){return this.IsTimer()?this._time<=this._eventSheetManager.GetRuntime().GetGameTime():this.IsWallTimer()?this._time<=this._eventSheetManager.GetRuntime().GetWallTime():this.IsSignalled()}_RestoreState(e){e._Restore(this._event,this._actIndex);for(const[e,t]of this._sols.entries()){const s=e.GetCurrentSol();t._Restore(s)}this._dynamicSolModifiers&&e.SetDynamicSolModifiers([...this._dynamicSolModifiers]);const t=this._callingFunctionBlock;t&&(t.SetFunctionParameters(this._functionParameters),t._GetAllInnerLocalVariables().map((e,t)=>e.SetValue(this._functionInnerLocalVars[t])),t.IsAsync()&&t.ResumeAsyncFunction(this._asyncId))}_Run(e){this._RestoreState(e),this._event._ResumeActionsAndSubEvents(e),this._callingFunctionBlock&&this._callingFunctionBlock.IsAsync()&&this._callingFunctionBlock.MaybeFinishAsyncFunctionCall(this._asyncId),this._eventSheetManager.ClearSol(this._solModifiers),this._shouldRelease=!0}async _DebugRun(e){this._RestoreState(e);for(const t of this._event._DebugResumeActionsAndSubEvents(e))await this._eventSheetManager.GetRuntime().DebugBreak(t);this._callingFunctionBlock&&this._callingFunctionBlock.IsAsync()&&this._callingFunctionBlock.MaybeFinishAsyncFunctionCall(this._asyncId),this._eventSheetManager.ClearSol(this._solModifiers),this._shouldRelease=!0}ShouldRelease(){return this._shouldRelease}RemoveInstances(e){for(const t of this._sols.values())t.RemoveInstances(e);if("instance-signals"===this._type){for(const t of e)this._pendingInstances.delete(t);0===this._pendingInstances.size&&this.SetSignalled()}}_SaveToJson(){const e={},t={wt:this._type,t:this._time,st:this._signalTag,s:this._isSignalled,ev:this._event.GetSID(),sm:this._solModifiers.map(e=>e.GetSID()),dsm:this._dynamicSolModifiers?[...this._dynamicSolModifiers].map(e=>e.GetSID()):null,sols:e};this._event._HasActionIndex(this._actIndex)&&(t.act=this._event.GetActionAt(this._actIndex).GetSID());for(const[t,s]of this._sols)e[t.GetSID().toString()]=s._SaveToJson();return"instance-signals"===this._type&&(t.pi=[...this._pendingInstances].map(e=>e.GetUID())),t}static _CreateFromJson(e,t){const s=e.GetRuntime(),i=e.GetEventBlockBySID(t.ev);if(!i)return null;let r=0;if(t.hasOwnProperty("act")){const s=e.GetActionBySID(t.act);if(!s)return null;r=s.GetIndex()}const n=Ob.New(Ob.ScheduledWait,e);n._time=t.t,t.hasOwnProperty("wt")?n._type=t.wt:n._type=-1===n._time?"signal":"timer",n._signalTag=t.st,n._isSignalled=t.s,n._event=i,n._actIndex=r;for(const e of t.sm){const t=s.GetObjectClassBySID(e);t&&n._solModifiers.push(t)}if(Array.isArray(t.dsm))for(const e of t.dsm){const t=s.GetObjectClassBySID(e);t&&(n._dynamicSolModifiers||(n._dynamicSolModifiers=new Set),n._dynamicSolModifiers.add(t))}for(const[i,r]of Object.entries(t.sols)){const t=parseInt(i,10),a=s.GetObjectClassBySID(t);if(!a)continue;const o=Ob.New(Ob.SolState,null);o._LoadFromJson(e,r),n._sols.set(a,o)}if("instance-signals"===n._type){n._pendingInstances=new Set;for(const e of t.pi){const t=s.GetInstanceByUID(e);t&&n._pendingInstances.add(t)}}return n}}}{const Bb=self.C3;Bb.SolState=class extends Bb.DefendedBase{constructor(e){super(),this._objectClass=null,this._isSelectAll=!0,this._instances=[],e&&(this._objectClass=e.GetObjectClass(),this._isSelectAll=e.IsSelectAll(),Bb.shallowAssignArray(this._instances,e._GetOwnInstances()))}Release(){this._objectClass=null,Bb.clearArray(this._instances)}_Restore(e){e._SetSelectAll(this._isSelectAll),Bb.shallowAssignArray(e._GetOwnInstances(),this._instances)}RemoveInstances(e){Bb.arrayRemoveAllInSet(this._instances,e)}_SaveToJson(){return{sa:this._isSelectAll,insts:this._instances.map(e=>e.GetUID())}}_LoadFromJson(e,t){const s=e.GetRuntime();this._isSelectAll=!!t.sa,Bb.clearArray(this._instances);for(const e of t.insts){const t=s.GetInstanceByUID(e);t&&this._instances.push(t)}}}}{let kb=function(e,t){let s=e.get(t);return s||(s=new Map,e.set(t,s)),s};GetNextParamMap=kb;const Lb=self.C3;Lb.SDKPluginBase=class extends Lb.DefendedBase{constructor(e){super(),this._runtime=e.runtime,this._id=e.id,this._name=e.name??"",this._isSingleGlobal=!!e.isSingleGlobal,this._isWorldType=!!e.isWorld,this._isRotatable=!!e.isRotatable,this._mustPredraw=!!e.mustPredraw,this._hasEffects=!!e.hasEffects,this._supportsSceneGraph=!!e.supportsSceneGraph,this._supportsMesh=!!e.supportsMesh,this._isHTMLElementType=!!e.isHTMLElementType,this._is3d=!!e.is3d,this._sdkVersion=e.sdkVersion,this._exportData=e.exportData,this._singleGlobalObjectClass=null,this._boundACEMethodCache=new Map,this._boundACEMethodCache_1param=new Map,this._boundACEMethodCache_2params=new Map,this._boundACEMethodCache_3params=new Map,this._scriptInterfaceClass=e.scriptInterfaceClass,this._iPlugin=null}Release(){this._runtime=null}GetRuntime(){return this._runtime}GetID(){return this._id}GetName(){return this._name}OnCreate(){}GetConstructor(){return this.GetSdkVersion()>=2?this._iPlugin.constructor:this.constructor}GetSdkVersion(){return this._sdkVersion}GetScriptInterfaceClass(e=!1){let t=this._scriptInterfaceClass;return e&&"function"!=typeof t&&this.GetSdkVersion()>=2&&(t=globalThis.ISDKPluginBase),t}GetExportData(){return this._exportData}IsSingleGlobal(){return this._isSingleGlobal}IsWorldType(){return this._isWorldType}IsHTMLElementType(){return this._isHTMLElementType}Is3D(){return this._is3d}IsRotatable(){return this._isRotatable}MustPreDraw(){return this._mustPredraw}HasEffects(){return this._hasEffects}SupportsSceneGraph(){return this._supportsSceneGraph}SupportsMesh(){return this._supportsMesh}_GetBoundACEMethod(e,t){if(!t)throw new Error("missing 'this' binding");let s=this._boundACEMethodCache.get(e);return s||(s=e.bind(t),this._boundACEMethodCache.set(e,s),s)}_GetBoundACEMethod_1param(e,t,s){if(!t)throw new Error("missing 'this' binding");const i=kb(this._boundACEMethodCache_1param,e);let r=i.get(s);return r||(r=e.bind(t,s),i.set(s,r),r)}_GetBoundACEMethod_2params(e,t,s,i){if(!t)throw new Error("missing 'this' binding");const r=kb(this._boundACEMethodCache_2params,e),n=kb(r,s);let a=n.get(i);return a||(a=e.bind(t,s,i),n.set(i,a),a)}_GetBoundACEMethod_3params(e,t,s,i,r){if(!t)throw new Error("missing 'this' binding");const n=kb(this._boundACEMethodCache_3params,e),a=kb(n,s),o=kb(a,i);let h=o.get(r);return h||(h=e.bind(t,s,i,r),o.set(r,h),h)}_SetSingleGlobalObjectClass(e){if(!this.IsSingleGlobal())throw new Error("must be single-global plugin");this._singleGlobalObjectClass=e}GetSingleGlobalObjectClass(){if(!this.IsSingleGlobal())throw new Error("must be single-global plugin");return this._singleGlobalObjectClass}GetSingleGlobalInstance(){if(!this.IsSingleGlobal())throw new Error("must be single-global plugin");return this._singleGlobalObjectClass.GetSingleGlobalInstance()}_InitScriptInterface(){const e=this.GetSdkVersion();Lb.AddonManager._PushInitObject(this,e);const t=this.GetScriptInterfaceClass(!0);if(t){if(this._iPlugin=new t,!(this._iPlugin instanceof self.IPlugin))throw new TypeError("plugin class must derive from IPlugin")}else this._iPlugin=new self.IPlugin;Lb.AddonManager._PopInitObject(e)}GetIPlugin(){return this._iPlugin}}}{const Nb=self.C3;Nb.SDKDOMPluginBase=class extends Nb.SDKPluginBase{constructor(e,t){super(e),this._domComponentId=t,this._nextElementId=0,this._instMap=new Map,this.AddElementMessageHandler("elem-focused",e=>e._OnElemFocused()),this.AddElementMessageHandler("elem-blurred",e=>{e&&e._OnElemBlurred()})}Release(){super.Release()}_AddElement(e){const t=this._nextElementId++;return this._instMap.set(t,e),t}_RemoveElement(e){this._instMap.delete(e)}AddElementMessageHandler(e,t){this._runtime.AddDOMComponentMessageHandler(this._domComponentId,e,e=>{const s=this._instMap.get(e.elementId);t(s,e)})}}}{const Wb=self.C3;Wb.SDKTypeBase=class extends Wb.DefendedBase{constructor(e){super(),this._objectClass=e,this._runtime=e.GetRuntime(),this._plugin=e.GetPlugin()}Release(){this._objectClass=null,this._runtime=null,this._plugin=null}GetObjectClass(){return this._objectClass}GetRuntime(){return this._runtime}GetPlugin(){return this._plugin}GetImageInfo(){return this._objectClass.GetImageInfo()}OnCreate(){}FinishCondition(e){}BeforeRunAction(e){}AfterRunAction(e){}LoadTextures(e){}ReleaseTextures(){}OnDynamicTextureLoadComplete(){}PreloadTexturesWithInstances(e){}LoadTilemapData(){}GetScriptInterfaceClass(){return null}DispatchScriptEvent(e,t,s){const i=Wb.New(Wb.Event,e,t);i.objectClass=this,s&&Object.assign(i,s),this.GetObjectClass().DispatchUserScriptEvent(i)}}}{const Ub=self.C3;Ub.SDKInstanceBase=class extends Ub.DefendedBase{constructor(e,t){super(),this._inst=e,this._domComponentId=t,this._wrapperComponentId=null,this._runtime=e.GetRuntime(),this._objectClass=this._inst.GetObjectClass(),this._sdkType=this._objectClass.GetSdkType(),this._tickFunc=null,this._tick2Func=null,this._isTicking=!1,this._isTicking2=!1,this._disposables=null,this._wasReleased=!1}Release(){this._wasReleased=!0,this._StopTicking(),this._StopTicking2(),this._tickFunc=null,this._tick2Func=null,this._disposables&&(this._disposables.Release(),this._disposables=null),this._inst=null,this._runtime=null,this._objectClass=null,this._sdkType=null}WasReleased(){return this._wasReleased}GetInstance(){return this._inst}GetRuntime(){return this._runtime}GetObjectClass(){return this._objectClass}GetPlugin(){return this._sdkType.GetPlugin()}GetSdkType(){return this._sdkType}GetScriptInterface(){return this._inst.GetInterfaceClass()}Trigger(e){return this._runtime.Trigger(e,this._inst,null)}DebugTrigger(e){return this._runtime.DebugTrigger(e,this._inst,null)}TriggerAsync(e){return this._runtime.TriggerAsync(e,this._inst,null)}FastTrigger(e,t){return this._runtime.FastTrigger(e,this._inst,t)}DebugFastTrigger(e,t){return this._runtime.DebugFastTrigger(e,this._inst,t)}ScheduleTriggers(e){return this._runtime.ScheduleTriggers(e)}AddDOMMessageHandler(e,t){this._runtime.AddDOMComponentMessageHandler(this._domComponentId,e,t)}AddDOMMessageHandlers(e){for(const[t,s]of e)this.AddDOMMessageHandler(t,s)}PostToDOM(e,t){this._runtime.PostComponentMessageToDOM(this._domComponentId,e,t)}PostToDOMAsync(e,t){return this._runtime.PostComponentMessageToDOMAsync(this._domComponentId,e,t)}_PostToDOMMaybeSync(e,t){if(!this._runtime.IsInWorker())return window.c3_runtimeInterface._OnMessageFromRuntime({type:"event",component:this._domComponentId,handler:e,data:t,responseId:null});this.PostToDOM(e,t)}SetWrapperExtensionComponentId(e){if(!e)throw new Error("cannot set empty component id");this._wrapperComponentId=e}IsWrapperExtensionAvailable(){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");return this._runtime.HasWrapperComponentId(this._wrapperComponentId)}AddWrapperExtensionMessageHandler(e,t){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");this._runtime.AddWrapperExtensionMessageHandler(this._wrapperComponentId,e,t)}AddWrapperExtensionMessageHandlers(e){for(const[t,s]of e)this.AddWrapperExtensionMessageHandler(t,s)}SendWrapperExtensionMessage(e,t){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");this._runtime.SendWrapperExtensionMessage(this._wrapperComponentId,e,t)}SendWrapperExtensionMessageAsync(e,t){if(!this._wrapperComponentId)throw new Error("wrapper extension component id not set");return this._runtime.SendWrapperExtensionMessageAsync(this._wrapperComponentId,e,t)}Tick(){}Tick2(){}_StartTicking(){if(!this._isTicking){if(!this._tickFunc)if(this._runtime.IsDebug()){const e=globalThis.C3Debugger,t=this.GetPlugin();this._tickFunc=()=>{const s=performance.now();this.Tick(),e.AddIndividualPluginTickTime(t,performance.now()-s)}}else this._tickFunc=()=>this.Tick();this._runtime.Dispatcher().addEventListener("tick",this._tickFunc),this._isTicking=!0}}_StopTicking(){this._isTicking&&(this._runtime.Dispatcher().removeEventListener("tick",this._tickFunc),this._isTicking=!1)}IsTicking(){return this._isTicking}_StartTicking2(){if(!this._isTicking2){if(!this._tick2Func)if(this._runtime.IsDebug()){const e=globalThis.C3Debugger,t=this.GetPlugin();this._tick2Func=()=>{const s=performance.now();this.Tick2(),e.AddIndividualPluginTickTime(t,performance.now()-s)}}else this._tick2Func=()=>this.Tick2();this._runtime.Dispatcher().addEventListener("tick2",this._tick2Func),this._isTicking2=!0}}_StopTicking2(){this._isTicking2&&(this._runtime.Dispatcher().removeEventListener("tick2",this._tick2Func),this._isTicking2=!1)}IsTicking2(){return this._isTicking2}GetDebuggerProperties(){return[]}SaveToJson(){return null}LoadFromJson(e){}GetPropertyValueByIndex(e){}SetPropertyValueByIndex(e,t){}OffsetPropertyValueByIndex(e,t,s){if(0===t)return;const i=this.GetPropertyValueByIndex(e);if("number"!=typeof i)throw new Error("expected number");this.SetPropertyValueByIndex(e,i+t,s)}SetPropertyColorOffsetValueByIndex(e,t,s,i){}CallAction(e,...t){e.call(this,...t)}CallExpression(e,...t){return e.call(this,...t)}GetScriptInterfaceClass(){return null}DispatchScriptEvent(e,t,s){if(!this._inst.HasScriptInterface())return;const i=this.GetScriptInterface(),r=Ub.New(Ub.Event,e,t);r.instance=i,s&&Object.assign(r,s),i.dispatchEvent(r)}MustPreDraw(){return!1}}}{const Vb=self.C3;Vb.SDKWorldInstanceBase=class extends Vb.SDKInstanceBase{constructor(e,t){super(e,t),this._worldInfo=e.GetWorldInfo(),this._renderercontextlost_handler=null,this._renderercontextrestored_handler=null}Release(){if(this._renderercontextlost_handler){const e=this._runtime.Dispatcher();e.removeEventListener("renderercontextlost",this._renderercontextlost_handler),e.removeEventListener("renderercontextrestored",this._renderercontextrestored_handler),this._renderercontextlost_handler=null,this._renderercontextrestored_handler=null}this._worldInfo=null,super.Release()}HandleWebGLContextLoss(){this.HandleRendererContextLoss()}OnWebGLContextLost(){}OnWebGLContextRestored(){}HandleRendererContextLoss(){if(this._renderercontextlost_handler)return;this._renderercontextlost_handler=()=>this.OnRendererContextLost(),this._renderercontextrestored_handler=()=>this.OnRendererContextRestored();const e=this._runtime.Dispatcher();e.addEventListener("renderercontextlost",this._renderercontextlost_handler),e.addEventListener("renderercontextrestored",this._renderercontextrestored_handler)}OnRendererContextLost(){this.OnWebGLContextLost()}OnRendererContextRestored(){this.OnWebGLContextRestored()}GetWorldInfo(){return this._worldInfo}IsOriginalSizeKnown(){return!1}GetOriginalWidth(){if(!this.IsOriginalSizeKnown())throw new Error("original size not known");const e=this.GetCurrentImageInfo();if(e)return e.GetWidth()}GetOriginalHeight(){if(!this.IsOriginalSizeKnown())throw new Error("original size not known");const e=this.GetCurrentImageInfo();if(e)return e.GetHeight()}GetCurrentImageInfo(){return null}GetCurrentSurfaceSize(){const e=this.GetCurrentImageInfo();if(e){const t=e.GetTexture();if(t)return[t.GetWidth(),t.GetHeight()]}return[100,100]}GetCurrentTexRect(){const e=this.GetCurrentImageInfo();return e?e.GetTexRect():null}GetCurrentTexQuad(){const e=this.GetCurrentImageInfo();return e?e.GetTexQuad():null}IsCurrentTexRotated(){const e=this.GetCurrentImageInfo();return!!e&&e.IsRotated()}GetImagePoint(e){const t=this._inst.GetWorldInfo();return[t.GetX(),t.GetY(),t.GetTotalZElevation()]}LoadTilemapData(e,t,s){}TestPointOverlapTile(e,t){}RendersToOwnZPlane(){return!0}}}{const Hb=self.C3,jb=Hb.New(Hb.Rect);Hb.SDKDOMInstanceBase=class extends Hb.SDKWorldInstanceBase{constructor(e,t){super(e,t),this._elementId=this.GetPlugin()._AddElement(this),this._isElementShowing=!0,this._elemHasFocus=!1,this._autoFontSize=!1,this._autoFontSizeOffset=-.2,this._lastRect=Hb.New(Hb.Rect,0,0,-1,-1);const s=this._runtime.GetCanvasManager();this._lastWindowWidth=s.GetLastWidth(),this._lastWindowHeight=s.GetLastHeight(),this._lastHTMLIndex=-1,this._lastHTMLZIndex=-1,this._isPendingUpdateState=!1,this._StartTicking()}Release(){this.GetPlugin()._RemoveElement(this._elementId),this.PostToDOMElement("destroy"),this._elementId=-1,super.Release()}_GetElementInDOMMode(){if(this._runtime.IsInWorker())throw new Error("not valid in worker mode");return this._PostToDOMElementMaybeSync("get-element")}PostToDOMElement(e,t){t||(t={}),t.elementId=this._elementId,this.PostToDOM(e,t)}_PostToDOMElementMaybeSync(e,t){return t||(t={}),t.elementId=this._elementId,this._PostToDOMMaybeSync(e,t)}PostToDOMElementAsync(e,t){return t||(t={}),t.elementId=this._elementId,this.PostToDOMAsync(e,t)}CreateElement(e){e||(e={});const t=this.GetWorldInfo();e.elementId=this._elementId,e.isVisible=t.IsVisible(),e.htmlIndex=t.GetLayer().GetHTMLIndex(),e.htmlZIndex=t.GetHTMLZIndex(),Object.assign(e,this.GetElementState()),this._isElementShowing=!!e.isVisible,this._PostToDOMMaybeSync("create",e),this._UpdatePosition(!0)}SetElementVisible(e){e=!!e,this._isElementShowing!==e&&(this._isElementShowing=e,this.PostToDOMElement("set-visible",{isVisible:e}))}Tick(){this._UpdatePosition(!1)}_ShouldPreserveElement(){const e=this._runtime.GetCanvasManager().GetFullscreenMode();return"Android"===Hb.Platform.OS&&("scale-inner"===e||"scale-outer"===e||"crop"===e)}_UpdatePosition(e){if(this.GetInstance().IsDestroyed())return;const t=this.GetWorldInfo(),s=t.GetLayer(),i=t.GetBoundingBox();let[r,n]=s.LayerToCanvasCss(i.getLeft(),i.getTop()),[a,o]=s.LayerToCanvasCss(i.getRight(),i.getBottom());const h=this._runtime.GetCanvasManager(),l=h.GetCssWidth(),c=h.GetCssHeight();if(!t.IsVisible()||!s.IsVisible())return void this.SetElementVisible(!1);if(!this._ShouldPreserveElement()&&(a<=0||o<=0||r>=l||n>=c))return void this.SetElementVisible(!1);jb.set(r,n,a,o);const u=h.GetLastWidth(),d=h.GetLastHeight(),_=s.GetHTMLIndex(),p=t.GetHTMLZIndex();if(!e&&jb.equals(this._lastRect)&&this._lastWindowWidth===u&&this._lastWindowHeight===d&&this._lastHTMLIndex===_&&this._lastHTMLZIndex===p)return void this.SetElementVisible(!0);this._lastRect.copy(jb),this._lastWindowWidth=u,this._lastWindowHeight=d,this._lastHTMLIndex=_,this._lastHTMLZIndex=p,this.SetElementVisible(!0);let f=null;this._autoFontSize&&(f=s.GetDisplayScale()+this._autoFontSizeOffset),this._PostToDOMElementMaybeSync("update-position",{left:Math.round(this._lastRect.getLeft()),top:Math.round(this._lastRect.getTop()),width:Math.round(this._lastRect.width()),height:Math.round(this._lastRect.height()),htmlIndex:_,htmlZIndex:p,fontSize:f})}FocusElement(){this._PostToDOMElementMaybeSync("focus",{focus:!0})}BlurElement(){this._PostToDOMElementMaybeSync("focus",{focus:!1})}_OnElemFocused(){this._elemHasFocus=!0}_OnElemBlurred(){this._elemHasFocus=!1}IsElementFocused(){return this._elemHasFocus}SetElementCSSStyle(e,t){this.PostToDOMElement("set-css-style",{prop:Hb.CSSToCamelCase(e),val:t})}SetElementAttribute(e,t){this.PostToDOMElement("set-attribute",{name:e,val:t})}RemoveElementAttribute(e){this.PostToDOMElement("remove-attribute",{name:e})}UpdateElementState(){this._isPendingUpdateState||(this._isPendingUpdateState=!0,Promise.resolve().then(()=>{this._isPendingUpdateState=!1,this.PostToDOMElement("update-state",this.GetElementState())}))}GetElementState(){}GetElementId(){return this._elementId}}}{const zb=self.C3,Xb=self.IBehavior;zb.SDKBehaviorBase=class extends zb.DefendedBase{constructor(e){super(),this._runtime=e.runtime,this._id=e.id,this._name=e.name??"",this._myObjectClasses=zb.New(zb.ArraySet),this._myInstances=zb.New(zb.ArraySet),this._sdkVersion=e.sdkVersion,this._scriptInterfaceClass=e.scriptInterfaceClass,this._iBehavior=null}Release(){this._myInstances.Release(),this._myObjectClasses.Release(),this._runtime=null}GetRuntime(){return this._runtime}GetID(){return this._id}GetName(){return this._name}OnCreate(){}GetSdkVersion(){return this._sdkVersion}GetScriptInterfaceClass(e=!1){let t=this._scriptInterfaceClass;return e&&"function"!=typeof t&&this.GetSdkVersion()>=2&&(t=globalThis.ISDKBehaviorBase),t}_AddObjectClass(e){this._myObjectClasses.Add(e)}GetObjectClasses(){return this._myObjectClasses.GetArray()}_AddInstance(e){this._myInstances.Add(e)}_RemoveInstance(e){this._myInstances.Delete(e)}GetInstances(){return this._myInstances.GetArray()}_InitScriptInterface(){const e=this.GetSdkVersion();zb.AddonManager._PushInitObject(this,e);const t=this.GetScriptInterfaceClass(!0);if(t){if(this._iBehavior=new t,!(this._iBehavior instanceof Xb))throw new TypeError("behavior class must derive from IBehavior")}else this._iBehavior=new Xb;zb.AddonManager._PopInitObject(e)}GetIBehavior(){return this._iBehavior}}}{const Yb=self.C3;Yb.SDKBehaviorTypeBase=class extends Yb.DefendedBase{constructor(e){super(),this._runtime=e.GetRuntime(),this._behaviorType=e,this._objectClass=e.GetObjectClass(),this._behavior=e.GetBehavior(),this._behavior._AddObjectClass(this._objectClass)}Release(){this._runtime=null,this._behaviorType=null,this._objectClass=null,this._behavior=null}OnCreate(){}GetBehaviorType(){return this._behaviorType}GetObjectClass(){return this._objectClass}GetRuntime(){return this._runtime}GetBehavior(){return this._behavior}}}{const qb=self.C3;qb.SDKBehaviorInstanceBase=class extends qb.DefendedBase{constructor(e,t){super(),this._behInst=e,this._domComponentId=t,this._inst=e.GetObjectInstance(),this._runtime=e.GetRuntime(),this._behaviorType=e.GetBehaviorType(),this._sdkType=this._behaviorType.GetSdkType(),this._isTicking=!1,this._isTicking2=!1,this._isPostTicking=!1,this._disposables=null}Release(){this._StopTicking(),this._StopTicking2(),this._StopPostTicking(),this._disposables&&(this._disposables.Release(),this._disposables=null),this._behInst=null,this._inst=null,this._runtime=null,this._behaviorType=null,this._sdkType=null}GetBehavior(){return this._behaviorType.GetBehavior()}GetBehaviorInstance(){return this._behInst}GetObjectInstance(){return this._inst}GetObjectClass(){return this._inst.GetObjectClass()}GetWorldInfo(){return this._inst.GetWorldInfo()}GetRuntime(){return this._runtime}GetBehaviorType(){return this._behaviorType}GetSdkType(){return this._sdkType}GetScriptInterface(){return this._behInst.GetScriptInterface()}Trigger(e){return this._runtime.Trigger(e,this._inst,this._behaviorType)}DebugTrigger(e){return this._runtime.DebugTrigger(e,this._inst,this._behaviorType)}TriggerAsync(e){return this._runtime.TriggerAsync(e,this._inst,this._behaviorType)}PostCreate(){}Tick(){}Tick2(){}PostTick(){}_StartTicking(){this._isTicking||(this._runtime._AddBehInstToTick(this),this._isTicking=!0)}_StopTicking(){this._isTicking&&(this._runtime._RemoveBehInstToTick(this),this._isTicking=!1)}IsTicking(){return this._isTicking}_StartTicking2(){this._isTicking2||(this._runtime._AddBehInstToTick2(this),this._isTicking2=!0)}_StopTicking2(){this._isTicking2&&(this._runtime._RemoveBehInstToTick2(this),this._isTicking2=!1)}IsTicking2(){return this._isTicking2}_StartPostTicking(){this._isPostTicking||(this._runtime._AddBehInstToPostTick(this),this._isPostTicking=!0)}_StopPostTicking(){this._isPostTicking&&(this._runtime._RemoveBehInstToPostTick(this),this._isPostTicking=!1)}IsPostTicking(){return this._isPostTicking}GetDebuggerProperties(){return[]}AddDOMMessageHandler(e,t){this._runtime.AddDOMComponentMessageHandler(this._domComponentId,e,t)}OnSpriteFrameChanged(e,t){}SaveToJson(){return null}LoadFromJson(e){}GetPropertyValueByIndex(e){}SetPropertyValueByIndex(e,t){}OffsetPropertyValueByIndex(e,t){if(0===t)return;const s=this.GetPropertyValueByIndex(e);if("number"!=typeof s)throw new Error("expected number");this.SetPropertyValueByIndex(e,s+t)}SetPropertyColorOffsetValueByIndex(e,t,s,i){}CallAction(e,...t){e.call(this,...t)}CallExpression(e,...t){return e.call(this,...t)}GetScriptInterfaceClass(){return null}DispatchScriptEvent(e,t,s){if(!this._behInst.HasScriptInterface())return;const i=this.GetScriptInterface(),r=qb.New(qb.Event,e,t);r.behaviorInstance=i,r.instance=i.instance,s&&Object.assign(r,s),i.dispatchEvent(r)}}}{let Kb=function(e){if(e!==Jb)throw new Error("invalid internal API token")};ValidateInternalAPIToken=Kb;const $b=self.C3;$b.Plugins={},$b.Behaviors={};const Jb=$b._GetInternalAPIToken();let Zb=[],Qb=[],ex=[],tx=null,sx=null,ix=null,rx=null;const nx=new Map,ax=new Map;$b.AddonManager=class extends $b.DefendedBase{#s=null;#e=[];#i=null;#n=[];#r=new Map;#o=null;#h=null;#t;constructor(e,t){super(),this.#s=e,this.#t=new Set(t)}CreatePlugin(e){const t=e[19],s=this.#s.GetObjectReference(e[0]);if(!s)throw new Error("missing plugin");$b.AddCommonACEs(e,s,t);const i=t>=2?$b.SDKPluginBase:s,r=$b.New(i,{runtime:this.#s,isSingleGlobal:e[1],isWorld:e[2],isRotatable:e[5],hasEffects:e[8],mustPredraw:e[9],supportsSceneGraph:e[13],supportsMesh:e[14],isHTMLElementType:e[17],is3d:e[18],sdkVersion:t,id:e[20],name:e[21],scriptInterfaceClass:t>=2?s:null,exportData:e[22]});r.OnCreate(),this.#e.push(r),nx.set(s,r)}CreateSystemPlugin(){this.#i=$b.New($b.Plugins.System,{runtime:this.#s,isSingleGlobal:!0}),this.#i.OnCreate()}CreateBehavior(e){const t=e[1],s=e[2],i=e[3],r=this.#s.GetObjectReference(e[0]);if(!r)throw new Error("missing behavior");this.#r.set(r,()=>{const e=t>=2?$b.SDKBehaviorBase:r,n=$b.New(e,{runtime:this.#s,id:s,name:i,sdkVersion:t,scriptInterfaceClass:t>=2?r:null});n.OnCreate(),this.#n.push(n),ax.set(r,n),!this.#o&&$b.Behaviors.solid&&n instanceof $b.Behaviors.solid?this.#o=n:!this.#h&&$b.Behaviors.jumpthru&&n instanceof $b.Behaviors.jumpthru&&(this.#h=n),n._InitScriptInterface()})}_DelayCreateBehavior(e){const t=this.#r.get(e);t&&(t(),this.#r.delete(e))}static _PushInitObject(e,t=1){if($b.AddonManager._PushInitObject!==tx)throw new Error("invalid method");1===t&&Zb.push(e),Qb.push(e)}static _PopInitObject(e=1){if($b.AddonManager._PopInitObject!==sx)throw new Error("invalid method");1===e&&Zb.pop(),Qb.pop()}static _GetInitObject(){if($b.AddonManager._GetInitObject!==ix)throw new Error("invalid method");if(0===Zb.length)throw new Error("no init object set");return Zb.at(-1)}static _GetInitObject2(e){if($b.AddonManager._GetInitObject2!==rx)throw new Error("invalid method");if(Kb(e),0===Qb.length)throw new Error("no init object set");return Qb.at(-1)}static _PushInitProperties(e){ex.push(e)}static _PopInitProperties(){ex.pop()}static _GetInitProperties(){if(0===ex.length)throw new Error("no init properties set");return ex.at(-1)}_InitAddonScriptInterfaces(){for(const e of this.#e)e._InitScriptInterface()}static GetPluginByConstructorFunction(e){return nx.get(e)||null}static GetBehaviorByConstructorFunction(e){return ax.get(e)||null}GetSystemPlugin(){return this.#i}GetSolidBehavior(){return this.#o}GetJumpthruBehavior(){return this.#h}HasWrapperComponentId(e){return this.#t.has(e)}},tx=$b.AddonManager._PushInitObject,sx=$b.AddonManager._PopInitObject,ix=$b.AddonManager._GetInitObject,rx=$b.AddonManager._GetInitObject2}{const ox=self.C3,hx=new Set;ox.ImageInfo=class extends ox.DefendedBase{constructor(){super(),this._generation=0,this._url="",this._size=0,this._offsetX=0,this._offsetY=0,this._width=0,this._height=0,this._isRotated=!1,this._hasMetaData=!1,this._imageAsset=null,this._textureState="",this._rcTex=ox.New(ox.Rect),this._quadTex=ox.New(ox.Quad),this._blobUrl="",this._iImageInfo=new self.IImageInfo(this),hx.add(this)}Release(){this.ReleaseTexture(),this._imageAsset&&0===this._imageAsset.GetRefCount()&&this._imageAsset.Release(),this._imageAsset=null,hx.delete(this),this.ReleaseBlobURL()}static OnRendererContextLost(){for(const e of hx)e._textureState="",e._rcTex.set(0,0,0,0),e._quadTex.setFromRect(e._rcTex)}LoadData(e){this._url=e[0],this._size=e[1],this._offsetX=e[2],this._offsetY=e[3],this._width=e[4],this._height=e[5],this._isRotated=e[6],this._hasMetaData=!0}LoadDynamicAsset(e,t,s){if(s=!!s,this._imageAsset)throw new Error("already loaded asset");this._url=t;const i={isTiled:s};return ox.IsAbsoluteURL(t)&&(i.loadPolicy="remote"),this.LoadAsset(e,i),this._imageAsset.Load()}LoadDynamicBlobAsset(e,t){if(this._imageAsset)throw new Error("already loaded asset");this._url="",this._size=t.size,this._imageAsset=ox.New(ox.ImageAsset,e.GetAssetManager(),{blob:t,size:this._size,loadPolicy:"local"})}ReplaceWith(e){if(e===this)throw new Error("cannot replace with self");this._generation++,this.ReleaseTexture(),this._url=e._url,this._size=e._size,this._offsetX=e._offsetX,this._offsetY=e._offsetY,this._width=e._width,this._height=e._height,this._isRotated=e._isRotated,this._hasMetaData=e._hasMetaData,this._imageAsset=e._imageAsset,this._textureState=e._textureState,this._rcTex=e._rcTex,this._quadTex=e._quadTex,this.ReleaseBlobURL()}GetURL(){return this._url}GetSize(){return this._size}GetOffsetX(){return this._offsetX}GetOffsetY(){return this._offsetY}IsRotated(){return this._isRotated}GetWidth(){return this._width}GetHeight(){return this._height}GetSheetWidth(){return this._imageAsset.GetWidth()}GetSheetHeight(){return this._imageAsset.GetHeight()}LoadAsset(e,t){if(this._imageAsset)throw new Error("already got asset");t=Object.assign({},t,{url:this.GetURL(),size:this.GetSize()}),this._imageAsset=e.LoadImage(t)}IsLoaded(){return this._imageAsset&&this._imageAsset.IsLoaded()}async LoadStaticTexture(e,t){if(!this._imageAsset)throw new Error("no asset");if(this._textureState)throw new Error("already loaded texture");const s=this._generation;this._textureState="loading";const i=await this._imageAsset.LoadStaticTexture(e,t);if(this._generation!==s)return null;if(!i)return this._textureState="",null;this._textureState="loaded",this._hasMetaData||(this._width=i.GetWidth(),this._height=i.GetHeight(),this._hasMetaData=!0);const r=this._isRotated?this._height:this._width,n=this._isRotated?this._width:this._height;return this._rcTex.set(this._offsetX,this._offsetY,this._offsetX+r,this._offsetY+n),this._rcTex.divide(i.GetWidth(),i.GetHeight()),this._quadTex.setFromRect(this._rcTex),this._isRotated&&this._quadTex.rotatePointsAnticlockwise(),i}ReleaseTexture(){this._textureState&&(this._imageAsset&&this._imageAsset.ReleaseTexture(),this._textureState="",this._rcTex.set(0,0,0,0),this._quadTex.setFromRect(this._rcTex))}GetTexture(){return this._imageAsset&&"loaded"===this._textureState?this._imageAsset.GetTexture():null}GetTexRect(){return this._rcTex}GetTexQuad(){return this._quadTex}GetIImageInfo(){return this._iImageInfo}GetImageAsset(){return this._imageAsset}async ExtractImageToCanvas(e){e||(e=await this._imageAsset.LoadToDrawable()),this._hasMetaData||(this._width=e.width,this._height=e.height,this._hasMetaData=!0);const t=ox.CreateCanvas(this._width,this._height),s=t.getContext("2d");return this._isRotated?(s.rotate(Math.PI/-2),s.translate(-this._height,0),s.drawImage(e,this._offsetX,this._offsetY,this._height,this._width,0,0,this._height,this._width)):s.drawImage(e,this._offsetX,this._offsetY,this._width,this._height,0,0,this._width,this._height),t}async ExtractImageToBlobURL(e){if(this._blobUrl)return this._blobUrl;const t=await this.ExtractImageToCanvas(e),s=await ox.CanvasToBlob(t);return this._blobUrl=URL.createObjectURL(s),this._blobUrl}ReleaseBlobURL(){this._blobUrl&&(URL.revokeObjectURL(this._blobUrl),this._blobUrl="")}}}{const lx=self.C3;lx.AnimationInfo=class extends lx.DefendedBase{constructor(e){super(),this._name=e[0],this._speed=e[1],this._isLooping=!!e[2],this._repeatCount=e[3],this._repeatTo=e[4],this._isPingPong=!!e[5],this._sid=e[6],this._frames=e[7].map(e=>lx.New(lx.AnimationFrameInfo,e)),this._iAnimation=new self.IAnimation(this)}static CreateDynamic(e,t){const s=lx.New(lx.AnimationInfo,[t,0,!1,0,0,!1,Math.floor(1e15*Math.random()),[]]);return s._frames.push(lx.AnimationFrameInfo.CreateDynamic(e)),s}Release(){for(const e of this._frames)e.Release();lx.clearArray(this._frames)}LoadAllAssets(e){for(const t of this._frames)t.GetImageInfo().LoadAsset(e)}LoadAllTextures(e,t){return Promise.all(this._frames.map(s=>s.GetImageInfo().LoadStaticTexture(e,t)))}ReleaseAllTextures(){for(const e of this._frames)e.GetImageInfo().ReleaseTexture()}GetName(){return this._name}GetSID(){return this._sid}GetFrameCount(){return this._frames.length}GetFrames(){return this._frames}GetFrameAt(e){if((e=Math.floor(e))<0||e>=this._frames.length)throw new RangeError("invalid frame");return this._frames[e]}InsertFrameAt(e,t){(t=Math.floor(t))<0?this._frames.unshift(e):t>=this._frames.length?this._frames.push(e):this._frames.splice(t,0,e)}RemoveFrameAt(e){if((e=Math.floor(e))<0||e>=this._frames.length)throw new RangeError("invalid frame");this._frames[e].Release(),this._frames.splice(e,1)}GetFrameIndexByTag(e){for(let t=0,s=this._frames.length;t<s;++t)if(lx.equalsNoCase(this._frames[t].GetTag(),e))return t;return-1}FrameTagOrIndexToIndex(e){if("string"==typeof e){const t=this.GetFrameIndexByTag(e);if(-1===t)throw new Error(`cannot find animation frame with tag ${e}`);return t}return e}GetSpeed(){return this._speed}IsLooping(){return this._isLooping}GetRepeatCount(){return this._repeatCount}GetRepeatTo(){return this._repeatTo}IsPingPong(){return this._isPingPong}GetIAnimation(){return this._iAnimation}}}{const cx=self.C3,ux=(()=>{const e=atob("iVBORw0KGgoAAAANSUhEUgAAAGQAAABkAQMAAABKLAcXAAAAAXNSR0IArs4c6QAAAANQTFRFAAAAp3o92gAAAAF0Uk5TAEDm2GYAAAATSURBVBgZYxgFo2AUjIJRQFcAAAV4AAHcRQIbAAAAAElFTkSuQmCC"),t=new Uint8Array(e.length);for(let s=0,i=e.length;s<i;++s)t[s]=e.charCodeAt(s);return new Blob([t],{type:"image/png"})})();cx.AnimationFrameInfo=class extends cx.DefendedBase{constructor(e){super(),this._imageInfo=cx.New(cx.ImageInfo),this._imageInfo.LoadData(e),this._duration=e[7],this._origin=cx.New(cx.Vector2,e[8],e[9]),this._imagePoints=e[10].map(e=>cx.New(cx.ImagePoint,this,e)),this._imagePointsByName=new Map;for(const e of this._imagePoints)this._imagePointsByName.set(e.GetName().toLowerCase(),e);this._collisionPoly=null;const t=e[11];t.length>=6&&(this._collisionPoly=cx.New(cx.CollisionPoly,t)),this._tag=e[12]?e[12]:"",this._iAnimationFrame=new self.IAnimationFrame(this)}static CreateDynamic(e){const t=cx.New(cx.AnimationFrameInfo,["",0,0,0,100,100,!1,1,0,0,[],[],""]);return t._imageInfo.LoadDynamicBlobAsset(e,ux),t}Release(){this._collisionPoly&&(this._collisionPoly.Release(),this._collisionPoly=null),this._imageInfo.Release(),this._imageInfo=null}GetImageInfo(){return this._imageInfo}GetDuration(){return this._duration}GetOriginX(){return this._origin.getX()}GetOriginY(){return this._origin.getY()}GetCollisionPoly(){return this._collisionPoly}GetImagePointByName(e){return this._imagePointsByName.get(e.toLowerCase())||null}GetImagePointByIndex(e){return(e=Math.floor(e))<0||e>=this._imagePoints.length?null:this._imagePoints[e]}GetImagePointCount(){return this._imagePoints.length}GetTag(){return this._tag}GetIAnimationFrame(){return this._iAnimationFrame}}}{const dx=self.C3;dx.ImagePoint=class extends dx.DefendedBase{constructor(e,t){super(),this._afi=e,this._name=t[0],this._pos=dx.New(dx.Vector2,t[1],t[2])}Release(){}GetName(){return this._name}GetX(){return this._pos.getX()}GetY(){return this._pos.getY()}GetVec2(){return this._pos}}}{const _x=globalThis.C3,px=globalThis.C3Debugger,fx=globalThis.IObjectClass,mx=globalThis.IObjectType,gx=globalThis.IFamily,Sx=globalThis.assert;_x.ObjectClass=class extends _x.DefendedBase{constructor(e,t,s){super();const i=e.GetObjectReference(s[1]);this._runtime=e,this._plugin=_x.AddonManager.GetPluginByConstructorFunction(i),this._sdkType=null,this._instSdkCtor=i.Instance,this._index=t,this._sid=s[11],this._name=s[0],this._jsPropName=this._runtime.GetJsPropName(s[14]),this._isGlobal=!!s[9],this._isFamily=!!s[2],this._isOnLoaderLayout=!!s[10],this._instVars=s[3].map(t=>({sid:t[0],type:t[1],name:t[2],jsPropName:e.GetJsPropName(t[3])})),this._behaviorsCount=s[4],this._effectsCount=s[5],this._isWorldType=this._plugin.IsWorldType(),this._dispatcher=_x.New(_x.Event.Dispatcher),this._effectList=null;const[r,n]=e.GetCollisionEngine().GetCollisionCellSize();if(this._collisionGrid=_x.New(_x.SparseGrid,r,n),this._anyCollisionCellChanged=!0,this._familyMembers=null,this._familyMembersSet=null,this._familyIndex=-1,this._families=null,this._familiesSet=null,this._familyInstVarMap=null,this._familyBehaviorMap=null,this._familyEffectMap=null,this._isInContainer=!1,this._container=null,this._behaviorTypes=s[8].map(e=>_x.BehaviorType.Create(this,e)),this._behaviorTypesIncludingInherited=[],this._behaviorsByName=new Map,this._behaviorNameToIndex=new Map,this._usedBehaviorCtors=new Set,this._customActionMap=new Map,this._solStack=_x.New(_x.SolStack,this),this._defaultInstanceData=null,this._defaultLayerIndex=0,this._isContained=!1,this._container=null,this._imageInfo=null,this._animations=null,this._animationsByName=null,this._animationsBySid=null,this._textureRefCount=0,this._savedData=new Map,this._instances=[],this._worldInfosByLayer=new Map,this._iidsStale=!0,this._plugin.HasEffects()&&(this._effectList=_x.New(_x.EffectList,this,s[12])),s[6]&&(this._imageInfo=_x.New(_x.ImageInfo),this._imageInfo.LoadData(s[6])),s[7]){this._animations=s[7].map(e=>_x.New(_x.AnimationInfo,e)),this._animationsByName=new Map,this._animationsBySid=new Map;for(const e of this._animations)this._animationsByName.set(e.GetName().toLowerCase(),e),this._animationsBySid.set(e.GetSID(),e)}this._isFamily?(this._familyMembers=[],this._familyMembersSet=new Set,this._familyIndex=this._runtime._GetNextFamilyIndex()):(this._families=[],this._familiesSet=new Set,this._familyInstVarMap=[],this._familyBehaviorMap=[],this._familyEffectMap=[]);const a=this._plugin.GetSdkVersion();if(a<2&&(this._sdkType=_x.New(i.Type,this,s[15]),!(this._sdkType instanceof _x.SDKTypeBase)))throw new Error("v1 sdk type must derive from SDKTypeBase");let o;if(this._iObjectClass=null,this._instanceUserScriptClass=null,this._userScriptDispatcher=_x.New(_x.Event.Dispatcher),_x.AddonManager._PushInitObject(this,a),a>=2?(o=i.Type,o||(o=globalThis.ISDKObjectTypeBase)):o=this._sdkType.GetScriptInterfaceClass(),o&&!this._isFamily){if(this._iObjectClass=new o(a<2?this:null),a<2&&!(this._iObjectClass instanceof mx))throw new TypeError("script interface class must derive from IObjectType");if(a>=2&&!(this._iObjectClass instanceof globalThis.ISDKObjectTypeBase))throw new TypeError("script interface class must derive from ISDKObjectTypeBase")}else{const e=this._isFamily?gx:mx;this._iObjectClass=new e}if(_x.AddonManager._PopInitObject(a),s[13]){const e=s[13];if(e){const t=e[0],s=e[1],i=e[2];this._sdkType.LoadTilemapData(t,s,i)}}this._runtime.UsesLoaderLayout()&&!this._isFamily&&!this._isOnLoaderLayout&&this._isWorldType||this.OnCreate(),this._plugin.IsSingleGlobal()&&(this._plugin._SetSingleGlobalObjectClass(this),this._CreateSingleGlobalInstance(s)),this._loadInstancesJson=null}static Create(e,t,s){return _x.New(_x.ObjectClass,e,t,s)}Release(){if(this._dispatcher.Release(),this._dispatcher=null,this._imageInfo&&(this._imageInfo.Release(),this._imageInfo=null),this._animations){for(const e of this._animations)e.Release();_x.clearArray(this._animations),this._animationsByName.clear(),this._animationsBySid.clear()}this._loadInstancesJson=null,this._solStack.Release(),this._solStack=null,this._savedData.clear(),this._container=null,this._runtime=null}_LoadFamily(e){for(let t=1,s=e.length;t<s;++t){const s=this._runtime.GetObjectClassByIndex(e[t]);this._familyMembers.push(s),this._familyMembersSet.add(s),s._families.push(this),s._familiesSet.add(this)}}_SetContainer(e){this._isInContainer=!0,this._container=e}IsInContainer(){return this._isInContainer}GetContainer(){return this._container}_OnAfterCreate(){let e=0;if(!this._isFamily)for(const t of this._families)for(const s of t.GetBehaviorTypes()){const t=s.GetName().toLowerCase();this._behaviorsByName.set(t,s),this._behaviorNameToIndex.set(t,e),this._behaviorTypesIncludingInherited.push(s),++e}for(const t of this.GetBehaviorTypes()){const s=t.GetName().toLowerCase();this._behaviorsByName.set(s,t),this._behaviorNameToIndex.set(s,e),this._behaviorTypesIncludingInherited.push(t),++e}for(const e of this._behaviorTypesIncludingInherited)this._usedBehaviorCtors.add(e.GetBehavior().constructor);if(!this._isFamily&&this._families.length){const e=this._runtime.GetFamilyCount();_x.extendArray(this._familyInstVarMap,e,0),_x.extendArray(this._familyBehaviorMap,e,0),_x.extendArray(this._familyEffectMap,e,0);const t=[];let s=0,i=0,r=0;for(const e of this._families){const n=e.GetFamilyIndex();this._familyInstVarMap[n]=s,s+=e.GetInstanceVariablesCount(),this._familyBehaviorMap[n]=i,i+=e.GetBehaviorTypesCount(),this._familyEffectMap[n]=r,r+=e.GetEffectTypesCount();const a=e.GetEffectList();if(a&&this._effectList)for(const e of a.GetAllEffectTypes())t.push(e.Clone(this._effectList))}this._effectList&&this._effectList.PrependEffectTypes(t)}}_CreateSingleGlobalInstance(e){const t=_x.IsFiniteNumber(e[17])?e[17]:this._runtime._GetNewUID(),s=_x.New(_x.Instance,{runtime:this._runtime,objectType:this,uid:t});s._CreateSdkInstance(e[16],[]),this._runtime._MapInstanceByUID(t,s),this._instances.push(s)}GetSdkType(){return this._sdkType}IsOnLoaderLayout(){return this._isOnLoaderLayout}Dispatcher(){return this._dispatcher}OnCreate(){this._isFamily||(this._sdkType?this._sdkType.OnCreate():this._iObjectClass._onCreate())}HasLoadedTextures(){return this._textureRefCount>0}async LoadTextures(e){this._isFamily||(this._textureRefCount++,1===this._textureRefCount&&(this._sdkType?await this._sdkType.LoadTextures(e):await this._iObjectClass._loadTextures(this._runtime.GetCanvasManager().GetIRenderer())))}ReleaseTextures(){if(!this._isFamily){if(this._textureRefCount--,this._textureRefCount<0)throw new Error("released textures too many times");0===this._textureRefCount&&(this._sdkType?this._sdkType.ReleaseTextures():this._iObjectClass._releaseTextures(this._runtime.GetCanvasManager().GetIRenderer()))}}OnDynamicTextureLoadComplete(){if(this._isFamily)throw new Error("not applicable to family");this._sdkType?this._sdkType.OnDynamicTextureLoadComplete():this._iObjectClass._onDynamicTextureLoadComplete()}async PreloadTexturesWithInstances(e){this._isFamily||(this._sdkType?await this._sdkType.PreloadTexturesWithInstances(e):await this._iObjectClass._preloadTexturesWithInstances(this._runtime.GetCanvasManager().GetIRenderer()))}GetRuntime(){return this._runtime}GetPlugin(){return this._plugin}GetInstanceSdkCtor(){return this._instSdkCtor}GetName(){return this._name}GetJsPropName(){return this._jsPropName}GetIndex(){return this._index}GetSID(){return this._sid}IsFamily(){return this._isFamily}IsGlobal(){return this._isGlobal}IsWorldType(){return this._isWorldType}GetFamilyIndex(){return this._familyIndex}GetBehaviorTypes(){return this._behaviorTypes}GetBehaviorTypesCount(){return this._behaviorsCount}UsesBehaviorByCtor(e){return e&&this._usedBehaviorCtors.has(e)}GetInstanceVariablesCount(){return this._instVars.length}GetInstanceVariableSIDs(){return this._instVars.map(e=>e.sid)}GetInstanceVariableIndexBySID(e){return this._instVars.findIndex(t=>t.sid===e)}GetInstanceVariableIndexByName(e){return this._instVars.findIndex(t=>t.name===e)}_GetAllInstanceVariableNames(){return this._instVars.map(e=>e.name)}_GetAllInstanceVariableJsPropNames(){return this._instVars.map(e=>e.jsPropName)}GetInstanceVariableType(e){if((e=Math.floor(e))<0||e>=this._instVars.length)throw new RangeError("invalid instance variable index");return this._instVars[e].type}GetInstanceVariableName(e){if((e=Math.floor(e))<0||e>=this._instVars.length)throw new RangeError("invalid instance variable index");return this._instVars[e].name}GetEffectTypesCount(){return this._effectsCount}GetBehaviorTypesIncludingInherited(){return this._behaviorTypesIncludingInherited}GetBehaviorTypeByName(e){return this._behaviorsByName.get(e.toLowerCase())||null}GetBehaviorIndexByName(e){const t=this._behaviorNameToIndex.get(e.toLowerCase());return void 0===t?-1:t}GetEffectList(){return this._effectList}HasEffects(){return this._plugin.HasEffects()}UsesEffects(){return this._effectList&&this._effectList.HasAnyEffectType()}GetSolStack(){return this._solStack}GetCurrentSol(){return this._solStack.GetCurrentSol()}GetImageInfo(){return this._imageInfo}SetDefaultInstanceData(e){this._defaultInstanceData=e}GetDefaultInstanceData(){return this._defaultInstanceData}_SetDefaultLayerIndex(e){this._defaultLayerIndex=e}GetDefaultLayerIndex(){return this._defaultLayerIndex}GetAnimations(){return this._animations}GetAnimationCount(){return this._animations.length}GetFamilies(){return this._families}BelongsToFamily(e){return this._familiesSet.has(e)}GetFamilyMembers(){return this._familyMembers}FamilyHasMember(e){return this._familyMembersSet.has(e)}GetFamilyBehaviorOffset(e){return this._familyBehaviorMap[e]}GetFamilyInstanceVariableOffset(e){return this._familyInstVarMap[e]}AddCustomAction(e){this._customActionMap.set(e.GetACEName().toLowerCase(),e)}HasOwnCustomActionByName(e){return!!this.GetOwnCustomActionByName(e)}GetOwnCustomActionByName(e){const t=this._customActionMap.get(e.toLowerCase());return t&&t.IsEnabled()?t:null}GetAllAnimations(){return this._animations}GetAnimationByName(e){if(!this._animations)throw new Error("no animations");return this._animationsByName.get(e.toLowerCase())||null}GetAnimationBySID(e){if(!this._animations)throw new Error("no animations");return this._animationsBySid.get(e)||null}AddAnimation(e){if(this.GetAnimationByName(e))throw new Error(`animation name '${e}' already exists`);const t=_x.AnimationInfo.CreateDynamic(this.GetRuntime(),e);return this._animations.push(t),this._animationsByName.set(t.GetName().toLowerCase(),t),this._animationsBySid.set(t.GetSID(),t),t}RemoveAnimation(e){const t=this.GetAnimationByName(e);if(!t)throw new Error(`animation name '${e}' does not exist`);if(1===this._animations.length)throw new Error("cannot remove last animation");const s=this._animations.indexOf(t);this._animations.splice(s,1),this._animationsByName.delete(t.GetName().toLowerCase()),this._animationsBySid.delete(t.GetSID()),t.Release()}GetFirstAnimation(){if(!this._animations)throw new Error("no animations");return this._animations[0]}GetFirstAnimationFrame(){return this.GetFirstAnimation().GetFrameAt(0)}GetDefaultInstanceSize(){if(this._animations){const e=this.GetFirstAnimationFrame().GetImageInfo();return[e.GetWidth(),e.GetHeight()]}return this._imageInfo?[this._imageInfo.GetWidth(),this._imageInfo.GetHeight()]:[100,100]}GetSingleGlobalInstance(){if(!this._plugin.IsSingleGlobal())throw new Error("not a single-global plugin");return this._instances[0]}GetInstances(){return this._instances}*instances(){yield*this._instances}*instancesIncludingPendingCreate(){yield*this._instances,yield*this._runtime.instancesPendingCreateForObjectClass(this)}GetInstanceCount(){return this._instances.length}_AddInstance(e){this._instances.push(e)}_SetIIDsStale(){this._iidsStale=!0}_UpdateIIDs(){if(!this._iidsStale||this._isFamily)return;const e=this._instances;let t=0;for(let s=e.length;t<s;++t)e[t]._SetIID(t);const s=this._runtime._GetInstancesPendingCreate();for(const e of s)e.GetObjectClass()===this&&e._SetIID(t++);this._iidsStale=!1}GetInstanceByIID(e){const t=this._instances;if(e<t.length)return t[e];e-=t.length;const s=this._runtime._GetInstancesPendingCreate();for(const t of s)if(t.GetObjectClass()===this){if(0===e)return t;--e}return null}GetFirstPicked(e){if(e&&e.IsInContainer()&&e.GetObjectClass()!==this)for(const t of e.siblings())if(t.GetObjectClass()===this)return t;const t=this.GetCurrentSol().GetInstances();return t.length?t[0]:null}GetPairedInstance(e){const t=this.GetCurrentSol().GetInstances();return t.length>0?t[e.GetIID()%t.length]:null}*allCorrespondingInstances(e,t){const s=this.GetCurrentSol().GetInstances(),i=s.length,r=t.GetCurrentSol(),n=t.GetCurrentSol().GetInstances(),a=n.length;let o=e.GetIID();!t.IsFamily()&&r.IsSelectAll()||(o=n.indexOf(e));const h=Math.ceil(i/a),l=i%a;let c=0,u=0;0===l||o<l?(c=o*h,u=h):(c=l*h+(o-l)*(h-1),u=h-1);for(let e=c,t=c+u;e<t;++e)yield s[e]}FinishCondition(e){this._sdkType?.FinishCondition(e)}ApplySolToContainer(){if(!this._isInContainer||this._isFamily)return;this._UpdateIIDs();const e=this.GetCurrentSol(),t=e._GetOwnInstances(),s=e.IsSelectAll(),i=this._runtime.GetCurrentEventStackFrame(),r=i&&i.GetCurrentEvent()&&i.GetCurrentEvent().IsOrBlock();for(const i of this._container.objectTypes()){if(i===this)continue;i._UpdateIIDs();const n=i.GetCurrentSol();if(n._SetSelectAll(s),!s){const s=n._GetOwnInstances();_x.clearArray(s);for(const e of t)s.push(i.GetInstanceByIID(e.GetIID()));if(r){const t=e._GetOwnElseInstances(),s=n._GetOwnElseInstances();_x.clearArray(s);for(const e of t)s.push(i.GetInstanceByIID(e.GetIID()))}}}}_TruncateContainerSols(e,t){for(const s of this.GetContainer().objectTypes()){const i=s.GetCurrentSol();e?_x.truncateArray(i._GetOwnElseInstances(),t):_x.truncateArray(i._GetOwnInstances(),t)}}_GetCollisionCellGrid(){return this._collisionGrid}_SetAnyCollisionCellChanged(e){this._anyCollisionCellChanged=!!e}_UpdateAllCollisionCells(){if(this._anyCollisionCellChanged&&this._isWorldType){for(const e of this._instances)e.GetWorldInfo()._UpdateCollisionCell();for(const e of this._runtime._GetInstancesPendingCreate())e.GetObjectClass()===this&&e.GetWorldInfo()._UpdateCollisionCell();this._anyCollisionCellChanged=!1}}_OnWorldInstanceLayerChanged(e,t,s){if(t){const s=this._worldInfosByLayer.get(t);s&&(s.delete(e),0===s.size&&this._worldInfosByLayer.delete(t))}if(s){let t=this._worldInfosByLayer.get(s);t||(t=new Set,this._worldInfosByLayer.set(s,t)),t.add(e)}}*layersHasInstancesOn(){if(this.IsFamily()){const e=new Set;for(const t of this._familyMembers)for(const s of t.layersHasInstancesOn())e.add(s);yield*e.values()}else for(const e of this._worldInfosByLayer.keys())e.WasReleased()||(yield e)}GetSavedDataMap(){return this._savedData||(this._savedData=new Map),this._savedData}HasSolidBehavior(){return this.UsesBehaviorByCtor(_x.Behaviors.solid)}HasJumpthruBehavior(){return this.UsesBehaviorByCtor(_x.Behaviors.jumpthru)}HasNoSaveBehavior(){return this.UsesBehaviorByCtor(_x.Behaviors.NoSave)}HasPersistBehavior(){return this.UsesBehaviorByCtor(_x.Behaviors.Persist)}_SaveToJson(){const e={instances:this._instances.map(e=>e.SaveToJson())};return this._savedData&&this._savedData.size&&(e.ex=_x.ToSuperJSON(this._savedData)),e}_LoadFromJson(e,t){this._savedData&&(this._savedData.clear(),this._savedData=null);const s=e.ex;s&&(this._savedData=_x.FromSuperJSON(s));const i=this._instances,r=e.instances;for(let e=0,t=Math.min(i.length,r.length);e<t;++e)i[e].LoadFromJson(r[e]);for(let e=r.length,t=i.length;e<t;++e)this._runtime.DestroyInstance(i[e]);for(let e=i.length,s=r.length;e<s;++e){const s=r[e];let i=null;if(this.IsWorldType()&&(i=this._runtime.GetMainRunningLayout().GetLayerBySID(s.w.l),!i))continue;const n=this._runtime.CreateInstanceFromData(this._defaultInstanceData||this,i,!1,0,0,!0);n.LoadFromJson(s),t&&t.add(n)}this._loadInstancesJson=r,this._SetIIDsStale()}_GetLoadInstancesJson(){return this._loadInstancesJson}_ClearLoadInstancesJson(){this._loadInstancesJson=null}_SetupSceneGraphConnectionsOnChangeOfLayout(){for(let e=0,t=this._instances;e<t;++e)this._instances[e]._SetupSceneGraphConnectionsOnChangeOfLayout()}GetIObjectClass(){return this._iObjectClass}UserScriptDispatcher(){return this._userScriptDispatcher}_GetUserScriptInstanceClass(){return this._instanceUserScriptClass}_SetUserScriptInstanceClass(e){this._instanceUserScriptClass=e}DispatchUserScriptEvent(e){const t=this._runtime,s=t.IsDebug()&&!t.GetEventSheetManager().IsInEventEngine();s&&px.StartMeasuringScriptTime(),this._userScriptDispatcher.dispatchEvent(e),s&&px.AddScriptTime()}}}{const Gx=self.C3;Gx.Container=class extends Gx.DefendedBase{constructor(e,t){super(),this._runtime=e,this._objectTypes=t;for(const e of this._objectTypes)e._SetContainer(this)}Release(){this._runtime=null}GetRuntime(){return this._runtime}GetObjectTypes(){return this._objectTypes}objectTypes(){return this._objectTypes}HasAnyWorldType(){return this._objectTypes.some(e=>e.IsWorldType())}}}{const yx=self.C3,Ix=self.C3Debugger,Tx=self.IInstance,Cx=yx.AddonManager,bx=[],xx=new Set;let wx=0;const Px=new WeakMap,Rx=1,vx=2,Ax=4,Mx=8,Dx=16,Ex=32,Fx=32,Ox=64;yx.Instance=class extends yx.DefendedBase{#s=null;constructor(e){if(yx.AddonManager!==Cx)throw new Error("invalid addon manager");super(),this._runtime=e.runtime,this._objectType=e.objectType,this._worldInfo=null,this._sdkInst=null,this._iScriptInterface=null,this._iid=0,this._uid=e.uid,this._puid=wx++,this._flags=0;const t=yx.splitStringAndNormalize(e.tags);t.length>0&&this.SetTagsSet(new Set(t)),this._instVarValues=bx,this._behaviorInstances=bx;const s=this._objectType.GetBehaviorTypesIncludingInherited();s.length>0&&(this._behaviorInstances=s.map((e,t)=>yx.New(yx.BehaviorInstance,{runtime:this._runtime,behaviorType:e,instance:this,index:t}))),this._siblings=this._objectType.IsInContainer()?[]:null,this._timeScale=-1,this._dispatcher=null;const i=this.GetPlugin();if(i.MustPreDraw()&&(this._flags|=4),i.IsWorldType())if(this._worldInfo=yx.New(yx.WorldInfo,this,e.layer),e.worldData)this._worldInfo.Init(e.worldData);else{this._worldInfo.InitNoData();const[e,t]=this._objectType.GetDefaultInstanceSize();this._worldInfo.SetSize(e,t),this.GetObjectClass().UsesEffects()&&this._worldInfo.GetInstanceEffectList().LoadDefaultEffectParameters()}e.instVarData?this._LoadInstanceVariableData(e.instVarData):this._LoadDefaultInstanceVariables()}Release(){if(this._iScriptInterface&&(this._iScriptInterface._release(),this._iScriptInterface=null),this._behaviorInstances.length>0){for(const e of this._behaviorInstances)e.Release();yx.clearArray(this._behaviorInstances)}this._sdkInst&&(this._sdkInst.Release(),this._sdkInst=null);const e=Px.get(this);e&&(e.clear(),Px.delete(this)),this._siblings&&yx.clearArray(this._siblings),this._dispatcher&&(this._dispatcher.Release(),this._dispatcher=null),this.#s&&(this.#s.originalTags.clear(),this.#s.lowercaseTags.clear()),this.#s=null,this._runtime=null,this._objectType=null,this._instVarValues.length>0&&yx.clearArray(this._instVarValues),this._worldInfo&&(this._worldInfo.Release(),this._worldInfo=null)}_LoadInstanceVariableData(e){e.length>0&&(this._instVarValues=[],yx.shallowAssignArray(this._instVarValues,e))}_LoadDefaultInstanceVariables(){const e=this._objectType.GetInstanceVariablesCount();if(0===e)return;this._instVarValues=[];const t=[0,0,""];for(let s=0;s<e;++s)this._instVarValues.push(t[this._objectType.GetInstanceVariableType(s)])}_CreateSdkInstance(e,t){if(this._sdkInst)throw new Error("already got sdk instance");for(let e=0,s=this._behaviorInstances.length;e<s;++e)this._behaviorInstances[e]._CreateSdkInstance(t?t[e]:null);if(this.GetPlugin().GetSdkVersion()<2){if(this._sdkInst=yx.New(this._objectType.GetInstanceSdkCtor(),this,e),!(this._sdkInst instanceof yx.SDKInstanceBase))throw new Error("sdk type must derive from SDKInstanceBase");!this.GetPlugin().IsWorldType()&&this._objectType._GetUserScriptInstanceClass()&&this.GetInterfaceClass()}else{const t=this.GetPlugin().GetScriptInterfaceClass();this._InitUserScriptInterface(t.Instance,e)}}GetSdkInstance(){return this._sdkInst??this._iScriptInterface}GetWorldInfo(){return this._worldInfo}GetRuntime(){return this._runtime}GetTimeScale(){return this._timeScale}GetActiveTimeScale(){const e=this._timeScale;return-1===e?this.GetRuntime().GetTimeScale():e}SetTimeScale(e){((e=+e)<0||!isFinite(e))&&(e=0),this._timeScale=e,this.GetObjectClass().UsesEffects()&&this._runtime._SetTrackingInstanceTime(this,!0)}RestoreTimeScale(){this._timeScale=-1,this.GetObjectClass().UsesEffects()&&this._runtime._SetTrackingInstanceTime(this,!1)}GetInstanceGameTime(){return this._runtime._GetInstanceGameTime(this)}Dispatcher(){return this._dispatcher||(this._dispatcher=yx.New(yx.Event.Dispatcher)),this._dispatcher}Draw(e){this._sdkInst?this._sdkInst.Draw(e):this._iScriptInterface._draw(this._runtime.GetCanvasManager().GetIRenderer())}OnCreate(e){this._sdkInst.OnCreate(e)}_SetHasTilemap(){this._flags|=2}HasTilemap(){return!!(2&this._flags)}_MarkDestroyed(){this._flags|=1}IsDestroyed(){return!!(1&this._flags)}MustPreDraw(){return!!(4&this._flags)||(this._sdkInst?this._sdkInst.MustPreDraw():this._iScriptInterface._mustPreDraw())}SetMustMitigateZFighting(){this._flags|=32}MustMitigateZFighting(){return!!(32&this._flags)}_IsSolidEnabled(){return!!(8&this._flags)}_SetSolidEnabled(e){e?this._flags|=8:this._flags&=-9}_IsSolidUsingInstanceTags(){return!!(16&this._flags)}_SetSolidUsingInstanceTags(e){e?this._flags|=16:this._flags&=-17}_IsJumpthruEnabled(){return!!(32&this._flags)}_SetJumpthruEnabled(e){e?this._flags|=32:this._flags&=-33}_IsDrawingWithEffects(){return!!(64&this._flags)}_SetIsDrawingWithEffects(e){e?this._flags|=64:this._flags&=-65}SetFlag(e,t){e<<=16,t?this._flags|=e:this._flags&=~e}GetFlag(e){return!!(this._flags&e<<16)}GetCurrentImageInfo(){return this._sdkInst?this._sdkInst.GetCurrentImageInfo():null}GetCurrentSurfaceSize(){return this._sdkInst?this._sdkInst.GetCurrentSurfaceSize():null}GetCurrentTexRect(){return this._sdkInst?this._sdkInst.GetCurrentTexRect():null}GetCurrentTexQuad(){return this._sdkInst?this._sdkInst.GetCurrentTexQuad():null}IsCurrentTexRotated(){return!!this._sdkInst&&this._sdkInst.IsCurrentTexRotated()}GetImagePoint(e){return this._sdkInst?this._sdkInst.GetImagePoint(e):[this._iScriptInterface.x,this._iScriptInterface.y,this._iScriptInterface.totalZElevation]}GetObjectClass(){return this._objectType}RendersToOwnZPlane(){return this._sdkInst?this._sdkInst.RendersToOwnZPlane():this._iScriptInterface._rendersToOwnZPlane()}BelongsToObjectClass(e){return e.IsFamily()?e.FamilyHasMember(this.GetObjectClass()):this.GetObjectClass()===e}CollectInstancesToPick(e,t,s){const i=(t,s)=>{const i=s||t.GetObjectClass(),r=e.get(i);r?r.add(t):e.set(i,new Set([t]))};if(i(this,t),this.IsInContainer())for(const e of this.siblings())i(e);if(s)for(const e of this.allChildren())i(e)}VerifySupportsSceneGraph(){if(!this.GetPlugin().SupportsSceneGraph())throw new Error("object does not support scene graph")}HasParent(){return null!==this.GetParent()}GetParent(){const e=this.GetWorldInfo();if(!e)return null;const t=e.GetParent();return t?t.GetInstance():null}GetTopParent(){const e=this.GetWorldInfo();if(!e)return null;const t=e.GetTopParent();return t?t.GetInstance():null}*parents(){const e=this.GetWorldInfo();if(e)for(const t of e.parents())yield t.GetInstance()}HasChild(e){if(!e)return!1;for(const t of this.children())if(t===e)return!0;return!1}HasChildren(){const e=this.GetWorldInfo();return!!e&&e.HasChildren()}GetChildrenOfObjectClass(e){const t=this.GetWorldInfo();if(!t)return[];const s=e.GetName();return t.GetChildren().map(e=>e.GetInstance()).filter(e=>e.GetObjectClass().GetName()===s)}GetChildren(){const e=this.GetWorldInfo();return e?e.GetChildren().map(e=>e.GetInstance()):[]}*children(){const e=this.GetWorldInfo();if(e)for(const t of e.children())yield t.GetInstance()}*allChildren(){const e=this.GetWorldInfo();if(e)for(const t of e.allChildren())yield t.GetInstance()}GetChildCount(){const e=this.GetWorldInfo();return e?e.GetChildCount():0}GetParentCount(){return[...this.parents()].length}GetAllChildCount(){const e=this.GetWorldInfo();return e?e.GetAllChildCount():0}GetChildAt(e){const t=this.GetWorldInfo();if(!t)return null;const s=t.GetChildAt(e);return s?s.GetInstance():null}GetIndexInParent(){const e=this.GetWorldInfo();if(!e)return NaN;const t=e.GetParent();return t?t.GetChildIndex(e):NaN}HasChildWithUID(e){for(const t of this.GetWorldInfo().GetChildren())if(t.GetInstance().GetUID()===e)return!0;return!1}AddChild(e,t){this.VerifySupportsSceneGraph(),e.VerifySupportsSceneGraph(),this.GetWorldInfo().AddChild(e.GetWorldInfo(),t||{})}RemoveChild(e){const t=this.GetWorldInfo();t&&t.RemoveChild(e.GetWorldInfo())}GetDestroyWithParent(){const e=this.GetWorldInfo();return!!e&&e.GetDestroyWithParent()}SetupInitialSceneGraphConnections(){const e=this.GetWorldInfo();if(!e)return;const t=e.GetSceneGraphChildrenExportData();if(t)for(const e of t){const t=this._runtime.GetInstanceByUID(e[2]);if(t){const s=e[3];this.AddChild(t,{transformX:!!(1&s),transformY:!!(s>>1&1),transformWidth:!!(s>>2&1),transformHeight:!!(s>>3&1),transformAngle:!!(s>>4&1),destroyWithParent:!!(s>>5&1),transformZElevation:!!(s>>6&1),transformOpacity:!!(s>>7&1),transformVisibility:!!(s>>8&1)})}}}SetupPersistedSceneGraphConnections(e,t){const s=e.get(this);if(s)for(const e of s.sceneGraphJson.children){const s=t.get(e.index);if(!s)continue;const i=e.flags;this.AddChild(s,{transformX:!!(1&i),transformY:!!(i>>1&1),transformWidth:!!(i>>2&1),transformHeight:!!(i>>3&1),transformAngle:!!(i>>4&1),destroyWithParent:!!(i>>5&1),transformZElevation:!!(i>>6&1),transformOpacity:!!(i>>7&1),transformVisibility:!!(i>>8&1)})}}GetTemplateName(){const e=this._runtime.GetTemplateManager();return e?e.GetInstanceTemplateName(this):""}IsInContainer(){return null!==this._siblings}_ClearSiblings(){yx.clearArray(this._siblings)}_AddSibling(e){this._siblings.push(e)}GetSiblings(){return this._siblings}HasSibling(e){return!!this.GetSibling(e)}GetSibling(e){const t=this.siblings();if(null===t||0===t.length)return!1;for(const s of t)if(s.GetObjectClass()===e)return s;return null}siblings(){return this._siblings}SetSiblingsSinglePicked(){for(const e of this.siblings())e.GetObjectClass().GetCurrentSol().SetSinglePicked(e)}_PushSiblingsToSolInstances(){for(const e of this.siblings())e.GetObjectClass().GetCurrentSol()._PushInstance(e)}_SetSiblingsToSolInstancesIndex(e){for(const t of this.siblings())t.GetObjectClass().GetCurrentSol()._GetOwnInstances()[e]=t}_PushSiblingsToSolElseInstances(){for(const e of this.siblings())e.GetObjectClass().GetCurrentSol()._PushElseInstance(e)}_SetSiblingsToSolElseInstancesIndex(e){for(const t of this.siblings())t.GetObjectClass().GetCurrentSol()._GetOwnElseInstances()[e]=t}GetPlugin(){return this._objectType.GetPlugin()}_SetIID(e){this._iid=e}GetIID(){return this._objectType._UpdateIIDs(),this._iid}GetUID(){return this._uid}SetUID(e){this._uid=e}GetPUID(){return this._puid}SetTagsSet(e){if(this.#s&&(this.#s.originalTags.clear(),this.#s.lowercaseTags.clear()),0===e.size)this.#s=null;else{this.#s||(this.#s={originalTags:new Set,lowercaseTags:new Set});for(const t of e){const e=t.toLowerCase();this.#s.lowercaseTags.has(e)||(this.#s.originalTags.add(t),this.#s.lowercaseTags.add(e))}}}GetTagsSet(){return this.#s?this.#s.originalTags:xx}GetLowercaseTagsSet(){return this.#s?this.#s.lowercaseTags:xx}_GetLowercaseTagsSetMaybeNull(){return this.#s?this.#s.lowercaseTags:null}HasTag(e){return!!this.#s&&this.#s.lowercaseTags.has(e.toLowerCase())}GetTagsString(){return Array.from(this.GetTagsSet()).join(" ")}GetTagAt(e){e=Math.floor(e);for(const t of this.GetTagsSet()){if(0===e)return t;--e}return""}GetBehaviorInstances(){return this._behaviorInstances}GetBehaviorInstanceFromCtor(e){if(!e)return null;for(const t of this._behaviorInstances)if(t.GetBehavior()instanceof e)return t;return null}GetBehaviorSdkInstanceFromCtor(e){if(!e)return null;const t=this.GetBehaviorInstanceFromCtor(e);return t?t.GetSdkInstance():null}GetBehaviorIndexBySID(e){const t=this._behaviorInstances;for(let s=0,i=t.length;s<i;++s)if(t[s].GetBehaviorType().GetSID()===e)return s;return-1}GetAllInstanceVariableValues(){return this._instVarValues}_GetAllInstanceVariableNames(){return this._objectType._GetAllInstanceVariableNames()}GetInstanceVariableCount(){return this._instVarValues.length}GetInstanceVariableValue(e){e|=0;const t=this._instVarValues;if(e<0||e>=t.length)throw new RangeError("invalid instance variable");return t[e]}_GetInstanceVariableValueUnchecked(e){return this._instVarValues[e]}_GetInstanceVariableTypedValue(e){const t=this._instVarValues[e];return 0===this._objectType.GetInstanceVariableType(e)?!!t:t}SetInstanceVariableValue(e,t){e|=0;const s=this._instVarValues;if(e<0||e>=s.length)throw new RangeError("invalid instance variable");switch(this._objectType.GetInstanceVariableType(e)){case 0:s[e]=t?1:0;break;case 1:s[e]="number"==typeof t?t:parseFloat(t);break;case 2:s[e]="string"==typeof t?t:t.toString();break;default:throw new Error("unknown instance variable type")}}SetInstanceVariableOffset(e,t){if(0===t)return;e|=0;const s=this._instVarValues;if(e<0||e>=s.length)throw new RangeError("invalid instance variable");const i=s[e];if("number"!=typeof i)throw"boolean"==typeof i?new Error("can not set offset of boolean variable"):"string"==typeof i?new Error("can not set offset of string variable"):new Error("unknown instance variable type");s[e]+="number"==typeof t?t:parseFloat(t)}GetSavedDataMap(){let e=Px.get(this);return e||(e=new Map,Px.set(this,e),e)}_HasAnyCreateDestroyHandler(e){const t=this.GetObjectClass();if(t.UserScriptDispatcher().HasAnyHandlerFor(e))return!0;for(const s of t.GetFamilies())if(s.UserScriptDispatcher().HasAnyHandlerFor(e))return!0;return!!this._runtime.UserScriptDispatcher().HasAnyHandlerFor(e)}_TriggerOnCreatedOnSelfAndRelated(e=void 0){const t=e??new Set;if(t.has(this))return;t.add(this);const s=this.GetWorldInfo();if(s&&s.HasChildren())for(const e of this.allChildren())if(t.add(e),e.IsInContainer())for(const s of e.siblings())t.add(s);if(this.IsInContainer())for(const e of this.siblings())e._TriggerOnCreatedOnSelfAndRelated(t);if(!e){for(const e of t.values())e._TriggerOnCreated();this._OnHierarchyReady()}}_OnCreatedCommon(){this._objectType._GetUserScriptInstanceClass()&&this.GetInterfaceClass();for(const e of this._behaviorInstances)e.PostCreate()}_OnCreatedForLoadingSavegame(){this._OnCreatedCommon()}_TriggerOnCreated(){if(this._OnCreatedCommon(),this._HasAnyCreateDestroyHandler("instancecreate")){const e=this.GetObjectClass(),t=new yx.Event("instancecreate");t.instance=this.GetInterfaceClass(),e.DispatchUserScriptEvent(t);for(const s of e.GetFamilies())s.DispatchUserScriptEvent(t);this._runtime.DispatchUserScriptEvent(t)}this._runtime.Trigger(this.GetPlugin().GetConstructor().Cnds.OnCreated,this,null)}_OnHierarchyReady(){if(this.GetPlugin().SupportsSceneGraph()){if(this.DispatchUserScriptEvent(new yx.Event("hierarchyready")),this._HasAnyCreateDestroyHandler("hierarchyready")){const e=this.GetObjectClass(),t=new yx.Event("hierarchyready");t.instance=this.GetInterfaceClass(),e.DispatchUserScriptEvent(t);for(const s of e.GetFamilies())s.DispatchUserScriptEvent(t);this._runtime.DispatchUserScriptEvent(t)}this._runtime.Trigger(this.GetPlugin().GetConstructor().Cnds.OnHierarchyReady,this,null)}}_TriggerOnDestroyed(){this._runtime.Trigger(this.GetPlugin().GetConstructor().Cnds.OnDestroyed,this,null)}_FireDestroyedScriptEvents(e){if(this._iScriptInterface){const t=new yx.Event("destroy");t.isEndingLayout=e,this.DispatchUserScriptEvent(t)}if(!this._HasAnyCreateDestroyHandler("instancedestroy"))return;const t=this.GetObjectClass(),s=new yx.Event("instancedestroy");s.instance=this.GetInterfaceClass(),s.isEndingLayout=e,t.DispatchUserScriptEvent(s);for(const e of t.GetFamilies())e.DispatchUserScriptEvent(s);this._runtime.DispatchUserScriptEvent(s)}_GetDebuggerProperties(){return this._sdkInst?this._sdkInst.GetDebuggerProperties():this._iScriptInterface._getDebuggerProperties()}SaveToJson(e="full",t=null){const s={};"full"===e?s.uid=this.GetUID():s.c3=!0;const i=this.GetTagsSet();if(i.size>0&&(s.tags=Array.from(i)),"visual-state"!==e){const t=Px.get(this);if(t&&t.size&&(s.ex=yx.ToSuperJSON(t)),-1!==this.GetTimeScale()&&(s.mts=this.GetTimeScale()),this._objectType.GetInstanceVariablesCount()>0){const e={},t=this._objectType.GetInstanceVariableSIDs();for(let s=0,i=this._instVarValues.length;s<i;++s)e[t[s].toString()]=this._instVarValues[s];s.ivs=e}if(this._behaviorInstances.length){const t={};for(const s of this._behaviorInstances){const i=s.SaveToJson(e);i&&(t[s.GetBehaviorType().GetSID().toString()]=i)}s.behs=t}}this._worldInfo&&(s.w=this._worldInfo._SaveToJson(e,t));const r=this._sdkInst?this._sdkInst.SaveToJson():this._iScriptInterface._saveToJson();return r&&(s.data=r),s}_OnBeforeLoad(e="full",t=null){this._worldInfo&&this._worldInfo._OnBeforeLoad(e)}_OnAfterLoad(e,t="full",s=null){this._worldInfo&&this._worldInfo._OnAfterLoad(e,t,s)}_OnAfterLoad2(e,t="full",s=null){this._worldInfo&&this._worldInfo._OnAfterLoad2(e,t,s)}_SetupSceneGraphConnectionsOnChangeOfLayout(){this.GetPlugin().IsWorldType()&&this._worldInfo._SetupSceneGraphConnectionsOnChangeOfLayout()}LoadFromJson(e,t="full",s=null){if("full"===t)this._uid=e.uid;else if(!e.c3)return;if(this.SetTagsSet(new Set(e.tags??[])),"visual-state"!==t){let t=Px.get(this);t&&(t.clear(),Px.delete(this));const s=e.ex;s&&(t=yx.FromSuperJSON(s),Px.set(this,t)),this._timeScale=e.hasOwnProperty("mts")?e.mts:-1;const i=e.ivs;if(i)for(const[e,t]of Object.entries(i)){const s=parseInt(e,10),i=this._objectType.GetInstanceVariableIndexBySID(s);if(i<0||i>=this._instVarValues.length)continue;let r=t;null===r&&(r=NaN),this._instVarValues[i]=r}}if(this.GetPlugin().IsWorldType()){const i=e.w;if(i){const e=i.l;if(this._worldInfo.GetLayer().GetSID()!==e){const s=this._worldInfo.GetLayer(),i=s.GetLayout().GetLayerBySID(e);i?(this._worldInfo._SetLayer(i),s._RemoveInstance(this,!0),i._AddInstance(this,!0),i.SetZIndicesChanged(this),this._worldInfo.SetBboxChanged()):"full"===t&&this._runtime.DestroyInstance(this)}this._worldInfo._LoadFromJson(i,t,s)}}if("visual-state"!==t){const s=e.behs;if(s)for(const[e,i]of Object.entries(s)){const s=parseInt(e,10),r=this.GetBehaviorIndexBySID(s);r<0||r>=this._behaviorInstances.length||this._behaviorInstances[r].LoadFromJson(i,t)}}const i=e.data;i&&(this._sdkInst?this._sdkInst.LoadFromJson(i,t):this._iScriptInterface._loadFromJson(i))}MoveToLayerWithSID(e){if(this._worldInfo.GetLayer().GetSID()===e)return;const t=this._worldInfo.GetLayer(),s=t.GetLayout().GetLayerBySID(e);s&&(this._worldInfo._SetLayer(s),t._RemoveInstance(this,!0),s._AddInstance(this,!0),s.SetZIndicesChanged(this),this._worldInfo.SetBboxChanged())}GetInterfaceClass(){return this._iScriptInterface||this._InitUserScriptInterface()}HasScriptInterface(){return!!this._iScriptInterface}_InitUserScriptInterface(e,t){const s=this._worldInfo?e?self.ISDKWorldInstanceBase:self.IWorldInstance:e?self.ISDKInstanceBase:self.IInstance,i=e||this._sdkInst.GetScriptInterfaceClass(),r=this._objectType._GetUserScriptInstanceClass(),n=r||i||s,a=this.GetPlugin().GetSdkVersion();if(yx.AddonManager._PushInitObject(this,a),yx.AddonManager._PushInitProperties(t),this._iScriptInterface=new n,yx.AddonManager._PopInitProperties(),yx.AddonManager._PopInitObject(a),i&&!(this._iScriptInterface instanceof s))throw new TypeError(`script interface class '${i.name}' does not extend the right base class '${s.name}'`);if(r){const e=i||s;if(!(this._iScriptInterface instanceof e))throw new TypeError(`setInstanceClass(): class '${r.name}' does not extend the right base class - check it extends the right class, e.g. globalThis.InstanceType.MyObjectName`)}return this._iScriptInterface}_GetInstVarsScriptDescriptor(e){if(0===this._instVarValues.length)return;const t={},s=this._objectType._GetAllInstanceVariableJsPropNames();for(let e=0,i=s.length;e<i;++e)t[s[e]]={configurable:!1,enumerable:!0,get:yx.Instance.prototype._GetInstanceVariableTypedValue.bind(this,e),set:yx.Instance.prototype.SetInstanceVariableValue.bind(this,e)};const i=Object.create(Object.prototype,t);e.instVars={value:i,writable:!1}}_GetBehaviorsScriptDescriptor(e){const t=this._behaviorInstances;if(0===t.length)return;const s={};for(const e of t)s[e.GetBehaviorType().GetJsPropName()]={value:e.GetScriptInterface(),writable:!1};const i=Object.create(Object.prototype,s);e.behaviors={value:i,writable:!1}}DispatchUserScriptEvent(e){if(!this.HasScriptInterface())return;const t=this.GetInterfaceClass();e.instance=t;const s=this._runtime,i=s.IsDebug()&&!s.GetEventSheetManager().IsInEventEngine();i&&Ix.StartMeasuringScriptTime(),t.dispatchEvent(e),i&&Ix.AddScriptTime()}}}{const Bx=self.C3,kx=new Map;Bx.SceneGraphInfo=class extends Bx.DefendedBase{constructor(e){super(),this._owner=e,this._parent=null,this._children=[],this._startWidth=e.GetWidth(),this._startHeight=e.GetHeight(),this._startScaleX=1,this._startScaleY=1,this._parentStartAngle=0,this._ownOpacity=1,this._startOpacity=e.GetOpacity(),this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null,this._indexInParent=NaN,this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN,this._on_instance_create=t=>{if(t.instance!==this._parent.GetInstance())return;e.GetRuntime().Dispatcher().removeEventListener("instancecreate",this._on_instance_create);const s=this._parent.GetInstance().GetSdkInstance();this._originalSizeKnown=!!s.IsOriginalSizeKnown(),this._originalWidth=this._originalSizeKnown?s.GetOriginalWidth():NaN,this._originalHeight=this._originalSizeKnown?s.GetOriginalHeight():NaN}}Release(){this._parent=null,this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null,this._indexInParent=NaN,this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN,Bx.clearArray(this._children)}SetParent(e){if(this._ownOpacity=this._owner.GetOpacity(),this._startOpacity=this._ownOpacity,this._parent=e,this._parentStartAngle=e?e.GetAngle():0,this._parent){const e=this._owner.GetRuntime();if(this._parent.GetInstance().GetPlugin().GetSdkVersion()<2){const t=this._parent.GetInstance().GetSdkInstance();t?(this._originalSizeKnown=!!t.IsOriginalSizeKnown(),this._originalWidth=this._originalSizeKnown?t.GetOriginalWidth():NaN,this._originalHeight=this._originalSizeKnown?t.GetOriginalHeight():NaN):this._parent.GetInstance().IsDestroyed()||e.Dispatcher().addEventListener("instancecreate",this._on_instance_create)}else this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN}else this._originalSizeKnown=!1,this._originalWidth=NaN,this._originalHeight=NaN}GetParent(){return this._parent}HasChildren(){return this._children.length>0}GetChildren(){return this._children}_MaybeSortChildren(){this.HasChildren()&&1!==this._children.length&&(this._tmpSceneGraphChildrenIndexes?this._children.sort((e,t)=>{const s=this._tmpSceneGraphChildrenIndexes.get(e.GetInstance()),i=this._tmpSceneGraphChildrenIndexes.get(t.GetInstance());return Bx.IsFiniteNumber(s)&&Bx.IsFiniteNumber(i)?s-i:0}):this._children.sort((e,t)=>{const s=e._GetSceneGraphInfo()._GetIndexInParent(),i=t._GetSceneGraphInfo()._GetIndexInParent();return Bx.IsFiniteNumber(s)&&Bx.IsFiniteNumber(i)?s-i:0}))}_GetIndexInParent(){return this._indexInParent}GetStartScaleX(){return this._startScaleX}SetStartScaleX(e){this._startScaleX=e}GetStartScaleY(){return this._startScaleY}SetStartScaleY(e){this._startScaleY=e}GetStartOpacity(){return this._startOpacity}GetOwnOpacity(){return this._ownOpacity}SetOwnOpacity(e){this._ownOpacity=e}_GetStartWidth(){return 0===this._startWidth?Number.EPSILON:this._startWidth}_GetStartHeight(){return 0===this._startHeight?Number.EPSILON:this._startHeight}GetParentScaleX(){if(this._owner.GetTransformWithParentWidth()){const e=this._parent;let t=e.GetWidth(),s=e._GetSceneGraphInfo()._GetStartWidth();return 0===t&&(t=Number.EPSILON),s===Number.EPSILON&&t===Number.EPSILON?1:s===Number.EPSILON&&t!==Number.EPSILON&&this._originalSizeKnown?1+t/this._originalWidth:t/s}return 1}GetParentScaleY(){if(this._owner.GetTransformWithParentHeight()){const e=this._parent;let t=e.GetHeight(),s=e._GetSceneGraphInfo()._GetStartHeight();return 0===t&&(t=Number.EPSILON),s===Number.EPSILON&&t===Number.EPSILON?1:s===Number.EPSILON&&t!==Number.EPSILON&&this._originalSizeKnown?1+t/this._originalHeight:t/s}return 1}GetParentStartAngle(){return 0}_SaveToJsonProperties(){return{sw:this._startWidth,sh:this._startHeight,sx:this._startScaleX,sy:this._startScaleY,psa:this._parentStartAngle,oo:this._ownOpacity,so:this._startOpacity,pi:this._owner.GetInstance().GetIndexInParent()}}_SaveToJson(e,t=null){const s=this._SaveToJsonProperties();return t&&t.selfOnly?Object.assign(s,{p:null,c:[]}):Object.assign(s,{p:this._GetParentJson(e),c:this._GetChildrenJson(e)})}_GetFlagsString(e){let t="";return e.GetTransformWithParentX()&&(t+="x"),e.GetTransformWithParentY()&&(t+="y"),e.GetTransformWithParentWidth()&&(t+="w"),e.GetTransformWithParentHeight()&&(t+="h"),e.GetTransformWithParentAngle()&&(t+="a"),e.GetTransformWithParentZElevation()&&(t+="z"),e.GetDestroyWithParent()&&(t+="d"),e.GetTransformWithParentOpacity()&&(t+="o"),e.GetTransformWithParentVisibility()&&(t+="v"),t}_GetParentJson(e){return this._parent?!this._parent.GetInstance()||this._parent.GetInstance().IsDestroyed()?null:this._GetInstanceJson(this._parent,this._owner,e):null}_GetChildrenJson(e){return this._children.map(t=>this._GetInstanceJson(t,t,e)).filter(e=>e)}_GetInstanceJson(e,t,s){const i=e.GetInstance();if(i&&i.IsDestroyed())return null;const r={};return r.uid=i.GetUID(),r.f=this._GetFlagsString(t),r.offsets=t._SaveSceneGraphPropertiesToJson(),r.data=Bx.SceneGraphInfo.GetSceneGraphInstanceDataFromInstance(i),r.oci=i.GetObjectClass().GetIndex(),"state"===s?(r.inst=i.SaveToJson("full",{selfOnly:!0}),r.instIndex=NaN):(r.instIndex=i.GetObjectClass().GetInstances().indexOf(i),r.inst=null),r}_LoadFromJson(e){this._startWidth=e.sw,this._startHeight=e.sh,this._startScaleX=e.sx,this._startScaleY=e.sy,this._parentStartAngle=e.psa,this._ownOpacity=e.oo,this._startOpacity=e.so,this._indexInParent=Bx.IsFiniteNumber(e.pi)?e.pi:NaN}_SetTmpSceneGraphChildren(e,t,s,i){if(!e&&!t)if(i?.setFromJson){if(this._tmpSceneGraphChildren)for(const e of this._tmpSceneGraphChildren)e.IsDestroyed()||e.HasParent()||e.GetRuntime().DestroyInstance(e)}else if(this._tmpSceneGraphChildren)for(const e of this._tmpSceneGraphChildren)if(s.c&&s.c.length){if(!s.c.some(t=>t.uid===e.GetUID()))continue;e.IsDestroyed()||e.HasParent()||e.GetRuntime().DestroyInstance(e)}this._tmpSceneGraphChildren=e,this._tmpSceneGraphChildrenIndexes=t}_GetInstanceByUID(e){const t=this._owner.GetRuntime();return kx.has(e)?kx.get(e):t.GetInstanceByUID(e)}_OnAfterLoad(e,t){const s=this._owner,i=s.GetRuntime(),r=t?.processedWorldInfo??new Set;if(e.p&&!this._parent){const n=e.p.uid,a=this._GetInstanceByUID(n);if(a){const n=a.GetWorldInfo();a.HasChild(s.GetInstance())?this._parent=n:(a.HasChildWithUID(s.GetInstance().GetUID())?(i.DestroyInstance(s.GetInstance()),i._RemoveInstanceFromUIDMap(s.GetInstance().GetUID()),kx.delete(s.GetInstance().GetUID())):a.AddChild(s.GetInstance(),this._GetFlagsObj(e.p.f)),r.has(s)||(s._LoadSceneGraphPropertiesFromJson(e.p.offsets),this._LoadInstancePropertiesFromJson(a,e.p,t),this._UpdateUIDInstanceMap(a,a.GetUID(),s.GetRuntime(),t)),r.add(s),a.GetWorldInfo()._GetSceneGraphInfo()._MaybeSortChildren())}else if(Bx.IsFiniteNumber(e.p.oci)){const r=i.CreateInstance(i.GetObjectClassByIndex(e.p.oci),s.GetLayer(),0,0,!0);if(r){const n=this._GetInstanceData(e.p,i);n&&r.LoadFromJson(n);const a=r.GetWorldInfo(),o=!!t?.setFromJson;a.GetLayer().SortAndAddInstancesByZIndex(r,!1,o),r.AddChild(s.GetInstance(),this._GetFlagsObj(e.p.f)),kx.set(r.GetUID(),r),this._UpdateUIDInstanceMap(r,r.GetUID(),i,t),r.GetWorldInfo()._GetSceneGraphInfo()._MaybeSortChildren()}}}const n=[];for(const t of e.c){const e=t.uid,s=this._GetInstanceByUID(e);s&&n.push(s)}let a=0;for(const o of e.c){const h=o.uid,l=this._GetInstanceByUID(h);if(l){if(this._tmpSceneGraphChildren){if(this._tmpSceneGraphChildren.includes(l)){const i=l;if(i.GetObjectClass()!==l.GetObjectClass()){a++;continue}if(i.IsDestroyed()){a++;continue}const o=e.c[a];if(!t?.setFromJson&&this._HasAllChildrenOfType(i,n,s)){if(s.GetInstance().GetChildAt(a)){const n=i.GetObjectClass().GetIndex(),h=o.oci,l=s.GetInstance().GetChildAt(a).GetObjectClass().GetIndex();if(n!==h||h!==l){this._RefreshAllChildren(e.c,s,r,t);break}this._UpdateInstance(a,o,s,r,t)}else this._UpdateInstance(a,o,s,r,t);a++;continue}if(i.HasParent()&&i.GetParent()!==s.GetInstance()){const e=this._CreateNewChildInstance(o,t);this._AddAndSetChildInstance(e,o,r,t),a++;continue}this._AddAndSetChildInstance(i.GetWorldInfo(),o,r,t,!0),a++;continue}if(this._tmpSceneGraphChildren[a]){const i=this._tmpSceneGraphChildren[a];if(i.GetObjectClass()!==l.GetObjectClass()){a++;continue}if(i.IsDestroyed()){a++;continue}const o=e.c[a];if(!t?.setFromJson&&this._HasAllChildrenOfType(i,n,s)){if(s.GetInstance().GetChildAt(a)){const n=i.GetObjectClass().GetIndex(),h=o.oci,l=s.GetInstance().GetChildAt(a).GetObjectClass().GetIndex();if(n!==h||h!==l){this._RefreshAllChildren(e.c,s,r,t);break}this._UpdateInstance(a,o,s,r,t)}else this._UpdateInstance(a,o,s,r,t);a++;continue}if(i.HasParent()&&i.GetParent()!==s.GetInstance()){const e=this._CreateNewChildInstance(o,t);this._AddAndSetChildInstance(e,o,r,t),a++;continue}this._AddAndSetChildInstance(i.GetWorldInfo(),o,r,t,!0),a++;continue}}const i=l.GetObjectClass();if(this._GetInstancesOfObjectClassCount(n,i)===s.GetInstance().GetChildrenOfObjectClass(i).length){for(const e of s.GetInstance().GetChildren()){if(e.GetObjectClass()!==i)continue;const s=e.GetWorldInfo();if(s&&!r.has(s)){r.add(s),s._LoadSceneGraphPropertiesFromJson(o.offsets),this._LoadInstancePropertiesFromJson(e,o,t);break}}a++;continue}if(l.HasParent()&&l.GetParent()!==s.GetInstance()){const e=this._CreateNewChildInstance(o,t);this._AddAndSetChildInstance(e,o,r,t),a++;continue}this._AddAndSetChildInstance(l.GetWorldInfo(),o,r,t)}else if(this._tmpSceneGraphChildren&&this._tmpSceneGraphChildren[a]){const h=this._tmpSceneGraphChildren[a],l=i.GetObjectClassByIndex(this._GetObjectClassIndex(o));if(h.GetObjectClass()!==l){a++;continue}if(h.IsDestroyed()){a++;continue}const c=e.c[a];if(!t?.setFromJson&&this._HasAllChildrenOfType(h,n,s)){if(s.GetInstance().GetChildAt(a)){const i=h.GetObjectClass().GetIndex(),n=c.oci,o=s.GetInstance().GetChildAt(a).GetObjectClass().GetIndex();if(i!==n||n!==o){this._RefreshAllChildren(e.c,s,r,t);break}this._UpdateInstance(a,c,s,r,t)}else this._UpdateInstance(a,c,s,r,t);a++;continue}if(h.HasParent()&&h.GetParent()!==s.GetInstance()){const e=this._CreateNewChildInstance(c,t);this._AddAndSetChildInstance(e,c,r,t),a++;continue}this._AddAndSetChildInstance(h.GetWorldInfo(),c,r,t)}else{const e=this._CreateNewChildInstance(o,t);this._AddAndSetChildInstance(e,o,r,t)}a++}}_RefreshAllChildren(e,t,s,i){const r=t.GetRuntime();for(const e of t.GetInstance().children())e&&!e.IsDestroyed()&&(r.DestroyInstance(e),r._RemoveInstanceFromUIDMap(e.GetUID()),kx.delete(e.GetUID()));this._tmpSceneGraphChildren&&(this._tmpSceneGraphChildren=[]),this._tmpSceneGraphChildrenIndexes&&(this._tmpSceneGraphChildrenIndexes=new WeakMap),Object.assign({},i,{assignZIndex:!1});for(const t of e){const e=this._CreateNewChildInstance(t,i);this._AddAndSetChildInstance(e,t,s,i),this._tmpSceneGraphChildren.push(e.GetInstance()),this._tmpSceneGraphChildrenIndexes.set(e.GetInstance(),this._tmpSceneGraphChildren.length-1)}t._GetSceneGraphInfo()._MaybeSortChildren()}_HasAllChildrenOfType(e,t,s){const i=e.GetObjectClass();return this._GetInstancesOfObjectClassCount(t,i)===s.GetInstance().GetChildrenOfObjectClass(i).length}_UpdateInstance(e,t,s,i,r){const n=s.GetInstance().GetChildAt(e);if(!n)return;const a=n.GetWorldInfo();a&&(i.has(a)||(a._LoadSceneGraphPropertiesFromJson(t.offsets),this._LoadInstancePropertiesFromJson(n,t,r)),i.add(a))}_GetFlagsObj(e){const t={};return t.transformX=e.includes("x"),t.transformY=e.includes("y"),t.transformWidth=e.includes("w"),t.transformHeight=e.includes("h"),t.transformAngle=e.includes("a"),t.transformZElevation=e.includes("z"),t.destroyWithParent=e.includes("d"),t.transformOpacity=e.includes("o"),t.transformVisibility=e.includes("v"),t}_GetObjectClassIndex(e){return Bx.IsFiniteNumber(e.oci)?e.oci:e[1]}_CreateNewChildInstance(e,t){if(!Bx.IsFiniteNumber(e.oci))return;const s=this._owner,i=s.GetRuntime();let r;const n=!t.hasOwnProperty("createHierarchy")||t.createHierarchy;if(r=e.data?i.CreateInstanceFromData(e.data,s.GetLayer(),!1,0,0,!1,n):i.CreateInstance(i.GetObjectClassByIndex(e.oci),s.GetLayer(),0,0,n),!r)return;const a=this._GetInstanceData(e,i);a&&r.LoadFromJson(a);const o=r.GetWorldInfo(),h=!!t?.setFromJson;return o.GetLayer().SortAndAddInstancesByZIndex(r,!0,h),o}_UpdateUIDInstanceMap(e,t,s,i){if(this._GetInstanceByUID(t)&&!i?.setFromJson){const i=this._GetInstanceByUID(t);i!==e&&s.DestroyInstance(i)}s._RemoveInstanceFromUIDMap(t),s._MapInstanceByUID(t,e)}_AddAndSetChildInstance(e,t,s,i,r=!0){const n=this._owner,a=n.AddChild(e,this._GetFlagsObj(t.f));a&&r?(s.has(e)||(e._LoadSceneGraphPropertiesFromJson(t.offsets),this._LoadInstancePropertiesFromJson(e.GetInstance(),t,i)),s.add(e)):a&&(kx.set(e.GetInstance().GetUID(),e.GetInstance()),this._UpdateUIDInstanceMap(e.GetInstance(),t.uid,n.GetRuntime(),i)),this._MaybeSortChildren()}_LoadInstancePropertiesFromJson(e,t,s){let i=this._GetInstanceData(t,this._owner.GetRuntime());if(!i)return;const r=!s.hasOwnProperty("clearChildren")||s.clearChildren,n=!s.hasOwnProperty("assignZIndex")||s.assignZIndex,a=e.GetRuntime();if(kx.set(e.GetUID(),e),i=JSON.parse(JSON.stringify(i)),r&&e.GetUID()!==i.uid){for(const t of e.children())t&&!t.IsDestroyed()&&(a.DestroyInstance(t),a._RemoveInstanceFromUIDMap(t.GetUID()),kx.delete(t.GetUID()));if(i.w?.sgi&&i.w.sgi.c?.length)for(const t of i.w.sgi.c){const i=Object.assign({},s,{clearChildren:!1,createHierarchy:!1}),r=this._CreateNewChildInstance(t,i);kx.set(r.GetInstance().GetUID(),r.GetInstance()),e.AddChild(r.GetInstance(),this._GetFlagsObj(t.f)),r._LoadSceneGraphPropertiesFromJson(t.offsets),this._LoadInstancePropertiesFromJson(r.GetInstance(),t,i)}}const o=i.w?.zi,h=i.w?.l;i.w=null,e.LoadFromJson(i),s?.setFromJson||(Bx.IsFiniteNumber(o)&&n&&e.GetWorldInfo()._SetZIndex(o),Bx.IsFiniteNumber(h)&&e.MoveToLayerWithSID(h)),this._UpdateUIDInstanceMap(e,i.uid,a,s)}_GetInstancesOfObjectClassCount(e,t){return e.filter(e=>e.GetObjectClass().GetName()===t.GetName()).length}_GetInstanceData(e,t){if(Bx.IsFiniteNumber(e.instIndex)){const s=t.GetObjectClassByIndex(e.oci)._GetLoadInstancesJson();return s?s[e.instIndex]:null}return Bx.IsString(e.inst)?JSON.parse(e.inst):e.inst?e.inst:void 0}static GetSceneGraphInstanceDataFromInstance(e){let t=e.GetWorldInfo().GetLayer().GetInitialInstanceData(e.GetUID());if(!t)return null;t=JSON.parse(JSON.stringify(t));const s=[];for(const t of[...e.GetChildren()]){const e=t.GetWorldInfo();s.push([e.GetLayout().GetSID(),e.GetLayer().GetIndex(),t.GetUID(),Bx.SceneGraphInfo._GetFlagsNumber(e),t.GetObjectClass().IsInContainer()?1:0,e.GetZIndex(),Bx.SceneGraphInfo.GetSceneGraphInstanceDataFromInstance(t)])}return Bx.IsArray(t[0][14])?t[0][14][1]=s:(t[0][14]=[],t[0][14][0]=Bx.SceneGraphInfo._GetDefaultFlagsNumber(),t[0][14][1]=s,t[0][14][2]=e.GetWorldInfo().GetZIndex()),t}static _GetFlagsNumber(e){let t=0;return t|=Number(e.GetTransformWithParentVisibility())<<8,t|=Number(e.GetTransformWithParentOpacity())<<7,t|=Number(e.GetTransformWithParentZElevation())<<6,t|=Number(e.GetDestroyWithParent())<<5,t|=Number(e.GetTransformWithParentAngle())<<4,t|=Number(e.GetTransformWithParentHeight())<<3,t|=Number(e.GetTransformWithParentWidth())<<2,t|=Number(e.GetTransformWithParentY())<<1,t|=0|Number(e.GetTransformWithParentX()),t}static _GetDefaultFlagsNumber(e){let t=0;return t|=256,t|=128,t|=64,t|=32,t|=16,t|=8,t|=4,t|=2,t|=1,511}static ClearUpdatedInstances(){kx.clear()}}}{const Lx=self.C3,Nx=self.glMatrix,Wx=Nx.vec3,Ux=Nx.vec4,Vx=Lx.New(Lx.Rect),Hx=Lx.New(Lx.Quad),jx=Lx.New(Lx.Event,"bboxchange",!1),zx=Lx.New(Lx.Color,0,0,0,0),Xx=Lx.New(Lx.CollisionPoly),Yx=Lx.New(Lx.Color,1,1,1,1),qx=Lx.New(Lx.Rect,0,0,-1,-1),Kx=Lx.New(Lx.Rect,0,0,-1,-1),$x=new Set(["absolute","relative"]),Jx=[];let Zx=!0;const Qx=1,ew=2,tw=4,sw=8,iw=16,rw=32,nw=64,aw=128,ow=256,hw=512,lw=1024,cw=2048,uw=4096,dw=8192,_w=16384,pw=32768,fw=1<<22,mw=1<<23,gw=12647936,Sw=65536,Gw=1<<17,yw=1<<18,Iw=1<<19,Tw=1<<20,Cw=1<<21,bw=1<<24,xw=26,ww=31<<26,Pw=new WeakMap,Rw=new WeakMap;Lx.WorldInfo=class extends Lx.DefendedBase{constructor(e,t){super(),this._inst=e,this._objectClass=e.GetObjectClass(),this._runtime=e.GetRuntime(),this._layer=t,this._objectClass._OnWorldInstanceLayerChanged(this,null,t),this._zIndex=-1,this._htmlZIndex=-1,this._flags=196635,this._objectClass.GetPlugin().IsRotatable()&&(this._flags|=128),this._x=NaN,this._y=NaN,this._zElevation=NaN,this._w=NaN,this._h=NaN,this._depth=NaN,this._a=NaN,this._sinA=NaN,this._cosA=NaN,this._ox=NaN,this._oy=NaN,this._boundingBox=Lx.New(Lx.Rect),this._boundingQuad=Lx.New(Lx.Quad),this._collisionCells=Kx,this._renderCells=qx,this._sourceCollisionPoly=null,this._transformedPolyInfo=null,this._solidFilterTags=null,this._color=Yx,this._colorPremultiplied=Yx,this._stateGroup=null,this._instanceEffectList=null,this._inst.GetObjectClass().UsesEffects()&&(this._instanceEffectList=Lx.New(Lx.InstanceEffectList,this._inst,this)),this._sceneGraphInfo=null,this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null,this._tmpHierarchyPosition=-1,this._meshInfo=null}_MarkDestroyed(){this._flags|=256}IsDestroyed(){return!!(256&this._flags)}Release(){if(this._objectClass._OnWorldInstanceLayerChanged(this,this._layer,null),this._stateGroup&&(this._runtime.GetRenderer().ReleaseStateGroup(this._stateGroup),this._stateGroup=null),this._sourceCollisionPoly=null,this._transformedPolyInfo&&(this._transformedPolyInfo.poly.Release(),this._transformedPolyInfo=null),this._solidFilterTags&&(this._solidFilterTags.clear(),this._solidFilterTags=null),this.ReleaseMesh(),this._instanceEffectList&&this._instanceEffectList.Release(),this.HasParent()&&this.GetParent().RemoveChild(this),this.HasChildren()){const e=[...this.GetChildren()];for(const t of e)this.RemoveChild(t)}this._ReleaseSceneGraphInfo(),this._ReleaseTmpSceneGraphInfo(),Pw.delete(this),Rw.delete(this),this._inst=null,this._objectClass=null,this._runtime=null,this._layer=null}Init(e){if(Zx=!1,this.SetXY(e[0],e[1]),this.SetZElevation(e[2]),this.SetSize(e[3],e[4]),this._depth=0,this.IsRotatable()?this.SetAngle(e[6]):this._a=0,zx.setFromJSON(e[7]),this._SetColor(zx),this.SetOriginX(e[8]),this.SetOriginY(e[9]),this.SetBlendMode(e[10]),this._instanceEffectList&&this._instanceEffectList._LoadEffectParameters(e[12]),e[14]&&Pw.set(this,{childrenData:e[14][1],zIndexData:e[14][2]}),e[15]){const t=e[15];this.CreateMesh(t[0],t[1]);const s=this.GetSourceMesh(),i=t[2];for(let e=0,t=i.length;e<t;++e){const t=i[e];for(let i=0,r=t.length;i<r;++i){const r=t[i],n=s.GetMeshPointAt(i,e);n.SetX(r[0]),n.SetY(r[1]),n.SetZElevation(r[2]),n.SetU(r[3]),n.SetV(r[4])}}}if(e[16]){const t=e[16][0],s=e[16][1],i=!!s,r=!i,n=this._runtime.GetTemplateManager();i&&n&&n.MapInstanceToTemplateName(this.GetInstance(),s),r&&n&&n.MapInstanceToTemplateName(this.GetInstance(),t)}Zx=!0,this._UpdateRendererStateGroup()}InitNoData(){this._x=0,this._y=0,this._zElevation=0,this._w=0,this._h=0,this._depth=0,this._a=0,this._sinA=0,this._cosA=1,this._ox=0,this._oy=0,this._UpdateRendererStateGroup()}GetRuntime(){return this._runtime}GetObjectClass(){return this._objectClass}GetInstance(){return this._inst}_GetParentOffsetAngle(){return this.GetTransformWithParentAngle()?this._MaybeReflectAngleForMirrorFlip(this.GetParent()._GetAngleNoReflect()-this._sceneGraphInfo.GetParentStartAngle()):0}SetX(e){if(e=+e,this.GetTransformWithParentX()){const t=this._sceneGraphInfo,s=e-this.GetX(),i=-this._GetParentOffsetAngle();0===i?this._x+=s/t.GetParentScaleX():(this._x+=Math.cos(i)*s/t.GetParentScaleX(),this.GetTransformWithParentY()&&(this._y+=Math.sin(i)*s/t.GetParentScaleY()))}else this._x=e}OffsetX(e,t=!1){e=+e,t?this._x+=e:this.GetTransformWithParentX()?this.SetX(this.GetX()+e):this._x+=e}GetX(){if(this.GetTransformWithParentX()){let e=this._x;const t=this._sceneGraphInfo,s=this.GetParent(),i=this._GetParentOffsetAngle();return 0===i?e*=t.GetParentScaleX():(e=e*t.GetParentScaleX()*Math.cos(i),this.GetTransformWithParentY()&&(e-=this._y*t.GetParentScaleY()*Math.sin(i))),s.GetX()+e}return this._x}SetY(e){if(e=+e,this.GetTransformWithParentY()){const t=this._sceneGraphInfo,s=e-this.GetY(),i=-this._GetParentOffsetAngle();0===i?this._y+=s/t.GetParentScaleY():(this.GetTransformWithParentX()&&(this._x-=Math.sin(i)*s/t.GetParentScaleX()),this._y+=Math.cos(i)*s/t.GetParentScaleY())}else this._y=e}OffsetY(e,t=!1){e=+e,t?this._y+=e:this.GetTransformWithParentY()?this.SetY(this.GetY()+e):this._y+=e}GetY(){if(this.GetTransformWithParentY()){let e=this._y;const t=this._sceneGraphInfo,s=this.GetParent(),i=this._GetParentOffsetAngle();return 0===i?e*=t.GetParentScaleY():(e=e*t.GetParentScaleY()*Math.cos(i),this.GetTransformWithParentX()&&(e+=this._x*t.GetParentScaleX()*Math.sin(i))),s.GetY()+e}return this._y}SetXY(e,t){if(e=+e,t=+t,this.GetTransformWithParentXOrY()){const s=this.GetTransformWithParentX(),i=this.GetTransformWithParentY(),r=this._sceneGraphInfo,n=e-this.GetX(),a=t-this.GetY(),o=-this._GetParentOffsetAngle();if(0===o)s?this._x+=n/r.GetParentScaleX():this._x=e,i?this._y+=a/r.GetParentScaleY():this._y=t;else{const h=Math.sin(o),l=Math.cos(o);s?this._x+=i?(l*n-h*a)/r.GetParentScaleX():l*n/r.GetParentScaleX():this._x=e,i?this._y+=s?(h*n+l*a)/r.GetParentScaleY():l*a/r.GetParentScaleY():this._y=t}}else this._x=e,this._y=t}GetXY(){return[this.GetX(),this.GetY()]}OffsetXY(e,t){e=+e,t=+t,this.GetTransformWithParentXOrY()?this.SetXY(this.GetX()+e,this.GetY()+t):(this._x+=e,this._y+=t)}EqualsXY(e,t){return this.GetX()===e&&this.GetY()===t}SetZElevation(e){if(e=+e,this.GetTransformWithParentZElevation()&&(e-=this.GetParent().GetZElevation()),this._zElevation===e)return;this._zElevation=e,this._UpdateZElevation();const t=this.GetLayer();0!==this._zElevation&&t._SetAnyInstanceZElevated(),t.SetZIndicesChanged(this)}_UpdateZElevation(){if(this._UpdateRendererStateGroup(),this.HasChildren()){const e=this.GetChildren();for(let t=0,s=e.length;t<s;t++){const s=e[t];s.GetTransformWithParentZElevation()&&s._UpdateZElevation()}}}OffsetZElevation(e){this.SetZElevation(this.GetZElevation()+e)}GetZElevation(){return this.GetTransformWithParentZElevation()?this.GetParent().GetZElevation()+this._zElevation:this._zElevation}GetTotalZElevation(){return this.GetLayer().GetZElevation()+this.GetZElevation()}IsOriginalSizeKnown(){return this.GetInstance().GetPlugin().GetSdkVersion()<2&&this.GetInstance().GetSdkInstance().IsOriginalSizeKnown()}SetWidth(e){if(e=+e,this.GetTransformWithParentWidth()){const t=this.GetWidth();0===t?this._w=Number.EPSILON:this._w*=e/t}else this._w=e;this._MarkSinCosAngleChanged()}OffsetWidth(e,t){e=+e,t?this._w+=e:this.GetTransformWithParentWidth()?this.SetWidth(this.GetWidth()+e):this._w+=e,this._MarkSinCosAngleChanged()}GetWidth(){if(this.GetTransformWithParentWidth()){const e=this.GetParent(),t=e.GetWidth();return e._GetSceneGraphInfo()._GetStartWidth()===Number.EPSILON?(this._GetSceneGraphInfo()._GetStartWidth()+t)*this._w:t*this._w}return this._w}SetHeight(e){if(e=+e,this.GetTransformWithParentHeight()){const t=this.GetHeight();0===t?this._h=Number.EPSILON:this._h*=e/t}else this._h=e;this._MarkSinCosAngleChanged()}OffsetHeight(e,t){e=+e,t?this._h+=e:this.GetTransformWithParentHeight()?this.SetHeight(this.GetHeight()+e):this._h+=e,this._MarkSinCosAngleChanged()}GetHeight(){if(this.GetTransformWithParentHeight()){const e=this.GetParent(),t=e.GetHeight();return e._GetSceneGraphInfo()._GetStartHeight()===Number.EPSILON?(this._GetSceneGraphInfo()._GetStartHeight()+t)*this._h:t*this._h}return this._h}SetSize(e,t){if(e=+e,t=+t,this.GetTransformWithParentWidth()){const t=this.GetWidth();0===t?this._w=Number.EPSILON:this._w*=e/t}else this._w=e;if(this.GetTransformWithParentHeight()){const e=this.GetHeight();0===e?this._h=Number.EPSILON:this._h*=t/e}else this._h=t;this._MarkSinCosAngleChanged()}GetSize(){return[this.GetWidth(),this.GetHeight()]}GetDepth(){return this._depth}SetDepth(e){if(e<0)throw new RangeError("invalid depth");this._depth=e}GetSceneGraphScale(){if(this.HasParent()){const e=this._sceneGraphInfo;return Math.min(e.GetParentScaleX(),e.GetParentScaleY())}return 1}IsRotatable(){return!!(128&this._flags)}SetAngle(e){e=+e,this.IsRotatable()&&(this.GetTransformWithParentAngle()&&(e-=this.GetParent().GetAngle()),e=Lx.clampAngle(e),this._a!==e&&(this._a=e,this._MarkSinCosAngleChanged()))}OffsetAngle(e){0!==(e=+e)&&this.IsRotatable()&&(this._a=Lx.clampAngle(this._a+e),this._MarkSinCosAngleChanged())}_MarkSinCosAngleChanged(){if(this._flags|=262144,this.HasChildren()){const e=this.GetChildren();for(let t=0,s=e.length;t<s;t++)e[t]._MarkSinCosAngleChanged()}}GetAngle(){return this.GetTransformWithParentAngle()&&this.IsRotatable()?this._MaybeReflectAngleForMirrorFlip(Lx.clampAngle(this.GetParent()._GetAngleNoReflect()+this._a)):this._a}_GetAngleNoReflect(){return this.GetTransformWithParentAngle()&&this.IsRotatable()?Lx.clampAngle(this.GetParent()._GetAngleNoReflect()+this._a):this._a}_MaybeReflectAngleForMirrorFlip(e){return this.GetTransformWithParentWidth()&&this.GetTopParent().GetWidth()<0&&(e=Lx.clampAngle(Lx.angleReflect(e,this.GetTopParent().GetAngle()+Math.PI))),this.GetTransformWithParentHeight()&&this.GetTopParent().GetHeight()<0&&(e=Lx.angleReflect(e,this.GetTopParent().GetAngle())),e}_NeedsReflectAngleForMirrorOrFlip(){const e=this.GetParent();return!!(this.GetTransformWithParentWidth()&&e.GetWidth()<0)||!!(this.GetTransformWithParentHeight()&&e.GetHeight()<0)}_NeedsReflectAngleForMirrorAndFlip(){const e=this.GetParent();return!!(this.GetTransformWithParentWidth()&&e.GetWidth()<0&&this.GetTransformWithParentHeight()&&e.GetHeight()<0)}_MaybeUpdateSinCosAngle(){const e=this._flags;if(!(262144&e))return;const t=this.GetAngle();this._sinA=Math.sin(t),this._cosA=Math.cos(t),this._flags=-262145&e}GetSinAngle(){return this._MaybeUpdateSinCosAngle(),this._sinA}GetCosAngle(){return this._MaybeUpdateSinCosAngle(),this._cosA}SetOriginX(e){this._ox=+e}OffsetOriginX(e){this._ox+=+e}GetOriginX(){return this._ox}SetOriginY(e){this._oy=+e}OffsetOriginY(e){this._oy+=+e}GetOriginY(){return this._oy}_SetColor(e){this._color.equals(e)||(this._color===Yx?(this._color=Lx.New(Lx.Color,e),this._colorPremultiplied=Lx.New(Lx.Color,e),this._colorPremultiplied.premultiply()):e.equalsRgba(1,1,1,1)?(this._color=Yx,this._colorPremultiplied=Yx):(this._color.set(e),this._colorPremultiplied.set(e),this._colorPremultiplied.premultiply()),this._UpdateRendererStateGroup())}SetOpacity(e){if(e=Lx.clamp(+e,0,1),this.GetTransformWithParentOpacity()){if(this._GetSceneGraphInfo().GetOwnOpacity()===e)return;this._GetSceneGraphInfo().SetOwnOpacity(e),e=this.GetOpacity()}else if(this._color.a===e)return;this._SetColorWithOpacity(e)}_SetOpacityOfChildren(){if(!this.HasChildren())return;const e=this.GetChildren();for(let t=0,s=e.length;t<s;t++){const s=e[t];s._SetColorWithOpacity(s.GetOpacity())}}_SetColorWithOpacity(e){zx.copyRgb(this._color),zx.a=e,this._SetColor(zx),this._SetOpacityOfChildren()}OffsetOpacity(e){this.GetTransformWithParentOpacity()?this.SetOpacity(this._GetSceneGraphInfo().GetOwnOpacity()+e):this.SetOpacity(this.GetOpacity()+e)}GetOpacity(){return this.GetTransformWithParentOpacity()?this.GetParent().GetOpacity()*this._GetSceneGraphInfo().GetOwnOpacity():this._color.a}SetUnpremultipliedColor(e){this._color.equalsIgnoringAlpha(e)||(zx.copyRgb(e),zx.a=this.GetOpacity(),this._SetColor(zx))}SetUnpremultipliedColorRGB(e,t,s){zx.setRgb(e,t,s),this.SetUnpremultipliedColor(zx)}OffsetUnpremultipliedColorRGB(e,t,s){0===e&&0===t&&0===s||(zx.copyRgb(this._color),zx.r+=e,zx.g+=t,zx.b+=s,this.SetUnpremultipliedColor(zx))}GetUnpremultipliedColor(){return this._color}GetPremultipliedColor(){return this._colorPremultiplied}GetDestroyWithParent(){return!!(512&this._flags)}SetDestroyWithParent(e){this._SetFlag(512,e)}GetTransformWithParentX(){return!!(1024&this._flags)}SetTransformWithParentX(e){this._SetFlag(1024,e)}GetTransformWithParentY(){return!!(2048&this._flags)}GetTransformWithParentXOrY(){return!!(3072&this._flags)}SetTransformWithParentY(e){this._SetFlag(2048,e)}GetTransformWithParentWidth(){return!!(4096&this._flags)}SetTransformWithParentWidth(e){this._SetFlag(4096,e)}GetTransformWithParentHeight(){return!!(8192&this._flags)}SetTransformWithParentHeight(e){this._SetFlag(8192,e)}GetTransformWithParentAngle(){return!!(16384&this._flags)}SetTransformWithParentAngle(e){this._SetFlag(16384,e)}GetTransformWithParentZElevation(){return!!(32768&this._flags)}SetTransformWithParentZElevation(e){this._SetFlag(32768,e)}GetTransformWithParentOpacity(){return!!(4194304&this._flags)}SetTransformWithParentOpacity(e){this._SetFlag(4194304,e)}GetTransformWithParentVisibility(){return!!(8388608&this._flags)}SetTransformWithParentVisibility(e){this._SetFlag(8388608,e)}_ClearAllSceneGraphFlags(){this._flags&=-12647937}AddChild(e,t){if(e===this)return!1;if(e.HasParent())return!1;if(this._HasChildRecursive(e))return!1;if(this._HasAnyParent(e))return!1;const s=e.GetX(),i=e.GetY(),r=e.GetWidth(),n=e.GetHeight(),a=e.GetAngle(),o=e.GetZElevation(),h=e.GetOpacity();e._SetParent(this),e.SetTransformWithParentX(t.transformX),e.SetTransformWithParentY(t.transformY),e.SetTransformWithParentWidth(t.transformWidth),e.SetTransformWithParentHeight(t.transformHeight),e.SetTransformWithParentAngle(t.transformAngle),e.SetTransformWithParentZElevation(t.transformZElevation),e.SetTransformWithParentOpacity(t.transformOpacity),e.SetTransformWithParentVisibility(t.transformVisibility),e.SetDestroyWithParent(t.destroyWithParent);const l=s-this.GetX(),c=i-this.GetY(),u=-this.GetAngle(),d=Math.cos(u),_=Math.sin(u);if(t.transformX&&(t.transformAngle?e._x=l*d-c*_:e._x=l,t.transformWidth)){const t=this.GetWidth()/this._sceneGraphInfo._GetStartWidth();0!==t&&(e._x/=t)}if(t.transformY&&(t.transformAngle?e._y=l*_+c*d:e._y=c,t.transformHeight)){const t=this.GetHeight()/this._sceneGraphInfo._GetStartHeight();0!==t&&(e._y/=t)}if(t.transformWidth){const t=this.GetWidth();0===t||t===Number.EPSILON?(e._w=1,e._sceneGraphInfo.SetStartScaleX(1)):(e._w=r/this.GetWidth(),e._sceneGraphInfo.SetStartScaleX(e._w))}if(t.transformHeight){const t=this.GetHeight();0===t||t===Number.EPSILON?(e._h=1,e._sceneGraphInfo.SetStartScaleY(1)):(e._h=n/this.GetHeight(),e._sceneGraphInfo.SetStartScaleY(e._h))}return t.transformAngle&&(e._a=a-this.GetAngle()),t.transformZElevation&&(e._zElevation=o-this.GetZElevation()),t.transformOpacity&&e._sceneGraphInfo.SetOwnOpacity(h),t.transformVisibility&&e.SetVisible(this.IsVisible()),this._AddChildToSceneGraphInfo(e),this.SetBboxChanged(),this._SetOpacityOfChildren(),!0}RemoveChild(e){if(e.GetParent()!==this)return;const t=e.GetX(),s=e.GetY(),i=e.GetWidth(),r=e.GetHeight(),n=e.GetAngle(),a=e.GetZElevation(),o=e.GetOpacity();e._SetParent(null),e._ClearAllSceneGraphFlags(),e.SetXY(t,s),e.SetSize(i,r),e.SetAngle(n),e.SetZElevation(a),e.SetOpacity(o),this._RemoveChildFromSceneGraphInfo(e),this.SetBboxChanged()}GetTmpHierarchyPosition(){return this._tmpHierarchyPosition}_ResetAllSceneGraphState(){this._BuildTmpSceneGraphData();const e=[...this.children()];for(const t of e)this.RemoveChild(t);const t=this.GetParent();t&&t.RemoveChild(this),this._ClearAllSceneGraphFlags()}_BuildTmpSceneGraphData(){if(this._SetTmpHierarchyPosition(),!this._tmpSceneGraphChildren){const e=[...this.children()];e.length&&(this._tmpSceneGraphChildren=[],this._tmpSceneGraphChildrenIndexes=new WeakMap);let t=0;for(const s of e){const e=s.GetInstance();this._tmpSceneGraphChildren.push(e),this._tmpSceneGraphChildrenIndexes.set(e,t),t++}}const e=this.GetParent();e&&e._BuildTmpSceneGraphData()}_SetTmpHierarchyPosition(){if(-1!==this._tmpHierarchyPosition)return;const e=[...this.parents()];this._tmpHierarchyPosition=e.length;for(const t of e)t._SetTmpHierarchyPosition();const t=[...this.children()];for(const e of t)e._SetTmpHierarchyPosition()}_ReleaseTmpSceneGraphInfo(){this._tmpSceneGraphChildren&&(this._tmpSceneGraphChildren.length=0),this._tmpSceneGraphChildren=null,this._tmpSceneGraphChildrenIndexes=null;const e=this.GetParent();e&&e._ReleaseTmpSceneGraphInfo(),this._tmpHierarchyPosition=-1}HasParent(){return null!==this.GetParent()}GetParent(){const e=this._sceneGraphInfo;return null!==e?e.GetParent():null}GetTopParent(){let e=this;for(;e.HasParent();)e=e.GetParent();return e}*parents(){let e=this.GetParent();for(;e;)yield e,e=e.GetParent()}HasChild(e){return this.GetChildren().includes(e)}HasChildren(){const e=this._sceneGraphInfo;return null!==e&&e.HasChildren()}GetChildren(){const e=this._sceneGraphInfo;return null!==e?e.GetChildren():Jx}children(){return this.GetChildren()}*allChildren(){for(const e of this.children())yield e,yield*e.allChildren()}GetChildCount(){return this.GetChildren().length}GetAllChildCount(){return[...this.allChildren()].length}GetChildAt(e){const t=this.GetChildren();return(e=Math.floor(+e))<0||e>=t.length?null:t[e]}GetChildIndex(e){if(!e)return NaN;const t=this.GetChildren();if(!t)return NaN;for(let s=0;s<t.length;s++)if(e===t[s])return s;return NaN}_CreateSceneGraphInfo(e){this._sceneGraphInfo||(this._sceneGraphInfo=Lx.New(Lx.SceneGraphInfo,this)),e&&this._sceneGraphInfo.SetParent(e)}_GetSceneGraphInfo(){return this._sceneGraphInfo}_ReleaseSceneGraphInfo(){this._sceneGraphInfo&&(this._sceneGraphInfo.Release(),this._sceneGraphInfo=null)}_SetParent(e){e?(e._CreateSceneGraphInfo(null),this._CreateSceneGraphInfo(e)):(this._sceneGraphInfo&&this._sceneGraphInfo.SetParent(null),this.HasChildren()||this._ReleaseSceneGraphInfo())}_HasAnyParent(e){if(!this.HasParent())return!1;const t=this.GetParent();return t===e||t._HasAnyParent(e)}_HasChildRecursive(e){if(this.HasChild(e))return!0;for(const t of this.GetChildren())if(t._HasChildRecursive(e))return!0;return!1}_AddChildToSceneGraphInfo(e){this._sceneGraphInfo.GetChildren().push(e)}_RemoveChildFromSceneGraphInfo(e){const t=this._sceneGraphInfo.GetChildren(),s=t.indexOf(e);-1!==s&&t.splice(s,1),0!==t.length||this.HasParent()||this._ReleaseSceneGraphInfo(),e.HasChildren()||e._ReleaseSceneGraphInfo()}GetSceneGraphChildrenExportData(){const e=Pw.get(this);return e?e.childrenData:null}GetSceneGraphZIndexExportData(){const e=Pw.get(this);return e?e.zIndexData:NaN}GetSceneGraphZIndex(){const e=Rw.get(this);return Lx.IsFiniteNumber(e)?e:NaN}SetSceneGraphZIndex(e){Rw.set(this,e)}SetUsePointsShaderProgram(){this._SetFlag(524288,!0),this._UpdateRendererStateGroup()}_UpdateRendererStateGroup(){if(!Zx)return;const e=this._runtime.GetRenderer();let t;this._stateGroup&&e.ReleaseStateGroup(this._stateGroup),t=524288&this._flags?e.GetPointsRenderingProgram()||"<point>":e.GetTextureFillShaderProgram()||"<default>",this._stateGroup=e.AcquireStateGroup(t,this.GetBlendMode(),this._colorPremultiplied,this.GetZElevation(),this.IsBackFaceCulling()?1:0,0)}GetRendererStateGroup(){return this._stateGroup}HasDefaultColor(){return this._color===Yx}SetBlendMode(e){if((e|=0)<0||e>31)throw new RangeError("invalid blend mode");this.GetBlendMode()!==e&&(this._flags=-2080374785&this._flags|e<<26,this._UpdateRendererStateGroup())}GetBlendMode(){return(2080374784&this._flags)>>26}_SetLayer(e,t){const s=t&&this._layer!==e;s&&this._RemoveFromRenderCells(),this._objectClass._OnWorldInstanceLayerChanged(this,this._layer,e),this._layer=e,s&&this._UpdateRenderCell(),0!==this.GetZElevation()&&this._layer._SetAnyInstanceZElevated()}GetLayer(){return this._layer}GetLayout(){return this.GetLayer().GetLayout()}_SetZIndex(e){this._zIndex=0|e}GetZIndex(){return this._layer._UpdateZIndices(),this._zIndex}_SetHTMLZIndex(e){this._htmlZIndex=0|e}GetHTMLZIndex(){return this._layer._UpdateHTMLZIndices(),this._htmlZIndex}_GetLastCachedZIndex(){return this._zIndex}_SetFlag(e,t){t?this._flags|=e:this._flags&=~e}IsVisible(){return!!(1&this._flags)}SetVisible(e){if(this._SetFlag(1,e),this.HasChildren())for(const t of this.GetChildren())t.GetTransformWithParentVisibility()&&t.SetVisible(e)}IsCollisionEnabled(){return!!(8&this._flags)}SetCollisionEnabled(e){e=!!e,this.IsCollisionEnabled()!==e&&(this._SetFlag(8,e),e?this.SetBboxChanged():this._RemoveFromCollisionCells())}SetSolidCollisionFilter(e,t){this._SetFlag(32,e),this._solidFilterTags&&this._solidFilterTags.clear();for(const e of t)this._solidFilterTags||(this._solidFilterTags=new Set),this._solidFilterTags.add(e.toLowerCase());this._solidFilterTags&&0===this._solidFilterTags.size&&(this._solidFilterTags=null)}IsSolidCollisionAllowed(e){const t=e._IsSolidUsingInstanceTags()?e._GetLowercaseTagsSetMaybeNull():e.GetSavedDataMap().get("solidTags"),s=!!(32&this._flags),i=this._solidFilterTags;if(!t||!i)return!s;for(const e of i)if(t.has(e))return s;return!s}SetBboxChanged(){if(this._flags|=65554,this._objectClass._SetAnyCollisionCellChanged(!0),this._runtime.UpdateRender(),this._layer.UsesRenderCells()&&(this.CalculateBbox(this._boundingBox,this._boundingQuad,!0),this._flags&=-3,this._UpdateRenderCell()),4&this._flags&&this._inst.Dispatcher().dispatchEvent(jx),null!==this._sceneGraphInfo){const e=this._sceneGraphInfo.GetChildren();for(let t=0,s=e.length;t<s;++t)e[t].SetBboxChanged()}}CalculateBbox(e,t,s){const i=this.GetX(),r=this.GetY(),n=this.GetWidth(),a=this.GetHeight(),o=this.GetAngle();e.setWH(i-this._ox*n,r-this._oy*a,n,a),s&&this.HasMesh()&&this._ExpandBboxForMesh(e),0===o?t.setFromRect(e):(e.offset(-i,-r),t.setFromRotatedRectPrecalc(e,this.GetSinAngle(),this.GetCosAngle()),t.offset(i,r),t.getBoundingBox(e)),e.normalize()}_UpdateBbox(){const e=this._flags;2&e&&(this.CalculateBbox(this._boundingBox,this._boundingQuad,!0),this._flags=-3&e)}GetBoundingBox(){return this._UpdateBbox(),this._boundingBox}GetBoundingQuad(){return this._UpdateBbox(),this._boundingQuad}PixelRoundQuad(e){const t=this.GetX(),s=this.GetY(),i=Math.round(t)-t,r=Math.round(s)-s;return 0===i&&0===r?e:(Hx.copy(e),Hx.offset(i,r),Hx)}OverwriteBoundingBox(e){this._boundingBox.copy(e),this._boundingQuad.setFromRect(this._boundingBox),this._flags&=-3,this._UpdateCollisionCell(),this._UpdateRenderCell()}SetBboxChangeEventEnabled(e){this._SetFlag(4,e)}IsBboxChangeEventEnabled(){return!!(4&this._flags)}IsInViewport(e,t,s){return t&&0!==this.GetDepth()?this.IsInViewport3D(this.GetLayer()._GetViewFrustum()):0===this.GetZElevation()||s?e.intersectsRect(this.GetBoundingBox()):this._IsInViewport_ZElevated()}_IsInViewport_ZElevated(){const e=this.GetLayer(),t=this.GetTotalZElevation();return!(t>=e.Get2DCameraZ())&&(e.GetViewportForZ(t,Vx),Vx.intersectsRect(this.GetBoundingBox()))}IsInViewport3D(e){const t=this.GetBoundingBox(),s=t.getLeft(),i=t.getRight(),r=t.getTop(),n=t.getBottom(),a=this.GetTotalZElevation(),o=a+this.GetDepth();return e.ContainsAABB(s,r,a,i,n,o)}IsInViewport2(){const e=this.GetLayer();if(e.Has3DCamera())return this.IsInViewport3D(e._GetViewFrustum());{const t=e.GetLayout();return this.IsInViewport(e.GetViewport(),t.HasVanishingPointOutsideViewport(),t.IsOrthographicProjection())}}_SetDrawBackFaceOnly(e){this._SetFlag(1048576,e)}_SetDrawNonBackFacesOnly(e){this._SetFlag(2097152,e)}IsDrawBackFaceOnly(){return!!(1048576&this._flags)}IsDrawNonBackFacesOnly(){return!!(2097152&this._flags)}SetBackFaceCulling(e){(e=!!e)!==this.IsBackFaceCulling()&&(this._SetFlag(16777216,e),this._UpdateRendererStateGroup())}IsBackFaceCulling(){return!!(16777216&this._flags)}SetSourceCollisionPoly(e){this._sourceCollisionPoly=e,this._DiscardTransformedCollisionPoly(),this.HasMesh()&&(this._meshInfo.meshPoly=null)}GetSourceCollisionPoly(){return this._sourceCollisionPoly}HasOwnCollisionPoly(){return null!==this._sourceCollisionPoly||this.HasMesh()}GetTransformedCollisionPoly(){return this._GetCustomTransformedCollisionPolyPrecalc(this.GetWidth(),this.GetHeight(),this.GetAngle(),this.GetSinAngle(),this.GetCosAngle())}GetCustomTransformedCollisionPoly(e,t,s){let i=0,r=1;return 0!==s&&(i=Math.sin(s),r=Math.cos(s)),this._GetCustomTransformedCollisionPolyPrecalc(e,t,s,i,r)}_GetCustomTransformedCollisionPolyPrecalc(e,t,s,i,r){let n=this._transformedPolyInfo;null===n&&(n={poly:Lx.New(Lx.CollisionPoly),width:NaN,height:NaN,angle:NaN},this._transformedPolyInfo=n);const a=n.poly;if(n.width===e&&n.height===t&&n.angle===s)return a;const o=this._sourceCollisionPoly;if(this.HasMesh()){const s=this.GetOriginX(),n=this.GetOriginY(),h=this.GetSourceMesh();let l=this._meshInfo.meshPoly;l||(o?(Xx.copy(o),Xx.offset(s,n)):Xx.setDefaultPoints(),l=h.InsertPolyMeshVertices(Xx),this._meshInfo.meshPoly=l),h.TransformCollisionPoly(l,a),a.offset(-s,-n),a.transformPrecalc(e,t,i,r)}else o?(a.copy(o),a.transformPrecalc(e,t,i,r)):a.setFromQuad(this.GetBoundingQuad(),-this.GetX(),-this.GetY());return n.width=e,n.height=t,n.angle=s,a}_DiscardTransformedCollisionPoly(){this.SetPhysicsBodyChanged(!0);const e=this._transformedPolyInfo;null!==e&&(e.width=NaN)}CreateMesh(e,t){if(e=Math.floor(e),t=Math.floor(t),!this.GetInstance().GetPlugin().SupportsMesh())throw new Error("object does not support mesh");this.ReleaseMesh(),this._meshInfo={sourceMesh:Lx.New(Lx.Gfx.DeformMesh,e,t),transformedMesh:Lx.New(Lx.Gfx.DeformMesh,e,t),meshPoly:null}}HasMesh(){return null!==this._meshInfo}GetSourceMesh(){if(!this.HasMesh())throw new Error("no mesh");return this._meshInfo.sourceMesh}GetTransformedMesh(){if(!this.HasMesh())throw new Error("no mesh");return this._meshInfo.transformedMesh}SetMeshChanged(e){this._SetFlag(65536,e)}IsMeshChanged(){return!!(65536&this._flags)}SetPhysicsBodyChanged(e){this._SetFlag(131072,e)}IsPhysicsBodyChanged(){return!!(131072&this._flags)}_ExpandBboxForMesh(e){const t=this._meshInfo.sourceMesh,s=Math.min(t.GetMinX(),0),i=Math.min(t.GetMinY(),0),r=Math.max(t.GetMaxX(),1),n=Math.max(t.GetMaxY(),1),a=e.width(),o=e.height();e.offsetLeft(s*a),e.offsetTop(i*o),e.offsetRight((r-1)*a),e.offsetBottom((n-1)*o),this._depth=t.GetMaxZ()}ReleaseMesh(){this._meshInfo&&(this._meshInfo.sourceMesh.Release(),this._meshInfo.transformedMesh.Release(),this._meshInfo=null,this._DiscardTransformedCollisionPoly())}SetMeshPoint(e,t,s){e=Math.floor(e),t=Math.floor(t);const i=s.mode||"absolute";if(!$x.has(i))throw new Error("invalid mode");const r="relative"===i;let n=s.x,a=s.y;const o=s.zElevation;let h="number"==typeof s.u?s.u:r?0:-1,l="number"==typeof s.v?s.v:r?0:-1;if(!this.HasMesh())return!1;const c=this.GetSourceMesh(),u=c.GetMeshPointAt(e,t);if(null===u)return!1;let d=!1;return"number"==typeof o&&u.GetZElevation()!==o&&(u.SetZElevation(o),d=!0),r&&(n+=e/(c.GetHSize()-1),a+=t/(c.GetVSize()-1)),-1!==h||r?(r&&(h+=e/(c.GetHSize()-1)),h=Lx.clamp(h,0,1)):h=u.GetU(),-1!==l||r?(r&&(l+=t/(c.GetVSize()-1)),l=Lx.clamp(l,0,1)):l=u.GetV(),u.GetX()===n&&u.GetY()===a&&u.GetU()===h&&u.GetV()===l?d:(u.SetX(n),u.SetY(a),u.SetU(h),u.SetV(l),this._DiscardTransformedCollisionPoly(),!0)}HasTilemap(){return this._inst.HasTilemap()}ContainsPoint(e,t){return!!this.GetBoundingBox().containsPoint(e,t)&&!!this.GetBoundingQuad().containsPoint(e,t)&&(this.HasTilemap()?this._inst.GetSdkInstance().TestPointOverlapTile(e,t):!this.HasOwnCollisionPoly()||this.GetTransformedCollisionPoly().containsPoint(e-this.GetX(),t-this.GetY()))}_IsCollisionCellChanged(){return!!(16&this._flags)}_UpdateCollisionCell(){if(!this._IsCollisionCellChanged()||!this.IsCollisionEnabled()||this.IsDestroyed())return;const e=this.GetBoundingBox(),t=this._objectClass._GetCollisionCellGrid(),s=this._collisionCells;if(Vx.set(t.XToCell(e.getLeft()),t.YToCell(e.getTop()),t.XToCell(e.getRight()),t.YToCell(e.getBottom())),s.equals(Vx))return;const i=this._inst;s===Kx?(t.Update(i,null,Vx),this._collisionCells=Lx.New(Lx.Rect,Vx)):(t.Update(i,s,Vx),s.copy(Vx)),this._flags&=-17}_SetCollisionCellChanged(){this._flags|=16}_RemoveFromCollisionCells(){const e=this._collisionCells;e!==Kx&&(this._objectClass._GetCollisionCellGrid().Update(this._inst,e,null),this._collisionCells=Kx)}_UpdateRenderCell(){const e=this.GetLayer();if(!e.UsesRenderCells()||this.IsDestroyed())return;const t=e.GetRenderGrid(),s=this.GetBoundingBox(),i=this._renderCells;if(Vx.set(t.XToCell(s.getLeft()),t.YToCell(s.getTop()),t.XToCell(s.getRight()),t.YToCell(s.getBottom())),i.equals(Vx))return;const r=this._inst;i===qx?(t.Update(r,null,Vx),this._renderCells=Lx.New(Lx.Rect,Vx)):(t.Update(r,i,Vx),i.copy(Vx)),e.SetRenderListStale()}_RemoveFromRenderCells(){const e=this._renderCells;e!==qx&&(this.GetLayer().GetRenderGrid().Update(this._inst,e,null),this._renderCells=qx)}GetRenderCellRange(){return this._renderCells}ZOrderMoveToTop(){if(this.IsDestroyed())return;const e=this._inst,t=this._layer,s=t._GetInstances();s.length&&s.at(-1)===e||(t._RemoveInstance(e,!1),t._AddInstance(e,!1),this._runtime.UpdateRender())}ZOrderMoveToBottom(){if(this.IsDestroyed())return;const e=this._inst,t=this._layer,s=t._GetInstances();s.length&&s[0]===e||(t._RemoveInstance(e,!1),t._PrependInstance(e,!1),this._runtime.UpdateRender())}ZOrderMoveToLayer(e){if(this.IsDestroyed())return;const t=this._inst,s=this._layer;if(s.GetLayout()!==e.GetLayout())throw new Error("layer from different layout");e!==s&&(s._RemoveInstance(t,!0),this._SetLayer(e),e._AddInstance(t,!0),this._runtime.UpdateRender())}ZOrderMoveAdjacentToInstance(e,t){if(this.IsDestroyed())return;const s=this._inst;let i=!1;const r=this._layer;if(e.GetUID()===s.GetUID())return;const n=e.GetWorldInfo();if(!n)throw new Error("expected world instance");const a=n.GetLayer();r.GetIndex()!==a.GetIndex()&&(r._RemoveInstance(s,!0),this._SetLayer(a),a._AddInstance(s,!0),i=!0);const o=a.MoveInstanceAdjacent(s,e,!!t);(i||o)&&this._runtime.UpdateRender()}GetInstanceEffectList(){return this._instanceEffectList}_SetHasAnyActiveEffect(e){this._SetFlag(64,e)}HasAnyActiveEffect(){return!!(64&this._flags)}_SaveToJson(e,t=null){const s={x:this.GetX(),y:this.GetY(),w:this.GetWidth(),h:this.GetHeight(),l:this.GetLayer().GetSID(),zi:this.GetZIndex()};0!==this.GetZElevation()&&(s.ze=this.GetZElevation()),0!==this.GetAngle()&&(s.a=this._GetAngleNoReflect()),this.HasDefaultColor()||(s.c=this._color.toJSON()),.5!==this.GetOriginX()&&(s.oX=this.GetOriginX()),.5!==this.GetOriginY()&&(s.oY=this.GetOriginY()),0!==this.GetBlendMode()&&(s.bm=this.GetBlendMode()),this.IsVisible()||(s.v=this.IsVisible()),this.IsCollisionEnabled()||(s.ce=this.IsCollisionEnabled()),this.IsBboxChangeEventEnabled()&&(s.be=this.IsBboxChangeEventEnabled()),this._instanceEffectList&&(s.fx=this._instanceEffectList._SaveToJson());const i=!!(32&this._flags);return i&&(s.sfi=i),this._solidFilterTags&&(s.sft=[...this._solidFilterTags].join(" ")),this._sceneGraphInfo&&"visual-state"!==e&&(s.sgi=this._sceneGraphInfo._SaveToJson(e,t),Pw.has(this)&&(s.sgcd=Pw.get(this).childrenData,s.sgzid=Pw.get(this).zIndexData)),this.HasMesh()&&(s.mesh=this.GetSourceMesh().SaveToJson()),s}_SaveSceneGraphPropertiesToJson(){return{x:this._x,y:this._y,z:this._zElevation,w:this._w,h:this._h,a:this._a,sgi:this._GetSceneGraphInfo()?this._GetSceneGraphInfo()._SaveToJsonProperties():null}}_LoadSceneGraphPropertiesFromJson(e){e&&(this._x=e.x,this._y=e.y,this._zElevation=e.z,this._w=e.w,this._h=e.h,this._a=e.a,e.sgi&&this._GetSceneGraphInfo()&&this._GetSceneGraphInfo()._LoadFromJson(e.sgi),this._MarkSinCosAngleChanged(),this.SetBboxChanged())}_SetupSceneGraphConnectionsOnChangeOfLayout(){this._ReleaseTmpSceneGraphInfo(),this._ResetAllSceneGraphState(),this._CreateSceneGraphInfo(null),this._sceneGraphInfo&&this._sceneGraphInfo._SetTmpSceneGraphChildren(this._tmpSceneGraphChildren,this._tmpSceneGraphChildrenIndexes)}_OnBeforeLoad(e){"visual-state"!==e&&this._ResetAllSceneGraphState()}_OnAfterLoad(e,t="full",s=null){if(e.hasOwnProperty("sgi")&&"visual-state"!==t){if(this.IsDestroyed())return;this._sceneGraphInfo._OnAfterLoad(e.sgi,s)}}_OnAfterLoad2(e,t="full",s=null){if("visual-state"!==t)if(this.IsDestroyed())this._ReleaseTmpSceneGraphInfo();else{if(e.hasOwnProperty("sgi"))this._sceneGraphInfo._SetTmpSceneGraphChildren(null,null,e.sgi,s);else if(s?.setFromJson&&this._tmpSceneGraphChildren)for(const e of this._tmpSceneGraphChildren)e.IsDestroyed()||this._runtime.DestroyInstance(e);this._ReleaseTmpSceneGraphInfo(),this.SetBboxChanged()}}_LoadFromJson(e,t,s=null){if(Zx=!1,this.SetX(e.x),this.SetY(e.y),this.SetWidth(e.w),this.SetHeight(e.h),this._SetZIndex(e.zi),this.SetZElevation(e.hasOwnProperty("ze")?e.ze:0),this.SetAngle(e.hasOwnProperty("a")?e.a:0),e.hasOwnProperty("c")?zx.setFromJSON(e.c):e.hasOwnProperty("o")?(zx.copyRgb(this._color),zx.a=e.o):zx.setRgba(1,1,1,1),this._SetColor(zx),this.SetOriginX(e.hasOwnProperty("oX")?e.oX:.5),this.SetOriginY(e.hasOwnProperty("oY")?e.oY:.5),this.SetBlendMode(e.hasOwnProperty("bm")?e.bm:0),this.SetVisible(!e.hasOwnProperty("v")||e.v),this.SetCollisionEnabled(!e.hasOwnProperty("ce")||e.ce),this.SetBboxChangeEventEnabled(!!e.hasOwnProperty("be")&&e.be),this.SetSolidCollisionFilter(!!e.hasOwnProperty("sfi")&&e.sfi,e.hasOwnProperty("sft")?e.sft:""),this._instanceEffectList&&e.hasOwnProperty("fx")&&this._instanceEffectList._LoadFromJson(e.fx),e.hasOwnProperty("sgi")&&"visual-state"!==t){this._CreateSceneGraphInfo(null);const t=this._sceneGraphInfo,s=e.sgi;t._LoadFromJson(s),t._SetTmpSceneGraphChildren(this._tmpSceneGraphChildren,this._tmpSceneGraphChildrenIndexes),this._SetSceneGraphExportData(e.sgcd,e.sgzid)}if(e.hasOwnProperty("mesh")){const t=e.mesh;this.CreateMesh(t.cols,t.rows),this.GetSourceMesh().LoadFromJson(t)}else this.ReleaseMesh();this.SetBboxChanged(),Zx=!0,this._UpdateRendererStateGroup(),"visual-state"!==t&&this._runtime.AddInstanceNeedingAfterLoad(this.GetInstance(),e)}_SetSceneGraphExportData(e,t){e&&Lx.IsFiniteNumber(t)&&Pw.set(this,{childrenData:e,zIndexData:t})}}}{const vw=self.C3;vw.BehaviorType=class extends vw.DefendedBase{constructor(e,t){super();const s=e.GetRuntime(),i=s.GetObjectReference(t[1]);s.GetAddonManager()._DelayCreateBehavior(i),this._runtime=s,this._objectClass=e,this._behavior=vw.AddonManager.GetBehaviorByConstructorFunction(i),this._sdkType=null,this._iBehaviorType=null,this._instSdkCtor=i.Instance,this._sid=t[2],this._name=t[0],this._jsPropName=this._runtime.GetJsPropName(t[3]);const r=this._behavior.GetSdkVersion();if(r<2&&(this._sdkType=vw.New(i.Type,this),!(this._sdkType instanceof vw.SDKBehaviorTypeBase)))throw new Error("v1 sdk type must derive from SDKBehaviorBase");if(vw.AddonManager._PushInitObject(this,r),r>=2){const e=i.Type??globalThis.ISDKBehaviorTypeBase;if(this._iBehaviorType=new e,!(this._iBehaviorType instanceof globalThis.ISDKBehaviorTypeBase))throw new Error("script interface class must derive from ISDKBehaviorTypeBase")}else this._iBehaviorType=new globalThis.IBehaviorType;vw.AddonManager._PopInitObject(r),this.OnCreate()}static Create(e,t){return vw.New(vw.BehaviorType,e,t)}Release(){this._runtime=null,this._behavior=null,this._sdkType&&(this._sdkType.Release(),this._sdkType=null),this._instSdkCtor=null}GetSdkType(){return this._sdkType}OnCreate(){this._sdkType?this._sdkType.OnCreate():this._iBehaviorType&&this._iBehaviorType._onCreate()}GetRuntime(){return this._runtime}GetObjectClass(){return this._objectClass}GetBehavior(){return this._behavior}GetInstanceSdkCtor(){return this._instSdkCtor}GetName(){return this._name}GetSID(){return this._sid}GetIBehaviorType(){return this._iBehaviorType}GetJsPropName(){return this._jsPropName}}}{const Aw=self.C3,Mw=self.IBehaviorInstance;Aw.BehaviorInstance=class extends Aw.DefendedBase{constructor(e){super(),this._runtime=e.runtime,this._behaviorType=e.behaviorType,this._behavior=this._behaviorType.GetBehavior(),this._inst=e.instance,this._index=e.index,this._sdkInst=null,this._iScriptInterface=null,this._behavior._AddInstance(this._inst)}Release(){this._iScriptInterface&&(this._iScriptInterface._release(),this._iScriptInterface=null),this._behavior._RemoveInstance(this._inst),this._sdkInst&&(this._sdkInst.Release(),this._sdkInst=null),this._runtime=null,this._behaviorType=null,this._behavior=null,this._inst=null}_CreateSdkInstance(e){if(this._sdkInst)throw new Error("already got sdk instance");if(this.GetBehavior().GetSdkVersion()<2){if(this._sdkInst=Aw.New(this._behaviorType.GetInstanceSdkCtor(),this,e),!(this._sdkInst instanceof Aw.SDKBehaviorInstanceBase))throw new Error("v1 sdk type must derive from SDKBehaviorInstanceBase")}else{const t=this.GetBehavior().GetScriptInterfaceClass();this._InitScriptInterface(t.Instance,e)}}GetSdkInstance(){return this._sdkInst??this._iScriptInterface}GetObjectInstance(){return this._inst}GetRuntime(){return this._runtime}GetBehaviorType(){return this._behaviorType}GetBehavior(){return this._behavior}_GetIndex(){return this._index}PostCreate(){this._sdkInst?this._sdkInst.PostCreate():this._iScriptInterface._postCreate()}OnSpriteFrameChanged(e,t){this._sdkInst&&this._sdkInst.OnSpriteFrameChanged(e,t)}_GetDebuggerProperties(){return this._sdkInst?this._sdkInst.GetDebuggerProperties():this._iScriptInterface._getDebuggerProperties()}SaveToJson(e="full"){return this._sdkInst?this._sdkInst.SaveToJson(e):this._iScriptInterface._saveToJson(e)}LoadFromJson(e,t="full"){if(this._sdkInst)return this._sdkInst.LoadFromJson(e,t);this._iScriptInterface._loadFromJson(e,t)}static SortByTickSequence(e,t,s){const i=globalThis.ISDKBehaviorInstanceBase;let r,n;r=t instanceof i?e._UnwrapScriptInterface(t):t.GetBehaviorInstance(),n=s instanceof i?e._UnwrapScriptInterface(s):s.GetBehaviorInstance();const a=r.GetObjectInstance(),o=n.GetObjectInstance(),h=a.GetObjectClass().GetIndex(),l=o.GetObjectClass().GetIndex();if(h!==l)return h-l;const c=a.GetPUID(),u=o.GetPUID();return c!==u?c-u:r._GetIndex()-n._GetIndex()}_InitScriptInterface(e,t){const s=Mw,i=e??this._sdkInst.GetScriptInterfaceClass(),r=i||s,n=this.GetBehavior().GetSdkVersion();if(Aw.AddonManager._PushInitObject(this,n),Aw.AddonManager._PushInitProperties(t),this._iScriptInterface=new r,Aw.AddonManager._PopInitProperties(),Aw.AddonManager._PopInitObject(n),i&&!(this._iScriptInterface instanceof s))throw new TypeError(`script interface class '${i.name}' does not extend the right base class '${s.name}'`);return this._iScriptInterface}GetScriptInterface(){return this._iScriptInterface||this._InitScriptInterface()}HasScriptInterface(){return!!this._iScriptInterface}}}{const Dw=self.C3;Dw.EffectList=class extends Dw.DefendedBase{constructor(e,t){super(),this._owner=e,this._allEffectTypes=[],this._activeEffectTypes=[],this._effectTypesByName=new Map,this._effectParams=[],this._effectParamBuffers=[],this._allInstanceEffectLists=new Set,this._preservesOpaqueness=!0;for(const e of t){const t=Dw.New(Dw.EffectType,this,e,this._allEffectTypes.length);this._allEffectTypes.push(t),this._effectTypesByName.set(t.GetName().toLowerCase(),t),e.length>=3&&this._effectParams.push(this._LoadSingleEffectParameters(t,e[2]))}this.GetRuntime()._AddEffectList(this)}Release(){this.GetRuntime()._RemoveEffectList(this);for(const e of this._effectParamBuffers)e.Release();Dw.clearArray(this._effectParamBuffers),Dw.clearArray(this._allEffectTypes),Dw.clearArray(this._activeEffectTypes),this._effectTypesByName.clear(),Dw.clearArray(this._effectParams),this._owner=null}_AddInstanceEffectList(e){this._allInstanceEffectLists.add(e)}_RemoveInstanceEffectList(e){this._allInstanceEffectLists.delete(e)}_InitRenderer(e){e.IsWebGPU()&&(this._effectParamBuffers=this._allEffectTypes.map(e=>{const t=e.GetShaderProgram();return t.GetCustomParametersByteSize()>0?Dw.New(Dw.Gfx.WebGPUEffectCustomParamsBuffer,t):null}),this._UpdateAllEffectParamBuffers());for(const t of this._allInstanceEffectLists)t._InitRenderer(e)}PrependEffectTypes(e){if(e.length){this._allEffectTypes=e.concat(this._allEffectTypes);for(const t of e)this._effectTypesByName.set(t.GetName().toLowerCase(),t);for(let e=0,t=this._allEffectTypes.length;e<t;++e)this._allEffectTypes[e]._SetIndex(e)}}_LoadSingleEffectParameters(e,t){e.SetActive(t[0]);const s=t.slice(1);for(let e=0,t=s.length;e<t;++e){const t=s[e];if(Array.isArray(t)){const i=Dw.New(Dw.Color);i.setFromJSON(t),s[e]=i}}return s}GetOwner(){return this._owner}GetRuntime(){return this._owner.GetRuntime()}UpdateActiveEffects(){Dw.clearArray(this._activeEffectTypes);let e=!0;for(const t of this._allEffectTypes)t.IsActive()&&(this._activeEffectTypes.push(t),t.GetShaderProgram().PreservesOpaqueness()||(e=!1));this._preservesOpaqueness=e}GetAllEffectTypes(){return this._allEffectTypes}HasAnyEffectType(){return this._allEffectTypes.length>0}GetEffectTypeByName(e){return this._effectTypesByName.get(e.toLowerCase())||null}GetEffectTypeByIndex(e){if((e=Math.floor(+e))<0||e>=this._allEffectTypes.length)throw new RangeError("invalid effect type index");return this._allEffectTypes[e]}IsEffectIndexActive(e){return this.GetEffectTypeByIndex(e).IsActive()}SetEffectIndexActive(e,t){this.GetEffectTypeByIndex(e).SetActive(t)}GetActiveEffectTypes(){return this._activeEffectTypes}HasAnyActiveEffect(){return this._activeEffectTypes.length>0}PreservesOpaqueness(){return this._preservesOpaqueness}GetEffectParametersForIndex(e){return this._effectParams[e]}_GetEffectChainShaderParametersForIndex(e){return e<this._effectParamBuffers.length?this._effectParamBuffers[e]:this._effectParams[e]}GetEffectParameter(e,t){if(e<0||e>=this._effectParams.length)return null;const s=this._effectParams[e];return t<0||t>=s.length?null:s[t]}SetEffectParameter(e,t,s){if(e<0||e>=this._effectParams.length)return!1;const i=this._effectParams[e];if(t<0||t>=i.length)return!1;const r=i[t];if(r instanceof Dw.Color){if(r.equalsIgnoringAlpha(s))return!1;r.copyRgb(s)}else{if(r===s)return!1;i[t]=s}return e<this._effectParamBuffers.length&&this._effectParamBuffers[e].SetParameterValue(t,s),!0}_UpdateAllEffectParamBuffers(){const e=this._effectParams,t=this._effectParamBuffers;for(let s=0,i=Math.min(e.length,t.length);s<i;++s){const i=t[s],r=e[s];for(let e=0,t=r.length;e<t;++e)i.SetParameterValue(e,r[e])}}static SaveFxParamToJson(e){return e&&e instanceof Dw.Color?{t:"color",v:e.toJSON()}:e}static LoadFxParamFromJson(e){if(null===e)return NaN;if("object"==typeof e){if("color"===e.t){const t=Dw.New(Dw.Color);return t.setFromJSON(e.v),t}throw new Error("invalid effect parameter type")}return e}static SaveFxParamsToJson(e){return e.map(Dw.EffectList.SaveFxParamToJson)}static LoadFxParamsFromJson(e){return e.map(Dw.EffectList.LoadFxParamFromJson)}SaveToJson(){return this._allEffectTypes.map(e=>({name:e.GetName(),active:e.IsActive(),params:Dw.EffectList.SaveFxParamsToJson(this._effectParams[e.GetIndex()])}))}LoadFromJson(e){for(const t of e){const e=this.GetEffectTypeByName(t.name);e&&(e.SetActive(t.active),this._effectParams[e.GetIndex()]=Dw.EffectList.LoadFxParamsFromJson(t.params))}this.UpdateActiveEffects(),this._UpdateAllEffectParamBuffers()}}}{const Ew=self.C3;Ew.EffectType=class extends Ew.DefendedBase{constructor(e,t,s){super(),this._effectList=e,this._id=t[0],this._name=t[1],this._index=s,this._shaderProgram=null,this._isActive=!0}Release(){this._effectList=null,this._shaderProgram=null}Clone(e){const t=Ew.New(Ew.EffectType,e,[this._id,this._name],-1);return t._shaderProgram=this._shaderProgram,t._isActive=this._isActive,t}_InitRenderer(e){const t=e.GetShaderProgramByName(this._id);if(!t)throw new Error("failed to find shader program '"+this._id+"'");this._shaderProgram=t}GetEffectList(){return this._effectList}GetName(){return this._name}_SetIndex(e){this._index=e}GetIndex(){return this._index}GetOwner(){return this._effectList.GetOwner()}GetRuntime(){return this._effectList.GetRuntime()}SetActive(e){this._isActive=!!e}IsActive(){return this._isActive}GetShaderProgram(){return this._shaderProgram}GetDefaultParameterValues(){const e=[];for(let t=0,s=this._shaderProgram.GetParameterCount();t<s;++t){const s=this._shaderProgram.GetParameterType(t);if("float"===s||"percent"===s)e.push(0);else{if("color"!==s)throw new TypeError("unknown effect parameter type");e.push(Ew.New(Ew.Color,1,1,1,1))}}return e}}}{const Fw=self.C3;Fw.InstanceEffectList=class extends Fw.DefendedBase{constructor(e,t){super(),this._inst=e,this._wi=t,this._effectList=e.GetObjectClass().GetEffectList(),this._needsRebuildSteps=!0,this._wasDefaultColor=!0,this._was3D=!1,this._wasRotatedOrNegativeSize=!1,this._wasTexRotated=!1,this._wasMustPreDraw=!1,this._effectChain=Fw.New(Fw.Gfx.EffectChain,e.GetRuntime().GetCanvasManager().GetEffectChainManager(),{drawContent:(e,t)=>{const s=t.GetContentObject(),i=s.GetWorldInfo();e.SetColor(i.GetPremultipliedColor()),e.SetCurrentZ(i.GetTotalZElevation()),s.Draw(e),e.SetCurrentZ(0)},getSourceTextureInfo:e=>{const t=e.GetCurrentTexRect(),[s,i]=e.GetCurrentSurfaceSize();return{srcTexRect:t,srcWidth:s,srcHeight:i}},getShaderParameters:e=>this._GetEffectChainShaderParametersForIndex(e)}),this._activeEffectFlags=[],this._activeEffectTypes=[],this._preservesOpaqueness=!0,this._effectParams=[],this._effectParamBuffers=[],this._InitRenderer(e.GetRuntime().GetRenderer());for(let e=0,t=this._effectList.GetAllEffectTypes().length;e<t;++e)this._activeEffectFlags.push(!0);this.UpdateActiveEffects(),this._effectList._AddInstanceEffectList(this)}Release(){this._effectList._RemoveInstanceEffectList(this);for(const e of this._effectParamBuffers)e&&e.Release();Fw.clearArray(this._effectParamBuffers),this._effectChain.Release(),this._effectChain=null,Fw.clearArray(this._activeEffectFlags),Fw.clearArray(this._activeEffectTypes),Fw.clearArray(this._effectParams),this._inst=null,this._effectList=null}_InitRenderer(e){e.IsWebGPU()&&(this._effectParamBuffers=this._effectList.GetAllEffectTypes().map(e=>{const t=e.GetShaderProgram();return t.GetCustomParametersByteSize()>0?Fw.New(Fw.Gfx.WebGPUEffectCustomParamsBuffer,t):null}))}_LoadEffectParameters(e){let t=0;for(const s of e)this._effectParams.push(this._LoadSingleEffectParameters(t,s)),++t;this._UpdateAllEffectParamBuffers(),this.UpdateActiveEffects()}_LoadSingleEffectParameters(e,t){this._activeEffectFlags[e]=t[0];const s=t.slice(1);for(let e=0,t=s.length;e<t;++e){const t=s[e];if(Array.isArray(t)){const i=Fw.New(Fw.Color);i.setFromJSON(t),s[e]=i}}return s}LoadDefaultEffectParameters(){for(const e of this._effectList.GetAllEffectTypes())this._effectParams.push(e.GetDefaultParameterValues());this._UpdateAllEffectParamBuffers()}GetOwner(){return this._owner}GetEffectList(){return this._effectList}GetEffectChain(){return this._MaybeRebuildEffectChainSteps(),this._effectChain}GetRuntime(){return this._inst.GetRuntime()}UpdateActiveEffects(){Fw.clearArray(this._activeEffectTypes);const e=this._wi,t=this._effectList.GetAllEffectTypes(),s=this._activeEffectTypes,i=this._activeEffectFlags;let r=!0;for(let e=0,n=t.length;e<n;++e)if(i[e]){const i=t[e];s.push(i),i.GetShaderProgram().PreservesOpaqueness()||(r=!1)}this._preservesOpaqueness=r,e._SetHasAnyActiveEffect(!!s.length),this._needsRebuildSteps=!0}_MaybeRebuildEffectChainSteps(){const e=this._inst,t=this._wi,s=t.HasDefaultColor(),i=e.GetPlugin().Is3D(),r=0!==t.GetAngle()||0!==t.GetLayer().GetAngle()||t.GetWidth()<0||t.GetHeight()<0,n=e.IsCurrentTexRotated(),a=e.MustPreDraw();(this._needsRebuildSteps||s!==this._wasDefaultColor||i!==this._was3D||r!==this._wasRotatedOrNegativeSize||n!==this._wasTexRotated||a!==this._wasMustPreDraw||this._effectChain.NeedsRebuild())&&(this._effectChain.BuildSteps(this._activeEffectTypes.map(e=>e.GetShaderProgram()),{indexMap:this._activeEffectTypes.map(e=>e.GetIndex()),forcePreDraw:!s||a,is3D:i,isSourceTextureRotated:n,isRotatedOrNegativeSizeInstance:r}),this._needsRebuildSteps=!1,this._wasDefaultColor=s,this._was3D=i,this._wasRotatedOrNegativeSize=r,this._wasTexRotated=n,this._wasMustPreDraw=a)}GetActiveEffectTypes(){return this._activeEffectTypes}GetEffectParametersForIndex(e){return this._effectParams[e]}_GetEffectChainShaderParametersForIndex(e){return e<this._effectParamBuffers.length?this._effectParamBuffers[e]:this._effectParams[e]}GetEffectParameter(e,t){if(e<0||e>=this._effectParams.length)return null;const s=this._effectParams[e];return t<0||t>=s.length?null:s[t]}SetEffectParameter(e,t,s){if(e<0||e>=this._effectParams.length)return!1;const i=this._effectParams[e];if(t<0||t>=i.length)return!1;const r=i[t];if(r instanceof Fw.Color){if(r.equalsIgnoringAlpha(s))return!1;r.copyRgb(s)}else{if(r===s)return!1;i[t]=s}return e<this._effectParamBuffers.length&&this._effectParamBuffers[e].SetParameterValue(t,s),!0}_UpdateAllEffectParamBuffers(){const e=this._effectParams,t=this._effectParamBuffers;for(let s=0,i=t.length;s<i;++s){const i=t[s],r=e[s];for(let e=0,t=r.length;e<t;++e)i.SetParameterValue(e,r[e])}}PreservesOpaqueness(){return this._preservesOpaqueness}HasAnyActiveBackgroundBlendingEffect(){return this._activeEffectTypes.some(e=>e.GetShaderProgram().BlendsBackground())}IsEffectIndexActive(e){return this._activeEffectFlags[e]}SetEffectIndexActive(e,t){this._activeEffectFlags[e]=!!t}GetAllEffectTypes(){return this._effectList.GetAllEffectTypes()}_SaveToJson(){return this._effectList.GetAllEffectTypes().map(e=>({name:e.GetName(),active:this._activeEffectFlags[e.GetIndex()],params:Fw.EffectList.SaveFxParamsToJson(this._effectParams[e.GetIndex()])}))}_LoadFromJson(e){for(const t of e){const e=this._effectList.GetEffectTypeByName(t.name);e&&(this._activeEffectFlags[e.GetIndex()]=t.active,this._effectParams[e.GetIndex()]=Fw.EffectList.LoadFxParamsFromJson(t.params))}this.UpdateActiveEffects(),this._UpdateAllEffectParamBuffers()}}}{const Ow=self.C3,Bw=[],kw=[],Lw=[],Nw=Ow.New(Ow.CollisionPoly),Ww=Ow.New(Ow.CollisionPoly),Uw=Ow.New(Ow.Quad),Vw=Ow.New(Ow.Rect),Hw=Ow.New(Ow.Rect);let jw=null,zw=null,Xw=null;Ow.CollisionEngine=class extends Ow.DefendedBase{constructor(e){super(),this._runtime=e,this._collisionCellWidth=0,this._collisionCellHeight=0,this._registeredCollisions=[],this._collisionCheckCount=0,this._collisionCheckSec=0,this._polyCheckCount=0,this._polyCheckSec=0,this._iCollisionEngine=new self.ICollisionEngine(this)}Release(){this._runtime=null}GetRuntime(){return this._runtime}GetICollisionEngine(){return this._iCollisionEngine}_Update1sStats(){this._collisionCheckSec=this._collisionCheckCount,this._collisionCheckCount=0,this._polyCheckSec=this._polyCheckCount,this._polyCheckCount=0}Get1secCollisionChecks(){return this._collisionCheckSec}Get1secPolyChecks(){return this._polyCheckSec}RegisterCollision(e,t){const s=e.GetWorldInfo(),i=t.GetWorldInfo();s&&i&&s.IsCollisionEnabled()&&i.IsCollisionEnabled()&&this._registeredCollisions.push([e,t])}AddRegisteredCollisionCandidates(e,t,s){for(const[i,r]of this._registeredCollisions){let n=null;if(e===i)n=r;else{if(e!==r)continue;n=i}n.BelongsToObjectClass(t)&&(s.includes(n)||s.push(n))}}CheckRegisteredCollision(e,t){if(!this._registeredCollisions.length)return!1;for(const[s,i]of this._registeredCollisions)if(e===s&&t===i||e===i&&t===s)return!0;return!1}ClearRegisteredCollisions(){Ow.clearArray(this._registeredCollisions)}TestOverlap(e,t){if(!e||!t||e===t)return!1;const s=e.GetWorldInfo(),i=t.GetWorldInfo();if(!s.IsCollisionEnabled()||!i.IsCollisionEnabled())return!1;this._collisionCheckCount++;const r=s.GetLayer(),n=i.GetLayer();return r.IsTransformCompatibleWith(n)?this._TestOverlap_SameLayers(s,i):this._TestOverlap_DifferentLayers(s,i)}_TestOverlap_SameLayers(e,t){if(!e.GetBoundingBox().intersectsRect(t.GetBoundingBox()))return!1;if(this._polyCheckCount++,!e.GetBoundingQuad().intersectsQuad(t.GetBoundingQuad()))return!1;if(e.HasTilemap()&&t.HasTilemap())return!1;if(e.HasTilemap())return this.TestTilemapOverlap(e,t);if(t.HasTilemap())return this.TestTilemapOverlap(t,e);if(!e.HasOwnCollisionPoly()&&!t.HasOwnCollisionPoly())return!0;const s=e.GetTransformedCollisionPoly(),i=t.GetTransformedCollisionPoly();return s.intersectsPoly(i,t.GetX()-e.GetX(),t.GetY()-e.GetY())}_TestOverlap_DifferentLayers(e,t){const s=e.HasTilemap(),i=t.HasTilemap();if(s&&!i)return this.TestTilemapOverlapDifferentLayers(e,t);if(i&&!s)return this.TestTilemapOverlapDifferentLayers(t,e);if(i||s)return!1;{const s=e.GetLayer(),i=t.GetLayer();Nw.copy(e.GetTransformedCollisionPoly()),Ww.copy(t.GetTransformedCollisionPoly());const r=Nw.pointsArr();for(let t=0,i=r.length;t<i;t+=2){const i=t+1,n=r[t],a=r[i],[o,h]=s.LayerToCanvasCss(n+e.GetX(),a+e.GetY());r[t]=o,r[i]=h}const n=Ww.pointsArr();for(let e=0,s=n.length;e<s;e+=2){const s=e+1,r=n[e],a=n[s],[o,h]=i.LayerToCanvasCss(r+t.GetX(),a+t.GetY());n[e]=o,n[s]=h}return Nw.setBboxChanged(),Ww.setBboxChanged(),this._polyCheckCount++,Nw.intersectsPoly(Ww,0,0)}}TestTilemapOverlapDifferentLayers(e,t){const s=e.GetLayer(),i=t.GetLayer();jw||(jw=Ow.New(Ow.CollisionPoly)),zw||(zw=Ow.New(Ow.Rect)),Xw||(Xw=Ow.New(Ow.Quad));const r=t.GetX(),n=t.GetY(),[a,o]=i.LayerToCanvasCss(r,n),[h,l]=s.CanvasCssToLayer(a,o),c=h-r,u=l-n;if(zw.copy(t.GetBoundingBox()),zw.offset(c,u),!e.GetBoundingBox().intersectsRect(zw))return!1;if(Xw.copy(t.GetBoundingQuad()),Xw.offset(c,u),this._polyCheckCount++,!e.GetBoundingQuad().intersectsQuad(Xw))return!1;jw.copy(t.GetTransformedCollisionPoly());const d=jw.pointsArr();for(let e=0,t=d.length;e<t;e+=2){const t=e+1;d[e]+=c,d[t]+=u}return jw.setBboxChanged(),this.TestTilemapOverlap(e,t,h,l,jw,zw,Xw)}TestTilemapOverlap(e,t,s,i,r,n,a){const o=void 0!==n?n:t.GetBoundingBox(),h=e.GetX(),l=e.GetY(),c=e.GetInstance().GetSdkInstance(),u=void 0!==s?s:t.GetX(),d=void 0!==i?i:t.GetY(),_=t.HasOwnCollisionPoly(),p=void 0!==a?a:t.GetBoundingQuad(),f=kw;c.GetCollisionRectCandidates(o,f);for(let e=0,s=f.length;e<s;++e){const s=f[e],i=s.GetRect();if(this._collisionCheckCount++,o.intersectsRectOffset(i,h,l)&&(Uw.setFromRect(i),Uw.offset(h,l),Uw.intersectsQuad(p)))if(_){const e=void 0!==r?r:t.GetTransformedCollisionPoly();let n=u,a=d;void 0!==r&&(n=t.GetX(),a=t.GetY());const o=s.GetPoly();if(o){if(this._polyCheckCount++,o.intersectsPoly(e,n-(h+i.getLeft()),a-(l+i.getTop())))return Ow.clearArray(f),!0}else if(Nw.setFromQuad(Uw,0,0),Nw.intersectsPoly(e,n,a))return Ow.clearArray(f),!0}else{const e=s.GetPoly();if(!e)return Ow.clearArray(f),!0;if(Nw.setFromQuad(p,0,0),e.intersectsPoly(Nw,-(h+i.getLeft()),-(l+i.getTop())))return Ow.clearArray(f),!0}}return Ow.clearArray(f),!1}TestAndSelectCanvasPointOverlap(e,t,s){const i=e.GetCurrentSol(),r=this._runtime.GetCurrentEvent();if(!r)throw new Error("cannot call outside event");const n=r.IsOrBlock(),a=new Ow.LayerStateCache;if(i.IsSelectAll()){s||(i._SetSelectAll(!1),Ow.clearArray(i._GetOwnInstances())),n&&Ow.clearArray(i._GetOwnElseInstances());for(const r of e.GetInstances()){const e=r.GetWorldInfo(),o=e.GetLayer();let h=!1;if(a.IsInteractive(o)&&e.IsInViewport2()&&(h=t.some(([t,s])=>{const[i,r]=a.CanvasCssToLayer(o,t,s,e.GetTotalZElevation());return e.ContainsPoint(i,r)})),h){if(s)return!1;i._PushInstance(r)}else n&&i._PushElseInstance(r)}}else{let e,o=!1;n&&!r.IsFirstConditionOfType(this._runtime.GetCurrentCondition())?this._runtime.IsCurrentConditionFirst()&&!i._GetOwnElseInstances().length&&i._GetOwnInstances().length?e=i._GetOwnInstances():(e=i._GetOwnElseInstances(),o=!0):e=i._GetOwnInstances();let h=0;for(let r=0,l=e.length;r<l;++r){const l=e[r],c=l.GetWorldInfo(),u=c.GetLayer();let d=!1;if(a.IsInteractive(u)&&c.IsInViewport2()&&(d=t.some(([e,t])=>{const[s,i]=a.CanvasCssToLayer(u,e,t,c.GetTotalZElevation());return c.ContainsPoint(s,i)})),d){if(s)return!1;o?i._PushInstance(l):e[h++]=l}else o?e[h++]=l:n&&i._PushElseInstance(l)}s||(e.length=h)}return e.ApplySolToContainer(),a.Release(),!!s||i.HasAnyInstances()}_ObjectClassCanUseCollisionCells(e,t){if(!e)return!0;for(const s of t.layersHasInstancesOn())if(!e.IsTransformCompatibleWith(s))return!1;return!0}GetCollisionCandidates(e,t,s,i){if(t.IsFamily())for(const r of t.GetFamilyMembers())this._ObjectClassCanUseCollisionCells(e,r)?(r._UpdateAllCollisionCells(),r._GetCollisionCellGrid().QueryRange(s,i)):Ow.appendArray(i,r.GetInstances());else this._ObjectClassCanUseCollisionCells(e,t)?(t._UpdateAllCollisionCells(),t._GetCollisionCellGrid().QueryRange(s,i)):Ow.appendArray(i,t.GetInstances())}GetObjectClassesCollisionCandidates(e,t,s,i){for(const r of t)this.GetCollisionCandidates(e,r,s,i)}GetSolidCollisionCandidates(e,t,s){const i=this._runtime.GetSolidBehavior();i&&this.GetObjectClassesCollisionCandidates(e,i.GetObjectClasses(),t,s)}GetJumpthruCollisionCandidates(e,t,s){const i=this._runtime.GetJumpthruBehavior();i&&this.GetObjectClassesCollisionCandidates(e,i.GetObjectClasses(),t,s)}IsSolidCollisionAllowed(e,t){return e._IsSolidEnabled()&&(!t||t.GetWorldInfo().IsSolidCollisionAllowed(e))}TestOverlapSolid(e){const t=e.GetWorldInfo();this.GetSolidCollisionCandidates(t.GetLayer(),t.GetBoundingBox(),Bw);for(const t of Bw)if(this.IsSolidCollisionAllowed(t,e)&&this.TestOverlap(e,t))return Ow.clearArray(Bw),t;return Ow.clearArray(Bw),null}TestRectOverlapSolid(e,t){this.GetSolidCollisionCandidates(null,e,Bw);for(const s of Bw)if(this.IsSolidCollisionAllowed(s,t)&&this.TestRectOverlap(e,s))return Ow.clearArray(Bw),s;return Ow.clearArray(Bw),null}TestOverlapJumpthru(e,t){let s=null;t&&(s=Lw,Ow.clearArray(s));const i=e.GetWorldInfo();this.GetJumpthruCollisionCandidates(i.GetLayer(),i.GetBoundingBox(),Bw);for(const i of Bw)if(i._IsJumpthruEnabled()&&this.TestOverlap(e,i)){if(!t)return Ow.clearArray(Bw),i;s.push(i)}return Ow.clearArray(Bw),s}PushOut(e,t,s,i,r){i=i||50;const n=e.GetWorldInfo(),a=n.GetX(),o=n.GetY();for(let h=0;h<i;++h)if(n.SetXY(a+t*h,o+s*h),n.SetBboxChanged(),!this.TestOverlap(e,r))return!0;return n.SetXY(a,o),n.SetBboxChanged(),!1}PushOutSolid(e,t,s,i,r,n){i=i||50;const a=e.GetWorldInfo(),o=a.GetX(),h=a.GetY();let l=null,c=null;for(let u=0;u<i;++u)if(a.SetXY(o+t*u,h+s*u),a.SetBboxChanged(),!this.TestOverlap(e,l))if(l=this.TestOverlapSolid(e),l)c=l;else if(r&&(l=n?this.TestOverlap(e,n)?n:null:this.TestOverlapJumpthru(e),l&&(c=l)),!l)return c&&this.PushInFractional(e,t,s,c,16,!0),!0;return a.SetXY(o,h),a.SetBboxChanged(),!1}PushOutSolidAxis(e,t,s,i){i=i||50;const r=e.GetWorldInfo(),n=r.GetX(),a=r.GetY();let o=null,h=null;for(let l=0;l<i;++l)for(let i=0;i<2;++i){const c=2*i-1;if(r.SetXY(n+t*l*c,a+s*l*c),r.SetBboxChanged(),!this.TestOverlap(e,o)){if(o=this.TestOverlapSolid(e),!o)return h&&this.PushInFractional(e,t*c,s*c,h,16,!0),!0;h=o}}return r.SetXY(n,a),r.SetBboxChanged(),!1}PushInFractional(e,t,s,i,r,n){let a=2,o=!1,h=!1;const l=e.GetWorldInfo();let c=l.GetX(),u=l.GetY();for(;a<=r;){const r=1/a;a*=2,l.OffsetXY(t*r*(o?1:-1),s*r*(o?1:-1)),l.SetBboxChanged(),this.TestOverlap(e,i)||n&&this.TestOverlapSolid(e)?(o=!0,h=!0):(o=!1,h=!1,c=l.GetX(),u=l.GetY())}h&&(l.SetXY(c,u),l.SetBboxChanged())}PushOutSolidNearest(e,t=100){let s=0;const i=e.GetWorldInfo(),r=i.GetX(),n=i.GetY();let a=0,o=this.TestOverlapSolid(e);if(!o)return!0;for(;s<=t;){let t=0,h=0;switch(a){case 0:t=0,h=-1,s++;break;case 1:t=1,h=-1;break;case 2:t=1,h=0;break;case 3:t=1,h=1;break;case 4:t=0,h=1;break;case 5:t=-1,h=1;break;case 6:t=-1,h=0;break;case 7:t=-1,h=-1}if(a=(a+1)%8,i.SetXY(Math.floor(r+t*s),Math.floor(n+h*s)),i.SetBboxChanged(),!this.TestOverlap(e,o)&&(o=this.TestOverlapSolid(e),!o))return!0}return i.SetXY(r,n),i.SetBboxChanged(),!1}CalculateBounceAngle(e,t,s,i){const r=e.GetWorldInfo(),n=r.GetX(),a=r.GetY(),o=Math.max(10,Ow.distanceTo(t,s,n,a)),h=Ow.angleTo(t,s,n,a),l=i||this.TestOverlapSolid(e);if(!l)return Ow.clampAngle(h+Math.PI);let c=l,u=0,d=0;const _=Ow.toRadians(5);let p;for(p=1;p<36;++p){const n=h-p*_;if(r.SetXY(t+Math.cos(n)*o,s+Math.sin(n)*o),r.SetBboxChanged(),!this.TestOverlap(e,c)&&(c=i?null:this.TestOverlapSolid(e),!c)){u=n;break}}for(36===p&&(u=Ow.clampAngle(h+Math.PI)),c=l,p=1;p<36;++p){const n=h+p*_;if(r.SetXY(t+Math.cos(n)*o,s+Math.sin(n)*o),r.SetBboxChanged(),!this.TestOverlap(e,c)&&(c=i?null:this.TestOverlapSolid(e),!c)){d=n;break}}if(36===p&&(d=Ow.clampAngle(h+Math.PI)),r.SetXY(n,a),r.SetBboxChanged(),d===u)return d;const f=Ow.angleDiff(d,u)/2;let m;m=Ow.angleClockwise(d,u)?Ow.clampAngle(u+f+Math.PI):Ow.clampAngle(d+f);const g=Math.cos(h),S=Math.sin(h),G=Math.cos(m),y=Math.sin(m),I=g*G+S*y,T=g-2*I*G,C=S-2*I*y;return Ow.angleTo(0,0,T,C)}TestSegmentOverlap(e,t,s,i,r){if(!r)return!1;const n=r.GetWorldInfo();return!!n.IsCollisionEnabled()&&(this._collisionCheckCount++,Vw.set(Math.min(e,s),Math.min(t,i),Math.max(e,s),Math.max(t,i)),!!n.GetBoundingBox().intersectsRect(Vw)&&(r.HasTilemap()?this._TestSegmentOverlapTilemap(e,t,s,i,r,n):(this._polyCheckCount++,!!n.GetBoundingQuad().intersectsSegment(e,t,s,i)&&(!n.HasOwnCollisionPoly()||n.GetTransformedCollisionPoly().intersectsSegment(n.GetX(),n.GetY(),e,t,s,i)))))}_TestSegmentOverlapTilemap(e,t,s,i,r,n){const a=n.GetX(),o=n.GetY(),h=r.GetSdkInstance(),l=kw;Hw.set(e,t,s,i),Hw.normalize(),h.GetCollisionRectCandidates(Hw,l);for(let r=0,n=l.length;r<n;++r){const n=l[r],h=n.GetRect();if(this._collisionCheckCount++,Vw.intersectsRectOffset(h,a,o)&&(Uw.setFromRect(h),Uw.offset(a,o),Uw.intersectsSegment(e,t,s,i))){const r=n.GetPoly();if(!r)return Ow.clearArray(l),!0;if(this._polyCheckCount++,r.intersectsSegment(a+h.getLeft(),o+h.getTop(),e,t,s,i))return Ow.clearArray(l),!0}}return Ow.clearArray(l),!1}TestRectOverlap(e,t){if(!t)return!1;const s=t.GetWorldInfo();if(!s.IsCollisionEnabled())return!1;if(this._collisionCheckCount++,!s.GetBoundingBox().intersectsRect(e))return!1;if(t.HasTilemap())return this._TestRectOverlapTilemap(e,t,s);if(this._polyCheckCount++,Uw.setFromRect(e),!s.GetBoundingQuad().intersectsQuad(Uw))return!1;if(!s.HasOwnCollisionPoly())return!0;const i=Nw;i.setFromRect(e,s.GetX(),s.GetY());const r=s.GetTransformedCollisionPoly();return i.intersectsPoly(r,0,0)}_TestRectOverlapTilemap(e,t,s){const i=s.GetX(),r=s.GetY(),n=t.GetSdkInstance(),a=kw;n.GetCollisionRectCandidates(e,a);for(let t=0,s=a.length;t<s;++t){const s=a[t],n=s.GetRect();if(this._collisionCheckCount++,e.intersectsRectOffset(n,i,r)){const t=s.GetPoly();if(!t)return Ow.clearArray(a),!0;if(this._polyCheckCount++,Nw.setFromRect(e,0,0),t.intersectsPoly(Nw,-(i+n.getLeft()),-(r+n.getTop())))return Ow.clearArray(a),!0}}return Ow.clearArray(a),!1}TestRayIntersectsInstance(e,t){if(!e)return;const s=e.GetWorldInfo();s.IsCollisionEnabled()&&(this._collisionCheckCount++,s.GetBoundingBox().intersectsRect(t.rect)&&(e.HasTilemap()?this._TestRayIntersectsTilemap(e,s,t):(this._polyCheckCount++,s.HasOwnCollisionPoly()?t.TestInstancePoly(e,s.GetX(),s.GetY(),s.GetTransformedCollisionPoly()):t.TestInstanceQuad(e,s.GetBoundingQuad()))))}_TestRayIntersectsTilemap(e,t,s){const i=t.GetX(),r=t.GetY(),n=kw;e.GetSdkInstance().GetCollisionRectCandidates(s.rect,n);for(let a=0,o=n.length;a<o;a++){const o=n[a],h=o.GetRect();if(this._collisionCheckCount++,s.rect.intersectsRectOffset(h,i,r)){const n=o.GetPoly();this._polyCheckCount++,n?s.TestInstancePoly(e,i+h.getLeft(),r+h.getTop(),n):s.TestInstanceRect(e,t.GetX(),t.GetY(),h)}}Ow.clearArray(n)}SetCollisionCellSize(e,t){if(e===this._collisionCellWidth&&t===this._collisionCellHeight)return;this._collisionCellWidth=e,this._collisionCellHeight=t;const s=this._runtime.GetAllObjectClasses();for(const i of s)if(i.IsWorldType()){for(const e of i.instancesIncludingPendingCreate())e.GetWorldInfo()._RemoveFromCollisionCells();i._GetCollisionCellGrid().SetCellSize(e,t),i._SetAnyCollisionCellChanged();for(const e of i.instancesIncludingPendingCreate()){const t=e.GetWorldInfo();t._SetCollisionCellChanged(),t._UpdateCollisionCell()}}}GetCollisionCellSize(){return[this._collisionCellWidth,this._collisionCellHeight]}_InitCollisionCellSize(e,t){this._collisionCellWidth=e,this._collisionCellHeight=t}}}{const Yw=self.C3;Yw.SparseGrid=class extends Yw.DefendedBase{constructor(e,t){super(),this._cellWidth=e,this._cellHeight=t,this._cells=Yw.New(Yw.PairMap)}Release(){this._cells.Release(),this._cells=null}SetCellSize(e,t){if(!this._cells.IsEmpty())throw new Error("grid not empty");this._cellWidth=e,this._cellHeight=t}GetCell(e,t,s){let i=this._cells.Get(e,t);return i||(s?(i=Yw.New(Yw.GridCell,this,e,t),this._cells.Set(e,t,i),i):null)}XToCell(e){const t=Math.floor(e/this._cellWidth);return isFinite(t)?t:0}YToCell(e){const t=Math.floor(e/this._cellHeight);return isFinite(t)?t:0}Update(e,t,s){if(t)for(let i=t.getLeft(),r=t.getRight();i<=r;++i)for(let r=t.getTop(),n=t.getBottom();r<=n;++r){if(s&&s.containsPoint(i,r))continue;const t=this.GetCell(i,r,!1);t&&(t.Remove(e),t.IsEmpty()&&this._cells.Delete(i,r))}if(s)for(let i=s.getLeft(),r=s.getRight();i<=r;++i)for(let r=s.getTop(),n=s.getBottom();r<=n;++r)t&&t.containsPoint(i,r)||this.GetCell(i,r,!0).Insert(e)}QueryRange(e,t){let s=this.XToCell(e.getLeft());const i=this.YToCell(e.getTop()),r=this.XToCell(e.getRight()),n=this.YToCell(e.getBottom());if(isFinite(r)&&isFinite(n))for(;s<=r;++s)for(let e=i;e<=n;++e){const i=this.GetCell(s,e,!1);i&&i.Dump(t)}}}}{const qw=self.C3;qw.GridCell=class extends qw.DefendedBase{constructor(e,t,s){super(),this._grid=e,this._x=t,this._y=s,this._instances=qw.New(qw.ArraySet)}Release(){this._instances.Release(),this._instances=null,this._grid=null}IsEmpty(){return this._instances.IsEmpty()}Insert(e){this._instances.Add(e)}Remove(e){this._instances.Delete(e)}Dump(e){qw.appendArray(e,this._instances.GetArray())}}}{const Kw=self.C3,$w=1e-6,Jw=2;Kw.Ray=class{constructor(){this.x1=0,this.y1=0,this.x2=0,this.y2=0,this.dx=0,this.dy=0,this.rect=new Kw.Rect,this.hitFraction=2,this.hitUid=null,this.hitNormal=0,this.hitNormalDx=0,this.hitNormalDy=0,this.hitX=0,this.hitY=0,this.distance=0,this.normalX=1,this.normalY=0,this.reflectionX=1,this.reflectionY=0}DidCollide(){return this.hitFraction<1.000001}Reset(){this.hitFraction=2}Set(e,t,s,i){return this.x1=e,this.y1=t,this.x2=s,this.y2=i,this.dx=s-e,this.dy=i-t,this.rect.set(e,t,s,i),this.rect.normalize(),this.hitFraction=2,this.hitUid=null,this.hitNormal=0,this.hitNormalDx=0,this.hitNormalDy=0,this.hitX=0,this.hitY=0,this.distance=0,this.normalX=1,this.normalY=0,this.reflectionX=1,this.reflectionY=0,this}Complete(){if(!1===this.DidCollide())return;const e=this.dx*this.hitFraction,t=this.dy*this.hitFraction,s=Kw.hypot2DFast(e,t),i=e/s,r=t/s;this.distance=s-$w,this.hitX=this.x1+i*this.distance,this.hitY=this.y1+r*this.distance,this.hitNormal=Math.atan2(this.hitNormalDy,this.hitNormalDx)+Math.PI/2,this.normalX=Math.cos(this.hitNormal),this.normalY=Math.sin(this.hitNormal);const n=i*this.normalX+r*this.normalY;if(this.reflectionX=i-2*this.normalX*n,this.reflectionY=r-2*this.normalY*n,n>0){const e=Math.PI;this.hitNormal=Kw.clampAngle(this.hitNormal+e),this.normalX=-this.normalX,this.normalY=-this.normalY}}TestInstanceSegment(e,t,s,i,r){const n=Kw.rayIntersect(this.x1,this.y1,this.x2,this.y2,t,s,i,r);n>=0&&n<this.hitFraction&&(this.hitFraction=n,this.hitUid=e.GetUID(),this.hitNormalDx=t-i,this.hitNormalDy=s-r)}TestInstanceRect(e,t,s,i){const r=t+i.getLeft(),n=t+i.getRight(),a=s+i.getTop(),o=s+i.getBottom();this.TestInstanceSegment(e,r,a,n,a),this.TestInstanceSegment(e,n,a,n,o),this.TestInstanceSegment(e,n,o,r,o),this.TestInstanceSegment(e,r,o,r,a)}TestInstanceQuad(e,t){const s=t.getTlx(),i=t.getTly(),r=t.getTrx(),n=t.getTry(),a=t.getBrx(),o=t.getBry(),h=t.getBlx(),l=t.getBly();this.TestInstanceSegment(e,s,i,r,n),this.TestInstanceSegment(e,r,n,a,o),this.TestInstanceSegment(e,a,o,h,l),this.TestInstanceSegment(e,h,l,s,i)}TestInstancePoly(e,t,s,i){const r=i.pointsArr();for(let i=0,n=r.length;i<n;i+=2){const a=(i+2)%n,o=r[i]+t,h=r[i+1]+s,l=r[a]+t,c=r[a+1]+s;this.TestInstanceSegment(e,o,h,l,c)}}}}{const Zw=self.C3;Zw.LayerStateCache=class{constructor(){this._layerCache=new Map}Release(){for(const e of this._layerCache.values())e.layerPts.Clear();this._layerCache.clear()}_GetLayerCache(e){let t=this._layerCache.get(e);return void 0===t&&(t={isInteractive:null,layerPts:new Zw.PairMap},this._layerCache.set(e,t)),t}IsInteractive(e){const t=this._GetLayerCache(e);return null===t.isInteractive&&(t.isInteractive=e.IsSelfAndParentsInteractive()),t.isInteractive}CanvasCssToLayer(e,t,s,i){if(0!==i)return e.CanvasCssToLayer(t,s,i);const r=this._GetLayerCache(e);let n=r.layerPts.Get(t,s);return void 0===n&&(n=e.CanvasCssToLayer(t,s,i),r.layerPts.Set(t,s,n)),n}}}{const Qw=self.C3,eP=new Set(["off","crop","scale-inner","scale-outer","letterbox-scale","letterbox-integer-scale"]),tP=new Set(["high","low"]),sP=self.glMatrix,iP=sP.mat4,rP=sP.vec3,nP=iP.create(),aP=300,oP=200,hP=120,lP=8,cP=Qw.New(Qw.Quad),uP=Qw.New(Qw.Rect),dP=3e3,_P=200,pP=300,fP=8;Qw.CanvasManager=class extends Qw.DefendedBase{#e=null;constructor(e){super(),this._runtime=e,this._canvasLayers=[],this._isWebGPUEnabled=!1,this._webglRenderer=null,this._webgpuRenderer=null,this._iRenderer=null,this._gpuPreference="high-performance",this._isLimitedToWebGL1=!1,this._multitexturingMode="auto",this._windowInnerWidth=0,this._windowInnerHeight=0,this._cssDisplayMode="",this._canvasCssWidth=0,this._canvasCssHeight=0,this._canvasDeviceWidth=0,this._canvasDeviceHeight=0,this._canvasCssOffsetX=0,this._canvasCssOffsetY=0,this._zAxisScale="normalized",this._initFieldOfView=0,this._zNear=1,this._zFar=1e4,this._enableMipmaps=!0,this._textureAnisotropy=0,this._drawWidth=0,this._drawHeight=0,this._fullscreenMode="letterbox-scale",this._documentFullscreenMode="letterbox-scale",this._deviceTransformOffX=0,this._deviceTransformOffY=0,this._defaultProjectionMatrix=iP.create(),this._wantFullscreenScalingQuality="high",this._fullscreenScalingQuality=this._wantFullscreenScalingQuality,this._isDocumentFullscreen=!1,this._availableAdditionalRenderTargets=[],this._usedAdditionalRenderTargets=new Set,this._shaderData=self.C3_Shaders,this._effectChainManager=Qw.New(Qw.Gfx.EffectChainManager,{getDrawSize:()=>[this.GetDrawWidth(),this.GetDrawHeight()],getRenderTarget:()=>this.GetEffectCompositorRenderTarget(),releaseRenderTarget:e=>this.ReleaseEffectCompositorRenderTarget(e),getTime:()=>this.GetRuntime().GetGameTime(),redraw:()=>this.GetRuntime().UpdateRender()}),this._gpuTimeStartFrame=0,this._gpuTimeEndFrame=0,this._gpuLastUtilisation=NaN,this._gpuFrameTimingsBuffer=null,this._layersGpuProfile=new Map,this._gpuCurUtilisation=NaN,this._webgpuTimingPromises=new Map,this._snapshotFormat="",this._snapshotQuality=1,this._snapshotArea=Qw.New(Qw.Rect),this._snapshotUrl="",this._snapshotPromise=null,this._snapshotResolve=null,this._isPastingToDrawingCanvas=0,this._loaderStartTime=0,this._rafId=-1,this._loadingProgress=0,this._loadingprogress_handler=e=>this._loadingProgress=e.progress,this._percentText=null,this._splashTextures={logo:null,powered:null,website:null},this._splashFrameNumber=0,this._splashFadeInFinishTime=0,this._splashFadeOutStartTime=0,this._splashState="fade-in",this._splashDoneResolve=null,this._splashDonePromise=new Promise(e=>this._splashDoneResolve=e)}_SetGPUPowerPreference(e){this._gpuPreference=e}_SetWebGPUEnabled(e){this._isWebGPUEnabled=!!e}_SetZAxisScale(e){this._zAxisScale=e}GetZAxisScale(){return this._zAxisScale}_SetInitFieldOfView(e){this._initFieldOfView=e}_SetZDistances(e,t){this._zNear=e,this._zFar=t}_SetLimitedToWebGL1(e){this._isLimitedToWebGL1=!!e}_SetMultitexturingMode(e){this._multitexturingMode=e}async CreateCanvas(e){let t=e.canvas;this._canvasLayers.push({canvas:t,ctx:null}),this._runtime.AddDOMComponentMessageHandler("runtime","window-resize",e=>this._OnWindowResize(e)),this._runtime.AddDOMComponentMessageHandler("runtime","fullscreenchange",e=>this._OnFullscreenChange(e)),this._runtime.AddDOMComponentMessageHandler("runtime","fullscreenerror",e=>this._OnFullscreenError(e)),t.addEventListener("webglcontextlost",e=>this._OnWebGLContextLost(e)),t.addEventListener("webglcontextrestored",e=>this._OnWebGLContextRestored(e)),this._isDocumentFullscreen=!!e.isFullscreen,this._cssDisplayMode=e.cssDisplayMode;const s=navigator.gpu&&this._isWebGPUEnabled;let i=!1;if(s)try{await this._InitWebGPUContext(!0)}catch(e){this._MaybeLogRendererError("WebGPU",e),this._webgpuRenderer=null}if(!this.GetRenderer())try{await this._InitWebGLContext(!0)}catch(e){this._MaybeLogRendererError("WebGL",e),this._webglRenderer=null}if(this.GetRenderer()||(i=!0),!this.GetRenderer()&&s)try{await this._InitWebGPUContext(!1)}catch(e){this._MaybeLogRendererError("WebGPU",e),this._webgpuRenderer=null}if(!this.GetRenderer())try{await this._InitWebGLContext(!1)}catch(e){this._MaybeLogRendererError("WebGL",e),this._webglRenderer=null}const r=this.GetRenderer();if(!r)throw new Error("failed to acquire a renderer - check WebGL or WebGPU is supported");r.SetHasMajorPerformanceCaveat(i),this._webgpuRenderer&&(this._webgpuRenderer.ondevicelost=()=>this._OnWebGPUDeviceLost(),this._webgpuRenderer.ondevicerestored=()=>this._OnWebGPUDeviceRestored()),"normalized"===this._zAxisScale?r.SetZAxisScaleNormalized():(r.SetZAxisScaleRegular(),r.SetFovY(this._initFieldOfView)),this.SetSize(e.windowInnerWidth,e.windowInnerHeight,!0),await this._InitRenderer()}_MaybeLogRendererError(e,t){t&&"string"==typeof t.message&&t.message.startsWith("renderer-unavailable")||console.error(`Error creating ${e} renderer: `,t)}async _InitWebGPUContext(e){const t={nearZ:this._zNear,farZ:this._zFar};let s=!0;"no"===this._multitexturingMode?s=!1:"auto"===this._multitexturingMode&&(s=Qw.Platform.IsDesktop);let i="nearest";this._runtime.UsesAnyCrossSampling()&&"nearest"!==this._runtime.GetSampling()&&(i="bilinear");const r={powerPreference:this._gpuPreference,depth:this._runtime.Uses3DFeatures(),failIfMajorPerformanceCaveat:e,usesBackgroundBlending:this._runtime.UsesAnyBackgroundBlending(),canSampleBackbuffer:this._runtime.UsesAnyCrossSampling(),backTextureSampling:i,canSampleDepth:this._runtime.UsesAnyDepthSampling(),isMultiTexturingAllowed:s};this._webgpuRenderer=Qw.New(Qw.Gfx.WebGPURenderer,t),await this._webgpuRenderer.Create(this._canvasLayers[0].canvas,r)}async _InitWebGLContext(e){const t={alpha:!0,powerPreference:this._gpuPreference,enableGpuProfiling:"xbox-uwp-webview2"!==this._runtime.GetExportType(),depth:this._runtime.Uses3DFeatures(),canSampleDepth:this._runtime.UsesAnyDepthSampling(),failIfMajorPerformanceCaveat:e,nearZ:this._zNear,farZ:this._zFar};this._isLimitedToWebGL1&&(t.maxWebGLVersion=1),this._webglRenderer=Qw.New(Qw.Gfx.WebGLRenderer,this._canvasLayers[0].canvas,t),await this._webglRenderer.InitState()}async _InitWebGPU(){if(this._shaderData){const e=[];for(const[t,s]of Object.entries(this._shaderData)){s.src=s.wgsl;const i=Qw.Gfx.WebGPUShaderProgram.GetDefaultVertexShaderSource(this._webgpuRenderer.IsColorDataF16());e.push(this._webgpuRenderer.CreateShaderProgram(Object.assign({vertexSrc:i,name:t},s)))}await Promise.all(e)}}async _InitWebGL(){if(this._shaderData){const e=[];for(const[t,s]of Object.entries(this._shaderData)){let i;if(s.glslWebGL2&&this._webglRenderer.GetWebGLVersionNumber()>=2)s.src=s.glslWebGL2,i=Qw.Gfx.WebGLShaderProgram.GetDefaultVertexShaderSource_WebGL2();else{if(!s.glsl)throw new Error(`shader '${t}' does not support WebGL 1`);s.src=s.glsl,i=Qw.Gfx.WebGLShaderProgram.GetDefaultVertexShaderSource()}e.push(this._webglRenderer.CreateShaderProgram(Object.assign({vertexSrc:i,name:t},s)))}await Promise.all(e),this._webglRenderer.ResetLastProgram(),this._webglRenderer.SetTextureFillMode()}this._webglRenderer.SupportsGPUProfiling()&&(this._gpuFrameTimingsBuffer=Qw.New(Qw.Gfx.WebGLQueryResultBuffer,this._webglRenderer))}async _InitRenderer(){this._webgpuRenderer?await this._InitWebGPU():this._webglRenderer&&await this._InitWebGL();const e=this.GetRenderer();e.SetMipmapsEnabled(this._enableMipmaps),e.SupportsGPUProfiling()&&(this._gpuLastUtilisation=0);for(const t of this._runtime._GetAllEffectLists()){for(const s of t.GetAllEffectTypes())s._InitRenderer(e);t._InitRenderer(e),t.UpdateActiveEffects()}this._iRenderer=new self.IRenderer(this._runtime,e)}Release(){this._runtime=null,this._webglRenderer=null,this._canvasLayers.length=0}IsInWorker(){return this._runtime.IsInWorker()}_OnWindowResize(e){const t=this._runtime;if(t.IsExportToVideo())return;const s=e.devicePixelRatio;this.IsInWorker()&&(self.devicePixelRatio=s),t._SetDevicePixelRatio(s),this._isDocumentFullscreen=!!e.isFullscreen,this._cssDisplayMode=e.cssDisplayMode,this.SetSize(e.innerWidth,e.innerHeight),t.UpdateRender();const i=new Qw.Event("window-resize");i.data=e,t.Dispatcher().dispatchEventAndWaitAsyncSequential(i);const r=new Qw.Event("resize");r.cssWidth=this.GetCssWidth(),r.cssHeight=this.GetCssHeight(),r.deviceWidth=this.GetDeviceWidth(),r.deviceHeight=this.GetDeviceHeight(),t.DispatchUserScriptEvent(r),this._runtime.GetCurrentLayout()?.BoundScrolling(),t.IsDebug()&&(t.HitBreakpoint()||self.C3Debugger.IsDebuggerPaused())&&t.Render()}_OnFullscreenChange(e){this._isDocumentFullscreen=!!e.isFullscreen,this.SetSize(e.innerWidth,e.innerHeight,!0),this._runtime.UpdateRender()}_OnFullscreenError(e){this._isDocumentFullscreen=!!e.isFullscreen,this.SetSize(e.innerWidth,e.innerHeight,!0),this._runtime.UpdateRender()}SetSize(e,t,s=!1){if(e=Math.floor(e),t=Math.floor(t),e<=0||t<=0)throw new Error("invalid size");if(this._windowInnerWidth===e&&this._windowInnerHeight===t&&!s)return;this._windowInnerWidth=e,this._windowInnerHeight=t;const i=this.GetCurrentFullscreenMode();"letterbox-scale"===i?this._CalculateLetterboxScale(e,t):"letterbox-integer-scale"===i?this._CalculateLetterboxIntegerScale(e,t):"off"===i?this._CalculateFixedSizeCanvas(e,t):this._CalculateFullsizeCanvas(e,t),this._UpdateFullscreenScalingQuality(i);for(const{canvas:e}of this._canvasLayers)e.width=this._canvasDeviceWidth,e.height=this._canvasDeviceHeight;this._runtime.PostComponentMessageToDOM("canvas","update-size",{marginLeft:this._canvasCssOffsetX,marginTop:this._canvasCssOffsetY,styleWidth:this._canvasCssWidth,styleHeight:this._canvasCssHeight,displayScale:this.GetDisplayScale()});const r=this.GetRenderer();r.SetSize(this._canvasDeviceWidth,this._canvasDeviceHeight,!0);for(const e of this._availableAdditionalRenderTargets)r.DeleteRenderTarget(e);Qw.clearArray(this._availableAdditionalRenderTargets),this.UpdateDefaultProjectionMatrix();const n=this._runtime.GetLayoutManager();n.SetAllLayerProjectionChanged(),n.SetAllLayerMVChanged()}UpdateDefaultProjectionMatrix(){this.GetRenderer().CalculatePerspectiveMatrix(this._defaultProjectionMatrix,this.GetDrawWidth()/this.GetDrawHeight())}GetDefaultProjectionMatrix(){return this._defaultProjectionMatrix}_CalculateLetterboxScale(e,t){const s=this._runtime.GetDevicePixelRatio(),i=this._runtime.GetOriginalViewportWidth(),r=this._runtime.GetOriginalViewportHeight(),n=i/r;if(e/t>n){const s=t*n;this._canvasCssWidth=Math.round(s),this._canvasCssHeight=t,this._canvasCssOffsetX=Math.floor((e-this._canvasCssWidth)/2),this._canvasCssOffsetY=0}else{const s=e/n;this._canvasCssWidth=e,this._canvasCssHeight=Math.round(s),this._canvasCssOffsetX=0,this._canvasCssOffsetY=Math.floor((t-this._canvasCssHeight)/2)}this._canvasDeviceWidth=Math.round(this._canvasCssWidth*s),this._canvasDeviceHeight=Math.round(this._canvasCssHeight*s),this._runtime.SetViewportSize(i,r)}_CalculateLetterboxIntegerScale(e,t){const s=this._runtime.GetDevicePixelRatio();1!==s&&(e+=1,t+=1);const i=this._runtime.GetOriginalViewportWidth(),r=this._runtime.GetOriginalViewportHeight(),n=i/r;let a;a=e/t>n?t*n*s/i:e/n*s/r,a>1?a=Math.floor(a):a<1&&(a=1/Math.ceil(1/a)),this._canvasDeviceWidth=Math.round(i*a),this._canvasDeviceHeight=Math.round(r*a),this._canvasCssWidth=this._canvasDeviceWidth/s,this._canvasCssHeight=this._canvasDeviceHeight/s,this._canvasCssOffsetX=Math.max(Math.floor((e-this._canvasCssWidth)/2),0),this._canvasCssOffsetY=Math.max(Math.floor((t-this._canvasCssHeight)/2),0),this._runtime.SetViewportSize(i,r)}_CalculateFullsizeCanvas(e,t){const s=this._runtime.GetDevicePixelRatio();this._canvasCssWidth=e,this._canvasCssHeight=t,this._canvasDeviceWidth=Math.round(this._canvasCssWidth*s),this._canvasDeviceHeight=Math.round(this._canvasCssHeight*s),this._canvasCssOffsetX=0,this._canvasCssOffsetY=0;const i=this.GetDisplayScale();this._runtime.SetViewportSize(this._canvasCssWidth/i,this._canvasCssHeight/i)}_CalculateFixedSizeCanvas(e,t){const s=this._runtime.GetDevicePixelRatio();this._canvasCssWidth=this._runtime.GetViewportWidth(),this._canvasCssHeight=this._runtime.GetViewportHeight(),this._canvasDeviceWidth=Math.round(this._canvasCssWidth*s),this._canvasDeviceHeight=Math.round(this._canvasCssHeight*s),this.IsDocumentFullscreen()?(this._canvasCssOffsetX=Math.floor((e-this._canvasCssWidth)/2),this._canvasCssOffsetY=Math.floor((t-this._canvasCssHeight)/2)):(this._canvasCssOffsetX=0,this._canvasCssOffsetY=0),this._runtime.SetViewportSize(this._runtime.GetViewportWidth(),this._runtime.GetViewportHeight())}_UpdateFullscreenScalingQuality(e){if("high"===this._wantFullscreenScalingQuality)this._drawWidth=this._canvasDeviceWidth,this._drawHeight=this._canvasDeviceHeight,this._fullscreenScalingQuality="high";else{let t,s;if("off"===this.GetCurrentFullscreenMode()?(t=this._runtime.GetViewportWidth(),s=this._runtime.GetViewportHeight()):(t=this._runtime.GetOriginalViewportWidth(),s=this._runtime.GetOriginalViewportHeight()),this._canvasDeviceWidth<t||this._canvasDeviceHeight<s)this._drawWidth=this._canvasDeviceWidth,this._drawHeight=this._canvasDeviceHeight,this._fullscreenScalingQuality="high";else if(this._drawWidth=t,this._drawHeight=s,this._fullscreenScalingQuality="low","scale-inner"===e){const e=t/s,i=this._windowInnerWidth/this._windowInnerHeight;i<e?this._drawWidth=this._drawHeight*i:i>e&&(this._drawHeight=this._drawWidth/i)}else if("scale-outer"===e){const e=t/s,i=this._windowInnerWidth/this._windowInnerHeight;i>e?this._drawWidth=this._drawHeight*i:i<e&&(this._drawHeight=this._drawWidth/i)}}}GetRuntime(){return this._runtime}GetMainCanvas(){return this._canvasLayers[0].canvas}GetEffectChainManager(){return this._effectChainManager}IsDocumentFullscreen(){return this._isDocumentFullscreen}GetCssDisplayMode(){return this._cssDisplayMode}SetFullscreenMode(e){if(!eP.has(e))throw new Error("invalid fullscreen mode");this._fullscreenMode=e;const t=this._runtime.GetLayoutManager();t.SetAllLayerProjectionChanged(),t.SetAllLayerMVChanged()}GetFullscreenMode(){return this._fullscreenMode}SetDocumentFullscreenMode(e){if(!eP.has(e))throw new Error("invalid fullscreen mode");this._documentFullscreenMode=e;const t=this._runtime.GetLayoutManager();t.SetAllLayerProjectionChanged(),t.SetAllLayerMVChanged()}GetDocumentFullscreenMode(){return this._documentFullscreenMode}GetCurrentFullscreenMode(){return this.IsDocumentFullscreen()?this.GetDocumentFullscreenMode():this.GetFullscreenMode()}SetFullscreenScalingQuality(e){if(!tP.has(e))throw new Error("invalid fullscreen scaling quality");this._wantFullscreenScalingQuality=e,this._runtime.GetLayoutManager().SetAllLayerProjectionChanged()}GetSetFullscreenScalingQuality(){return this._wantFullscreenScalingQuality}GetCurrentFullscreenScalingQuality(){return this._fullscreenScalingQuality}static _FullscreenModeNumberToString(e){switch(e){case 0:return"off";case 1:return"crop";case 2:return"scale-inner";case 3:return"scale-outer";case 4:return"letterbox-scale";case 5:return"letterbox-integer-scale";default:throw new Error("invalid fullscreen mode")}}GetLastWidth(){return this._windowInnerWidth}GetLastHeight(){return this._windowInnerHeight}GetDrawWidth(){return this._drawWidth}GetDrawHeight(){return this._drawHeight}SetMipmapsEnabled(e){this._enableMipmaps=!!e}GetMipmapsEnabled(){return this._enableMipmaps}_SetTextureAnisotropy(e){this._textureAnisotropy=e}GetTextureAnisotropy(){return this._textureAnisotropy}IsRendererContextLost(){return this.GetRenderer().IsContextLost()}_OnWebGLContextLost(e){console.log("[Construct] WebGL context lost"),e.preventDefault(),this._availableAdditionalRenderTargets=[],this._usedAdditionalRenderTargets.clear(),this._effectChainManager.OnContextLost(),this._webglRenderer.OnContextLost(),this._runtime._OnRendererContextLost()}_OnWebGPUDeviceLost(){console.log("[Construct] WebGPU device lost"),this._availableAdditionalRenderTargets=[],this._usedAdditionalRenderTargets.clear(),this._effectChainManager.OnContextLost(),this._runtime._OnRendererContextLost()}async _OnWebGLContextRestored(e){await this._webglRenderer.OnContextRestored(),await this._InitRenderer(),await this._runtime._OnRendererContextRestored(),console.log("[Construct] WebGL context restored")}async _OnWebGPUDeviceRestored(){await this._InitRenderer(),await this._runtime._OnRendererContextRestored(),console.log("[Construct] WebGPU device restored")}GetWebGLRenderer(){return this._webglRenderer}GetWebGPURenderer(){return this._webgpuRenderer}GetRenderer(){return this._webgpuRenderer||this._webglRenderer}GetIRenderer(){return this._iRenderer}GetRendererString(){let e="";return e=this._runtime.GetWebGPURenderer()?"webgpu":"webgl"+this._runtime.GetWebGLRenderer().GetWebGLVersionNumber(),this._runtime.GetRenderer().HasMajorPerformanceCaveat()&&(e+="-software"),e}GetRendererDetailString(){return this._runtime.GetWebGPURenderer()?this._runtime.GetWebGPURenderer().GetAdapterInfoString():this._runtime.GetWebGLRenderer().GetUnmaskedRenderer()}GetRenderScale(){return"low"===this._fullscreenScalingQuality?1/this._runtime.GetDevicePixelRatio():this.GetDisplayScale()}GetDisplayScale(){const e=this.GetCurrentFullscreenMode();if("off"===e||"crop"===e)return 1;const t=this._runtime.GetOriginalViewportWidth(),s=this._runtime.GetOriginalViewportHeight(),i=t/s,r=this._canvasDeviceWidth/this._canvasDeviceHeight;return"scale-inner"!==e&&r>i||"scale-inner"===e&&r<i?this._canvasCssHeight/s:this._canvasCssWidth/t}GetEffectLayerScaleParam(){return"low"===this.GetCurrentFullscreenScalingQuality()?1:this.GetDisplayScale()}GetEffectDevicePixelRatioParam(){return"low"===this.GetCurrentFullscreenScalingQuality()?1:this._runtime.GetDevicePixelRatio()}SetDeviceTransformOffset(e,t){this._deviceTransformOffX=e,this._deviceTransformOffY=t}SetDeviceTransform(e,t,s,i=!0){t=t||this._drawWidth,s=s||this._drawHeight;const r=t/2+this._deviceTransformOffX,n=s/2+this._deviceTransformOffY;if(i){let i=this.GetDefaultProjectionMatrix();t===this._drawWidth&&s===this._drawHeight||(e.CalculatePerspectiveMatrix(nP,t/s),i=nP),e.SetProjectionMatrix(i)}const a=e.CalculateLookAtModelView2(r,n,e.GetDefaultCameraZ(s),r,n,0,s);e.SetModelViewMatrix(a)}SetCssTransform(e,t=!0){const s=this.GetCssWidth(),i=this.GetCssHeight(),r=s/2,n=i/2;t&&e.SetProjectionMatrix(this.GetDefaultProjectionMatrix());const a=e.CalculateLookAtModelView2(r,n,e.GetDefaultCameraZ(i),r,n,0,i);e.SetModelViewMatrix(a)}GetDeviceWidth(){return this._canvasDeviceWidth}GetDeviceHeight(){return this._canvasDeviceHeight}GetCssWidth(){return this._canvasCssWidth}GetCssHeight(){return this._canvasCssHeight}GetCanvasClientX(){return this._canvasCssOffsetX}GetCanvasClientY(){return this._canvasCssOffsetY}GetHTMLLayerCount(){return this._canvasLayers.length}_CanUseImageBitmapRenderingContext(){return"undefined"!=typeof OffscreenCanvas&&this.GetMainCanvas()instanceof OffscreenCanvas&&("Chromium"!==Qw.Platform.BrowserEngine||Qw.Platform.BrowserVersionNumber>=124)}async SetHTMLLayerCount(e,t=!1){if(e<1)throw new Error("invalid HTML layer count");if(this._canvasLayers.length===e)return;const s={count:e,layersDomState:this._runtime.GetLayoutManager().GetMainRunningLayout()._GetRootLayers().filter(e=>e.IsHTMLElementsLayer()).map(e=>e._GetHTMLLayerDOMState()),immediate:t,marginLeft:this._canvasCssOffsetX,marginTop:this._canvasCssOffsetY,styleWidth:this._canvasCssWidth,styleHeight:this._canvasCssHeight};let i;if(i=this.IsInWorker()?await this._runtime.PostComponentMessageToDOMAsync("canvas","set-html-layer-count",s):self.c3_runtimeInterface._OnSetHTMLLayerCount(s),e<this._canvasLayers.length)this._canvasLayers.length=e;else for(const e of i.addedCanvases){e.width=this._canvasDeviceWidth,e.height=this._canvasDeviceHeight;const t=this._CanUseImageBitmapRenderingContext()?"bitmaprenderer":"2d",s=e.getContext(t);if(!s)throw new Error(`failed to acquire '${t}' canvas context`);this._canvasLayers.push({canvas:e,ctx:s})}this._runtime.UpdateRender()}BlitMainCanvasToHTMLLayerCanvas(e){if(e>=this._canvasLayers.length)return;const t=this.GetMainCanvas(),s=this._canvasLayers[e].ctx;this._CanUseImageBitmapRenderingContext()?s.transferFromImageBitmap(t.transferToImageBitmap()):(s.globalCompositeOperation="copy",s.drawImage(t,0,0))}GetAdditionalRenderTarget(e){e.depth=this._runtime.Uses3DFeatures();const t=this._availableAdditionalRenderTargets,s=t.findIndex(t=>t.IsCompatibleWithOptions(e));let i;return-1!==s?(i=t[s],t.splice(s,1)):i=this.GetRenderer().CreateRenderTarget(e),this._usedAdditionalRenderTargets.add(i),i}ReleaseAdditionalRenderTarget(e){if(!this._usedAdditionalRenderTargets.has(e))throw new Error("render target not in use");this._usedAdditionalRenderTargets.delete(e),this._availableAdditionalRenderTargets.push(e)}GetEffectCompositorRenderTarget(){const e={sampling:this._runtime.GetSampling()};return"low"===this.GetCurrentFullscreenScalingQuality()&&(e.width=this.GetDrawWidth(),e.height=this.GetDrawHeight()),this.GetAdditionalRenderTarget(e)}ReleaseEffectCompositorRenderTarget(e){this.ReleaseAdditionalRenderTarget(e)}*activeLayersGpuProfiles(){for(const e of this._runtime.GetLayoutManager().runningLayouts())for(const t of e.GetLayers()){const e=this._layersGpuProfile.get(t);e&&(yield e)}}GetLayerTimingsBuffer(e){if(!this.GetRenderer().SupportsGPUProfiling())return null;let t=this._layersGpuProfile.get(e);return t||(t={layer:e,name:e.GetName(),timingsBuffer:Qw.New(Qw.Gfx.WebGLQueryResultBuffer,this._webglRenderer),curUtilisation:0,lastTotalUtilisation:0,lastSelfUtilisation:0},this._layersGpuProfile.set(e,t)),t.timingsBuffer}_Update1sFrameRange(){const e=this.GetRenderer();if(e.SupportsGPUProfiling()&&0===this._gpuTimeEndFrame){this._gpuTimeEndFrame=e.GetFrameNumber(),this._gpuCurUtilisation=NaN;for(const e of this.activeLayersGpuProfiles())e.curUtilisation=NaN}}_UpdateTick(){this._webglRenderer&&this._webglRenderer.SupportsGPUProfiling()&&this._UpdateTick_WebGL(),this._webgpuRenderer&&this._webgpuRenderer.SupportsGPUProfiling()&&this._UpdateTick_WebGPU()}_UpdateTick_WebGL(){if(isNaN(this._gpuCurUtilisation)&&(this._gpuCurUtilisation=this._gpuFrameTimingsBuffer.GetFrameRangeResultSum(this._gpuTimeStartFrame,this._gpuTimeEndFrame),!isNaN(this._gpuCurUtilisation))){if(this._runtime.IsDebug())for(const e of this.activeLayersGpuProfiles())if(e.curUtilisation=e.timingsBuffer.GetFrameRangeResultSum(this._gpuTimeStartFrame,this._gpuTimeEndFrame),isNaN(e.curUtilisation))return;if(this._gpuFrameTimingsBuffer.DeleteAllBeforeFrameNumber(this._gpuTimeEndFrame),this._gpuLastUtilisation=Math.min(this._gpuCurUtilisation,1),this._runtime.IsDebug()){const e=new Map;for(const t of this.activeLayersGpuProfiles())t.timingsBuffer.DeleteAllBeforeFrameNumber(this._gpuTimeEndFrame),t.lastTotalUtilisation=Math.min(t.curUtilisation,1),e.set(t.layer,t.lastTotalUtilisation);for(const t of this.activeLayersGpuProfiles()){const s=t.layer,i=(e.get(s)||0)-s.GetSubLayers().reduce((t,s)=>t+(e.get(s)||0),0);t.lastSelfUtilisation=Qw.clamp(i,0,1)}const t=this._runtime.GetMainRunningLayout(),s=this._gpuLastUtilisation-t._GetRootLayers().reduce((t,s)=>t+(e.get(s)||0),0);self.C3Debugger.UpdateGPUProfile(Qw.clamp(s,0,1),this._gpuLastUtilisation,[...this.activeLayersGpuProfiles()])}this._gpuTimeStartFrame=this._gpuTimeEndFrame,this._gpuTimeEndFrame=0}}GetGPUFrameTimingsBuffer(){return this._gpuFrameTimingsBuffer}_UpdateTick_WebGPU(){if(0===this._gpuTimeEndFrame)return;const e=[];for(let t=this._gpuTimeStartFrame;t<this._gpuTimeEndFrame;++t)e.push(this._webgpuTimingPromises.get(t)),this._webgpuTimingPromises.delete(t);this._gpuTimeStartFrame=this._gpuTimeEndFrame,this._gpuTimeEndFrame=0,this.#s(e)}async#s(e){let t;try{t=await Promise.all(e)}catch(e){return void console.error("[WebGPU] Error reading frame timing results: ",e)}const s=this._runtime.GetMainRunningLayout(),i=Qw.MakeFilledArray(s.GetLayerCount()+1,0);let r=0;for(const e of t){if(!e)continue;let t=BigInt(0),s=BigInt(0);const n=BigInt(0);for(let r=0,a=Math.min(i.length,e.length/2);r<a;++r){const a=e[2*r],o=e[2*r+1];a!==n&&(t===n||a<t)&&(t=a),o>s&&(s=o);const h=Number(o-a)/1e9;i[r]+=h}r+=Number(s-t)/1e9}if(this._gpuLastUtilisation=Qw.clamp(r,0,1),this._runtime.IsDebug()){const e=s.GetLayers(),t=new Map;for(let s=0,r=Math.min(e.length,i.length-1);s<r;++s){const r=i[s+1];t.set(e[s],r)}const r=[],n=new Map;for(const[e,s]of t){const i=[...e.selfAndAllSubLayers()].reduce((e,s)=>e+(t.get(s)||0),0);n.set(e,i),r.push({name:e.GetName(),lastSelfUtilisation:Qw.clamp(s,0,1),lastTotalUtilisation:Qw.clamp(i,0,1)})}const a=this._gpuLastUtilisation-s._GetRootLayers().reduce((e,t)=>e+(n.get(t)||0),0);self.C3Debugger.UpdateGPUProfile(Qw.clamp(a,0,1),this._gpuLastUtilisation,r)}}_AddWebGPUFrameTimingResultPromise(e){this._webgpuTimingPromises.set(this._webgpuRenderer.GetFrameNumber(),e)}_GetRendererThrottlePromise(){const e=this.GetRenderer();if(e.GetFrameNumber()%8!=0)return null;const t=this.#e;return this.#e=e.WaitForSubmittedWorkDone(),t}GetGPUUtilisation(){return this._gpuLastUtilisation}SnapshotCanvas(e,t,s,i,r,n){return this._snapshotFormat=e,this._snapshotQuality=t,this._snapshotArea.setWH(s,i,r,n),this._snapshotPromise||(this._snapshotPromise=new Promise(e=>{this._snapshotResolve=e})),this._snapshotPromise}_MaybeTakeSnapshot(){if(!this._snapshotFormat)return;let e=this.GetMainCanvas();const t=this._snapshotArea,s=Qw.clamp(Math.floor(t.getLeft()),0,e.width),i=Qw.clamp(Math.floor(t.getTop()),0,e.height);let r=t.width();r=0===r?e.width-s:Qw.clamp(Math.floor(r),0,e.width-s);let n=t.height();if(n=0===n?e.height-i:Qw.clamp(Math.floor(n),0,e.height-i),(0!==s||0!==i||r!==e.width||n!==e.height)&&r>0&&n>0){const t=Qw.CreateCanvas(r,n);t.getContext("2d").drawImage(e,s,i,r,n,0,0,r,n),e=t}Qw.CanvasToBlob(e,this._snapshotFormat,this._snapshotQuality).then(e=>{this._snapshotUrl&&URL.revokeObjectURL(this._snapshotUrl),this._snapshotUrl=URL.createObjectURL(e),this._snapshotPromise=null,this._snapshotResolve(e)}),this._snapshotFormat="",this._snapshotQuality=1}GetCanvasSnapshotUrl(){return this._snapshotUrl}SetIsPastingToDrawingCanvas(e){e?this._isPastingToDrawingCanvas++:this._isPastingToDrawingCanvas--}IsPastingToDrawingCanvas(){return this._isPastingToDrawingCanvas>0}InitLoadingScreen(e){const t=this.GetRenderer();if(2===e)this._percentText=Qw.New(Qw.Gfx.RendererText,this.GetRenderer()),this._percentText.SetFontName("Arial"),this._percentText.SetFontSize(16),this._percentText.SetHorizontalAlignment("center"),this._percentText.SetVerticalAlignment("center"),this._percentText.SetSize(300,200);else if(0===e){const e=this._runtime.GetLoadingLogoAsset();e&&e.LoadStaticTexture(t).catch(e=>console.warn("[C3 runtime] Failed to create texture for loading logo: ",e))}else 4===e&&(this._LoadSvgSplashImage("splash-images/splash-logo.svg").then(e=>{"done"===this._splashState?t.DeleteTexture(e):this._splashTextures.logo=e}).catch(e=>console.warn("Failed to load splash image: ",e)),this._LoadBitmapSplashImage("splash-images/splash-poweredby-512.png").then(e=>{"done"===this._splashState?t.DeleteTexture(e):this._splashTextures.powered=e}).catch(e=>console.warn("Failed to load splash image: ",e)),this._LoadBitmapSplashImage("splash-images/splash-website-512.png").then(e=>{"done"===this._splashState?t.DeleteTexture(e):this._splashTextures.website=e}).catch(e=>console.warn("Failed to load splash image: ",e)))}async _LoadSvgSplashImage(e){e=new URL(e,this._runtime.GetRuntimeBaseURL()).toString();const t=await Qw.FetchBlob(e),s=await this._runtime.RasterSvgImage(t,2048,2048);return await this.GetRenderer().CreateStaticTextureAsync(s,{mipMapQuality:"high"})}async _LoadBitmapSplashImage(e){e=new URL(e,this._runtime.GetRuntimeBaseURL()).toString();const t=await Qw.FetchBlob(e);return await this.GetRenderer().CreateStaticTextureAsync(t,{mipMapQuality:"high"})}HideCordovaSplashScreen(){this._runtime.PostComponentMessageToDOM("runtime","hide-cordova-splash")}StartLoadingScreen(){this._loaderStartTime=Date.now(),this._runtime.Dispatcher().addEventListener("loadingprogress",this._loadingprogress_handler),this._rafId=requestAnimationFrame(()=>this._DrawLoadingScreen()),3!==this._runtime.GetLoaderStyle()&&this.HideCordovaSplashScreen()}async EndLoadingScreen(){const e=this.GetRenderer();this._loadingProgress=1;const t=this._runtime.GetLoaderStyle();4===t&&await this._splashDonePromise,this._splashDoneResolve=null,this._splashDonePromise=null,-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1),this._runtime.Dispatcher().removeEventListener("loadingprogress",this._loadingprogress_handler),this._loadingprogress_handler=null,this._percentText&&(this._percentText.Release(),this._percentText=null),this._runtime.ReleaseLoadingLogoAsset(),e.Start(),this._splashTextures.logo&&(e.DeleteTexture(this._splashTextures.logo),this._splashTextures.logo=null),this._splashTextures.powered&&(e.DeleteTexture(this._splashTextures.powered),this._splashTextures.powered=null),this._splashTextures.website&&(e.DeleteTexture(this._splashTextures.website),this._splashTextures.website=null),e.ClearRgba(0,0,0,0),e.Finish(),this._splashState="done",this._gpuTimeStartFrame=e.GetFrameNumber(),3===t&&this.HideCordovaSplashScreen()}_DrawLoadingScreen(){if(-1===this._rafId)return;const e=this.GetRenderer();e.Start(),this._rafId=-1;const t=this._runtime.GetAssetManager().HasHadErrorLoading(),s=this._runtime.GetLoaderStyle();if(3!==s&&(this.SetCssTransform(e),e.ClearRgba(0,0,0,0),e.ResetColor(),e.SetTextureFillMode(),e.SetTexture(null)),0===s)this._DrawProgressBarAndLogoLoadingScreen(t);else if(1===s)this._DrawProgressBarLoadingScreen(t,120,0);else if(2===s)this._DrawPercentTextLoadingScreen(t);else if(3===s)Qw.noop();else{if(4!==s)throw new Error("invalid loader style");this._DrawSplashLoadingScreen(t)}e.Finish(),this._rafId=requestAnimationFrame(()=>this._DrawLoadingScreen())}_DrawPercentTextLoadingScreen(e){e?this._percentText.SetColorRgb(1,0,0):this._percentText.SetColorRgb(.6,.6,.6),this._percentText.SetText(Math.round(100*this._loadingProgress)+"%");const t=this._canvasCssWidth/2,s=this._canvasCssHeight/2;cP.setRect(t-150,s-100,t+150,s+100);const i=this.GetRenderer();i.SetTexture(this._percentText.GetTexture()),i.Quad3(cP,this._percentText.GetTexRect())}_DrawProgressBarLoadingScreen(e,t,s){const i=this.GetRenderer();i.SetColorFillMode(),e?i.SetColorRgba(1,0,0,1):i.SetColorRgba(.118,.565,1,1);const r=this._canvasCssWidth/2,n=this._canvasCssHeight/2,a=t/2;uP.setWH(r-a,n-4+s,Math.floor(t*this._loadingProgress),8),i.Rect(uP),uP.setWH(r-a,n-4+s,t,8),uP.offset(-.5,-.5),uP.inflate(.5,.5),i.SetColorRgba(0,0,0,1),i.LineRect2(uP),uP.inflate(1,1),i.SetColorRgba(1,1,1,1),i.LineRect2(uP)}_DrawProgressBarAndLogoLoadingScreen(e){const t=this.GetRenderer(),s=this._runtime.GetLoadingLogoAsset();if(!s)return void this._DrawProgressBarLoadingScreen(e,120,0);const i=s.GetTexture();if(!i)return void this._DrawProgressBarLoadingScreen(e,120,0);const r=i.GetWidth(),n=i.GetHeight(),a=this._canvasCssWidth/2,o=this._canvasCssHeight/2,h=r/2,l=n/2;cP.setRect(a-h,o-l,a+h,o+l),t.SetTexture(i),t.Quad(cP),this._DrawProgressBarLoadingScreen(e,r,l+16)}_DrawSplashLoadingScreen(e){const t=this.GetRenderer(),s=this._splashTextures.logo,i=this._splashTextures.powered,r=this._splashTextures.website,n=Date.now();0===this._splashFrameNumber&&(this._loaderStartTime=n);const a=this._runtime.IsPreview()||this._runtime.IsFBInstantAvailable()&&!this._runtime.IsCordova(),o=a?0:200,h=a?0:3e3;let l=1;"fade-in"===this._splashState?l=Math.min((n-this._loaderStartTime)/300,1):"fade-out"===this._splashState&&(l=Math.max(1-(n-this._splashFadeOutStartTime)/300,0)),t.SetColorFillMode(),t.SetColorRgba(.231*l,.251*l,.271*l,l),uP.set(0,0,this._canvasCssWidth,this._canvasCssHeight),t.Rect(uP);const c=Math.ceil(this._canvasCssWidth),u=Math.ceil(this._canvasCssHeight);let d,_;this._canvasCssHeight>256?(t.SetColorRgba(.302*l,.334*l,.365*l,l),d=c,_=Math.max(.005*u,2),uP.setWH(0,.8*u-_/2,d,_),t.Rect(uP),e?t.SetColorRgba(l,0,0,l):t.SetColorRgba(.161*l,.953*l,.816*l,l),d=c*this._loadingProgress,uP.setWH(.5*c-d/2,.8*u-_/2,d,_),t.Rect(uP),t.SetColorRgba(l,l,l,l),t.SetTextureFillMode(),i&&(d=1.5*Qw.clamp(.22*u,105,.6*c),_=d/8,uP.setWH(.5*c-d/2,.2*u-_/2,d,_),t.SetTexture(i),t.Rect(uP)),s&&(d=Math.min(.395*u,.95*c),_=d,uP.setWH(.5*c-d/2,.485*u-_/2,d,_),t.SetTexture(s),t.Rect(uP)),r&&(d=1.5*Qw.clamp(.22*u,105,.6*c),_=d/8,uP.setWH(.5*c-d/2,.868*u-_/2,d,_),t.SetTexture(r),t.Rect(uP))):(t.SetColorRgba(.302*l,.334*l,.365*l,l),d=c,_=Math.max(.005*u,2),uP.setWH(0,.85*u-_/2,d,_),t.Rect(uP),e?t.SetColorRgba(l,0,0,l):t.SetColorRgba(.161*l,.953*l,.816*l,l),d=c*this._loadingProgress,uP.setWH(.5*c-d/2,.85*u-_/2,d,_),t.Rect(uP),t.SetColorRgba(l,l,l,l),t.SetTextureFillMode(),s&&(d=.55*u,_=d,uP.setWH(.5*c-d/2,.45*u-_/2,d,_),t.SetTexture(s),t.Rect(uP))),this._splashFrameNumber++,"fade-in"===this._splashState&&n-this._loaderStartTime>=300&&this._splashFrameNumber>=2&&(this._splashState="wait",this._splashFadeInFinishTime=n),"wait"===this._splashState&&n-this._splashFadeInFinishTime>=h&&this._loadingProgress>=1&&(this._splashState="fade-out",this._splashFadeOutStartTime=n),("fade-out"===this._splashState&&n-this._splashFadeOutStartTime>=300+o||a&&this._loadingProgress>=1&&n-this._loaderStartTime<500)&&this._splashDoneResolve()}}}{let mP=function(e){return new SP.Runtime(e)},gP=function(e,t){return e.Init(t)};CreateRuntime=mP,InitRuntime=gP;const SP=self.C3,GP=self.C3Debugger,yP=self.assert,IP=self.ISDKBehaviorInstanceBase,TP={messagePort:null,runtimeBaseUrl:"",headless:!1,hasDom:!0,isInWorker:!1,useAudio:!0,exportType:""};let CP=!0;SP.Runtime=class extends SP.DefendedBase{#e=new WeakMap;#s={pretick:SP.New(SP.Event,"pretick",!1),tick:SP.New(SP.Event,"tick",!1),tick2:SP.New(SP.Event,"tick2",!1),instancecreate:SP.New(SP.Event,"instancecreate",!1),instancedestroy:SP.New(SP.Event,"instancedestroy",!1),beforelayoutchange:SP.New(SP.Event,"beforelayoutchange",!1),layoutchange:SP.New(SP.Event,"layoutchange",!1),beforerender:SP.New(SP.Event,"beforerender",!1),beforerender2:SP.New(SP.Event,"beforerender2",!1),afterrender:SP.New(SP.Event,"afterrender",!1)};#t;#n;#i;#h;#r;#o;#a;#l;#u;#g;#S;#d;#v=new WeakMap;#_=[];constructor(e){e=Object.assign({},TP,e),super(),this._messagePort=e.messagePort,this._runtimeBaseUrl=e.runtimeBaseUrl,this._previewUrl=e.previewUrl,this._isHeadless=!!e.headless,this._hasDom=!!e.hasDom,this._isInWorker=!!e.isInWorker,CP=e.ife,this._useAudio=!!e.useAudio,this._exportType=e.exportType,this._isiOSCordova=!!e.isiOSCordova,this._isiOSWebView=!!e.isiOSWebView,this._isWindowsWebView2=!!e.isWindowsWebView2,this._isAnyWebView2Wrapper=!!e.isAnyWebView2Wrapper,this._isFBInstantAvailable=!!e.isFBInstantAvailable,this._isDebug=!("preview"!==this._exportType||!e.isDebug),this._breakpointsEnabled=this._isDebug,this._isDebugging=this._isDebug,this._debuggingDisabled=0,this._additionalLoadPromises=[],this._additionalCreatePromises=[],this._isUsingCreatePromises=!1,this._projectName="",this._projectVersion="",this._projectUniqueId="",this._appId="",this._exportTimestamp=0,this._originalViewportWidth=0,this._originalViewportHeight=0,this._devicePixelRatio=self.devicePixelRatio,this._parallaxXorigin=0,this._parallaxYorigin=0,this._viewportWidth=0,this._viewportHeight=0,this._loaderStyle=0,this._usesLoaderLayout=!1,this._isLoading=!0,this._usesAnyBackgroundBlending=!1,this._usesAnyCrossSampling=!1,this._usesAnyDepthSampling=!1,this._loadingLogoAsset=null,this.#n=SP.New(SP.AssetManager,this,e),this.#i=SP.New(SP.LayoutManager,this),this.#h=SP.New(SP.EventSheetManager,this),this.#r=SP.New(SP.AddonManager,this,e.wrapperComponentIds),this.#o=SP.New(SP.CollisionEngine,this),this.#a=SP.New(SP.TimelineManager,this),this.#l=SP.New(SP.TransitionManager,this),this.#u=SP.New(SP.TemplateManager,this),this.#g=SP.New(SP.FlowchartManager,this),SP.Model3dManager&&(this.#S=SP.New(SP.Model3dManager,this)),this._textIconManager=SP.New(SP.TextIconManager,{getIconSetMeta:e=>this._GetTextIconSetMeta(e),getIconSetContent:e=>this._GetTextIconSetContent(e)}),this._iconChangeHandlers=new Map,this._allObjectClasses=[],this._objectClassesByName=new Map,this._objectClassesBySid=new Map,this._familyCount=0,this._allContainers=[],this._allEffectLists=new Set,this._currentLayoutStack=[],this._instancesPendingCreate=[],this._instancesPendingDestroy=new Map,this._hasPendingInstances=!1,this._isFlushingPendingInstances=!1,this._objectCount=0,this._nextUid=0,this._instancesByUid=new Map,this._instancesPendingRelease=new Set,this._instancesPendingReleaseAffectedObjectClasses=new Set,this._objectReferenceTable=[],this._jsPropNameTable=[],this._uses3dFeatures=!1,this._framerateMode="vsync",this._sampling="trilinear",this._isPixelRoundingEnabled=!1,this._needRender=!0,this._pauseOnBlur=!1,this._isPausedOnBlur=!1,this._exportToVideo=null,this._tickCallbacks={normal:e=>{this._rafId=-1,this._ruafId=-1,this.Tick(e)},tickOnly:e=>{this._ruafId=-1,this.Tick(e,!1,"skip-render")},renderOnly:()=>{this._rafId=-1,this.Render()}},this._rafId=-1,this._ruafId=-1,this._tickCount=0,this._tickCountNoSave=0,this._hasStarted=!1,this._isInTick=!1,this._hasStartedTicking=!1,this._isLayoutFirstTick=!0,this._isAutoSuspendEnabled=!0,this._isPageVisibilitySuspended=!1,this._suspendCount=0,this._scheduleTriggersThrottle=new SP.PromiseThrottle(1),this._randomNumberCallback=()=>Math.random(),this._startTime=0,this._lastTickTime=0,this._dtRaw=0,this._dt1=0,this._dt=0,this._timeScale=1,this._maxDt=1/30,this._minDt=0,this._gameTime=SP.New(SP.KahanSum),this._gameTimeRaw=SP.New(SP.KahanSum),this._wallTime=SP.New(SP.KahanSum),this._instanceTimes=new Map,this._fpsFrameCount=-1,this._fpsLastTime=0,this._fps=0,this._tpsTickCount=-1,this._tps=0,this._mainThreadTimeCounter=0,this._mainThreadTime=0,this._isLoadingState=!1,this._saveToSlotName="",this._saveToJsonString=!1,this._loadFromSlotName="",this._loadFromJson=null,this._lastSaveJson="",this._projectStorage=null,this._savegamesStorage=null,this._dispatcher=SP.New(SP.Event.Dispatcher),this._domEventHandlers=new Map,this._pendingResponsePromises=new Map,this._nextDomResponseId=0,this._didRequestDeviceOrientationEvent=!1,this._didRequestDeviceMotionEvent=!1,this._isReadyToHandleEvents=!1,this._waitingToHandleEvents=[],this.#s.instancecreate.instance=null,this.#s.instancedestroy.instance=null,this._userScriptDispatcher=SP.New(SP.Event.Dispatcher),this._userScriptEventObjects=null;const t=(e,t)=>SP.BehaviorInstance.SortByTickSequence(this,e,t);this._behInstsToTick=SP.New(SP.RedBlackSet,t),this._behInstsToPostTick=SP.New(SP.RedBlackSet,t),this._behInstsToTick2=SP.New(SP.RedBlackSet,t),this.#d=SP.New(SP.JobSchedulerRuntime,this,e.jobScheduler),e.canvas&&(this.#t=SP.New(SP.CanvasManager,this)),this._messagePort.onmessage=e=>this._OnMessageFromDOM(e.data),this.AddDOMComponentMessageHandler("runtime","visibilitychange",e=>this._OnVisibilityChange(e)),this.AddDOMComponentMessageHandler("runtime","wrapper-extension-message",e=>this._OnWrapperExtensionMessage(e)),this.AddDOMComponentMessageHandler("runtime","get-remote-preview-status-info",()=>this._GetRemotePreviewStatusInfo()),this.AddDOMComponentMessageHandler("runtime","js-invoke-function",e=>this._InvokeFunctionFromJS(e)),this.AddDOMComponentMessageHandler("runtime","go-to-last-error-script",self.goToLastErrorScript),this.AddDOMComponentMessageHandler("runtime","offline-audio-render-completed",e=>this._OnOfflineAudioRenderCompleted(e)),this._dispatcher.addEventListener("window-blur",e=>this._OnWindowBlur(e)),this._dispatcher.addEventListener("window-focus",()=>this._OnWindowFocus()),this.#a.AddRuntimeListeners(),this.#u.AddRuntimeListeners(),this._iRuntime=null,this._constructVersionCode=0,this._commonScriptInterfaces={keyboard:null,mouse:null,touch:null,timelineController:null}}Release(){SP.clearArray(this._allObjectClasses),this._objectClassesByName.clear(),this._objectClassesBySid.clear(),this.#i.Release(),this.#i=null,this.#h.Release(),this.#h=null,this.#r.Release(),this.#r=null,this.#n.Release(),this.#n=null,this.#o.Release(),this.#o=null,this.#a.Release(),this.#a=null,this.#l.Release(),this.#l=null,this.#u.Release(),this.#u=null,this.#g.Release(),this.#g=null,this._textIconManager.Release(),this._textIconManager=null,this.#S&&(this.#S.Release(),this.#S=null),this.#t&&(this.#t.Release(),this.#t=null),this._dispatcher.Release(),this._dispatcher=null,this._tickEvent=null}_OnMessageFromDOM(e){const t=e.type;if("event"===t)this._OnEventFromDOM(e);else{if("result"!==t)throw new Error(`unknown message '${t}'`);this._OnResultFromDOM(e)}}_OnEventFromDOM(e){if(!this._isReadyToHandleEvents)return void this._waitingToHandleEvents.push(e);const t=e.component,s=e.handler,i=e.data,r=e.dispatchOpts,n=!(!r||!r.dispatchRuntimeEvent),a=!(!r||!r.dispatchUserScriptEvent),o=e.responseId;if("runtime"===t){if(n){const e=new SP.Event(s);e.data=i,this._dispatcher.dispatchEventAndWaitAsyncSequential(e)}if(a){const e=new SP.Event(s,!0);if(i)for(const[t,s]of Object.entries(i))e[t]=s;this.DispatchUserScriptEvent(e)}}const h=this._domEventHandlers.get(t);if(!h)return void(n||a||console.warn(`[Runtime] No DOM event handlers for component '${t}'`));const l=h.get(s);if(!l)return void(n||a||console.warn(`[Runtime] No DOM handler '${s}' for component '${t}'`));let c=null;try{c=l(i)}catch(e){return console.error(`Exception in '${t}' handler '${s}':`,e),void(null!==o&&this._PostResultToDOM(o,!1,""+e))}null!==o&&(c&&c.then?c.then(e=>this._PostResultToDOM(o,!0,e)).catch(e=>{console.error(`Rejection from '${t}' handler '${s}':`,e),this._PostResultToDOM(o,!1,""+e)}):this._PostResultToDOM(o,!0,c))}_PostResultToDOM(e,t,s){this._messagePort.postMessage({type:"result",responseId:e,isOk:t,result:s})}_OnResultFromDOM(e){const t=e.responseId,s=e.isOk,i=e.result,r=this._pendingResponsePromises.get(t);s?r.resolve(i):r.reject(i),this._pendingResponsePromises.delete(t)}AddDOMComponentMessageHandler(e,t,s){let i=this._domEventHandlers.get(e);if(i||(i=new Map,this._domEventHandlers.set(e,i)),i.has(t))throw new Error(`[Runtime] Component '${e}' already has handler '${t}'`);i.set(t,s)}PostComponentMessageToDOM(e,t,s,i){this._messagePort.postMessage({type:"event",component:e,handler:t,data:s,responseId:null},i)}PostComponentMessageToDOMAsync(e,t,s,i){const r=this._nextDomResponseId++,n=new Promise((e,t)=>{this._pendingResponsePromises.set(r,{resolve:e,reject:t})});return this._messagePort.postMessage({type:"event",component:e,handler:t,data:s,responseId:r},i),n}SendWrapperExtensionMessage(e,t,s,i=-1){this.PostComponentMessageToDOM("runtime","send-wrapper-extension-message",{componentId:e,messageId:t,params:s,asyncId:i})}SendRawWrapperExtensionMessage(e){this.PostComponentMessageToDOM("runtime","send-raw-wrapper-extension-message",e)}SendWrapperExtensionMessageAsync(e,t,s){const i=this._nextDomResponseId++,r=new Promise((e,t)=>{this._pendingResponsePromises.set(i,{resolve:e,reject:t})});return this.SendWrapperExtensionMessage(e,t,s,i),r}_OnWrapperExtensionMessage(e){if(-1!==e.asyncId){const t=e.asyncId;this._pendingResponsePromises.get(t).resolve(e.params),this._pendingResponsePromises.delete(t)}else this._OnEventFromDOM({component:"wrapper-extension:"+e.componentId,handler:e.messageId,data:e.params,responseId:null})}AddWrapperExtensionMessageHandler(e,t,s){this.AddDOMComponentMessageHandler("wrapper-extension:"+e,t,s)}HasWrapperComponentId(e){return this.#r.HasWrapperComponentId(e)}PostToDebugger(e){if(!this.IsDebug())throw new Error("not in debug mode");this.PostComponentMessageToDOM("runtime","post-to-debugger",e)}async Init(e){SP.CommonACES_SetRuntime(this),this.IsDebug()?await GP.Init(this):self.C3Debugger&&self.C3Debugger.InitPreview(this);const t=await this.#n.FetchJson("data.json");if(await this._LoadDataJson(t),await this._InitialiseCanvas(e),this.IsPreview()||console.info("%cMade with Construct, the game and animation creation tool. Visit: https://www.construct.net","font-weight: bold"),this.GetWebGLRenderer()){const e=this.GetWebGLRenderer();console.info(`[C3 runtime] Hosted in ${this.IsInWorker()?"worker":"DOM"}, rendering with WebGL ${e.GetWebGLVersionNumber()} [${e.GetUnmaskedRenderer()}]`)}else this.GetWebGPURenderer()&&console.info(`[C3 runtime] Hosted in ${this.IsInWorker()?"worker":"DOM"}, rendering with WebGPU [${this.GetWebGPURenderer().GetAdapterInfoString()}]`);this.GetRenderer().HasMajorPerformanceCaveat()&&console.warn("[C3 runtime] The renderer indicates a major performance caveat. Software rendering may be in use. This can result in significantly degraded performance."),this._isReadyToHandleEvents=!0;for(const e of this._waitingToHandleEvents)this._OnEventFromDOM(e);SP.clearArray(this._waitingToHandleEvents),this.#t&&this.#t.StartLoadingScreen();for(const t of e.runOnStartupFunctions)this._additionalLoadPromises.push(this._RunOnStartupFunction(t));if(await Promise.all([this.#n.WaitForAllToLoad(!1),...this._additionalLoadPromises]),SP.clearArray(this._additionalLoadPromises),!this.#n.HasHadErrorLoading())return this.#t&&await this.#t.EndLoadingScreen(),await this._dispatcher.dispatchEventAndWaitAsync(new SP.Event("beforeruntimestart")),await this.Start(),this._messagePort.postMessage({type:"runtime-ready"}),this;this.#t&&this.#t.HideCordovaSplashScreen()}async _RunOnStartupFunction(e){try{await e(this._iRuntime)}catch(e){console.error("[C3 runtime] Error in runOnStartup function: ",e)}}async _LoadDataJson(e){const t=e.project;this._projectName=t[0],this._projectVersion=t[16],this._projectUniqueId=t[31],this._appId=t[38],this._exportTimestamp=t[36];const s=t[39]||"loading-logo.png";this._isPixelRoundingEnabled=!!t[9],this._originalViewportWidth=this._viewportWidth=t[10],this._originalViewportHeight=this._viewportHeight=t[11],this.#o._InitCollisionCellSize(this._originalViewportWidth,this._originalViewportHeight),this._parallaxXorigin=this._originalViewportWidth/2,this._parallaxYorigin=this._originalViewportHeight/2,this._framerateMode=t[37],this._uses3dFeatures=!!t[40],this._sampling=t[14],this._usesAnyBackgroundBlending=t[15],this._usesAnyCrossSampling=t[42],this._usesAnyDepthSampling=t[17],this._usesLoaderLayout=!!t[18],this._loaderStyle=t[19],this._nextUid=t[21],this._pauseOnBlur=t[22],this._constructVersionCode=t[51];const i=this.#n;i._SetAudioFiles(t[7],t[25]),i._SetMediaSubfolder(t[8]),i._SetFontsSubfolder(t[32]),i._SetIconsSubfolder(t[28]),i._SetWebFonts(t[29]),i._SetExportedFileList(t[45]),0===this._loaderStyle&&s&&(this._loadingLogoAsset=i.LoadImage({url:s})),this.#t&&(this.#t.SetFullscreenMode(SP.CanvasManager._FullscreenModeNumberToString(t[12])),this.#t.SetFullscreenScalingQuality(t[23]?"high":"low"),this.#t.SetMipmapsEnabled(0!==t[24]),this.#t._SetGPUPowerPreference(t[34]),this.#t._SetTextureAnisotropy(t[41]),this.#t._SetWebGPUEnabled(t[13]),this.#t._SetZAxisScale(t[30]),this.#t._SetZDistances(t[46],t[47]),this.#t._SetInitFieldOfView(t[26]),this.#t._SetLimitedToWebGL1(t[48]),this.#t._SetMultitexturingMode(t[50]));const r=t[43];r&&await this._LoadExportToVideoData(r),this._InitScriptInterfaces(),this.#r.CreateSystemPlugin(),this._objectReferenceTable=self.C3_GetObjectRefTable();const n=t[2];for(const e of n[1])this.#r.CreateBehavior(e);for(const e of n[0])this.#r.CreatePlugin(e);this._objectReferenceTable=self.C3_GetObjectRefTable(),this._LoadJsPropNameTable(),this.#r._InitAddonScriptInterfaces();for(const e of t[3]){const t=SP.ObjectClass.Create(this,this._allObjectClasses.length,e);this._allObjectClasses.push(t),this._objectClassesByName.set(t.GetName().toLowerCase(),t),this._objectClassesBySid.set(t.GetSID(),t)}for(const e of t[4])this._allObjectClasses[e[0]]._LoadFamily(e);for(const e of t[27]){const t=e.map(e=>this._allObjectClasses[e]);this._allContainers.push(SP.New(SP.Container,this,t))}this._InitObjectsScriptInterface();for(const e of this._allObjectClasses)e._OnAfterCreate();for(const e of t[5])this.#i.Create(e);const a=t[1];if(a){const e=this.#i.GetLayoutByName(a);e&&this.#i.SetFirstLayout(e)}for(const e of t[35])this.#l.Create(e);for(const e of t[33])this.#a.Create(e);for(const e of t[44])this.#u.Create(e);this.#u.HasTemplates()||(this.#u.Release(),this.#u=null);for(const e of t[49])this.#g.Create(e);if(this.#g.HasFlowcharts()||(this.#g.Release(),this.#g=null),this.#S){for(const e of t[52])this.#S.Create(e);this.#S.HasModels3d()||(this.#S.Release(),this.#S=null)}for(const e of t[6])this.#h.Create(e);this.#h._PostInit(),this._InitGlobalVariableScriptInterface(),SP.clearArray(this._objectReferenceTable),this.FlushPendingInstances();let o="any";const h=t[20];1===h?o="portrait":2===h&&(o="landscape"),this.PostComponentMessageToDOM("runtime","set-target-orientation",{targetOrientation:o})}async _LoadExportToVideoData(e){const t=e.format;"image-sequence"===t?this._exportToVideo=new self.C3ExportToImageSequence(this,e):"image-sequence-gif"===t?this._exportToVideo=new self.C3ExportToGIF(this,e):"webm"===t?this._exportToVideo=new self.C3ExportToWebMVideo(this,e):"mp4"===t&&(this._exportToVideo=new self.C3ExportToMP4Video(this,e)),this._framerateMode="unlimited-frame",this.#t.SetFullscreenMode("off"),this._devicePixelRatio=1,self.devicePixelRatio=1,await this.PostComponentMessageToDOMAsync("runtime","set-exporting-to-video",{message:this._exportToVideo.GetExportingMessageForPercent(0),duration:this._exportToVideo.GetDuration()})}GetLoaderStyle(){return this._loaderStyle}IsExportToVideo(){return null!==this._exportToVideo}GetExportVideoDuration(){return this._exportToVideo.GetDuration()}GetExportVideoFramerate(){return this._exportToVideo.GetFramerate()}_InitExportToVideo(){return this._exportToVideo.Init({width:this.#t.GetDeviceWidth(),height:this.#t.GetDeviceHeight()})}_ExportToVideoAddFrame(){const e=this._tickCount/this.GetExportVideoFramerate();return this._exportToVideo.AddFrame(this.#t.GetMainCanvas(),e)}_ExportToVideoAddKeyframe(){this._exportToVideo&&this._exportToVideo.AddKeyframe()}_OnOfflineAudioRenderCompleted(e){this._exportToVideo.OnOfflineAudioRenderCompleted(e)}_ExportToVideoFinish(){return this._exportToVideo.Finish()}IsFBInstantAvailable(){return this._isFBInstantAvailable}IsLoading(){return this._isLoading}AddLoadPromise(e){this._additionalLoadPromises.push(e)}SetUsingCreatePromises(e){this._isUsingCreatePromises=!!e}AddCreatePromise(e){this._isUsingCreatePromises&&this._additionalCreatePromises.push(e)}GetCreatePromises(){return this._additionalCreatePromises}_GetNextFamilyIndex(){return this._familyCount++}GetFamilyCount(){return this._familyCount}_AddEffectList(e){this._allEffectLists.add(e)}_RemoveEffectList(e){this._allEffectLists.delete(e)}_GetAllEffectLists(){return this._allEffectLists}async _InitialiseCanvas(e){this.#t&&(await this.#t.CreateCanvas(e),this.#t.InitLoadingScreen(this._loaderStyle))}async Start(){this._hasStarted=!0,this._startTime=Date.now();let e=null;const t=new Promise(t=>e=t);if(this._usesLoaderLayout){for(const e of this._allObjectClasses)e.IsFamily()||e.IsOnLoaderLayout()||!e.IsWorldType()||e.OnCreate();(async()=>{await this.#n.WaitForAllToLoad(!0),await t,this._isLoading=!1,this._OnLoadFinished()})()}else this._isLoading=!1;this.#n.SetInitialLoadFinished(),this.IsDebug()&&GP.RuntimeInit(CP);for(const e of this.#i.GetAllLayouts())e._CreateGlobalNonWorlds();this.IsExportToVideo()&&await this._InitExportToVideo();const s=this.#i.GetFirstLayout();await s._Load(null,this.GetRenderer()),await s._StartRunning(!0),this._fpsLastTime=performance.now(),e(),this._usesLoaderLayout||this._OnLoadFinished(),(await this.PostComponentMessageToDOMAsync("runtime","before-start-ticking")).isSuspended&&!this.IsExportToVideo()?(this._suspendCount++,this._isPageVisibilitySuspended=!0):this.Tick()}_OnLoadFinished(){this.Trigger(SP.Plugins.System.Cnds.OnLoadFinished,null,null),this.PostComponentMessageToDOM("runtime","register-sw")}GetObjectReference(e){e=Math.floor(e);const t=this._objectReferenceTable;if(e<0||e>=t.length)throw new Error("invalid object reference");return t[e]}_LoadJsPropNameTable(){for(const e of self.C3_JsPropNameTable){const t=SP.first(Object.keys(e));this._jsPropNameTable.push(t)}}GetJsPropName(e){e=Math.floor(e);const t=this._jsPropNameTable;if(e<0||e>=t.length)throw new Error("invalid prop reference");return t[e]}HasDOM(){return this._hasDom}IsHeadless(){return this._isHeadless}IsInWorker(){return this._isInWorker}GetRuntimeBaseURL(){return this._runtimeBaseUrl}GetPreviewURL(){return this._previewUrl}GetEventSheetManager(){return this.#h}GetEventStack(){return this.#h.GetEventStack()}GetCurrentEventStackFrame(){return this.#h.GetCurrentEventStackFrame()}GetCurrentEvent(){return this.#h.GetCurrentEvent()}GetCurrentCondition(){return this.#h.GetCurrentCondition()}IsCurrentConditionFirst(){return 0===this.GetCurrentEventStackFrame().GetConditionIndex()}GetCurrentAction(){return this.#h.GetCurrentAction()}GetAddonManager(){return this.#r}GetSystemPlugin(){return this.#r.GetSystemPlugin()}GetObjectClassByIndex(e){if((e=Math.floor(e))<0||e>=this._allObjectClasses.length)throw new RangeError("invalid index");return this._allObjectClasses[e]}GetObjectClassByName(e){return this._objectClassesByName.get(e.toLowerCase())||null}GetObjectClassBySID(e){return this._objectClassesBySid.get(e)||null}GetSingleGlobalObjectClassByCtor(e){const t=SP.AddonManager.GetPluginByConstructorFunction(e);return t?t.GetSingleGlobalObjectClass():null}GetAllObjectClasses(){return this._allObjectClasses}*allInstances(){for(const e of this._allObjectClasses)e.IsFamily()||(yield*e.instances())}Dispatcher(){return this._dispatcher}UserScriptDispatcher(){return this._userScriptDispatcher}DispatchUserScriptEvent(e){e.runtime=this.GetIRuntime();const t=this.IsDebug()&&!this.#h.IsInEventEngine();t&&GP.StartMeasuringScriptTime(),this._userScriptDispatcher.dispatchEvent(e),t&&GP.AddScriptTime()}DispatchUserScriptEventAsyncWait(e){return e.runtime=this.GetIRuntime(),this._userScriptDispatcher.dispatchEventAndWaitAsync(e)}GetOriginalViewportWidth(){return this._originalViewportWidth}GetOriginalViewportHeight(){return this._originalViewportHeight}SetOriginalViewportSize(e,t){if(this._originalViewportWidth===e&&this._originalViewportHeight===t)return;this._originalViewportWidth=e,this._originalViewportHeight=t;const s=this.GetLayoutManager();s.SetAllLayerProjectionChanged(),s.SetAllLayerMVChanged()}GetViewportWidth(){return this._viewportWidth}GetViewportHeight(){return this._viewportHeight}SetViewportSize(e,t){if(this._viewportWidth===e&&this._viewportHeight===t)return;this._viewportWidth=e,this._viewportHeight=t;const s=this.GetLayoutManager();s.SetAllLayerProjectionChanged(),s.SetAllLayerMVChanged()}_SetDevicePixelRatio(e){this.IsExportToVideo()||(this._devicePixelRatio=e)}GetDevicePixelRatio(){return this._devicePixelRatio}GetParallaxXOrigin(){return this._parallaxXorigin}GetParallaxYOrigin(){return this._parallaxYorigin}GetCanvasManager(){return this.#t}GetDrawWidth(){return this.#t?this.#t.GetDrawWidth():this._viewportWidth}GetDrawHeight(){return this.#t?this.#t.GetDrawHeight():this._viewportHeight}GetRenderScale(){return this.#t?this.#t.GetRenderScale():1}GetDisplayScale(){return this.#t?this.#t.GetDisplayScale():1}GetEffectLayerScaleParam(){return this.#t?this.#t.GetEffectLayerScaleParam():1}GetEffectDevicePixelRatioParam(){return this.#t?this.#t.GetEffectDevicePixelRatioParam():1}GetCanvasClientX(){return this.#t?this.#t.GetCanvasClientX():0}GetCanvasClientY(){return this.#t?this.#t.GetCanvasClientY():0}GetCanvasCssWidth(){return this.#t?this.#t.GetCssWidth():0}GetCanvasCssHeight(){return this.#t?this.#t.GetCssHeight():0}GetFullscreenMode(){return this.#t?this.#t.GetFullscreenMode():"off"}GetAdditionalRenderTarget(e){return this.#t?this.#t.GetAdditionalRenderTarget(e):null}ReleaseAdditionalRenderTarget(e){this.#t&&this.#t.ReleaseAdditionalRenderTarget(e)}UsesAnyBackgroundBlending(){return this._usesAnyBackgroundBlending}UsesAnyCrossSampling(){return this._usesAnyCrossSampling}UsesAnyDepthSampling(){return this._usesAnyDepthSampling}GetGPUUtilisation(){return this.#t?this.#t.GetGPUUtilisation():NaN}IsLinearSampling(){return"nearest"!==this.GetSampling()}GetFramerateMode(){return this._framerateMode}_SetFramerateMode(e){this._framerateMode!==e&&(this._framerateMode=e,-1===this._rafId&&-1===this._ruafId||(this._CancelAnimationFrame(),this._RequestAnimationFrame()))}GetSampling(){return this._sampling}UsesLoaderLayout(){return this._usesLoaderLayout}GetLoadingLogoAsset(){return this._loadingLogoAsset}ReleaseLoadingLogoAsset(){this._loadingLogoAsset&&(this._loadingLogoAsset.ReleaseTexture(),this._loadingLogoAsset.Release(),this._loadingLogoAsset=null)}GetLayoutManager(){return this.#i}GetMainRunningLayout(){return this.#i.GetMainRunningLayout()}GetTimelineManager(){return this.#a}GetTemplateManager(){return this.#u}GetFlowchartManager(){return this.#g}GetModel3dManager(){return this.#S}GetAssetManager(){return this.#n}LoadImage(e){return this.#n.LoadImage(e)}CreateInstance(e,t,s,i,r,n){if(n&&this.#u){if(e instanceof SP.ObjectClass&&e.IsFamily()){const a=e.GetFamilyMembers(),o=Math.floor(this.Random()*a.length);return this.CreateInstance(a[o],t,s,i,r,n)}const a=this.#u.GetTemplateData(e,n);if(a){const e=this.CreateInstanceFromData(a,t,!1,s,i,!1,r,void 0,r);return this.#u.MapInstanceToTemplateName(e,n),e}}return this.CreateInstanceFromData(e,t,!1,s,i,!1,r,void 0,r)}CreateInstanceFromData(e,t,s,i,r,n,a,o,h){let l=null,c=null;if(e instanceof SP.ObjectClass){if(c=e,c.IsFamily()){const e=c.GetFamilyMembers();c=e[Math.floor(this.Random()*e.length)]}l=c.GetDefaultInstanceData()}else l=e,c=this.GetObjectClassByIndex(l[1]);const u=c.GetPlugin().IsWorldType();if(this._isLoading&&u&&!c.IsOnLoaderLayout())return null;const d=t;let _;u||(t=null),_=s&&!n&&l&&!this._instancesByUid.has(l[2])?l[2]:this._nextUid++;const p=l?l[0]:null,f=SP.New(SP.Instance,{runtime:this,objectType:c,layer:t,worldData:p,instVarData:l?l[3]:null,uid:_,tags:l?l[6]:null});this._instancesByUid.set(_,f);let m=null;if(u&&(m=f.GetWorldInfo(),void 0!==i&&void 0!==r&&(m.SetX(i),m.SetY(r)),c._SetAnyCollisionCellChanged(!0)),t&&(h||t._AddInstance(f,!0),t.GetLayout().MaybeLoadTexturesFor(c)),this._objectCount++,c.IsInContainer()&&!s&&!n){const e=new Set;for(const t of c.GetContainer().objectTypes()){if(t===c)continue;const s=this._MaybeGetChildInstanceForObjectTypeData(t,m,e);if(s){const e=this.CreateInstanceFromData(s,d,!1,m?m.GetX():i,m?m.GetY():r,!0,!1,void 0,h);f._AddSibling(e)}else{const e=this.CreateInstanceFromData(t,d,!1,m?m.GetX():i,m?m.GetY():r,!0,!1,void 0,h);f._AddSibling(e)}}for(const e of f.siblings()){e._AddSibling(f);for(const t of f.siblings())e!==t&&e._AddSibling(t)}}if(u&&!s&&a&&this._CreateChildInstancesFromData(f,p,m,t,i,r,h),c.IsInContainer()&&!s&&!n&&a)for(const e of f.siblings()){const s=e.GetWorldInfo();if(!s)continue;const i=e.GetPlugin(),r=e.GetObjectClass().GetDefaultInstanceData()[0];i.IsWorldType()?this._CreateChildInstancesFromData(e,r,s,t,s.GetX(),s.GetY(),h):this._CreateChildInstancesFromData(e,r,s,t,void 0,void 0,h)}if(!n&&a){void 0===i&&(i=p[0]),void 0===r&&(r=p[1]);const e=m.GetTopParent(),t=i-m.GetX()+e.GetX(),s=r-m.GetY()+e.GetY();e.SetXY(t,s)}c._SetIIDsStale();const g=l?SP.cloneArray(l[5]):null,S=l?l[4].map(e=>SP.cloneArray(e)):null,G=u&&p&&p[13];if(G&&f._SetHasTilemap(),f._CreateSdkInstance(g,S),G){const e=p[13];f.GetSdkInstance().LoadTilemapData(e[2],e[0],e[1])}this._instancesPendingCreate.push(f),this._hasPendingInstances=!0,this.IsDebug()&&GP.InstanceCreated(f);const y=this.#s.instancecreate;return y.instance=f,this._dispatcher.dispatchEvent(y),f}_GetInstanceData(e){const t=e[0],s=e[1],i=e[2],r=e[6];return r||this.#i.GetLayoutBySID(t).GetLayer(s).GetInitialInstanceData(i)}_MaybeGetChildInstanceForObjectTypeData(e,t,s){const i=t?.GetSceneGraphChildrenExportData()??[];for(const t of i){const i=this._GetInstanceData(t),r=!!t[4],n=this.GetObjectClassByIndex(i[1]);if(!s.has(i)&&e===n&&r)return s.add(i),i}}_CreateChildInstancesFromData(e,t,s,i,r,n,a){const o=s.GetSceneGraphZIndexExportData(),h=s.GetSceneGraphChildrenExportData();if(e.GetWorldInfo().SetSceneGraphZIndex(o),!h)return;void 0===r&&(r=t[0]),void 0===n&&(n=t[1]);const l=new Set,c=t[0],u=t[1];for(const t of h){const s=t[0],o=t[1],h=t[2],d=t[3],_=!!t[4],p=t[5],f=t[6];let m;m=f||this.#i.GetLayoutBySID(s).GetLayer(o).GetInitialInstanceData(h);const g=this.GetObjectClassByIndex(m[1]),S=e.HasSibling(g),G=l.has(g);if(S&&!G&&_){const t=e.GetSibling(g);t.GetWorldInfo().Init(m[0]);const s=r+m[0][0]-c,i=n+m[0][1]-u;t.GetWorldInfo().SetXY(s,i),t.GetWorldInfo().SetSceneGraphZIndex(p),e.AddChild(t,{transformX:!!(1&d),transformY:!!(d>>1&1),transformWidth:!!(d>>2&1),transformHeight:!!(d>>3&1),transformAngle:!!(d>>4&1),destroyWithParent:!!(d>>5&1),transformZElevation:!!(d>>6&1),transformOpacity:!!(d>>7&1),transformVisibility:!!(d>>8&1)}),l.add(g)}else{const t=r+m[0][0]-c,s=n+m[0][1]-u,o=this.CreateInstanceFromData(m,i,!1,t,s,!1,!0,e,a);o.GetWorldInfo().SetSceneGraphZIndex(p),e.AddChild(o,{transformX:!!(1&d),transformY:!!(d>>1&1),transformWidth:!!(d>>2&1),transformHeight:!!(d>>3&1),transformAngle:!!(d>>4&1),destroyWithParent:!!(d>>5&1),transformZElevation:!!(d>>6&1),transformOpacity:!!(d>>7&1),transformVisibility:!!(d>>8&1)})}}}DestroyInstance(e){if(this._instancesPendingRelease.has(e))return;const t=e.GetObjectClass();let s=this._instancesPendingDestroy.get(t);if(s){if(s.has(e))return;s.add(e)}else s=new Set,s.add(e),this._instancesPendingDestroy.set(t,s);if(this.IsDebug()&&GP.InstanceDestroyed(e),e._MarkDestroyed(),this._hasPendingInstances=!0,e.IsInContainer())for(const t of e.siblings())this.DestroyInstance(t);for(const t of e.children())t.GetDestroyWithParent()&&this.DestroyInstance(t);if(!this.#i.IsEndingLayout()&&!this._isLoadingState){const t=this.GetEventSheetManager();t.BlockFlushingInstances(!0),e._TriggerOnDestroyed(),t.BlockFlushingInstances(!1)}e._FireDestroyedScriptEvents(this.#i.IsEndingLayout())}FlushPendingInstances(){this._hasPendingInstances&&(this._isFlushingPendingInstances=!0,this._FlushInstancesPendingCreate(),this._FlushInstancesPendingDestroy(),this._isFlushingPendingInstances=!1,this._hasPendingInstances=!1,this.UpdateRender())}_FlushInstancesPendingCreate(){for(const e of this._instancesPendingCreate){const t=e.GetObjectClass();t._AddInstance(e);for(const s of t.GetFamilies())s._AddInstance(e),s._SetIIDsStale()}SP.clearArray(this._instancesPendingCreate)}_FlushInstancesPendingDestroy(){this._dispatcher.SetDelayRemoveEventsEnabled(!0);for(const[e,t]of this._instancesPendingDestroy.entries())this._FlushInstancesPendingDestroyForObjectClass(e,t),t.clear();this._instancesPendingDestroy.clear(),this._dispatcher.SetDelayRemoveEventsEnabled(!1)}_FlushInstancesPendingDestroyForObjectClass(e,t){for(const e of t){const t=this.#s.instancedestroy;t.instance=e,this._dispatcher.dispatchEvent(t),this._instancesByUid.delete(e.GetUID()),this._instanceTimes.delete(e);const s=e.GetWorldInfo();s&&(s._RemoveFromCollisionCells(),s._RemoveFromRenderCells(),s._MarkDestroyed()),this._instancesPendingRelease.add(e),this._objectCount--}SP.arrayRemoveAllInSet(e.GetInstances(),t),e._SetIIDsStale(),this._instancesPendingReleaseAffectedObjectClasses.add(e);for(const s of e.GetFamilies())SP.arrayRemoveAllInSet(s.GetInstances(),t),s._SetIIDsStale(),this._instancesPendingReleaseAffectedObjectClasses.add(s);if(e.GetPlugin().IsWorldType()){const e=new Set([...t].map(e=>e.GetWorldInfo().GetLayer()));for(const s of e)s._RemoveAllInstancesInSet(t)}}_GetInstancesPendingCreate(){return this._instancesPendingCreate}*instancesPendingCreateForObjectClass(e){for(const t of this._GetInstancesPendingCreate())e.IsFamily()?t.GetObjectClass().BelongsToFamily(e)&&(yield t):t.GetObjectClass()===e&&(yield t)}_GetNewUID(){return this._nextUid++}_MapInstanceByUID(e,t){this._instancesByUid.set(e,t)}_SetAutoSuspendEnabled(e){e=!!e,this._isAutoSuspendEnabled!==e&&(this._isAutoSuspendEnabled=!!e,this._isAutoSuspendEnabled&&this._isPageVisibilitySuspended&&(this.SetSuspended(!1),this._isPageVisibilitySuspended=!1))}_IsAutoSuspendEnabled(){return this._isAutoSuspendEnabled}_OnRendererContextLost(){this._dispatcher.dispatchEvent(SP.New(SP.Event,"renderercontextlost")),this.SetSuspended(!0);for(const e of this._allObjectClasses)!e.IsFamily()&&e.HasLoadedTextures()&&e.ReleaseTextures();const e=this.GetMainRunningLayout();e&&e._OnRendererContextLost(),SP.ImageInfo.OnRendererContextLost(),SP.ImageAsset.OnRendererContextLost()}async _OnRendererContextRestored(){await this.GetMainRunningLayout()._Load(null,this.GetRenderer()),this._dispatcher.dispatchEvent(SP.New(SP.Event,"renderercontextrestored")),this.SetSuspended(!1),this.UpdateRender()}_OnVisibilityChange(e){if(!this._isAutoSuspendEnabled)return;const t=e.hidden;this.SetSuspended(t),this._isPageVisibilitySuspended=t,t||this.UpdateRender()}_OnWindowBlur(e){this.IsPreview()&&this._pauseOnBlur&&!SP.Platform.IsMobile&&(e.data.parentHasFocus||(this.SetSuspended(!0),this._isPausedOnBlur=!0))}_OnWindowFocus(){this._isPausedOnBlur&&(this.SetSuspended(!1),this._isPausedOnBlur=!1)}_RequestAnimationFrame(){const e=this._tickCallbacks;"vsync"===this._framerateMode?-1===this._rafId&&(this._rafId=self.requestAnimationFrame(e.normal)):"unlimited-tick"===this._framerateMode?(-1===this._ruafId&&(this._ruafId=SP.RequestUnlimitedAnimationFrame(e.tickOnly)),-1===this._rafId&&(this._rafId=self.requestAnimationFrame(e.renderOnly))):-1===this._ruafId&&(this._ruafId=SP.RequestUnlimitedAnimationFrame(e.normal))}_CancelAnimationFrame(){-1!==this._rafId&&(self.cancelAnimationFrame(this._rafId),this._rafId=-1),-1!==this._ruafId&&(SP.CancelUnlimitedAnimationFrame(this._ruafId),this._ruafId=-1)}IsSuspended(){return this._suspendCount>0}SetSuspended(e){if(this.IsExportToVideo())return;const t=this.IsSuspended();this._suspendCount+=e?1:-1,this._suspendCount<0&&(this._suspendCount=0);const s=this.IsSuspended();if(!t&&s)console.log("[Construct] Suspending"),this._CancelAnimationFrame(),this._dispatcher.dispatchEvent(SP.New(SP.Event,"suspend")),this.DispatchUserScriptEvent(SP.New(SP.Event,"suspend")),this.Trigger(SP.Plugins.System.Cnds.OnSuspend,null,null);else if(t&&!s){console.log("[Construct] Resuming");const e=performance.now();this._lastTickTime=e,this._fpsLastTime=e,this._fpsFrameCount=0,this._fps=0,this._tpsTickCount=0,this._tps=0,this._mainThreadTime=0,this._mainThreadTimeCounter=0,this._dispatcher.dispatchEvent(SP.New(SP.Event,"resume")),this.DispatchUserScriptEvent(SP.New(SP.Event,"resume")),this.Trigger(SP.Plugins.System.Cnds.OnResume,null,null),this.HitBreakpoint()||this.Tick(e)}}_AddBehInstToTick(e){this._behInstsToTick.Add(e)}_AddBehInstToPostTick(e){this._behInstsToPostTick.Add(e)}_AddBehInstToTick2(e){this._behInstsToTick2.Add(e)}_RemoveBehInstToTick(e){this._behInstsToTick.Remove(e)}_RemoveBehInstToPostTick(e){this._behInstsToPostTick.Remove(e)}_RemoveBehInstToTick2(e){this._behInstsToTick2.Remove(e)}_CallBehaviorTickMethod(e,t){const s=t?performance.now():0;let i;return e instanceof IP?(i=e._tick(),t&&GP.AddIndividualBehaviorTickTime(e.behavior,performance.now()-s)):(i=e.Tick(),t&&GP.AddIndividualBehaviorTickTime(e.GetBehavior(),performance.now()-s)),i}_BehaviorTick(){const e=this.IsDebug();this._behInstsToTick.SetQueueingEnabled(!0);for(const t of this._behInstsToTick)this._CallBehaviorTickMethod(t,e);this._behInstsToTick.SetQueueingEnabled(!1)}_CallBehaviorPostTickMethod(e,t){const s=t?performance.now():0;let i;return e instanceof IP?(i=e._postTick(),t&&GP.AddIndividualBehaviorTickTime(e.behavior,performance.now()-s)):(i=e.PostTick(),t&&GP.AddIndividualBehaviorTickTime(e.GetBehavior(),performance.now()-s)),i}_BehaviorPostTick(){const e=this.IsDebug();this._behInstsToPostTick.SetQueueingEnabled(!0);for(const t of this._behInstsToPostTick)this._CallBehaviorPostTickMethod(t,e);this._behInstsToPostTick.SetQueueingEnabled(!1)}_CallBehaviorTick2Method(e,t){const s=t?performance.now():0;let i;return e instanceof IP?(i=e._tick2(),t&&GP.AddIndividualBehaviorTickTime(e.behavior,performance.now()-s)):(i=e.Tick2(),t&&GP.AddIndividualBehaviorTickTime(e.GetBehavior(),performance.now()-s)),i}_BehaviorTick2(){const e=this.IsDebug();this._behInstsToTick2.SetQueueingEnabled(!0);for(const t of this._behInstsToTick2)this._CallBehaviorTick2Method(t,e);this._behInstsToTick2.SetQueueingEnabled(!1)}*_DebugBehaviorTick(){const e=this.IsDebug();this._behInstsToTick.SetQueueingEnabled(!0);for(const t of this._behInstsToTick){const s=this._CallBehaviorTickMethod(t,e);SP.IsIterator(s)&&(yield*s)}this._behInstsToTick.SetQueueingEnabled(!1)}*_DebugBehaviorPostTick(){const e=this.IsDebug();this._behInstsToPostTick.SetQueueingEnabled(!0);for(const t of this._behInstsToPostTick){const s=this._CallBehaviorPostTickMethod(t,e);SP.IsIterator(s)&&(yield*s)}this._behInstsToPostTick.SetQueueingEnabled(!1)}*_DebugBehaviorTick2(){const e=this.IsDebug();this._behInstsToTick2.SetQueueingEnabled(!0);for(const t of this._behInstsToTick2){const s=this._CallBehaviorTick2Method(t,e);SP.IsIterator(s)&&(yield*s)}this._behInstsToTick2.SetQueueingEnabled(!1)}async Tick(e,t,s){this._hasStartedTicking=!0;const i="background-wake"===s,r="background-wake"!==s&&"skip-render"!==s,n=this.GetLayoutManager(),a=this.GetCanvasManager();if(!this._hasStarted||this.IsSuspended()&&!t&&!i)return;const o=performance.now();this._isInTick=!0,this._MeasureDt(e||0),this._tpsTickCount++,this._ReleasePendingInstances();const h=this.Step_BeforePreTick();this.IsDebugging()&&await h;const l=this._dispatcher.dispatchEventAndWait_AsyncOptional(this.#s.pretick);l instanceof Promise&&await l,this.DispatchUserScriptEvent(this._userScriptEventObjects.pretick);const c=this.Step_AfterPreTick();this.IsDebugging()&&await c,this._NeedsHandleSaveOrLoad()&&await this._HandleSaveOrLoad(),n.IsPendingChangeMainLayout()&&await this._MaybeChangeLayout();const u=this.Step_RunEventsEtc();this.IsDebugging()&&await u;const d=n.GetMainRunningLayout(),_=d._GetPendingSetHTMLLayerCount();let p=!1;if(-1!==_&&(d._ResetPendingHTMLLayerCount(),a.GetHTMLLayerCount()!==_)){const e=this.GetCanvasManager().SetHTMLLayerCount(_);this.IsInWorker()&&(p=!0,await e)}if(this.PostComponentMessageToDOM("canvas","update-html-layer-dom-state",{layersDomState:d._GetRootLayers().filter(e=>e.IsHTMLElementsLayer()).map(e=>e._GetHTMLLayerDOMState())}),r&&this.Render(),p&&this.PostComponentMessageToDOM("canvas","cleanup-html-layers"),this.IsExportToVideo()&&(await this._ExportToVideoAddFrame(),this.GetGameTime()>=this.GetExportVideoDuration()))this._ExportToVideoFinish();else{if(!this.IsSuspended()&&!i){if("unlimited-frame"===this.GetFramerateMode()){const e=this.#t._GetRendererThrottlePromise();if(e){const t=this.GetRenderer(),s=t.IsWebGL();let i=!1;if(s){const e=()=>{t._CheckPendingPolls(),i||SP.RequestUnlimitedAnimationFrame(e,"background")};e()}await e,i=!0}}this._RequestAnimationFrame()}this._tickCount++,this._tickCountNoSave++,this._isInTick=!1,this._mainThreadTimeCounter+=performance.now()-o}}async Step_BeforePreTick(){const e=this.#h,t=this.IsDebug();this.FlushPendingInstances(),e.BlockFlushingInstances(!0),this.PushCurrentLayout(this.GetMainRunningLayout()),t&&GP.StartMeasuringTime(),this.IsDebugging()?await e.DebugRunScheduledWaits():e.RunScheduledWaits(),t&&GP.AddEventsTime(),this.PopCurrentLayout(),e.BlockFlushingInstances(!1),this.FlushPendingInstances(),e.BlockFlushingInstances(!0)}async Step_AfterPreTick(){const e=this.#h,t=this.IsDebug(),s=this.IsDebugging(),i=this._dispatcher,r=this.#s,n=this._userScriptEventObjects;t&&GP.StartMeasuringTime(),s?await this.DebugIterateAndBreak(this._DebugBehaviorTick()):this._BehaviorTick(),s?await this.DebugIterateAndBreak(this._DebugBehaviorPostTick()):this._BehaviorPostTick(),t&&GP.AddBehaviorTotalTickTime(),t&&GP.StartMeasuringTime(),s?await this.DebugFireGeneratorEventAndBreak(r.tick):i.dispatchEvent(r.tick),t&&GP.AddPluginTotalTickTime(),e.BlockFlushingInstances(!1),this.DispatchUserScriptEvent(n.tick)}async Step_RunEventsEtc(){const e=this.#h,t=this._dispatcher,s=this.#s,i=this._userScriptEventObjects,r=this.IsDebug(),n=this.IsDebugging();r&&GP.StartMeasuringTime(),n?await e.DebugRunEvents(this.#i):e.RunEvents(this.#i),r&&GP.AddEventsTime(),this.#o.ClearRegisteredCollisions(),this._ReleasePendingInstances(),this._isLayoutFirstTick=!1,e.BlockFlushingInstances(!0),r&&GP.StartMeasuringTime(),n?await this.DebugIterateAndBreak(this._DebugBehaviorTick2()):this._BehaviorTick2(),r&&GP.AddBehaviorTotalTickTime(),r&&GP.StartMeasuringTime(),n?await this.DebugFireGeneratorEventAndBreak(s.tick2):t.dispatchEvent(s.tick2),r&&GP.AddPluginTotalTickTime(),e.BlockFlushingInstances(!1),this.DispatchUserScriptEvent(i.tick2),n&&await e.RunQueuedDebugTriggersAsync(),this.FlushPendingInstances(),this._ReleasePendingInstances()}_ReleasePendingInstances(){if(0===this._instancesPendingRelease.size)return;const e=this._dispatcher;e.SetDelayRemoveEventsEnabled(!0);for(const e of this._instancesPendingReleaseAffectedObjectClasses)e.GetSolStack().RemoveInstances(this._instancesPendingRelease);this._instancesPendingReleaseAffectedObjectClasses.clear(),this.#h._OnInstancesReleased(this._instancesPendingRelease);for(const e of this._instancesPendingRelease)e.Release();this._instancesPendingRelease.clear(),e.SetDelayRemoveEventsEnabled(!1)}async _MaybeChangeLayout(){const e=this.GetLayoutManager();let t=0;for(;e.IsPendingChangeMainLayout()&&t++<10;)await this._DoChangeLayout(e.GetPendingChangeMainLayout())}_MeasureDt(e){let t=0;this.IsExportToVideo()?(t=1/this.GetExportVideoFramerate(),this._dtRaw=t,this._dt1=t):0!==this._lastTickTime&&(t=Math.max(e-this._lastTickTime,0)/1e3,t>.5&&(t=0),this._dtRaw=t,this._dt1=SP.clamp(t,this._minDt,this._maxDt)),this._lastTickTime=e,this._dt=this._dt1*this._timeScale,this._gameTime.Add(this._dt),this._gameTimeRaw.Add(t*this._timeScale),this._wallTime.Add(this._dt1);for(const[e,t]of this._instanceTimes)t.Add(this._dt1*e.GetTimeScale());this.#t&&this.#t._UpdateTick(),e-this._fpsLastTime>=1e3&&(this._fpsLastTime+=1e3,e-this._fpsLastTime>=1e3&&(this._fpsLastTime=e),this._fps=this._fpsFrameCount,this._fpsFrameCount=0,this._tps=this._tpsTickCount,this._tpsTickCount=0,this._mainThreadTime=Math.min(this._mainThreadTimeCounter/1e3,1),this._mainThreadTimeCounter=0,this.#t&&this.#t._Update1sFrameRange(),this.#o._Update1sStats(),this.IsDebug()&&GP.Update1sPerfStats())}_SetTrackingInstanceTime(e,t){if(t){if(!this._instanceTimes.has(e)){const t=SP.New(SP.KahanSum);t.Copy(this._gameTime),this._instanceTimes.set(e,t)}}else this._instanceTimes.delete(e)}_GetInstanceGameTime(e){const t=this._instanceTimes.get(e);return t?t.Get():this.GetGameTime()}async _DoChangeLayout(e){const t=this._dispatcher,s=this.GetLayoutManager().GetMainRunningLayout();await s._StopRunning(),s._Unload(e,this.GetRenderer()),s===e&&this.#h.ClearAllScheduledWaits(),this.#o.ClearRegisteredCollisions(),this._ReleasePendingInstances(),t.dispatchEvent(this.#s.beforelayoutchange),SP.Asyncify.SetHighThroughputMode(!0),await e._Load(s,this.GetRenderer()),SP.Asyncify.SetHighThroughputMode(!1),await e._StartRunning(!1),t.dispatchEvent(this.#s.layoutchange),this.UpdateRender(),this._isLayoutFirstTick=!0,this.FlushPendingInstances(),this._ExportToVideoAddKeyframe()}UpdateRender(){this._needRender=!0}GetWebGLRenderer(){return this.#t?this.#t.GetWebGLRenderer():null}GetWebGPURenderer(){return this.#t?this.#t.GetWebGPURenderer():null}GetRenderer(){return this.#t?this.#t.GetRenderer():null}Render(){const e=this.#t;if(!e||e.IsRendererContextLost())return;const t=this.GetRenderer(),s=t.SupportsGPUProfiling(),i=s&&t.IsWebGL(),r=s&&t.IsWebGPU();if(i&&t.CheckForQueryResults(),!this._needRender&&!this.IsExportToVideo()&&"unlimited-frame"!==this.GetFramerateMode())return void t.IncrementFrameNumber();const n=this.#i.GetMainRunningLayout();this._fpsFrameCount++,t.Start();const a=this.IsDebug();a&&GP.StartMeasuringTime(),this._needRender=!1;let o=null;i&&(o=e.GetGPUFrameTimingsBuffer().AddTimeElapsedQuery(),t.StartQuery(o)),r&&(t.StartFrameTiming(2*(1+n.GetLayerCount())),t.StartMeasuringRenderPassTime(0,1)),this.Uses3DFeatures()&&"low"===e.GetCurrentFullscreenScalingQuality()?t.SetFixedSizeDepthBuffer(e.GetDrawWidth(),e.GetDrawHeight()):t.SetAutoSizeDepthBuffer(),this._Render(this.GetRenderer(),n),o&&t.EndQuery(o),r&&t.StopMeasuringRenderPassTime(),t.Finish(),r&&this.#t._AddWebGPUFrameTimingResultPromise(t.FinishFrameTiming()),a&&(GP.AddDrawCallsTime(),GP.UpdateInspectHighlight()),e&&e._MaybeTakeSnapshot()}_NeedsHTMLLayerCompositing(e){return"low"===this.GetCanvasManager().GetCurrentFullscreenScalingQuality()||e.IsWebGL()&&(this.UsesAnyBackgroundBlending()||this.Uses3DFeatures())}_Render(e,t){e.SetTextureFillMode(),e.SetAlphaBlend(),e.ResetCullState(),e.SetColorRgba(1,1,1,1),e.SetRenderTarget(null),e.SetTexture(null),e.SetDepthEnabled(this.Uses3DFeatures()),this.Dispatcher().dispatchEvent(this.#s.beforerender),this.Dispatcher().dispatchEvent(this.#s.beforerender2),this._NeedsHTMLLayerCompositing(e)&&t._MaybeStartDrawToOwnTexture(e);const s=t.GetHTMLLayerCount();for(let i=1;i<s;++i)t.DrawForHTMLLayerIndex(e,i),e.IsWebGPU()&&e.Restart();this._NeedsHTMLLayerCompositing(e)||t._MaybeStartDrawToOwnTexture(e),t.DrawMain(e),this.Dispatcher().dispatchEvent(this.#s.afterrender)}Trigger(e,t,s){if(!this._hasStarted)return!1;const i=!this._isInTick&&!this.#h.IsInTrigger();let r=0;i&&(r=performance.now());const n=this.IsDebug();n&&this.SetDebuggingEnabled(!1);const a=this.#h._Trigger(this.#i,e,t,s);if(i){const e=performance.now()-r;this._mainThreadTimeCounter+=e,n&&GP.AddTriggersTime(e)}return n&&this.SetDebuggingEnabled(!0),a}DebugTrigger(e,t,s){if(!this.IsDebugging())return this.Trigger(e,t,s);if(this.HitBreakpoint())throw new Error("called DebugTrigger() while stopped on breakpoint");if(!this._isInTick&&!this.#h.IsInTrigger())throw new Error("called DebugTrigger() outside of event code - use TriggerAsync() instead");return this.#h._DebugTrigger(this.#i,e,t,s)}async TriggerAsync(e,t,s){if(!this.IsDebugging())return this.Trigger(e,t,s);if(!this._hasStarted)return!1;if(this.HitBreakpoint())return this.#h.QueueDebugTrigger(e,t,s);if(!this.GetMainRunningLayout())return this.#h.QueueTrigger(e,t,s);const i=performance.now(),r=this.#h._DebugTrigger(this.#i,e,t,s);let n=r.next();for(;!n.done;)await this.DebugBreak(n.value),n=r.next();return this.IsSuspended()||this.#h.IsInTrigger()||(await this.#h.RunQueuedDebugTriggersAsync(),this._hasStartedTicking&&!this._isInTick&&this._RequestAnimationFrame()),this._mainThreadTimeCounter+=performance.now()-i,n.value}FastTrigger(e,t,s){const i=this.IsDebug();i&&this.SetDebuggingEnabled(!1);const r=this.#h._FastTrigger(this.#i,e,t,s);return i&&this.SetDebuggingEnabled(!0),r}DebugFastTrigger(e,t,s){return this.#h._DebugFastTrigger(this.#i,e,t,s)}ScheduleTriggers(e){return this._scheduleTriggersThrottle.Add(e)}PushCurrentLayout(e){this._currentLayoutStack.push(e)}PopCurrentLayout(){if(!this._currentLayoutStack.length)throw new Error("layout stack empty");this._currentLayoutStack.pop()}GetCurrentLayout(){return this._currentLayoutStack.length?this._currentLayoutStack.at(-1):this.GetMainRunningLayout()}GetDt(e){return e&&-1!==e.GetTimeScale()?this._dt1*e.GetTimeScale():this._dt}_GetDtFast(){return this._dt}GetDt1(){return this._dt1}GetDtRaw(){return this._dtRaw}GetTimeScale(){return this._timeScale}SetTimeScale(e){(isNaN(e)||e<0)&&(e=0),this._timeScale=e}SetMinDt(e){this._minDt=Math.max(e,0)}GetMinDt(){return this._minDt}SetMaxDt(e){this._maxDt=Math.max(e,0)}GetMaxDt(){return this._maxDt}GetFramesPerSecond(){return this._fps}GetTicksPerSecond(){return this._tps}GetMainThreadTime(){return this._mainThreadTime}GetStartTime(){return this._startTime}GetGameTime(){return this._gameTime.Get()}GetGameTimeRaw(){return this._gameTimeRaw.Get()}GetWallTime(){return this._wallTime.Get()}GetTickCount(){return this._tickCount}GetTickCountNoSave(){return this._tickCountNoSave}GetObjectCount(){return this._objectCount}GetProjectName(){return this._projectName}GetProjectVersion(){return this._projectVersion}GetProjectUniqueId(){return this._projectUniqueId}GetAppId(){return this._appId}GetExportTimestamp(){return this._exportTimestamp}GetInstanceByUID(e){if(this._isLoadingState)throw new Error("cannot call while loading state - wait until afterload event");return this._instancesByUid.get(e)||null}_RemoveInstanceFromUIDMap(e){if(this._isLoadingState)throw new Error("cannot call while loading state - wait until afterload event");this._instancesByUid.delete(e)}_RefreshUidMap(){this._instancesByUid.clear();for(const e of this._allObjectClasses)if(!e.IsFamily())for(const t of e.GetInstances())this._instancesByUid.set(t.GetUID(),t)}IsPreview(){return"preview"===this._exportType}IsDebug(){return this._isDebug}GetExportType(){return this._exportType}IsCordova(){return"cordova"===this._exportType}IsAndroidWebView(){return"Android"===SP.Platform.OS&&("cordova"===this._exportType||"playable-ad-single-file"===this._exportType||"playable-ad-zip"===this._exportType||"instant-games"===this._exportType)}IsiOSCordova(){return this._isiOSCordova}IsiOSWebView(){return this._isiOSWebView}IsWindowsWebView2(){return this._isWindowsWebView2}IsAnyWebView2Wrapper(){return this._isAnyWebView2Wrapper}GetCollisionEngine(){return this.#o}GetSolidBehavior(){return this.#r.GetSolidBehavior()}GetJumpthruBehavior(){return this.#r.GetJumpthruBehavior()}Uses3DFeatures(){return this._uses3dFeatures}GetZScaleFactor(){return this.GetRenderer().GetZAxisScaleFactor(this.GetViewportHeight())}GetDefaultCameraZ(e){return this.GetRenderer().GetDefaultCameraZ(e||this.GetViewportHeight())}IsLayoutFirstTick(){return this._isLayoutFirstTick}SetPixelRoundingEnabled(e){e=!!e,this._isPixelRoundingEnabled!==e&&(this._isPixelRoundingEnabled=e,this.GetLayoutManager().SetAllLayerMVChanged(),this.UpdateRender())}IsPixelRoundingEnabled(){return this._isPixelRoundingEnabled}GetTextIconSet(e){if(!this._iconChangeHandlers.has(e)){const t=()=>this.DeleteTextIconSet(e);this._iconChangeHandlers.set(e,t),e.Dispatcher().addEventListener("animationframeimagechange",t)}const t=this._textIconManager.GetIconSet(e);return t.HasLoaded()||t.LoadContent().then(()=>this.UpdateRender()),t}DeleteTextIconSet(e){this._textIconManager.DeleteIconSet(e)}_GetTextIconSetMeta(e){const t=[];for(const s of e.GetAnimations())for(const e of s.GetFrames()){const s=e.GetImageInfo();t.push({source:e,width:s.GetWidth(),height:s.GetHeight(),tag:e.GetTag()})}return{icons:t}}async _GetTextIconSetContent(e){const t=SP.New(SP.PromiseThrottle),s=[],i=new Map;for(const r of e.GetAnimations())for(const e of r.GetFrames()){const r=e.GetImageInfo().GetImageAsset();i.has(r)||(i.set(r,null),s.push(t.Add(async()=>{const e=await r.LoadToDrawable();i.set(r,e)})))}await Promise.all(s);const r=[];for(const s of e.GetAnimations())for(const e of s.GetFrames())r.push(t.Add(async()=>{const t=e.GetImageInfo(),s=i.get(t.GetImageAsset()),r=await t.ExtractImageToCanvas(s);return{drawable:await createImageBitmap(r)}}));const n=await Promise.all(r);for(const e of i.values())e instanceof ImageBitmap&&e.close&&e.close();return{icons:n}}SaveToSlot(e){this._saveToSlotName=e,this._saveToJsonString=!1}SaveToJsonString(){this._saveToSlotName="",this._saveToJsonString=!0}LoadFromSlot(e){this._loadFromSlotName=e}LoadFromJsonString(e){this._loadFromJson=e}GetLastSaveJsonString(){return this._lastSaveJson}_NeedsHandleSaveOrLoad(){return!!(this._saveToSlotName||this._saveToJsonString||this._loadFromSlotName||null!==this._loadFromJson)}async _HandleSaveOrLoad(){if(this._saveToSlotName&&(this.FlushPendingInstances(),await this._DoSaveToSlot(this._saveToSlotName),this._ClearSaveOrLoad()),this._loadFromSlotName&&(await this._DoLoadFromSlot(this._loadFromSlotName),this._ClearSaveOrLoad(),this.IsDebug()&&GP.StepIfPausedInDebugger()),this._saveToJsonString){const e=await this._SaveToJsonString();this._lastSaveJson=e,await this.TriggerAsync(SP.Plugins.System.Cnds.OnSaveComplete,null),this._lastSaveJson="",this._ClearSaveOrLoad()}if(null!==this._loadFromJson){this.FlushPendingInstances();try{await this._DoLoadFromJsonString(this._loadFromJson),this._lastSaveJson=this._loadFromJson,await this.TriggerAsync(SP.Plugins.System.Cnds.OnLoadComplete,null),this._lastSaveJson=""}catch(e){console.error("[Construct] Failed to load state from JSON string: ",e),await this.TriggerAsync(SP.Plugins.System.Cnds.OnLoadFailed,null)}this._ClearSaveOrLoad()}}_ClearSaveOrLoad(){this._saveToSlotName="",this._saveToJsonString=!1,this._loadFromSlotName="",this._loadFromJson=null}_GetProjectStorage(){return this._projectStorage||(this._projectStorage=localforage.createInstance({name:"c3-localstorage-"+this.GetProjectUniqueId(),description:this.GetProjectName()})),this._projectStorage}_GetSavegamesStorage(){return this._savegamesStorage||(this._savegamesStorage=localforage.createInstance({name:"c3-savegames-"+this.GetProjectUniqueId(),description:this.GetProjectName()})),this._savegamesStorage}async _DoSaveToSlot(e){const t=await this._SaveToJsonString();try{await this._GetSavegamesStorage().setItem(e,t),console.log("[Construct] Saved state to storage ("+t.length+" chars)"),this._lastSaveJson=t,await this.TriggerAsync(SP.Plugins.System.Cnds.OnSaveComplete,null),this._lastSaveJson=""}catch(e){console.error("[Construct] Failed to save state to storage: ",e),await this.TriggerAsync(SP.Plugins.System.Cnds.OnSaveFailed,null)}}async _DoLoadFromSlot(e){try{const t=await this._GetSavegamesStorage().getItem(e);if(!t)throw new Error("empty slot");console.log("[Construct] Loaded state from storage ("+t.length+" chars)"),await this._DoLoadFromJsonString(t),this._lastSaveJson=t,await this.TriggerAsync(SP.Plugins.System.Cnds.OnLoadComplete,null),this._lastSaveJson=""}catch(e){console.error("[Construct] Failed to load state from storage: ",e),await this.TriggerAsync(SP.Plugins.System.Cnds.OnLoadFailed,null)}}async _SaveToJsonString(){const e={c3save:!0,version:1,rt:{time:this.GetGameTime(),timeRaw:this.GetGameTimeRaw(),walltime:this.GetWallTime(),timescale:this.GetTimeScale(),tickcount:this.GetTickCount(),next_uid:this._nextUid,running_layout:this.GetMainRunningLayout().GetSID(),start_time_offset:Date.now()-this._startTime},types:{},layouts:{},events:this.#h._SaveToJson(),timelines:this.#a._SaveToJson(),user_script_data:null};for(const t of this._allObjectClasses)t.IsFamily()||t.HasNoSaveBehavior()||(e.types[t.GetSID().toString()]=t._SaveToJson());for(const t of this.#i.GetAllLayouts())e.layouts[t.GetSID().toString()]=t._SaveToJson();const t=this._CreateUserScriptEvent("save");return t.saveData=null,await this.DispatchUserScriptEventAsyncWait(t),e.user_script_data=t.saveData,JSON.stringify(e)}IsLoadingState(){return this._isLoadingState}async _DoLoadFromJsonString(e){const t=this.GetLayoutManager(),s=JSON.parse(e);if(s.c2save)throw new Error("C2 saves are incompatible with C3 runtime");if(!s.c3save)throw new Error("not valid C3 save data");if(s.version>1)throw new Error("C3 save data from future version");this.ClearIntancesNeedingAfterLoad(),this._dispatcher.dispatchEvent(SP.New(SP.Event,"beforeload"));for(const e of this.allInstances())e.GetObjectClass().HasNoSaveBehavior()||e._OnBeforeLoad();const i=s.rt;this._gameTime.Set(i.time),i.hasOwnProperty("timeRaw")&&this._gameTimeRaw.Set(i.timeRaw),this._wallTime.Set(i.walltime),this._timeScale=i.timescale,this._tickCount=i.tickcount,this._startTime=Date.now()-i.start_time_offset;const r=i.running_layout;this._isLoadingState=!0;let n=!1;if(r!==this.GetMainRunningLayout().GetSID()){const e=t.GetLayoutBySID(r);if(!e)return;await this._DoChangeLayout(e),n=!0}for(const[e,i]of Object.entries(s.layouts)){const s=parseInt(e,10),r=t.GetLayoutBySID(s);r&&r._LoadFromJson(i)}const a=new Set;for(const[e,t]of Object.entries(s.types)){const s=parseInt(e,10),i=this.GetObjectClassBySID(s);!i||i.IsFamily()||i.HasNoSaveBehavior()||i._LoadFromJson(t,a)}for(const e of this.#i.GetAllLayouts())for(const t of e.allLayers())t._LoadFromJsonAfterInstances();if(this.FlushPendingInstances(),this._RefreshUidMap(),this._isLoadingState=!1,n){for(const e of this.allInstances())e.SetupInitialSceneGraphConnections();for(const[e,t]of Object.entries(s.types)){const s=parseInt(e,10),i=this.GetObjectClassBySID(s);!i||i.IsFamily()||i.HasNoSaveBehavior()||i._SetupSceneGraphConnectionsOnChangeOfLayout(t)}}this._nextUid=i.next_uid,this.#h._LoadFromJson(s.events);for(const e of this._allObjectClasses)if(!e.IsFamily()&&e.IsInContainer())for(const t of e.GetInstances()){const s=t.GetIID();t._ClearSiblings();for(const i of e.GetContainer().objectTypes()){if(i===e)continue;const r=i.GetInstances();if(s<0||s>=r.length)throw new Error("missing sibling instance");t._AddSibling(r[s])}}this.#a._LoadFromJson(s.timelines),t.SetAllLayerProjectionChanged(),t.SetAllLayerMVChanged();for(const e of a)e._OnCreatedForLoadingSavegame();this.DoAfterLoad(),this._dispatcher.dispatchEvent(SP.New(SP.Event,"afterload")),this.DispatchUserScriptEvent(this._CreateUserScriptEvent("afterload"));for(const[e,t]of Object.entries(s.types)){const t=parseInt(e,10),s=this.GetObjectClassBySID(t);s&&s._ClearLoadInstancesJson()}const o=this._CreateUserScriptEvent("load");o.saveData=s.user_script_data,await this.DispatchUserScriptEventAsyncWait(o),this.UpdateRender()}SortOnTmpHierarchyPosition(e,t){return t.GetWorldInfo().GetTmpHierarchyPosition()-e.GetWorldInfo().GetTmpHierarchyPosition()}AddInstanceNeedingAfterLoad(e,t){e.GetWorldInfo()&&(this.#v.has(e)||(this.#v.set(e,t),this.#_.push(e)))}ClearIntancesNeedingAfterLoad(){this.#v=new WeakMap,SP.clearArray(this.#_),SP.SceneGraphInfo.ClearUpdatedInstances()}DoAfterLoad(e="full",t=null){this.#_.sort(this.SortOnTmpHierarchyPosition),t||(t={}),t.processedWorldInfo=new Set;const s=this.#_.length;for(const s of this.#_)s._OnAfterLoad(this.#v.get(s),e,t);for(const s of this.#_)s._OnAfterLoad2(this.#v.get(s),e,t);if(this.ClearIntancesNeedingAfterLoad(),s){this.FlushPendingInstances(),this._RefreshUidMap();for(const e of this.#i.GetAllLayouts())for(const t of e.allLayers())t._SortInstancesByLastCachedZIndex(),t.SetZIndicesChanged()}}async AddJobWorkerScripts(e){const t=e.map(e=>new URL(e,location.href).toString());this.#d.ImportScriptsToJobWorkers(t)}AddJobWorkerBlob(e,t){this.#d.SendBlobToJobWorkers(e,t)}AddJobWorkerBuffer(e,t){this.#d.SendBufferToJobWorkers(e,t)}AddJob(e,t,s,i){return this.#d.AddJob(e,t,s,null,null,i)}BroadcastJob(e,t,s,i){return this.#d.BroadcastJob(e,t,s,i)}GetMaxNumJobWorkers(){return this.#d.GetMaxNumWorkers()}InvokeDownload(e,t){this.PostComponentMessageToDOM("runtime","invoke-download",{url:e,filename:t})}async RasterSvgImage(e,t,s,i,r,n){if(i=i||t,r=r||s,this.IsInWorker())return(await this.PostComponentMessageToDOMAsync("runtime","raster-svg-image",{blob:e,imageWidth:t,imageHeight:s,surfaceWidth:i,surfaceHeight:r,imageBitmapOpts:n})).imageBitmap;{const a=await self.C3_RasterSvgImageBlob(e,t,s,i,r);return n?await self.createImageBitmap(a,n):a}}async GetSvgImageSize(e){return this.IsInWorker()?await this.PostComponentMessageToDOMAsync("runtime","get-svg-image-size",{blob:e}):await self.C3_GetSvgImageSize(e)}RequestDeviceOrientationEvent(){this._didRequestDeviceOrientationEvent||(this._didRequestDeviceOrientationEvent=!0,this.PostComponentMessageToDOM("runtime","enable-device-orientation"))}RequestDeviceMotionEvent(){this._didRequestDeviceMotionEvent||(this._didRequestDeviceMotionEvent=!0,this.PostComponentMessageToDOM("runtime","enable-device-motion"))}Random(){return this._randomNumberCallback()}SetRandomNumberGeneratorCallback(e){this._randomNumberCallback=e}_GetRemotePreviewStatusInfo(){const e=this.GetRenderer();return{fps:this.GetFramesPerSecond(),tps:this.GetTicksPerSecond(),cpu:this.GetMainThreadTime(),gpu:this.GetGPUUtilisation(),layout:this.GetMainRunningLayout()?this.GetMainRunningLayout().GetName():"",renderer:e.IsWebGL()?e.GetUnmaskedRenderer():e.GetAdapterInfoString()}}HitBreakpoint(){return!!this.IsDebug()&&GP.HitBreakpoint()}DebugBreak(e){return this.IsDebugging()?GP.DebugBreak(e):Promise.resolve()}DebugBreakNext(){return!!this.IsDebugging()&&GP.BreakNext()}SetDebugBreakpointsEnabled(e){this._breakpointsEnabled=!!e,this._UpdateDebuggingFlag()}AreDebugBreakpointsEnabled(){return this._breakpointsEnabled}IsDebugging(){return this._isDebugging}SetDebuggingEnabled(e){e?this._debuggingDisabled--:this._debuggingDisabled++,this._UpdateDebuggingFlag()}_UpdateDebuggingFlag(){this._isDebugging=this.IsDebug()&&this._breakpointsEnabled&&0===this._debuggingDisabled}IsCPUProfiling(){return this.IsDebug()&&GP.IsCPUProfiling()}IsGPUProfiling(){return this.IsDebug()&&this.GetRenderer().SupportsGPUProfiling()&&GP.IsGPUProfiling()}async DebugIterateAndBreak(e){if(e)for(const t of e)await this.DebugBreak(t)}DebugFireGeneratorEventAndBreak(e){return this.DebugIterateAndBreak(this._dispatcher.dispatchGeneratorEvent(e))}_InvokeFunctionFromJS(e){return this.#h._InvokeFunctionFromJS(e.name,e.params)}_GetHTMLLayerWrapElement(e){if(this.IsInWorker())throw new Error("not supported in worker mode");return self.c3_runtimeInterface._GetHTMLWrapElement(e)}GetIRuntime(){return this._iRuntime}GetConstructVersionCode(){return this._constructVersionCode}_CreateUserScriptEvent(e){const t=SP.New(SP.Event,e,!1);return t.runtime=this._iRuntime,t}_InitScriptInterfaces(){this._iRuntime=new self.IRuntime(this),this._userScriptEventObjects={pretick:this._CreateUserScriptEvent("pretick"),tick:this._CreateUserScriptEvent("tick"),tick2:this._CreateUserScriptEvent("tick2")}}_InitObjectsScriptInterface(){const e={};for(const t of this._allObjectClasses)e[t.GetJsPropName()]={value:t.GetIObjectClass(),enumerable:!0,writable:!1};this._iRuntime._InitObjects(e)}_InitGlobalVariableScriptInterface(){const e={};for(const t of this.GetEventSheetManager().GetAllGlobalVariables())e[t.GetJsPropName()]=t._GetScriptInterfaceDescriptor();this._iRuntime._InitGlobalVars(e)}_GetCommonScriptInterfaces(){return this._commonScriptInterfaces}_MapScriptInterface(e,t){this.#e.set(e,t)}_UnwrapScriptInterface(e){return this.#e.get(e)}_UnwrapIObjectClass(e){if(!(e instanceof self.IObjectClass))throw new TypeError("expected IObjectClass");const t=this._UnwrapScriptInterface(e);if(!(t&&t instanceof SP.ObjectClass))throw new Error("invalid IObjectClass");return t}_UnwrapIInstance(e){if(!(e instanceof self.IInstance))throw new TypeError("expected IInstance");const t=this._UnwrapScriptInterface(e);if(!(t&&t instanceof SP.Instance))throw new Error("invalid IInstance");return t}_UnwrapIWorldInstance(e){if(!(e instanceof self.IWorldInstance))throw new TypeError("expected IWorldInstance");const t=this._UnwrapScriptInterface(e);if(!(t&&t instanceof SP.Instance))throw new Error("invalid IInstance");return t}},globalThis.C3_SetInitFunctions(mP,gP)}{const bP=self.C3;bP.JobSchedulerRuntime=class extends bP.DefendedBase{constructor(e,t){super(),this._runtime=e,this._jobPromises=new Map,this._nextJobId=0,this._inputPort=t.inputPort,t.outputPort.onmessage=e=>this._OnJobWorkerMessage(e),this._maxNumWorkers=t.maxNumWorkers,this._jobWorkerCount=1,this._isCreatingWorker=!1,this._hadErrorCreatingWorker=!1}GetMaxNumWorkers(){return this._maxNumWorkers}ImportScriptsToJobWorkers(e){this._inputPort.postMessage({type:"_import_scripts",scripts:e})}SendBlobToJobWorkers(e,t){this._inputPort.postMessage({type:"_send_blob",blob:e,id:t})}SendBufferToJobWorkers(e,t){this._inputPort.postMessage({type:"_send_buffer",buffer:e,id:t},[e])}AddJob(e,t,s,i,r,n){if(s||(s=[]),"number"==typeof n&&(n=Math.floor(n))<=0)throw new Error("invalid maxWorkerNum");const a=this._nextJobId++,o={type:e,isBroadcast:!1,maxWorkerNum:n,jobId:a,params:t,transferables:s},h=new Promise((e,t)=>{this._jobPromises.set(a,{resolve:e,progress:i,reject:t,cancelled:!1,maxWorkerNum:n})});return r&&r.SetAction(()=>this._CancelJob(a)),this._inputPort.postMessage(o,s),this._MaybeCreateExtraWorker(),h}BroadcastJob(e,t,s,i){if(s||(s=[]),"number"==typeof i&&(i=Math.floor(i))<=0)throw new Error("invalid maxWorkerNum");const r={type:e,isBroadcast:!0,maxWorkerNum:i,jobId:this._nextJobId++,params:t,transferables:s};this._inputPort.postMessage(r,s)}_CancelJob(e){const t=this._jobPromises.get(e);t&&(t.cancelled=!0,t.resolve=null,t.progress=null,t.reject=null,this._inputPort.postMessage({type:"_cancel",jobId:e}))}_OnJobWorkerMessage(e){const t=e.data,s=t.type,i=t.jobId;switch(s){case"result":this._OnJobResult(i,t.result);break;case"progress":this._OnJobProgress(i,t.progress);break;case"error":this._OnJobError(i,t.error);break;case"ready":this._OnJobWorkerReady();break;default:throw new Error(`unknown message from worker '${s}'`)}}_OnJobResult(e,t){const s=this._jobPromises.get(e);if(!s)throw new Error("invalid job ID");s.cancelled||s.resolve(t),this._jobPromises.delete(e)}_OnJobProgress(e,t){const s=this._jobPromises.get(e);if(!s)throw new Error("invalid job ID");!s.cancelled&&s.progress&&s.progress(t)}_OnJobError(e,t){const s=this._jobPromises.get(e);if(!s)throw new Error("invalid job ID");s.cancelled||s.reject(t),this._jobPromises.delete(e)}_OnJobWorkerReady(){this._isCreatingWorker&&(this._isCreatingWorker=!1,this._jobWorkerCount++,this._jobWorkerCount<this._maxNumWorkers?this._MaybeCreateExtraWorker():this._inputPort.postMessage({type:"_no_more_workers"}))}_GetWorkerCountNeededForPendingJobs(){let e=0;const t=[...this._jobPromises.values()].sort((e,t)=>(e.maxWorkerNum||1/0)-(t.maxWorkerNum||1/0));for(const s of t)e<(s.maxWorkerNum||1/0)&&e++;return e}async _MaybeCreateExtraWorker(){if(!(this._jobWorkerCount>=this._maxNumWorkers||this._isCreatingWorker||this._hadErrorCreatingWorker||this._GetWorkerCountNeededForPendingJobs()<=this._jobWorkerCount))try{this._isCreatingWorker=!0,(await this._runtime.PostComponentMessageToDOMAsync("runtime","create-job-worker")).outputPort.onmessage=e=>this._OnJobWorkerMessage(e)}catch(e){this._hadErrorCreatingWorker=!0,this._isCreatingWorker=!1,console.error(`[Construct] Failed to create job worker; stopping creating any more (created ${this._jobWorkerCount} so far)`,e)}}}}self.C3_Shaders={},self.C3_Shaders.glowhorizontal={glsl:"varying mediump vec2 vTex;\nuniform mediump sampler2D samplerFront;\nuniform mediump vec2 pixelSize;\nuniform mediump float intensity;\nvoid main(void)\n{\nmediump vec4 sum = vec4(0.0);\nmediump float pixelWidth = pixelSize.x;\nmediump float halfPixelWidth = pixelWidth / 2.0;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 7.0 + halfPixelWidth, 0.0)) * 0.06;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 5.0 + halfPixelWidth, 0.0)) * 0.10;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 3.0 + halfPixelWidth, 0.0)) * 0.13;\nsum += texture2D(samplerFront, vTex - vec2(pixelWidth * 1.0 + halfPixelWidth, 0.0)) * 0.16;\nmediump vec4 front = texture2D(samplerFront, vTex);\nsum += front * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 1.0 + halfPixelWidth, 0.0)) * 0.16;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 3.0 + halfPixelWidth, 0.0)) * 0.13;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 5.0 + halfPixelWidth, 0.0)) * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(pixelWidth * 7.0 + halfPixelWidth, 0.0)) * 0.06;\ngl_FragColor = mix(front, max(front, sum), intensity);\n}",glslWebGL2:"",wgsl:"%%SAMPLERFRONT_BINDING%% var samplerFront : sampler;\n%%TEXTUREFRONT_BINDING%% var textureFront : texture_2d<f32>;\nstruct ShaderParams {\nintensity : f32\n};\n%%SHADERPARAMS_BINDING%% var<uniform> shaderParams : ShaderParams;\n%%C3_UTILITY_FUNCTIONS%%\n%%FRAGMENTINPUT_STRUCT%%\n%%FRAGMENTOUTPUT_STRUCT%%\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\nvar pixelWidth : f32 = c3_getPixelSize(textureFront).x;\nvar front : vec4<f32> = textureSample(textureFront, samplerFront, input.fragUV);\nvar sum : vec4<f32> =\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 7.5, 0.0)) * 0.06 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 5.5, 0.0)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 3.5, 0.0)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(pixelWidth * 1.5, 0.0)) * 0.16 +\nfront * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 1.5, 0.0)) * 0.16 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 3.5, 0.0)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 5.5, 0.0)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(pixelWidth * 7.5, 0.0)) * 0.06;\nvar output : FragmentOutput;\noutput.color = mix(front, max(front, sum), shaderParams.intensity);\nreturn output;\n}",blendsBackground:!1,usesDepth:!1,extendBoxHorizontal:8,extendBoxVertical:0,crossSampling:!1,mustPreDraw:!1,preservesOpaqueness:!1,supports3dDirectRendering:!1,animated:!1,parameters:[["intensity",0,"percent"]]},self.C3_Shaders.glowvertical={glsl:"varying mediump vec2 vTex;\nuniform mediump sampler2D samplerFront;\nuniform mediump vec2 pixelSize;\nuniform mediump float intensity;\nvoid main(void)\n{\nmediump vec4 sum = vec4(0.0);\nmediump float pixelHeight = pixelSize.y;\nmediump float halfPixelHeight = pixelHeight / 2.0;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 7.0 + halfPixelHeight)) * 0.06;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 5.0 + halfPixelHeight)) * 0.10;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 3.0 + halfPixelHeight)) * 0.13;\nsum += texture2D(samplerFront, vTex - vec2(0.0, pixelHeight * 1.0 + halfPixelHeight)) * 0.16;\nmediump vec4 front = texture2D(samplerFront, vTex);\nsum += front * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 1.0 + halfPixelHeight)) * 0.16;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 3.0 + halfPixelHeight)) * 0.13;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 5.0 + halfPixelHeight)) * 0.10;\nsum += texture2D(samplerFront, vTex + vec2(0.0, pixelHeight * 7.0 + halfPixelHeight)) * 0.06;\ngl_FragColor = mix(front, max(front, sum), intensity);\n}",glslWebGL2:"",wgsl:"%%SAMPLERFRONT_BINDING%% var samplerFront : sampler;\n%%TEXTUREFRONT_BINDING%% var textureFront : texture_2d<f32>;\nstruct ShaderParams {\nintensity : f32\n};\n%%SHADERPARAMS_BINDING%% var<uniform> shaderParams : ShaderParams;\n%%C3_UTILITY_FUNCTIONS%%\n%%FRAGMENTINPUT_STRUCT%%\n%%FRAGMENTOUTPUT_STRUCT%%\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\nvar pixelHeight : f32 = c3_getPixelSize(textureFront).y;\nvar front : vec4<f32> = textureSample(textureFront, samplerFront, input.fragUV);\nvar sum : vec4<f32> =\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 7.5)) * 0.06 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 5.5)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 3.5)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV - vec2<f32>(0.0, pixelHeight * 1.5)) * 0.16 +\nfront * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 1.5)) * 0.16 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 3.5)) * 0.13 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 5.5)) * 0.10 +\ntextureSample(textureFront, samplerFront, input.fragUV + vec2<f32>(0.0, pixelHeight * 7.5)) * 0.06;\nvar output : FragmentOutput;\noutput.color = mix(front, max(front, sum), shaderParams.intensity);\nreturn output;\n}",blendsBackground:!1,usesDepth:!1,extendBoxHorizontal:0,extendBoxVertical:8,crossSampling:!1,mustPreDraw:!1,preservesOpaqueness:!1,supports3dDirectRendering:!1,animated:!1,parameters:[["intensity",0,"percent"]]},self.C3_Shaders.waterbg={glsl:"#ifdef GL_FRAGMENT_PRECISION_HIGH\n#define highmedp highp\n#else\n#define highmedp mediump\n#endif\nvarying mediump vec2 vTex;\nuniform lowp sampler2D samplerFront;\nuniform mediump vec2 srcStart;\nuniform mediump vec2 srcEnd;\nuniform lowp sampler2D samplerBack;\nuniform mediump vec2 destStart;\nuniform mediump vec2 destEnd;\nprecision mediump float;\nuniform highmedp float seconds;\nuniform mediump vec2 pixelSize;\nconst float PI = 3.1415926535897932;\nuniform float speed;\nuniform float speed_x;\nuniform float speed_y;\nuniform float intensity;\nconst float steps = 8.0;\nuniform float frequency;\nuniform float angle; // better when a prime\nuniform float delta;\nuniform float intence;\nuniform float emboss;\nfloat col(vec2 coord)\n{\nfloat delta_theta = 2.0 * PI / angle;\nfloat col = 0.0;\nfloat theta = 0.0;\nfor (float i = 0.0; i < steps; i++)\n{\nvec2 adjc = coord;\ntheta = delta_theta*i;\nadjc.x += cos(theta)*seconds*speed + seconds * speed_x;\nadjc.y -= sin(theta)*seconds*speed - seconds * speed_y;\ncol = col + cos( (adjc.x*cos(theta) - adjc.y*sin(theta))*frequency)*intensity;\n}\nreturn cos(col);\n}\nvoid main(void)\n{\nmediump vec2 tex = (vTex - srcStart) / (srcEnd - srcStart);\nvec2 p = tex, c1 = p, c2 = p;\nfloat cc1 = col(c1);\nc2.x += (1.0 / pixelSize.x) / delta;\nfloat dx = emboss*(cc1-col(c2))/delta;\nc2.x = p.x;\nc2.y += (1.0 / pixelSize.y) / delta;\nfloat dy = emboss*(cc1-col(c2))/delta;\nc1.x += dx;\nc1.y = -(c1.y+dy);\nfloat alpha = 1.+dot(dx,dy)*intence;\nc1.y = -c1.y;\nc1 = clamp(c1, 0.0, 1.0);\nlowp vec4 front = texture2D(samplerFront, mix(srcStart, srcEnd, c1)) * alpha;\nlowp vec4 result;\nif (front.a == 0.0)\nresult = front + texture2D(samplerBack, mix(destStart, destEnd, tex)) * (1.0 - front.a);\nelse\nresult = front + texture2D(samplerBack, mix(destStart, destEnd, c1)) * (1.0 - front.a);\ngl_FragColor = result;\n}",glslWebGL2:"",wgsl:"%%SAMPLERFRONT_BINDING%% var samplerFront : sampler;\n%%TEXTUREFRONT_BINDING%% var textureFront : texture_2d<f32>;\n%%SAMPLERBACK_BINDING%% var samplerBack : sampler;\n%%TEXTUREBACK_BINDING%% var textureBack : texture_2d<f32>;\nstruct ShaderParams {\nspeed : f32,\nspeed_x : f32,\nspeed_y : f32,\nintensity : f32,\nfrequency : f32,\nangle : f32,\ndelta : f32,\nintence : f32,\nemboss : f32\n};\n%%SHADERPARAMS_BINDING%% var<uniform> shaderParams : ShaderParams;\n%%C3PARAMS_STRUCT%%\n%%C3_UTILITY_FUNCTIONS%%\n%%FRAGMENTINPUT_STRUCT%%\n%%FRAGMENTOUTPUT_STRUCT%%\nconst pi : f32 = 3.1415926535897932;\nconst steps = 8.0;\nfn col(coord : vec2<f32>) -> f32\n{\nvar delta_theta : f32 = 2.0 * pi / shaderParams.angle;\nvar col : f32 = 0.0;\nvar theta : f32 = 0.0;\nfor (var i : f32 = 0.0; i < steps; i = i + 1.0)\n{\nvar adjc : vec2<f32> = coord;\ntheta = delta_theta * i;\nadjc.x = adjc.x + cos(theta) * c3Params.seconds * shaderParams.speed + c3Params.seconds * shaderParams.speed_x;\nadjc.y = adjc.y - (sin(theta) * c3Params.seconds * shaderParams.speed - c3Params.seconds * shaderParams.speed_y);\ncol = col + cos((adjc.x * cos(theta) - adjc.y * sin(theta)) * shaderParams.frequency) * shaderParams.intensity;\n}\nreturn cos(col);\n}\n@fragment\nfn main(input : FragmentInput) -> FragmentOutput\n{\nvar texSize : vec2<f32> = vec2<f32>(textureDimensions(textureFront));\nvar tex : vec2<f32> = c3_srcToNorm(input.fragUV);\nvar p : vec2<f32> = tex;\nvar c1 : vec2<f32> = tex;\nvar c2 : vec2<f32> = tex;\nvar cc1 : f32 = col(c1);\nc2.x = c2.x + texSize.x / shaderParams.delta;\nvar dx : f32 = shaderParams.emboss * (cc1 - col(c2)) / shaderParams.delta;\nc2.x = p.x;\nc2.y = c2.y + texSize.y / shaderParams.delta;\nvar dy : f32 = shaderParams.emboss * (cc1 - col(c2)) / shaderParams.delta;\nc1.x = c1.x + dx;\nc1.y = -(c1.y + dy);\nvar alpha : f32 = 1.0 + dx * dy * shaderParams.intence;\nc1.y = -c1.y;\nc1 = c3_clamp2(c1, 0.0, 1.0);\nlet texXy = mix(c3Params.srcStart, c3Params.srcEnd, c1);\nlet texDx = dpdx(texXy);\nlet texDy = dpdy(texXy);\nvar front : vec4<f32> = textureSampleGrad(textureFront, samplerFront, texXy, texDx, texDy);\nvar output : FragmentOutput;\nif (front.a == 0.0)\n{\noutput.color = textureSampleGrad(textureBack, samplerBack, mix(c3Params.destStart, c3Params.destEnd, tex), texDx, texDy);\n}\nelse\n{\noutput.color =  textureSampleGrad(textureBack, samplerBack, mix(c3Params.destStart, c3Params.destEnd, c1), texDx, texDy);\n}\noutput.color = output.color * (1.0 - front.a) + front;\nreturn output;\n}",blendsBackground:!0,usesDepth:!1,extendBoxHorizontal:40,extendBoxVertical:40,crossSampling:!0,mustPreDraw:!1,preservesOpaqueness:!1,supports3dDirectRendering:!1,animated:!0,parameters:[["speed",0,"percent"],["speed_x",0,"percent"],["speed_y",0,"percent"],["intensity",0,"float"],["frequency",0,"float"],["angle",0,"float"],["delta",0,"float"],["intence",0,"float"],["emboss",0,"percent"]]};{let xP=function(e,t){const s=e[1],i=t[1];if("number"==typeof s&&"number"==typeof i)return s-i;{const e=""+s,t=""+i;return e<t?-1:e>t?1:0}};ForEachOrdered_SortInstances=xP;const wP=self.C3;let PP=null,RP="",vP="",AP=[],MP="",DP="",EP="";const FP=wP.New(wP.ArrayStack);wP.Plugins.System=class extends wP.SDKPluginBase{constructor(e){super(e),this._loopStack=this._runtime.GetEventSheetManager().GetLoopStack(),this._eventStack=this._runtime.GetEventSheetManager().GetEventStack(),this._imagesLoadingTotal=0,this._imagesLoadingComplete=0,this._functionMaps=new Map}Release(){super.Release()}UpdateRender(){this._runtime.UpdateRender()}Trigger(e){this._runtime.Trigger(e,null,null)}GetRegex(e,t){return PP&&e===RP&&t===vP||(PP=new RegExp(e,t),RP=e,vP=t),PP.lastIndex=0,PP}GetRegexMatches(e,t,s){if(e===MP&&t===DP&&s===EP)return AP;const i=this.GetRegex(t,s);return AP=e.match(i),MP=e,DP=t,EP=s,AP}async _LoadTexturesForObjectClasses(e,t){if(!t.length)return;this._imagesLoadingTotal+=t.length;const s=[];for(const i of t)s.push(e.MaybeLoadTexturesFor(i));await wP.PromiseAllWithProgress(s,()=>{this._imagesLoadingComplete++}),this._imagesLoadingComplete++,this._imagesLoadingComplete===this._imagesLoadingTotal&&(this._imagesLoadingComplete=0,this._imagesLoadingTotal=0,this._runtime.Trigger(wP.Plugins.System.Cnds.OnImageLoadingComplete,null,null))}GetImageLoadingProgress(){return 0===this._imagesLoadingTotal?1:this._imagesLoadingComplete/this._imagesLoadingTotal}_UnloadTexturesForObjectClasses(e,t){for(const s of t)0===s.GetInstanceCount()&&e.MaybeUnloadTexturesFor(s)}_GetForEachStack(){return FP}_Repeat(e){const t=this._runtime.GetEventSheetManager(),s=t.GetEventStack(),i=s.GetCurrentStackFrame(),r=i.GetCurrentEvent(),n=r.GetSolModifiers(),a=i.IsSolModifierAfterCnds(),o=s.Push(r),h=t.GetLoopStack(),l=h.Push();if(l.SetEnd(e),a)for(let s=0;s<e&&!l.IsStopped();++s)t.PushCopySol(n),l.SetIndex(s),r.Retrigger(i,o),t.PopSol(n);else for(let t=0;t<e&&!l.IsStopped();++t)l.SetIndex(t),r.Retrigger(i,o);return s.Pop(),h.Pop(),!1}*_DebugRepeat(e){const t=this._runtime.GetEventSheetManager(),s=t.GetEventStack(),i=s.GetCurrentStackFrame(),r=i.GetCurrentEvent(),n=r.GetSolModifiers(),a=i.IsSolModifierAfterCnds(),o=s.Push(r),h=t.GetLoopStack(),l=h.Push();if(l.SetEnd(e),a)for(let s=0;s<e&&!l.IsStopped();++s)t.PushCopySol(n),l.SetIndex(s),yield*r.DebugRetrigger(i,o),t.PopSol(n);else for(let t=0;t<e&&!l.IsStopped();++t)l.SetIndex(t),yield*r.DebugRetrigger(i,o);return s.Pop(),h.Pop(),!1}_While(){const e=this._runtime.GetEventSheetManager(),t=e.GetEventStack(),s=t.GetCurrentStackFrame(),i=s.GetCurrentEvent(),r=i.GetSolModifiers(),n=s.IsSolModifierAfterCnds(),a=t.Push(i),o=e.GetLoopStack(),h=o.Push();if(n)for(let t=0;!h.IsStopped();++t)e.PushCopySol(r),h.SetIndex(t),i.Retrigger(s,a)||h.Stop(),e.PopSol(r);else for(let e=0;!h.IsStopped();++e)h.SetIndex(e),i.Retrigger(s,a)||h.Stop();return t.Pop(),o.Pop(),!1}*_DebugWhile(){const e=this._runtime.GetEventSheetManager(),t=e.GetEventStack(),s=t.GetCurrentStackFrame(),i=s.GetCurrentEvent(),r=i.GetSolModifiers(),n=s.IsSolModifierAfterCnds(),a=t.Push(i),o=e.GetLoopStack(),h=o.Push();if(n)for(let t=0;!h.IsStopped();++t)e.PushCopySol(r),h.SetIndex(t),(yield*i.DebugRetrigger(s,a))||h.Stop(),e.PopSol(r);else for(let e=0;!h.IsStopped();++e)h.SetIndex(e),(yield*i.DebugRetrigger(s,a))||h.Stop();return t.Pop(),o.Pop(),!1}_For(e,t,s){const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),h=n.IsSolModifierAfterCnds(),l=r.Push(a),c=i.GetLoopStack(),u=c.Push();if(u.SetName(e),u.SetEnd(s),s<t)if(h)for(let e=t;e>=s&&!u.IsStopped();--e)i.PushCopySol(o),u.SetIndex(e),a.Retrigger(n,l),i.PopSol(o);else for(let e=t;e>=s&&!u.IsStopped();--e)u.SetIndex(e),a.Retrigger(n,l);else if(h)for(let e=t;e<=s&&!u.IsStopped();++e)i.PushCopySol(o),u.SetIndex(e),a.Retrigger(n,l),i.PopSol(o);else for(let e=t;e<=s&&!u.IsStopped();++e)u.SetIndex(e),a.Retrigger(n,l);return r.Pop(),c.Pop(),!1}*_DebugFor(e,t,s){const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),h=n.IsSolModifierAfterCnds(),l=r.Push(a),c=i.GetLoopStack(),u=c.Push();if(u.SetName(e),u.SetEnd(s),s<t)if(h)for(let e=t;e>=s&&!u.IsStopped();--e)i.PushCopySol(o),u.SetIndex(e),yield*a.DebugRetrigger(n,l),i.PopSol(o);else for(let e=t;e>=s&&!u.IsStopped();--e)u.SetIndex(e),yield*a.DebugRetrigger(n,l);else if(h)for(let e=t;e<=s&&!u.IsStopped();++e)i.PushCopySol(o),u.SetIndex(e),yield*a.DebugRetrigger(n,l),i.PopSol(o);else for(let e=t;e<=s&&!u.IsStopped();++e)u.SetIndex(e),yield*a.DebugRetrigger(n,l);return r.Pop(),c.Pop(),!1}_ForEach(e){const t=e.GetCurrentSol(),s=t.GetInstances();if(0===s.length)return!1;const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),h=n.IsSolModifierAfterCnds(),l=r.Push(a),c=i.GetLoopStack(),u=c.Push(),d=e.IsInContainer(),_=FP.Push();if(wP.shallowAssignArray(_,s),u.SetEnd(_.length),h)for(let t=0,s=_.length;t<s&&!u.IsStopped();++t){i.PushCopySol(o);const s=_[t];e.GetCurrentSol().SetSinglePicked(s),d&&s.SetSiblingsSinglePicked(),u.SetIndex(t),a.Retrigger(n,l),i.PopSol(o)}else{t._SetSelectAll(!1);const e=t._GetOwnInstances();wP.clearArray(e),e.push(null);for(let t=0,s=_.length;t<s&&!u.IsStopped();++t){const s=_[t];e[0]=s,d&&s.SetSiblingsSinglePicked(),u.SetIndex(t),a.Retrigger(n,l)}}return r.Pop(),c.Pop(),wP.clearArray(_),FP.Pop(),!1}*_DebugForEach(e){const t=e.GetCurrentSol(),s=t.GetInstances();if(0===s.length)return!1;const i=this._runtime.GetEventSheetManager(),r=i.GetEventStack(),n=r.GetCurrentStackFrame(),a=n.GetCurrentEvent(),o=a.GetSolModifiers(),h=n.IsSolModifierAfterCnds(),l=r.Push(a),c=i.GetLoopStack(),u=c.Push(),d=e.IsInContainer(),_=FP.Push();if(wP.shallowAssignArray(_,s),u.SetEnd(_.length),h)for(let t=0,s=_.length;t<s&&!u.IsStopped();++t){i.PushCopySol(o);const s=_[t];e.GetCurrentSol().SetSinglePicked(s),d&&s.SetSiblingsSinglePicked(),u.SetIndex(t),yield*a.DebugRetrigger(n,l),i.PopSol(o)}else{t._SetSelectAll(!1);const e=t._GetOwnInstances();wP.clearArray(e),e.push(null);for(let t=0,s=_.length;t<s&&!u.IsStopped();++t){const s=_[t];e[0]=s,d&&s.SetSiblingsSinglePicked(),u.SetIndex(t),yield*a.DebugRetrigger(n,l)}}return r.Pop(),c.Pop(),wP.clearArray(_),FP.Pop(),!1}_ForEachOrdered(e,t){const s=e.GetCurrentSol(),i=s.GetInstances();if(0===i.length)return!1;const r=this._runtime.GetEventSheetManager(),n=r.GetEventStack(),a=r.GetCurrentCondition(),o=n.GetCurrentStackFrame(),h=o.GetCurrentEvent(),l=h.GetSolModifiers(),c=o.IsSolModifierAfterCnds(),u=n.Push(h),d=r.GetLoopStack(),_=d.Push(),p=e.IsInContainer(),f=FP.Push();wP.clearArray(f),_.SetEnd(i.length);for(let e=0,t=i.length;e<t;++e)f.push([i[e],a.ReevaluateParameter(1,e)]);if(f.sort(xP),1===t&&f.reverse(),c)for(let t=0,s=f.length;t<s&&!_.IsStopped();++t){r.PushCopySol(l);const s=f[t][0];e.GetCurrentSol().SetSinglePicked(s),p&&s.SetSiblingsSinglePicked(),_.SetIndex(t),h.Retrigger(o,u),r.PopSol(l)}else{s._SetSelectAll(!1);const e=s._GetOwnInstances();wP.clearArray(e),e.push(null);for(let t=0,s=f.length;t<s&&!_.IsStopped();++t){const s=f[t][0];e[0]=s,p&&s.SetSiblingsSinglePicked(),_.SetIndex(t),h.Retrigger(o,u)}}return n.Pop(),d.Pop(),wP.clearArray(f),FP.Pop(),!1}*_DebugForEachOrdered(e,t){const s=e.GetCurrentSol(),i=s.GetInstances();if(0===i.length)return!1;const r=this._runtime.GetEventSheetManager(),n=r.GetEventStack(),a=r.GetCurrentCondition(),o=n.GetCurrentStackFrame(),h=o.GetCurrentEvent(),l=h.GetSolModifiers(),c=o.IsSolModifierAfterCnds(),u=n.Push(h),d=r.GetLoopStack(),_=d.Push(),p=e.IsInContainer(),f=FP.Push();wP.clearArray(f),_.SetEnd(i.length);for(let e=0,t=i.length;e<t;++e)f.push([i[e],a.ReevaluateParameter(1,e)]);if(f.sort(xP),1===t&&f.reverse(),c)for(let t=0,s=f.length;t<s&&!_.IsStopped();++t){r.PushCopySol(l);const s=f[t][0];e.GetCurrentSol().SetSinglePicked(s),p&&s.SetSiblingsSinglePicked(),_.SetIndex(t),yield*h.DebugRetrigger(o,u),r.PopSol(l)}else{s._SetSelectAll(!1);const e=s._GetOwnInstances();wP.clearArray(e),e.push(null);for(let t=0,s=f.length;t<s&&!_.IsStopped();++t){const s=f[t][0];e[0]=s,p&&s.SetSiblingsSinglePicked(),_.SetIndex(t),yield*h.DebugRetrigger(o,u)}}return n.Pop(),d.Pop(),wP.clearArray(f),FP.Pop(),!1}_GetFunctionMap(e,t){let s=this._functionMaps.get(e);return s||(t?(s={defaultFunc:null,strMap:new Map},this._functionMaps.set(e,s),s):null)}_DoCallMappedFunction(e,t,s,i,r){t.GetEventBlock().RunAsMappedFunctionCall(s,t.IsCopyPicked()),i&&e.PopSol(r)}*_DebugDoCallMappedFunction(e,t,s,i,r){yield*t.GetEventBlock().DebugRunAsMappedFunctionCall(s,t.IsCopyPicked()),i&&e.PopSol(r)}}}{const OP=self.C3;OP.Plugins.System.Type=class extends OP.DefendedBase{constructor(e){super(),this._objectClass=e,this._runtime=e.GetRuntime(),this._plugin=e.GetPlugin()}OnCreate(){}Release(){this._objectClass=null,this._runtime=null,this._plugin=null}}}{const BP=self.C3;BP.Plugins.System.Instance=class extends BP.DefendedBase{constructor(e,t){super(),this._inst=e,this._objectClass=this._inst.GetObjectClass(),this._sdkType=this._objectClass.GetSdkType(),this._runtime=this._inst.GetRuntime()}Release(){this._inst=null,this._objectClass=null,this._sdkType=null,this._runtime=null}}}{const kP=self.C3,LP=[];kP.Plugins.System.Cnds={EveryTick:()=>!0,OnLayoutStart:()=>!0,OnLayoutEnd:()=>!0,OnSuspend:()=>!0,OnResume:()=>!0,IsSuspended(){return this._runtime.IsSuspended()},Else(){const e=this._runtime.GetCurrentEventStackFrame();return!e.GetElseBranchRan()&&!e.GetLastEventTrue()},TriggerOnce(){const e=this._runtime.GetCurrentCondition().GetSavedDataMap();let t=e.get("TriggerOnce_lastTick");void 0===t&&(t=-1,e.set("TriggerOnce_lastTick",-1));const s=this._runtime.GetTickCount();return e.set("TriggerOnce_lastTick",s),this._runtime.IsLayoutFirstTick()||t!==s-1},Every(e){const t=this._runtime.GetCurrentCondition().GetSavedDataMap(),s=t.get("Every_lastTime")||0,i=this._runtime.GetGameTime();t.has("Every_seconds")||t.set("Every_seconds",e);const r=t.get("Every_seconds");return i>=s+r?(t.set("Every_lastTime",s+r),i>=t.get("Every_lastTime")+.04&&t.set("Every_lastTime",i),t.set("Every_seconds",e),!0):(i<s-.1&&t.set("Every_lastTime",i),!1)},IsGroupActive(e){const t=this._runtime.GetEventSheetManager().GetEventGroupByName(e);return t&&t.IsGroupActive()},IsPreview(){return this._runtime.IsPreview()},IsMobile:()=>kP.Platform.IsMobile,OnLoadFinished:()=>!0,OnCanvasSnapshot:()=>!0,EffectsSupported:()=>!0,OnSaveComplete:()=>!0,OnSaveFailed:()=>!0,OnLoadComplete:()=>!0,OnLoadFailed:()=>!0,ObjectUIDExists(e){return!!this._runtime.GetInstanceByUID(e)},IsOnPlatform(e){switch(e){case 0:return"browser"===kP.Platform.Context;case 1:return"iOS"===kP.Platform.OS;case 2:return"Android"===kP.Platform.OS;case 8:return"cordova"===kP.Platform.Context;case 9:return"scirra-arcade"===this._runtime.GetExportType();case 13:return"windows-uwp"===this._runtime.GetExportType();default:return!1}},RegexTest(e,t,s){return this.GetRegex(t,s).test(e)},Compare:(e,t,s)=>kP.compare(e,t,s),CompareBetween:(e,t,s)=>e>=t&&e<=s,CompareVar:(e,t,s)=>kP.compare(e.GetValue(),t,s),CompareBoolVar:e=>!!e.GetValue(),CompareTime(e,t){const s=this._runtime.GetGameTime();if(0===e){const e=this._runtime.GetCurrentCondition().GetSavedDataMap();return!e.get("CompareTime_executed")&&s>=t&&(e.set("CompareTime_executed",!0),!0)}return kP.compare(s,e,t)},IsNaN:e=>isNaN(e),AngleWithin:(e,t,s)=>kP.angleDiff(kP.toRadians(e),kP.toRadians(s))<=kP.toRadians(t),IsClockwiseFrom:(e,t)=>kP.angleClockwise(kP.toRadians(e),kP.toRadians(t)),IsBetweenAngles(e,t,s){let i=kP.toRadians(e),r=kP.toRadians(t),n=kP.toRadians(s);return kP.angleClockwise(n,r)?kP.angleClockwise(i,r)&&!kP.angleClockwise(i,n):!(!kP.angleClockwise(i,r)&&kP.angleClockwise(i,n))},IsValueType:(e,t)=>"number"==typeof e?0===t:1===t,EvaluateExpression:e=>!!e,OnSignal(e){return e.toLowerCase()===this._runtime.GetEventSheetManager().GetCurrentSignalTag()},PickByComparison(e,t,s,i){if(!e)return!1;const r=this._GetForEachStack(),n=r.Push(),a=e.GetCurrentSol();kP.shallowAssignArray(n,a.GetInstances()),a.IsSelectAll()&&kP.clearArray(a._GetOwnElseInstances());const o=this._runtime.GetCurrentCondition();let h=0;for(let e=0,r=n.length;e<r;++e){const r=n[e];n[h]=r,t=o.ReevaluateParameter(1,e),i=o.ReevaluateParameter(3,e),kP.compare(t,s,i)?++h:a._PushElseInstance(r)}kP.truncateArray(n,h),a.SetArrayPicked(n);const l=!!n.length;return kP.clearArray(n),r.Pop(),e.ApplySolToContainer(),l},PickByEvaluate(e,t){if(!e)return!1;const s=this._GetForEachStack(),i=s.Push(),r=e.GetCurrentSol();kP.shallowAssignArray(i,r.GetInstances()),r.IsSelectAll()&&kP.clearArray(r._GetOwnElseInstances());const n=this._runtime.GetCurrentCondition();let a=0;for(let e=0,t=i.length;e<t;++e){const t=i[e];i[a]=t,n.ReevaluateParameter(1,e)?++a:r._PushElseInstance(t)}kP.truncateArray(i,a),r.SetArrayPicked(i);const o=!!i.length;return kP.clearArray(i),s.Pop(),e.ApplySolToContainer(),o},PickByHighestLowestValue(e,t,s,i){if(!e)return!1;const r=e.GetCurrentSol(),n=r.GetInstances();if(0===n.length)return!1;const a=this._runtime.GetCurrentCondition(),o=[];let h=0;for(let e=0,r=n.length;e<r;++e){const r=n[e];s=a.ReevaluateParameter(2,e),0===o.length||0===t&&s<h||1===t&&s>h?(h=s,kP.clearArray(o),o.push(r)):i&&s===h&&o.push(r)}return i?r.SetArrayPicked(o):r.PickOne(o[0]),e.ApplySolToContainer(),!0},PickNth(e,t){if(!e)return!1;const s=e.GetCurrentSol(),i=s.GetInstances();if((t=Math.floor(t))>=i.length)return!1;const r=i[t];return s.PickOne(r),e.ApplySolToContainer(),!0},PickRandom(e){if(!e)return!1;const t=e.GetCurrentSol(),s=t.GetInstances(),i=Math.floor(this._runtime.Random()*s.length);if(i>=s.length)return!1;const r=s[i];return t.PickOne(r),e.ApplySolToContainer(),!0},PickAll:e=>!!e&&(!!e.GetInstanceCount()&&(e.GetCurrentSol()._SetSelectAll(!0),e.ApplySolToContainer(),!0)),PickOverlappingPoint(e,t,s){if(!e)return!1;const i=e.GetCurrentSol(),r=i.GetInstances(),n=this._runtime.GetCurrentEvent().IsOrBlock(),a=this._runtime.GetCurrentCondition().IsInverted();i.IsSelectAll()?(kP.shallowAssignArray(LP,r),i.ClearArrays(),i._SetSelectAll(!1)):n?(kP.shallowAssignArray(LP,i._GetOwnElseInstances()),kP.clearArray(i._GetOwnElseInstances())):(kP.shallowAssignArray(LP,i._GetOwnInstances()),kP.clearArray(i._GetOwnInstances()));for(let e=0,r=LP.length;e<r;++e){const r=LP[e];kP.xor(r.GetWorldInfo().ContainsPoint(t,s),a)?i._PushInstance(r):i._PushElseInstance(r)}return e.ApplySolToContainer(),kP.xor(!!i._GetOwnInstances().length,a)},PickLastCreated(e){if(!e)return!1;const t=e.IsFamily();let s=null;const i=this._runtime._GetInstancesPendingCreate();for(let r=i.length-1;r>=0;--r){const n=i[r];if(t){if(n.GetObjectClass().BelongsToFamily(e)){s=n;break}}else if(n.GetObjectClass()===e){s=n;break}}if(!s){const t=e.GetInstances();t.length&&(s=t.at(-1))}return!!s&&(e.GetCurrentSol().PickOne(s),e.ApplySolToContainer(),!0)},Repeat(e){return this._runtime.IsDebugging()?this._DebugRepeat(e):this._Repeat(e)},While(){return this._runtime.IsDebugging()?this._DebugWhile():this._While()},For(e,t,s){return this._runtime.IsDebugging()?this._DebugFor(e,t,s):this._For(e,t,s)},ForEach(e){return this._runtime.IsDebugging()?this._DebugForEach(e):this._ForEach(e)},ForEachOrdered(e,t,s){return this._runtime.IsDebugging()?this._DebugForEachOrdered(e,s):this._ForEachOrdered(e,s)},LayerVisible:e=>!!e&&e.IsVisible(),LayerInteractive:e=>!!e&&e.IsSelfAndParentsInteractive(),LayerIsHTML:e=>!!e&&e.IsHTMLElementsLayer(),LayerEmpty:e=>!!e&&!e.GetInstanceCount(),LayerCmpOpacity:(e,t,s)=>!!e&&kP.compare(100*e.GetOpacity(),t,s),LayerNameExists(e){const t=this._runtime.GetMainRunningLayout();return!!t&&t.HasLayerByName(e)},OnImageLoadingComplete:()=>!0,IsLoadingImages(){return this._imagesLoadingTotal>0},TemplateExists(e,t){const s=this._runtime.GetTemplateManager();return!!s&&!!t&&!!s.GetTemplateData(e,t)}}}{let NP=function(e,t){const s=e[0]-t[0];return 0!==s?s:e[1]-t[1]},WP=function(e,t){return e[1]-t[1]};SortZOrderList=NP,SortInstancesByValue=WP;const UP=self.C3,VP=[],HP=[],jP=UP.New(UP.Rect),zP=UP.New(UP.Color),XP=[];UP.Plugins.System.Acts={SetVar(e,t){e.SetValue(t)},AddVar(e,t){e.IsNumber()&&"number"!=typeof t&&(t=parseFloat(t)),e.SetValue(e.GetValue()+t)},SubVar(e,t){e.IsNumber()&&e.SetValue(e.GetValue()-t)},SetBoolVar(e,t){e.SetValue(!!t)},ToggleBoolVar(e){e.SetValue(!e.GetValue())},ResetEventVar(e){e.SetValue(e.GetInitialValue())},ResetGlobals(e){this._runtime.GetEventSheetManager().ResetAllGlobalsToInitialValue(e)},CreateObject(e,t,s,i,r,n){if(!e||!t)return;const a=this._runtime.CreateInstance(e,t,s,i,r,n);if(!a)return;r&&t.SortAndAddInstancesByZIndex(a);const o=this._runtime.GetEventSheetManager();o.BlockFlushingInstances(!0),a._TriggerOnCreatedOnSelfAndRelated(),o.BlockFlushingInstances(!1);const h=new Map;a.CollectInstancesToPick(h,e,r);for(const[e,t]of h)e.GetCurrentSol().SetSetPicked(t)},CreateObjectByName(e,t,s,i,r,n){if(!e||!t)return;const a=this._runtime.GetObjectClassByName(e);a&&UP.Plugins.System.Acts.CreateObject.call(this,a,t,s,i,r,n)},RecreateInitialObjects(e,t,s,i,r,n,a,o,h,l,c){if(!e)return;const u=this._runtime.GetCurrentLayout();let d=u;if(n){const e=this._runtime.GetLayoutManager().GetLayoutByName(n);if(!e)return;d=e}let _=null;if(("number"!=typeof a||a>=0)&&(_=d.GetLayer(a),!_))return;let p=null;if(("number"!=typeof o||o>=0)&&(p=u.GetLayer(o),!p))return;jP.set(t,s,i,r);const f=d.RecreateInitialObjects(e,jP,_,p,h,l,c);e.GetCurrentSol().SetArrayPicked(f),e.ApplySolToContainer()},StopLoop(){const e=this._loopStack;e.IsInLoop()&&e.GetCurrent().Stop()},SetGroupActive(e,t){const s=this._runtime.GetEventSheetManager().GetEventGroupByName(e);s&&(0===t?s.SetGroupActive(!1):1===t?s.SetGroupActive(!0):s.SetGroupActive(!s.IsGroupActive()))},SetTimescale(e){this._runtime.SetTimeScale(e)},SetObjectTimescale(e,t){if(t<0&&(t=0),!e)return;const s=e.GetCurrentSol().GetInstances();for(const e of s)e.SetTimeScale(t)},RestoreObjectTimescale(e){if(!e)return;const t=e.GetCurrentSol().GetInstances();for(const e of t)e.RestoreTimeScale()},Wait(e,t){if(e<0)return;const s=this._runtime.GetEventSheetManager().AddScheduledWait();return t?s.InitTimer(e):s.InitWallTimer(e),!0},WaitForSignal(e){return this._runtime.GetEventSheetManager().AddScheduledWait().InitSignal(e),!0},WaitForPreviousActions(){const e=this._runtime.GetEventSheetManager();return e.AddScheduledWait().InitPromise(e.GetPromiseForAllAsyncActions()),!0},Signal(e){this._runtime.GetEventSheetManager().Signal(e)},async SnapshotCanvas(e,t,s,i,r,n){const a=this._runtime.GetCanvasManager();a&&(this.UpdateRender(),await a.SnapshotCanvas(0===e?"image/png":"image/jpeg",t/100,s,i,r,n),await this._runtime.TriggerAsync(UP.Plugins.System.Cnds.OnCanvasSnapshot,null))},SetCanvasSize(e,t){if(e<=0||t<=0)return;this._runtime.SetViewportSize(e,t),this._runtime.GetCurrentLayout().BoundScrolling();const s=this._runtime.GetCanvasManager();s&&("off"===s.GetCurrentFullscreenMode()||this._runtime.SetOriginalViewportSize(e,t),s.SetSize(s.GetLastWidth(),s.GetLastHeight(),!0),this._runtime.UpdateRender())},SetFullscreenQuality(e){const t=this._runtime.GetCanvasManager();t&&"off"!==t.GetCurrentFullscreenMode()&&(t.SetFullscreenScalingQuality(0!==e?"high":"low"),t.SetSize(t.GetLastWidth(),t.GetLastHeight(),!0))},SaveState(e){this._runtime.SaveToSlot(e)},SaveStateJSON(){this._runtime.SaveToJsonString()},LoadState(e){this._runtime.LoadFromSlot(e)},LoadStateJSON(e){this._runtime.LoadFromJsonString(e)},SetHalfFramerateMode(e){},ResetPersisted(){for(const e of this._runtime.GetLayoutManager().GetAllLayouts())e.ResetPersistData()},SetPixelRounding(e){this._runtime.SetPixelRoundingEnabled(0!==e)},SetFramerateMinMax(e,t){this._runtime.SetMaxDt(1/e),this._runtime.SetMinDt(1/t)},SetDeltaTimeMinMax(e,t){this._runtime.SetMinDt(e),this._runtime.SetMaxDt(t)},SetFramerateMode(e){this._runtime._SetFramerateMode(["vsync","unlimited-tick","unlimited-frame"][e])},SortZOrderByInstVar(e,t){if(!e)return;const s=e.GetCurrentSol().GetInstances(),i=VP,r=HP,n=this._runtime.GetCurrentLayout(),a=e.IsFamily(),o=e.GetFamilyIndex();for(let e=0,n=s.length;e<n;++e){const n=s[e],h=n.GetWorldInfo();if(!h||h.IsDestroyed())continue;let l;l=a?n.GetInstanceVariableValue(t+n.GetObjectClass().GetFamilyInstanceVariableOffset(o)):n.GetInstanceVariableValue(t),i.push([h.GetLayer().GetIndex(),h.GetZIndex()]),r.push([n,l])}if(!i.length)return;i.sort(NP),r.sort(WP);let h=!1;for(let e=0,t=i.length;e<t;++e){const t=r[e][0],s=n.GetLayerByIndex(i[e][0]),a=i[e][1],o=s._GetInstances();o[a]!==t&&(o[a]=t,t.GetWorldInfo()._SetLayer(s,!0),s.SetZIndicesChanged(t),h=!0)}h&&this._runtime.UpdateRender(),UP.clearArray(VP),UP.clearArray(HP)},SetCollisionCellSize(e,t){e=Math.floor(e),t=Math.floor(t),e<=0||t<=0||!Number.isFinite(e)||!Number.isFinite(t)||this._runtime.GetCollisionEngine().SetCollisionCellSize(e,t)},GoToLayout(e){if(this._runtime.IsLoading())return;const t=this._runtime.GetLayoutManager();t.IsPendingChangeMainLayout()||t.ChangeMainLayout(e)},GoToLayoutByName(e){if(this._runtime.IsLoading())return;const t=this._runtime.GetLayoutManager();if(t.IsPendingChangeMainLayout())return;const s=t.GetLayoutByName(e);s&&t.ChangeMainLayout(s)},NextPrevLayout(e){if(this._runtime.IsLoading())return;const t=this._runtime.GetLayoutManager();if(t.IsPendingChangeMainLayout())return;const s=t.GetAllLayouts(),i=s.indexOf(t.GetMainRunningLayout());if(e&&0===i)return;if(!e&&i===s.length-1)return;const r=s[i+(e?-1:1)];t.ChangeMainLayout(r)},RestartLayout(){if(this._runtime.IsLoading())return;const e=this._runtime.GetLayoutManager();e.IsPendingChangeMainLayout()||(e.ChangeMainLayout(e.GetMainRunningLayout()),this._runtime.GetEventSheetManager().ResetAllGroupsInitialActivation())},SetLayerVisible(e,t){e&&e.SetVisible(t)},SetLayerInteractive(e,t){e&&e.SetInteractive(t)},SetLayerHTML(e,t){e&&e.SetIsHTMLElementsLayer(t)},SetLayerOpacity(e,t){e&&e.SetOpacity(t/100)},SetLayerScale(e,t){e&&e.SetOwnScale(t)},SetLayerScaleRate(e,t){e&&e.SetScaleRate(t)},SetLayerAngle(e,t){e&&e.SetAngle(UP.toRadians(+t))},SetLayerScroll(e,t,s){e&&(e.SetOwnScrollPositionEnabled(!0),e.SetScrollX(t),e.SetScrollY(s))},RestoreLayerScroll(e){e&&e.SetOwnScrollPositionEnabled(!1)},SetLayerParallax(e,t,s){e&&e.SetParallax(t/100,s/100)},SetLayerZElevation(e,t){e&&e.SetZElevation(+t)},SetLayerRenderingMode(e,t){e&&e.SetRenderAs3D(1===t)},SetLayerBackground(e,t){if(!e)return;zP.setFromRgbValue(t),zP.clamp();const s=e.GetBackgroundColor();s.equalsIgnoringAlpha(zP)||(s.copyRgb(zP),this.UpdateRender())},SetLayerTransparent(e,t){e&&e.SetTransparent(t)},SetLayerBlendMode(e,t){e&&e.SetBlendMode(t)},SetLayerEffectEnabled(e,t,s){if(!e)return;const i=e.GetEffectList().GetEffectTypeByName(s);if(!i)return;const r=1===t;i.IsActive()!==r&&(i.SetActive(r),e.UpdateActiveEffects(),this._runtime.UpdateRender())},SetLayerEffectParam(e,t,s,i){if(!e)return;const r=e.GetEffectList(),n=r.GetEffectTypeByName(t);if(!n)return;s=Math.floor(s);const a=n.GetShaderProgram().GetParameterType(s);a&&("color"===a?(zP.setFromRgbValue(i),i=zP):"percent"===a&&(i/=100),r.SetEffectParameter(n.GetIndex(),s,i)&&n.IsActive()&&this._runtime.UpdateRender())},SetLayerForceOwnTexture(e,t){e&&e.SetForceOwnTexture(t)},SetLayoutScale(e){this._runtime.GetCurrentLayout().SetScale(+e)},SetLayoutAngle(e){this._runtime.GetCurrentLayout().SetAngle(UP.toRadians(+e))},SetLayoutEffectEnabled(e,t){const s=this._runtime.GetCurrentLayout(),i=s.GetEffectList().GetEffectTypeByName(t);if(!i)return;const r=1===e;i.IsActive()!==r&&(i.SetActive(r),s.UpdateActiveEffects(),this._runtime.UpdateRender())},SetLayoutEffectParam(e,t,s){const i=this._runtime.GetCurrentLayout().GetEffectList(),r=i.GetEffectTypeByName(e);if(!r)return;t=Math.floor(t);const n=r.GetShaderProgram().GetParameterType(t);n&&("color"===n?(zP.setFromRgbValue(s),s=zP):"percent"===n&&(s/=100),i.SetEffectParameter(r.GetIndex(),t,s)&&r.IsActive()&&this._runtime.UpdateRender())},SetLayoutVanishingPoint(e,t){this._runtime.GetCurrentLayout().SetVanishingPointXY(e/100,t/100)},SetLayoutProjection(e){const t=this._runtime.GetCurrentLayout();0===e?t.SetPerspectiveProjection():t.SetOrthographicProjection()},ScrollX(e){this._runtime.GetCurrentLayout().SetScrollX(e)},ScrollY(e){this._runtime.GetCurrentLayout().SetScrollY(e)},Scroll(e,t){const s=this._runtime.GetCurrentLayout();s.SetScrollX(e),s.SetScrollY(t)},ScrollToObject(e){if(!e)return;const t=e.GetFirstPicked();if(!t)return;const s=t.GetWorldInfo();if(!s)return;const i=this._runtime.GetCurrentLayout();i.SetScrollX(s.GetX()),i.SetScrollY(s.GetY())},AddLayer(e,t,s){const i=this._runtime.GetCurrentLayout();try{i.AddLayer(e,t,s)}catch(e){console.warn("[Construct] Cannot add layer: ",e)}},MoveLayer(e,t,s){if(!e)return;const i=this._runtime.GetCurrentLayout();try{i.MoveLayer(e,t,s)}catch(e){console.warn("[Construct] Cannot move layer: ",e)}},RemoveLayer(e){e&&this._runtime.GetCurrentLayout().RemoveLayer(e)},RemoveAllDynamicLayers(){this._runtime.GetCurrentLayout().RemoveAllDynamicLayers()},async LoadObjectTextures(e){const t=this._runtime.GetMainRunningLayout();if(!t||!e||this._runtime.IsLoading())return;const s=e.IsFamily()?e.GetFamilyMembers():[e];await this._LoadTexturesForObjectClasses(t,s)},async LoadObjectTexturesByName(e){await UP.Plugins.System.Acts.LoadObjectTextures.call(this,this._runtime.GetObjectClassByName(e))},UnloadObjectTextures(e){const t=this._runtime.GetMainRunningLayout();if(!t||!e)return;const s=e.IsFamily()?e.GetFamilyMembers():[e];this._UnloadTexturesForObjectClasses(t,s)},UnloadObjectTexturesByName(e){UP.Plugins.System.Acts.UnloadObjectTextures.call(this,this._runtime.GetObjectClassByName(e))},UnloadUnusedTextures(){const e=this._runtime.GetMainRunningLayout();if(!e)return;const t=e._GetTextureLoadedObjectTypes();this._UnloadTexturesForObjectClasses(e,t)},async LoadLayoutTextures(e){const t=this._runtime.GetMainRunningLayout();e&&t&&!this._runtime.IsLoading()&&await this._LoadTexturesForObjectClasses(t,e._GetInitialObjectClasses())},async LoadLayoutTexturesByName(e){const t=this._runtime.GetMainRunningLayout(),s=this._runtime.GetLayoutManager().GetLayoutByName(e);s&&t&&!this._runtime.IsLoading()&&await this._LoadTexturesForObjectClasses(t,s._GetInitialObjectClasses())},SetFunctionReturnValue(e){const t=this._eventStack.GetCurrentExpFuncStackFrame();if(t)switch(t.GetFunctionReturnType()){case 1:"number"==typeof e&&t.SetFunctionReturnValue(e);break;case 2:"string"==typeof e&&t.SetFunctionReturnValue(e);break;case 3:t.SetFunctionReturnValue(e)}},MapFunction(e,t,s){const i=this._GetFunctionMap(e.toLowerCase(),!0),r=i.strMap,n=t.toLowerCase();r.has(n)&&console.warn(`[Construct] Function map '${e}' string '${t}' already in map; overwriting entry`);const a=UP.first(r.values())||i.defaultFunc;a&&0!==a.GetReturnType()!=(0!==s.GetReturnType())?console.error(`[Construct] Function map '${e}' string '${t}' function return type not compatible with other functions in the map; entry ignored`):r.set(n,s)},MapFunctionDefault(e,t){const s=this._GetFunctionMap(e.toLowerCase(),!0);s.defaultFunc&&console.warn(`[Construct] Function map '${e}' already has a default; overwriting entry`);const i=UP.first(s.strMap.values())||s.defaultFunc;i&&0!==i.GetReturnType()!=(0!==t.GetReturnType())?console.error(`[Construct] Function map '${e}' default: function return type not compatible with other functions in the map; entry ignored`):s.defaultFunc=t},CallMappedFunction(e,t,s){const i=this._runtime,r=i.IsDebugging()?XP:null;s=Math.floor(s);const n=this._GetFunctionMap(e.toLowerCase(),!1);if(!n)return console.warn(`[Construct] Call mapped function: map name '${e}' not found; call ignored`),r;let a=n.strMap.get(t.toLowerCase());if(!a){if(!n.defaultFunc)return console.warn(`[Construct] Call mapped function: no function associated with map '${e}' string '${t}'; call ignored (consider setting a default)`),r;a=n.defaultFunc,s=0}if(!a.IsEnabled())return r;if(0!==a.GetReturnType())return console.warn(`[Construct] Call mapped function: map '${e}' string '${t}' has a return type so cannot be called`),r;const o=i.GetEventSheetManager(),h=o.GetCurrentEvent(),l=h.GetSolModifiersIncludingParents(),c=l.length>0;c&&(a.IsCopyPicked()?o.PushCopySol(l):o.PushCleanSol(l));const u=[],d=o.FindFirstFunctionBlockParent(h);if(d){const e=d.GetFunctionParameters();for(let t=s,i=e.length;t<i;++t)u.push(e[t].GetValue())}const _=a.GetFunctionParameters();for(let e=u.length,t=_.length;e<t;++e)u.push(_[e].GetInitialValue());return i.IsDebugging()?this._DebugDoCallMappedFunction(o,a,u,c,l):this._DoCallMappedFunction(o,a,u,c,l)}}}{const YP=self.C3,qP=YP.New(YP.Color);YP.Plugins.System.Exps={int:function(e){return"string"==typeof e&&(e=parseInt(e,10),isNaN(e)&&(e=0)),Math.floor(e)},float:function(e){return"string"==typeof e&&(e=parseFloat(e),isNaN(e)&&(e=0)),e},str:e=>e.toString(),len:e=>"string"==typeof e?e.length:0,random(e,t){return void 0===t?this._runtime.Random()*e:this._runtime.Random()*(t-e)+e},choose(...e){return e[Math.floor(this._runtime.Random()*e.length)]},chooseindex:(e,...t)=>("number"!=typeof e&&(e=0),t[e=YP.clamp(Math.floor(e),0,t.length-1)]),pi:()=>Math.PI,infinity:()=>1/0,sqrt:e=>Math.sqrt(e),abs:e=>Math.abs(e),round:e=>Math.round(e),roundtodp(e,t){t=Math.max(Math.floor(t),0);const s=Math.pow(10,t);return Math.round((e+Number.EPSILON)*s)/s},floor:e=>Math.floor(e),ceil:e=>Math.ceil(e),sign:e=>Math.sign(e),sin:e=>Math.sin(YP.toRadians(e)),cos:e=>Math.cos(YP.toRadians(e)),tan:e=>Math.tan(YP.toRadians(e)),asin:e=>YP.toDegrees(Math.asin(e)),acos:e=>YP.toDegrees(Math.acos(e)),atan:e=>YP.toDegrees(Math.atan(e)),exp:e=>Math.exp(e),ln:e=>Math.log(e),log10:e=>Math.log10(e),max(...e){let t=e[0];"number"!=typeof t&&(t=0);for(let s=1,i=e.length;s<i;++s){let i=e[s];"number"==typeof i&&t<i&&(t=i)}return t},min(...e){let t=e[0];"number"!=typeof t&&(t=0);for(let s=1,i=e.length;s<i;++s){let i=e[s];"number"==typeof i&&t>i&&(t=i)}return t},clamp:(e,t,s)=>YP.clamp(e,t,s),distance:(e,t,s,i)=>YP.distanceTo(e,t,s,i),angle:(e,t,s,i)=>YP.toDegrees(YP.angleTo(e,t,s,i)),lerp:(e,t,s)=>YP.lerp(e,t,s),unlerp:(e,t,s)=>YP.unlerp(e,t,s),qarp:(e,t,s,i)=>YP.qarp(e,t,s,i),cubic:(e,t,s,i,r)=>YP.cubic(e,t,s,i,r),cosp:(e,t,s)=>YP.cosp(e,t,s),anglediff:(e,t)=>YP.toDegrees(YP.angleDiff(YP.toRadians(e),YP.toRadians(t))),anglelerp:(e,t,s)=>YP.toDegrees(YP.angleLerp(YP.toRadians(e),YP.toRadians(t),s)),anglerotate:(e,t,s)=>YP.toDegrees(YP.angleRotate(YP.toRadians(e),YP.toRadians(t),YP.toRadians(s))),setbit:(e,t,s)=>(e|=0)&~(1<<(t|=0))|(s=0!==s?1:0)<<t,togglebit:(e,t)=>(e|=0)^1<<t,getbit:(e,t)=>(e|=0)&1<<(t|=0)?1:0,newline:()=>"\n",uppercase:e=>"string"==typeof e?e.toUpperCase():"",lowercase:e=>"string"==typeof e?e.toLowerCase():"",left:(e,t)=>"string"==typeof e?e.substr(0,t):"",mid:(e,t,s)=>"string"!=typeof e?"":s<0?e.substr(t):e.substr(t,s),right:(e,t)=>"string"==typeof e?e.substr(Math.max(e.length-t,0)):"",trim:e=>"string"==typeof e?e.trim():"",tokenat(e,t,s){if("string"!=typeof e||"string"!=typeof s)return"";let i=e.split(s);return(t=Math.floor(t))<0||t>=i.length?"":i[t]},tokencount:(e,t)=>"string"==typeof e&&"string"==typeof t&&e.length?e.split(t).length:0,find:(e,t)=>"string"==typeof e&&"string"==typeof t?e.search(new RegExp(YP.EscapeRegex(t),"i")):-1,findcase:(e,t)=>"string"==typeof e&&"string"==typeof t?e.search(new RegExp(YP.EscapeRegex(t),"")):-1,replace:(e,t,s)=>"string"==typeof e&&"string"==typeof t&&"string"==typeof s?e.replace(new RegExp(YP.EscapeRegex(t),"gi"),s):"string"==typeof e?e:"",stringsub(e,...t){let s=e;for(let e=0,i=t.length;e<i;++e)s=s.replaceAll(`{${e}}`,t[e].toString());return s},regexsearch(e,t,s){const i=this.GetRegex(t,s);return e?e.search(i):-1},regexreplace(e,t,s,i){const r=this.GetRegex(t,s);return e?e.replace(r,i):""},regexmatchcount(e,t,s){const i=this.GetRegexMatches(e.toString(),t,s);return i?i.length:0},regexmatchat(e,t,s,i){i=Math.floor(i);const r=this.GetRegexMatches(e.toString(),t,s);return!r||i<0||i>=r.length?"":r[i]},zeropad(e,t){let s=e<0?"-":"";e<0&&(e=-e);const i=t-e.toString().length;return s+="0".repeat(Math.max(i,0)),s+e.toString()},urlencode:e=>encodeURIComponent(e),urldecode:e=>decodeURIComponent(e),dt(){return this._runtime._GetDtFast()},wallclockdt(){return this._runtime.GetDt1()},timescale(){return this._runtime.GetTimeScale()},wallclocktime(){return(Date.now()-this._runtime.GetStartTime())/1e3},unixtime:()=>Date.now(),time(){return this._runtime.GetGameTime()},tickcount(){return this._runtime.GetTickCount()},objectcount(){return this._runtime.GetObjectCount()},fps(){return this._runtime.GetFramesPerSecond()},cpuutilisation(){return this._runtime.GetMainThreadTime()},gpuutilisation(){return this._runtime.GetGPUUtilisation()},windowwidth(){return this._runtime.GetCanvasManager().GetDeviceWidth()},windowheight(){return this._runtime.GetCanvasManager().GetDeviceHeight()},originalwindowwidth(){return this._runtime.GetOriginalViewportWidth()},originalwindowheight(){return this._runtime.GetOriginalViewportHeight()},originalviewportwidth(){return this._runtime.GetOriginalViewportWidth()},originalviewportheight(){return this._runtime.GetOriginalViewportHeight()},scrollx(){return this._runtime.GetCurrentLayout().GetScrollX()},scrolly(){return this._runtime.GetCurrentLayout().GetScrollY()},layoutname(){return this._runtime.GetCurrentLayout().GetName()},layoutscale(){return this._runtime.GetCurrentLayout().GetScale()},layoutangle(){return YP.toDegrees(this._runtime.GetCurrentLayout().GetAngle())},layoutwidth(){return this._runtime.GetCurrentLayout().GetWidth()},layoutheight(){return this._runtime.GetCurrentLayout().GetHeight()},vanishingpointx(){return 100*this._runtime.GetCurrentLayout().GetVanishingPointX()},vanishingpointy(){return 100*this._runtime.GetCurrentLayout().GetVanishingPointY()},viewportleft(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().getLeft():0},viewporttop(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().getTop():0},viewportright(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().getRight():0},viewportbottom(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().getBottom():0},viewportwidth(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().width():0},viewportheight(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetViewport3D().height():0},viewportmidx(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);if(t){const e=t.GetViewport3D();return(e.getLeft()+e.getRight())/2}return 0},viewportmidy(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);if(t){const e=t.GetViewport3D();return(e.getTop()+e.getBottom())/2}return 0},canvastolayerx(e,t,s){const i=this._runtime.GetCurrentLayout().GetLayer(e);return i?i.CanvasCssToLayer(t,s)[0]:0},canvastolayery(e,t,s){const i=this._runtime.GetCurrentLayout().GetLayer(e);return i?i.CanvasCssToLayer(t,s)[1]:0},layertocanvasx(e,t,s){const i=this._runtime.GetCurrentLayout().GetLayer(e);return i?i.LayerToCanvasCss(t,s)[0]:0},layertocanvasy(e,t,s){const i=this._runtime.GetCurrentLayout().GetLayer(e);return i?i.LayerToCanvasCss(t,s)[1]:0},layertolayerx(e,t,s,i){const r=this._runtime.GetCurrentLayout(),n=r.GetLayer(e),a=r.GetLayer(t);if(!n||!a||n===a)return s;const[o,h]=n.LayerToCanvasCss(s,i);return a.CanvasCssToLayer(o,h)[0]},layertolayery(e,t,s,i){const r=this._runtime.GetCurrentLayout(),n=r.GetLayer(e),a=r.GetLayer(t);if(!n||!a||n===a)return i;const[o,h]=n.LayerToCanvasCss(s,i);return a.CanvasCssToLayer(o,h)[1]},layerscale(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetOwnScale():0},layerangle(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?YP.toDegrees(t.GetOwnAngle()):0},layeropacity(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?100*t.GetOpacity():0},layerscalerate(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetScaleRate():0},layerscrollx(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetScrollX():0},layerscrolly(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetScrollY():0},layerparallaxx(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?100*t.GetParallaxX():0},layerparallaxy(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?100*t.GetParallaxY():0},layerzelevation(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetZElevation():0},layerindex(e){const t=this._runtime.GetCurrentLayout().GetLayer(e);return t?t.GetIndex():-1},canvassnapshot(){const e=this._runtime.GetCanvasManager();return e?e.GetCanvasSnapshotUrl():""},loopindex(e){const t=this._loopStack;if(!t.IsInLoop())return 0;if(e){const s=t.FindByName(e);return s?s.GetIndex():0}return t.GetCurrent().GetIndex()},savestatejson(){return this._runtime.GetLastSaveJsonString()},callmapped(e,t,...s){const i=this._GetFunctionMap(e.toLowerCase(),!1);if(!i)return console.warn(`[Construct] Call mapped function: map name '${e}' not found; returning 0`),0;let r=i.strMap.get(t.toLowerCase());if(!r){if(!i.defaultFunc)return console.warn(`[Construct] Call mapped function: no function associated with map '${e}' string '${t}'; returning 0 (consider setting a default)`),0;r=i.defaultFunc}const n=r.GetReturnType(),a=r.GetDefaultReturnValue();if(0===n)return console.warn(`[Construct] Call mapped function: map '${e}' string '${t}' has no return type so cannot be called from an expression; returning 0`),0;if(!r.IsEnabled())return a;const o=this._runtime.GetEventSheetManager(),h=o.GetCurrentEvent().GetSolModifiersIncludingParents(),l=h.length>0;l&&(r.IsCopyPicked()?o.PushCopySol(h):o.PushCleanSol(h));const c=r.GetFunctionParameters();for(let e=s.length,t=c.length;e<t;++e)s.push(c[e].GetInitialValue());const u=r.GetEventBlock(),d=u.RunAsExpressionOrJSFunctionCall(u.GetSolModifiersIncludingParents(),r.IsCopyPicked(),n,a,null,...s);return l&&o.PopSol(h),d},loadingprogress(){return this._runtime.GetAssetManager().GetLoadProgress()},imageloadingprogress(){return this.GetImageLoadingProgress()},renderer(){return this._runtime.GetWebGPURenderer()?"webgpu":"webgl"},rendererdetail(){return this._runtime.GetWebGPURenderer()?this._runtime.GetWebGPURenderer().GetAdapterInfoString():this._runtime.GetWebGLRenderer().GetUnmaskedRenderer()},imagememoryusage(){let e=this._runtime.GetRenderer().GetEstimatedTextureMemoryUsage();return Math.round(100*e/1048576)/100},rgb:(e,t,s)=>YP.PackRGB(e,t,s),rgbex:(e,t,s)=>YP.PackRGBEx(e/100,t/100,s/100),rgba:(e,t,s,i)=>YP.PackRGBAEx(e/100,t/100,s/100,i/100),rgbex255:(e,t,s)=>YP.PackRGBEx(e/255,t/255,s/255),rgba255:(e,t,s,i)=>YP.PackRGBAEx(e/255,t/255,s/255,i/255),hexcolor:e=>(qP.setRgba(0,0,0,1),qP.parseHexString(e),YP.PackRGBAEx(qP.getR(),qP.getG(),qP.getB(),qP.getA())),colortohexstring:e=>(qP.setFromRgbValue(e),qP.toHexString(1!==qP.getA())),projectname(){return this._runtime.GetProjectName()},projectversion(){return this._runtime.GetProjectVersion()},projectid(){return this._runtime.GetAppId()},projectuniqueid(){return this._runtime.GetProjectUniqueId()},currenteventsheetname(){return this._runtime.GetCurrentEvent().GetEventSheet().GetName()},currenteventnumber(){return this._runtime.GetCurrentEvent().GetDisplayNumber()},projectfilecount(){return this._runtime.GetAssetManager().GetExportedFileList().length},projectfilenameat(e){e=Math.floor(e);const t=this._runtime.GetAssetManager().GetExportedFileList();return e<0||e>=t.length?"":t[e].name}}}{const KP=self.C3,$P=[];KP.Plugins.Audio=class extends KP.SDKPluginBase{constructor(e){super(e)}_AddActionPromise(e){$P.push(e)}static async WaitForAllActionPromises(){await Promise.all($P),KP.clearArray($P)}Release(){super.Release()}}}{let JP=function(){return tR.GetSingleGlobalInstance().GetSdkInstance()},ZP=function(){if(self.C3Audio_DOMInterface)return self.C3Audio_DOMInterface;throw new Error("audio scripting API cannot be used here - make sure the project is using DOM mode, not worker mode")};GetAudioSdkInstance=JP,GetAudioDOMInterface=ZP;const QP=self.C3,eR=self.C3X;QP.Plugins.Audio.Type=class extends QP.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}GetScriptInterfaceClass(){return self.IAudioObjectType}};let tR=null;self.IAudioObjectType=class extends self.IObjectType{constructor(e){super(e),tR=e}get audioContext(){return ZP().GetAudioContextExtern()}get destinationNode(){return ZP().GetDestinationNodeExtern()}get isSilent(){return JP()._IsSilent()}set isSilent(e){JP()._SetSilent(e)}get masterVolume(){return JP()._GetMasterVolume()}set masterVolume(e){eR.RequireFiniteNumber(e),JP()._SetMasterVolume(e)}stopAll(){JP()._StopAll()}}}{const sR=self.C3,iR="audio",rR=["interactive","balanced","playback"];sR.Plugins.Audio.Instance=class extends sR.SDKInstanceBase{constructor(e,t){super(e,iR),this._nextPlayTime=0,this._nextPlayOffset=0,this._triggerTags=[],this._enableMultiTags=!0,this._timeScaleMode=0,this._saveLoadMode=0,this._playInBackground=!1,this._panningModel=1,this._distanceModel=1,this._listenerPos=[this._runtime.GetViewportWidth()/2,this._runtime.GetViewportHeight()/2,600],this._listenerForwardVec=[0,0,-1],this._listenerUpVec=[0,1,0],this._referenceDistance=600,this._maxDistance=1e4,this._rolloffFactor=1,this._listenerInst=null,this._loadListenerUid=-1,this._masterVolume=1,this._isSilent=!1,this._sampleRate=0,this._audioContextState="suspended",this._outputLatency=0,this._effectCount=new Map,this._preloadTotal=0,this._preloadCount=0,this._bufferMetadata=new Map,this._remoteUrls=new Map;let s="interactive";t&&(this._timeScaleMode=t[0],this._saveLoadMode=t[1],this._playInBackground=t[2],s=rR[t[3]],this._enableMultiTags=t[4],this._panningModel=t[5],this._distanceModel=t[6],this._listenerPos[2]=t[7],this._referenceDistance=t[8],this._maxDistance=t[9],this._rolloffFactor=t[10]),this._lastAIState=[],this._lastFxState=[],this._lastAnalysersData=[],this.AddDOMMessageHandlers([["state",e=>this._OnUpdateState(e)],["audiocontext-state",e=>this._OnAudioContextStateChanged(e)],["fxstate",e=>this._OnUpdateFxState(e)],["trigger",e=>this._OnTrigger(e)],["buffer-metadata",e=>this._OnBufferMetadata(e)]]);const i=this.GetRuntime().Dispatcher();this._disposables=new sR.CompositeDisposable(sR.Disposable.From(i,"instancedestroy",e=>this._OnInstanceDestroyed(e.instance)),sR.Disposable.From(i,"afterload",()=>this._OnAfterLoad()),sR.Disposable.From(i,"suspend",()=>this._OnSuspend()),sR.Disposable.From(i,"resume",()=>this._OnResume()));const r=this._runtime.GetExportType(),n="Safari"===sR.Platform.Browser,a=this._runtime.IsiOSWebView()||"macos-wkwebview"===r,o="playable-ad-single-file"===r,h="cordova"===r&&"Android"===sR.Platform.OS,l=n||a||o||h;this._runtime.AddLoadPromise(this.PostToDOMAsync("create-audio-context",{preloadList:this._runtime.GetAssetManager().GetAudioToPreload().map(e=>({originalUrl:e.originalUrl,url:e.url,type:e.type,fileSize:e.fileSize})),timeScaleMode:this._timeScaleMode,latencyHint:s,panningModel:this._panningModel,distanceModel:this._distanceModel,refDistance:this._referenceDistance,maxDistance:this._maxDistance,rolloffFactor:this._rolloffFactor,listenerPos:this._listenerPos,usePlayMusicAsSoundWorkaround:l}).then(e=>{this._sampleRate=e.sampleRate,this._audioContextState=e.audioContextState,this._outputLatency=e.outputLatency})),this._StartTicking()}Release(){this._listenerInst=null,super.Release()}_SplitTags(e){return this._enableMultiTags?e.split(" ").filter(e=>!!e):e?[e]:[]}_MatchTagLists(e,t){for(const s of t){let t=!1;for(const i of e)if(sR.equalsNoCase(i,s)){t=!0;break}if(!t)return!1}return!0}_MatchTagListToStr(e,t){return this._MatchTagLists(e,this._SplitTags(t))}_AddActionPromise(e){this.GetPlugin()._AddActionPromise(e)}_OnInstanceDestroyed(e){this._listenerInst===e&&(this._listenerInst=null)}DbToLinearNoCap(e){return Math.pow(10,e/20)}DbToLinear(e){const t=this.DbToLinearNoCap(e);return isFinite(t)?Math.max(Math.min(t,1),0):0}LinearToDbNoCap(e){return Math.log(e)/Math.log(10)*20}LinearToDb(e){return this.LinearToDbNoCap(Math.max(Math.min(e,1),0))}_GetScheduledPlayInfo(){let e=0;const t=!!self.C3_GetAudioContextCurrentTime;return e=t?this._nextPlayTime:this._nextPlayOffset,this._nextPlayTime=0,this._nextPlayOffset=0,{playOffset:e,isTrueClock:t}}_OnSuspend(){this._playInBackground||this.PostToDOM("set-suspended",{isSuspended:!0})}_OnResume(){this._playInBackground||this.PostToDOM("set-suspended",{isSuspended:!1})}_OnUpdateState(e){const t=e.tickCount;this._outputLatency=e.outputLatency;const s=this._lastAIState.filter(e=>e.hasOwnProperty("placeholder")&&(e.placeholder>t||-1===e.placeholder));this._lastAIState=e.audioInstances,this._lastAnalysersData=e.analysers,s.length>0&&sR.appendArray(this._lastAIState,s)}_OnBufferMetadata(e){this._bufferMetadata.set(e.originalUrl,{duration:e.duration})}_OnAudioContextStateChanged(e){this._audioContextState=e.audioContextState}GetAudioContextState(){return this._runtime.IsExportToVideo()?"running":this._audioContextState}_OnUpdateFxState(e){this._lastFxState=e.fxstate}_GetFirstAudioStateByTags(e){const t=this._SplitTags(e);for(const e of this._lastAIState)if(this._MatchTagLists(e.tags,t))return e;return null}_IsTagPlaying(e){const t=this._SplitTags(e);return this._lastAIState.some(e=>this._MatchTagLists(e.tags,t)&&e.isPlaying)}_MaybeMarkAsPlaying(e,t,s,i,r){if(this._IsTagPlaying(t))return null;const n=this._bufferMetadata.get(e),a={tags:this._SplitTags(t),duration:n?n.duration:0,volume:r,isPlaying:!0,playbackTime:0,playbackRate:1,uid:-1,bufferOriginalUrl:e,bufferUrl:"",bufferType:"",isMusic:s,isLooping:i,isMuted:!1,resumePosition:0,pan:null,placeholder:-1};return this._lastAIState.push(a),a}_MaybeMarkAsStopped(e){const t=this._SplitTags(e);for(const e of this._lastAIState)this._MatchTagLists(e.tags,t)&&(e.isPlaying=!1)}async _OnTrigger(e){const t=e.type;this._triggerTags=e.tags;const s=e.aiid;if("ended"===t){for(const e of this._lastAIState)if(e.aiid===s){e.isPlaying=!1;break}await this.TriggerAsync(sR.Plugins.Audio.Cnds.OnEnded)}else"fade-ended"===t&&await this.TriggerAsync(sR.Plugins.Audio.Cnds.OnFadeEnded)}_MatchTriggerTag(e){return this._MatchTagListToStr(this._triggerTags,e)}Tick(){const e={timeScale:this._runtime.GetTimeScale(),gameTime:this._runtime.GetGameTimeRaw(),instPans:this.GetInstancePans(),tickCount:this._runtime.GetTickCountNoSave()};if(this._listenerInst){const t=this._listenerInst.GetWorldInfo();this._listenerPos[0]=t.GetX(),this._listenerPos[1]=t.GetY(),e.listenerPos=this._listenerPos,e.listenerOrientation=[...this._listenerForwardVec,...this._listenerUpVec]}this.PostToDOM("tick",e)}rotatePtAround(e,t,s,i,r){if(0===s)return[e,t];const n=Math.sin(s),a=Math.cos(s),o=(e-=i)*n;return e=e*a-(t-=r)*n,t=t*a+o,[e+=i,t+=r]}GetInstancePans(){return this._lastAIState.filter(e=>-1!==e.uid).map(e=>this._runtime.GetInstanceByUID(e.uid)).filter(e=>e).map(e=>{const t=e.GetWorldInfo(),s=t.GetLayer().GetAngle(),[i,r]=this.rotatePtAround(t.GetX(),t.GetY(),-s,this._listenerPos[0],this._listenerPos[1]);return{uid:e.GetUID(),x:i,y:r,z:t.GetTotalZElevation(),angle:t.GetAngle()-s}})}GetAnalyserData(e,t){for(const s of this._lastAnalysersData)if(s.index===t&&sR.equalsNoCase(s.tag,e))return s;return null}_IncrementEffectCount(e){for(const t of this._SplitTags(e)){const e=t.toLowerCase();this._effectCount.set(e,(this._effectCount.get(e)||0)+1)}}_IsSilent(){return this._isSilent}_SetSilent(e){e=!!e,this._isSilent!==e&&(this._isSilent=e,this.PostToDOM("set-silent",{isSilent:e}))}_GetMasterVolume(){return this._masterVolume}_SetMasterVolume(e){this._masterVolume!==e&&(this._masterVolume=e,this.PostToDOM("set-master-volume",{vol:e}))}_StopAll(){this.PostToDOM("stop-all");for(const e of this._lastAIState)e.isPlaying=!1}_ShouldSave(e){return!(e.hasOwnProperty("placeholder")||3===this._saveLoadMode||e.isMusic&&1===this._saveLoadMode||!e.isMusic&&2===this._saveLoadMode)}SaveToJson(){return{isSilent:this._isSilent,masterVolume:this._masterVolume,listenerZ:this._listenerPos[2],listenerForwardVec:this._listenerForwardVec,listenerUpVec:this._listenerUpVec,listenerUid:this._listenerInst?this._listenerInst.GetUID():-1,remoteUrls:[...this._remoteUrls.entries()],playing:this._lastAIState.filter(e=>this._ShouldSave(e)),effects:this._lastFxState,analysers:this._lastAnalysersData}}LoadFromJson(e){if(this._isSilent=e.isSilent,this._masterVolume=e.masterVolume,this._listenerPos[2]=e.listenerZ,this._listenerInst=null,this._loadListenerUid=e.listenerUid,e.hasOwnProperty("listenerForwardVec")?this._listenerForwardVec=e.listenerForwardVec:this._listenerForwardVec=[0,0,-1],e.hasOwnProperty("listenerUpVec")?this._listenerUpVec=e.listenerUpVec:this._listenerUpVec=[0,1,0],this._remoteUrls.clear(),e.remoteUrls)for(const[t,s]of e.remoteUrls)this._remoteUrls.set(t,s);this._lastAIState=e.playing;for(const e of this._lastAIState)e.hasOwnProperty("tag")&&!e.hasOwnProperty("tags")&&(e.tags=[e.tag].filter(e=>!!e));this._lastFxState=e.effects,this._lastAnalysersData=e.analysers}_OnAfterLoad(){if(-1!==this._loadListenerUid&&(this._listenerInst=this._runtime.GetInstanceByUID(this._loadListenerUid),this._loadListenerUid=-1,this._listenerInst)){const e=this._listenerInst.GetWorldInfo();this._listenerPos[0]=e.GetX(),this._listenerPos[1]=e.GetY()}for(const e of this._lastAIState){const t=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e.bufferOriginalUrl);t?(e.bufferUrl=t.url,e.bufferType=t.type):e.bufferUrl=null}for(const e of Object.values(this._lastFxState))for(const t of e)if(t.hasOwnProperty("bufferOriginalUrl")){const e=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t.bufferOriginalUrl);e&&(t.bufferUrl=e.url,t.bufferType=e.type)}this.PostToDOM("load-state",{saveLoadMode:this._saveLoadMode,timeScale:this._runtime.GetTimeScale(),gameTime:this._runtime.GetGameTimeRaw(),listenerPos:this._listenerPos,listenerOrientation:[...this._listenerForwardVec,...this._listenerUpVec],isSilent:this._isSilent,masterVolume:this._masterVolume,playing:this._lastAIState.filter(e=>null!==e.bufferUrl),effects:this._lastFxState})}GetDebuggerProperties(){const e=[];for(const[t,s]of Object.entries(this._lastFxState))e.push({name:"$"+t,value:s.map(e=>e.type).join(", ")});const t="plugins.audio.debugger";return[{title:t+".tag-effects",properties:e},{title:t+".currently-playing",properties:[{name:t+".currently-playing-count",value:this._lastAIState.length},...this._lastAIState.map((e,t)=>({name:"$#"+t,value:`${e.bufferOriginalUrl} ("${e.tags}") ${Math.round(10*e.playbackTime)/10} / ${Math.round(10*e.duration)/10}`}))]}]}}}self.C3.Plugins.Audio.Cnds={OnEnded(e){return this._MatchTriggerTag(e)},OnFadeEnded(e){return this._MatchTriggerTag(e)},PreloadsComplete(){return this._preloadCount===this._preloadTotal},AdvancedAudioSupported:()=>!0,IsSilent(){return this._IsSilent()},IsAnyPlaying(){for(const e of this._lastAIState)if(e.isPlaying)return!0;return!1},IsTagPlaying(e){return this._IsTagPlaying(e)}};{const nR=self.C3,aR=["lowpass","highpass","bandpass","lowshelf","highshelf","peaking","notch","allpass"];nR.Plugins.Audio.Acts={Play(e,t,s,i,r){const n=nR.Plugins.Audio.Acts._DoPlay.call(this,e,t,s,i,r);return this._AddActionPromise(n),n},PlayFromTimeline(e,t,s,i){nR.Plugins.Audio.Acts._DoPlay.call(this,e,0,t,0,s,i)},async _DoPlay(e,t,s,i,r,n){if(this._isSilent)return;const a=e[1],o=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e[0]);if(!o)return;const{playOffset:h,isTrueClock:l}=this._GetScheduledPlayInfo(),c=this._MaybeMarkAsPlaying(e[0],r,a,0!==t,this.DbToLinear(s));try{await this.PostToDOMAsync("play",{originalUrl:e[0],url:o.url,type:o.type,isMusic:a,tags:this._SplitTags(r),isLooping:0!==t,vol:this.DbToLinear(s),stereoPan:nR.clamp(i/100,-1,1),pos:n||0,off:h,trueClock:l})}finally{c&&(c.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtPosition(e,t,s,i,r,n,a,o,h,l,c){if(this._isSilent)return;const u=e[1],d=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e[0]);if(!d)return;const{playOffset:_,isTrueClock:p}=this._GetScheduledPlayInfo(),f=this._MaybeMarkAsPlaying(e[0],c,u,0!==t,this.DbToLinear(s));try{await this.PostToDOMAsync("play",{originalUrl:e[0],url:d.url,type:d.type,isMusic:u,tags:this._SplitTags(c),isLooping:0!==t,vol:this.DbToLinear(s),pos:0,off:_,trueClock:p,panning:{x:i,y:r,z:n,angle:nR.toRadians(a),innerAngle:nR.toRadians(o),outerAngle:nR.toRadians(h),outerGain:this.DbToLinear(l)}})}finally{f&&(f.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtObject(e,t,s,i,r,n,a,o){if(this._isSilent)return;if(!i)return;const h=i.GetFirstPicked();if(!h||!h.GetWorldInfo())return;const l=h.GetWorldInfo(),c=l.GetLayer().GetAngle(),[u,d]=this.rotatePtAround(l.GetX(),l.GetY(),-c,this._listenerPos[0],this._listenerPos[1]),_=e[1],p=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e[0]);if(!p)return;const{playOffset:f,isTrueClock:m}=this._GetScheduledPlayInfo(),g=this._MaybeMarkAsPlaying(e[0],o,_,0!==t,this.DbToLinear(s));try{await this.PostToDOMAsync("play",{originalUrl:e[0],url:p.url,type:p.type,isMusic:_,tags:this._SplitTags(o),isLooping:0!==t,vol:this.DbToLinear(s),pos:0,off:f,trueClock:m,panning:{x:u,y:d,z:l.GetTotalZElevation(),angle:l.GetAngle()-c,innerAngle:nR.toRadians(r),outerAngle:nR.toRadians(n),outerGain:this.DbToLinear(a),uid:h.GetUID()}})}finally{g&&(g.placeholder=this._runtime.GetTickCountNoSave())}},async PlayByName(e,t,s,i,r,n){if(this._isSilent)return;const a=1===e,o=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t)||this._remoteUrls.get(t.toLowerCase());if(!o)return;const{playOffset:h,isTrueClock:l}=this._GetScheduledPlayInfo(),c=this._MaybeMarkAsPlaying(t,n,a,0!==s,this.DbToLinear(i));try{await this.PostToDOMAsync("play",{originalUrl:t,url:o.url,type:o.type,isMusic:a,tags:this._SplitTags(n),isLooping:0!==s,vol:this.DbToLinear(i),stereoPan:nR.clamp(r/100,-1,1),pos:0,off:h,trueClock:l})}finally{c&&(c.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtPositionByName(e,t,s,i,r,n,a,o,h,l,c,u){if(this._isSilent)return;const d=1===e,_=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t)||this._remoteUrls.get(t.toLowerCase());if(!_)return;const{playOffset:p,isTrueClock:f}=this._GetScheduledPlayInfo(),m=this._MaybeMarkAsPlaying(t,u,d,0!==s,this.DbToLinear(i));try{await this.PostToDOMAsync("play",{originalUrl:t,url:_.url,type:_.type,isMusic:d,tags:this._SplitTags(u),isLooping:0!==s,vol:this.DbToLinear(i),pos:0,off:p,trueClock:f,panning:{x:r,y:n,z:a,angle:nR.toRadians(o),innerAngle:nR.toRadians(h),outerAngle:nR.toRadians(l),outerGain:this.DbToLinear(c)}})}finally{m&&(m.placeholder=this._runtime.GetTickCountNoSave())}},async PlayAtObjectByName(e,t,s,i,r,n,a,o,h){if(this._isSilent)return;if(this._isSilent)return;if(!r)return;const l=r.GetFirstPicked();if(!l||!l.GetWorldInfo())return;const c=l.GetWorldInfo(),u=c.GetLayer().GetAngle(),[d,_]=this.rotatePtAround(c.GetX(),c.GetY(),-u,this._listenerPos[0],this._listenerPos[1]),p=1===e,f=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t)||this._remoteUrls.get(t.toLowerCase());if(!f)return;const{playOffset:m,isTrueClock:g}=this._GetScheduledPlayInfo(),S=this._MaybeMarkAsPlaying(t,h,p,0!==s,this.DbToLinear(i));try{await this.PostToDOMAsync("play",{originalUrl:t,url:f.url,type:f.type,isMusic:p,tags:this._SplitTags(h),isLooping:0!==s,vol:this.DbToLinear(i),pos:0,off:m,trueClock:g,panning:{x:d,y:_,z:c.GetTotalZElevation(),angle:c.GetAngle()-u,innerAngle:nR.toRadians(n),outerAngle:nR.toRadians(a),outerGain:this.DbToLinear(o),uid:l.GetUID()}})}finally{S&&(S.placeholder=this._runtime.GetTickCountNoSave())}},SetLooping(e,t){this.PostToDOM("set-looping",{tags:this._SplitTags(e),isLooping:0===t})},SetMuted(e,t){this.PostToDOM("set-muted",{tags:this._SplitTags(e),isMuted:0===t})},SetVolume(e,t){this.PostToDOM("set-volume",{tags:this._SplitTags(e),vol:this.DbToLinear(t)})},FadeVolume(e,t,s,i){this.PostToDOM("fade-volume",{tags:this._SplitTags(e),vol:this.DbToLinear(t),duration:s,stopOnEnd:0===i})},SetStereoPan(e,t){this.PostToDOM("set-stereo-pan",{tags:this._SplitTags(e),p:nR.clamp(t/100,-1,1)})},async Preload(e){const t=e[1],s=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e[0]);s&&(this._preloadTotal++,await this.PostToDOMAsync("preload",{originalUrl:e[0],url:s.url,type:s.type,isMusic:t}),this._preloadCount++)},async PreloadByName(e,t){const s=1===e,i=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t)||this._remoteUrls.get(t.toLowerCase());i&&(this._preloadTotal++,await this.PostToDOMAsync("preload",{originalUrl:t,url:i.url,type:i.type,isMusic:s}),this._preloadCount++)},SetPlaybackRate(e,t){this.PostToDOM("set-playback-rate",{tags:this._SplitTags(e),rate:Math.max(t,0)})},Stop(e){this._MaybeMarkAsStopped(e),this.PostToDOM("stop",{tags:this._SplitTags(e)})},StopAll(){this._StopAll()},SetPaused(e,t){this.PostToDOM("set-paused",{tags:this._SplitTags(e),paused:0===t})},Seek(e,t){this.PostToDOM("seek",{tags:this._SplitTags(e),pos:t})},SetSilent(e){2===e&&(e=this._IsSilent()?1:0),this._SetSilent(0===e)},SetMasterVolume(e){const t=this.DbToLinear(e);this._SetMasterVolume(t)},AddFilterEffect(e,t,s,i,r,n,a){const o=aR[t];this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"filter",tags:this._SplitTags(e),params:[o,s,i,r,n,nR.clamp(a/100,0,1)]})},AddDelayEffect(e,t,s,i){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"delay",tags:this._SplitTags(e),params:[t,this.DbToLinear(s),nR.clamp(i/100,0,1)]})},AddFlangerEffect(e,t,s,i,r,n){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"flanger",tags:this._SplitTags(e),params:[t/1e3,s/1e3,i,r/100,nR.clamp(n/100,0,1)]})},AddPhaserEffect(e,t,s,i,r,n,a){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"phaser",tags:this._SplitTags(e),params:[t,s,i,r,n,nR.clamp(a/100,0,1)]})},AddConvolutionEffect(e,t,s,i){const r=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t[0]);r&&(this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"convolution",tags:this._SplitTags(e),bufferOriginalUrl:t[0],bufferUrl:r.url,bufferType:r.type,params:[0===s,nR.clamp(i/100,0,1)]}))},AddGainEffect(e,t){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"gain",tags:this._SplitTags(e),params:[this.DbToLinear(t)]})},AddStereoPanEffect(e,t){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"stereopan",tags:this._SplitTags(e),params:[nR.clamp(t/100,-1,1)]})},AddMuteEffect(e){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"gain",tags:this._SplitTags(e),params:[0]})},AddTremoloEffect(e,t,s){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"tremolo",tags:this._SplitTags(e),params:[t,nR.clamp(s/100,0,1)]})},AddRingModEffect(e,t,s){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"ringmod",tags:this._SplitTags(e),params:[t,nR.clamp(s/100,0,1)]})},AddDistortionEffect(e,t,s,i,r,n){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"distortion",tags:this._SplitTags(e),params:[this.DbToLinearNoCap(t),this.DbToLinearNoCap(s),i,this.DbToLinearNoCap(r),nR.clamp(n/100,0,1)]})},AddCompressorEffect(e,t,s,i,r,n){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"compressor",tags:this._SplitTags(e),params:[t,s,i,r/1e3,n/1e3]})},AddAnalyserEffect(e,t,s){this._IncrementEffectCount(e),this.PostToDOM("add-effect",{type:"analyser",tags:this._SplitTags(e),params:[t,s]})},RemoveEffects(e){const t=this._SplitTags(e);for(const e of t)this._effectCount.set(e.toLowerCase(),0);this.PostToDOM("remove-effects",{tags:t}),this._lastFxState={}},SetEffectParameter(e,t,s,i,r,n){this.PostToDOM("set-effect-param",{tags:this._SplitTags(e),index:Math.floor(t),param:s,value:i,ramp:r,time:n})},SetListenerObject(e){if(!e)return;const t=e.GetFirstPicked();t&&t.GetWorldInfo()&&(this._listenerInst=t)},SetListenerZ(e){this._listenerPos[2]=e},SetListenerOrientation(e,t,s,i,r,n){this._listenerForwardVec[0]=e,this._listenerForwardVec[1]=t,this._listenerForwardVec[2]=-s,this._listenerUpVec[0]=i,this._listenerUpVec[1]=r,this._listenerUpVec[2]=-n},ScheduleNextPlay(e){this._nextPlayTime=Math.max(e,0),this._nextPlayOffset=Math.max(e-performance.now()/1e3,0)},UnloadAudio(e){const t=e[1],s=this._runtime.GetAssetManager().GetProjectAudioFileUrl(e[0]);s&&this.PostToDOM("unload",{url:s.url,type:s.type,isMusic:t})},UnloadAudioByName(e,t){const s=1===e,i=this._runtime.GetAssetManager().GetProjectAudioFileUrl(t)||this._remoteUrls.get(t.toLowerCase());i&&this.PostToDOM("unload",{url:i.url,type:i.type,isMusic:s})},UnloadAll(){this.PostToDOM("unload-all")},AddRemoteURL(e,t,s){this._remoteUrls.set(s.toLowerCase(),{url:e,type:t})}}}{const oR=self.C3;oR.Plugins.Audio.Exps={Duration(e){const t=this._GetFirstAudioStateByTags(e);return t?t.duration:0},PlaybackTime(e){const t=this._GetFirstAudioStateByTags(e);return t?t.playbackTime:0},PlaybackRate(e){const t=this._GetFirstAudioStateByTags(e);return t?t.playbackRate:0},Volume(e){const t=this._GetFirstAudioStateByTags(e);return t?this.LinearToDb(t.volume):0},MasterVolume(){return this.LinearToDb(this._GetMasterVolume())},EffectCount(e){return this._effectCount.get(e.toLowerCase())||0},AnalyserFreqBinCount(e,t){const s=this.GetAnalyserData(e,Math.floor(t));return s?s.binCount:0},AnalyserFreqBinAt(e,t,s){const i=this.GetAnalyserData(e,Math.floor(t));return i?(s=Math.floor(s))<0||s>=i.binCount?0:i.freqBins[s]:0},AnalyserPeakLevel(e,t){const s=this.GetAnalyserData(e,Math.floor(t));return s?s.peak:0},AnalyserRMSLevel(e,t){const s=this.GetAnalyserData(e,Math.floor(t));return s?s.rms:0},SampleRate(){return this._sampleRate},CurrentTime:()=>self.C3_GetAudioContextCurrentTime?self.C3_GetAudioContextCurrentTime():performance.now()/1e3,OutputLatency(){return this._outputLatency},NormalizedVolume(e,t){return 0==(e=oR.clamp(+e,0,100)/100)?-1/0:e<.1?this.LinearToDb(oR.lerp(0,this.DbToLinear(t),10*e)):oR.lerp(t,0,(e-.1)/.9)}}}{const hR=self.C3;hR.Plugins.Browser=class extends hR.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const lR=self.C3;lR.Plugins.Browser.Type=class extends lR.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const cR=self.C3,uR="browser";cR.Plugins.Browser.Instance=class extends cR.SDKInstanceBase{constructor(e,t){super(e,uR),this._initLocationStr="",this._isOnline=!1,this._referrer="",this._docTitle="",this._isCookieEnabled=!1,this._screenWidth=0,this._screenHeight=0,this._windowOuterWidth=0,this._windowOuterHeight=0,this._windowHasFocus=!1,this._isConstructArcade=!1,this._cssStyleMap=new Map,this._isInstallAvailable=!1,this._installResult="",this._isWarnOnCloseEnabled=!1,this.AddDOMMessageHandlers([["online-state",e=>this._OnOnlineStateChanged(e)],["backbutton",()=>this._OnBackButton()],["sw-message",e=>this._OnSWMessage(e)],["hashchange",e=>this._OnHashChange(e)],["install-available",()=>this._OnInstallAvailable()],["app-installed",e=>this._OnAppInstalled(e)],["fullscreenerror",()=>this._OnFullscreenError()]]);const s=this.GetRuntime().Dispatcher();this._disposables=new cR.CompositeDisposable(cR.Disposable.From(s,"afterfirstlayoutstart",()=>this._OnAfterFirstLayoutStart()),cR.Disposable.From(s,"window-resize",()=>this._OnWindowResize()),cR.Disposable.From(s,"window-focus",()=>this._OnWindowFocus()),cR.Disposable.From(s,"window-blur",()=>this._OnWindowBlur()),cR.Disposable.From(s,"suspend",()=>this._OnSuspend()),cR.Disposable.From(s,"resume",()=>this._OnResume()),cR.Disposable.From(s,"windowmaximize",()=>this._OnWindowMaximized()),cR.Disposable.From(s,"windowminimize",()=>this._OnWindowMinimized())),this._runtime.AddLoadPromise(this.PostToDOMAsync("get-initial-state",{exportType:this._runtime.GetExportType()}).then(e=>{this._initLocationStr=e.location,this._isOnline=e.isOnline,this._referrer=e.referrer,this._docTitle=e.title,this._isCookieEnabled=e.isCookieEnabled,this._screenWidth=e.screenWidth,this._screenHeight=e.screenHeight,this._windowOuterWidth=e.windowOuterWidth,this._windowOuterHeight=e.windowOuterHeight,this._windowHasFocus=e.windowHasFocus,this._isConstructArcade=e.isConstructArcade}))}Release(){super.Release()}_OnAfterFirstLayoutStart(){this.PostToDOM("ready-for-sw-messages")}async _OnOnlineStateChanged(e){const t=!!e.isOnline;this._isOnline!==t&&(this._isOnline=t,this._isOnline?await this.TriggerAsync(cR.Plugins.Browser.Cnds.OnOnline):await this.TriggerAsync(cR.Plugins.Browser.Cnds.OnOffline))}async _OnWindowResize(){await this.TriggerAsync(cR.Plugins.Browser.Cnds.OnResize)}async _OnFullscreenError(){await this.TriggerAsync(cR.Plugins.Browser.Cnds.OnFullscreenError)}async _OnWindowFocus(){this._windowHasFocus=!0,await this.TriggerAsync(cR.Plugins.Browser.Cnds.OnWindowFocus)}async _OnWindowBlur(){this._windowHasFocus=!1,await this.TriggerAsync(cR.Plugins.Browser.Cnds.OnWindowBlur)}async _OnWindowMaximized(){await this.TriggerAsync(cR.Plugins.Browser.Cnds.OnWindowMaximized)}async _OnWindowMinimized(){await this.TriggerAsync(cR.Plugins.Browser.Cnds.OnWindowMinimized)}_OnSuspend(){this.Trigger(cR.Plugins.Browser.Cnds.OnPageHidden)}_OnResume(){this.Trigger(cR.Plugins.Browser.Cnds.OnPageVisible)}async _OnBackButton(){await this.TriggerAsync(cR.Plugins.Browser.Cnds.OnBackButton)}_OnSWMessage(e){const t=e.type;"downloading-update"===t?this.Trigger(cR.Plugins.Browser.Cnds.OnUpdateFound):"update-ready"===t||"update-pending"===t?this.Trigger(cR.Plugins.Browser.Cnds.OnUpdateReady):"offline-ready"===t&&this.Trigger(cR.Plugins.Browser.Cnds.OnOfflineReady)}_OnHashChange(e){this._initLocationStr=e.location,this.Trigger(cR.Plugins.Browser.Cnds.OnHashChange)}_OnInstallAvailable(){this._isInstallAvailable=!0,this.Trigger(cR.Plugins.Browser.Cnds.OnInstallAvailable)}_OnAppInstalled(e){this._isInstallAvailable=!1,this.Trigger(cR.Plugins.Browser.Cnds.OnAppInstalled)}_IsWarnOnCloseEnabled(){return this._isWarnOnCloseEnabled}_SetWarnOnCloseEnabled(e){e=!!e,this._isWarnOnCloseEnabled!==e&&(this._isWarnOnCloseEnabled=e,this.PostToDOM("set-warn-on-close",{enabled:e}))}GetDebuggerProperties(){const e="plugins.browser.debugger";return[{title:"plugins.browser.name",properties:[{name:e+".user-agent",value:navigator.userAgent},{name:e+".is-online",value:this._isOnline},{name:e+".is-fullscreen",value:this._runtime.GetCanvasManager().IsDocumentFullscreen()}]}]}}}{const dR=self.C3;dR.Plugins.Browser.Cnds={IsOnline(){return this._isOnline},OnOnline:()=>!0,OnOffline:()=>!0,OnResize:()=>!0,OnFullscreenError:()=>!0,OnWindowFocus:()=>!0,OnWindowBlur:()=>!0,WindowHasFocus(){return this._windowHasFocus},CookiesEnabled(){return this._isCookieEnabled},IsFullscreen(){return this._runtime.GetCanvasManager().IsDocumentFullscreen()},OnBackButton:()=>!0,IsPortraitLandscape(e){return(this._runtime.GetCanvasManager().GetLastWidth()<=this._runtime.GetCanvasManager().GetLastHeight()?0:1)===e},OnUpdateFound:()=>!0,OnUpdateReady:()=>!0,OnOfflineReady:()=>!0,OnHashChange:()=>!0,OnInstallAvailable:()=>!0,IsInstallAvailable(){return this._isInstallAvailable},OnInstallResult(e){switch(e){case 0:return"accepted"===this._installResult;case 1:return"dismissed"===this._installResult;case 2:return"error"===this._installResult;case 3:return!0;default:return!1}},OnAppInstalled:()=>!0,CompareDisplayMode(e){const t=this._runtime.GetCanvasManager().GetCssDisplayMode();switch(e){case 0:return"browser"===t;case 1:return"minimal-ui"===t;case 2:return"standalone"===t;case 3:return"fullscreen"===t;default:return!1}},IsWarnOnCloseEnabled(){return this._IsWarnOnCloseEnabled()},OnWindowMaximized:()=>!0,OnWindowMinimized:()=>!0,PageVisible(){return!this._runtime.IsSuspended()},OnPageHidden:()=>!0,OnPageVisible:()=>!0,HasJava:()=>!1,IsDownloadingUpdate:()=>!1,OnMenuButton:()=>!1,OnSearchButton:()=>!1,IsMetered:()=>!1,IsCharging:()=>!0,SupportsFullscreen:()=>!0}}{const C3=self.C3,ORIENTATIONS=["portrait","landscape","portrait-primary","portrait-secondary","landscape-primary","landscape-secondary"];C3.Plugins.Browser.Acts={Alert(e){this.PostToDOM("alert",{message:e.toString()})},Close(){this._isConstructArcade||(this._runtime.IsDebug()?self.C3Debugger.CloseWindow():this.PostToDOM("close"))},Focus(){this.PostToDOM("set-focus",{isFocus:!0})},Blur(){this.PostToDOM("set-focus",{isFocus:!1})},GoBack(){this._isConstructArcade||this.PostToDOM("navigate",{type:"back"})},GoForward(){this._isConstructArcade||this.PostToDOM("navigate",{type:"forward"})},GoHome(){},Reload(){this._isConstructArcade||(this._runtime.IsDebug()?this._runtime.PostToDebugger({type:"reload"}):this.PostToDOM("navigate",{type:"reload"}))},GoToURL(e,t){this._PostToDOMMaybeSync("navigate",{type:"url",url:e,target:t,exportType:this._runtime.GetExportType()})},GoToURLWindow(e,t){this._PostToDOMMaybeSync("navigate",{type:"new-window",url:e,tag:t,exportType:this._runtime.GetExportType()})},RequestFullScreen(e,t){e>=2&&(e+=1),6===e&&(e=2),1===e&&(e=0);const s=C3.CanvasManager._FullscreenModeNumberToString(e);this._runtime.GetCanvasManager().SetDocumentFullscreenMode(s),this._PostToDOMMaybeSync("request-fullscreen",{navUI:t})},CancelFullScreen(){this._PostToDOMMaybeSync("exit-fullscreen")},Vibrate(e){const t=e.split(",");for(let e=0,s=t.length;e<s;++e)t[e]=parseInt(t[e],10);this._PostToDOMMaybeSync("vibrate",{pattern:t})},InvokeDownload(e,t){if(!e||!t)return;const s=this._runtime.GetAssetManager().GetProjectFileUrl(e);this._runtime.InvokeDownload(s,t)},InvokeDownloadString(e,t,s){if(!s)return;const i=`data:${t},${encodeURIComponent(e)}`;this._runtime.InvokeDownload(i,s)},ConsoleLog(e,t){t=t.toString(),0===e?console.log(t):1===e?console.warn(t):2===e&&console.error(t)},ConsoleGroup(e){console.group(e)},ConsoleGroupEnd(){console.groupEnd()},ExecJs(jsStr){try{eval(jsStr)}catch(e){console.error("Error executing JavaScript: ",e)}},LockOrientation(e){if((e=Math.floor(e))<0||e>=ORIENTATIONS.length)return;const t=ORIENTATIONS[e];this._PostToDOMMaybeSync("lock-orientation",{orientation:t})},UnlockOrientation(){this._PostToDOMMaybeSync("unlock-orientation")},LoadStyleSheet(e){this._runtime.GetAssetManager().LoadStyleSheet(e)},async SetDocumentCSSStyle(e,t,s,i){await this.PostToDOMAsync("set-document-css-style",{prop:C3.CSSToCamelCase(e),value:t,selector:s,"is-all":0!==i})},async GetDocumentCSSStyle(e,t,s){const i=await this.PostToDOMAsync("get-document-css-style",{prop:e,selector:t});i.isOk&&this._cssStyleMap.set(s.toLowerCase(),i.result.trim())},SetHash(e){this.PostToDOM("set-hash",{hash:e})},SetWindowSize(e,t){this.PostToDOM("set-window-size",{windowWidth:e,windowHeight:t})},SetWindowPosition(e,t){this.PostToDOM("set-window-position",{windowX:e,windowY:t})},async RequestInstall(){const e=await this.PostToDOMAsync("request-install");this._installResult=e.result,this.Trigger(C3.Plugins.Browser.Cnds.OnInstallResult)},SetWarnOnClose(e){this._SetWarnOnCloseEnabled(e)},MaximizeWindow(){this._runtime.SendRawWrapperExtensionMessage({type:"maximize-window"})},MinimizeWindow(){this._runtime.SendRawWrapperExtensionMessage({type:"minimize-window"})},RestoreWindow(){this._runtime.SendRawWrapperExtensionMessage({type:"restore-window"})}}}{const C3=self.C3;C3.Plugins.Browser.Exps={URL(){return this._runtime.IsInWorker()?this._initLocationStr:location.toString()},Protocol(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).protocol:location.protocol},Domain(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).hostname:location.hostname},Port(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).port:location.port},PathName(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).pathname:location.pathname},Hash(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).hash:location.hash},QueryString(){return this._runtime.IsInWorker()?new URL(this._initLocationStr).search:location.search},QueryParam(e){const t=this._runtime.IsInWorker()?new URL(this._initLocationStr).search:location.search,s=RegExp("[?&]"+e+"=([^&]*)").exec(t);return s?decodeURIComponent(s[1].replace(/\+/g," ")):""},Referrer(){return this._referrer},Title(){return this._docTitle},Language:()=>navigator.language,Platform:()=>navigator.platform,UserAgent:()=>navigator.userAgent,ExecJS(jsStr){let result=0;try{result=eval(jsStr)}catch(e){console.error("Error executing JavaScript: ",e)}return"number"==typeof result||"string"==typeof result?result:"boolean"==typeof result&&result?1:0},CSSStyleValue(e){return this._cssStyleMap.get(e)||""},Name:()=>navigator.appName,Version:()=>navigator.appVersion,Product:()=>navigator.product,Vendor:()=>navigator.vendor,BatteryLevel:()=>1,BatteryTimeLeft:()=>1/0,Bandwidth(){const e=navigator.connection;return e&&(e.downlink||e.downlinkMax||e.bandwidth)||1/0},ConnectionType(){const e=navigator.connection;return e&&e.type||"unknown"},DevicePixelRatio:()=>self.devicePixelRatio,ScreenWidth(){return this._screenWidth},ScreenHeight(){return this._screenHeight},WindowInnerWidth(){return this._runtime.GetCanvasManager().GetLastWidth()},WindowInnerHeight(){return this._runtime.GetCanvasManager().GetLastHeight()},WindowOuterWidth(){return this._windowOuterWidth},WindowOuterHeight(){return this._windowOuterWidth},DisplayMode(){return this._runtime.GetCanvasManager().GetCssDisplayMode()},InstallResult(){return this._installResult}}}{const _R=self.C3;_R.Plugins.Keyboard=class extends _R.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{let pR=function(){return mR.GetSingleGlobalInstance().GetSdkInstance()};GetKeyboardSdkInstance=pR;const fR=self.C3;self.C3X,fR.Plugins.Keyboard.Type=class extends fR.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}GetScriptInterfaceClass(){return self.IKeyboardObjectType}};let mR=null;self.IKeyboardObjectType=class extends self.IObjectType{constructor(e){super(e),mR=e,e.GetRuntime()._GetCommonScriptInterfaces().keyboard=this}isKeyDown(e){const t=pR();if("string"==typeof e)return t.IsKeyDown(e);if("number"==typeof e)return t.IsKeyCodeDown(e);throw new TypeError("expected string or number")}}}{const gR=self.C3,SR="keyboard";gR.Plugins.Keyboard.Instance=class extends gR.SDKInstanceBase{constructor(e,t){super(e,SR),this._keysDownByString=new Set,this._keysDownByWhich=new Set,this._triggerWhich=0,this._triggerString="",this._triggerTypedKey="",this._isKeyboardLockSupported=!1;const s=this.GetRuntime().Dispatcher();this._disposables=new gR.CompositeDisposable(gR.Disposable.From(s,"keydown",e=>this._OnKeyDown(e.data)),gR.Disposable.From(s,"keyup",e=>this._OnKeyUp(e.data)),gR.Disposable.From(s,"window-blur",()=>this._OnWindowOrKeyboardBlur()),gR.Disposable.From(s,"keyboard-blur",()=>this._OnWindowOrKeyboardBlur())),this._runtime.AddLoadPromise(this._Init())}Release(){super.Release()}async _Init(){const e=await this.PostToDOMAsync("init");this._isKeyboardLockSupported=e.isKeyboardLockSupported}_OnKeyDown(e){const t=e.which,s=e.code||t.toString(),i=e.key;this._keysDownByString.has(s)||(this._keysDownByString.add(s),this._keysDownByWhich.add(t),this._triggerString=s,this._triggerWhich=t,this._triggerTypedKey=i,this.Trigger(gR.Plugins.Keyboard.Cnds.OnAnyKey),this.Trigger(gR.Plugins.Keyboard.Cnds.OnKey),this.Trigger(gR.Plugins.Keyboard.Cnds.OnLeftRightKeyPressed),this.Trigger(gR.Plugins.Keyboard.Cnds.OnKeyCode))}_OnKeyUp(e){const t=e.which,s=e.code||t.toString(),i=e.key;this._keysDownByString.delete(s),this._keysDownByWhich.delete(t),this._triggerString=s,this._triggerWhich=t,this._triggerTypedKey=i,this.Trigger(gR.Plugins.Keyboard.Cnds.OnAnyKeyReleased),this.Trigger(gR.Plugins.Keyboard.Cnds.OnKeyReleased),this.Trigger(gR.Plugins.Keyboard.Cnds.OnLeftRightKeyReleased),this.Trigger(gR.Plugins.Keyboard.Cnds.OnKeyCodeReleased)}_OnWindowOrKeyboardBlur(){for(const e of this._keysDownByWhich)this._keysDownByWhich.delete(e),this._triggerWhich=e,this.Trigger(gR.Plugins.Keyboard.Cnds.OnAnyKeyReleased),this.Trigger(gR.Plugins.Keyboard.Cnds.OnKeyReleased),this.Trigger(gR.Plugins.Keyboard.Cnds.OnKeyCodeReleased);this._keysDownByString.clear()}IsKeyDown(e){return this._keysDownByString.has(e)}IsKeyCodeDown(e){return this._keysDownByWhich.has(e)}SaveToJson(){return{tk:this._triggerWhich,tkk:this._triggerTypedKey}}LoadFromJson(e){this._triggerWhich=e.tk,e.hasOwnProperty("tkk")&&(this._triggerTypedKey=e.tkk)}GetDebuggerProperties(){const e="plugins.keyboard";return[{title:e+".name",properties:[{name:e+".debugger.last-key-code",value:this._triggerWhich},{name:e+".debugger.last-key-string",value:gR.Plugins.Keyboard.Exps.StringFromKeyCode(this._triggerWhich)},{name:e+".debugger.last-typed-key",value:this._triggerTypedKey}]}]}}}{const GR=self.C3,yR=["ShiftLeft","ShiftRight","ControlLeft","ControlRight","AltLeft","AltRight","MetaLeft","MetaRight"];GR.Plugins.Keyboard.Cnds={IsKeyDown(e){return this._keysDownByWhich.has(e)},OnKey(e){return this._triggerWhich===e},OnAnyKey:()=>!0,OnAnyKeyReleased:()=>!0,OnKeyReleased(e){return this._triggerWhich===e},IsKeyCodeDown(e){return e=Math.floor(e),this._keysDownByWhich.has(e)},OnKeyCode(e){return this._triggerWhich===e},OnKeyCodeReleased(e){return this._triggerWhich===e},OnLeftRightKeyPressed(e){const t=yR[e];return this._triggerString===t},OnLeftRightKeyReleased(e){const t=yR[e];return this._triggerString===t},IsLeftRightKeyDown(e){const t=yR[e];return this._keysDownByString.has(t)},IsKeyboardLockSupported(){return this._isKeyboardLockSupported},OnKeyboardLocked:()=>!0,OnKeyboardLockError:()=>!0}}{const IR=self.C3;IR.Plugins.Keyboard.Acts={async LockKeyboard(e){if(!this._isKeyboardLockSupported)return;let t=[];e&&(t=e.split(",")),(await this.PostToDOMAsync("lock-keyboard",{keysArr:t})).isOk?this.Trigger(IR.Plugins.Keyboard.Cnds.OnKeyboardLocked):this.Trigger(IR.Plugins.Keyboard.Cnds.OnKeyboardLockError)},UnlockKeyboard(){this._isKeyboardLockSupported&&this.PostToDOMAsync("unlock-keyboard")}}}{let TR=function(e){switch(e=Math.floor(e)){case 8:return"backspace";case 9:return"tab";case 13:return"enter";case 16:return"shift";case 17:return"control";case 18:return"alt";case 19:return"pause";case 20:return"capslock";case 27:return"esc";case 33:return"pageup";case 34:return"pagedown";case 35:return"end";case 36:return"home";case 37:return"";case 38:return"";case 39:return"";case 40:return"";case 45:return"insert";case 46:return"del";case 91:return"left window key";case 92:return"right window key";case 93:return"select";case 96:return"numpad 0";case 97:return"numpad 1";case 98:return"numpad 2";case 99:return"numpad 3";case 100:return"numpad 4";case 101:return"numpad 5";case 102:return"numpad 6";case 103:return"numpad 7";case 104:return"numpad 8";case 105:return"numpad 9";case 106:return"numpad *";case 107:return"numpad +";case 109:return"numpad -";case 110:return"numpad .";case 111:return"numpad /";case 112:return"F1";case 113:return"F2";case 114:return"F3";case 115:return"F4";case 116:return"F5";case 117:return"F6";case 118:return"F7";case 119:return"F8";case 120:return"F9";case 121:return"F10";case 122:return"F11";case 123:return"F12";case 144:return"numlock";case 145:return"scroll lock";case 186:return";";case 187:return"=";case 188:return",";case 189:return"-";case 190:return".";case 191:return"/";case 192:return"'";case 219:return"[";case 220:return"\\";case 221:return"]";case 222:return"#";case 223:return"`";default:return String.fromCharCode(e)}};StringFromCharCode=TR,self.C3.Plugins.Keyboard.Exps={LastKeyCode(){return this._triggerWhich},StringFromKeyCode:e=>TR(e),TypedKey(){return this._triggerTypedKey}}}{const CR=self.C3;CR.Plugins.Mouse=class extends CR.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{let bR=function(){return PR.GetSingleGlobalInstance().GetSdkInstance()};GetMouseSdkInstance=bR;const xR=self.C3,wR=self.C3X;xR.Plugins.Mouse.Type=class extends xR.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}GetScriptInterfaceClass(){return self.IMouseObjectType}};let PR=null;self.IMouseObjectType=class extends self.IObjectType{constructor(e){super(e),PR=e,e.GetRuntime()._GetCommonScriptInterfaces().mouse=this}getMouseX(e){return bR().GetMousePositionForLayer(e)[0]}getMouseY(e){return bR().GetMousePositionForLayer(e)[1]}getMousePosition(e){return bR().GetMousePositionForLayer(e)}isMouseButtonDown(e){return bR().IsMouseButtonDown(e)}setCursorStyle(e){wR.RequireString(e),bR().SetCursorStyle(e)}setCursorObjectClass(e){const t=bR(),s=t.GetRuntime()._UnwrapIObjectClass(e);t.SetCursorObjectClass(s)}}}{const RR=self.C3,vR="mouse";let AR=null;RR.Plugins.Mouse.Instance=class extends RR.SDKInstanceBase{constructor(e,t){super(e,vR),this._buttonMap=[!1,!1,!1,!1,!1],this._mouseXcanvas=0,this._mouseYcanvas=0,this._triggerButton=0,this._triggerType=0,this._triggerDir=0,this._wheelDeltaX=0,this._wheelDeltaY=0,this._wheelDeltaZ=0,this._hasPointerLock=!1,this._movementX=0,this._movementY=0,this.AddDOMMessageHandlers([["pointer-lock-change",e=>this._OnPointerLockChange(e)],["pointer-lock-error",e=>this._OnPointerLockError(e)]]);const s=this.GetRuntime().Dispatcher();this._disposables=new RR.CompositeDisposable(RR.Disposable.From(s,"pointermove",e=>this._OnPointerMove(e.data)),RR.Disposable.From(s,"pointerdown",e=>this._OnPointerDown(e.data)),RR.Disposable.From(s,"pointerup",e=>this._OnPointerUp(e.data)),RR.Disposable.From(s,"dblclick",e=>this._OnDoubleClick(e.data)),RR.Disposable.From(s,"wheel",e=>this._OnMouseWheel(e.data)),RR.Disposable.From(s,"window-blur",()=>this._OnWindowBlur()))}Release(){super.Release()}_OnPointerDown(e){"mouse"===e.pointerType&&(this._mouseXcanvas=e.pageX-this._runtime.GetCanvasClientX(),this._mouseYcanvas=e.pageY-this._runtime.GetCanvasClientY(),this._CheckButtonChanges(e.lastButtons,e.buttons))}_OnPointerMove(e){this._movementX=e.movementX,this._movementY=e.movementY,this.Trigger(RR.Plugins.Mouse.Cnds.OnMovement),this._movementX=0,this._movementY=0,"mouse"===e.pointerType&&(this._mouseXcanvas=e.pageX-this._runtime.GetCanvasClientX(),this._mouseYcanvas=e.pageY-this._runtime.GetCanvasClientY(),this._CheckButtonChanges(e.lastButtons,e.buttons))}_OnPointerUp(e){"mouse"===e.pointerType&&this._CheckButtonChanges(e.lastButtons,e.buttons)}_CheckButtonChanges(e,t){this._CheckButtonChange(e,t,1,0),this._CheckButtonChange(e,t,4,1),this._CheckButtonChange(e,t,2,2),this._CheckButtonChange(e,t,8,3),this._CheckButtonChange(e,t,16,4)}_CheckButtonChange(e,t,s,i){!(e&s)&&t&s?this._OnMouseDown(i):e&s&&!(t&s)&&this._OnMouseUp(i)}_OnMouseDown(e){this._buttonMap[e]=!0,this.Trigger(RR.Plugins.Mouse.Cnds.OnAnyClick),this._triggerButton=e,this._triggerType=0,this.Trigger(RR.Plugins.Mouse.Cnds.OnClick),this.Trigger(RR.Plugins.Mouse.Cnds.OnObjectClicked)}_OnMouseUp(e){this._buttonMap[e]&&(this._buttonMap[e]=!1,this._triggerButton=e,this.Trigger(RR.Plugins.Mouse.Cnds.OnRelease))}_OnDoubleClick(e){this._triggerButton=e.button,this._triggerType=1,this.Trigger(RR.Plugins.Mouse.Cnds.OnClick),this.Trigger(RR.Plugins.Mouse.Cnds.OnObjectClicked)}_OnMouseWheel(e){this._triggerDir=e.deltaY<0?1:0,this._wheelDeltaX=e.deltaX,this._wheelDeltaY=e.deltaY,this._wheelDeltaZ=e.deltaZ,this.Trigger(RR.Plugins.Mouse.Cnds.OnWheel)}_OnWindowBlur(){for(let e=0,t=this._buttonMap.length;e<t;++e){if(!this._buttonMap[e])return;this._buttonMap[e]=!1,this._triggerButton=e,this.Trigger(RR.Plugins.Mouse.Cnds.OnRelease)}}GetMousePositionForLayer(e){const t=this._runtime.GetMainRunningLayout(),s=this._mouseXcanvas,i=this._mouseYcanvas;if(void 0===e)return t.GetLayerByIndex(0).CanvasCssToLayer_DefaultTransform(s,i);{const r=t.GetLayer(e);return r?r.CanvasCssToLayer(s,i):[0,0]}}IsMouseButtonDown(e){return e=Math.floor(e),!!this._buttonMap[e]}_IsMouseOverCanvas(){return this._mouseXcanvas>=0&&this._mouseYcanvas>=0&&this._mouseXcanvas<this._runtime.GetCanvasCssWidth()&&this._mouseYcanvas<this._runtime.GetCanvasCssHeight()}SetCursorStyle(e){AR!==e&&(AR=e,this.PostToDOM("cursor",e))}async SetCursorObjectClass(e){if(RR.Platform.IsMobile||!e)return;const t=e.GetFirstPicked();if(!t)return;const s=t.GetWorldInfo(),i=t.GetCurrentImageInfo();if(!s||!i)return;if(AR===i)return;AR=i;const r=`url(${await i.ExtractImageToBlobURL()}) ${Math.round(s.GetOriginX()*i.GetWidth())} ${Math.round(s.GetOriginY()*i.GetHeight())}, auto`;this.PostToDOM("cursor",r)}_OnPointerLockChange(e){this._UpdatePointerLockState(e["has-pointer-lock"])}_OnPointerLockError(e){this._UpdatePointerLockState(e["has-pointer-lock"]),this.Trigger(RR.Plugins.Mouse.Cnds.OnPointerLockError)}_UpdatePointerLockState(e){this._hasPointerLock!==e&&(this._hasPointerLock=e,this._hasPointerLock?this.Trigger(RR.Plugins.Mouse.Cnds.OnPointerLocked):this.Trigger(RR.Plugins.Mouse.Cnds.OnPointerUnlocked))}GetDebuggerProperties(){const e="plugins.mouse";return[{title:e+".name",properties:[{name:e+".debugger.absolute-position",value:this._mouseXcanvas+","+this._mouseYcanvas},{name:e+".debugger.left-button",value:this._buttonMap[0]},{name:e+".debugger.middle-button",value:this._buttonMap[1]},{name:e+".debugger.right-button",value:this._buttonMap[2]},{name:e+".debugger.button-4",value:this._buttonMap[3]},{name:e+".debugger.button-5",value:this._buttonMap[4]}]},{title:e+".debugger.position-on-each-layer",properties:this._runtime.GetMainRunningLayout().GetLayers().map(e=>({name:"$"+e.GetName(),value:e.CanvasCssToLayer(this._mouseXcanvas,this._mouseYcanvas).join(", ")}))}]}}}{const MR=self.C3;MR.Plugins.Mouse.Cnds={OnClick(e,t){return this._triggerButton===e&&this._triggerType===t},OnAnyClick:()=>!0,IsButtonDown(e){return this._buttonMap[e]},OnRelease(e){return this._triggerButton===e},IsOverObject(e){const t=this._runtime.GetCurrentCondition().IsInverted(),s=[];return this._IsMouseOverCanvas()&&s.push([this._mouseXcanvas,this._mouseYcanvas]),MR.xor(this._runtime.GetCollisionEngine().TestAndSelectCanvasPointOverlap(e,s,t),t)},OnObjectClicked(e,t,s){if(e!==this._triggerButton||t!==this._triggerType)return!1;if(!this._IsMouseOverCanvas())return!1;const i=this._mouseXcanvas,r=this._mouseYcanvas;return this._runtime.GetCollisionEngine().TestAndSelectCanvasPointOverlap(s,[[i,r]],!1)},OnWheel(e){return 2===e||this._triggerDir===e},OnPointerLocked:()=>!0,OnPointerUnlocked:()=>!0,OnPointerLockError:()=>!0,HasPointerLock(){return this._hasPointerLock},OnMovement:()=>!0}}{const DR=self.C3,ER=["auto","pointer","text","crosshair","move","help","wait","none"],FR=["auto","all-scroll","none","help","pointer","progress","wait","cell","crosshair","text","vertical-text","alias","copy","move","not-allowed","grab","grabbing","col-resize","row-resize","ew-resize","ns-resize","nesw-resize","nwse-resize","zoom-in","zoom-out"];DR.Plugins.Mouse.Acts={SetCursor(e){this.SetCursorStyle(ER[e])},SetCursor2(e){this.SetCursorStyle(FR[e])},SetCursorSprite(e){this.SetCursorObjectClass(e)},RequestPointerLock(e){this._PostToDOMMaybeSync("request-pointer-lock",{unadjustedMovement:e})},ReleasePointerLock(){this.PostToDOM("release-pointer-lock")}}}self.C3.Plugins.Mouse.Exps={X(e){return this.GetMousePositionForLayer(e)[0]},Y(e){return this.GetMousePositionForLayer(e)[1]},AbsoluteX(){return this._mouseXcanvas},AbsoluteY(){return this._mouseYcanvas},MovementX(){return this._movementX},MovementY(){return this._movementY},WheelDeltaX(){return this._wheelDeltaX},WheelDeltaY(){return this._wheelDeltaY},WheelDeltaZ(){return this._wheelDeltaZ}};{const OR=self.C3;OR.Plugins.PlatformInfo=class extends OR.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const BR=self.C3;BR.Plugins.PlatformInfo.Type=class extends BR.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const kR=self.C3,LR="platform-info";kR.Plugins.PlatformInfo.Instance=class extends kR.SDKInstanceBase{constructor(e,t){super(e,LR),this._screenWidth=0,this._screenHeight=0,this._windowOuterWidth=0,this._windowOuterHeight=0,this._safeAreaInset=[0,0,0,0],this._supportsWakeLock=!1,this._isWakeLockActive=!1,this.AddDOMMessageHandlers([["window-resize",e=>this._OnWindowResize(e)],["wake-lock-acquired",e=>this._OnWakeLockAcquired(e)],["wake-lock-error",e=>this._OnWakeLockError(e)],["wake-lock-released",e=>this._OnWakeLockReleased(e)]]),navigator.connection&&navigator.connection.addEventListener("change",()=>this._OnNetworkChange()),this._runtime.AddLoadPromise(this.PostToDOMAsync("get-initial-state").then(e=>{this._screenWidth=e.screenWidth,this._screenHeight=e.screenHeight,this._windowOuterWidth=e.windowOuterWidth,this._windowOuterHeight=e.windowOuterHeight,this._safeAreaInset=e.safeAreaInset,this._supportsWakeLock=e.supportsWakeLock}))}Release(){super.Release()}_OnWindowResize(e){this._windowOuterWidth=e.windowOuterWidth,this._windowOuterHeight=e.windowOuterHeight,this._safeAreaInset=e.safeAreaInset}async _OnNetworkChange(){await this.TriggerAsync(kR.Plugins.PlatformInfo.Cnds.OnNetworkChange)}async _OnWakeLockAcquired(){this._isWakeLockActive=!0,await this.TriggerAsync(kR.Plugins.PlatformInfo.Cnds.OnWakeLockAcquired)}async _OnWakeLockError(){this._isWakeLockActive=!1,await this.TriggerAsync(kR.Plugins.PlatformInfo.Cnds.OnWakeLockError)}async _OnWakeLockReleased(){this._isWakeLockActive=!1,await this.TriggerAsync(kR.Plugins.PlatformInfo.Cnds.OnWakeLockReleased)}}}{const NR=self.C3;NR.Plugins.PlatformInfo.Cnds={IsOnMobile:()=>NR.Platform.IsMobile,IsOnWindows:()=>"Windows"===NR.Platform.OS,IsOnMacOS:()=>"macOS"===NR.Platform.OS,IsOnLinux:()=>"Linux"===NR.Platform.OS,IsOnChromeOS:()=>"Chrome OS"===NR.Platform.OS,IsOnAndroid:()=>"Android"===NR.Platform.OS,IsOniOS:()=>"iOS"===NR.Platform.OS,IsWebExport(){const e=this._runtime.GetExportType();return"html5"===e||"scirra-arcade"===e||"preview"===e||"instant-games"===e},IsCordovaExport(){return this._runtime.IsCordova()},IsNWjsExport:()=>!1,IsWindowsUWPExport(){return"windows-uwp"===this._runtime.GetExportType()},IsWindowsWebView2Export(){return this._runtime.IsWindowsWebView2()},IsMacOSWKWebView2Export(){return"macos-wkwebview"===this._runtime.GetExportType()},IsLinuxCEFExport(){return"linux-cef"===this._runtime.GetExportType()},OnNetworkChange:()=>!0,OnWakeLockAcquired:()=>!0,OnWakeLockError:()=>!0,OnWakeLockReleased:()=>!0,IsWakeLockActive(){return this._isWakeLockActive},IsWakeLockSupported(){return this._supportsWakeLock}}}self.C3.Plugins.PlatformInfo.Acts={RequestWakeLock(){this._supportsWakeLock&&this._PostToDOMMaybeSync("request-wake-lock")},ReleaseWakeLock(){this._supportsWakeLock&&(this._isWakeLockActive=!1,this.PostToDOM("release-wake-lock"))}},self.C3.Plugins.PlatformInfo.Exps={Renderer(){return this._runtime.GetCanvasManager().GetRendererString()},RendererDetail(){return this._runtime.GetCanvasManager().GetRendererDetailString()},DevicePixelRatio(){return this._runtime.GetDevicePixelRatio()},ScreenWidth(){return this._screenWidth},ScreenHeight(){return this._screenHeight},WindowInnerWidth(){return this._runtime.GetCanvasManager().GetLastWidth()},WindowInnerHeight(){return this._runtime.GetCanvasManager().GetLastHeight()},WindowOuterWidth(){return this._windowOuterWidth},WindowOuterHeight(){return this._windowOuterHeight},CanvasCssWidth(){return this._runtime.GetCanvasManager().GetCssWidth()},CanvasCssHeight(){return this._runtime.GetCanvasManager().GetCssHeight()},CanvasDeviceWidth(){return this._runtime.GetCanvasManager().GetDeviceWidth()},CanvasDeviceHeight(){return this._runtime.GetCanvasManager().GetDeviceHeight()},Downlink:()=>navigator.connection&&navigator.connection.downlink||0,DownlinkMax:()=>navigator.connection&&navigator.connection.downlinkMax||0,ConnectionType:()=>navigator.connection&&navigator.connection.type||"unknown",ConnectionEffectiveType:()=>navigator.connection&&navigator.connection.effectiveType||"unknown",ConnectionRTT:()=>navigator.connection&&navigator.connection.rtt||0,HardwareConcurrency:()=>navigator.hardwareConcurrency||0,DeviceMemory:()=>navigator.deviceMemory||0,SafeAreaInsetTop(){return this._safeAreaInset[0]},SafeAreaInsetRight(){return this._safeAreaInset[1]},SafeAreaInsetBottom(){return this._safeAreaInset[2]},SafeAreaInsetLeft(){return this._safeAreaInset[3]},FramesPerSecond(){return this._runtime.GetFramesPerSecond()},TicksPerSecond(){return this._runtime.GetTicksPerSecond()}};{const WR=self.C3;WR.Plugins.Tilemap=class extends WR.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}},WR.Plugins.Tilemap.TILE_FLIPPED_HORIZONTAL=-2147483648,WR.Plugins.Tilemap.TILE_FLIPPED_VERTICAL=1073741824,WR.Plugins.Tilemap.TILE_FLIPPED_DIAGONAL=536870912,WR.Plugins.Tilemap.TILE_FLAGS_MASK=3758096384,WR.Plugins.Tilemap.TILE_ID_MASK=536870911}{const UR=self.C3,VR=UR.Plugins.Tilemap.TILE_FLIPPED_HORIZONTAL,HR=UR.Plugins.Tilemap.TILE_FLIPPED_VERTICAL,jR=UR.Plugins.Tilemap.TILE_FLIPPED_DIAGONAL,zR=UR.Plugins.Tilemap.TILE_ID_MASK;UR.Plugins.Tilemap.Type=class extends UR.SDKTypeBase{constructor(e){super(e),this._tilePolys=[],this._areTilePolysCached=!1,this._maxTileIndex=0,this._brushesData=[],this._nameToIndexMap=null}Release(){this._nameToIndexMap.clear(),this._nameToIndexMap=null,super.Release()}OnCreate(){this.GetImageInfo().LoadAsset(this._runtime)}LoadTextures(e){return this.GetImageInfo().LoadStaticTexture(e,{sampling:this._runtime.GetSampling()})}ReleaseTextures(){this.GetImageInfo().ReleaseTexture()}OnDynamicTextureLoadComplete(){for(const e of this.GetObjectClass().instancesIncludingPendingCreate())e.GetSdkInstance()._OnDynamicTextureLoadComplete()}LoadTilemapData(e,t,s){this._maxTileIndex=t;for(const t of e)if(t){const e=t[0],s=!!t[1];this._tilePolys.push({poly:e,use:s,flipmap:[[[null,null],[null,null]],[[null,null],[null,null]]]})}else this._tilePolys.push(null);for(const e of s){const t=e[0],s=e[1],i=e[2];this._brushesData.push({name:t,type:s,tileData:i})}}_ForceCacheOfTileCollisionPolys(e,t){this._areTilePolysCached=!1,this._MaybeCacheTileCollisionPolys(e,t)}_MaybeCacheTileCollisionPolys(e,t){if(!this._areTilePolysCached){this._areTilePolysCached=!0;for(let s=0,i=this._tilePolys.length;s<i;++s)this._tilePolys[s]&&(this._CacheTilePoly(s,e,t,!1,!1,!1),this._CacheTilePoly(s,e,t,!1,!1,!0),this._CacheTilePoly(s,e,t,!1,!0,!1),this._CacheTilePoly(s,e,t,!1,!0,!0),this._CacheTilePoly(s,e,t,!0,!1,!1),this._CacheTilePoly(s,e,t,!0,!1,!0),this._CacheTilePoly(s,e,t,!0,!0,!1),this._CacheTilePoly(s,e,t,!0,!0,!0))}}_CacheTilePoly(e,t,s,i,r,n){if(e<0||e>=this._tilePolys.length)return;const a=this._tilePolys[e];if(!a)return;const o=UR.New(UR.CollisionPoly,a.poly,a.use);o.transform(t,s,0),n&&o.diag(),i&&o.mirror(t/2),r&&o.flip(s/2),a.flipmap[i?1:0][r?1:0][n?1:0]=null,a.flipmap[i?1:0][r?1:0][n?1:0]=o}GetTilePoly(e){if(-1===e)return null;const t=e&zR;if(t<0||t>=this._tilePolys.length)return null;const s=this._tilePolys[t];if(!s)return null;const i=e&VR?1:0,r=e&HR?1:0,n=e&jR?1:0;return s.flipmap[i][r][n]}IsTilePolyEnabled(e){return!e||e.IsEnabled()}GetMaxTileIndex(){return this._maxTileIndex}GetBrushData(e){this._nameToIndexMap||(this._nameToIndexMap=new Map);const t=this._nameToIndexMap.get(e);if("number"==typeof t&&t>=0)return this._brushesData[t];for(let t=0;t<this._brushesData.length;t++)if(this._brushesData[t].name===e)return this._nameToIndexMap.set(e,t),this._brushesData[t]}}}{let XR=function(e){const t=[],s=e.split(",");for(let e=0,i=s.length;e<i;++e){const i=s[e],r=i.indexOf("x");if(r>-1){let e=parseInt(i.substring(0,r),10);const s=i.substring(r+1);let n=parseInt(s,10);for(s.includes("h")&&(n|=sv),s.includes("v")&&(n|=iv),s.includes("d")&&(n|=rv);e>0;--e)t.push(n)}else{let e=parseInt(i,10);i.includes("h")&&(e|=sv),i.includes("v")&&(e|=iv),i.includes("d")&&(e|=rv),t.push(e)}}return t};RunLengthDecode=XR;const YR=self.C3,qR=self.C3X,KR=0,$R=1,JR=2,ZR=3,QR=4,ev=5,tv=6,sv=YR.Plugins.Tilemap.TILE_FLIPPED_HORIZONTAL,iv=YR.Plugins.Tilemap.TILE_FLIPPED_VERTICAL,rv=YR.Plugins.Tilemap.TILE_FLIPPED_DIAGONAL,nv=YR.Plugins.Tilemap.TILE_FLAGS_MASK,av=YR.Plugins.Tilemap.TILE_ID_MASK,ov=YR.New(YR.Rect),hv=YR.New(YR.Rect),lv=YR.New(YR.Rect);YR.Plugins.Tilemap.Instance=class extends YR.SDKWorldInstanceBase{constructor(e,t){super(e);const s=this.GetWorldInfo();this._tileWidth=32,this._tileHeight=32,this._tileXoffset=0,this._tileYoffset=0,this._tileXspacing=0,this._tileYspacing=0,this._mapWidth=0,this._mapHeight=0,this._lastWidth=s.GetWidth(),this._lastHeight=s.GetHeight(),this._cellWidth=0,this._cellHeight=0,this._tileCells=[],this._tileTexQuads=new Map,this._isAnyQuadMapChanged=!0,this._ownImageInfo=null,t&&(s.SetVisible(t[KR]),this._tileWidth=Math.max(t[$R],1),this._tileHeight=Math.max(t[JR],1),this._tileXoffset=t[ZR],this._tileYoffset=t[QR],this._tileXspacing=t[ev],this._tileYspacing=t[tv]),this._cellWidth=Math.ceil(this._runtime.GetOriginalViewportWidth()/this._tileWidth),this._cellHeight=Math.ceil(this._runtime.GetOriginalViewportHeight()/this._tileHeight),this._sdkType._MaybeCacheTileCollisionPolys(this._tileWidth,this._tileHeight),this._brushManager=null}Release(){this._ReleaseOwnImage(),YR.clearArray(this._tileCells),this._tileCells=null,this._tileTexQuads.clear(),this._tileTexQuads=null,super.Release()}_ReleaseOwnImage(){this._ownImageInfo&&(this._ownImageInfo.Release(),this._ownImageInfo=null)}LoadTilemapData(e,t,s){this._mapWidth=t,this._mapHeight=s,this._MaybeResizeTilemap(!0),this.SetTilesFromRLECSV(e),this._MaybeBuildAllQuadMap()}_MaybeResizeTilemap(e){const[t,s]=this.GetMapDisplaySize();if(t<=this._mapWidth&&s<=this._mapHeight&&!e)return;let i=0,r=0;e?(i=Math.ceil(this._mapHeight/this._cellHeight),r=Math.ceil(this._mapWidth/this._cellWidth)):(i=this._tileCells.length,r=Math.ceil(this._mapWidth/this._cellWidth),s>this._mapHeight&&(this._mapHeight=s,i=Math.ceil(this._mapHeight/this._cellHeight)),t>this._mapWidth&&(this._mapWidth=t,r=Math.ceil(this._mapWidth/this._cellWidth)),this._SetAllQuadMapChanged(),this._SetPhysicsChanged(),this._runtime.UpdateRender());const n=this._tileCells;if(n.length<i)for(let e=n.length;e<i;++e)n.push([]);for(let e=0;e<i;++e){const t=n[e];for(let s=t.length;s<r;++s)t.push(YR.New(YR.Plugins.Tilemap.TileCell,this,s,e))}}SetTilesFromRLECSV(e){const t=XR(e);let s=0;const i=this._mapWidth,r=this._cellWidth,n=this._cellHeight;for(let e=0,a=this._mapHeight;e<a;++e)for(let a=0;a<i;++a){const i=t[s++],o=this.GetCellAt(a,e);o&&o.SetTileAt(a%r,e%n,i)}}GetTilesAsRLECSV(){let e="";if(this._mapWidth<=0||this._mapHeight<=0)return e;let t=1,s=this.GetTileAt(0,0);const[i,r]=this.GetMapDisplaySize();let n=-1,a=!1,o=!1,h=!1;for(let l=0;l<r;++l)for(let r=0===l?1:0;r<i;++r){const i=this.GetTileAt(r,l);i===s?++t:(-1===s?(n=-1,a=!1,o=!1,h=!1):(n=s&av,a=0!==(s&sv),o=0!==(s&iv),h=0!==(s&rv)),e+=1===t?""+n:t+"x"+n,a&&(e+="h"),o&&(e+="v"),h&&(e+="d"),e+=",",t=1,s=i)}return-1===s?(n=-1,a=!1,o=!1,h=!1):(n=s&av,a=0!==(s&sv),o=0!==(s&iv),h=0!==(s&rv)),e+=1===t?""+n:t+"x"+n,a&&(e+="h"),o&&(e+="v"),h&&(e+="d"),e}_SetAllQuadMapChanged(){const e=this._tileCells;for(let t=0,s=e.length;t<s;++t){const s=e[t];for(let e=0,t=s.length;e<t;++e)s[e]._SetQuadMapChanged()}this._isAnyQuadMapChanged=!0}_MaybeBuildAllQuadMap(){if(!this._isAnyQuadMapChanged)return;this._isAnyQuadMapChanged=!1;const e=this._tileCells;for(let t=0,s=e.length;t<s;++t){const s=e[t];for(let e=0,t=s.length;e<t;++e)s[e].MaybeBuildQuadMap()}}SetTileChanged(){this._isAnyQuadMapChanged=!0,this._SetPhysicsChanged(),this._runtime.UpdateRender()}_SetPhysicsChanged(){this.GetWorldInfo().SetPhysicsBodyChanged(!0)}GetCellAt(e,t){if(e<0||t<0)return null;const s=Math.floor(t/this._cellHeight);if(s>=this._tileCells.length)return null;const i=this._tileCells[s],r=Math.floor(e/this._cellWidth);return r>=i.length?null:i[r]}GetCellAtIndex(e,t){if(e<0||t<0||t>=this._tileCells.length)return null;const s=this._tileCells[t];return e>=s.length?null:s[e]}GetTileAt(e,t){if(e=Math.floor(e),t=Math.floor(t),e<0||t<0||e>=this._mapWidth||t>=this._mapHeight)return-1;const s=this.GetCellAt(e,t);return s?s.GetTilesArr()[t%this._cellHeight][e%this._cellWidth]:-1}SetTileAt(e,t,s){if(e=Math.floor(e),t=Math.floor(t),e<0||t<0||e>=this._mapWidth||t>=this._mapHeight)return;if(-1!==s&&(s&av)>this.GetMaxTileIndex())return;const i=this.GetCellAt(e,t);i&&i.SetTileAt(e%this._cellWidth,t%this._cellHeight,s)}GetMaxTileIndex(){return this._sdkType.GetMaxTileIndex()}WorldToCellX(e){return Math.floor((e-this.GetWorldInfo().GetX())/(this._cellWidth*this._tileWidth))}WorldToCellY(e){return Math.floor((e-this.GetWorldInfo().GetY())/(this._cellHeight*this._tileHeight))}WorldToTileX(e){return Math.floor((e-this.GetWorldInfo().GetX())/this._tileWidth)}WorldToTileY(e){return Math.floor((e-this.GetWorldInfo().GetY())/this._tileHeight)}GetMapWidth(){return this._mapWidth}GetMapHeight(){return this._mapHeight}GetMapDisplayWidth(){return Math.floor(this.GetWorldInfo().GetWidth()/this.GetTileWidth())}GetMapDisplayHeight(){return Math.floor(this.GetWorldInfo().GetHeight()/this.GetTileHeight())}GetMapDisplaySize(){const e=this.GetWorldInfo();return[Math.floor(e.GetWidth()/this.GetTileWidth()),Math.floor(e.GetHeight()/this.GetTileHeight())]}GetTileWidth(){return this._tileWidth}GetTileHeight(){return this._tileHeight}GetCellWidth(){return this._cellWidth}GetCellHeight(){return this._cellHeight}GetCollisionRectCandidates(e,t){const s=this.WorldToCellX(e.getLeft()),i=this.WorldToCellY(e.getTop()),r=this.WorldToCellX(e.getRight()),n=this.WorldToCellY(e.getBottom());for(let e=s;e<=r;++e)for(let s=i;s<=n;++s){const i=this.GetCellAtIndex(e,s);i&&(i.MaybeBuildQuadMap(),YR.appendArray(t,i.GetCollisionRects()))}}TestPointOverlapTile(e,t){const s=this.WorldToTileX(e),i=this.WorldToTileY(t),r=this.GetTileAt(s,i);if(-1===r)return!1;const n=this._sdkType.GetTilePoly(r);if(!n)return!0;if(!this._sdkType.IsTilePolyEnabled(n))return!1;const a=this.GetWorldInfo();return e-=Math.floor((e-a.GetX())/this._tileWidth)*this._tileWidth+a.GetX(),t-=Math.floor((t-a.GetY())/this._tileHeight)*this._tileHeight+a.GetY(),n.containsPoint(e,t)}GetAllCollisionRects(e){const t=this._tileCells;for(let s=0,i=t.length;s<i;++s){const i=t[s];for(let t=0,s=i.length;t<s;++t){const s=i[t];s.MaybeBuildQuadMap(),YR.appendArray(e,s.GetCollisionRects())}}}GetCurrentImageInfo(){return this._ownImageInfo||this._objectClass.GetImageInfo()}GetTileUvQuad(e){const t=this._tileTexQuads,s=t.get(e);if(s)return s;const i=e&av,r=0!==(e&sv),n=0!==(e&iv),a=0!==(e&rv),o=this.GetCurrentImageInfo(),h=o.GetWidth(),l=this._tileWidth,c=this._tileXoffset,u=this._tileXspacing,d=Math.floor((h-c)/(l+u)*l)+u,_=Math.floor(d/l),p=i%_,f=Math.floor(i/_),m=o.GetOffsetX()+this._tileXoffset+(this._tileWidth+this._tileXspacing)*p,g=o.GetOffsetY()+this._tileYoffset+(this._tileHeight+this._tileYspacing)*f;ov.setWH(m,g,this._tileWidth,this._tileHeight),ov.divide(o.GetSheetWidth(),o.GetSheetHeight());const S=YR.New(YR.Quad);return S.setFromRect(ov),a&&S.diag(),r&&S.mirror(),n&&S.flip(),S.offset(p,f),t.set(e,S),S}_OnDynamicTextureLoadComplete(){this._tileTexQuads.clear(),this._SetAllQuadMapChanged()}Draw(e){const t=this.GetCurrentImageInfo(),s=t.GetTexture();if(!s)return;ov.copy(t.GetTexRect()),ov.offsetLeft(this._tileXoffset/s.GetWidth()),ov.offsetTop(this._tileYoffset/s.GetHeight()),e.SetTilemapFillMode(),e.SetTilemapInfo(ov,s.GetWidth(),s.GetHeight(),this._tileWidth,this._tileHeight,this._tileXspacing,this._tileYspacing),e.SetTexture(s);const i=this.GetWorldInfo(),r=i.GetLayer();i.GetWidth()===this._lastWidth&&i.GetHeight()===this._lastHeight||(this._SetPhysicsChanged(),this._SetAllQuadMapChanged(),this._lastWidth=i.GetWidth(),this._lastHeight=i.GetHeight());let n=i.GetX(),a=i.GetY();this._runtime.IsPixelRoundingEnabled()&&(n=Math.round(n),a=Math.round(a));const o=this._cellWidth*this._tileWidth,h=this._cellHeight*this._tileHeight,l=i.GetTotalZElevation(),c=hv;if(r.Has3DCamera()){c.set(-1/0,-1/0,1/0,1/0);const t=lv,s=r._GetViewFrustum();for(const i of this._tileCells)for(const r of i)r.GetLayoutRect(t),s.ContainsAABB(t.getLeft(),t.getTop(),l,t.getRight(),t.getBottom(),l)&&(r.MaybeBuildQuadMap(),r.Draw(e,c,n,a))}else{r.GetViewportForZ(l,c);const t=Math.floor((c.getLeft()-n)/o),s=Math.floor((c.getRight()-n)/o),i=Math.floor((c.getTop()-a)/h),u=Math.floor((c.getBottom()-a)/h);for(let r=t;r<=s;++r)for(let t=i;t<=u;++t){const s=this.GetCellAtIndex(r,t);s&&(s.MaybeBuildQuadMap(),s.Draw(e,c,n,a))}}}SaveToJson(){this._MaybeResizeTilemap();const[e,t]=this.GetMapDisplaySize();return{tw:this._tileWidth,th:this._tileHeight,tox:this._tileXoffset,toy:this._tileYoffset,tsx:this._tileXspacing,tsy:this._tileYspacing,w:e,h:t,d:this.GetTilesAsRLECSV()}}LoadFromJson(e){this._tileWidth=e.tw,this._tileHeight=e.th,this._tileXoffset=e.tox,this._tileYoffset=e.toy,this._tileXspacing=e.tsx,this._tileYspacing=e.tsy,this._mapWidth=e.w,this._mapHeight=e.h,this._MaybeResizeTilemap(!0),this.SetTilesFromRLECSV(e.d),this._SetPhysicsChanged(),this._SetAllQuadMapChanged()}GetAsJsonString(){this._MaybeResizeTilemap();const[e,t]=this.GetMapDisplaySize();return JSON.stringify({c2tilemap:!0,width:e,height:t,data:this.GetTilesAsRLECSV()})}StateComboToFlags(e){switch(e){case 0:default:return 0;case 1:return sv;case 2:return iv;case 3:return sv|rv;case 4:return sv|iv;case 5:return iv|rv;case 6:return sv|iv|rv;case 7:return rv}}GetPropertyValueByIndex(e){switch(e){case $R:return this._tileWidth;case JR:return this._tileHeight;case ZR:return this._tileXoffset;case QR:return this._tileYoffset;case ev:return this._tileXspacing;case tv:return this._tileYspacing}}SetPropertyValueByIndex(e,t){switch(e){case $R:if(this._tileWidth===t)return;this._tileWidth=Math.max(t,1),this._cellWidth=Math.ceil(this._runtime.GetOriginalViewportWidth()/this._tileWidth),this._sdkType._ForceCacheOfTileCollisionPolys(),this._UpdateQuadMaps();break;case JR:if(this._tileHeight===t)return;this._tileHeight=Math.max(t,1),this._cellHeight=Math.ceil(this._runtime.GetOriginalViewportHeight()/this._tileHeight),this._sdkType._ForceCacheOfTileCollisionPolys(),this._UpdateQuadMaps();break;case ZR:if(this._tileXoffset===t)return;this._tileXoffset=t,this._UpdateQuadMaps();break;case QR:if(this._tileYoffset===t)return;this._tileYoffset=t,this._UpdateQuadMaps();break;case ev:if(this._tileXspacing===t)return;this._tileXspacing=t,this._UpdateQuadMaps();break;case tv:if(this._tileYspacing===t)return;this._tileYspacing=t,this._UpdateQuadMaps()}}_UpdateQuadMaps(){this._tileTexQuads.clear(),this._SetAllQuadMapChanged(),this._MaybeBuildAllQuadMap()}GetScriptInterfaceClass(){return uv}};const cv=new WeakMap,uv=self.ITilemapInstance=class extends self.IWorldInstance{constructor(){super(),cv.set(this,self.IInstance._GetInitInst().GetSdkInstance())}get mapWidth(){return cv.get(this).GetMapWidth()}get mapHeight(){return cv.get(this).GetMapHeight()}getMapSize(){const e=cv.get(this);return[e.GetMapWidth(),e.GetMapHeight()]}get mapDisplayWidth(){return cv.get(this).GetMapDisplayWidth()}get mapDisplayHeight(){return cv.get(this).GetMapDisplayHeight()}getMapDisplaySize(){const e=cv.get(this);return[e.GetMapDisplayWidth(),e.GetMapDisplayHeight()]}get tileWidth(){return cv.get(this).GetTileWidth()}get tileHeight(){return cv.get(this).GetTileHeight()}getTileSize(){const e=cv.get(this);return[e.GetTileWidth(),e.GetTileHeight()]}getTileAt(e,t){return qR.RequireFiniteNumber(e),qR.RequireFiniteNumber(t),cv.get(this).GetTileAt(e,t)}setTileAt(e,t,s){qR.RequireFiniteNumber(e),qR.RequireFiniteNumber(t),qR.RequireFiniteNumber(s);const i=cv.get(this);i._MaybeResizeTilemap(),i.SetTileAt(e,t,s)}async replaceImage(e){qR.RequireInstanceOf(e,Blob);const t=cv.get(this),s=t.GetRuntime(),i=YR.New(YR.ImageInfo);i.LoadDynamicBlobAsset(s,e),await i.LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling()}),t.WasReleased()?i.Release():(t._ReleaseOwnImage(),t._ownImageInfo=i,t._tileTexQuads.clear(),t._SetAllQuadMapChanged(),s.UpdateRender())}};uv.TILE_FLIPPED_HORIZONTAL=sv,uv.TILE_FLIPPED_VERTICAL=iv,uv.TILE_FLIPPED_DIAGONAL=rv,uv.TILE_FLAGS_MASK=nv,uv.TILE_ID_MASK=av}{const dv=self.C3,_v=dv.Plugins.Tilemap.TILE_FLAGS_MASK,pv=dv.Plugins.Tilemap.TILE_ID_MASK;dv.Plugins.Tilemap.Cnds={CompareTileAt(e,t,s,i){let r=this.GetTileAt(e,t);return-1!==r&&(r&=pv),dv.compare(r,s,i)},CompareTileStateAt(e,t,s){const i=this.GetTileAt(e,t);let r=0;return-1!==i&&(r=i&_v),r===this.StateComboToFlags(s)},OnURLLoaded:()=>!0,OnURLFailed:()=>!0,BrushExists(e){return this._brushManager||(this._brushManager=new dv.Plugins.Tilemap.BrushManager(this,this._sdkType)),this._brushManager.BrushExists(e)}}}{const fv=self.C3,mv=fv.Plugins.Tilemap.TILE_ID_MASK;fv.Plugins.Tilemap.Acts={EraseTile(e,t){this._MaybeResizeTilemap(),this.SetTileAt(e,t,-1)},SetTile(e,t,s,i){this._MaybeResizeTilemap(),this.SetTileAt(e,t,s&mv|this.StateComboToFlags(i))},SetTileState(e,t,s){const i=this.GetTileAt(e,t);-1!==i&&(this._MaybeResizeTilemap(),this.SetTileAt(e,t,i&mv|this.StateComboToFlags(s)))},EraseTileRange(e,t,s,i){const r=Math.floor(Math.max(e,0)),n=Math.floor(Math.max(t,0)),a=Math.floor(Math.min(e+s,this._mapWidth)),o=Math.floor(Math.min(t+i,this._mapHeight));for(let e=n;e<o;++e)for(let t=r;t<a;++t)this.SetTileAt(t,e,-1)},SetTileRange(e,t,s,i,r,n){this._MaybeResizeTilemap();const a=Math.floor(Math.max(e,0)),o=Math.floor(Math.max(t,0)),h=Math.floor(Math.min(e+s,this._mapWidth)),l=Math.floor(Math.min(t+i,this._mapHeight)),c=r&mv|this.StateComboToFlags(n);for(let e=o;e<l;++e)for(let t=a;t<h;++t)this.SetTileAt(t,e,c)},SetTileStateRange(e,t,s,i,r){this._MaybeResizeTilemap();const n=Math.floor(Math.max(e,0)),a=Math.floor(Math.max(t,0)),o=Math.floor(Math.min(e+s,this._mapWidth)),h=Math.floor(Math.min(t+i,this._mapHeight)),l=this.StateComboToFlags(r);for(let e=a;e<h;++e)for(let t=n;t<o;++t){const s=this.GetTileAt(t,e);-1!==s&&this.SetTileAt(t,e,s&mv|l)}},LoadFromJSON(e){let t=null;try{t=JSON.parse(e)}catch(e){return void console.error("[Construct] Failed to parse tilemap JSON: ",e)}t.c2tilemap?(this._mapWidth=t.width,this._mapHeight=t.height,this._MaybeResizeTilemap(!0),this.SetTilesFromRLECSV(t.data),this._SetAllQuadMapChanged(),this._SetPhysicsChanged()):console.error("[Construct] Unrecognized JSON data format")},JSONDownload(e){const t=URL.createObjectURL(new Blob([this.GetAsJsonString()],{type:"application/json"}));this._runtime.InvokeDownload(t,e)},async LoadURL(e,t){if(this._ownImageInfo&&this._ownImageInfo.GetURL()===e)return;const s=this._runtime,i=fv.New(fv.ImageInfo);try{if(await i.LoadDynamicAsset(s,e),!i.IsLoaded())throw new Error("image failed to load");if(this.WasReleased())return i.Release(),null;if(!await i.LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling()}))return}catch(e){return console.error("Load image from URL failed: ",e),void(this.WasReleased()||this.Trigger(fv.Plugins.Tilemap.Cnds.OnURLFailed))}this.WasReleased()?i.Release():(this._ReleaseOwnImage(),this._ownImageInfo=i,s.UpdateRender(),this._tileTexQuads.clear(),this._SetAllQuadMapChanged(),await this.TriggerAsync(fv.Plugins.Tilemap.Cnds.OnURLLoaded))},SetEffect(e){e>=2&&e++,this.GetWorldInfo().SetBlendMode(e),this._runtime.UpdateRender()},SetTileWithBrush(e,t,s){if(this._MaybeResizeTilemap(),this._brushManager||(this._brushManager=new fv.Plugins.Tilemap.BrushManager(this,this._sdkType)),this._brushManager.BrushExists(s))switch(this._brushManager.GetBrushType(s)){case 0:case 1:this._brushManager.SetAutoTile(e,t,s);break;case 2:this._brushManager.SetPatchTile(e,t,s)}},SetTileWithPatchBrush(e,t,s,i,r,n,a){this._MaybeResizeTilemap(),this._brushManager||(this._brushManager=new fv.Plugins.Tilemap.BrushManager(this,this._sdkType)),this._brushManager.BrushExists(s)&&2===this._brushManager.GetBrushType(s)&&this._brushManager.SetPatchTile(e,t,s,i,r,n,a)},EraseTileWithBrush(e,t,s){if(this._MaybeResizeTilemap(),this._brushManager||(this._brushManager=new fv.Plugins.Tilemap.BrushManager(this,this._sdkType)),this._brushManager.BrushExists(s))switch(this._brushManager.GetBrushType(s)){case 0:case 1:this._brushManager.EraseAutoTile(e,t,s);break;case 2:this._brushManager.ErasePatchTile(e,t,s)}},EraseTileWithPatchBrush(e,t,s,i,r,n){this._MaybeResizeTilemap(),this._brushManager||(this._brushManager=new fv.Plugins.Tilemap.BrushManager(this,this._sdkType)),this._brushManager.BrushExists(s)&&2===this._brushManager.GetBrushType(s)&&this._brushManager.ErasePatchTile(e,t,s,i,r,n)},SetTileWithPatchBrushByName(e,t,s,i,r,n,a){fv.Plugins.Tilemap.Acts.SetTileWithPatchBrush.call(this,e,t,s,i,r,n,a)},EraseTileWithPatchBrushByName(e,t,s,i,r,n){fv.Plugins.Tilemap.Acts.EraseTileWithPatchBrush.call(this,e,t,s,i,r,n)},SetTileWithBrushByName(e,t,s){fv.Plugins.Tilemap.Acts.SetTileWithBrush.call(this,e,t,s)},EraseTileWithBrushByName(e,t,s){fv.Plugins.Tilemap.Acts.EraseTileWithBrush.call(this,e,t,s)}}}{const gv=self.C3,Sv=gv.Plugins.Tilemap.TILE_ID_MASK;gv.Plugins.Tilemap.Exps={TileAt(e,t){const s=this.GetTileAt(e,t);return-1===s?-1:s&Sv},PositionToTileX(e){return this.WorldToTileX(e)},PositionToTileY(e){return this.WorldToTileY(e)},TileToPositionX(e){return e*this._tileWidth+this.GetWorldInfo().GetX()+this._tileWidth/2},TileToPositionY(e){return e*this._tileHeight+this.GetWorldInfo().GetY()+this._tileHeight/2},SnapX(e){const t=this.GetWorldInfo().GetX();return Math.floor((e-t)/this._tileWidth)*this._tileWidth+t+this._tileWidth/2},SnapY(e){const t=this.GetWorldInfo().GetY();return Math.floor((e-t)/this._tileHeight)*this._tileHeight+t+this._tileHeight/2},TilesJSON(){return this.GetAsJsonString()},TileWidth(){return this.GetTileWidth()},TileHeight(){return this.GetTileHeight()},MapDisplayWidth(){return this.GetMapDisplayWidth()},MapDisplayHeight(){return this.GetMapDisplayHeight()},BrushWidth(e){return this._brushManager||(this._brushManager=new gv.Plugins.Tilemap.BrushManager(this,this._sdkType)),this._brushManager.BrushExists(e)&&2===this._brushManager.GetBrushType(e)?this._brushManager.GetBrushWidth(e):0},BrushHeight(e){return this._brushManager||(this._brushManager=new gv.Plugins.Tilemap.BrushManager(this,this._sdkType)),this._brushManager.BrushExists(e)&&2===this._brushManager.GetBrushType(e)?this._brushManager.GetBrushHeight(e):0}}}{const Gv=self.C3,yv=Gv.Plugins.Tilemap.TILE_FLIPPED_HORIZONTAL,Iv=Gv.Plugins.Tilemap.TILE_FLIPPED_VERTICAL,Tv=Gv.Plugins.Tilemap.TILE_FLIPPED_DIAGONAL,Cv=Gv.Plugins.Tilemap.TILE_ID_MASK,bv=Gv.New(Gv.Rect),xv=Gv.New(Gv.Quad);Gv.Plugins.Tilemap.TileQuad=class extends Gv.DefendedBase{constructor(){super(),this._id=-1,this._tileId=-1,this._isHorizFlip=!1,this._isVertFlip=!1,this._isDiagFlip=!1,this._rc=Gv.New(Gv.Rect),this._uv=null}Update(e,t,s,i,r,n,a,o){this._id=e,this._tileId=e&Cv,this._isHorizFlip=0!==(e&yv),this._isVertFlip=0!==(e&Iv),this._isDiagFlip=0!==(e&Tv),this._rc.setWH(i*t+n,r*s+a,t,s),this._uv=o.GetTileUvQuad(this._id)}Draw(e,t,s,i,r){bv.copy(this._rc),bv.offset(s,i),bv.intersectsRect(t)&&(xv.setFromRect(bv),e.Quad4(xv,this._uv))}}}{const wv=self.C3;wv.Plugins.Tilemap.TileCollisionRect=class extends wv.DefendedBase{constructor(){super(),this._id=-1,this._poly=null,this._rc=wv.New(wv.Rect)}Update(e,t,s,i,r,n,a,o){this._id=e,this._poly=t,this._rc.setWH(r*s+a,n*i+o,s,i)}ExtendRight(e){this._rc.setRight(this._rc.getRight()+e)}GetTileId(){return this._id}HasPoly(){return!!this._poly}GetPoly(){return this._poly}GetRect(){return this._rc}}}{const Pv=self.C3,Rv=Pv.Plugins.Tilemap.TILE_ID_MASK;Pv.Plugins.Tilemap.TileCell=class extends Pv.DefendedBase{constructor(e,t,s){super();const i=e.GetCellWidth(),r=e.GetCellHeight();this._sdkInst=e,this._x=t,this._y=s,this._left=this._x*i*e.GetTileWidth(),this._top=this._y*r*e.GetTileHeight(),this._tiles=[],this._quads=[],this._collisionRects=[],this._isQuadMapValid=!1;for(let e=0;e<r;++e){const e=new Int32Array(i);e.fill(-1),this._tiles.push(e)}}Clear(){const e=this._sdkInst.GetCellWidth(),t=this._sdkInst.GetCellHeight(),s=this._tiles;if(s.length<t)for(let i=s.length;i<t;++i)s.push(new Int32Array(e));else s.length>t&&Pv.truncateArray(s,t);for(let t=0,i=s.length;t<i;++t){let i=s[t];i.length!==e&&(i=new Int32Array(e),s[t]=i),i.fill(-1)}}GetLayoutRect(e){const t=this._sdkInst,s=t.GetWorldInfo(),i=t.GetCellWidth()*t.GetTileWidth(),r=t.GetCellHeight()*t.GetTileHeight(),n=s.GetX()+this._left,a=s.GetY()+this._top;e.set(n,a,n+i,a+r)}_SetQuadMapChanged(){this._isQuadMapValid=!1}MaybeBuildQuadMap(){if(this._isQuadMapValid)return;const e=this._sdkInst,t=e.GetSdkType(),s=e.GetWorldInfo(),i=e.GetTileWidth(),r=e.GetTileHeight(),n=e.GetCellWidth(),a=e.GetCellHeight(),o=this._left,h=this._top;if(i<=0||r<=0)return;let l=Math.min(e.GetMapWidth(),Math.floor(s.GetWidth()/i)),c=Math.min(e.GetMapHeight(),Math.floor(s.GetHeight()/r));l-=o/i,c-=h/r,l>n&&(l=n),c>a&&(c=a);const u=this._tiles,d=this._quads;let _=0;for(let t=0;t<c;++t){const s=u[t];for(let n=0;n<l;++n){const a=s[n];if(-1===a)continue;let l=null;_<d.length?l=d[_]:(l=Pv.New(Pv.Plugins.Tilemap.TileQuad),d.push(l)),l.Update(a,i,r,n,t,o,h,e),++_}}_<d.length&&Pv.truncateArray(d,_);let p=null,f=!1;const m=this._collisionRects;Pv.clearArray(m);for(let e=0;e<c;++e){const s=u[e];for(let n=0;n<l;++n){const a=s[n],l=t.GetTilePoly(a),c=t.IsTilePolyEnabled(l);-1!==a&&c?!p||l||f?(p&&m.push(p),p=Pv.New(Pv.Plugins.Tilemap.TileCollisionRect),p.Update(a,l,i,r,n,e,o,h),f=!!l):p.ExtendRight(i):p&&(m.push(p),p=null,f=!1)}p&&(m.push(p),p=null,f=!1)}let g=m.length;for(let e=0;e<g;++e){const t=m[e];if(t.HasPoly())continue;const s=t.GetRect();for(let t=e+1;t<g;++t){const e=m[t],i=e.GetRect();i.getTop()<s.getBottom()||i.getTop()>s.getBottom()||i.getRight()>s.getRight()||i.getLeft()>s.getLeft()||e.HasPoly()||i.getLeft()===s.getLeft()&&i.getRight()===s.getRight()&&(m.splice(t,1),--g,s.setBottom(s.getBottom()+r),--t)}}this._isQuadMapValid=!0}SetTileAt(e,t,s){this._tiles[t][e]!==s&&(this._tiles[t][e]=s,this._isQuadMapValid=!1,this._sdkInst.SetTileChanged())}GetTilesArr(){return this._tiles}GetCollisionRects(){return this._collisionRects}Draw(e,t,s,i){const r=this._sdkInst,n=this._quads;for(let a=0,o=n.length;a<o;++a)n[a].Draw(e,t,s,i,r)}}}{const vv=self.C3,Av=-999,Mv=-998,Dv=-1,Ev=0,Fv=1,Ov=Object.freeze([[0,0,0],[0,0,0],[0,0,0]]);vv.Plugins.Tilemap.BrushManager=class{constructor(e,t){this._sdkInst=e,this._sdkType=t,this._brushAdapterInstances=[null,null,null],this._brushAdapterConstructors=[vv.Plugins.Tilemap.AutoTiling16,vv.Plugins.Tilemap.AutoTiling47,vv.Plugins.Tilemap.Patch],this._probabilityTable=new vv.ProbabilityTable}get AUTO_TILING_PATCH(){return Ov}get IGNORE_INDEX(){return-999}get FORCE_INDEX(){return-998}get EMPTY_INDEX(){return-1}get PAINT_MODE(){return 0}get ERASE_MODE(){return 1}GetSdkIntance(){return this._sdkInst}GetSdkType(){return this._sdkType}GetProbabilityTable(){return this._probabilityTable}GetBrushWidth(e){return this.BrushExists(e)?this._GetBrushWidth(e):0}GetBrushHeight(e){return this.BrushExists(e)?this._GetBrushHeight(e):0}SetAutoTile(e,t,s){this.BrushExists(s)&&(this._SetMode(s,0),this._SetAutoTilePatch(e,t,this._GetPatch(e,t,s)))}EraseAutoTile(e,t,s){this.BrushExists(s)&&(this._SetMode(s,1),this._EraseTile(e,t),this._SetAutoTilePatch(e,t,this._GetPatch(e,t,s)))}SetPatchTile(e,t,s,i,r,n,a){this.BrushExists(s)&&(this._SetMode(s,0),this._SetTilePatch(e,t,s,this._GetPatch(e,t,s),i,r,n,a,0))}ErasePatchTile(e,t,s,i,r,n){this.BrushExists(s)&&(this._SetMode(s,1),this._SetTilePatch(e,t,s,this._GetPatch(e,t,s),i,r,n,0,1))}GetBrushType(e){return this._GetBrushType(e)}BrushExists(e){return!!this.GetSdkType().GetBrushData(e)}GetTile(e,t){return this.GetSdkIntance().GetTileAt(e,t)}_SetTile(e,t,s){this.GetSdkIntance().SetTileAt(e,t,s)}_EraseTile(e,t){this.GetSdkIntance().SetTileAt(e,t,-1)}_SetAutoTilePatch(e,t,s){s&&(this._SetTile(e-1,t-1,s[0][0]),this._SetTile(e,t-1,s[1][0]),this._SetTile(e+1,t-1,s[2][0]),this._SetTile(e-1,t,s[0][1]),this._SetTile(e,t,s[1][1]),this._SetTile(e+1,t,s[2][1]),this._SetTile(e-1,t+1,s[0][2]),this._SetTile(e,t+1,s[1][2]),this._SetTile(e+1,t+1,s[2][2]))}_SetTilePatch(e,t,s,i,r=!1,n=!1,a=0,o=0,h=0){if(!i)return;const l=(i=this._TransformPatch(i,s,r,n,a,o,h))[0].length,c=i.length;for(let s=0;s<c;s++)for(let r=0;r<l;r++)if(i[s][r]!==this.IGNORE_INDEX)switch(o){case 0:i[s][r]===this.EMPTY_INDEX?this._EraseTile(e+r,t+s):this._SetTile(e+r,t+s,i[s][r]);break;case 1:-1!==i[s][r]&&this._SetTile(e+r,t+s,i[s][r])}}_GetBrushType(e){return this.GetSdkType().GetBrushData(e).type}_MaybeCreateBrushAdapter(e){const t=this._GetBrushType(e);this._brushAdapterInstances[t]||(this._brushAdapterInstances[t]=new this._brushAdapterConstructors[t](this))}_SetMode(e,t){this._MaybeCreateBrushAdapter(e);const s=this._GetBrushType(e);this._brushAdapterInstances[s]&&this._brushAdapterInstances[s].SetMode(t)}_GetMode(e){this._MaybeCreateBrushAdapter(e);const t=this._GetBrushType(e);if(this._brushAdapterInstances[t])return this._brushAdapterInstances[t].GetMode()}_GetPatch(e,t,s){this._MaybeCreateBrushAdapter(s);const i=this.GetSdkType().GetBrushData(s);if(this._brushAdapterInstances[i.type])return this._brushAdapterInstances[i.type].BuildPatch(e,t,i)}_TransformPatch(e,t,s=!1,i=!1,r=0,n=0,a=0){this._MaybeCreateBrushAdapter(t);const o=this.GetSdkType().GetBrushData(t);if(this._brushAdapterInstances[o.type])return this._brushAdapterInstances[o.type].TransformPatch(e,s,i,r,n,a)}_GetBrushWidth(e){this._MaybeCreateBrushAdapter(e);const t=this.GetSdkType().GetBrushData(e);if(this._brushAdapterInstances[t.type])return this._brushAdapterInstances[t.type].GetBrushWidth(t)}_GetBrushHeight(e){this._MaybeCreateBrushAdapter(e);const t=this.GetSdkType().GetBrushData(e);if(this._brushAdapterInstances[t.type])return this._brushAdapterInstances[t.type].GetBrushHeight(t)}}}{const Bv=self.C3;Bv.Plugins.Tilemap.AutoTilingHelper=class{constructor(e){this._manager=e}DoesTileExist(e,t,s){const i=this._manager.GetTile(e,t);return!!this.IsTileValid(i,!0,i,s)}IsTileValid(e,t,s,i){return e===this._manager.EMPTY_INDEX?0:t&&e===this._manager.FORCE_INDEX?1:t&&i&&!this._IsTileIndexInBrush(s,i)?0:1}GetTileIndex(e,t,s,i){const r=i.tileData[e];if(!r.length)return this._manager.EMPTY_INDEX;if(1===r.length)return r[0][0];const n=this._manager.GetTile(t,s);if(this.IsTileValid(n)&&r.some(e=>n===e[0]))return n;const a=this._manager.GetProbabilityTable();a.Clear();for(let[e,t]of r)e>this._manager.GetSdkIntance().GetMaxTileIndex()||("number"!=typeof t&&(t=1),a.AddItem(t,e));return a.Sample()}_IsTileIndexInBrush(e,t){for(const s of t.tileData)for(const[t]of s)if(t===e)return!0;return!1}}}{const kv=self.C3;kv.Plugins.Tilemap.AutoTiling16=class{constructor(e){this._manager=e,this._helper=new kv.Plugins.Tilemap.AutoTilingHelper(e),this._mode=e.PAINT_MODE}SetMode(e){this._mode=e}GetMode(){return this._mode}GetBrushWidth(e){return 0}GetBrushHeight(e){return 0}TransformPatch(e,t=!1,s=!1,i=0,r=0,n=0){return e}BuildPatch(e,t,s){return this._Build4BitAutoTilePatch(e,t,s)}_Build4BitAutoTilePatch(e,t,s){const i=this._mode===this._manager.PAINT_MODE?this._4BitAutoTiling(e,t,void 0,s):this._manager.EMPTY_INDEX,r=this._Get4BitAutoTile(e,t-1,"s",s),n=this._Get4BitAutoTile(e-1,t,"e",s),a=this._Get4BitAutoTile(e+1,t,"w",s),o=this._Get4BitAutoTile(e,t+1,"n",s),h=this._manager.AUTO_TILING_PATCH;return h[0][0]=this._manager.IGNORE_INDEX,h[1][0]=this._Get4BitTileIndex(r,e,t-1,s),h[2][0]=this._manager.IGNORE_INDEX,h[0][1]=this._Get4BitTileIndex(n,e-1,t,s),h[1][1]=this._Get4BitTileIndex(i,e,t,s),h[2][1]=this._Get4BitTileIndex(a,e+1,t,s),h[0][2]=this._manager.IGNORE_INDEX,h[1][2]=this._Get4BitTileIndex(o,e,t+1,s),h[2][2]=this._manager.IGNORE_INDEX,h}_Get4BitAutoTile(e,t,s,i){return this._helper.DoesTileExist(e,t,i)?this._4BitAutoTiling(e,t,s,i):this._manager.IGNORE_INDEX}_4BitAutoTiling(e,t,s,i){this._mode===this._manager.ERASE_MODE&&(s=void 0);const r=this._manager.GetTile(e,t-1),n=this._manager.GetTile(e-1,t),a=this._manager.GetTile(e+1,t),o=this._manager.GetTile(e,t+1),h="n"===s?this._manager.FORCE_INDEX:r,l="w"===s?this._manager.FORCE_INDEX:n,c="e"===s?this._manager.FORCE_INDEX:a,u="s"===s?this._manager.FORCE_INDEX:o;return 1*this._helper.IsTileValid(h,!0,r,i)+2*this._helper.IsTileValid(l,!0,n,i)+4*this._helper.IsTileValid(c,!0,a,i)+8*this._helper.IsTileValid(u,!0,o,i)}_Get4BitTileIndex(e,t,s,i){return e===this._manager.IGNORE_INDEX||e===this._manager.EMPTY_INDEX?e:this._helper.GetTileIndex(e,t,s,i)}}}{const Lv=self.C3,Nv=new Map([[2,1],[8,2],[10,3],[11,4],[16,5],[18,6],[22,7],[24,8],[26,9],[27,10],[30,11],[31,12],[64,13],[66,14],[72,15],[74,16],[75,17],[80,18],[82,19],[86,20],[88,21],[90,22],[91,23],[94,24],[95,25],[104,26],[106,27],[107,28],[120,29],[122,30],[123,31],[126,32],[127,33],[208,34],[210,35],[214,36],[216,37],[218,38],[219,39],[222,40],[223,41],[248,42],[250,43],[251,44],[254,45],[255,46],[0,47]]);Lv.Plugins.Tilemap.AutoTiling47=class{constructor(e){this._manager=e,this._helper=new Lv.Plugins.Tilemap.AutoTilingHelper(e),this._mode=e.PAINT_MODE}SetMode(e){this._mode=e}GetMode(){return this._mode}GetBrushWidth(e){return 0}GetBrushHeight(e){return 0}TransformPatch(e,t=!1,s=!1,i=0,r=0,n=0){return e}BuildPatch(e,t,s){return this._Build8BitAutoTilePatch(e,t,s)}_Build8BitAutoTilePatch(e,t,s){const i=this._mode===this._manager.PAINT_MODE?this._8BitAutoTiling(e,t,void 0,s):this._manager.EMPTY_INDEX,r=this._Get8BitAutoTile(e-1,t-1,"se",s),n=this._Get8BitAutoTile(e,t-1,"s",s),a=this._Get8BitAutoTile(e+1,t-1,"sw",s),o=this._Get8BitAutoTile(e-1,t,"e",s),h=this._Get8BitAutoTile(e+1,t,"w",s),l=this._Get8BitAutoTile(e-1,t+1,"ne",s),c=this._Get8BitAutoTile(e,t+1,"n",s),u=this._Get8BitAutoTile(e+1,t+1,"nw",s),d=this._manager.AUTO_TILING_PATCH;return d[0][0]=this._Get8BitTileIndex(r,e-1,t-1,s),d[1][0]=this._Get8BitTileIndex(n,e,t-1,s),d[2][0]=this._Get8BitTileIndex(a,e+1,t-1,s),d[0][1]=this._Get8BitTileIndex(o,e-1,t,s),d[1][1]=this._Get8BitTileIndex(i,e,t,s),d[2][1]=this._Get8BitTileIndex(h,e+1,t,s),d[0][2]=this._Get8BitTileIndex(l,e-1,t+1,s),d[1][2]=this._Get8BitTileIndex(c,e,t+1,s),d[2][2]=this._Get8BitTileIndex(u,e+1,t+1,s),d}_Get8BitAutoTile(e,t,s,i){return this._helper.DoesTileExist(e,t,i)?this._8BitAutoTiling(e,t,s,i):this._manager.IGNORE_INDEX}_8BitAutoTiling(e,t,s,i){this._mode===this._manager.ERASE_MODE&&(s=void 0);const r=this._manager.GetTile(e,t-1),n=this._manager.GetTile(e-1,t),a=this._manager.GetTile(e+1,t),o=this._manager.GetTile(e,t+1),h=this._manager.GetTile(e-1,t-1),l=this._manager.GetTile(e+1,t-1),c=this._manager.GetTile(e-1,t+1),u=this._manager.GetTile(e+1,t+1),d="n"===s?this._manager.FORCE_INDEX:r,_="w"===s?this._manager.FORCE_INDEX:n,p="e"===s?this._manager.FORCE_INDEX:a,f="s"===s?this._manager.FORCE_INDEX:o,m="nw"===s?this._manager.FORCE_INDEX:h,g="ne"===s?this._manager.FORCE_INDEX:l,S="sw"===s?this._manager.FORCE_INDEX:c,G="se"===s?this._manager.FORCE_INDEX:u,y=this._helper.IsTileValid(d,!0,r,i),I=this._helper.IsTileValid(_,!0,n,i),T=this._helper.IsTileValid(p,!0,a,i),C=this._helper.IsTileValid(f,!0,o,i);return 1*(y&&I?this._helper.IsTileValid(m,!0,h,i):0)+2*y+4*(y&&T?this._helper.IsTileValid(g,!0,l,i):0)+8*I+16*T+32*(C&&I?this._helper.IsTileValid(S,!0,c,i):0)+64*C+128*(C&&T?this._helper.IsTileValid(G,!0,u,i):0)}_Get8BitTileIndex(e,t,s,i){return e===this._manager.IGNORE_INDEX||e===this._manager.EMPTY_INDEX?e:this._helper.GetTileIndex(Nv.get(e),t,s,i)}}}{const Wv=self.C3;Wv.Plugins.Tilemap.Patch=class{constructor(e){this._manager=e,this._mode=e.PAINT_MODE,this._mirror=0,this._flip=0,this._diagonal=0,this._indexTransformMirror=0,this._indexTransformFlip=0,this._indexTransformDiagonal=0}SetMode(e){this._mode=e}GetMode(){return this._mode}GetBrushWidth(e){return e.tileData[0].length}GetBrushHeight(e){return e.tileData.length}TransformPatch(e,t=!1,s=!1,i=0,r=0,n=0){switch(e=this._SetTransformState(0,0,i,e),this._indexTransformMirror=this._mirror,this._indexTransformFlip=this._flip,this._indexTransformDiagonal=this._diagonal,this._diagonal&&(e=this._TransposePatch(e)),this._mirror&&(e=this._MirrorPatch(e,n===this._manager.PAINT_MODE)),this._flip&&(e=this._FlipPatch(e,n===this._manager.PAINT_MODE)),e=this._SetTransformState(t?1:0,s?1:0,0,e),i){case 0:this._indexTransformMirror=this._mirror,this._indexTransformFlip=this._flip;break;case 1:this._indexTransformMirror=1^this._mirror,this._indexTransformFlip=this._flip;break;case 2:this._indexTransformMirror=1^this._mirror,this._indexTransformFlip=1^this._flip;break;case 3:this._indexTransformMirror=this._mirror,this._indexTransformFlip=1^this._flip}return this._mirror&&(e=this._MirrorPatch(e,n===this._manager.PAINT_MODE)),this._flip&&(e=this._FlipPatch(e,n===this._manager.PAINT_MODE)),e}BuildPatch(e,t,s){const i=s.tileData[0].length,r=s.tileData.length,n=Array.from({length:r},()=>new Array(i).fill(this._manager.EMPTY_INDEX)),a=this._manager.GetProbabilityTable();a.Clear();for(let e=0;e<r;e++)for(let t=0;t<i;t++){const i=s.tileData[e][t];switch(this._mode){case this._manager.PAINT_MODE:if(1===i.length){const s=i[0][0];if(s>this._manager.GetSdkIntance().GetMaxTileIndex())continue;n[e][t]=s}else{for(let[e,t]of i)e>this._manager.GetSdkIntance().GetMaxTileIndex()||("number"!=typeof t&&(t=1),a.AddItem(t,e));n[e][t]=a.Sample()}break;case this._manager.ERASE_MODE:s.tileData[e][t][0][0]===this._manager.EMPTY_INDEX?n[e][t]=this._manager.IGNORE_INDEX:n[e][t]=this._manager.EMPTY_INDEX}}return n}_SetTransformState(e,t,s,i){switch(s){case 0:this._mirror=e,this._flip=t,this._diagonal=0;break;case 1:this._mirror=1^t,this._flip=e,this._diagonal=1;break;case 2:this._mirror=1^e,this._flip=1^t,this._diagonal=0;break;case 3:this._mirror=t,this._flip=1^e,this._diagonal=1}return i}_GetTileIndexTransformation(e){if(e===this._manager.IGNORE_INDEX||e===this._manager.EMPTY_INDEX)return e;const t=globalThis.ITilemapInstance;let s=e&t.TILE_ID_MASK;return this._indexTransformDiagonal&&(s|=t.TILE_FLIPPED_DIAGONAL),this._indexTransformMirror&&(s|=t.TILE_FLIPPED_HORIZONTAL),this._indexTransformFlip&&(s|=t.TILE_FLIPPED_VERTICAL),s}_MirrorPatch(e,t){for(let t=0;t<e.length;t++)e[t].reverse();if(t){let t=e[0].length,s=e.length;for(let i=0;i<s;i++)for(let s=0;s<t;s++){const t=this._GetTileIndexTransformation(e[i][s]);e[i][s]=t}}return e}_FlipPatch(e,t){if(e.reverse(),t){let t=e[0].length,s=e.length;for(let i=0;i<s;i++)for(let s=0;s<t;s++){const t=this._GetTileIndexTransformation(e[i][s]);e[i][s]=t}}return e}_TransposePatch(e){let t=[],s=e.length,i=e[0].length;for(let r=0;r<i;r++){let i=[];for(let t=0;t<s;t++)i.push(e[t][r]);t.push(i)}return t}}}{const Uv=self.C3;Uv.Plugins.Sprite=class extends Uv.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const Vv=self.C3,Hv=self.C3X,jv=[];Vv.Plugins.Sprite.Type=class extends Vv.SDKTypeBase{constructor(e){super(e),this._animations=e.GetAnimations()}Release(){Vv.clearArray(this._animations),super.Release()}OnCreate(){for(const e of this._animations)e.LoadAllAssets(this._runtime)}LoadTextures(e){const t={sampling:this._runtime.GetSampling()};return Promise.all(this._animations.map(s=>s.LoadAllTextures(e,t)))}ReleaseTextures(){for(const e of this._animations)e.ReleaseAllTextures()}OnDynamicTextureLoadComplete(){this._UpdateAllCurrentTexture()}_UpdateAllCurrentTexture(){for(const e of this._objectClass.instancesIncludingPendingCreate())e.GetSdkInstance()._UpdateCurrentTexture()}FinishCondition(e){Vv.Plugins.Sprite.FinishCollisionCondition(this,e)}BeforeRunAction(e){jv.push({objectClass:null,createHierarchy:!1,instances:[]})}_SpawnPickInstance(e,t,s){const i=jv.at(-1);i.objectClass=e,i.createHierarchy=s,i.instances.push(t)}AfterRunAction(e){const t=jv.pop(),s=t.objectClass,i=t.createHierarchy;if(!s)return;const r=new Map;for(const e of t.instances)e.CollectInstancesToPick(r,s,i);for(const[e,t]of r)e.GetCurrentSol().SetSetPicked(t)}_AddAnimation(e){const t=this.GetObjectClass().AddAnimation(e),s=this.GetRuntime();return t.GetFrameAt(0).GetImageInfo().LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling()}).then(()=>this._UpdateAllCurrentTexture()),t}_RemoveAnimation(e){for(const t of this._objectClass.instancesIncludingPendingCreate())t.GetSdkInstance()._OnAnimationRemoved(e);this.GetObjectClass().RemoveAnimation(e)}_AddAnimationFrame(e,t){const s=this._objectClass.GetAnimationByName(e);if(!s)throw new Error(`cannot find animation name '${e}'`);let i=s.FrameTagOrIndexToIndex(t);i<0&&(i+=s.GetFrameCount()+1);const r=Vv.AnimationFrameInfo.CreateDynamic(this.GetRuntime());s.InsertFrameAt(r,i);const n=this.GetRuntime();r.GetImageInfo().LoadStaticTexture(n.GetRenderer(),{sampling:n.GetSampling()}).then(()=>this._UpdateAllCurrentTexture());for(const e of this._objectClass.instancesIncludingPendingCreate())e.GetSdkInstance()._OnAnimationFramesChanged();return r}_RemoveAnimationFrame(e,t){const s=this._objectClass.GetAnimationByName(e);if(!s)throw new Error(`cannot find animation name '${e}'`);if(1===s.GetFrameCount())throw new Error(`cannot remove last frame from animation '${e}'`);let i=s.FrameTagOrIndexToIndex(t);i<0&&(i+=s.GetFrameCount()),s.RemoveFrameAt(i);for(const e of this._objectClass.instancesIncludingPendingCreate())e.GetSdkInstance()._OnAnimationFramesChanged()}GetScriptInterfaceClass(){return self.ISpriteObjectType}};const zv=new WeakMap;self.ISpriteObjectType=class extends self.IObjectType{constructor(e){super(e),zv.set(this,e.GetSdkType())}getAnimation(e){Hv.RequireString(e);const t=zv.get(this).GetObjectClass().GetAnimationByName(e);return t?t.GetIAnimation():null}getAllAnimations(){return zv.get(this).GetObjectClass().GetAllAnimations().map(e=>e.GetIAnimation())}addAnimation(e){return Hv.RequireString(e),zv.get(this)._AddAnimation(e).GetIAnimation()}removeAnimation(e){Hv.RequireString(e),zv.get(this)._RemoveAnimation(e)}addAnimationFrame(e,t){if(Hv.RequireString(e),"number"!=typeof t&&"string"!=typeof t)throw new TypeError("invalid insert location");return zv.get(this)._AddAnimationFrame(e,t).GetIAnimationFrame()}removeAnimationFrame(e,t){if(Hv.RequireString(e),"number"!=typeof t&&"string"!=typeof t)throw new TypeError("invalid insert location");zv.get(this)._RemoveAnimationFrame(e,t)}}}{const Xv=self.C3,Yv=self.C3X,qv=0,Kv=1,$v=2,Jv=3,Zv=Xv.New(Xv.Rect),Qv=Xv.New(Xv.Quad),eA=Xv.New(Xv.Vector2),tA=1,sA=2,iA=4;Xv.Plugins.Sprite.Instance=class extends Xv.SDKWorldInstanceBase{constructor(e,t){super(e);let s=!0,i="",r=0,n=!0;t&&(s=!!t[qv],i=t[Kv],r=t[$v],n=t[Jv]),this._currentAnimation=this._objectClass.GetAnimationByName(i)||this._objectClass.GetAnimations()[0],this._currentFrameIndex=Xv.clamp(r,0,this._currentAnimation.GetFrameCount()-1),this._currentAnimationFrame=this._currentAnimation.GetFrameAt(this._currentFrameIndex);const a=this._currentAnimationFrame.GetImageInfo();this._currentTexture=a.GetTexture(),this._currentRcTex=a.GetTexRect(),this._currentQuadTex=a.GetTexQuad(),this.HandleRendererContextLoss(),e.SetFlag(sA,!0),e.SetFlag(tA,this._currentAnimation.GetSpeed()>=0),this._currentAnimationSpeed=Math.abs(this._currentAnimation.GetSpeed()),this._currentAnimationRepeatTo=this._currentAnimation.GetRepeatTo(),this._animationTimer=Xv.New(Xv.KahanSum),this._frameStartTime=0,this._animationRepeats=0,this._animTriggerName="",this._changeAnimFrameIndex=-1,this._changeAnimationName="",this._changeAnimationFrom=0;const o=this.GetWorldInfo();this._bquadRef=o.GetBoundingQuad(),o.SetVisible(s),o.SetCollisionEnabled(n),o.SetOriginX(this._currentAnimationFrame.GetOriginX()),o.SetOriginY(this._currentAnimationFrame.GetOriginY()),o.SetSourceCollisionPoly(this._currentAnimationFrame.GetCollisionPoly()),o.SetBboxChanged(),1===this._objectClass.GetAnimationCount()&&1===this._objectClass.GetAnimations()[0].GetFrameCount()||0===this._currentAnimationSpeed||this._StartTicking()}Release(){this._currentAnimation=null,this._currentAnimationFrame=null,this._currentTexture=null,this._animationTimer=null,super.Release()}GetCurrentImageInfo(){return this._currentAnimationFrame.GetImageInfo()}IsOriginalSizeKnown(){return!0}OnRendererContextLost(){this._currentTexture=null}OnRendererContextRestored(){this._UpdateCurrentTexture()}Draw(e){const t=this._currentTexture;if(null===t)return;e.SetTexture(t);const s=this.GetWorldInfo();s.HasMesh()?this._DrawMesh(s,e):this._DrawStandard(s,e)}_DrawStandard(e,t){let s=this._bquadRef;this._runtime.IsPixelRoundingEnabled()&&(s=e.PixelRoundQuad(s)),t.Quad4(s,this._currentQuadTex)}_DrawMesh(e,t){const s=e.GetTransformedMesh();if(e.IsMeshChanged()){e.CalculateBbox(Zv,Qv,!1);let t=Qv;this._runtime.IsPixelRoundingEnabled()&&(t=e.PixelRoundQuad(t)),s.CalculateTransformedMesh(e.GetSourceMesh(),t,this._currentQuadTex),e.SetMeshChanged(!1)}s.Draw(t,e.GetTotalZElevation())}GetAnimationTime(){return this._animationTimer.Get()}IsAnimationPlaying(){return this._inst.GetFlag(sA)}SetAnimationPlaying(e){this._inst.SetFlag(sA,e)}IsPlayingForwards(){return this._inst.GetFlag(tA)}SetPlayingForwards(e){this._inst.SetFlag(tA,e)}IsInAnimationTrigger(){return this._inst.GetFlag(iA)}SetInAnimationTrigger(e){this._inst.SetFlag(iA,e)}Tick(){this._changeAnimationName&&this._DoChangeAnimation(),this._changeAnimFrameIndex>=0&&this._DoChangeAnimFrame();const e=this._currentAnimationSpeed;if(!this.IsAnimationPlaying()||0===e)return void this._StopTicking();const t=this._runtime.GetDt(this._inst);this._animationTimer.Add(t);const s=this.GetAnimationTime(),i=this._currentAnimationFrame,r=i.GetDuration()/e;if(s<this._frameStartTime+r)return;const n=this._currentAnimation,a=this._currentAnimationRepeatTo,o=n.GetFrameCount(),h=n.GetRepeatCount(),l=n.IsLooping(),c=n.IsPingPong();this.IsPlayingForwards()?this._currentFrameIndex++:this._currentFrameIndex--,this._frameStartTime+=r,this._currentFrameIndex>=o&&(c?(this.SetPlayingForwards(!1),this._currentFrameIndex=o-2):l?this._currentFrameIndex=a:(this._animationRepeats++,this._animationRepeats>=h?this._FinishAnimation(!1):this._currentFrameIndex=a)),this._currentFrameIndex<0&&(c?(this._currentFrameIndex=1,this.SetPlayingForwards(!0),l||(this._animationRepeats++,this._animationRepeats>=h&&this._FinishAnimation(!0))):l?this._currentFrameIndex=a:(this._animationRepeats++,this._animationRepeats>=h?this._FinishAnimation(!0):this._currentFrameIndex=a)),this._currentFrameIndex=Xv.clamp(this._currentFrameIndex,0,o-1);const u=n.GetFrameAt(this._currentFrameIndex);s>this._frameStartTime+u.GetDuration()/e&&(this._frameStartTime=s),this._OnFrameChanged(i,u)}_FinishAnimation(e){this._currentFrameIndex=e?0:this._currentAnimation.GetFrameCount()-1,this.SetAnimationPlaying(!1),this._animTriggerName=this._currentAnimation.GetName(),this.SetInAnimationTrigger(!0),this.DispatchScriptEvent("animationend",!1,{animationName:this._animTriggerName}),this.Trigger(Xv.Plugins.Sprite.Cnds.OnAnyAnimFinished),this.Trigger(Xv.Plugins.Sprite.Cnds.OnAnimFinished),this.SetInAnimationTrigger(!1),this._animationRepeats=0}_OnFrameChanged(e,t,s){if(e===t)return;const i=this.GetWorldInfo(),r=e.GetImageInfo(),n=t.GetImageInfo(),a=r.GetWidth(),o=r.GetHeight(),h=n.GetWidth(),l=n.GetHeight();s&&s.onFrameChange?s.onFrameChange(i,a,o,h,l):(a!==h&&i.SetWidth(i.GetWidth()*(h/a)),o!==l&&i.SetHeight(i.GetHeight()*(l/o))),i.SetOriginX(t.GetOriginX()),i.SetOriginY(t.GetOriginY()),i.SetSourceCollisionPoly(t.GetCollisionPoly()),i.SetBboxChanged(),this._currentAnimationFrame=t,this._currentTexture=n.GetTexture(),this._currentRcTex=n.GetTexRect(),this._currentQuadTex=n.GetTexQuad();const c=this.GetInstance().GetBehaviorInstances();for(let s=0,i=c.length;s<i;++s)c[s].OnSpriteFrameChanged(e,t);this.DispatchScriptEvent("framechange",!1,{animationName:this._currentAnimation.GetName(),animationFrame:this._currentFrameIndex}),this.Trigger(Xv.Plugins.Sprite.Cnds.OnFrameChanged),this._runtime.UpdateRender()}_StartAnim(e){this.SetAnimationPlaying(!0),this._frameStartTime=this.GetAnimationTime(),1===e&&0!==this._currentFrameIndex&&(this._changeAnimFrameIndex=0,this.IsInAnimationTrigger()||this._DoChangeAnimFrame()),this._StartTicking()}_SetAnim(e,t,s){this._changeAnimationName=e,this._changeAnimationFrom=t,this._StartTicking(),!s&&this.IsInAnimationTrigger()||this._DoChangeAnimation()}_GetCurrentAnimation(){return this._currentAnimation}_GetCurrentAnimationName(){return this._changeAnimationName?this._changeAnimationName:this._currentAnimation.GetName()}_OnAnimationRemoved(e){Xv.equalsNoCase(e,this._GetCurrentAnimationName())&&this._SetAnim(this._objectClass.GetFirstAnimation().GetName(),1,!0)}_SetAnimFrame(e){if("string"==typeof e)if(String(Number(e))===e)e=Number(e);else{const t=this._objectClass.GetAnimationByName(this._GetCurrentAnimationName());if(!t)return;if(-1===(e=t.GetFrameIndexByTag(e)))return}isFinite(e)&&(this._changeAnimFrameIndex=e,this.IsInAnimationTrigger()||this._DoChangeAnimFrame())}_OnAnimationFramesChanged(){if(this._changeAnimationName||-1!==this._changeAnimFrameIndex)return;const e=this._currentAnimationFrame,t=this._currentAnimation.GetFrameAt(Xv.clamp(this._currentFrameIndex,0,this._currentAnimation.GetFrameCount()-1));e!==t&&this._OnFrameChanged(e,t),this._currentAnimation.GetFrameCount()>1&&this._currentAnimationSpeed>0&&this._StartTicking()}_GetAnimFrame(){return this._currentFrameIndex}_GetAnimFrameTag(){return this._currentAnimationFrame.GetTag()}_SetAnimSpeed(e){this._currentAnimationSpeed=Math.abs(e),this.SetPlayingForwards(e>=0),this._currentAnimationSpeed>0&&this._StartTicking()}_GetAnimSpeed(){return this.IsPlayingForwards()?this._currentAnimationSpeed:-this._currentAnimationSpeed}_SetAnimRepeatToFrame(e){"string"==typeof e&&-1===(e=this._currentAnimation.GetFrameIndexByTag(e))||(e=Xv.clamp(Math.floor(e),0,this._currentAnimation.GetFrameCount()-1),this._currentAnimationRepeatTo=e)}_GetAnimRepeatToFrame(){return this._currentAnimationRepeatTo}_DoChangeAnimation(e){const t=this._currentAnimationFrame,s=this._objectClass.GetAnimationByName(this._changeAnimationName);if(this._changeAnimationName="",!s)return;if(s===this._currentAnimation&&this.IsAnimationPlaying())return;this._currentAnimation=s,this.SetPlayingForwards(s.GetSpeed()>=0),this._currentAnimationSpeed=Math.abs(s.GetSpeed()),this._currentAnimationRepeatTo=s.GetRepeatTo(),this._currentFrameIndex=Xv.clamp(this._currentFrameIndex,0,this._currentAnimation.GetFrameCount()-1),1===this._changeAnimationFrom&&(this._currentFrameIndex=0),this.SetAnimationPlaying(!0),this._frameStartTime=this.GetAnimationTime();const i=this._currentAnimation.GetFrameAt(this._currentFrameIndex);this._OnFrameChanged(t,i,e)}_DoChangeAnimFrame(e){const t=this._currentAnimationFrame,s=this._currentFrameIndex;if(this._currentFrameIndex=Xv.clamp(Math.floor(this._changeAnimFrameIndex),0,this._currentAnimation.GetFrameCount()-1),this._changeAnimFrameIndex=-1,!e&&s===this._currentFrameIndex)return;const i=this._currentAnimation.GetFrameAt(this._currentFrameIndex);this._OnFrameChanged(t,i),this._frameStartTime=this.GetAnimationTime()}_UpdateCurrentTexture(){const e=this._currentAnimationFrame.GetImageInfo();this._currentTexture=e.GetTexture(),this._currentRcTex=e.GetTexRect(),this._currentQuadTex=e.GetTexQuad(),this.GetWorldInfo().SetMeshChanged(!0)}GetTexture(){return this._currentTexture}GetTexRect(){return this._currentRcTex}GetTexQuad(){return this._currentQuadTex}GetImagePointCount(){return this._currentAnimationFrame.GetImagePointCount()}GetImagePoint(e){const t=this._currentAnimationFrame,s=this.GetWorldInfo();let i=null;if("string"==typeof e)i=t.GetImagePointByName(e);else{if("number"!=typeof e)throw new TypeError("expected string or number");i=t.GetImagePointByIndex(e-1)}let r=s.GetTotalZElevation();if(!i)return[s.GetX(),s.GetY(),r];if(eA.copy(i.GetVec2()),s.HasMesh()){const[e,t,i]=s.GetSourceMesh().TransformPoint(eA.getX(),eA.getY());eA.set(e,t),r+=i}return eA.offset(-t.GetOriginX(),-t.GetOriginY()),eA.scale(s.GetWidth(),s.GetHeight()),eA.rotate(s.GetAngle()),eA.offset(s.GetX(),s.GetY()),[eA.getX(),eA.getY(),r]}GetCollisionPolyPointCount(){return this.GetWorldInfo().GetTransformedCollisionPoly().pointCount()}GetCollisionPolyPoint(e){e=Math.floor(e);const t=this.GetWorldInfo(),s=t.GetTransformedCollisionPoly(),i=s.pointCount();if(e===i&&(e=0),e<0||e>=i)return[0,0];const r=s.pointsArr();return[r[2*e+0]+t.GetX(),r[2*e+1]+t.GetY()]}GetDebuggerProperties(){const e=Xv.Plugins.Sprite.Acts,t="plugins.sprite.debugger.animation-properties";return[{title:t+".title",properties:[{name:t+".current-animation",value:this._currentAnimation.GetName(),onedit:t=>this.CallAction(e.SetAnim,t,0)},{name:t+".current-frame",value:this._currentFrameIndex,onedit:t=>this.CallAction(e.SetAnimFrame,t)},{name:t+".is-playing",value:this.IsAnimationPlaying(),onedit:t=>t?this.CallAction(e.StartAnim,0):this.CallAction(e.StopAnim)},{name:t+".speed",value:this._currentAnimationSpeed,onedit:t=>this.CallAction(e.SetAnimSpeed,t)},{name:t+".repeats",value:this._animationRepeats,onedit:e=>this._animationRepeats=e}]}]}SaveToJson(){const e={a:this._currentAnimation.GetSID()};0!==this._frameStartTime&&(e.fs=this._frameStartTime);const t=this.GetAnimationTime();0!==t&&(e.at=t),0!==this._currentFrameIndex&&(e.f=this._currentFrameIndex),0!==this._currentAnimationSpeed&&(e.cas=this._currentAnimationSpeed),1!==this._animationRepeats&&(e.ar=this._animationRepeats),0!==this._currentAnimationRepeatTo&&(e.rt=this._currentAnimationRepeatTo),this.IsAnimationPlaying()||(e.ap=this.IsAnimationPlaying()),this.IsPlayingForwards()||(e.af=this.IsPlayingForwards());const s=this.GetWorldInfo();return s.IsCollisionEnabled()&&(e.ce=s.IsCollisionEnabled()),e}LoadFromJson(e){const t=this.GetObjectClass().GetAnimationBySID(e.a);t&&(this._currentAnimation=t),this._frameStartTime=e.hasOwnProperty("fs")?e.fs:0,this._animationTimer.Set(e.hasOwnProperty("at")?e.at:0);const s=e.hasOwnProperty("f")?e.f:0;this._currentFrameIndex=Xv.clamp(s,0,this._currentAnimation.GetFrameCount()-1),this._currentAnimationSpeed=e.hasOwnProperty("cas")?e.cas:0,this._animationRepeats=e.hasOwnProperty("ar")?e.ar:1;const i=e.hasOwnProperty("rt")?e.rt:0;this._currentAnimationRepeatTo=Xv.clamp(i,0,this._currentAnimation.GetFrameCount()-1),this.SetAnimationPlaying(!e.hasOwnProperty("ap")||!!e.ap),this.SetPlayingForwards(!e.hasOwnProperty("af")||!!e.af);const r=this._currentAnimation.GetFrameAt(this._currentFrameIndex);this._currentAnimationFrame=r,this._UpdateCurrentTexture();const n=this.GetWorldInfo();n.SetOriginX(r.GetOriginX()),n.SetOriginY(r.GetOriginY()),n.SetSourceCollisionPoly(r.GetCollisionPoly()),n.SetCollisionEnabled(!!e.ce),this.IsAnimationPlaying()&&this._StartTicking()}GetPropertyValueByIndex(e){const t=this.GetWorldInfo();switch(e){case Jv:return t.IsCollisionEnabled();case $v:return Xv.clamp(this._currentFrameIndex,0,this._currentAnimation.GetFrameCount()-1);case Kv:return this._currentAnimation.GetName()}}SetPropertyValueByIndex(e,t,s){const i=this.GetWorldInfo();switch(e){case Jv:i.SetCollisionEnabled(!!t);break;case $v:if(s.isChunkDiscreteLike){if(!s.keyframeReached)return;{const e=this._currentAnimation.GetFrameCount()-1,i=t=Xv.clamp(t,0,e),r=this._currentAnimation.GetFrameAt(this._currentFrameIndex),n=this._currentAnimation.GetFrameAt(i);this._OnFrameChanged(r,n,s),this._currentFrameIndex=Xv.clamp(i,0,e)}}else{this.SetAnimationPlaying(!1);const e=this._currentAnimation.GetFrameCount()-1,i=t=Xv.clamp(t,0,e),r=this._currentAnimation.GetFrameAt(this._currentFrameIndex),n=this._currentAnimation.GetFrameAt(i);this._OnFrameChanged(r,n,s),this._currentFrameIndex=Xv.clamp(i,0,e)}break;case Kv:this._changeAnimationName=t,this._changeAnimationFrom=s?.startFrom??0,this._DoChangeAnimation(s),this._currentAnimation.GetFrameCount()>1&&this._currentAnimation.GetSpeed()>0?this._StartTicking():this._StopTicking()}}GetScriptInterfaceClass(){return self.ISpriteInstance}};const rA=new WeakMap,nA=new Map([["current-frame",0],["beginning",1]]);self.ISpriteInstance=class extends self.IWorldInstance{constructor(){super(),rA.set(this,self.IInstance._GetInitInst().GetSdkInstance())}getImagePointCount(){return rA.get(this).GetImagePointCount()}getImagePointX(e){return this.getImagePoint(e)[0]}getImagePointY(e){return this.getImagePoint(e)[1]}getImagePointZ(e){return this.getImagePoint(e)[2]}getImagePoint(e){if("string"!=typeof e&&"number"!=typeof e)throw new TypeError("expected string or number");return rA.get(this).GetImagePoint(e)}getPolyPointCount(){return rA.get(this).GetCollisionPolyPointCount()}getPolyPointX(e){return Yv.RequireFiniteNumber(e),rA.get(this).GetCollisionPolyPoint(e)[0]}getPolyPointY(e){return Yv.RequireFiniteNumber(e),rA.get(this).GetCollisionPolyPoint(e)[1]}getPolyPoint(e){return Yv.RequireFiniteNumber(e),rA.get(this).GetCollisionPolyPoint(e)}stopAnimation(){rA.get(this).SetAnimationPlaying(!1)}startAnimation(e="current-frame"){Yv.RequireString(e);const t=nA.get(e);if(void 0===t)throw new Error("invalid mode");rA.get(this)._StartAnim(t)}setAnimation(e,t="beginning"){Yv.RequireString(e),Yv.RequireString(t);const s=nA.get(t);if(void 0===s)throw new Error("invalid mode");const i=rA.get(this);if(!i.GetObjectClass().GetAnimationByName(e))throw new Error(`animation name "${e}" does not exist`);i._SetAnim(e,s)}getAnimation(e){Yv.RequireString(e);const t=rA.get(this).GetObjectClass().GetAnimationByName(e);return t?t.GetIAnimation():null}get animation(){return rA.get(this)._GetCurrentAnimation().GetIAnimation()}get animationName(){return rA.get(this)._GetCurrentAnimationName()}set animationFrame(e){Yv.RequireFiniteNumber(e),rA.get(this)._SetAnimFrame(e)}get animationFrame(){return rA.get(this)._GetAnimFrame()}set animationFrameTag(e){Yv.RequireString(e),rA.get(this)._SetAnimFrame(e)}get animationFrameTag(){return rA.get(this)._GetAnimFrameTag()}set animationSpeed(e){Yv.RequireFiniteNumber(e),rA.get(this)._SetAnimSpeed(e)}get animationSpeed(){return rA.get(this)._GetAnimSpeed()}set animationRepeatToFrame(e){Yv.RequireFiniteNumber(e),rA.get(this)._SetAnimRepeatToFrame(e)}get animationRepeatToFrame(){return rA.get(this)._GetAnimRepeatToFrame()}get imageWidth(){return rA.get(this).GetCurrentImageInfo().GetWidth()}get imageHeight(){return rA.get(this).GetCurrentImageInfo().GetHeight()}getImageSize(){const e=rA.get(this).GetCurrentImageInfo();return[e.GetWidth(),e.GetHeight()]}async replaceCurrentAnimationFrame(e){Yv.RequireInstanceOf(e,Blob);const t=rA.get(this),s=t.GetRuntime(),i=t.GetCurrentImageInfo(),r=Xv.New(Xv.ImageInfo);if(r.LoadDynamicBlobAsset(s,e),await r.LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling()}),t.WasReleased())return void r.Release();i.ReplaceWith(r);const n=t.GetSdkType();n._UpdateAllCurrentTexture(),n.GetObjectClass().Dispatcher().dispatchEvent(new Xv.Event("animationframeimagechange")),s.UpdateRender()}setSolidCollisionFilter(e,t){"string"==typeof t&&(t=Xv.splitStringAndNormalize(t)),rA.get(this).GetWorldInfo().SetSolidCollisionFilter(!!e,t)}}}{const aA=self.C3;aA.Plugins.Sprite.Cnds={IsAnimPlaying(e){return aA.equalsNoCase(this._GetCurrentAnimationName(),e)},CompareFrame(e,t){return aA.compare(this._currentFrameIndex,e,t)},CompareFrameTag(e,t){if("string"!=typeof t)return!1;const s=this._currentAnimationFrame.GetTag();return aA.compare(s.toLowerCase(),e,t.toLowerCase())},CompareAnimSpeed(e,t){return aA.compare(this._GetAnimSpeed(),e,t)},OnAnimFinished(e){return aA.equalsNoCase(this._animTriggerName,e)},OnAnyAnimFinished:()=>!0,OnFrameChanged:()=>!0,IsMirrored(){return this.GetWorldInfo().GetWidth()<0},IsFlipped(){return this.GetWorldInfo().GetHeight()<0},OnURLLoaded:()=>!0,OnURLFailed:()=>!0,IsCollisionEnabled(){return this.GetWorldInfo().IsCollisionEnabled()}}}{const oA=self.C3;oA.Plugins.Sprite.Acts={Spawn(e,t,s,i,r){if(!e||!t)return;const[n,a]=this.GetImagePoint(s),o=this._runtime.CreateInstance(e,t,n,a,i,r);if(!o)return;if(i&&t.SortAndAddInstancesByZIndex(o),e.GetPlugin().IsRotatable()){const e=o.GetWorldInfo();e.SetAngle(this.GetWorldInfo().GetAngle()),e.SetBboxChanged()}const h=this._runtime.GetEventSheetManager();h.BlockFlushingInstances(!0),o._TriggerOnCreatedOnSelfAndRelated(),h.BlockFlushingInstances(!1),e!==this._runtime.GetCurrentAction().GetObjectClass()&&this._sdkType._SpawnPickInstance(e,o,i)},StopAnim(){this.SetAnimationPlaying(!1)},StartAnim(e){this._StartAnim(e)},SetAnim(e,t){this._SetAnim(e,t)},SetAnimFrame(e){this._SetAnimFrame(e)},SetAnimSpeed(e){this._SetAnimSpeed(e)},SetAnimRepeatToFrame(e){this._SetAnimRepeatToFrame(e)},AddRemoveAnimation(e,t){try{0===e?this.GetSdkType()._AddAnimation(t):this.GetSdkType()._RemoveAnimation(t)}catch(t){console.error(`[Construct] Error ${0===e?"adding":"removing"} animation: `,t)}},AddRemoveAnimationFrame(e,t,s){try{0===e?this.GetSdkType()._AddAnimationFrame(t,s):this.GetSdkType()._RemoveAnimationFrame(t,s)}catch(t){console.error(`[Construct] Error ${0===e?"adding":"removing"} animation frame: `,t)}},SetMirrored(e){const t=this.GetWorldInfo(),s=t.GetWidth(),i=Math.abs(s)*(0===e?-1:1);s!==i&&(t.SetWidth(i),t.SetBboxChanged())},SetFlipped(e){const t=this.GetWorldInfo(),s=t.GetHeight(),i=Math.abs(s)*(0===e?-1:1);s!==i&&(t.SetHeight(i),t.SetBboxChanged())},SetScale(e){const t=this._currentAnimationFrame.GetImageInfo(),s=this.GetWorldInfo(),i=s.GetWidth()<0?-1:1,r=s.GetHeight()<0?-1:1,n=t.GetWidth()*e*i,a=t.GetHeight()*e*r;s.GetWidth()===n&&s.GetHeight()===a||(s.SetSize(n,a),s.SetBboxChanged())},async LoadURL(e,t,s){const i=this._currentAnimationFrame.GetImageInfo(),r=this.GetWorldInfo(),n=this._runtime,a=this._sdkType;if(i.GetURL()===e)return 0===t&&(r.SetSize(i.GetWidth(),i.GetHeight()),r.SetBboxChanged()),void this.Trigger(oA.Plugins.Sprite.Cnds.OnURLLoaded);const o=oA.New(oA.ImageInfo);try{if(await o.LoadDynamicAsset(n,e),!o.IsLoaded())throw new Error("image failed to load");if(this.WasReleased())return void o.Release();await o.LoadStaticTexture(n.GetRenderer(),{sampling:n.GetSampling()})}catch(e){return console.error("Load image from URL failed: ",e),void(this.WasReleased()||this.Trigger(oA.Plugins.Sprite.Cnds.OnURLFailed))}this.WasReleased()?o.Release():(i.ReplaceWith(o),a._UpdateAllCurrentTexture(),a.GetObjectClass().Dispatcher().dispatchEvent(new oA.Event("animationframeimagechange")),n.UpdateRender(),0===t&&(r.SetSize(i.GetWidth(),i.GetHeight()),r.SetBboxChanged()),await this.TriggerAsync(oA.Plugins.Sprite.Cnds.OnURLLoaded))},SetCollisions(e){this.GetWorldInfo().SetCollisionEnabled(e)},SetSolidCollisionFilter(e,t){this.GetWorldInfo().SetSolidCollisionFilter(0===e,oA.splitStringAndNormalize(t))},SetEffect(e){this.GetWorldInfo().SetBlendMode(e),this._runtime.UpdateRender()}}}self.C3.Plugins.Sprite.Exps={AnimationFrame(){return this._GetAnimFrame()},AnimationFrameTag(){return this._GetAnimFrameTag()},AnimationFrameCount(){return this._currentAnimation.GetFrameCount()},AnimationName(){return this._currentAnimation.GetName()},AnimationSpeed(){return this._GetAnimSpeed()},OriginalAnimationSpeed(){return this._currentAnimation.GetSpeed()},ImagePointX(e){return this.GetImagePoint(e)[0]},ImagePointY(e){return this.GetImagePoint(e)[1]},ImagePointZ(e){return this.GetImagePoint(e)[2]},ImagePointCount(){return this.GetImagePointCount()},ImageWidth(){return this.GetCurrentImageInfo().GetWidth()},ImageHeight(){return this.GetCurrentImageInfo().GetHeight()},PolyPointXAt(e){return this.GetCollisionPolyPoint(e)[0]},PolyPointYAt(e){return this.GetCollisionPolyPoint(e)[1]},PolyPointCount(){return this.GetCollisionPolyPointCount()}};{const hA=self.C3;hA.Plugins.TiledBg=class extends hA.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{let lA=function(e){switch(e){case 0:return"clamp-to-edge";case 1:return"repeat";case 2:return"mirror-repeat"}return"repeat"};WrapModeToStr=lA;const cA=self.C3;cA.Plugins.TiledBg.Type=class extends cA.SDKTypeBase{constructor(e,t){super(e),this._wrapX="repeat",this._wrapY="repeat",t&&(this._wrapX=lA(t[0]),this._wrapY=lA(t[1]))}Release(){super.Release()}OnCreate(){this.GetImageInfo().LoadAsset(this._runtime)}LoadTextures(e){return this.GetImageInfo().LoadStaticTexture(e,{sampling:this._runtime.GetSampling(),wrapX:this._wrapX,wrapY:this._wrapY})}ReleaseTextures(){this.GetImageInfo().ReleaseTexture()}GetWrapModeX(){return this._wrapX}GetWrapModeY(){return this._wrapY}}}{const uA=globalThis.C3,dA=globalThis.C3X,_A=0,pA=4,fA=5,mA=6,gA=7,SA=8,GA=9,yA=10,IA=11,TA=12,CA=13,bA=14,xA=uA.New(uA.Rect),wA=uA.New(uA.Quad),PA=uA.New(uA.Rect),RA=uA.New(uA.Quad);uA.Plugins.TiledBg.Instance=class extends uA.SDKWorldInstanceBase{constructor(e,t){super(e),this._imageOffsetX=0,this._imageOffsetY=0,this._imageScaleX=1,this._imageScaleY=1,this._imageAngle=0,this._enableTileRandomization=!1,this._tileXRandom=0,this._tileYRandom=0,this._tileAngleRandom=0,this._tileBlendMarginX=0,this._tileBlendMarginY=0,this._ownImageInfo=null,t&&(this.GetWorldInfo().SetVisible(!!t[_A]),this._imageOffsetX=t[pA],this._imageOffsetY=t[fA],this._imageScaleX=t[mA],this._imageScaleY=t[gA],this._imageAngle=uA.toRadians(t[SA]),this._enableTileRandomization=!!t[GA],this._tileXRandom=t[yA],this._tileYRandom=t[IA],this._tileAngleRandom=t[TA],this._tileBlendMarginX=t[CA],this._tileBlendMarginY=t[bA])}Release(){this._ReleaseOwnImage(),super.Release()}_ReleaseOwnImage(){this._ownImageInfo&&(this._ownImageInfo.Release(),this._ownImageInfo=null)}CalculateTextureCoordsFor3DFace(e,t,s){const i=this.GetCurrentImageInfo(),r=i.GetWidth(),n=i.GetHeight(),a=this._imageOffsetX/r,o=this._imageOffsetY/n,h=this._imageAngle;PA.set(0,0,e/(r*this._imageScaleX),t/(n*this._imageScaleY)),PA.offset(-a,-o),0===h?s.setFromRect(PA):s.setFromRotatedRect(PA,-h)}SetTilingShaderProgram(e,t=!0){if(this._enableTileRandomization){const t=this.GetCurrentImageInfo();e.SetTileRandomizationMode(),e.SetTileRandomizationInfo(t.GetWidth()*this._imageScaleX,t.GetHeight()*this._imageScaleY,this._tileXRandom,this._tileYRandom,this._tileAngleRandom,this._tileBlendMarginX,this._tileBlendMarginY)}else t&&e.SetTextureFillMode()}Draw(e){const t=this.GetCurrentImageInfo(),s=t.GetTexture();if(null===s)return;this.SetTilingShaderProgram(e),e.SetTexture(s);const i=t.GetWidth(),r=t.GetHeight();let n=this._imageOffsetX/i,a=this._imageOffsetY/r;0!==this._imageAngle||this._enableTileRandomization||("repeat"===this.GetSdkType().GetWrapModeX()&&(n%=1),"repeat"===this.GetSdkType().GetWrapModeY()&&(a%=1));const o=this.GetWorldInfo();PA.set(0,0,o.GetWidth()/(i*this._imageScaleX),o.GetHeight()/(r*this._imageScaleY)),PA.offset(-n,-a),o.HasMesh()?this._DrawMesh(o,e):this._DrawStandard(o,e)}_DrawStandard(e,t){let s=e.GetBoundingQuad();this._runtime.IsPixelRoundingEnabled()&&(s=e.PixelRoundQuad(s)),0===this._imageAngle?t.Quad3(s,PA):(RA.setFromRotatedRect(PA,-this._imageAngle),t.Quad4(s,RA))}_DrawMesh(e,t){const s=e.GetTransformedMesh();if(e.IsMeshChanged()){e.CalculateBbox(xA,wA,!1);let t=wA;this._runtime.IsPixelRoundingEnabled()&&(t=e.PixelRoundQuad(t));let i=PA;0!==this._imageAngle&&(RA.setFromRotatedRect(PA,-this._imageAngle),i=RA),s.CalculateTransformedMesh(e.GetSourceMesh(),t,i),e.SetMeshChanged(!1)}s.Draw(t,e.GetTotalZElevation())}GetCurrentImageInfo(){return this._ownImageInfo||this._objectClass.GetImageInfo()}IsOriginalSizeKnown(){return!0}GetTexture(){return this.GetCurrentImageInfo().GetTexture()}_SetMeshChanged(){this.GetWorldInfo().SetMeshChanged(!0)}_SetImageOffsetX(e){this._imageOffsetX!==e&&(this._imageOffsetX=e,this._runtime.UpdateRender(),this._SetMeshChanged())}_GetImageOffsetX(){return this._imageOffsetX}_SetImageOffsetY(e){this._imageOffsetY!==e&&(this._imageOffsetY=e,this._runtime.UpdateRender(),this._SetMeshChanged())}_GetImageOffsetY(){return this._imageOffsetY}_SetImageScaleX(e){this._imageScaleX!==e&&(this._imageScaleX=e,this._runtime.UpdateRender(),this._SetMeshChanged())}_GetImageScaleX(){return this._imageScaleX}_SetImageScaleY(e){this._imageScaleY!==e&&(this._imageScaleY=e,this._runtime.UpdateRender(),this._SetMeshChanged())}_GetImageScaleY(){return this._imageScaleY}_SetImageAngle(e){this._imageAngle!==e&&(this._imageAngle=e,this._runtime.UpdateRender(),this._SetMeshChanged())}_GetImageAngle(){return this._imageAngle}_SetTileRandomizationEnabled(e){e=!!e,this._enableTileRandomization!==e&&(this._enableTileRandomization=e,this._runtime.UpdateRender())}_IsTileRandomizationEnabled(){return this._enableTileRandomization}_SetTileXRandom(e){this._tileXRandom!==e&&(this._tileXRandom=e,this._IsTileRandomizationEnabled()&&this._runtime.UpdateRender())}_GetTileXRandom(){return this._tileXRandom}_SetTileYRandom(e){this._tileYRandom!==e&&(this._tileYRandom=e,this._IsTileRandomizationEnabled()&&this._runtime.UpdateRender())}_GetTileYRandom(){return this._tileYRandom}_SetTileAngleRandom(e){this._tileAngleRandom!==e&&(this._tileAngleRandom=e,this._IsTileRandomizationEnabled()&&this._runtime.UpdateRender())}_GetTileAngleRandom(){return this._tileAngleRandom}_SetTileBlendMarginX(e){this._tileBlendMarginX!==e&&(this._tileBlendMarginX=e,this._IsTileRandomizationEnabled()&&this._runtime.UpdateRender())}_GetTileBlendMarginX(){return this._tileBlendMarginX}_SetTileBlendMarginY(e){this._tileBlendMarginY!==e&&(this._tileBlendMarginY=e,this._IsTileRandomizationEnabled()&&this._runtime.UpdateRender())}_GetTileBlendMarginY(){return this._tileBlendMarginY}SaveToJson(){const e={};return 0!==this._imageOffsetX&&(e.iox=this._imageOffsetX),0!==this._imageOffsetY&&(e.ioy=this._imageOffsetY),1!==this._imageScaleX&&(e.isx=this._imageScaleX),1!==this._imageScaleY&&(e.isy=this._imageScaleY),0!==this._imageAngle&&(e.ia=this._imageAngle),this._enableTileRandomization&&(e.tr=!0),1!==this._tileXRandom&&(e.trx=this._tileXRandom),1!==this._tileYRandom&&(e.try=this._tileYRandom),1!==this._tileAngleRandom&&(e.tra=this._tileAngleRandom),.1!==this._tileBlendMarginX&&(e.trbmx=this._tileBlendMarginX),.1!==this._tileBlendMarginY&&(e.trbmy=this._tileBlendMarginY),e}LoadFromJson(e){this._imageOffsetX=e.iox||0,this._imageOffsetY=e.ioy||0,this._imageScaleX=e.hasOwnProperty("isx")?e.isx:1,this._imageScaleY=e.hasOwnProperty("isy")?e.isy:1,this._imageAngle=e.ia||0,this._enableTileRandomization=!!e.tr,this._tileXRandom=e.hasOwnProperty("trx")?e.trx:1,this._tileYRandom=e.hasOwnProperty("try")?e.try:1,this._tileAngleRandom=e.hasOwnProperty("tra")?e.tra:1,this._tileBlendMarginX=e.hasOwnProperty("trbmx")?e.trbmx:.1,this._tileBlendMarginY=e.hasOwnProperty("trbmy")?e.trbmy:.1}GetDebuggerProperties(){const e="plugins.tiledbg.properties";return[{title:e+".image-transform.name",properties:[{name:e+".image-offset-x.name",value:this._GetImageOffsetX(),onedit:e=>this._SetImageOffsetX(e)},{name:e+".image-offset-y.name",value:this._GetImageOffsetY(),onedit:e=>this._SetImageOffsetY(e)},{name:e+".image-scale-x.name",value:100*this._GetImageScaleX(),onedit:e=>this._SetImageScaleX(e/100)},{name:e+".image-scale-y.name",value:100*this._GetImageScaleY(),onedit:e=>this._SetImageScaleY(e/100)},{name:e+".image-angle.name",value:uA.toDegrees(this._GetImageAngle()),onedit:e=>this._SetImageAngle(uA.toRadians(e))}]},{title:e+".tile-randomization.name",properties:[{name:e+".enable-tile-randomization.name",value:this._IsTileRandomizationEnabled(),onedit:e=>this._SetTileRandomizationEnabled(e)},{name:e+".x-random.name",value:100*this._GetTileXRandom(),onedit:e=>this._SetTileXRandom(e/100)},{name:e+".y-random.name",value:100*this._GetTileYRandom(),onedit:e=>this._SetTileYRandom(e/100)},{name:e+".angle-random.name",value:100*this._GetTileAngleRandom(),onedit:e=>this._SetTileAngleRandom(e/100)},{name:e+".blend-margin-x.name",value:100*this._GetTileBlendMarginX(),onedit:e=>this._SetTileBlendMarginX(e/100)},{name:e+".blend-margin-y.name",value:100*this._GetTileBlendMarginY(),onedit:e=>this._SetTileBlendMarginY(e/100)}]}]}GetPropertyValueByIndex(e){switch(e){case pA:return this._GetImageOffsetX();case fA:return this._GetImageOffsetY();case mA:return this._GetImageScaleX();case gA:return this._GetImageScaleY();case SA:return this._GetImageAngle();case GA:return this._IsTileRandomizationEnabled();case yA:return this._GetTileXRandom();case IA:return this._GetTileYRandom();case TA:return this._GetTileAngleRandom();case CA:return this._GetTileBlendMarginX();case bA:return this._GetTileBlendMarginY()}}SetPropertyValueByIndex(e,t){switch(e){case pA:this._SetImageOffsetX(t);break;case fA:this._SetImageOffsetY(t);break;case mA:this._SetImageScaleX(t);break;case gA:this._SetImageScaleY(t);break;case SA:this._SetImageAngle(t);break;case GA:this._SetTileRandomizationEnabled(!!t);break;case yA:this._SetTileXRandom(t);break;case IA:this._SetTileYRandom(t);break;case TA:this._SetTileAngleRandom(t);break;case CA:this._SetTileBlendMarginX(t);break;case bA:this._SetTileBlendMarginY(t)}}GetScriptInterfaceClass(){return globalThis.ITiledBackgroundInstance}},globalThis.ITiledBackgroundInstance=class extends globalThis.IWorldInstance{#e;constructor(){super(),this.#e=globalThis.IInstance._GetInitInst().GetSdkInstance()}set imageOffsetX(e){dA.RequireFiniteNumber(e),this.#e._SetImageOffsetX(e)}get imageOffsetX(){return this.#e._GetImageOffsetX()}set imageOffsetY(e){dA.RequireFiniteNumber(e),this.#e._SetImageOffsetY(e)}get imageOffsetY(){return this.#e._GetImageOffsetY()}setImageOffset(e,t){dA.RequireFiniteNumber(e),dA.RequireFiniteNumber(t);const s=this.#e;s._SetImageOffsetX(e),s._SetImageOffsetY(t)}getImageOffset(){const e=this.#e;return[e._GetImageOffsetX(),e._GetImageOffsetY()]}set imageScaleX(e){dA.RequireFiniteNumber(e),this.#e._SetImageScaleX(e)}get imageScaleX(){return this.#e._GetImageScaleX()}set imageScaleY(e){dA.RequireFiniteNumber(e),this.#e._SetImageScaleY(e)}get imageScaleY(){return this.#e._GetImageScaleY()}setImageScale(e,t){dA.RequireFiniteNumber(e),dA.RequireFiniteNumber(t);const s=this.#e;s._SetImageScaleX(e),s._SetImageScaleY(t)}getImageScale(){const e=this.#e;return[e._GetImageScaleX(),e._GetImageScaleY()]}set imageAngle(e){dA.RequireFiniteNumber(e),this.#e._SetImageAngle(e)}get imageAngle(){return this.#e._GetImageAngle()}set imageAngleDegrees(e){dA.RequireFiniteNumber(e),this.#e._SetImageAngle(uA.toRadians(e))}get imageAngleDegrees(){return uA.toDegrees(this.#e._GetImageAngle())}get imageWidth(){return this.#e.GetCurrentImageInfo().GetWidth()}get imageHeight(){return this.#e.GetCurrentImageInfo().GetHeight()}getImageSize(){const e=this.#e.GetCurrentImageInfo();return[e.GetWidth(),e.GetHeight()]}set enableTileRandomization(e){this.#e._SetTileRandomizationEnabled(!!e)}get enableTileRandomization(){return this.#e._IsTileRandomizationEnabled()}set tileXRandom(e){dA.RequireFiniteNumber(e),this.#e._SetTileXRandom(e)}get tileXRandom(){return this.#e._GetTileXRandom()}set tileYRandom(e){dA.RequireFiniteNumber(e),this.#e._SetTileYRandom(e)}get tileYRandom(){return this.#e._GetTileYRandom()}setTileRandom(e,t){dA.RequireFiniteNumber(e),dA.RequireFiniteNumber(t);const s=this.#e;s._SetTileXRandom(e),s._SetTileYRandom(t)}getTileRandom(){const e=this.#e;return[e._GetTileXRandom(),e._GetTileYRandom()]}set tileAngleRandom(e){dA.RequireFiniteNumber(e),this.#e._SetTileAngleRandom(e)}get tileAngleRandom(){return this.#e._GetTileAngleRandom()}set tileBlendMarginX(e){dA.RequireFiniteNumber(e),this.#e._SetTileBlendMarginX(e)}get tileBlendMarginX(){return this.#e._GetTileBlendMarginX()}set tileBlendMarginY(e){dA.RequireFiniteNumber(e),this.#e._SetTileBlendMarginY(e)}get tileBlendMarginY(){return this.#e._GetTileBlendMarginY()}setTileBlendMargin(e,t){dA.RequireFiniteNumber(e),dA.RequireFiniteNumber(t);const s=this.#e;s._SetTileBlendMarginX(e),s._SetTileBlendMarginY(t)}getTileBlendMargin(){const e=this.#e;return[e._GetTileBlendMarginX(),e._GetTileBlendMarginY()]}async replaceImage(e){dA.RequireInstanceOf(e,Blob);const t=this.#e,s=t.GetRuntime(),i=uA.New(uA.ImageInfo);i.LoadDynamicBlobAsset(s,e),await i.LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling(),wrapX:t.GetSdkType().GetWrapModeX(),wrapY:t.GetSdkType().GetWrapModeY()}),t.WasReleased()?i.Release():(t._ReleaseOwnImage(),t._ownImageInfo=i,s.UpdateRender())}}}self.C3.Plugins.TiledBg.Cnds={OnURLLoaded:()=>!0,OnURLFailed:()=>!0,IsTileRandomizationEnabled(){return this._IsTileRandomizationEnabled()}};{const vA=self.C3;vA.Plugins.TiledBg.Acts={SetImageOffsetX(e){this._SetImageOffsetX(e)},SetImageOffsetY(e){this._SetImageOffsetY(e)},SetImageScaleX(e){this._SetImageScaleX(e/100)},SetImageScaleY(e){this._SetImageScaleY(e/100)},SetImageAngle(e){this._SetImageAngle(vA.toRadians(e))},SetTileRandomizationEnabled(e){this._SetTileRandomizationEnabled(e)},SetTilePosRandom(e,t){this._SetTileXRandom(e/100),this._SetTileYRandom(t/100)},SetTileAngleRandom(e){this._SetTileAngleRandom(e/100)},SetTileBlendMargin(e,t){this._SetTileBlendMarginX(e/100),this._SetTileBlendMarginY(t/100)},SetEffect(e){this.GetWorldInfo().SetBlendMode(e),this._runtime.UpdateRender()},async LoadURL(e,t){if(this._ownImageInfo&&this._ownImageInfo.GetURL()===e)return;const s=this._runtime,i=vA.New(vA.ImageInfo);try{if(await i.LoadDynamicAsset(s,e,!0),!i.IsLoaded())throw new Error("image failed to load");if(this.WasReleased())return i.Release(),null;if(!await i.LoadStaticTexture(s.GetRenderer(),{sampling:s.GetSampling(),wrapX:this.GetSdkType().GetWrapModeX(),wrapY:this.GetSdkType().GetWrapModeY()}))return}catch(e){return console.error("Load image from URL failed: ",e),void(this.WasReleased()||this.Trigger(vA.Plugins.TiledBg.Cnds.OnURLFailed))}this.WasReleased()?i.Release():(this._ReleaseOwnImage(),this._ownImageInfo=i,s.UpdateRender(),await this.TriggerAsync(vA.Plugins.TiledBg.Cnds.OnURLLoaded))}}}{const AA=self.C3;AA.Plugins.TiledBg.Exps={ImageWidth(){return this.GetCurrentImageInfo().GetWidth()},ImageHeight(){return this.GetCurrentImageInfo().GetHeight()},ImageOffsetX(){return this._imageOffsetX},ImageOffsetY(){return this._imageOffsetY},ImageScaleX(){return 100*this._imageScaleX},ImageScaleY(){return 100*this._imageScaleY},ImageAngle(){return AA.toDegrees(this._imageAngle)},TileXRandom(){return 100*this._GetTileXRandom()},TileYRandom(){return 100*this._GetTileYRandom()},TileAngleRandom(){return 100*this._GetTileAngleRandom()},TileBlendMarginX(){return 100*this._GetTileBlendMarginX()},TileBlendMarginY(){return 100*this._GetTileBlendMarginY()}}}{const MA=self.C3;MA.Plugins.Text=class extends MA.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const DA=self.C3;DA.Plugins.Text.Type=class extends DA.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}LoadTextures(e){}ReleaseTextures(){}}}{const EA=self.C3,FA=self.C3X,OA=[0,0,0],BA=0,kA=1,LA=2,NA=3,WA=4,UA=5,VA=6,HA=7,jA=8,zA=9,XA=10,YA=11,qA=12,KA=13,$A=15,JA=["left","center","right"],ZA=["top","center","bottom"],QA=["ltr","rtl"],eM=["word","cjk","character"],tM=new EA.Rect,sM=new EA.Quad,iM=new EA.Color,rM=EA.New(EA.Vector2),nM=new Map([["b","strong"],["i","em"],["s","s"],["u","u"],["iconoffsety",null]]);EA.Plugins.Text.Instance=class extends EA.SDKWorldInstanceBase{constructor(e,t){if(super(e),this._text="",this._enableBBcode=!0,this._faceName="Arial",this._ptSize=12,this._lineHeightOffset=0,this._isBold=!1,this._isItalic=!1,this._color=EA.New(EA.Color),this._horizontalAlign=0,this._verticalAlign=0,this._wrapMode="word",this._textDirection=0,this._resolutionMode="auto",this._fixedScaleFactor=1,this._iconObjectClass=null,this._htmlString="",this._isHtmlStringUpToDate=!1,this._readAloud=!1,this._screenReaderText=null,this._typewriterStartTime=-1,this._typewriterEndTime=-1,this._typewriterLength=0,this._rendererText=EA.New(EA.Gfx.RendererText,this._runtime.GetRenderer(),{timeout:5}),this._rendererText.ontextureupdate=()=>this._runtime.UpdateRender(),this._animationframeimagechange_handler=()=>this._OnIconObjectClassImageChanged(),this._pendingUpdateIconSet=!1,this._didUpdateTextCanvas=!1,this._beforerender_handler=()=>this._OnBeforeRender(),this._beforerender2_handler=()=>this._OnBeforeRender2(),t){this._text=t[BA],this._enableBBcode=!!t[kA],this._faceName=t[LA],this._ptSize=t[NA],this._lineHeightOffset=t[WA],this._isBold=!!t[UA],this._isItalic=!!t[VA],this._horizontalAlign=t[jA],this._verticalAlign=t[zA],this._wrapMode=eM[t[XA]],this._textDirection=t[YA],this._SetIconObjectClass(this._runtime.GetObjectClassBySID(t[qA]));const e=t[HA];this._color.setRgb(e[0],e[1],e[2]),this.GetWorldInfo().SetVisible(t[KA]),this._readAloud=!!t[$A]}this._UpdateTextSettings(),this._UpdateScreenReaderText(),this._runtime.Dispatcher().addEventListener("beforerender",this._beforerender_handler),this._runtime.Dispatcher().addEventListener("beforerender2",this._beforerender2_handler)}Release(){this._runtime.Dispatcher().removeEventListener("beforerender2",this._beforerender2_handler),this._beforerender2_handler=null,this._runtime.Dispatcher().removeEventListener("beforerender",this._beforerender_handler),this._beforerender_handler=null,this._SetIconObjectClass(null),this._CancelTypewriter(),this._screenReaderText&&(this._screenReaderText.Release(),this._screenReaderText=null),this._rendererText.Release(),this._rendererText=null,super.Release()}_UpdateTextSettings(){const e=this._rendererText;e.SetText(this._text),e.SetBBCodeEnabled(this._enableBBcode),this._rendererText.IsBBCodeEnabled()&&this._iconObjectClass?this._rendererText.SetIconSet(this.GetRuntime().GetTextIconSet(this._iconObjectClass)):this._rendererText.SetIconSet(null),e.SetIconSmoothing("nearest"!==this._runtime.GetSampling()),e.SetFontName(this._faceName),e.SetLineHeight(this._lineHeightOffset),e.SetBold(this._isBold),e.SetItalic(this._isItalic),e.SetColor(this._color),e.SetHorizontalAlignment(JA[this._horizontalAlign]),e.SetVerticalAlignment(ZA[this._verticalAlign]),e.SetWordWrapMode(this._wrapMode),e.SetTextDirection(QA[this._textDirection])}_UpdateTextSize(){const e=this.GetWorldInfo();this._rendererText.SetText(this._text),this._rendererText.SetFontSize(this._ptSize),this._rendererText.SetFontSizeScale(e.GetSceneGraphScale());const t=e.GetLayer();let s;"auto"===this._resolutionMode?(s=t.GetResolutionScaleFactorToZ(e.GetTotalZElevation()),this._rendererText.SetMipMapEnabled(!1)):"fixed"===this._resolutionMode&&(s=this._fixedScaleFactor,this._rendererText.SetMipMapEnabled(!0)),e.HasMesh()&&s!==this._rendererText.GetZoom()&&e.SetMeshChanged(!0),this._rendererText.SetSize(e.GetWidth(),e.GetHeight(),s)}_SetIconObjectClass(e){e&&(e.IsFamily()||e.GetPlugin().constructor!==EA.Plugins.Sprite)||e!==this._iconObjectClass&&(this._iconObjectClass&&this._iconObjectClass.Dispatcher().removeEventListener("animationframeimagechange",this._animationframeimagechange_handler),this._iconObjectClass=e,this._iconObjectClass&&this._iconObjectClass.Dispatcher().addEventListener("animationframeimagechange",this._animationframeimagechange_handler),this._UpdateTextSettings(),this._isHtmlStringUpToDate=!1,this._runtime.UpdateRender())}_OnIconObjectClassImageChanged(){this._runtime.DeleteTextIconSet(this._iconObjectClass),this._runtime.UpdateRender(),this._pendingUpdateIconSet=!0}_UpdateScreenReaderText(){if(this._readAloud){let e=this._text;this._enableBBcode&&(e=EA.BBString.StripAnyTags(e)),this._screenReaderText?this._screenReaderText.SetText(e):this._screenReaderText=EA.New(EA.ScreenReaderText,this._runtime,e)}else this._screenReaderText&&(this._screenReaderText.Release(),this._screenReaderText=null)}_OnBeforeRender(){this._didUpdateTextCanvas=!1;const e=this.GetWorldInfo(),t=e.GetLayer(),s=e.GetLayout();e.IsVisible()&&e.IsInViewport(t.GetViewport(),s.HasVanishingPointOutsideViewport(),s.IsOrthographicProjection())&&(this._UpdateTextForDraw(),this._didUpdateTextCanvas=this._rendererText.MaybeUpdateCanvas())}_OnBeforeRender2(){this._didUpdateTextCanvas&&this._rendererText.GetTexture()}_UpdateTextForDraw(){this._UpdateTextSize(),this._pendingUpdateIconSet&&(this._pendingUpdateIconSet=!1,this._rendererText.IsBBCodeEnabled()&&this._iconObjectClass&&this._rendererText.SetIconSet(this.GetRuntime().GetTextIconSet(this._iconObjectClass)))}Draw(e){const t=this._runtime.GetCanvasManager().IsPastingToDrawingCanvas();t&&this._UpdateTextForDraw();const s=this._rendererText.GetTexture();if(!s)return;const i=this.GetWorldInfo(),r=i.GetLayer();if(0!==i.GetAngle()||0!==r.GetAngle()||0!==i.GetTotalZElevation()||i.HasMesh()||!r.RendersIn2DMode()||t)e.SetTexture(s),i.HasMesh()?this._DrawMesh(i,e):this._DrawStandard(i,e);else{const t=i.GetBoundingQuad(),[n,a]=r.LayerToDrawSurface(t.getTlx(),t.getTly()),[o,h]=r.LayerToDrawSurface(t.getBrx(),t.getBry()),l=n-Math.round(n),c=a-Math.round(a);tM.set(n,a,o,h),tM.offset(-l,-c),sM.setFromRect(tM);const[u,d]=e.GetRenderTargetSize(e.GetRenderTarget());e.IsWebGL()?this._runtime.GetCanvasManager().SetDeviceTransform(e,u,d):(e.SetNormalizedCoordsProgramVariant(!0),sM.divide(u,d)),e.SetTexture(s),e.Quad3(sM,this._rendererText.GetTexRect()),e.IsWebGL()?r._SetTransform(e):e.SetNormalizedCoordsProgramVariant(!1)}}_DrawStandard(e,t){let s=e.GetBoundingQuad();this._runtime.IsPixelRoundingEnabled()&&(s=this._PixelRoundQuad(s)),t.Quad3(s,this._rendererText.GetTexRect())}_DrawMesh(e,t){const s=e.GetTransformedMesh();if(e.IsMeshChanged()){e.CalculateBbox(tM,sM,!1);let t=sM;this._runtime.IsPixelRoundingEnabled()&&(t=this._PixelRoundQuad(t)),s.CalculateTransformedMesh(e.GetSourceMesh(),t,this._rendererText.GetTexRect()),e.SetMeshChanged(!1)}s.Draw(t,e.GetTotalZElevation())}_PixelRoundQuad(e){const t=e.getTlx()-Math.round(e.getTlx()),s=e.getTly()-Math.round(e.getTly());return 0===t&&0===s?e:(sM.copy(e),sM.offset(-t,-s),sM)}GetCurrentSurfaceSize(){const e=this._rendererText.GetTexture();return e?[e.GetWidth(),e.GetHeight()]:[100,100]}GetCurrentTexRect(){return this._rendererText.GetTexRect()}IsCurrentTexRotated(){return!1}SaveToJson(){const e={t:this._text,c:this._color.toJSON(),fn:this._faceName,ps:this._ptSize};return this._enableBBcode&&(e.bbc=this._enableBBcode),0!==this._horizontalAlign&&(e.ha=this._horizontalAlign),0!==this._verticalAlign&&(e.va=this._verticalAlign),"word"!==this._wrapMode&&(e.wr=this._wrapMode),0!==this._lineHeightOffset&&(e.lho=this._lineHeightOffset),this._isBold&&(e.b=this._isBold),this._isItalic&&(e.i=this._isItalic),-1!==this._typewriterEndTime&&(e.tw={st:this._typewriterStartTime,en:this._typewriterEndTime,l:this._typewriterLength}),this._iconObjectClass&&(e.ioc=this._iconObjectClass.GetSID()),"fixed"===this._resolutionMode&&(e.fs=this._fixedScaleFactor),e}LoadFromJson(e){if(this._CancelTypewriter(),this._text=e.t,this._color.setFromJSON(e.c),this._faceName=e.fn,this._ptSize=e.ps,this._enableBBcode=!!e.hasOwnProperty("bbc")&&e.bbc,this._horizontalAlign=e.hasOwnProperty("ha")?e.ha:0,this._verticalAlign=e.hasOwnProperty("va")?e.va:0,e.hasOwnProperty("wr")){const t=e.wr;this._wrapMode="boolean"==typeof t?t?"word":"character":t}else this._wrapMode="word";if(this._lineHeightOffset=e.hasOwnProperty("lho")?e.lho:0,this._isBold=!!e.hasOwnProperty("b")&&e.b,this._isItalic=!!e.hasOwnProperty("i")&&e.i,e.hasOwnProperty("tw")){const t=e.tw;this._typewriterStartTime=t.st,this._typewriterEndTime=t.en,this._typewriterLength=t.l}if(e.hasOwnProperty("ioc")){const t=this.GetRuntime().GetObjectClassBySID(e.ioc);t&&this._SetIconObjectClass(t)}else this._SetIconObjectClass(null);e.hasOwnProperty("fs")?(this._resolutionMode="fixed",this._fixedScaleFactor=e.fs):this._resolutionMode="auto",this._UpdateTextSettings(),this._UpdateScreenReaderText(),this._isHtmlStringUpToDate=!1,-1!==this._typewriterEndTime&&this._StartTicking()}GetPropertyValueByIndex(e){switch(e){case BA:return this.GetText();case kA:return this._enableBBcode;case LA:return this._GetFontFace();case NA:return this._GetFontSize();case WA:return this._GetLineHeight();case UA:return this._IsBold();case VA:return this._IsItalic();case HA:return OA[0]=this._color.getR(),OA[1]=this._color.getG(),OA[2]=this._color.getB(),OA;case jA:return this._GetHAlign();case zA:return this._GetVAlign();case XA:return this._GetWrapMode();case $A:return this._IsReadAloud()}}SetPropertyValueByIndex(e,t){switch(e){case BA:this._SetText(t);break;case kA:if(this._enableBBcode===!!t)return;this._enableBBcode=!!t,this._UpdateTextSettings();break;case LA:this._SetFontFace(t);break;case NA:this._SetFontSize(t);break;case WA:this._SetLineHeight(t);break;case UA:this._SetBold(t);break;case VA:this._SetItalic(t);break;case HA:const e=this._color,s=t;if(e.getR()===s[0]&&e.getG()===s[1]&&e.getB()===s[2])return;this._color.setRgb(s[0],s[1],s[2]),this._UpdateTextSettings();break;case jA:this._SetHAlign(t);break;case zA:this._SetVAlign(t);break;case XA:this._SetWrapMode(t)}}SetPropertyColorOffsetValueByIndex(e,t,s,i){0===t&&0===s&&0===i||e!==HA||(this._color.addRgb(t,s,i),this._UpdateTextSettings())}_SetText(e){this._text!==e&&(this._text=e,this._UpdateScreenReaderText(),this._isHtmlStringUpToDate=!1,this._runtime.UpdateRender())}GetText(){return this._text}_StartTypewriter(e,t){this._SetText(e),this._UpdateTextSize(),this._typewriterStartTime=this._runtime.GetWallTime(),this._typewriterEndTime=this._typewriterStartTime+t/this.GetInstance().GetActiveTimeScale(),this._typewriterLength=this._rendererText.GetLengthInGraphemes(),this._rendererText.SetDrawMaxCharacterCount(0),this._StartTicking()}_CancelTypewriter(){this._typewriterStartTime=-1,this._typewriterEndTime=-1,this._typewriterLength=0,this._rendererText.SetDrawMaxCharacterCount(-1),this._StopTicking()}_FinishTypewriter(){-1!==this._typewriterEndTime&&(this._CancelTypewriter(),this.Trigger(EA.Plugins.Text.Cnds.OnTypewriterTextFinished),this._runtime.UpdateRender())}_SetFontFace(e){this._faceName!==e&&(this._faceName=e,this._rendererText.SetFontName(e),this._runtime.UpdateRender())}_GetFontFace(){return this._faceName}_SetBold(e){e=!!e,this._isBold!==e&&(this._isBold=e,this._rendererText.SetBold(e),this._runtime.UpdateRender())}_IsBold(){return this._isBold}_SetItalic(e){e=!!e,this._isItalic!==e&&(this._isItalic=e,this._rendererText.SetItalic(e),this._runtime.UpdateRender())}_IsItalic(){return this._isItalic}_SetFontSize(e){this._ptSize!==e&&(this._ptSize=e,this._runtime.UpdateRender())}_GetFontSize(){return this._ptSize}_SetFontColor(e){this._color.equalsIgnoringAlpha(e)||(this._color.copyRgb(e),this._rendererText.SetColor(this._color),this._runtime.UpdateRender())}_GetFontColor(){return this._color}_SetLineHeight(e){this._lineHeightOffset!==e&&(this._lineHeightOffset=e,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetLineHeight(){return this._lineHeightOffset}_SetHAlign(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetHAlign(){return this._horizontalAlign}_SetVAlign(e){this._verticalAlign!==e&&(this._verticalAlign=e,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetVAlign(){return this._verticalAlign}_SetWrapModeByIndex(e){this._SetWrapMode(eM[e])}_SetWrapMode(e){this._wrapMode!==e&&(this._wrapMode=e,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetWrapMode(){return this._wrapMode}_SetTextDirection(e){this._textDirection!==e&&(this._textDirection=e,this._UpdateTextSettings(),this._runtime.UpdateRender())}_GetTextDirection(){return this._textDirection}_SetReadAloud(e){this._readAloud=!!e,this._UpdateScreenReaderText()}_IsReadAloud(){return this._readAloud}_SetResolutionMode(e){this._resolutionMode!==e&&(this._resolutionMode=e,this._runtime.UpdateRender())}_GetResolutionMode(){return this._resolutionMode}_SetFixedScaleFactor(e){this._fixedScaleFactor!==e&&(this._fixedScaleFactor=e,"fixed"===this._resolutionMode&&this._runtime.UpdateRender())}_GetFixedScaleFactor(){return this._fixedScaleFactor}_GetTextWidth(){return this._UpdateTextSize(),this._rendererText.GetTextWidth()}_GetTextHeight(){return this._UpdateTextSize(),this._rendererText.GetTextHeight()}_GetTagAtPosition(e,t){this._UpdateTextSize();const s=this.GetWorldInfo();rM.set(e-s.GetX(),t-s.GetY()),rM.rotate(-s.GetAngle()),rM.offset(s.GetWidth()*s.GetOriginX(),s.GetHeight()*s.GetOriginY()),rM.divide(s.GetWidth(),s.GetHeight()),rM.scale(this._rendererText.GetWidth(),this._rendererText.GetHeight());const i=this._rendererText.HitTestFragment(rM.getX(),rM.getY());if(i){const e=i.GetStyleTag("tag");if(e)return e.param}return""}_HasTagAtPosition(e,t,s){const i=this._GetTagAtPosition(t,s);return i&&EA.equalsNoCase(e,i)}_GetTagPosition(e,t){this._UpdateTextSize(),t=Math.floor(t);const s=this._rendererText.FindFragmentWithTag(e,t);if(!s)return null;const i=this.GetWorldInfo(),r=this._rendererText.GetDrawScale(),n=s.GetPosX(),a=s.GetPosY()-(s.GetHeight()-s.GetFontBoundingBoxDescent())*r,o=s.GetWidth()*r/this._rendererText.GetWidth()*i.GetWidth(),h=s.GetHeight()*r/this._rendererText.GetHeight()*i.GetHeight();return rM.set(n,a),rM.divide(this._rendererText.GetWidth(),this._rendererText.GetHeight()),rM.scale(i.GetWidth(),i.GetHeight()),rM.offset(-i.GetWidth()*i.GetOriginX(),-i.GetHeight()*i.GetOriginY()),rM.rotate(i.GetAngle()),rM.offset(i.GetX(),i.GetY()),{x:rM.getX(),y:rM.getY(),width:o,height:h}}_GetTagCount(e){return this._UpdateTextSize(),this._rendererText.CountFragmentsWithTag(e)}_GetHTMLCloseTag(e){let t=nM.get(e);return null===t?"":(t||(t="span"),`</${t||"span"}>`)}_GetHTMLOpenTag(e,t){let s=nM.get(e);if(null===s)return"";switch(s||(s="span"),e){case"color":return`<${s} style="color: ${t}">`;case"font":return`<${s} style="font-family: '${t}'">`;case"opacity":return`<${s} style="opacity: ${t}%">`;case"size":return`<${s} style="font-size: ${t}pt">`;case"background":return`<${s} style="background-color: ${t}">`;case"hide":return`<${s} style="visibility: hidden">`;case"class":return`<${s} class="${t}">`;case"tag":return`<${s} data-tag="${t}">`;default:return`<${s}>`}}async _UpdateHTMLString(){if(this._isHtmlStringUpToDate)return this._htmlString;const e=new EA.BBString(this._text,{noEscape:!0}).toFragmentList(),t=new Map;let s='<span class="c3-text"';const i=[];i.push(`font-family: '${this._GetFontFace()}';`),this._IsBold()&&i.push("font-weight: bold;"),this._IsItalic()&&i.push("font-style: italic;"),"character"===this._GetWrapMode()&&i.push("word-break: break-all;"),s+=` style="${i.join(" ")}">`;const r=this._iconObjectClass?this.GetRuntime().GetTextIconSet(this._iconObjectClass):null;if(this._iconObjectClass){const s=EA.New(EA.PromiseThrottle),i=[],n=new Map;for(const t of e)if(t.IsIcon()){const e=t.GetTextIcon(r);if(e){const t=e.GetSource().GetImageInfo().GetImageAsset();if(n.has(t))continue;n.set(t,null),i.push(s.Add(async()=>{const e=await t.LoadToDrawable();n.set(t,e)}))}}await Promise.all(i);const a=[];for(const i of e)if(i.IsIcon()){const e=i.GetTextIcon(r);if(e){const i=e.GetSource(),r=i.GetImageInfo().GetImageAsset();a.push(s.Add(async()=>{const s=await i.GetImageInfo().ExtractImageToBlobURL(n.get(r));t.set(e,s)}))}}await Promise.all(a);for(const e of n.values())e instanceof ImageBitmap&&e.close&&e.close()}const n=new Map;for(const i of e){const e=i.GetStyleMap();let a=[...n.keys()];a.reverse();for(const t of a)e.has(t)&&e.get(t)===n.get(t)||(n.delete(t),s+=this._GetHTMLCloseTag(t));for(const[t,i]of e)n.has(t)||(n.set(t,i),s+=this._GetHTMLOpenTag(t,i));if(i.IsText()&&(s+=EA.ReplaceAll(EA.EscapeHTML(i.GetCharacterArray().join("")),"\n","<br>")),i.IsIcon()&&r){const n=i.GetTextIcon(r);if(n){const r=t.get(n);if(r){const t=[];let a="0.2em";const o=e.get("iconoffsety");if(o){let e=o.trim();a=e.endsWith("%")?parseFloat(e)/100+"em":e+"px"}t.push(`top: ${a}`),"nearest"===this._runtime.GetSampling()&&t.push("image-rendering: pixelated"),s+=`<img class="c3-text-icon" data-icon="${i.GetIconParameter()}" width="${n.GetWidth()}" height="${n.GetHeight()}" style="${t.join(";")}" src="${r}">`}}}}const a=[...n.keys()];a.reverse();for(const e of a)s+=this._GetHTMLCloseTag(e);return s+="</span>",this._htmlString=s,this._isHtmlStringUpToDate=!0,this._htmlString}Tick(){const e=this._runtime.GetWallTime();if(e>=this._typewriterEndTime)this._CancelTypewriter(),this.Trigger(EA.Plugins.Text.Cnds.OnTypewriterTextFinished),this._runtime.UpdateRender();else{let t=EA.relerp(this._typewriterStartTime,this._typewriterEndTime,e,0,this._typewriterLength);t=Math.floor(t),t!==this._rendererText.GetDrawMaxCharacterCount()&&(this._rendererText.SetDrawMaxCharacterCount(t),this._runtime.UpdateRender())}}GetDebuggerProperties(){const e="plugins.text";return[{title:e+".name",properties:[{name:e+".properties.text.name",value:this.GetText(),onedit:e=>this._SetText(e)},{name:e+".properties.font.name",value:this._GetFontFace(),onedit:e=>this._SetFontFace(e)},{name:e+".properties.size.name",value:this._GetFontSize(),onedit:e=>this._SetFontSize(e)},{name:e+".properties.line-height.name",value:this._GetLineHeight(),onedit:e=>this._SetLineHeight(e)},{name:e+".properties.bold.name",value:this._IsBold(),onedit:e=>this._SetBold(e)},{name:e+".properties.italic.name",value:this._IsItalic(),onedit:e=>this._SetItalic(e)},{name:e+".debugger.text-width",value:this._GetTextWidth()},{name:e+".debugger.text-height",value:this._GetTextHeight()}]}]}GetScriptInterfaceClass(){return self.ITextInstance}};const aM=new WeakMap,oM=new Map([["left",0],["center",1],["right",2]]),hM=new Map([["top",0],["center",1],["bottom",2]]),lM=["ltr","rtl"];self.ITextInstance=class extends self.IWorldInstance{constructor(){super(),aM.set(this,self.IInstance._GetInitInst().GetSdkInstance())}get text(){return aM.get(this).GetText()}set text(e){FA.RequireString(e);const t=aM.get(this);t._CancelTypewriter(),t._SetText(e)}typewriterText(e,t){FA.RequireString(e),FA.RequireFiniteNumber(t);const s=aM.get(this);s._CancelTypewriter(),s._StartTypewriter(e,t)}typewriterFinish(){aM.get(this)._FinishTypewriter()}set fontFace(e){FA.RequireString(e),aM.get(this)._SetFontFace(e)}get fontFace(){return aM.get(this)._GetFontFace()}set isBold(e){aM.get(this)._SetBold(e)}get isBold(){return aM.get(this)._IsBold()}set isItalic(e){aM.get(this)._SetItalic(e)}get isItalic(){return aM.get(this)._IsItalic()}set sizePt(e){FA.RequireFiniteNumber(e),aM.get(this)._SetFontSize(e)}get sizePt(){return aM.get(this)._GetFontSize()}set fontColor(e){if(FA.RequireArray(e),e.length<3)throw new Error("expected 3 elements");iM.setRgb(e[0],e[1],e[2]),aM.get(this)._SetFontColor(iM)}get fontColor(){const e=aM.get(this)._GetFontColor();return[e.getR(),e.getG(),e.getB()]}set lineHeight(e){FA.RequireFiniteNumber(e),aM.get(this)._SetLineHeight(e)}get lineHeight(){return aM.get(this)._GetLineHeight()}set horizontalAlign(e){FA.RequireString(e);const t=oM.get(e);if(void 0===t)throw new Error("invalid mode");aM.get(this)._SetHAlign(t)}get horizontalAlign(){return JA[aM.get(this)._GetHAlign()]}set verticalAlign(e){FA.RequireString(e);const t=hM.get(e);if(void 0===t)throw new Error("invalid mode");aM.get(this)._SetVAlign(t)}get verticalAlign(){return ZA[aM.get(this)._GetVAlign()]}set wordWrapMode(e){if(!eM.includes(e))throw new Error("invalid mode");aM.get(this)._SetWrapMode(e)}get wordWrapMode(){return aM.get(this)._GetWrapMode()}set textDirection(e){FA.RequireString(e);const t=lM.indexOf(e);if(-1===t)throw new Error("invalid text direction");aM.get(this)._SetTextDirection(t)}get textDirection(){return lM[aM.get(this)._GetTextDirection()]}set readAloud(e){aM.get(this)._SetReadAloud(!!e)}get readAloud(){return aM.get(this)._IsReadAloud()}setFixedResolutionMode(e){FA.RequireFiniteNumber(e);const t=aM.get(this);t._SetResolutionMode("fixed"),t._SetFixedScaleFactor(e)}setAutoResolutionMode(){aM.get(this)._SetResolutionMode("auto")}get textWidth(){return aM.get(this)._GetTextWidth()}get textHeight(){return aM.get(this)._GetTextHeight()}getTextSize(){const e=aM.get(this);return[e._GetTextWidth(),e._GetTextHeight()]}hasTagAtPosition(e,t,s){return FA.RequireString(e),FA.RequireFiniteNumber(t),FA.RequireFiniteNumber(s),aM.get(this)._HasTagAtPosition(e,t,s)}getTagAtPosition(e,t){return FA.RequireFiniteNumber(e),FA.RequireFiniteNumber(t),aM.get(this)._GetTagAtPosition(e,t)}getTagPositionAndSize(e,t=0){return FA.RequireString(e),FA.RequireFiniteNumber(t),aM.get(this)._GetTagPosition(e,t)}getTagCount(e){return FA.RequireString(e),aM.get(this)._GetTagCount(e)}changeIconSet(e){const t=aM.get(this),s=t.GetRuntime()._UnwrapIObjectClass(e);t._SetIconObjectClass(s)}getAsHtmlString(){return aM.get(this)._UpdateHTMLString()}}}{const cM=self.C3;cM.Plugins.Text.Cnds={CompareText(e,t){return t?this._text===e:cM.equalsNoCase(this._text,e)},IsRunningTypewriterText(){return-1!==this._typewriterEndTime},OnTypewriterTextFinished:()=>!0,HasTagAtPosition(e,t,s){return this._HasTagAtPosition(e,t,s)}}}{const uM=self.C3,dM=uM.New(uM.Color);uM.Plugins.Text.Acts={SetText(e){this._CancelTypewriter(),"number"==typeof e&&e<1e9&&(e=Math.round(1e10*e)/1e10),this._SetText(e.toString())},AppendText(e){this._CancelTypewriter(),"number"==typeof e&&e<1e9&&(e=Math.round(1e10*e)/1e10),(e=e.toString())&&this._SetText(this._text+e)},TypewriterText(e,t){this._CancelTypewriter(),"number"==typeof e&&e<1e9&&(e=Math.round(1e10*e)/1e10),this._StartTypewriter(e.toString(),t)},SetFontFace(e,t){let s=!1,i=!1;switch(t){case 1:s=!0;break;case 2:i=!0;break;case 3:s=!0,i=!0}e===this._faceName&&s===this._isBold&&i===this._isItalic||(this._SetFontFace(e),this._SetBold(s),this._SetItalic(i))},SetFontSize(e){this._SetFontSize(e)},SetFontColor(e){dM.setFromRgbValue(e),dM.clamp(),this._SetFontColor(dM)},SetWebFont(e,t){console.warn("[Text] 'Set web font' action is deprecated and no longer has any effect")},SetEffect(e){this.GetWorldInfo().SetBlendMode(e),this._runtime.UpdateRender()},TypewriterFinish(){this._FinishTypewriter()},SetLineHeight(e){this._SetLineHeight(e)},SetHAlign(e){this._SetHAlign(e)},SetVAlign(e){this._SetVAlign(e)},SetWrapping(e){this._SetWrapModeByIndex(e)},SetTextDirection(e){this._SetTextDirection(e)},ChangeIconSet(e){this._SetIconObjectClass(e)},UpdateHTML(){return this._UpdateHTMLString()},SetReadAloud(e){this._SetReadAloud(e)},SetResolutionMode(e,t){this._SetResolutionMode(["auto","fixed"][e]),this._SetFixedScaleFactor(t)}}}{const _M=self.C3;_M.Plugins.Text.Exps={Text(){return this._text},PlainText(){return this._enableBBcode?_M.BBString.StripAnyTags(this._text):this._text},FaceName(){return this._faceName},FaceSize(){return this._ptSize},TextWidth(){return this._GetTextWidth()},TextHeight(){return this._GetTextHeight()},LineHeight(){return this._lineHeightOffset},TagAtPosition(e,t){return this._GetTagAtPosition(e,t)},TagCount(e){return this._GetTagCount(e)},TagX(e,t){const s=this._GetTagPosition(e,t);return s?s.x:0},TagY(e,t){const s=this._GetTagPosition(e,t);return s?s.y:0},TagWidth(e,t){const s=this._GetTagPosition(e,t);return s?s.width:0},TagHeight(e,t){const s=this._GetTagPosition(e,t);return s?s.height:0},AsHTML(){return this._htmlString}}}{const pM=self.C3;pM.Plugins.Spritefont2=class extends pM.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const fM=self.C3;fM.Plugins.Spritefont2.Type=class extends fM.SDKTypeBase{constructor(e){super(e),this._spriteFont=fM.New(self.SpriteFont)}Release(){super.Release()}OnCreate(){this.GetImageInfo().LoadAsset(this._runtime)}LoadTextures(e){return this.GetImageInfo().LoadStaticTexture(e,{sampling:this._runtime.GetSampling()})}ReleaseTextures(){this.GetImageInfo().ReleaseTexture()}GetSpriteFont(){return this._spriteFont}UpdateSettings(e,t,s,i){const r=this.GetImageInfo(),n=this._spriteFont;n.SetWidth(r.GetWidth()),n.SetHeight(r.GetHeight()),n.SetCharacterWidth(e),n.SetCharacterHeight(t),n.SetCharacterSet(s),n.SetSpacingData(i),n.UpdateCharacterMap()}}}{const mM=self.C3,gM=self.C3X,SM=mM.New(mM.Vector2),GM=0,yM=1,IM=2,TM=3,CM=4,bM=5,xM=6,wM=7,PM=8,RM=9,vM=10,AM=11,MM=14,DM=["left","center","right"],EM=["top","center","bottom"],FM=["word","cjk","character"];mM.Plugins.Spritefont2.Instance=class extends mM.SDKWorldInstanceBase{constructor(e,t){super(e),this._text="",this._enableBBcode=!0,this._characterWidth=16,this._characterHeight=16,this._characterSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789.,;:?!-_~#\"'&()[]|`\\/@+=*$<>";let s="";this._characterScale=1,this._characterSpacing=0,this._lineHeight=0,this._horizontalAlign=0,this._verticalAlign=0,this._wrapMode="word",this._needsTextLayout=!0,this._readAloud=!1,this._screenReaderText=null,this._spriteFontText=null,this._typewriterStartTime=-1,this._typewriterEndTime=-1,this._typewriterLength=0,t&&(this._text=t[0],this._enableBBcode=t[1],this._characterWidth=t[2],this._characterHeight=t[3],this._characterSet=t[4],s=t[5],this._characterScale=t[6],this._characterSpacing=t[7],this._lineHeight=t[8],this._horizontalAlign=t[9],this._verticalAlign=t[10],this._wrapMode=FM[t[11]],this.GetWorldInfo().SetVisible(t[12]),this._readAloud=!!t[MM]),this._sdkType.UpdateSettings(this._characterWidth,this._characterHeight,this._characterSet,s),this._spriteFontText=mM.New(self.SpriteFontText,this._sdkType.GetSpriteFont());const i=this.GetWorldInfo();this._spriteFontText.SetSize(i.GetWidth(),i.GetHeight()),this._UpdateSettings(),this._UpdateScreenReaderText(),this._inst.SetMustMitigateZFighting()}Release(){this._CancelTypewriter(),this._screenReaderText&&(this._screenReaderText.Release(),this._screenReaderText=null),this._spriteFontText.Release(),this._spriteFontText=null,super.Release()}_UpdateSettings(){const e=this._spriteFontText;e&&(e.SetBBCodeEnabled(this._enableBBcode),e.SetText(this._text),e.SetWordWrapMode(this._wrapMode),e.SetHorizontalAlign(DM[this._horizontalAlign]),e.SetVerticalAlign(EM[this._verticalAlign]),e.SetSpacing(this._characterSpacing),e.SetLineHeight(this._lineHeight))}_UpdateTextSize(){const e=this.GetWorldInfo();this._spriteFontText.SetSize(e.GetWidth(),e.GetHeight()),this._spriteFontText.SetScale(this._characterScale)}_UpdateScreenReaderText(){if(this._readAloud){let e=this._text;this._enableBBcode&&(e=mM.BBString.StripAnyTags(e)),this._screenReaderText?this._screenReaderText.SetText(e):this._screenReaderText=mM.New(mM.ScreenReaderText,this._runtime,e)}else this._screenReaderText&&(this._screenReaderText.Release(),this._screenReaderText=null)}Draw(e){const t=this._objectClass.GetImageInfo(),s=t.GetTexture();if(!s)return;e.SetTexture(s);const i=this.GetWorldInfo();let r=i.GetBoundingQuad();const n=this._spriteFontText;n.SetScale(this._characterScale),n.SetSceneGraphScale(i.GetSceneGraphScale()),this._runtime.IsPixelRoundingEnabled()&&(r=i.PixelRoundQuad(r)),n.SetSize(i.GetWidth(),i.GetHeight()),n.GetSpriteFont().SetTexRect(t.GetTexRect()),n.SetColor(i.GetUnpremultipliedColor()),n.Draw(e,r.getTlx(),r.getTly(),i.GetAngle()),this._needsTextLayout=!1}SaveToJson(){const e={t:this._text,ebbc:this._enableBBcode,csc:this._characterScale,csp:this._characterSpacing,lh:this._lineHeight,ha:this._horizontalAlign,va:this._verticalAlign,w:this._wrapMode,cw:this._sdkType.GetSpriteFont().GetCharacterWidth(),ch:this._sdkType.GetSpriteFont().GetCharacterHeight(),cs:this._sdkType.GetSpriteFont().GetCharacterSet(),sd:this._sdkType.GetSpriteFont().GetSpacingData()};return-1!==this._typewriterEndTime&&(e.tw={st:this._typewriterStartTime,en:this._typewriterEndTime,l:this._typewriterLength}),e}LoadFromJson(e){if(this._CancelTypewriter(),this._text=e.t,this._enableBBcode=e.ebbc,this._characterScale=e.csc,this._characterSpacing=e.csp,this._lineHeight=e.lh,this._horizontalAlign=e.ha,this._verticalAlign=e.va,e.hasOwnProperty("w")){const t=e.w;this._wrapMode="boolean"==typeof t?t?"word":"character":t}else this._wrapMode="word";if(e.hasOwnProperty("tw")){const t=e.tw;this._typewriterStartTime=t.st,this._typewriterEndTime=t.en,this._typewriterLength=e.l}const t=this._sdkType.GetSpriteFont();t.SetCharacterWidth(e.cw),t.SetCharacterHeight(e.ch),t.SetCharacterSet(e.cs),t.SetSpacingData(e.sd),this._UpdateSettings(),this._UpdateScreenReaderText(),-1!==this._typewriterEndTime&&this._StartTicking()}GetPropertyValueByIndex(e){switch(e){case GM:return this.GetText();case yM:return this._enableBBcode;case IM:return this._sdkType.GetSpriteFont().GetCharacterWidth();case TM:return this._sdkType.GetSpriteFont().GetCharacterHeight();case CM:return this._sdkType.GetSpriteFont().GetCharacterSet();case bM:return this._sdkType.GetSpriteFont().GetSpacingData();case xM:return this._GetScale();case wM:return this._GetCharacterSpacing();case PM:return this._GetLineHeight();case RM:return this._GetHAlign();case vM:return this._GetVAlign();case AM:return this._GetWrapMode()}}SetPropertyValueByIndex(e,t){switch(e){case GM:this._SetText(t);break;case yM:if(this._enableBBcode===!!t)return;this._enableBBcode=!!t,this._UpdateSettings();break;case IM:this._sdkType.GetSpriteFont().SetCharacterWidth(t);break;case TM:this._sdkType.GetSpriteFont().SetCharacterHeight(t);break;case CM:this._sdkType.GetSpriteFont().SetCharacterSet(t);break;case bM:this._sdkType.GetSpriteFont().SetSpacingData(t);break;case xM:this._SetScale(t);break;case wM:this._SetCharacterSpacing(t);break;case PM:this._SetLineHeight(t);break;case RM:this._SetHAlign(t);break;case vM:this._SetVAlign(t);break;case AM:this._SetWrapMode(t)}}_SetText(e){this._text!==e&&(this._text=e,this._spriteFontText.SetText(e),this._UpdateScreenReaderText(),this._runtime.UpdateRender())}GetText(){return this._text}_StartTypewriter(e,t){this._SetText(e),this._typewriterStartTime=this._runtime.GetWallTime(),this._typewriterEndTime=this._typewriterStartTime+t/this.GetInstance().GetActiveTimeScale(),this._typewriterLength=mM.CountGraphemes(mM.BBString.StripAnyTags(e)),this._spriteFontText.SetDrawMaxCharacterCount(0),this._StartTicking()}_CancelTypewriter(){this._typewriterStartTime=-1,this._typewriterEndTime=-1,this._typewriterLength=0,this._spriteFontText.SetDrawMaxCharacterCount(-1),this._StopTicking()}_FinishTypewriter(){-1!==this._typewriterEndTime&&(this._CancelTypewriter(),this.Trigger(mM.Plugins.Spritefont2.Cnds.OnTypewriterTextFinished),this._runtime.UpdateRender())}_SetScale(e){this._characterScale!==e&&(this._characterScale=e,this._spriteFontText.SetScale(this._characterScale),this._runtime.UpdateRender())}_GetScale(){return this._characterScale}_SetCharacterSpacing(e){this._characterSpacing!==e&&(this._characterSpacing=e,this._spriteFontText.SetSpacing(this._characterSpacing),this._runtime.UpdateRender())}_GetCharacterSpacing(){return this._characterSpacing}_SetLineHeight(e){this._lineHeight!==e&&(this._lineHeight=e,this._spriteFontText.SetLineHeight(this._lineHeight),this._runtime.UpdateRender())}_GetLineHeight(){return this._lineHeight}_SetHAlign(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this._UpdateSettings(),this._runtime.UpdateRender())}_GetHAlign(){return this._horizontalAlign}_SetVAlign(e){this._verticalAlign!==e&&(this._verticalAlign=e,this._UpdateSettings(),this._runtime.UpdateRender())}_GetVAlign(){return this._verticalAlign}_SetWrapModeByIndex(e){this._SetWrapMode(FM[e])}_SetWrapMode(e){this._wrapMode!==e&&(this._wrapMode=e,this._UpdateSettings(),this._runtime.UpdateRender())}_GetWrapMode(){return this._wrapMode}_SetReadAloud(e){this._readAloud=!!e,this._UpdateScreenReaderText()}_IsReadAloud(){return this._readAloud}_GetTextWidth(){return this._UpdateTextSize(),this._spriteFontText.GetTextWidth()}_GetTextHeight(){return this._UpdateTextSize(),this._spriteFontText.GetTextHeight()}_GetTagAtPosition(e,t){this._UpdateTextSize();const s=this.GetWorldInfo();SM.set(e-s.GetX(),t-s.GetY()),SM.rotate(-s.GetAngle()),SM.offset(s.GetWidth()*s.GetOriginX(),s.GetHeight()*s.GetOriginY());const i=this._spriteFontText.HitTestFragment(SM.getX(),SM.getY());if(i){const e=i.GetStyleTag("tag");if(e)return e.param}return""}_HasTagAtPosition(e,t,s){const i=this._GetTagAtPosition(t,s);return i&&mM.equalsNoCase(e,i)}_GetTagPosition(e,t){this._UpdateTextSize(),t=Math.floor(t);const s=this._spriteFontText.FindFragmentWithTag(e,t);if(!s)return null;const i=this.GetWorldInfo();return SM.set(s.GetPosX(),s.GetPosY()),SM.offset(-i.GetWidth()*i.GetOriginX(),-i.GetHeight()*i.GetOriginY()),SM.rotate(i.GetAngle()),SM.offset(i.GetX(),i.GetY()),{x:SM.getX(),y:SM.getY(),width:s.GetWidth(),height:s.GetHeight()}}_GetTagCount(e){return this._UpdateTextSize(),this._spriteFontText.CountFragmentsWithTag(e)}Tick(){const e=this._runtime.GetWallTime();if(e>=this._typewriterEndTime)this._CancelTypewriter(),this.Trigger(mM.Plugins.Spritefont2.Cnds.OnTypewriterTextFinished),this._runtime.UpdateRender();else{let t=mM.relerp(this._typewriterStartTime,this._typewriterEndTime,e,0,this._typewriterLength);t=Math.floor(t),t!==this._spriteFontText.GetDrawMaxCharacterCount()&&(this._spriteFontText.SetDrawMaxCharacterCount(t),this._runtime.UpdateRender())}}GetDebuggerProperties(){const e="plugins.spritefont2";return[{title:e+".name",properties:[{name:e+".properties.text.name",value:this.GetText(),onedit:e=>this._SetText(e)},{name:e+".properties.scale.name",value:this._GetScale(),onedit:e=>this._SetScale(e)},{name:e+".properties.character-spacing.name",value:this._GetCharacterSpacing(),onedit:e=>this._SetCharacterSpacing(e)},{name:e+".properties.line-height.name",value:this._GetLineHeight(),onedit:e=>this._SetLineHeight(e)},{name:e+".debugger.text-width",value:this._GetTextWidth()},{name:e+".debugger.text-height",value:this._GetTextHeight()}]}]}GetScriptInterfaceClass(){return self.ISpriteFontInstance}};const OM=new WeakMap,BM=new Map([["left",0],["center",1],["right",2]]),kM=new Map([["top",0],["center",1],["bottom",2]]);self.ISpriteFontInstance=class extends self.IWorldInstance{constructor(){super(),OM.set(this,self.IInstance._GetInitInst().GetSdkInstance())}get text(){return OM.get(this).GetText()}set text(e){gM.RequireString(e);const t=OM.get(this);t._CancelTypewriter(),t._SetText(e)}typewriterText(e,t){gM.RequireString(e),gM.RequireFiniteNumber(t);const s=OM.get(this);s._CancelTypewriter(),s._StartTypewriter(e,t)}typewriterFinish(){OM.get(this)._FinishTypewriter()}set characterScale(e){gM.RequireFiniteNumber(e),OM.get(this)._SetScale(e)}get characterScale(){return OM.get(this)._GetScale()}set characterSpacing(e){gM.RequireFiniteNumber(e),OM.get(this)._SetCharacterSpacing(e)}get characterSpacing(){return OM.get(this)._GetCharacterSpacing()}set lineHeight(e){gM.RequireFiniteNumber(e),OM.get(this)._SetLineHeight(e)}get lineHeight(){return OM.get(this)._GetLineHeight()}set horizontalAlign(e){gM.RequireString(e);const t=BM.get(e);if(void 0===t)throw new Error("invalid mode");OM.get(this)._SetHAlign(t)}get horizontalAlign(){return DM[OM.get(this)._GetHAlign()]}set verticalAlign(e){gM.RequireString(e);const t=kM.get(e);if(void 0===t)throw new Error("invalid mode");OM.get(this)._SetVAlign(t)}get verticalAlign(){return EM[OM.get(this)._GetVAlign()]}set wordWrapMode(e){if(!FM.includes(e))throw new Error("invalid mode");OM.get(this)._SetWrapMode(e)}get wordWrapMode(){return OM.get(this)._GetWrapMode()}set readAloud(e){OM.get(this)._SetReadAloud(!!e)}get readAloud(){return OM.get(this)._IsReadAloud()}get textWidth(){return OM.get(this)._GetTextWidth()}get textHeight(){return OM.get(this)._GetTextHeight()}getTextSize(){const e=OM.get(this);return[e._GetTextWidth(),e._GetTextHeight()]}hasTagAtPosition(e,t,s){return gM.RequireString(e),gM.RequireFiniteNumber(t),gM.RequireFiniteNumber(s),OM.get(this)._HasTagAtPosition(e,t,s)}getTagAtPosition(e,t){return gM.RequireFiniteNumber(e),gM.RequireFiniteNumber(t),OM.get(this)._GetTagAtPosition(e,t)}getTagPositionAndSize(e,t=0){return gM.RequireString(e),gM.RequireFiniteNumber(t),OM.get(this)._GetTagPosition(e,t)}getTagCount(e){return gM.RequireString(e),OM.get(this)._GetTagCount(e)}}}{const LM=self.C3;LM.Plugins.Spritefont2.Cnds={CompareText(e,t){return t?this._text===e:LM.equalsNoCase(this._text,e)},IsRunningTypewriterText(){return-1!==this._typewriterEndTime},OnTypewriterTextFinished:()=>!0,HasTagAtPosition(e,t,s){return this._HasTagAtPosition(e,t,s)}}}self.C3.Plugins.Spritefont2.Acts={SetText(e){this._CancelTypewriter(),"number"==typeof e&&e<1e9&&(e=Math.round(1e10*e)/1e10),this._SetText(e.toString())},AppendText(e){this._CancelTypewriter(),"number"==typeof e&&e<1e9&&(e=Math.round(1e10*e)/1e10),(e=e.toString())&&this._SetText(this._text+e)},TypewriterText(e,t){this._CancelTypewriter(),"number"==typeof e&&e<1e9&&(e=Math.round(1e10*e)/1e10),this._StartTypewriter(e.toString(),t)},TypewriterFinish(){this._FinishTypewriter()},SetScale(e){this._SetScale(e)},SetCharacterSpacing(e){this._SetCharacterSpacing(e)},SetLineHeight(e){this._SetLineHeight(e)},SetCharacterWidth(e,t){let s=!1;const i=this._sdkType.GetSpriteFont();for(const r of e)if(" "===r)i.SetSpaceWidth(t),s=!0;else{const e=i.GetCharacter(r);e&&(e.SetDisplayWidth(t),s=!0)}s&&i.SetCharacterWidthsChanged(),this._runtime.UpdateRender()},SetEffect(e){this.GetWorldInfo().SetBlendMode(e),this._runtime.UpdateRender()},SetHAlign(e){this._SetHAlign(e)},SetVAlign(e){this._SetVAlign(e)},SetWrapping(e){this._SetWrapModeByIndex(e)},SetReadAloud(e){this._SetReadAloud(e)}};{const NM=self.C3;NM.Plugins.Spritefont2.Exps={CharacterWidth(e){const t=this._sdkType.GetSpriteFont().GetCharacter(e);return t?t.GetDisplayWidth():this._sdkType.GetSpriteFont().GetCharacterWidth()},CharacterHeight(){return this._characterHeight},CharacterScale(){return this._characterScale},CharacterSpacing(){return this._characterSpacing},LineHeight(){return this._lineHeight},Text(){return this._text},PlainText(){return this._enableBBcode?NM.BBString.StripAnyTags(this._text):this._text},TextWidth(){return this._GetTextWidth()},TextHeight(){return this._GetTextHeight()},TagAtPosition(e,t){return this._GetTagAtPosition(e,t)},TagCount(e){return this._GetTagCount(e)},TagX(e,t){const s=this._GetTagPosition(e,t);return s?s.x:0},TagY(e,t){const s=this._GetTagPosition(e,t);return s?s.y:0},TagWidth(e,t){const s=this._GetTagPosition(e,t);return s?s.width:0},TagHeight(e,t){const s=this._GetTagPosition(e,t);return s?s.height:0}}}{const WM=self.C3;self.SpriteFontCharacter=class{constructor(e,t,s,i){let r=e.GetCharacterWidth(),n=e.GetCharacterHeight();this._spriteFont=e,this._char=t,this._pxRect=new WM.Rect(s,i,s+r,i+n),this._texRect=new WM.Rect,this._displayWidth=-1,this._UpdateTexRect()}Release(){this._spriteFont=null,this._pxRect=null,this._texRect=null}_UpdateTexRect(){let e=this._spriteFont.GetWidth(),t=this._spriteFont.GetHeight();this._texRect.copy(this._pxRect),this._texRect.divide(e,t),this._texRect.lerpInto(this._spriteFont.GetTexRect())}GetSpriteFont(){return this._spriteFont}GetChar(){return this._char}GetTexRect(){return this._texRect}SetDisplayWidth(e){this._displayWidth=e}GetDisplayWidth(){return this._displayWidth<0?this._spriteFont.GetCharacterWidth():this._displayWidth}}}{let UM=function(e,t){e=e.trim();const s=parseFloat(e);return isFinite(s)?e.endsWith("%")?t*s/100:s:0},VM=function(e){return $M||($M=HM.CreateCanvas(32,32).getContext("2d")),$M.fillStyle="#FFFFFF",$M.fillStyle=e,$M.fillStyle};getOffsetParam=UM,normalizeCssColorString=VM;const HM=self.C3,jM=new HM.Rect,zM=new HM.Quad,XM=new HM.Color,YM=new Set(["left","center","right"]),qM=new Set(["top","center","bottom"]),KM=new Set(["word","cjk","character"]);let $M=null;self.SpriteFontText=class{constructor(e){this._spriteFont=e,this._cssWidth=0,this._cssHeight=0,this._text="",this._isBBcodeEnabled=!1,this._bbString=null,this._wrappedText=HM.New(HM.WordWrap),this._wrapMode="word",this._wordWrapChanged=!1,this._textLayoutChanged=!1,this._horizontalAlign="left",this._verticalAlign="top",this._scale=1,this._sceneGraphScale=1,this._spacing=0,this._lineHeight=0,this._color=HM.New(HM.Color),this._drawMaxCharCount=-1,this._drawCharCount=0,this._measureTextCallback=e=>this._MeasureText(e),this._spriteFont._AddSpriteFontText(this)}Release(){this._spriteFont._RemoveSpriteFontText(this),this._color=null,this._measureTextCallback=null,this._wrappedText.Clear(),this._wrappedText=null,this._spriteFont=null,this._bbString=null}_MeasureText(e){if(e.IsIcon())return{width:0,height:0};const t=e.GetCharacterArray(),s=e.GetStyleTag("scale"),i=(s?parseFloat(s.param):this._scale)*this._sceneGraphScale,r=e.GetStyleTag("scalex"),n=(r?parseFloat(r.param):1)*i,a=e.GetStyleTag("scaley"),o=(a?parseFloat(a.param):1)*i,h=this._spriteFont.GetCharacterHeight()*o+this._lineHeight,l=this.GetSpriteFont(),c=l.GetCharacterWidth()*n,u=this.GetSpacing();if(l.HasAnyCustomWidths()){let e=0,s=0;for(const i of t){let t=c;const r=l.GetCharacter(i);r?t=r.GetDisplayWidth()*n:" "===i&&(t=l.GetSpaceWidth()*n),s+=t,++e}return{width:s+e*u,height:h}}{const e=t.length;return{width:c*e+Math.max(e,0)*u,height:h}}}_SetTextLayoutChanged(){this._textLayoutChanged=!0}_SetWordWrapChanged(){this._SetTextLayoutChanged(),this._wordWrapChanged=!0,this._wrappedText.Clear()}SetSize(e,t){e<=0||t<=0||this._cssWidth===e&&this._cssHeight===t||(this._cssWidth!==e?this._SetWordWrapChanged():this._SetTextLayoutChanged(),this._cssWidth=e,this._cssHeight=t)}SetDrawMaxCharacterCount(e){this._drawMaxCharCount=Math.floor(e)}GetDrawMaxCharacterCount(){return this._drawMaxCharCount}HitTestFragment(e,t){this._UpdateTextMeasurements();const s=this._wrappedText.GetLines();for(const i of s)if(t>i.GetPosY()&&t<i.GetPosY()+i.GetHeight())for(const t of i.fragments())if(e>=t.GetPosX()&&e<t.GetPosX()+t.GetWidth())return t;return null}*fragmentsWithTag(e){this._UpdateTextMeasurements();const t=this._wrappedText.GetLines();for(const s of t)for(const t of s.fragments()){const s=t.GetStyleTag("tag");s&&HM.equalsNoCase(s.param,e)&&(yield t)}}FindFragmentWithTag(e,t){for(const s of this.fragmentsWithTag(e)){if(0===t)return s;--t}return null}CountFragmentsWithTag(e){let t=0;for(const s of this.fragmentsWithTag(e))++t;return t}_UpdateTextMeasurements(){this._UpdateWordWrap(),this._UpdateTextLayout()}_UpdateWordWrap(){if(!this._wordWrapChanged)return;!this._isBBcodeEnabled||this._bbString&&this._bbString.toString()===this._text||(this._bbString=new HM.BBString(this._text,{noEscape:!0}));const e=-this.GetSpacing();this._wrappedText.WordWrap(this._isBBcodeEnabled?this._bbString.toFragmentList():this._text,this._measureTextCallback,this._cssWidth,this._wrapMode,e),this._wordWrapChanged=!1}_UpdateTextLayout(){this._textLayoutChanged&&(this._LayoutText(),this._textLayoutChanged=!1)}_LayoutText(){let e=0;const t=this._lineHeight,s=HM.cloneArray(this._wrappedText.GetLines());for(const e of s){e.SetPosX(NaN),e.SetPosY(NaN);for(const t of e.fragments())t.SetPosX(NaN),t.SetPosY(NaN)}const i=s.reduce((e,t)=>e+t.GetHeight(),0)-t;"center"===this._verticalAlign?e=Math.max(Math.floor(this._cssHeight/2-i/2),0):"bottom"===this._verticalAlign&&(e=Math.floor(this._cssHeight-i));for(let i=0,r=s.length;i<r;++i){const r=s[i],n=r.GetHeight();if(i>0&&e>this._cssHeight-(n-t))break;e>=0&&this._LayoutTextLine(r,e),e+=n}}_LayoutTextLine(e,t){let s=0;"center"===this._horizontalAlign?s=Math.max(Math.floor((this._cssWidth-e.GetWidth())/2),0):"right"===this._horizontalAlign&&(s=Math.max(Math.floor(this._cssWidth-e.GetWidth()),0)),e.SetPosX(s),e.SetPosY(t);for(const i of e.fragments())i.IsIcon()||(this._LayoutTextFragment(i,s,t),s+=i.GetWidth())}_LayoutTextFragment(e,t,s){const i=e.GetStyleTag("offsetx");t+=i?UM(i.param,e.GetHeight()):0;const r=e.GetStyleTag("offsety");s+=r?UM(r.param,e.GetHeight()):0,e.SetPosX(t),e.SetPosY(s)}Draw(e,t,s,i){this._UpdateTextMeasurements(),this._drawCharCount=0;const r=HM.cloneArray(this._wrappedText.GetLines()),n=Math.sin(i),a=Math.cos(i);for(const i of r)this._DrawLine(e,i,t,s,n,a)}_DrawLine(e,t,s,i,r,n){const a=t.GetPosX(),o=t.GetPosY();if(!Number.isFinite(a)||!Number.isFinite(o))return;const h=t.GetHeight();for(const a of t.fragments())this._DrawFragment(e,a,s,i,r,n,h)}_DrawFragment(e,t,s,i,r,n,a){let o=t.GetPosX(),h=t.GetPosY();if(!Number.isFinite(o)||!Number.isFinite(h))return;let l=t.GetCharacterArray(),c=t.GetWidth();if(-1!==this._drawMaxCharCount){if(this._drawCharCount>=this._drawMaxCharCount)return;this._drawCharCount+l.length>this._drawMaxCharCount&&(l=l.slice(0,this._drawMaxCharCount-this._drawCharCount),c=this._MeasureText(t).width),this._drawCharCount+=l.length}const u=t.GetStyleTag("background");if(HM.IsCharArrayAllWhitespace(l)&&!u||t.HasStyleTag("hide"))return;const d=t.GetStyleTag("scale"),_=(d?parseFloat(d.param):this._scale)*this._sceneGraphScale,p=t.GetStyleTag("scalex"),f=(p?parseFloat(p.param):1)*_,m=t.GetStyleTag("scaley"),g=(m?parseFloat(m.param):1)*_,S=this._spriteFont.GetCharacterHeight()*g;h+=a-this._lineHeight-S;let G=1;const y=t.GetStyleTag("opacity");y&&(G=parseFloat(y.param)/100),u&&(e.SetColorFillMode(),XM.parseString(VM(u.param)),XM.setA(XM.getA()*G*this._color.getA()),XM.premultiply(),e.SetColor(XM),jM.set(o,h,o+c,h+S),jM.getRight()>this._cssWidth&&jM.setRight(this._cssWidth),zM.setFromRotatedRectPrecalc(jM,r,n),zM.offset(s,i),e.Quad(zM),e.SetTextureFillMode());const I=t.GetStyleTag("color");I?(XM.parseString(VM(I.param)),XM.setA(this._color.getA())):XM.copy(this._color),XM.setA(XM.getA()*G),XM.premultiply(),e.SetColor(XM);const T=this._spriteFont.GetCharacterWidth()*f,C=Math.abs(this.GetSpacing());for(const t of l){const a=this._spriteFont.GetCharacter(t);if(a){const t=a.GetDisplayWidth()*f;if(o+t>this._cssWidth+C+1e-5)return;jM.set(o,h,o+T,h+S),zM.setFromRotatedRectPrecalc(jM,r,n),zM.offset(s,i),e.Quad3(zM,a.GetTexRect()),o+=t+this._spacing}else o+=this._spriteFont.GetSpaceWidth()*f+this._spacing}}GetSpriteFont(){return this._spriteFont}SetBBCodeEnabled(e){e=!!e,this._isBBcodeEnabled!==e&&(this._isBBcodeEnabled=e,this._SetWordWrapChanged())}IsBBCodeEnabled(){return this._isBBcodeEnabled}SetText(e){this._text!==e&&(this._text=e,this._SetWordWrapChanged())}SetWordWrapMode(e){if(!KM.has(e))throw new Error("invalid word wrap mode");this._wrapMode!==e&&(this._wrapMode=e,this._SetWordWrapChanged())}SetHorizontalAlign(e){if(!YM.has(e))throw new Error("invalid alignment");this._horizontalAlign!==e&&(this._horizontalAlign=e,this._SetTextLayoutChanged())}SetVerticalAlign(e){if(!qM.has(e))throw new Error("invalid alignment");this._verticalAlign!==e&&(this._verticalAlign=e,this._SetTextLayoutChanged())}SetScale(e){this._scale!==e&&(this._scale=e,this._SetWordWrapChanged())}GetScale(){return this._scale}SetSceneGraphScale(e){this._sceneGraphScale!==e&&(this._sceneGraphScale=e,this._SetWordWrapChanged())}GetSceneGraphScale(){return this._sceneGraphScale}SetSpacing(e){this._spacing!==e&&(this._spacing=e,this._SetWordWrapChanged())}GetSpacing(){return this._spacing}SetLineHeight(e){this._lineHeight=e,this._SetWordWrapChanged()}GetLineHeight(){return this._lineHeight}SetOpacity(e){e=HM.clamp(e,0,1),this._color.a=e}SetColor(e){this._color.equals(e)||this._color.copy(e)}GetColor(){return this._color}GetTextWidth(){return this._UpdateTextMeasurements(),this._wrappedText.GetMaxLineWidth()}GetTextHeight(){this._UpdateTextMeasurements();const e=this._spriteFont.GetCharacterHeight()*this._scale,t=this._lineHeight,s=e+t;return this._wrappedText.GetLineCount()*s-t}}}{const JM=self.C3,ZM=self.SpriteFontText,QM={width:256,height:256,characterWidth:16,characterHeight:16,characterSet:""};self.SpriteFont=class{constructor(e){if((e=Object.assign({},QM,e)).width<=0||e.height<=0||e.characterWidth<=0||e.characterHeight<=0)throw new Error("invalid size");this._width=e.width,this._height=e.height,this._characterWidth=e.characterWidth,this._characterHeight=e.characterHeight,this._characterSet=e.characterSet,this._spacingData="",this._spacingParsed=null,this._hasAnyCustomWidths=!1,this._spaceWidth=-1,this._texRect=new JM.Rect(0,0,1,1),this._characterMap=new Map,this._mapChanged=!0,this._allTexts=new Set}Release(){this._texRect=null,this._ReleaseCharacters(),this._characterMap=null,this._allTexts&&this._allTexts.clear(),this._allTexts=null}_ReleaseCharacters(){for(let e of this._characterMap.values())e.Release();this._characterMap.clear()}_AddSpriteFontText(e){this._allTexts.add(e)}_RemoveSpriteFontText(e){this._allTexts.delete(e)}UpdateCharacterMap(){if(!this._mapChanged)return;this._ReleaseCharacters();let e=JM.SplitGraphemes(this._characterSet),t=Math.floor(this._width/this._characterWidth),s=t*Math.floor(this._height/this._characterHeight);for(let i=0,r=e.length;i<r&&!(i>=s);++i){let s=e[i];if(this._characterMap.has(s))continue;let r=i%t,n=Math.floor(i/t);this._characterMap.set(s,JM.New(self.SpriteFontCharacter,this,s,r*this._characterWidth,n*this._characterHeight))}if(this._hasAnyCustomWidths=!1,this._spaceWidth=-1,Array.isArray(this._spacingParsed))for(let e of this._spacingParsed){if(!Array.isArray(e))continue;if(2!==e.length)continue;let t=e[0],s=e[1];if("number"==typeof t&&isFinite(t)&&"string"==typeof s&&t!==this._characterWidth)for(let e of s){let s=this._characterMap.get(e);s?(s.SetDisplayWidth(t),this._hasAnyCustomWidths=!0):" "===e&&(this._spaceWidth=t,this._hasAnyCustomWidths=!0)}}this._mapChanged=!1;for(let e of this._allTexts)e._SetWordWrapChanged()}SetCharacterWidthsChanged(){this._hasAnyCustomWidths=!0;for(const e of this._allTexts)e._SetWordWrapChanged()}GetCharacter(e){return this.UpdateCharacterMap(),this._characterMap.get(e)||null}HasAnyCustomWidths(){return this._hasAnyCustomWidths}SetWidth(e){if((e=Math.floor(e))<=0)throw new Error("invalid size");this._width!==e&&(this._width=e,this._mapChanged=!0)}GetWidth(){return this._width}SetHeight(e){if((e=Math.floor(e))<=0)throw new Error("invalid size");this._height!==e&&(this._height=e,this._mapChanged=!0)}GetHeight(){return this._height}SetTexRect(e){if(!this._texRect.equals(e)){this._texRect.copy(e);for(const e of this._characterMap.values())e._UpdateTexRect()}}GetTexRect(){return this._texRect}SetCharacterWidth(e){if((e=Math.floor(e))<=0)throw new Error("invalid size");this._characterWidth!==e&&(this._characterWidth=e,this._mapChanged=!0)}GetCharacterWidth(){return this._characterWidth}SetCharacterHeight(e){if((e=Math.floor(e))<=0)throw new Error("invalid size");this._characterHeight!==e&&(this._characterHeight=e,this._mapChanged=!0)}GetCharacterHeight(){return this._characterHeight}SetCharacterSet(e){this._characterSet!==e&&(this._characterSet=e,this._mapChanged=!0)}GetCharacterSet(){return this._characterSet}SetSpacingData(e){if(this._spacingData!==e&&(this._spacingData=e,this._mapChanged=!0,this._spacingParsed=null,this._spacingData.length))try{this._spacingParsed=JSON.parse(this._spacingData)}catch(e){this._spacingParsed=null}}GetSpacingData(){return this._spacingData}SetSpaceWidth(e){e<0&&(e=-1),this._spaceWidth!==e&&(this._spaceWidth=e,this._spaceWidth>=0&&(this._hasAnyCustomWidths=!0))}GetSpaceWidth(){return this._spaceWidth<0?this._characterWidth:this._spaceWidth}}}{const eD=self.C3;eD.Plugins.Particles=class extends eD.SDKPluginBase{constructor(e){super(e)}Release(){super.Release()}}}{const tD=self.C3;tD.Plugins.Particles.Type=class extends tD.SDKTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){this.GetImageInfo().LoadAsset(this._runtime)}LoadTextures(e){return this.GetImageInfo().LoadStaticTexture(e,{sampling:this._runtime.GetSampling()})}ReleaseTextures(){this.GetImageInfo().ReleaseTexture()}}}{let sD=function(e){return vD.get(e).GetParticleEngine()};GetParticleEngine=sD;const iD=self.C3,rD=self.C3X,nD=0,aD=1,oD=2,hD=3,lD=4,cD=5,uD=6,dD=7,_D=8,pD=9,fD=10,mD=11,gD=12,SD=13,GD=14,yD=15,ID=16,TD=17,CD=18,bD=19,xD=20,wD=0,PD=1,RD=iD.New(iD.Rect);iD.Plugins.Particles.Instance=class extends iD.SDKWorldInstanceBase{constructor(e,t){super(e),this._isFirstTick=!0;const s=iD.New(self.ParticleEngine);this._particleEngine=s,s.ononeshotfinish=()=>this._OnOneShotFinish(),this._spawnObjectClass=null,this._particleUpdateCallback=(e,t,s,i,r,n)=>this._OnParticleUpdate(e,t,s,i,r,n),this._particleDestroyCallback=e=>this._OnParticleDestroy(e),this._hasAnyDefaultParticle=!0;let i=!0;t&&(s.SetRate(t[nD]),s.SetSprayCone(iD.toRadians(t[aD])),s.SetSprayType(t[oD]?"one-shot":"continuous-spray"),this._SetParticleObjectClass(this._runtime.GetObjectClassBySID(t[hD])),i=t[lD],s.SetInitSpeed(t[cD]),s.SetInitSize(t[uD]),s.SetInitOpacity(t[dD]/100),s.SetGrowRate(t[_D]),s.SetInitXRandom(t[pD]),s.SetInitYRandom(t[fD]),s.SetInitSpeedRandom(t[mD]),s.SetInitSizeRandom(t[gD]),s.SetGrowRandom(t[SD]),s.SetAcceleration(t[GD]),s.SetGravity(t[yD]),s.SetLifeAngleRandom(t[ID]),s.SetLifeSpeedRandom(t[TD]),s.SetLifeOpacityRandom(t[CD]),s.SetDestroyModeIndex(t[bD]),s.SetTimeout(t[xD])),this._UpdateEngineParameters(),this._spawnObjectClass&&(this._hasAnyDefaultParticle=!1),"one-shot"===s.GetSprayType()?s.CreateOneShotSpray():s.SetSpraying(!0);const r=this.GetWorldInfo();r.SetVisible(i),r.SetBboxChangeEventEnabled(!0),this._inst.Dispatcher().addEventListener("bboxchange",()=>{r.OverwriteBoundingBox(this._particleEngine.GetBoundingBox())}),this.GetRuntime().GetRenderer().IsWebGPU()&&r.SetUsePointsShaderProgram(),this._afterLoad=e=>this._OnAfterLoad(e),this.GetRuntime().Dispatcher().addEventListener("afterload",this._afterLoad),this._StartTicking()}Release(){this.GetRuntime().Dispatcher().removeEventListener("afterload",this._afterLoad),this._afterLoad=null,this._particleEngine.Release(),this._particleEngine=null,this._particleUpdateCallback=null,this._particleDestroyCallback=null,super.Release()}GetParticleEngine(){return this._particleEngine}_SetRate(e){this._particleEngine.SetRate(e),"one-shot"===this._particleEngine.GetSprayType()&&this._isFirstTick&&this._particleEngine.SetParticleCount(e)}_SetParticleObjectClass(e){e===this.GetObjectClass()&&(e=null),e!==this._spawnObjectClass&&(this._spawnObjectClass=e,this._particleEngine.onparticlecreate=e?e=>this._OnParticleCreate(e):null,this._spawnObjectClass||(this._hasAnyDefaultParticle=!0))}_UpdateEngineParameters(){const e=this._particleEngine,t=this.GetWorldInfo();e.SetMasterOpacity(t.GetOpacity()),e.SetPixelRounding(this._runtime.IsPixelRoundingEnabled()),e.SetSpawnX(t.GetX()),e.SetSpawnY(t.GetY()),e.SetSpawnAngle(t.GetAngle()),e.SetInitSizeScale(Math.abs(t.GetSceneGraphScale()))}_OnOneShotFinish(){this._runtime.DestroyInstance(this._inst)}Draw(e){if(!this._hasAnyDefaultParticle)return;const t=this._objectClass.GetImageInfo(),s=t.GetTexture();if(!s)return;const i=this.GetWorldInfo(),r=i.GetLayer(),n=RD;this._runtime.GetCanvasManager().IsPastingToDrawingCanvas()?n.set(-1/0,-1/0,1/0,1/0):r.Has3DCamera()?r.CalculateViewport3D(i.GetTotalZElevation(),n):r.GetViewportForZ(i.GetTotalZElevation(),n),e.SetTexture(s);const a=r.Get2DScaleFactorToZ(i.GetTotalZElevation());this._particleEngine.SetParticleScale(r.GetRenderScale()*a),this._particleEngine.Draw(e,t.GetTexQuad(),n,r.Has3DCamera())}SaveToJson(){const e=this._particleEngine;return{r:e.GetRate(),sc:e.GetSprayCone(),st:e.GetSprayType(),isp:e.GetInitSpeed(),isz:e.GetInitSize(),io:e.GetInitOpacity(),gr:e.GetGrowRate(),xr:e.GetInitXRandom(),yr:e.GetInitYRandom(),spr:e.GetInitSpeedRandom(),szr:e.GetInitSizeRandom(),grnd:e.GetGrowRandom(),acc:e.GetAcceleration(),g:e.GetGravity(),lar:e.GetLifeAngleRandom(),lsr:e.GetLifeSpeedRandom(),lor:e.GetLifeOpacityRandom(),dm:e.GetDestroyModeIndex(),to:e.GetTimeout(),s:e.IsSpraying(),pcc:e._GetCreateCounter(),ft:this._isFirstTick,soc:this._spawnObjectClass?this._spawnObjectClass.GetSID():null,p:e.GetParticles().map(e=>e.toJSON())}}LoadFromJson(e,t){const s=this._particleEngine;if(s.SetRate(e.r),s.SetSprayCone(e.sc),s.SetSprayType(e.st),s.SetInitSpeed(e.isp),s.SetInitSize(e.isz),s.SetInitOpacity(e.io),s.SetGrowRate(e.gr),s.SetInitXRandom(e.xr),s.SetInitYRandom(e.yr),s.SetInitSpeedRandom(e.spr),s.SetInitSizeRandom(e.szr),s.SetGrowRandom(e.grnd),s.SetAcceleration(e.acc),s.SetGravity(e.g),s.SetLifeAngleRandom(e.lar),s.SetLifeSpeedRandom(e.lsr),s.SetLifeOpacityRandom(e.lor),s.SetDestroyModeIndex(e.dm),s.SetTimeout(e.to),s.SetSpraying(e.s),s._SetCreateCounter(e.pcc),this._isFirstTick=e.ft,e.hasOwnProperty("soc")){const t=this.GetRuntime().GetObjectClassBySID(e.soc);t&&this._SetParticleObjectClass(t)}const i=e.p;s.SetParticleCount(i.length,!1);const r=s.GetParticles();for(let e=0,t=r.length;e<t;++e)r[e].setFromJSON(i[e]);"state"===t&&this._spawnObjectClass&&(s.UpdateAllParticlesUserData(),s.ApplyParticleDataToUserData(this))}_OnAfterLoad(){const e=this._particleEngine;e.UpdateAllParticlesUserData(),e.ApplyParticleDataToUserData(this);const t=e.GetParticles();for(let e=0,s=t.length;e<s;++e){const s=t[e],i=s.GetUserData();if(!i)continue;const r=i.GetWorldInfo();if(!r)continue;const n=r.GetInstance();if(!n)continue;const a=s.GetUserDataUID(),o=n.GetUID();if(("number"!=typeof a||"number"!=typeof o||a!==o)&&"number"==typeof a){const e=this.GetRuntime(),t=e.GetInstanceByUID(a);t&&e.DestroyInstance(t)}}}Tick(){const e=this._runtime.GetDt(this._inst);this._UpdateEngineParameters(),this._isFirstTick&&"one-shot"===this._particleEngine.GetSprayType()&&this._particleEngine.ReInitAllParticles(),this._particleEngine.Tick(e),this._particleEngine.IsSpraying()&&this._runtime.UpdateRender(),this.GetWorldInfo().SetBboxChanged(),this._isFirstTick=!1}_FastForward(e){const t=1/60;for(this._isFirstTick&&"one-shot"===this._particleEngine.GetSprayType()&&this._particleEngine.ReInitAllParticles();e>0;)this._particleEngine.Tick(t),e-=t;this._particleEngine.IsSpraying()&&this._runtime.UpdateRender(),this.GetWorldInfo().SetBboxChanged(),this._isFirstTick=!1}_OnParticleCreate(e,t){let s;"number"==typeof t&&(s=this._runtime.GetInstanceByUID(t)),s&&s.GetObjectClass()!==this._spawnObjectClass&&(s=null),s||(s=this._runtime.CreateInstance(this._spawnObjectClass,this.GetWorldInfo().GetLayer(),e.GetX(),e.GetY()));const i=s.GetWorldInfo();return i.SetSize(e.GetSize(),e.GetSize()),i.SetAngle(e.GetAngle()),i.SetOpacity(e.GetOpacity()),i.SetUnpremultipliedColor(this.GetWorldInfo().GetUnpremultipliedColor()),i.SetBboxChanged(),i.ZOrderMoveAdjacentToInstance(this.GetInstance(),!0),s._TriggerOnCreated(),e.SetUpdateCallback(this._particleUpdateCallback),e.SetDestroyCallback(this._particleDestroyCallback),s}_OnParticleUpdate(e,t,s,i,r,n){if(e.IsDestroyed())return;const a=e.GetWorldInfo();a.OffsetXY(t,s),a.SetSize(a.GetWidth()+i,a.GetHeight()+i),a.SetAngle(a.GetAngle()+r),a.SetOpacity(a.GetOpacity()+n),a.SetBboxChanged()}_OnParticleDestroy(e){e.IsDestroyed()||this._runtime.DestroyInstance(e)}GetPropertyValueByIndex(e){const t=this._particleEngine;switch(e){case nD:return t.GetRate();case aD:return iD.toDegrees(t.GetSprayCone());case oD:return"one-shot"===t.GetSprayType()?PD:wD;case cD:return t.GetInitSpeed();case uD:return t.GetInitSize();case dD:return 100*t.GetInitOpacity();case _D:return t.GetGrowRate();case pD:return t.GetInitXRandom();case fD:return t.GetInitYRandom();case mD:return t.GetInitSpeedRandom();case gD:return t.GetInitSizeRandom();case SD:return t.GetGrowRandom();case GD:return t.GetAcceleration();case yD:return t.GetGravity();case ID:return t.GetLifeAngleRandom();case TD:return t.GetLifeSpeedRandom();case CD:return t.GetLifeOpacityRandom();case bD:return t.GetDestroyModeIndex();case xD:return t.GetTimeout()}}SetPropertyValueByIndex(e,t){const s=this._particleEngine;switch(e){case nD:s.SetRate(t);break;case aD:s.SetSprayCone(iD.toRadians(t));break;case oD:s.SetSprayType(t?"one-shot":"continuous-spray");break;case cD:s.SetInitSpeed(t);break;case uD:s.SetInitSize(t);break;case dD:s.SetInitOpacity(t/100);break;case _D:s.SetGrowRate(t);break;case pD:s.SetInitXRandom(t);break;case fD:s.SetInitYRandom(t);break;case mD:s.SetInitSpeedRandom(t);break;case gD:s.SetInitSizeRandom(t);break;case SD:s.SetGrowRandom(t);break;case GD:s.SetAcceleration(t);break;case yD:s.SetGravity(t);break;case ID:s.SetLifeAngleRandom(t);break;case TD:s.SetLifeSpeedRandom(t);break;case CD:s.SetLifeOpacityRandom(t);break;case bD:s.SetDestroyModeIndex(t);break;case xD:s.SetTimeout(t)}}GetDebuggerProperties(){const e="plugins.particles",t=e+".properties",s=e+".debugger",i=this._particleEngine;return[{title:e+".name",properties:[{name:s+".particle-count",value:i.GetParticleCount()},{name:t+".type.name",value:[t+".type.items."+i.GetSprayType()]},{name:s+".is-spraying",value:i.IsSpraying(),onedit:e=>i.SetSpraying(e)},{name:t+".rate.name",value:i.GetRate(),onedit:e=>i.SetRate(e)},{name:t+".spray-cone.name",value:iD.toDegrees(i.GetSprayCone()),onedit:e=>i.SetSprayCone(iD.toRadians(e))},{name:t+".speed.name",value:i.GetInitSpeed(),onedit:e=>i.SetInitSpeed(e)},{name:t+".size.name",value:i.GetInitSize(),onedit:e=>i.SetInitSize(e)},{name:t+".opacity.name",value:i.GetInitOpacity(),onedit:e=>i.SetInitOpacity(e)},{name:t+".grow-rate.name",value:i.GetGrowRate(),onedit:e=>i.SetGrowRate(e)},{name:t+".x-randomiser.name",value:i.GetInitXRandom(),onedit:e=>i.SetInitXRandom(e)},{name:t+".y-randomiser.name",value:i.GetInitYRandom(),onedit:e=>i.SetInitYRandom(e)},{name:t+".initial-speed-randomiser.name",value:i.GetInitSpeedRandom(),onedit:e=>i.SetInitSpeedRandom(e)},{name:t+".size-randomiser.name",value:i.GetInitSizeRandom(),onedit:e=>i.SetInitSizeRandom(e)},{name:t+".grow-rate-randomiser.name",value:i.GetGrowRandom(),onedit:e=>i.SetGrowRandom(e)},{name:t+".acceleration.name",value:i.GetAcceleration(),onedit:e=>i.SetAcceleration(e)},{name:t+".gravity.name",value:i.GetGravity(),onedit:e=>i.SetGravity(e)},{name:t+".angle-randomiser.name",value:i.GetLifeAngleRandom(),onedit:e=>i.SetLifeAngleRandom(e)},{name:t+".life-speed-randomiser.name",value:i.GetLifeSpeedRandom(),onedit:e=>i.SetLifeSpeedRandom(e)},{name:t+".opacity-randomiser.name",value:i.GetLifeOpacityRandom(),onedit:e=>i.SetLifeOpacityRandom(e)},{name:t+".timeout.name",value:i.GetTimeout(),onedit:e=>i.SetTimeout(e)}]}]}GetScriptInterfaceClass(){return self.IParticlesInstance}};const vD=new WeakMap;self.IParticlesInstance=class extends self.IWorldInstance{constructor(){super(),vD.set(this,self.IInstance._GetInitInst().GetSdkInstance())}set isSpraying(e){sD(this).SetSpraying(!!e)}get isSpraying(){return sD(this).IsSpraying()}set rate(e){rD.RequireFiniteNumber(e),vD.get(this)._SetRate(e)}get rate(){return sD(this).GetRate()}set sprayCone(e){rD.RequireFiniteNumber(e),sD(this).SetSprayCone(e)}get sprayCone(){return sD(this).GetSprayCone()}set initSpeed(e){rD.RequireFiniteNumber(e),sD(this).SetInitSpeed(e)}get initSpeed(){return sD(this).GetInitSpeed()}set initSize(e){rD.RequireFiniteNumber(e),sD(this).SetInitSize(e)}get initSize(){return sD(this).GetInitSize()}set initOpacity(e){rD.RequireFiniteNumber(e),sD(this).SetInitOpacity(e)}get initOpacity(){return sD(this).GetInitOpacity()}set initXRandom(e){rD.RequireFiniteNumber(e),sD(this).SetInitXRandom(e)}get initXRandom(){return sD(this).GetInitXRandom()}set initYRandom(e){rD.RequireFiniteNumber(e),sD(this).SetInitYRandom(e)}get initYRandom(){return sD(this).GetInitYRandom()}set initSpeedRandom(e){rD.RequireFiniteNumber(e),sD(this).SetInitSpeedRandom(e)}get initSpeedRandom(){return sD(this).GetInitSpeedRandom()}set initSizeRandom(e){rD.RequireFiniteNumber(e),sD(this).SetInitSizeRandom(e)}get initSizeRandom(){return sD(this).GetInitSizeRandom()}set initGrowRate(e){rD.RequireFiniteNumber(e),sD(this).SetGrowRate(e)}get initGrowRate(){return sD(this).GetGrowRate()}set initGrowRandom(e){rD.RequireFiniteNumber(e),sD(this).SetGrowRandom(e)}get initGrowRandom(){return sD(this).GetGrowRandom()}set acceleration(e){rD.RequireFiniteNumber(e),sD(this).SetAcceleration(e)}get acceleration(){return sD(this).GetAcceleration()}set gravity(e){rD.RequireFiniteNumber(e),sD(this).SetGravity(e)}get gravity(){return sD(this).GetGravity()}set lifeAngleRandom(e){rD.RequireFiniteNumber(e),sD(this).SetLifeAngleRandom(e)}get lifeAngleRandom(){return sD(this).GetLifeAngleRandom()}set lifeSpeedRandom(e){rD.RequireFiniteNumber(e),sD(this).SetLifeSpeedRandom(e)}get lifeSpeedRandom(){return sD(this).GetLifeSpeedRandom()}set lifeOpacityRandom(e){rD.RequireFiniteNumber(e),sD(this).SetLifeOpacityRandom(e)}get lifeOpacityRandom(){return sD(this).GetLifeOpacityRandom()}set timeout(e){rD.RequireFiniteNumber(e),sD(this).SetTimeout(e)}get timeout(){return sD(this).GetTimeout()}fastForward(e){rD.RequireFiniteNumber(e),vD.get(this)._FastForward(e)}setParticleObjectClass(e){const t=vD.get(this);e?t._SetParticleObjectClass(t.GetRuntime()._UnwrapIObjectClass(e)):t._SetParticleObjectClass(null)}}}self.C3.Plugins.Particles.Cnds={IsSpraying(){return this._particleEngine.IsSpraying()}};{const AD=self.C3;AD.Plugins.Particles.Acts={SetSpraying(e){this._particleEngine.SetSpraying(0!==e)},SetRate(e){this._SetRate(e)},SetParticleObject(e){this._SetParticleObjectClass(e)},UnsetParticleObject(){this._SetParticleObjectClass(null)},SetSprayCone(e){this._particleEngine.SetSprayCone(AD.toRadians(e))},SetInitSpeed(e){this._particleEngine.SetInitSpeed(e)},SetInitSize(e){this._particleEngine.SetInitSize(e)},SetInitOpacity(e){this._particleEngine.SetInitOpacity(e/100)},SetGrowRate(e){this._particleEngine.SetGrowRate(e)},SetXRandomiser(e){this._particleEngine.SetInitXRandom(e)},SetYRandomiser(e){this._particleEngine.SetInitYRandom(e)},SetSpeedRandomiser(e){this._particleEngine.SetInitSpeedRandom(e)},SetSizeRandomiser(e){this._particleEngine.SetInitSizeRandom(e)},SetGrowRateRandomiser(e){this._particleEngine.SetGrowRandom(e)},SetParticleAcc(e){this._particleEngine.SetAcceleration(e)},SetGravity(e){this._particleEngine.SetGravity(e)},SetAngleRandomiser(e){this._particleEngine.SetLifeAngleRandom(e)},SetLifeSpeedRandomiser(e){this._particleEngine.SetLifeSpeedRandom(e)},SetOpacityRandomiser(e){this._particleEngine.SetLifeOpacityRandom(e)},SetTimeout(e){this._particleEngine.SetTimeout(e)},FastForward(e){this._FastForward(e)},SetEffect(e){this.GetWorldInfo().SetBlendMode(e),this._runtime.UpdateRender()}}}{const MD=self.C3;MD.Plugins.Particles.Exps={ParticleCount(){return this._particleEngine.GetParticleCount()},Rate(){return this._particleEngine.GetRate()},SprayCone(){return MD.toDegrees(this._particleEngine.GetSprayCone())},InitSpeed(){return this._particleEngine.GetInitSpeed()},InitSize(){return this._particleEngine.GetInitSize()},InitOpacity(){return 100*this._particleEngine.GetInitOpacity()},InitGrowRate(){return this._particleEngine.GetGrowRate()},XRandom(){return this._particleEngine.GetInitXRandom()},YRandom(){return this._particleEngine.GetInitYRandom()},InitSizeRandom(){return this._particleEngine.GetInitSizeRandom()},InitSpeedRandom(){return this._particleEngine.GetInitSpeedRandom()},InitGrowRandom(){return this._particleEngine.GetGrowRandom()},ParticleAcceleration(){return this._particleEngine.GetAcceleration()},Gravity(){return this._particleEngine.GetGravity()},ParticleAngleRandom(){return this._particleEngine.GetLifeAngleRandom()},ParticleSpeedRandom(){return this._particleEngine.GetLifeSpeedRandom()},ParticleOpacityRandom(){return this._particleEngine.GetLifeOpacityRandom()},Timeout(){return this._particleEngine.GetTimeout()}}}{const DD=self.C3,ED=[],FD=1e3,OD=new Set(["continuous-spray","one-shot"]),BD=["fade-to-invisible","timeout-expired","particle-stopped"],kD=DD.New(DD.Rect);self.ParticleEngine=class{constructor(){this._rate=0,this._sprayCone=0,this._sprayType="continuous-spray",this._isSpraying=!1,this._masterOpacity=0,this._isPixelRounding=!1,this._spawnX=0,this._spawnY=0,this._spawnAngle=0,this._initSpeed=0,this._initSize=0,this._initSizeScale=1,this._initOpacity=0,this._growRate=0,this._xRandom=0,this._yRandom=0,this._initSpeedRandom=0,this._initSizeRandom=0,this._growRandom=0,this._acceleration=0,this._gravity=0,this._lifeAngleRandom=0,this._lifeSpeedRandom=0,this._lifeOpacityRandom=0,this._destroyMode=0,this._timeout=0,this._createCounter=0,this._particleScale=1,this.ononeshotfinish=null,this.onparticlecreate=null,this._particles=[],this._boundingBox=new DD.Rect,this._color=new DD.Color,this._devicePixelRatio=globalThis.devicePixelRatio||1}Release(){this.Cancel(),DD.clearArray(this._particles),this._particles=null,this.ononeshotfinish=null,this.onparticlecreate=null,this._boundingBox=null,this._color=null}Cancel(){const e=this._particles;for(let t=0,s=e.length;t<s;++t)e[t].Destroy();DD.appendArray(ED,e),DD.clearArray(e),ED.length>1e3&&DD.truncateArray(ED,1e3),this._isSpraying=!1}CreateOneShotSpray(){for(let e=0,t=this._rate;e<t;++e)this._CreateParticle();this._particles.length&&(this._isSpraying=!0)}_CreateParticle(e=!0){let t=null;return ED.length?(t=ED.pop(),t.SetEngine(this)):t=DD.New(self.Particle,this),this._particles.push(t),e?t.Init(this.onparticlecreate):t.Init(),t}ReInitAllParticles(){const e=this._particles,t=this.onparticlecreate;for(let s=0,i=e.length;s<i;++s)e[s].Init(t)}UpdateAllParticlesUserData(){const e=this._particles,t=this.onparticlecreate;for(let s=0,i=e.length;s<i;++s)e[s].UpdateUserData(t)}ApplyParticleDataToUserData(e){const t=this._particles;for(let s=0,i=t.length;s<i;++s){const i=t[s],r=i.GetUserData();if(r){const t=r.GetWorldInfo();t.SetX(i.GetX()),t.SetY(i.GetY()),t.SetSize(i.GetSize(),i.GetSize()),t.SetOpacity(i.GetOpacity()),t.SetAngle(i.GetAngle()),t.SetUnpremultipliedColor(e.GetWorldInfo().GetUnpremultipliedColor()),t.SetBboxChanged()}}}SetParticleCount(e,t=!0){const s=this._particles;if(e<s.length){const t=s.length-e;for(let e=0;e<t;++e){const e=s.pop();e.Destroy(),ED.push(e)}ED.length>1e3&&DD.truncateArray(ED,1e3)}else if(e>s.length){const i=e-s.length;for(let e=0;e<i;++e)this._CreateParticle(t)}}GetParticles(){return this._particles}GetParticleCount(){return this._particles.length}Tick(e){this._SpawnContinuous(e),this._TickParticles(e),this._MaybeFinishOneShot()}_SpawnContinuous(e){if("continuous-spray"===this._sprayType&&this._isSpraying){this._createCounter+=e*this._rate;const t=Math.floor(this._createCounter);this._createCounter-=t;for(let e=0;e<t;++e)this._CreateParticle()}}_SetCreateCounter(e){this._createCounter=e}_GetCreateCounter(){return this._createCounter}_TickParticles(e){const t=this._boundingBox;t.set(this._spawnX,this._spawnY,this._spawnX,this._spawnY);const s=this._particles;let i=0;for(let r=0,n=s.length;r<n;++r){const n=s[r];s[i]=n,n.Tick(e),n.IsActive()?(++i,t.expandToContain(n.GetBoundingBox())):(n.Destroy(),ED.push(n))}DD.truncateArray(s,i),ED.length>1e3&&DD.truncateArray(ED,1e3)}_MaybeFinishOneShot(){"one-shot"===this._sprayType&&0===this._particles.length&&this._isSpraying&&(this.ononeshotfinish&&this.ononeshotfinish(),this._isSpraying=!1)}Draw(e,t,s,i){this._devicePixelRatio=globalThis.devicePixelRatio||1,kD.set(t.getTlx(),t.getTly(),t.getBrx(),t.getBry()),e.StartRenderingPoints(kD),this._color.copy(e.GetColor());const r=this._particles;for(let n=0,a=r.length;n<a;++n){const a=r[n];s.intersectsRect(a.GetBoundingBox())&&a.Draw(e,t,i)}e.FinishRenderingPoints()}GetColor(){return this._color}SetRate(e){this._rate=+e}GetRate(){return this._rate}SetSprayCone(e){this._sprayCone=+e}GetSprayCone(){return this._sprayCone}SetSprayType(e){if(!OD.has(e))throw new Error("invalid spray type");this._sprayType=e}GetSprayType(){return this._sprayType}SetSpraying(e){this._isSpraying=!!e}IsSpraying(){return this._isSpraying}SetMasterOpacity(e){this._masterOpacity=+e}GetMasterOpacity(){return this._masterOpacity}SetPixelRounding(e){this._isPixelRounding=!!e}IsPixelRounding(){return this._isPixelRounding}SetSpawnX(e){this._spawnX=+e}GetSpawnX(){return this._spawnX}SetSpawnY(e){this._spawnY=+e}GetSpawnY(){return this._spawnY}SetSpawnAngle(e){this._spawnAngle=+e}GetInitAngle(){return this._spawnAngle}SetInitSpeed(e){this._initSpeed=+e}GetInitSpeed(){return this._initSpeed}SetInitSize(e){this._initSize=+e}GetInitSize(){return this._initSize}SetInitSizeScale(e){this._initSizeScale=+e}GetInitSizeScale(){return this._initSizeScale}SetInitOpacity(e){this._initOpacity=+e}GetInitOpacity(){return this._initOpacity}SetGrowRate(e){this._growRate=+e}GetGrowRate(){return this._growRate}SetInitXRandom(e){this._xRandom=+e}GetInitXRandom(){return this._xRandom}SetInitYRandom(e){this._yRandom=+e}GetInitYRandom(){return this._yRandom}SetInitSpeedRandom(e){this._initSpeedRandom=+e}GetInitSpeedRandom(){return this._initSpeedRandom}SetInitSizeRandom(e){this._initSizeRandom=+e}GetInitSizeRandom(){return this._initSizeRandom}SetGrowRandom(e){this._growRandom=+e}GetGrowRandom(){return this._growRandom}SetAcceleration(e){this._acceleration=+e}GetAcceleration(){return this._acceleration}SetGravity(e){this._gravity=+e}GetGravity(){return this._gravity}SetLifeAngleRandom(e){this._lifeAngleRandom=+e}GetLifeAngleRandom(){return this._lifeAngleRandom}SetLifeSpeedRandom(e){this._lifeSpeedRandom=+e}GetLifeSpeedRandom(){return this._lifeSpeedRandom}SetLifeOpacityRandom(e){this._lifeOpacityRandom=+e}GetLifeOpacityRandom(){return this._lifeOpacityRandom}SetDestroyMode(e){let t=BD.indexOf(e);if(-1===t)throw new Error("invalid destroy mode");this._destroyMode=t}SetDestroyModeIndex(e){this.SetDestroyMode(BD[e])}GetDestroyMode(){return BD[this._destroyMode]}GetDestroyModeIndex(){return this._destroyMode}SetTimeout(e){this._timeout=+e}GetTimeout(){return this._timeout}SetParticleScale(e){this._particleScale=+e}GetParticleScale(){return this._particleScale}GetBoundingBox(){return this._boundingBox}GetDevicePixelRatio(){return this._devicePixelRatio}}}{let LD=function(e){return Math.random()*e-e/2};randomOffset=LD;const ND=self.C3,WD=self.ParticleEngine,UD=new ND.Quad,VD=new ND.Color;let HD=!1;self.Particle=class{constructor(e){this._engine=e,this._isActive=!1,this._x=0,this._y=0,this._speed=0,this._angle=0,this._opacity=1,this._lastOpacity=0,this._grow=0,this._size=0,this._halfSize=0,this._gs=0,this._age=0,this._bbox=new ND.Rect,this._userData=null,this._userDataUid=NaN,this._updateCallback=null,this._destroyCallback=null}SetEngine(e){this._engine=e}Init(e){const t=this._engine;this._isActive=!0,this._x=t.GetSpawnX()+LD(t.GetInitXRandom()),this._y=t.GetSpawnY()+LD(t.GetInitYRandom()),this._speed=t.GetInitSpeed()+LD(t.GetInitSpeedRandom()),this._angle=t.GetInitAngle()+LD(t.GetSprayCone()),this._opacity=t.GetInitOpacity(),this._lastOpacity=this._opacity,this._size=(t.GetInitSize()+LD(t.GetInitSizeRandom()))*t.GetInitSizeScale(),this._halfSize=this._size/2,this._grow=t.GetGrowRate()+LD(t.GetGrowRandom()),this._gs=0,this._age=0,this._UpdateBoundingBox(),e?this._userData||(this._userData=e(this)):(this._userData=null,this._updateCallback=null,this._destroyCallback=null)}UpdateUserData(e){e?this._userData&&!this._userData.IsDestroyed()||(this._userData=e(this,this._userDataUid)):(this._userData=null,this._updateCallback=null,this._destroyCallback=null)}SetUpdateCallback(e){this._updateCallback=e}SetDestroyCallback(e){this._destroyCallback=e}Destroy(){const e=this._destroyCallback;e&&e(this._userData),this._userData=null,this._updateCallback=null,this._destroyCallback=null}toJSON(){let e;return this._userData&&this._userData.GetWorldInfo()&&(e=this._userData.GetWorldInfo().GetInstance().GetUID()),[this._x,this._y,this._speed,this._angle,this._opacity,this._grow,this._size,this._gs,this._age,e]}setFromJSON(e){this._x=e[0],this._y=e[1],this._speed=e[2],this._angle=e[3],this._opacity=e[4],this._lastOpacity=this._opacity,this._grow=e[5],this._size=e[6],this._gs=e[7],this._age=e[8],this._userDataUid=e[9],this._halfSize=this._size/2,this._UpdateBoundingBox()}Tick(e){const t=this._engine,s=this._speed*e,i=this._angle,r=Math.cos(i)*s,n=Math.sin(i)*s+this._gs*e;this._x+=r,this._y+=n;const a=this._grow*e;this._size+=a,this._halfSize=this._size/2,this._speed+=t.GetAcceleration()*e,this._gs+=t.GetGravity()*e,this._age+=e,this._UpdateBoundingBox();const o=t.GetLifeAngleRandom(),h=t.GetLifeSpeedRandom(),l=t.GetLifeOpacityRandom();let c=0;0!==o&&(c=LD(o*e),this._angle+=c),0!==h&&(this._speed+=LD(h*e)),0!==l&&(this._opacity=ND.clamp(this._opacity+LD(l*e),0,1));const u=this._size>=1&&(2===t.GetDestroyModeIndex()?this._speed>0:this._age<t.GetTimeout()),d=this._updateCallback;if(d&&u){let e=t.GetMasterOpacity()*this._opacity;0===t.GetDestroyModeIndex()&&(e*=1-this._age/t.GetTimeout());const s=e-this._lastOpacity;this._lastOpacity=e,d(this._userData,r,n,a,c,s)}this._isActive=u}IsActive(){return this._isActive}GetBoundingBox(){return this._bbox}_UpdateBoundingBox(){const e=this._x,t=this._y,s=this._halfSize;this._bbox.set(e-s,t-s,e+s,t+s)}Draw(e,t,s){if(this._userData)return;const i=this._engine;let r=i.GetMasterOpacity()*this._opacity;if(0===i.GetDestroyModeIndex()&&(r*=1-this._age/i.GetTimeout()),r<=0)return;const n=this._size,a=n*i.GetParticleScale()*i.GetDevicePixelRatio();if(a<1)return;let o=this._x,h=this._y;i.IsPixelRounding()&&(o=o+.5|0,h=h+.5|0),e.IsWebGPU()?e.Point(o,h,n,r):s||a>e.GetMaxPointSize()||a<e.GetMinPointSize()?(VD.copy(i.GetColor()),VD.multiplyAlpha(r),e.SetColor(VD),HD=!0,UD.setFromRect(this._bbox),e.Quad4(UD,t)):(HD&&(e.SetColor(i.GetColor()),HD=!1),e.Point(o,h,a,r))}GetUserData(){return this._userData}GetUserDataUID(){return this._userDataUid}GetX(){return this._x}GetY(){return this._y}GetSize(){return this._size}GetAngle(){return this._angle}GetOpacity(){return this._opacity}}}{const jD=self.C3;jD.Behaviors.solid=class extends jD.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const zD=self.C3;zD.Behaviors.solid.Type=class extends zD.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const XD=self.C3,YD=self.C3X,qD=self.IBehaviorInstance,KD=0,$D=1,JD=2,ZD=new Set;XD.Behaviors.solid.Instance=class extends XD.SDKBehaviorInstanceBase{constructor(e,t){super(e),this.SetEnabled(!0),t&&(this.SetEnabled(t[KD]),this._SetUsesInstanceTags(t[$D]),this.SetTags(XD.splitStringAndNormalize(t[JD])))}Release(){super.Release()}SetEnabled(e){this._inst._SetSolidEnabled(!!e)}IsEnabled(){return this._inst._IsSolidEnabled()}_SetUsesInstanceTags(e){this._inst._SetSolidUsingInstanceTags(e)}UsesInstanceTags(){return this._inst._IsSolidUsingInstanceTags()}SetTags(e){const t=this._inst.GetSavedDataMap();let s=t.get("solidTags");s||(s=new Set,t.set("solidTags",s)),s.clear();for(const t of e)s.add(t.toLowerCase());0===s.size&&t.delete("solidTags")}GetTags(){return this._inst.GetSavedDataMap().get("solidTags")||ZD}_GetTagsString(){return[...this.GetTags()].join(" ")}SaveToJson(){return{e:this.IsEnabled(),it:this.UsesInstanceTags()}}LoadFromJson(e){this.SetEnabled(e.e),this._SetUsesInstanceTags(!!e.it)}GetPropertyValueByIndex(e){if(e===KD)return this.IsEnabled()}SetPropertyValueByIndex(e,t){e===KD&&this.SetEnabled(t)}GetDebuggerProperties(){const e=[{name:"behaviors.solid.properties.enabled.name",value:this.IsEnabled(),onedit:e=>this.SetEnabled(e)},{name:"behaviors.solid.properties.use-instance-tags.name",value:this.UsesInstanceTags()}];return this.UsesInstanceTags()||e.push({name:"behaviors.solid.properties.tags.name",value:this._GetTagsString(),onedit:e=>this.SetTags(XD.splitStringAndNormalize(e))}),[{title:"$"+this.GetBehaviorType().GetName(),properties:e}]}GetScriptInterfaceClass(){return self.ISolidBehaviorInstance}},self.ISolidBehaviorInstance=class extends qD{#e;constructor(){super(),this.#e=qD._GetInitInst().GetSdkInstance()}set isEnabled(e){this.#e.SetEnabled(!!e)}get isEnabled(){return this.#e.IsEnabled()}get usesInstanceTags(){return this.#e.UsesInstanceTags()}set tags(e){YD.RequireString(e),this.#e.SetTags(XD.splitStringAndNormalize(e))}get tags(){return this.#e._GetTagsString()}setAllTags(e){this.#e.SetTags(e)}getAllTags(){return new Set(this.#e.GetTags())}}}self.C3.Behaviors.solid.Cnds={IsEnabled(){return this.IsEnabled()}};{const QD=self.C3;QD.Behaviors.solid.Acts={SetEnabled(e){this.SetEnabled(e)},SetTags(e){this.SetTags(QD.splitStringAndNormalize(e))}}}self.C3.Behaviors.solid.Exps={};{const eE=self.C3;eE.Behaviors.destroy=class extends eE.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const tE=self.C3;tE.Behaviors.destroy.Type=class extends tE.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const sE=self.C3;sE.Behaviors.destroy.Instance=class extends sE.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._StartTicking()}Release(){super.Release()}Tick(){const e=this._inst.GetWorldInfo(),t=e.GetBoundingBox(),s=e.GetLayout();(t.getRight()<0||t.getBottom()<0||t.getLeft()>s.GetWidth()||t.getTop()>s.GetHeight())&&this._runtime.DestroyInstance(this._inst)}}}self.C3.Behaviors.destroy.Cnds={},self.C3.Behaviors.destroy.Acts={},self.C3.Behaviors.destroy.Exps={};{const iE=self.C3;iE.Behaviors.Sin=class extends iE.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const rE=self.C3;rE.Behaviors.Sin.Type=class extends rE.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const nE=self.C3,aE=self.C3X,oE=self.IBehaviorInstance,hE=0,lE=1,cE=2,uE=3,dE=4,_E=5,pE=6,fE=7,mE=8,gE=0,SE=1,GE=2,yE=3,IE=4,TE=5,CE=6,bE=7,xE=8,wE=9,PE=0,RE=1,vE=2,AE=3,ME=4,DE=2*Math.PI,EE=Math.PI/2,FE=3*Math.PI/2,OE=[0,1,8,3,4,2,5,6,9,7];nE.Behaviors.Sin.Instance=class extends nE.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._i=0,this._movement=0,this._wave=0,this._period=0,this._mag=0,this._isEnabled=!0,this._basePeriod=0,this._basePeriodOffset=0,this._baseMag=0,this._periodRandom=0,this._periodOffsetRandom=0,this._magnitudeRandom=0,this._initialValue=0,this._initialValue2=0,this._lastKnownValue=0,this._lastKnownValue2=0,this._ratio=0,t&&(this._movement=OE[t[hE]],this._wave=t[lE],this._periodRandom=this._runtime.Random()*t[uE],this._basePeriod=t[cE],this._period=t[cE],this._period+=this._periodRandom,this._basePeriodOffset=t[dE],0!==this._period&&(this._periodOffsetRandom=this._runtime.Random()*t[_E],this._i=t[dE]/this._period*DE,this._i+=this._periodOffsetRandom/this._period*DE),this._magnitudeRandom=this._runtime.Random()*t[fE],this._baseMag=t[pE],this._mag=t[pE],this._mag+=this._magnitudeRandom,this._isEnabled=!!t[mE]),this._movement===TE&&(this._mag=nE.toRadians(this._mag)),this.Init(),this._isEnabled&&this._StartTicking()}Release(){super.Release()}SaveToJson(){return{i:this._i,e:this._isEnabled,mv:this._movement,w:this._wave,p:this._period,mag:this._mag,iv:this._initialValue,iv2:this._initialValue2,r:this._ratio,lkv:this._lastKnownValue,lkv2:this._lastKnownValue2}}LoadFromJson(e){this._i=e.i,this._SetEnabled(e.e),this._movement=e.mv,this._wave=e.w,this._period=e.p,this._mag=e.mag,this._initialValue=e.iv,this._initialValue2=e.iv2,this._ratio=e.r,this._lastKnownValue=e.lkv,this._lastKnownValue2=e.lkv2}Init(){const e=this._inst.GetWorldInfo();switch(this._movement){case gE:this._initialValue=e.GetX();break;case SE:this._initialValue=e.GetY();break;case GE:this._initialValue=e.GetWidth(),this._ratio=e.GetHeight()/e.GetWidth();break;case yE:this._initialValue=e.GetWidth();break;case IE:this._initialValue=e.GetHeight();break;case TE:this._initialValue=e.GetAngle();break;case CE:this._initialValue=e.GetOpacity();break;case bE:this._initialValue=0;break;case xE:this._initialValue=e.GetX(),this._initialValue2=e.GetY();break;case wE:this._initialValue=e.GetZElevation()}this._lastKnownValue=this._initialValue,this._lastKnownValue2=this._initialValue2}WaveFunc(e){switch(e%=DE,this._wave){case PE:return Math.sin(e);case RE:return e<=EE?e/EE:e<=FE?1-2*(e-EE)/Math.PI:(e-FE)/EE-1;case vE:return 2*e/DE-1;case AE:return-2*e/DE+1;case ME:return e<Math.PI?-1:1}return 0}Tick(){const e=this._runtime.GetDt(this._inst);this._isEnabled&&0!==e&&(0===this._period?this._i=0:this._i=(this._i+e/this._period*DE)%DE,this._UpdateFromPhase())}_UpdateFromPhase(){const e=this._inst.GetWorldInfo();switch(this._movement){case gE:e.GetX()!==this._lastKnownValue&&(this._initialValue+=e.GetX()-this._lastKnownValue),e.SetX(this._initialValue+this.WaveFunc(this._i)*this._mag),this._lastKnownValue=e.GetX();break;case SE:e.GetY()!==this._lastKnownValue&&(this._initialValue+=e.GetY()-this._lastKnownValue),e.SetY(this._initialValue+this.WaveFunc(this._i)*this._mag),this._lastKnownValue=e.GetY();break;case GE:e.SetWidth(this._initialValue+this.WaveFunc(this._i)*this._mag),e.SetHeight(e.GetWidth()*this._ratio);break;case yE:e.SetWidth(this._initialValue+this.WaveFunc(this._i)*this._mag);break;case IE:e.SetHeight(this._initialValue+this.WaveFunc(this._i)*this._mag);break;case TE:e.GetAngle()!==this._lastKnownValue&&(this._initialValue=nE.clampAngle(this._initialValue+(e.GetAngle()-this._lastKnownValue))),e.SetAngle(this._initialValue+this.WaveFunc(this._i)*this._mag),this._lastKnownValue=e.GetAngle();break;case CE:e.SetOpacity(this._initialValue+this.WaveFunc(this._i)*this._mag/100);break;case xE:e.GetX()!==this._lastKnownValue&&(this._initialValue+=e.GetX()-this._lastKnownValue),e.GetY()!==this._lastKnownValue2&&(this._initialValue2+=e.GetY()-this._lastKnownValue2),e.SetX(this._initialValue+Math.cos(e.GetAngle())*this.WaveFunc(this._i)*this._mag),e.SetY(this._initialValue2+Math.sin(e.GetAngle())*this.WaveFunc(this._i)*this._mag),this._lastKnownValue=e.GetX(),this._lastKnownValue2=e.GetY();break;case wE:e.SetZElevation(this._initialValue+this.WaveFunc(this._i)*this._mag)}e.SetBboxChanged()}_OnSpriteFrameChanged(e,t){}_SetPeriod(e){this._period=e}_GetPeriod(){return this._period}_SetMagnitude(e){this._mag=e}_SetMagnitude_ConvertAngle(e){5===this._movement&&(e=nE.toRadians(e)),this._SetMagnitude(e)}_GetMagnitude(){return this._mag}_GetMagnitude_ConvertAngle(){let e=this._GetMagnitude();return 5===this._movement&&(e=nE.toDegrees(e)),e}_SetMovement(e){5===this._movement&&5!==e&&(this._mag=nE.toDegrees(this._mag)),this._movement=e,this.Init()}_GetMovement(){return this._movement}_SetWave(e){this._wave=e}_GetWave(){return this._wave}_SetPhase(e){this._i=nE.clamp(e,0,2*Math.PI),this._UpdateFromPhase()}_GetPhase(){return this._i}_SetEnabled(e){this._isEnabled=!!e,this._isEnabled?this._StartTicking():this._StopTicking()}_IsEnabled(){return this._isEnabled}GetPropertyValueByIndex(e){switch(e){case hE:return this._movement;case lE:return this._wave;case cE:return this._basePeriod;case pE:return this._baseMag;case mE:return this._isEnabled}}SetPropertyValueByIndex(e,t){switch(e){case hE:this._movement=OE[t],this.Init();break;case lE:this._wave=t;break;case cE:this._basePeriod=t,this._period=this._basePeriod+this._periodRandom,this._isEnabled||(0!==this._period?(this._i=this._basePeriodOffset/this._period*DE,this._i+=this._periodOffsetRandom/this._period*DE):this._i=0);break;case pE:this._baseMag=t,this._mag=this._baseMag+this._magnitudeRandom,this._movement===TE&&(this._mag=nE.toRadians(this._mag));break;case mE:this._isEnabled=!!t}}GetDebuggerProperties(){const e="behaviors.sin";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".properties.enabled.name",value:this._IsEnabled(),onedit:e=>this._SetEnabled(e)},{name:e+".properties.period.name",value:this._GetPeriod(),onedit:e=>this._SetPeriod(e)},{name:e+".properties.magnitude.name",value:this._GetMagnitude_ConvertAngle(),onedit:e=>this._SetMagnitude_ConvertAngle(e)},{name:e+".debugger.value",value:this.WaveFunc(this._GetPhase())*this._GetMagnitude_ConvertAngle()}]}]}GetScriptInterfaceClass(){return self.ISineBehaviorInstance}};const BE=new WeakMap,kE=["horizontal","vertical","size","width","height","angle","opacity","value-only","forwards-backwards","z-elevation"],LE=["sine","triangle","sawtooth","reverse-sawtooth","square"];self.ISineBehaviorInstance=class extends oE{constructor(){super(),BE.set(this,oE._GetInitInst().GetSdkInstance())}set period(e){aE.RequireFiniteNumber(e),BE.get(this)._SetPeriod(e)}get period(){return BE.get(this)._GetPeriod()}set magnitude(e){aE.RequireFiniteNumber(e),BE.get(this)._SetMagnitude(e)}get magnitude(){return BE.get(this)._GetMagnitude()}set phase(e){BE.get(this)._SetPhase(e)}get phase(){return BE.get(this)._GetPhase()}set movement(e){aE.RequireString(e);const t=kE.indexOf(e);if(-1===t)throw new Error("invalid movement");BE.get(this)._SetMovement(t)}get movement(){return kE[BE.get(this)._GetMovement()]}set wave(e){aE.RequireString(e);const t=LE.indexOf(e);if(-1===t)throw new Error("invalid wave");BE.get(this)._SetWave(t)}get wave(){return LE[BE.get(this)._GetWave()]}get value(){const e=BE.get(this);return e.WaveFunc(e._GetPhase())*e._GetMagnitude()}updateInitialState(){BE.get(this).Init()}set isEnabled(e){BE.get(this)._SetEnabled(!!e)}get isEnabled(){return BE.get(this)._IsEnabled()}}}{const NE=self.C3;NE.Behaviors.Sin.Cnds={IsEnabled(){return this._IsEnabled()},CompareMovement(e){return this._GetMovement()===e},ComparePeriod(e,t){return NE.compare(this._GetPeriod(),e,t)},CompareMagnitude(e,t){return NE.compare(this._GetMagnitude_ConvertAngle(),e,t)},CompareWave(e){return this._GetWave()===e}}}self.C3.Behaviors.Sin.Acts={SetEnabled(e){this._SetEnabled(0!==e)},SetPeriod(e){this._SetPeriod(e)},SetMagnitude(e){this._SetMagnitude_ConvertAngle(e)},SetMovement(e){this._SetMovement(e)},SetWave(e){this._wave=e},SetPhase(e){const t=2*Math.PI;this._SetPhase(e*t%t)},UpdateInitialState(){this.Init()}},self.C3.Behaviors.Sin.Exps={CyclePosition(){return this._GetPhase()/(2*Math.PI)},Period(){return this._GetPeriod()},Magnitude(){return this._GetMagnitude_ConvertAngle()},Value(){return this.WaveFunc(this._GetPhase())*this._GetMagnitude_ConvertAngle()}};{const WE=self.C3;WE.Behaviors.Fade=class extends WE.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const UE=self.C3;UE.Behaviors.Fade.Type=class extends UE.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const VE=self.C3,HE=self.C3X,jE=self.IBehaviorInstance,zE=0,XE=1,YE=2,qE=3,KE=4;VE.Behaviors.Fade.Instance=class extends VE.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._fadeInTime=0,this._waitTime=0,this._fadeOutTime=0,this._destroy=!0,this._activeAtStart=!0,this._setMaxOpacity=!1,this._stage=0,this._stageTime=VE.New(VE.KahanSum),this._maxOpacity=this._inst.GetWorldInfo().GetOpacity()||1,t&&(this._fadeInTime=t[zE],this._waitTime=t[XE],this._fadeOutTime=t[YE],this._destroy=!!t[qE],this._activeAtStart=!!t[KE],this._stage=this._activeAtStart?0:3),this._activeAtStart&&(0===this._fadeInTime?(this._stage=1,0===this._waitTime&&(this._stage=2)):(this._inst.GetWorldInfo().SetOpacity(0),this._runtime.UpdateRender())),this._StartTicking()}Release(){super.Release()}SaveToJson(){return{fit:this._fadeInTime,wt:this._waitTime,fot:this._fadeOutTime,d:this._destroy,s:this._stage,st:this._stageTime.Get(),mo:this._maxOpacity}}LoadFromJson(e){this._fadeInTime=e.fit,this._waitTime=e.wt,this._fadeOutTime=e.fot,this._destroy=e.d,this._stage=e.s,this._stageTime.Set(e.st),this._maxOpacity=e.mo,3===this._stage?this._StopTicking():this._StartTicking()}Tick(){const e=this._runtime.GetDt(this._inst);this._stageTime.Add(e);const t=this._inst.GetWorldInfo();0===this._stage&&(t.SetOpacity(this._stageTime.Get()/this._fadeInTime*this._maxOpacity),this._runtime.UpdateRender(),t.GetOpacity()>=this._maxOpacity&&(t.SetOpacity(this._maxOpacity),this._stage=1,this._stageTime.Reset(),this.DispatchScriptEvent("fadeinend"),this.Trigger(VE.Behaviors.Fade.Cnds.OnFadeInEnd))),1===this._stage&&this._stageTime.Get()>=this._waitTime&&(this._stage=2,this._stageTime.Reset(),this.DispatchScriptEvent("waitend"),this.Trigger(VE.Behaviors.Fade.Cnds.OnWaitEnd)),2===this._stage&&(0!==this._fadeOutTime?(t.SetOpacity(this._maxOpacity-this._stageTime.Get()/this._fadeOutTime*this._maxOpacity),this._runtime.UpdateRender(),t.GetOpacity()<=0&&(this._stage=3,this._stageTime.Reset(),this.DispatchScriptEvent("fadeoutend"),this.Trigger(VE.Behaviors.Fade.Cnds.OnFadeOutEnd),this._destroy&&this._runtime.DestroyInstance(this._inst))):(this._stage=3,this._stageTime.Reset())),3===this._stage&&this._StopTicking()}_StartFade(){this._activeAtStart||this._setMaxOpacity||(this._maxOpacity=this._inst.GetWorldInfo().GetOpacity()||1,this._setMaxOpacity=!0),3===this._stage&&this.Start()}_RestartFade(){this.Start()}Start(){this._stage=0,this._stageTime.Reset(),0===this._fadeInTime?(this._stage=1,0===this._waitTime&&(this._stage=2)):(this._inst.GetWorldInfo().SetOpacity(0),this._runtime.UpdateRender()),this._StartTicking()}_SetFadeInTime(e){this._fadeInTime=Math.max(e,0)}_GetFadeInTime(){return this._fadeInTime}_SetWaitTime(e){this._waitTime=Math.max(e,0)}_GetWaitTime(){return this._waitTime}_SetFadeOutTime(e){this._fadeOutTime=Math.max(e,0)}_GetFadeOutTime(){return this._fadeOutTime}GetPropertyValueByIndex(e){switch(e){case zE:return this._GetFadeInTime();case XE:return this._GetWaitTime();case YE:return this._GetFadeOutTime();case qE:return this._destroy}}SetPropertyValueByIndex(e,t){switch(e){case zE:this._SetFadeInTime(t);break;case XE:this._SetWaitTime(t);break;case YE:this._SetFadeOutTime(t);break;case qE:this._destroy=!!t}}GetDebuggerProperties(){const e="behaviors.fade";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".properties.fade-in-time.name",value:this._GetFadeInTime(),onedit:e=>this._SetFadeInTime(e)},{name:e+".properties.wait-time.name",value:this._GetWaitTime(),onedit:e=>this._SetWaitTime(e)},{name:e+".properties.fade-out-time.name",value:this._GetFadeOutTime(),onedit:e=>this._SetFadeOutTime(e)},{name:e+".debugger.stage",value:[e+".debugger."+["fade-in","wait","fade-out","done"][this._stage]]}]}]}GetScriptInterfaceClass(){return self.IFadeBehaviorInstance}};const $E=new WeakMap;self.IFadeBehaviorInstance=class extends jE{constructor(){super(),$E.set(this,jE._GetInitInst().GetSdkInstance())}startFade(){$E.get(this)._StartFade()}restartFade(){$E.get(this)._RestartFade()}set fadeInTime(e){HE.RequireFiniteNumber(e),$E.get(this)._SetFadeInTime(e)}get fadeInTime(){return $E.get(this)._GetFadeInTime()}set waitTime(e){HE.RequireFiniteNumber(e),$E.get(this)._SetWaitTime(e)}get waitTime(){return $E.get(this)._GetWaitTime()}set fadeOutTime(e){HE.RequireFiniteNumber(e),$E.get(this)._SetFadeOutTime(e)}get fadeOutTime(){return $E.get(this)._GetFadeOutTime()}}}self.C3.Behaviors.Fade.Cnds={OnFadeOutEnd:()=>!0,OnFadeInEnd:()=>!0,OnWaitEnd:()=>!0},self.C3.Behaviors.Fade.Acts={StartFade(){this._StartFade()},RestartFade(){this._RestartFade()},SetFadeInTime(e){this._SetFadeInTime(e)},SetWaitTime(e){this._SetWaitTime(e)},SetFadeOutTime(e){this._SetFadeOutTime(e)}},self.C3.Behaviors.Fade.Exps={FadeInTime(){return this._GetFadeInTime()},WaitTime(){return this._GetWaitTime()},FadeOutTime(){return this._GetFadeOutTime()}};{const JE=self.C3;JE.Behaviors.Tween=class extends JE.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const ZE=self.C3;ZE.Behaviors.Tween.Type=class extends ZE.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const QE=self.C3,eF=QE.Behaviors.Tween,tF=0;eF.Instance=class extends QE.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._allowMultiple=!1,this._enabled=!0,t&&(this._allowMultiple=!1,this._enabled=!!t[tF]),this._activeTweens=new Map,this._disabledTweens=[],this._waitingForReleaseTweens=new Map,this._finishingTween=null,this._activeTweensJson=null,this._disabledTweensJson=null,this._waitingForReleaseTweensJson=null,this._finishingTweenName="",this._triggerTweens=[],this._afterLoad=e=>this._OnAfterLoad(),this.GetRuntime().Dispatcher().addEventListener("afterload",this._afterLoad)}Release(){this.GetRuntime().Dispatcher().removeEventListener("afterload",this._afterLoad),this._afterLoad=null,this._finishingTween&&(this.ReleaseAndCompleteTween(this._finishingTween),this._finishingTween=null),this.ReleaseAndCompleteTweens(),this._tweens=null,this.ClearDisabledList(),this._disabledTweens=null,this._ReleaseWaitingTweens(),this._waitingForReleaseTweens=null,this._triggerTweens=null,super.Release()}PushTriggerTween(e){this._triggerTweens.push(e)}PopTriggerTween(){this._triggerTweens.pop()}GetTriggerTween(){return this._triggerTweens[this._triggerTweens.length-1]}SetEnabled(e){this._enabled=!!e,e?this._waitingForReleaseTweens&&this._waitingForReleaseTweens.size&&this._StartTicking2():this._StopTicking2();for(const t of this.AllTweens())e?this.IsInDisabledList(t)&&t.Resume():((t.IsPlaying()||t.IsScheduled())&&this.AddToDisabledList(t),t.Stop());e&&this.ClearDisabledList()}IsEnabled(){return this._enabled}AddToDisabledList(e){this._disabledTweens.push(e)}IsInDisabledList(e){return this._disabledTweens.includes(e)}ClearDisabledList(){QE.clearArray(this._disabledTweens)}GetFinishingTween(){return this._finishingTween}IsInstanceValid(){const e=this.GetObjectInstance();return!!e&&!e.IsDestroyed()}GetTween(e,t,s=!1){const i=t?this.PropertyTweens(t,s):this.AllTweens(s);if(i&&i.length)for(const t of i)if(t.HasTags(e))return t}CheckTweensWithTags(e,t){for(const s of this._activeTweens.values())for(const i of s)if(!i.IsReleased()&&i.HasTags(e)&&t(i))return!0;for(const s of this._waitingForReleaseTweens.values())for(const i of s)if(!i.IsReleased()&&i.HasTags(e)&&t(i))return!0;return!1}CheckTweens(e){for(const t of this._activeTweens.values())for(const s of t)if(!s.IsReleased()&&e(s))return!0;for(const t of this._waitingForReleaseTweens.values())for(const s of t)if(!s.IsReleased()&&e(s))return!0;return!1}GetTweenIncludingWaitingForRelease(e,t){return this.GetTween(e,t,!0)}*GetTweens(e,t,s=!1){const i=t?this.PropertyTweens(t,s):this.AllTweens(s);if(i&&i.length)for(const t of i)t.HasTags(e)&&(yield t)}*GetTweensIncludingWaitingForRelease(e,t){yield*this.GetTweens(e,t,!0)}PropertyTweens(e,t){if(t){let t=this._activeTweens.get(e),s=this._waitingForReleaseTweens.get(e);return t||(t=[]),s||(s=[]),t.concat(s).filter(e=>e).filter(e=>!e.IsReleased())}{let t=this._activeTweens.get(e);return t||(t=[]),t.filter(e=>e).filter(e=>!e.IsReleased())}}AllTweens(e){if(e){const e=[...this._activeTweens.values()].flat(),t=[...this._waitingForReleaseTweens.values()].flat();return e.concat(t).filter(e=>e).filter(e=>!e.IsReleased())}return[...this._activeTweens.values()].flat().filter(e=>e).filter(e=>!e.IsReleased())}AllTweensIncludingWaitingForRelease(){return this.AllTweens(!0)}SaveToJson(e="full"){return{s:!1,e:!!this._enabled,at:this._SaveActiveTweensToJson(),dt:this._SaveDisabledTweensToJson(),wt:this._SaveWaitingForReleaseTweensToJson(),ft:this._SaveFinishingTweenToJson()}}LoadFromJson(e,t="full"){e&&(this._activeTweensJson=e.at,this._disabledTweensJson=e.dt,this._waitingForReleaseTweensJson=e.wt,this._finishingTweenName=e.ft,this._allowMultiple=!1,this._enabled=!!e.e,"state"===t&&this._OnAfterLoad())}_OnAfterLoad(){const e=this.GetRuntime().GetTimelineManager();if(this._PopulateTweenMap(this._activeTweensJson,this._activeTweens,e),this._disabledTweensJson){QE.clearArray(this._disabledTweens);for(const t of this._disabledTweensJson)this._PopulateTweenArray(this._disabledTweens,t,e)}this._PopulateTweenMap(this._waitingForReleaseTweensJson,this._waitingForReleaseTweens,e),this._finishingTween=this._GetTween(this._finishingTweenName,e),this._enabled?this._waitingForReleaseTweens&&this._waitingForReleaseTweens.size&&this._StartTicking2():this._StopTicking2()}_PopulateTweenMap(e,t,s){if(e)for(const i in e){let r=t.get(i);r?QE.clearArray(r):r=[];const n=e[i];for(const e of n)if(this._PopulateTweenArray(r,e.name,s))this._LoadTweenFromJson(e.name,e,s);else{const t=QE.TweenState.Build({runtime:this.GetRuntime(),json:e});QE.TweenState.SetInstanceUID(t,this.GetObjectInstance().GetUID()),t.AddCompletedCallback(e=>this._FinishTriggers(e)),t.SetBehaviorInstance(this),s.AddScheduledTimeline(t),this._PopulateTweenArray(r,t,s)}t.set(i,r)}}_GetTween(e,t){return t.GetScheduledOrPlayingTimelineByName(e)}_PopulateTweenArray(e,t,s){if("string"!=typeof t)return!!e.push(t);{const i=this._GetTween(t,s);if(i)return!!e.push(i)}return!1}_LoadTweenFromJson(e,t,s){if("string"==typeof e){const i=this._GetTween(e,s);i&&(i._LoadFromJson(t),QE.TweenState.SetInstanceUID(i,this.GetObjectInstance().GetUID()),QE.TweenState.SetBehaviorInstance(i,this))}else e._LoadFromJson(t),QE.TweenState.SetInstanceUID(e,this.GetObjectInstance().GetUID()),QE.TweenState.SetBehaviorInstance(e,this)}_SaveActiveTweensToJson(){const e={};for(const[t,s]of this._activeTweens)e[t]=s.filter(e=>!e.IsReleased()).map(e=>e._SaveToJson());return e}_SaveDisabledTweensToJson(){return this._disabledTweens.filter(e=>!e.IsReleased()).map(e=>e.GetName())}_SaveWaitingForReleaseTweensToJson(){const e={};for(const[t,s]of this._waitingForReleaseTweens)e[t]=s.map(e=>e._SaveToJson());return e}_SaveFinishingTweenToJson(){return this._finishingTween?this._finishingTween.GetName():""}Tick2(){this._ReleaseWaitingTweens()}CreateTween(e){const t=eF.Config.GetPropertyTracksConfig(e.property,e.startValue,e.endValue,e.ease,e.resultMode,this.GetObjectInstance()),s=eF.Maps.GetPropertyFromIndex(e.property);eF.Maps.IsValueId(s)||this.ReleaseTweens(e.property);const i=QE.TweenState.Build({runtime:this.GetRuntime(),id:s,tags:e.tags,time:e.time,instance:this.GetObjectInstance(),releaseOnComplete:!!e.releaseOnComplete,loop:!!e.loop,pingPong:!!e.pingPong,repeatCount:e.repeatCount,initialValueMode:e.initialValueMode,propertyTracksConfig:t});return i.AddCompletedCallback(e=>this._FinishTriggers(e)),i.SetBehaviorInstance(this),this._AddTween(i,e.property),i}_MaybeRemoveFromActiveTweenMap(e){const t=e.GetId();if(this._activeTweens.has(t)){const s=this._activeTweens.get(t);if(s){const t=s.indexOf(e);-1!==t&&s.splice(t,1)}}}ReleaseTween(e,t=!1){this._MaybeRemoveFromActiveTweenMap(e),e.IsReleased()||this._IsInWaitingList(e)||(e.Stop(t),this._AddToWaitingList(e))}ReleaseTweens(e,t=!1){if(QE.IsFiniteNumber(e)){const s=eF.Maps.GetPropertyFromIndex(e);if(!this._activeTweens.has(s))return;const i=this._activeTweens.get(s),r=this.GetFinishingTween();for(const e of i)e!==r&&(e.IsReleased()||this._IsInWaitingList(e)||(e.Stop(t),e.Release()));QE.clearArray(i)}else{const e=this.GetFinishingTween();for(const s of this.AllTweens())s!==e&&(s.IsReleased()||this._IsInWaitingList(s)||(s.Stop(t),s.Release()));for(const e of this._activeTweens.keys())QE.clearArray(this._activeTweens.get(e)),this._activeTweens.delete(e);this._activeTweens.clear()}}ReleaseAndCompleteTween(e){this.ReleaseTween(e,!0)}ReleaseAndCompleteTweens(){this.ReleaseTweens(NaN,!0)}GetPropertyValueByIndex(e){if(e===tF)return this._enabled}SetPropertyValueByIndex(e,t){e===tF&&(this._enabled=!!t)}_GetBehaviorType(e){const t=e.GetInstance().GetBehaviorInstances();for(const e of t){const t=e.GetBehaviorType();if(t.GetInstanceSdkCtor()===this.constructor)return t}}Trigger(e,t,s,i){return this._runtime?super.Trigger(e):t.Trigger(e,s,i)}_FinishTriggers(e){let t,s;if(this._finishingTween=e,eF.Cnds.SetFinishingTween(e),this.GetRuntime())t=this._inst,s=this._runtime,this.Trigger(eF.Cnds.OnTweensFinished),this.Trigger(eF.Cnds.OnAnyTweensFinished),this.ReleaseTween(e);else{if(t=e.GetInstance(),!t)return;if(t&&t.IsDestroyed())return;s=t.GetRuntime();const i=this._GetBehaviorType(e);this.Trigger(eF.Cnds.OnTweensFinished,s,t,i),this.Trigger(eF.Cnds.OnAnyTweensFinished,s,t,i),e.Stop()}this._finishingTween=null,eF.Cnds.SetFinishingTween(null),e.GetDestroyInstanceOnComplete()&&s.DestroyInstance(t)}_AddTween(e,t){const s=eF.Maps.GetPropertyFromIndex(t);this._activeTweens.has(s)||this._activeTweens.set(s,[]),this._activeTweens.get(s).push(e)}_AddToWaitingList(e){const t=e.GetId();this._waitingForReleaseTweens.has(t)||this._waitingForReleaseTweens.set(t,[]),this._waitingForReleaseTweens.get(t).push(e),this.IsTicking2()||this._StartTicking2()}_IsInWaitingList(e){const t=e.GetId();return!!this._waitingForReleaseTweens.has(t)&&this._waitingForReleaseTweens.get(t).includes(e)}_ReleaseWaitingTweens(){if(this._waitingForReleaseTweens.size){for(const e of this._waitingForReleaseTweens.values()){for(const t of e)t.IsReleased()||t.Release();QE.clearArray(e)}this._waitingForReleaseTweens.clear(),this.IsTicking2()&&this._StopTicking2()}}GetDebuggerProperties(){return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:"behaviors.tween.properties.enabled.name",value:this.IsEnabled(),onedit:e=>this.SetEnabled(e)}]}]}GetScriptInterfaceClass(){return self.ITweenBehaviorInstance}}}{const sF=self.C3;let iF=null;sF.Behaviors.Tween.Cnds={OnAnyTweenLoop:()=>!0,OnTweensLoop(e){const t=this.GetTriggerTween();return!!t&&t.HasTags(e)},OnAnyTweenPingPong(e){const t=this.GetTriggerTween();return!!t&&(t.GetPingPongState()===e||2===e)},OnTweensPingPong(e,t){const s=this.GetTriggerTween();return!!s&&(s.GetPingPongState()===t||2===t)&&s.HasTags(e)},OnTweensReleased(e){return this.GetTriggerTween().HasTags(e)},OnAnyTweensReleased:()=>!0,SetFinishingTween(e){iF=e},OnTweensFinished:e=>iF.HasTags(e),OnAnyTweensFinished:()=>!0,IsPlaying(e){return this.CheckTweensWithTags(e,sF.TweenState.IsPlaying)},IsAnyPlaying(){return this.CheckTweens(sF.TweenState.IsPlaying)},IsPaused(e){return this.CheckTweensWithTags(e,sF.TweenState.IsPaused)},IsAnyPaused(){return this.CheckTweens(sF.TweenState.IsPaused)},IsPingPong(e,t){return 0===t?this.CheckTweensWithTags(e,sF.TweenState.IsPing):1===t&&this.CheckTweensWithTags(e,sF.TweenState.IsPong)},IsAnyPingPong(e){return 0===e?this.CheckTweens(sF.TweenState.IsPing):1===e&&this.CheckTweens(sF.TweenState.IsPong)}}}{const rF=self.C3,nF=self.Ease,aF=rF.Behaviors.Tween;aF.Acts={SetEnabled(e){this.SetEnabled(!!e)},async TweenOneProperty(...e){if(!this.IsEnabled()||!this.IsInstanceValid())return;const t=this.CreateTween(aF.TweenArguments.OneProperty(this,...e));t.Play()&&await t.GetPlayPromise()},async TweenTwoProperties(...e){if(!this.IsEnabled()||!this.IsInstanceValid())return;const t=this.CreateTween(aF.TweenArguments.TwoProperties(this,...e));t.Play()&&await t.GetPlayPromise()},async TweenValue(...e){if(!this.IsEnabled()||!this.IsInstanceValid())return;const t=this.CreateTween(aF.TweenArguments.ValueProperty(this,...e));t.Play()&&await t.GetPlayPromise()},PauseTweens(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.GetTweens(e))t.Stop()},PauseAllTweens(){if(this.IsEnabled()&&this.IsInstanceValid())for(const e of this.AllTweens())e.Stop()},ResumeTweens(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.GetTweens(e))t.Resume()},ResumeAllTweens(){if(this.IsEnabled()&&this.IsInstanceValid())for(const e of this.AllTweens())e.Resume()},StopTweens(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.GetTweens(e))this.ReleaseTween(t)},StopAllTweens(){if(this.IsEnabled()&&this.IsInstanceValid())for(const e of this.AllTweens())this.ReleaseTween(e)},SetOnePropertyTweensEndValue(e,t,s){if(!this.IsEnabled()||!this.IsInstanceValid())return;const i=rF.Behaviors.Tween.Maps.GetSinglePropertyFromIndex(t);for(const t of this.GetTweens(e))t.BeforeSetEndValues([i]),t.SetEndValue(s,i)},SetTwoPropertiesTweensEndValue(e,t,s,i){if(!this.IsEnabled()||!this.IsInstanceValid())return;const r=rF.Behaviors.Tween.Maps.GetRealProperties(t);for(const t of this.GetTweens(e))t.BeforeSetEndValues(r),t.SetEndValue(s,r[0]),t.SetEndValue(i,r[1])},SetValuePropertyTweensStartValue(e,t){if(this.IsEnabled()&&this.IsInstanceValid())for(const s of this.GetTweens(e,"value"))s.SetStartValue(t,"value")},SetValuePropertyTweensEndValue(e,t){if(this.IsEnabled()&&this.IsInstanceValid())for(const s of this.GetTweens(e,"value"))s.BeforeSetEndValues(["value"]),s.SetEndValue(t,"value")},SetTweensEase(e,t){if(!this.IsEnabled()||!this.IsInstanceValid())return;const s=nF.GetEaseFromIndex(t);for(const t of this.GetTweens(e))t.SetEase(s)},SetAllTweensEase(e){if(!this.IsEnabled()||!this.IsInstanceValid())return;const t=nF.GetEaseFromIndex(e);for(const e of this.AllTweens())e.SetEase(t)},SetTweensTime(e,t){if(this.IsEnabled()&&this.IsInstanceValid())for(const s of this.GetTweens(e))s.SetTime(t)},SetAllTweensTime(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.AllTweens())t.SetTime(e)},SetTweensPlaybackRate(e,t){if(this.IsEnabled()&&this.IsInstanceValid())for(const s of this.GetTweens(e))s.SetPlaybackRate(t)},SetAllTweensPlaybackRate(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.AllTweens())t.SetPlaybackRate(e)},SetTweensDestroyOnComplete(e,t){if(this.IsEnabled()&&this.IsInstanceValid())for(const s of this.GetTweens(e))s.SetDestroyInstanceOnComplete(!!t)},SetAllTweensDestroyOnComplete(e){if(this.IsEnabled()&&this.IsInstanceValid())for(const t of this.AllTweens())t.SetDestroyInstanceOnComplete(!!e)}}}self.C3.Behaviors.Tween.Exps={Time(e){const t=this.GetTweenIncludingWaitingForRelease(e);return t?t.GetTime():0},Progress(e){const t=this.GetTweenIncludingWaitingForRelease(e);return t?t.GetTime()/t.GetTotalTime():0},PlaybackRate(e){const t=this.GetTweenIncludingWaitingForRelease(e);return t?t.GetPlaybackRate():0},Value(e){const t=this.GetTweenIncludingWaitingForRelease(e,"value");return t?t.GetPropertyTrack("value").GetSourceAdapterValue():0},Tags(){let e=this.GetFinishingTween();return e?e.GetStringTags():(e=this.GetTriggerTween(),e?e.GetStringTags():"")}};{const oF=self.C3,hF=self.Ease,lF=["position","size","scale"],cF=["offsetX","offsetY","offsetWidth","offsetHeight","offsetAngle","offsetOpacity","offsetColor","offsetZElevation","offsetScaleX","offsetScaleY"],uF=["value"],dF=[].concat(lF).concat(cF).concat(uF),_F={position:["offsetX","offsetY"],size:["offsetWidth","offsetHeight"],scale:["offsetScaleX","offsetScaleY"]},pF=Object.assign({},dF.reduce((e,t)=>Object.assign({},e,{[t]:[t]}),{}),_F);oF.Behaviors.Tween.Maps=class{constructor(){}static GetEases(){return[...hF.GetRuntimeEaseNames()]}static GetEaseFromIndex(e){return[...hF.GetRuntimeEaseNames()][e]}static GetPropertyFromIndex(e){return dF[e]}static GetPropertyIndexFromName(e){return dF.indexOf(e)}static GetPairPropertyFromIndex(e){return lF[e]}static GetSinglePropertyFromIndex(e){return cF[e]}static GetValuePropertyFromIndex(e){return uF[e]}static GetPairProperties(e){return _F[e]}static GetRealProperties(e){return oF.IsString(e)?pF[e]:pF[dF[e]]}static IsPairId(e){return!!_F[e]}static IsColorId(e){return"offsetColor"===e}static IsAngleId(e){return"offsetAngle"===e}static IsOpacityId(e){return"offsetOpacity"===e}static IsValueId(e){return"value"===e}}}{const fF=self.C3,mF=fF.Behaviors.Tween,gF=new Map;mF.Config=class{constructor(){}static GetPropertyTracksConfig(e,t,s,i,r,n){0===gF.size&&this._CreateConfigObjects();const a=mF.PropertyTypes.Pick(e);let o=gF.get(a);return fF.IsFiniteNumber(e)&&(e=mF.Maps.GetPropertyFromIndex(e)),this._GetConfig(o,e,t,s,i,r,n)}static TransformValue(e,t){return fF.Behaviors.Tween.GetPropertyTracksConfig(e).valueGetter(t)}static _CreateConfigObjects(){const e=mF.PropertyTypes,t=mF.ValueGetters;this._AddConfigObject(e.PAIR,this._GetPairConfig,t._GetPropertyValue),this._AddConfigObject(e.COLOR,this._GetColorConfig,t._GetColorPropertyValue),this._AddConfigObject(e.ANGLE,this._GetAngleConfig,t._GetPropertyAngleValue),this._AddConfigObject(e.VALUE,this._GetValueConfig,t._GetPropertyValue),this._AddConfigObject(e.OTHER,this._GetCommonConfig,t._GetPropertyValue)}static _AddConfigObject(e,t,s){gF.set(e,this._CreateConfigObject(e,t,s))}static _CreateConfigObject(e,t,s){return{name:e,configFunc:t,valueGetter:s}}static _GetConfig(e,t,s,i,r,n,a){return e.configFunc(t,e.valueGetter(s),e.valueGetter(i),r,n,a)}static _GetPairConfig(e,t,s,i,r,n){return mF.Maps.GetPairProperties(e).map((e,n)=>({sourceId:"world-instance",property:e,type:"float",valueType:"numeric",startValue:t[n],endValue:s[n],ease:mF.Maps.GetEaseFromIndex(i),resultMode:r}))}static _GetColorConfig(e,t,s,i,r,n){return fF.Plugins.Text&&n.GetPlugin()instanceof fF.Plugins.Text?{sourceId:"plugin",sourceArgs:[7],property:"color",type:"color",valueType:"color",startValue:t,endValue:s,ease:mF.Maps.GetEaseFromIndex(i),resultMode:r}:{sourceId:"world-instance",property:e,type:"color",valueType:"color",startValue:t,endValue:s,ease:mF.Maps.GetEaseFromIndex(i),resultMode:r}}static _GetAngleConfig(e,t,s,i,r,n){return{sourceId:"world-instance",property:e,type:"angle",valueType:"angle",startValue:t,endValue:s,ease:mF.Maps.GetEaseFromIndex(i),resultMode:r}}static _GetCommonConfig(e,t,s,i,r,n){return{sourceId:"world-instance",property:e,type:"float",valueType:"numeric",startValue:t,endValue:s,ease:mF.Maps.GetEaseFromIndex(i),resultMode:r}}static _GetValueConfig(e,t,s,i,r,n){return{sourceId:"value",property:e,type:"float",valueType:"numeric",startValue:t,endValue:s,ease:mF.Maps.GetEaseFromIndex(i),resultMode:r}}}}{const SF=self.C3,GF=SF.Behaviors.Tween,yF={resultMode:"absolute"},IF=Object.assign({},yF,{tags:"",property:"",time:0,ease:0,releaseOnComplete:0,loop:!1,pingPong:!1,repeatCount:1}),TF=Object.assign({},IF,{initialValueMode:"current-state",startValue:0,endValue:0}),CF=Object.assign({},IF,{initialValueMode:"current-state",startValue:[0,0],endValue:[0,0]}),bF=Object.assign({},IF,{initialValueMode:"current-state",startValue:[0,0,0],endValue:[0,0,0]}),xF=Object.assign({},TF,{initialValueMode:"start-value"}),wF=0,PF=1,RF=0,vF=1,AF=2;GF.TweenArguments=class{constructor(){}static _SetCommonProperties(e,t,s,i,r,n,a,o){e.tags=t,e.time=s,e.ease=i,e.releaseOnComplete=r,e.loop=n,e.pingPong=a,e.repeatCount=o}static OneProperty(e,t,s,i,r,n,a,o,h,l){const c="string"==typeof s?s:GF.Maps.GetSinglePropertyFromIndex(s),u=GF.Maps.IsColorId(c)?bF:TF;return this._SetCommonProperties(u,t,r,n,a,o,h,l),GF.Maps.IsColorId(c)?(bF.endValue[0]=SF.GetRValue(i),bF.endValue[1]=SF.GetGValue(i),bF.endValue[2]=SF.GetBValue(i),bF.property=GF.Maps.GetPropertyIndexFromName(c)):GF.Maps.IsOpacityId(c)?TF.endValue=i/100:TF.endValue=i,u.property=GF.Maps.GetPropertyIndexFromName(c),u}static TwoProperties(e,t,s,i,r,n,a,o,h,l,c){this._SetCommonProperties(CF,t,n,a,o,h,l,c);const u="string"==typeof s?s:GF.Maps.GetPairPropertyFromIndex(s);return CF.endValue[0]=i,CF.endValue[1]=r,CF.property=GF.Maps.GetPropertyIndexFromName(u),CF}static ValueProperty(e,t,s,i,r,n,a,o,h,l){return this._SetCommonProperties(xF,t,r,n,a,o,h,l),xF.startValue=s,xF.endValue=i,xF.property=GF.Maps.GetPropertyIndexFromName("value"),xF}}}{const MF=self.C3,DF=MF.Behaviors.Tween,EF=[];DF.PropertyTypes=class{constructor(){}static Pick(e){if(0===EF.length){const e=EF;e.push({checkFunc:DF.Maps.IsPairId,result:this.PAIR}),e.push({checkFunc:DF.Maps.IsColorId,result:this.COLOR}),e.push({checkFunc:DF.Maps.IsAngleId,result:this.ANGLE}),e.push({checkFunc:DF.Maps.IsValueId,result:this.VALUE}),e.push({checkFunc:()=>!0,result:this.OTHER})}MF.IsFiniteNumber(e)&&(e=MF.Behaviors.Tween.Maps.GetPropertyFromIndex(e));for(const t of EF)if(t.checkFunc(e))return t.result}static get PAIR(){return"pair"}static get COLOR(){return"color"}static get ANGLE(){return"angle"}static get VALUE(){return"value"}static get OTHER(){return"other"}}}{const FF=self.C3,OF=FF.Behaviors.Tween;OF.ValueGetters=class{constructor(){}static _GetPropertyAngleValue(e){const t=FF.toRadians(parseFloat(e));return FF.clampAngle(t)}static _GetColorPropertyValue(e){return e.slice(0)}static _GetPropertyValue(e){return e}}}{let BF=function(e){NF.RequireString(e);const t=UF.ToInternal(e);let s;if(s=t?UF.GetIndexForEase(t,null):UF.GetIndexForEase(e,null),-1===s)throw new Error(`invalid ease name '${e}'`);return s},kF=function(e,t=!1){if(!(t&&null==e||"string"==typeof e||Array.isArray(e)))throw new Error("invalid tags")};getIndexForEase=BF,ValidateTags=kF;const LF=self.C3,NF=self.C3X,WF=self.IBehaviorInstance,UF=self.Ease,VF=LF.Behaviors.Tween,HF=new WeakMap,jF=new Map([["x",{name:"offsetX",type:"one"}],["y",{name:"offsetY",type:"one"}],["width",{name:"offsetWidth",type:"one"}],["height",{name:"offsetHeight",type:"one"}],["angle",{name:"offsetAngle",type:"one"}],["opacity",{name:"offsetOpacity",type:"one"}],["color",{name:"offsetColor",type:"color"}],["z-elevation",{name:"offsetZElevation",type:"one"}],["x-scale",{name:"offsetScaleX",type:"one"}],["y-scale",{name:"offsetScaleY",type:"one"}],["position",{name:"position",type:"two"}],["size",{name:"size",type:"two"}],["scale",{name:"scale",type:"two"}],["value",{name:"value",type:"value"}]]),zF={tags:"",destroyOnComplete:!1,loop:!1,pingPong:!1,repeatCount:1,startValue:0},XF={easeToIndexFunc:BF};self.ITweenBehaviorInstance=class extends WF{constructor(){super(),HF.set(this,WF._GetInitInst().GetSdkInstance())}startTween(e,t,s,i,r){const n=HF.get(this);if(!n.IsEnabled()||!n.IsInstanceValid())return null;const a=jF.get(e);if(!a)throw new Error("invalid tween property");"one"===a.type||"value"===a.type?NF.RequireNumber(t):(NF.RequireArray(t),"two"===a.type?(NF.RequireNumber(t[0]),NF.RequireNumber(t[1])):"color"===a.type&&(NF.RequireNumber(t[0]),NF.RequireNumber(t[1]),NF.RequireNumber(t[2]))),"angle"===e?t=LF.toDegrees(t):"opacity"===e?t*=100:"color"===e&&(t=LF.PackRGBEx(t[0],t[1],t[2]));const o=BF(i);let h;if(NF.RequireFiniteNumber(s),r=Object.assign({},zF,r),"value"===a.type&&NF.RequireNumber(r.startValue),kF(r.tags,!0),"one"===a.type||"color"===a.type?h=n.CreateTween(VF.TweenArguments.OneProperty(n,r.tags,a.name,t,s,o,!!r.destroyOnComplete,!!r.loop,!!r.pingPong,r.repeatCount)):"two"===a.type?h=n.CreateTween(VF.TweenArguments.TwoProperties(n,r.tags,a.name,t[0],t[1],s,o,!!r.destroyOnComplete,!!r.loop,!!r.pingPong,r.repeatCount)):"value"===a.type&&(h=n.CreateTween(VF.TweenArguments.ValueProperty(n,r.tags,r.startValue,t,s,o,!!r.destroyOnComplete,!!r.loop,!!r.pingPong,r.repeatCount))),h.SetBehaviorInstance(n.GetBehaviorInstance().GetSdkInstance()),!h.Play())throw new Error("failed to start tween");return h.GetITweenState(n,XF)}*allTweens(){const e=HF.get(this);for(const t of e.AllTweens())yield t.GetITweenState(e,XF)}*tweensByTags(e){kF(e);const t=HF.get(this);for(const s of t.GetTweens(e))yield s.GetITweenState(t,XF)}get isEnabled(){return HF.get(this).IsEnabled()}set isEnabled(e){HF.get(this).SetEnabled(e)}}}{const YF=self.C3;YF.Behaviors.EightDir=class extends YF.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const qF=self.C3;qF.Behaviors.EightDir.Type=class extends qF.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const KF=self.C3,$F=self.C3X,JF=self.IBehaviorInstance,ZF=1/Math.sqrt(2),QF=0,eO=1,tO=2,sO=3,iO=4,rO=5,nO=6,aO=7;KF.Behaviors.EightDir.Instance=class extends KF.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._upKey=!1,this._downKey=!1,this._leftKey=!1,this._rightKey=!1,this._ignoreInput=!1,this._simUp=!1,this._simDown=!1,this._simLeft=!1,this._simRight=!1,this._dx=0,this._dy=0,this._maxSpeed=200,this._acc=600,this._dec=500,this._directions=3,this._angleMode=3,this._allowSliding=!1,this._defaultControls=!0,this._isEnabled=!0,t&&(this._maxSpeed=t[QF],this._acc=t[eO],this._dec=t[tO],this._directions=t[sO],this._angleMode=t[iO],this._allowSliding=!!t[rO],this._defaultControls=!!t[nO],this._isEnabled=!!t[aO]),this._isEnabled&&this._StartTicking(),this._defaultControls&&this._BindEvents()}_BindEvents(){if(this._disposables)return;const e=this._runtime.Dispatcher();this._disposables=new KF.CompositeDisposable(KF.Disposable.From(e,"keydown",e=>this._OnKeyDown(e.data)),KF.Disposable.From(e,"keyup",e=>this._OnKeyUp(e.data)),KF.Disposable.From(e,"window-blur",()=>this._OnWindowOrKeyboardBlur()),KF.Disposable.From(e,"keyboard-blur",()=>this._OnWindowOrKeyboardBlur()))}_UnBindEvents(){this._disposables&&(this._disposables.Release(),this._disposables=null)}Release(){super.Release()}SaveToJson(){return{dx:this._dx,dy:this._dy,e:this._isEnabled,ms:this._maxSpeed,acc:this._acc,dec:this._dec,d:this._directions,am:this._angleMode,dc:this._defaultControls,ii:this._ignoreInput}}LoadFromJson(e){this._dx=e.dx,this._dy=e.dy,this._SetEnabled(e.e),this._maxSpeed=e.ms,this._acc=e.acc,this._dec=e.dec,this._directions=e.d,this._angleMode=e.am,this._defaultControls=e.dc,this._ignoreInput=e.ii,this._upKey=!1,this._downKey=!1,this._leftKey=!1,this._rightKey=!1,this._simUp=!1,this._simDown=!1,this._simLeft=!1,this._simRight=!1,this._defaultControls?this._BindEvents():this._UnBindEvents()}_OnKeyDown(e){switch(e.key){case"ArrowLeft":this._leftKey=!0;break;case"ArrowUp":this._upKey=!0;break;case"ArrowRight":this._rightKey=!0;break;case"ArrowDown":this._downKey=!0}}_OnKeyUp(e){switch(e.key){case"ArrowLeft":this._leftKey=!1;break;case"ArrowUp":this._upKey=!1;break;case"ArrowRight":this._rightKey=!1;break;case"ArrowDown":this._downKey=!1}}_OnWindowOrKeyboardBlur(){this._upKey=!1,this._downKey=!1,this._leftKey=!1,this._rightKey=!1}Tick(){const e=this._runtime.GetDt(this._inst),t=this._runtime.GetCollisionEngine();let s=this._leftKey||this._simLeft,i=this._rightKey||this._simRight,r=this._upKey||this._simUp,n=this._downKey||this._simDown;if(this._simLeft=!1,this._simRight=!1,this._simUp=!1,this._simDown=!1,!this._isEnabled)return;let a=t.TestOverlapSolid(this._inst);if(a&&(t.RegisterCollision(this._inst,a),!t.PushOutSolidNearest(this._inst)))return;if(this._ignoreInput&&(s=i=r=n=!1),0===this._directions?s=i=!1:1===this._directions&&(r=n=!1),2===this._directions&&(r||n)&&(s=i=!1),s===i){const t=r===n&&0!==this._dy?ZF:1;this._dx<0?this._dx=Math.min(this._dx+this._dec*t*e,0):this._dx>0&&(this._dx=Math.max(this._dx-this._dec*t*e,0))}if(r===n){const t=s===i&&0!==this._dx?ZF:1;this._dy<0?this._dy=Math.min(this._dy+this._dec*t*e,0):this._dy>0&&(this._dy=Math.max(this._dy-this._dec*t*e,0))}let o=0,h=0;s&&!i&&(o=-1),i&&!s&&(o=1),r&&!n&&(h=-1),n&&!r&&(h=1);let l=0,c=0;if(0!==o){const e=0!==h?ZF:1;l=Math.sign(this._dx)===-o?o*e*(this._acc+this._dec):o*e*this._acc}if(0!==h){const e=0!==o?ZF:1;c=Math.sign(this._dy)===-h?h*e*(this._acc+this._dec):h*e*this._acc}if(this._dx+=l*e,this._dy+=c*e,0!==this._dx||0!==this._dy){let s=Math.hypot(this._dx,this._dy);const i=Math.atan2(this._dy,this._dx),r=this._maxSpeed*Math.cos(i),n=this._maxSpeed*Math.sin(i);s>this._maxSpeed&&(s=this._maxSpeed,this._dx=r,this._dy=n);const o=this._inst.GetWorldInfo(),h=o.GetX(),u=o.GetY(),d=o.GetAngle(),_=Math.abs(r)*e,p=Math.abs(n)*e,f=KF.clamp(this._dx*e+.5*l*e*e,-_,_),m=KF.clamp(this._dy*e+.5*c*e*e,-p,p);if(this._allowSliding){if(o.OffsetXY(f,m),o.SetBboxChanged(),a=t.TestOverlapSolid(this._inst),a){t.RegisterCollision(this._inst,a);const i=Math.atan2(this._dy,this._dx)+Math.PI/2;let r=!1;const n=(o.GetWidth()+o.GetHeight())/4;if(t.PushOutSolidAxis(this._inst,Math.cos(i),Math.sin(i),Math.max(2.5*s*e,n))){r=!0;const i=o.GetX(),n=o.GetY(),l=s*e,c=KF.distanceTo(h,u,i,n);if(c>1.01*l){const e=l/c,s=KF.lerp(h,i,e),d=KF.lerp(u,n,e);if(o.SetXY(s,d),o.SetBboxChanged(),a=t.TestOverlapSolid(this._inst),a){const e=KF.angleTo(h,u,i,n)+Math.PI/2,s=Math.cos(e),a=Math.sin(e),l=(o.GetWidth()+o.GetHeight())/2/10;t.PushOutSolidAxis(this._inst,s,a,Math.max(l,1))||(o.SetXY(h,u),o.SetBboxChanged(),r=!1)}}}if(!r){const i=Math.hypot(f,m),r=-f/i,a=-m/i;this._dx=0,this._dy=0,t.PushOutSolid(this._inst,r,a,Math.max(2.5*s*e,n))||(o.SetXY(h,u),o.SetBboxChanged())}}}else o.OffsetX(f),o.SetBboxChanged(),a=t.TestOverlapSolid(this._inst),a&&(t.PushOutSolid(this._inst,this._dx<0?1:-1,0,Math.max(Math.abs(Math.floor(f)),1))||(o.SetX(h),o.SetBboxChanged()),this._dx=0,t.RegisterCollision(this._inst,a)),o.OffsetY(m),o.SetBboxChanged(),a=t.TestOverlapSolid(this._inst),a&&(t.PushOutSolid(this._inst,0,this._dy<0?1:-1,Math.max(Math.abs(Math.floor(m)),1))||(o.SetY(u),o.SetBboxChanged()),this._dy=0,t.RegisterCollision(this._inst,a));const g=KF.roundToDp(this._dx,6),S=KF.roundToDp(this._dy,6);0===g&&0===S||!this._inst.GetPlugin().IsRotatable()||(1===this._angleMode?o.SetAngle(KF.toRadians(90*Math.round(KF.toDegrees(Math.atan2(S,g))/90))):2===this._angleMode?o.SetAngle(KF.toRadians(45*Math.round(KF.toDegrees(Math.atan2(S,g))/45))):3===this._angleMode&&o.SetAngle(Math.atan2(S,g))),o.SetBboxChanged(),o.GetAngle()!=d&&(a=t.TestOverlapSolid(this._inst),a&&(o.SetAngle(d),o.SetBboxChanged(),t.RegisterCollision(this._inst,a)))}}GetPropertyValueByIndex(e){switch(e){case QF:return this._GetMaxSpeed();case eO:return this._GetAcceleration();case tO:return this._GetDeceleration();case sO:return this._directions;case iO:return this._angleMode;case rO:return this._allowSliding;case nO:return this._IsDefaultControls();case aO:return this._IsEnabled()}}SetPropertyValueByIndex(e,t){switch(e){case QF:this._SetMaxSpeed(t);break;case eO:this._SetAcceleration(t);break;case tO:this._SetDeceleration(t);break;case sO:this._directions=t;break;case iO:this._angleMode=t;break;case rO:this._allowSliding=!!t;break;case nO:this._SetDefaultControls(!!t);break;case aO:this._SetEnabled(!!t)}}_Stop(){this._dx=0,this._dy=0}_Reverse(){this._dx*=-1,this._dy*=-1}_MaybeClampSpeed(){const e=Math.hypot(this._dx,this._dy);e>this._maxSpeed&&this._SetSpeed(e)}_SetSpeed(e){e=KF.clamp(e,0,this._maxSpeed);const t=Math.atan2(this._dy,this._dx);this._dx=e*Math.cos(t),this._dy=e*Math.sin(t)}_GetSpeed(){return Math.hypot(this._dx,this._dy)}_SetMaxSpeed(e){this._maxSpeed=Math.max(e,0)}_GetMaxSpeed(){return this._maxSpeed}_SetAcceleration(e){this._acc=Math.max(e,0)}_GetAcceleration(){return this._acc}_SetDeceleration(e){this._dec=Math.max(e,0)}_GetDeceleration(){return this._dec}_GetMovingAngle(){return Math.atan2(this._dy,this._dx)}_SetVectorX(e){this._dx=e,this._MaybeClampSpeed()}_GetVectorX(){return this._dx}_SetVectorY(e){this._dy=e,this._MaybeClampSpeed()}_GetVectorY(){return this._dy}_SimulateControl(e){if(this._isEnabled)switch(e){case 0:this._simLeft=!0;break;case 1:this._simRight=!0;break;case 2:this._simUp=!0;break;case 3:this._simDown=!0}}_SetDefaultControls(e){e=!!e,this._defaultControls!==e&&(this._defaultControls=e,this._defaultControls?this._BindEvents():(this._UnBindEvents(),this._OnWindowOrKeyboardBlur()))}_IsDefaultControls(){return this._defaultControls}_SetIgnoreInput(e){this._ignoreInput=!!e}_IsIgnoreInput(){return this._ignoreInput}_SetEnabled(e){this._isEnabled=!!e,this._isEnabled?this._StartTicking():(this._simLeft=!1,this._simRight=!1,this._simUp=!1,this._simDown=!1,this._StopTicking())}_IsEnabled(){return this._isEnabled}_SetAllowSliding(e){this._allowSliding=!!e}_IsAllowSliding(){return this._allowSliding}GetDebuggerProperties(){const e="behaviors.eightdir";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".debugger.vector-x",value:this._GetVectorX(),onedit:e=>this._SetVectorX(e)},{name:e+".debugger.vector-y",value:this._GetVectorY(),onedit:e=>this._SetVectorY(e)},{name:e+".debugger.speed",value:this._GetSpeed(),onedit:e=>this._SetSpeed(e)},{name:e+".debugger.angle-of-motion",value:KF.toDegrees(this._GetMovingAngle())},{name:e+".properties.max-speed.name",value:this._GetMaxSpeed(),onedit:e=>this._SetMaxSpeed(e)},{name:e+".properties.acceleration.name",value:this._GetAcceleration(),onedit:e=>this._SetAcceleration(e)},{name:e+".properties.deceleration.name",value:this._GetDeceleration(),onedit:e=>this._SetDeceleration(e)},{name:e+".properties.allow-sliding.name",value:this._IsAllowSliding(),onedit:e=>this._SetAllowSliding(e)},{name:e+".properties.enabled.name",value:this._IsEnabled(),onedit:e=>this._SetEnabled(e)}]}]}GetScriptInterfaceClass(){return self.I8DirectionBehaviorInstance}};const oO=new WeakMap,hO=new Map([["left",0],["right",1],["up",2],["down",3]]);self.I8DirectionBehaviorInstance=class extends JF{constructor(){super(),oO.set(this,JF._GetInitInst().GetSdkInstance())}stop(){oO.get(this)._Stop()}reverse(){oO.get(this)._Reverse()}simulateControl(e){$F.RequireString(e);const t=hO.get(e);if("number"!=typeof t)throw new Error("invalid control");oO.get(this)._SimulateControl(t)}get speed(){return oO.get(this)._GetSpeed()}set speed(e){$F.RequireFiniteNumber(e),oO.get(this)._SetSpeed(e)}get maxSpeed(){return oO.get(this)._GetMaxSpeed()}set maxSpeed(e){$F.RequireFiniteNumber(e),oO.get(this)._SetMaxSpeed(e)}get acceleration(){return oO.get(this)._GetAcceleration()}set acceleration(e){$F.RequireFiniteNumber(e),oO.get(this)._SetAcceleration(e)}get deceleration(){return oO.get(this)._GetDeceleration()}set deceleration(e){$F.RequireFiniteNumber(e),oO.get(this)._SetDeceleration(e)}get vectorX(){return oO.get(this)._GetVectorX()}set vectorX(e){$F.RequireFiniteNumber(e),oO.get(this)._SetVectorX(e)}get vectorY(){return oO.get(this)._GetVectorY()}set vectorY(e){$F.RequireFiniteNumber(e),oO.get(this)._SetVectorY(e)}setVector(e,t){$F.RequireFiniteNumber(e),$F.RequireFiniteNumber(t);const s=oO.get(this);s._SetVectorX(e),s._SetVectorY(t)}getVector(){const e=oO.get(this);return[e._GetVectorX(),e._GetVectorY()]}get isDefaultControls(){return oO.get(this)._IsDefaultControls()}set isDefaultControls(e){oO.get(this)._SetDefaultControls(!!e)}get isIgnoringInput(){return oO.get(this)._IsIgnoreInput()}set isIgnoringInput(e){oO.get(this)._SetIgnoreInput(!!e)}get isAllowSliding(){return oO.get(this)._IsAllowSliding()}set isAllowSliding(e){oO.get(this)._SetAllowSliding(!!e)}get isEnabled(){return oO.get(this)._IsEnabled()}set isEnabled(e){oO.get(this)._SetEnabled(!!e)}}}{const lO=self.C3;lO.Behaviors.EightDir.Cnds={IsMoving(){return this._GetSpeed()>1e-10},CompareSpeed(e,t){return lO.compare(this._GetSpeed(),e,t)},IsEnabled(){return this._IsEnabled()},IsAllowSliding(){return this._IsAllowSliding()}}}self.C3.Behaviors.EightDir.Acts={Stop(){this._Stop()},Reverse(){this._Reverse()},SetIgnoreInput(e){this._SetIgnoreInput(e)},SetSpeed(e){this._SetSpeed(e)},SetMaxSpeed(e){this._SetMaxSpeed(e)},SetAcceleration(e){this._SetAcceleration(e)},SetDeceleration(e){this._SetDeceleration(e)},SimulateControl(e){this._SimulateControl(e)},SetEnabled(e){this._SetEnabled(e)},SetVectorX(e){this._SetVectorX(e)},SetVectorY(e){this._SetVectorY(e)},SetDefaultControls(e){this._SetDefaultControls(!!e)},SetAllowSliding(e){this._SetAllowSliding(e)}};{const cO=self.C3;cO.Behaviors.EightDir.Exps={Speed(){return this._GetSpeed()},MaxSpeed(){return this._GetMaxSpeed()},Acceleration(){return this._GetAcceleration()},Deceleration(){return this._GetDeceleration()},MovingAngle(){return cO.toDegrees(this._GetMovingAngle())},VectorX(){return this._GetVectorX()},VectorY(){return this._GetVectorY()}}}{const uO=self.C3;uO.Behaviors.bound=class extends uO.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const dO=self.C3;dO.Behaviors.bound.Type=class extends dO.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const _O=self.C3,pO=0;_O.Behaviors.bound.Instance=class extends _O.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._mode=0,t&&(this._mode=t[pO]),this._StartTicking2()}Release(){super.Release()}SaveToJson(){return{m:this._mode}}LoadFromJson(e){this._mode=e.m}Tick2(){const e=this._inst.GetWorldInfo(),t=e.GetBoundingBox(),s=e.GetLayout();let i=!1;0===this._mode?(e.GetX()<0&&(e.SetX(0),i=!0),e.GetY()<0&&(e.SetY(0),i=!0),e.GetX()>s.GetWidth()&&(e.SetX(s.GetWidth()),i=!0),e.GetY()>s.GetHeight()&&(e.SetY(s.GetHeight()),i=!0)):(t.getLeft()<0&&(e.OffsetX(-t.getLeft()),i=!0),t.getTop()<0&&(e.OffsetY(-t.getTop()),i=!0),t.getRight()>s.GetWidth()&&(e.OffsetX(-(t.getRight()-s.GetWidth())),i=!0),t.getBottom()>s.GetHeight()&&(e.OffsetY(-(t.getBottom()-s.GetHeight())),i=!0)),i&&e.SetBboxChanged()}GetPropertyValueByIndex(e){if(e===pO)return this._mode}SetPropertyValueByIndex(e,t){e===pO&&(this._mode=t)}}}self.C3.Behaviors.bound.Cnds={},self.C3.Behaviors.bound.Acts={},self.C3.Behaviors.bound.Exps={};{const fO=self.C3;fO.Behaviors.Flash=class extends fO.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const mO=self.C3;mO.Behaviors.Flash.Type=class extends mO.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const gO=self.C3,SO=self.C3X,GO=self.IBehaviorInstance;gO.Behaviors.Flash.Instance=class extends gO.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._onTime=0,this._offTime=0,this._stage=0,this._stageTimeLeft=0,this._timeLeft=0,this._StartTicking()}Release(){super.Release()}_Flash(e,t,s){this._onTime=e,this._offTime=t,this._stage=1,this._stageTimeLeft=t,this._timeLeft=s,this._inst.GetWorldInfo().SetVisible(!1),this._runtime.UpdateRender()}_StopFlashing(){this._timeLeft=0,this._inst.GetWorldInfo().SetVisible(!0),this._runtime.UpdateRender()}_IsFlashing(){return this._timeLeft>0}SaveToJson(){return{on:this._onTime,off:this._offTime,s:this._stage,stl:this._stageTimeLeft,tl:this._timeLeft}}LoadFromJson(e){this._onTime=e.on,this._offTime=e.off,this._stage=e.s,this._stageTimeLeft=e.stl,this._timeLeft=null===e.tl?1/0:e.tl}Tick(){if(this._timeLeft<=0)return;const e=this._runtime.GetDt(this._inst);if(this._timeLeft-=e,this._timeLeft<=0)return this._timeLeft=0,this._inst.GetWorldInfo().SetVisible(!0),this._runtime.UpdateRender(),this.DispatchScriptEvent("flashend"),this.DebugTrigger(gO.Behaviors.Flash.Cnds.OnFlashEnded);this._stageTimeLeft-=e,this._stageTimeLeft<=0&&(0===this._stage?(this._inst.GetWorldInfo().SetVisible(!1),this._stage=1,this._stageTimeLeft+=this._offTime):(this._inst.GetWorldInfo().SetVisible(!0),this._stage=0,this._stageTimeLeft+=this._onTime),this._runtime.UpdateRender())}GetDebuggerProperties(){const e="behaviors.flash.debugger";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".on-time",value:this._onTime,onedit:e=>this._onTime=e},{name:e+".off-time",value:this._offTime,onedit:e=>this._offTime=e},{name:e+".is-flashing",value:this._timeLeft>0},{name:e+".time-left",value:this._timeLeft}]}]}GetScriptInterfaceClass(){return self.IFlashBehaviorInstance}};const yO=new WeakMap;self.IFlashBehaviorInstance=class extends GO{constructor(){super(),yO.set(this,GO._GetInitInst().GetSdkInstance())}flash(e,t,s){SO.RequireFiniteNumber(e),SO.RequireFiniteNumber(t),SO.RequireFiniteNumber(s),yO.get(this)._Flash(e,t,s)}stop(){yO.get(this)._StopFlashing()}get isFlashing(){return yO.get(this)._IsFlashing()}}}self.C3.Behaviors.Flash.Cnds={IsFlashing(){return this._IsFlashing()},OnFlashEnded:()=>!0},self.C3.Behaviors.Flash.Acts={Flash(e,t,s){this._Flash(e,t,s)},StopFlashing(){this._StopFlashing()}},self.C3.Behaviors.Flash.Exps={};{const IO=self.C3;IO.Behaviors.Bullet=class extends IO.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const TO=self.C3;TO.Behaviors.Bullet.Type=class extends TO.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const CO=self.C3,bO=self.C3X,xO=self.IBehaviorInstance,wO=0,PO=1,RO=2,vO=3,AO=4,MO=5,DO=6;CO.Behaviors.Bullet.Instance=class extends CO.SDKBehaviorInstanceBase{constructor(e,t){super(e);const s=this.GetWorldInfo();this._speed=0,this._acc=0,this._g=0,this._bounceOffSolid=!1,this._setAngle=!1,this._isStepping=!1,this._isEnabled=!0,this._dx=0,this._dy=0,this._lastX=s.GetX(),this._lastY=s.GetY(),this._lastKnownAngle=s.GetAngle(),this._travelled=0,this._stepSize=Math.min(Math.abs(s.GetWidth()),Math.abs(s.GetHeight())/2),this._stopStepping=!1,t&&(this._speed=t[wO],this._acc=t[PO],this._g=t[RO],this._bounceOffSolid=!!t[vO],this._setAngle=!!t[AO],this._isStepping=!!t[MO],this._isEnabled=!!t[DO]);const i=s.GetAngle();this._dx=Math.cos(i)*this._speed,this._dy=Math.sin(i)*this._speed,this._isEnabled&&(this._StartTicking(),this._bounceOffSolid&&this._StartPostTicking())}Release(){super.Release()}SaveToJson(){const e={dx:this._dx,dy:this._dy,lx:this._lastX,ly:this._lastY,lka:this._lastKnownAngle,t:this._travelled};return 0!==this._acc&&(e.acc=this._acc),0!==this._g&&(e.g=this._g),this._isStepping&&(e.st=this._isStepping),this._isEnabled||(e.e=this._isEnabled),this._bounceOffSolid&&(e.bos=this._bounceOffSolid),this._setAngle&&(e.sa=this._setAngle),e}LoadFromJson(e){this._dx=e.dx,this._dy=e.dy,this._lastX=e.lx,this._lastY=e.ly,this._lastKnownAngle=e.lka,this._travelled=e.t,this._acc=e.hasOwnProperty("acc")?e.acc:0,this._g=e.hasOwnProperty("g")?e.g:0,this._isStepping=!!e.hasOwnProperty("st")&&e.st,this._bounceOffSolid=!!e.hasOwnProperty("bos")&&e.bos,this._setAngle=!!e.hasOwnProperty("sa")&&e.sa,this._SetEnabled(!e.hasOwnProperty("e")||e.e)}Tick(){if(!this._isEnabled)return;const e=this._runtime.GetDt(this._inst),t=this._inst.GetWorldInfo();if(t.GetAngle()!==this._lastKnownAngle){const e=t.GetAngle();if(this._setAngle){const t=CO.distanceTo(0,0,this._dx,this._dy);this._dx=Math.cos(e)*t,this._dy=Math.sin(e)*t}this._lastKnownAngle=e}let s=0,i=0;if(0!==this._acc){let r=CO.distanceTo(0,0,this._dx,this._dy),n=0;n=0===this._dx&&0===this._dy?t.GetAngle():CO.angleTo(0,0,this._dx,this._dy),r+=this._acc*e,s=Math.cos(n)*this._acc,i=Math.sin(n)*this._acc,r<0&&(r=0,s=0,i=0),this._dx=Math.cos(n)*r,this._dy=Math.sin(n)*r}if(0!==this._g&&(this._dy+=this._g*e,i+=this._g),this._lastX=t.GetX(),this._lastY=t.GetY(),0!==this._dx||0!==this._dy){const r=this._dx*e+.5*s*e*e,n=this._dy*e+.5*i*e*e,a=CO.distanceTo(0,0,r,n);if(this._MoveBy(r,n,a),this._travelled+=a,this._setAngle&&(0!==r||0!==n)){const e=CO.angleTo(0,0,r,n);t.SetAngle(e),this._lastKnownAngle=t.GetAngle()}t.SetBboxChanged()}}_MoveBy(e,t,s){const i=this.GetWorldInfo();if(!this._isStepping||s<=this._stepSize)return i.OffsetXY(e,t),i.SetBboxChanged(),void(this._isStepping&&this.Trigger(CO.Behaviors.Bullet.Cnds.OnStep));this._stopStepping=!1;const r=i.GetX(),n=i.GetY(),a=r+e,o=n+t,h=CO.angleTo(0,0,e,t),l=Math.cos(h)*this._stepSize,c=Math.sin(h)*this._stepSize,u=Math.floor(s/this._stepSize);for(let e=1;e<=u;++e)if(i.SetXY(r+l*e,n+c*e),i.SetBboxChanged(),this.Trigger(CO.Behaviors.Bullet.Cnds.OnStep),this._inst.IsDestroyed()||this._stopStepping)return;i.SetXY(a,o),i.SetBboxChanged(),this.Trigger(CO.Behaviors.Bullet.Cnds.OnStep)}PostTick(){if(!this._isEnabled||!this._bounceOffSolid||0===this._dx&&0===this._dy)return;const e=this._runtime.GetDt(this._inst),t=this._inst.GetWorldInfo(),s=this._runtime.GetCollisionEngine(),i=s.TestOverlapSolid(this._inst);if(i){s.RegisterCollision(this._inst,i);const r=CO.distanceTo(0,0,this._dx,this._dy),n=s.CalculateBounceAngle(this._inst,this._lastX,this._lastY);this._dx=Math.cos(n)*r,this._dy=Math.sin(n)*r,t.OffsetXY(this._dx*e,this._dy*e),t.SetBboxChanged(),this._setAngle&&(t.SetAngle(n),this._lastKnownAngle=t.GetAngle(),t.SetBboxChanged()),s.PushOutSolid(this._inst,this._dx/r,this._dy/r,Math.max(2.5*r*e,30))||s.PushOutSolidNearest(this._inst,100)}}GetPropertyValueByIndex(e){switch(e){case wO:return this._GetSpeed();case PO:return this._GetAcceleration();case RO:return this._GetGravity();case AO:return this._setAngle;case MO:return this._isStepping;case DO:return this._IsEnabled()}}SetPropertyValueByIndex(e,t){switch(e){case wO:this._SetSpeed(t);break;case PO:this._acc=t;break;case RO:this._g=t;break;case AO:this._setAngle=!!t;break;case MO:this._isStepping=!!t;break;case DO:this._SetEnabled(!!t)}}_SetSpeed(e){const t=CO.angleTo(0,0,this._dx,this._dy);this._dx=Math.cos(t)*e,this._dy=Math.sin(t)*e}_GetSpeed(){return CO.roundToDp(CO.distanceTo(0,0,this._dx,this._dy),6)}_SetAcceleration(e){this._acc=e}_GetAcceleration(){return this._acc}_SetGravity(e){this._g=e}_GetGravity(){return this._g}_SetAngleOfMotion(e){const t=CO.distanceTo(0,0,this._dx,this._dy);this._dx=Math.cos(e)*t,this._dy=Math.sin(e)*t}_GetAngleOfMotion(){return CO.angleTo(0,0,this._dx,this._dy)}_SetBounceOffSolids(e){e=!!e,this._bounceOffSolid!==e&&(this._bounceOffSolid=e,this._isEnabled&&(this._bounceOffSolid?this._StartPostTicking():this._StopPostTicking()))}_IsBounceOffSolids(){return this._bounceOffSolid}_SetDistanceTravelled(e){this._travelled=e}_GetDistanceTravelled(){return this._travelled}_SetEnabled(e){this._isEnabled=!!e,this._isEnabled?(this._StartTicking(),this._bounceOffSolid&&this._StartPostTicking()):(this._StopTicking(),this._StopPostTicking())}_IsEnabled(){return this._isEnabled}GetDebuggerProperties(){const e="behaviors.bullet";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".debugger.vector-x",value:this._dx,onedit:e=>this._dx=e},{name:e+".debugger.vector-y",value:this._dy,onedit:e=>this._dy=e},{name:e+".properties.speed.name",value:this._GetSpeed(),onedit:e=>this._SetSpeed(e)},{name:e+".debugger.angle-of-motion",value:CO.toDegrees(this._GetAngleOfMotion())},{name:e+".properties.gravity.name",value:this._GetGravity(),onedit:e=>this._SetGravity(e)},{name:e+".properties.acceleration.name",value:this._GetAcceleration(),onedit:e=>this._SetAcceleration(e)},{name:e+".debugger.distance-travelled",value:this._GetDistanceTravelled()},{name:e+".properties.enabled.name",value:this._IsEnabled(),onedit:e=>this._SetEnabled(e)}]}]}GetScriptInterfaceClass(){return self.IBulletBehaviorInstance}};const EO=new WeakMap;self.IBulletBehaviorInstance=class extends xO{constructor(){super(),EO.set(this,xO._GetInitInst().GetSdkInstance())}get speed(){return EO.get(this)._GetSpeed()}set speed(e){bO.RequireFiniteNumber(e),EO.get(this)._SetSpeed(e)}get acceleration(){return EO.get(this)._GetAcceleration()}set acceleration(e){bO.RequireFiniteNumber(e),EO.get(this)._SetAcceleration(e)}get gravity(){return EO.get(this)._GetGravity()}set gravity(e){bO.RequireFiniteNumber(e),EO.get(this)._SetGravity(e)}get angleOfMotion(){return EO.get(this)._GetAngleOfMotion()}set angleOfMotion(e){bO.RequireFiniteNumber(e),EO.get(this)._SetAngleOfMotion(e)}get bounceOffSolids(){return EO.get(this)._IsBounceOffSolids()}set bounceOffSolids(e){EO.get(this)._SetBounceOffSolids(!!e)}get distanceTravelled(){return EO.get(this)._GetDistanceTravelled()}set distanceTravelled(e){bO.RequireFiniteNumber(e),EO.get(this)._SetDistanceTravelled(e)}get isEnabled(){return EO.get(this)._IsEnabled()}set isEnabled(e){EO.get(this)._SetEnabled(e)}}}{const FO=self.C3;FO.Behaviors.Bullet.Cnds={CompareSpeed(e,t){const s=Math.hypot(this._dx,this._dy);return FO.compare(s,e,t)},CompareTravelled(e,t){return FO.compare(this._GetDistanceTravelled(),e,t)},OnStep:()=>!0,IsEnabled(){return this._IsEnabled()}}}{const OO=self.C3;OO.Behaviors.Bullet.Acts={SetSpeed(e){this._SetSpeed(e)},SetAcceleration(e){this._SetAcceleration(e)},SetGravity(e){this._SetGravity(e)},SetAngleOfMotion(e){this._SetAngleOfMotion(OO.toRadians(e))},Bounce(e){if(!e)return;const t=e.GetFirstPicked(this._inst);if(!t)return;const s=this._inst.GetWorldInfo(),i=this._runtime.GetCollisionEngine(),r=this._runtime.GetDt(this._inst),n=OO.distanceTo(0,0,this._dx,this._dy),a=i.CalculateBounceAngle(this._inst,this._lastX,this._lastY,t);this._dx=Math.cos(a)*n,this._dy=Math.sin(a)*n,s.OffsetXY(this._dx*r,this._dy*r),s.SetBboxChanged(),this._setAngle&&(s.SetAngle(a),this._lastKnownAngle=s.GetAngle(),s.SetBboxChanged()),0!==n&&(this._bounceOffSolid?i.PushOutSolid(this._inst,this._dx/n,this._dy/n,Math.max(2.5*n*r,30))||i.PushOutSolidNearest(this._inst,100):i.PushOut(this._inst,this._dx/n,this._dy/n,Math.max(2.5*n*r,30),t))},SetBounceOffSolids(e){this._SetBounceOffSolids(e)},SetDistanceTravelled(e){this._SetDistanceTravelled(e)},SetEnabled(e){this._SetEnabled(e)},StopStepping(){this._stopStepping=!0}}}{const BO=self.C3;BO.Behaviors.Bullet.Exps={Speed(){return this._GetSpeed()},Acceleration(){return this._GetAcceleration()},AngleOfMotion(){return BO.toDegrees(this._GetAngleOfMotion())},DistanceTravelled(){return this._GetDistanceTravelled()},Gravity(){return this._GetGravity()}}}{const kO=self.C3;kO.Behaviors.Timer=class extends kO.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const LO=self.C3;LO.Behaviors.Timer.Type=class extends LO.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const NO=self.C3,WO=self.C3X,UO=self.IBehaviorInstance;NO.Behaviors.Timer.SingleTimer=class{constructor(e,t,s,i){this._current=NO.New(NO.KahanSum),this._current.Set(e||0),this._total=NO.New(NO.KahanSum),this._total.Set(t||0),this._duration=s||0,this._isRegular=!!i,this._isPaused=!1}GetCurrentTime(){return this._current.Get()}GetTotalTime(){return this._total.Get()}GetDuration(){return this._duration}SetPaused(e){this._isPaused=!!e}IsPaused(){return this._isPaused}Add(e){this._current.Add(e),this._total.Add(e)}HasFinished(){return this._current.Get()>=this._duration}Update(){if(this.HasFinished()){if(!this._isRegular)return!0;this._current.Subtract(this._duration)}return!1}SaveToJson(){return{c:this._current.Get(),t:this._total.Get(),d:this._duration,r:this._isRegular,p:this._isPaused}}LoadFromJson(e){this._current.Set(e.c),this._total.Set(e.t),this._duration=e.d,this._isRegular=!!e.r,this._isPaused=!!e.p}},NO.Behaviors.Timer.Instance=class extends NO.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._timers=new Map}Release(){this._timers.clear(),super.Release()}_StartTimer(e,t,s){const i=new NO.Behaviors.Timer.SingleTimer(0,0,e,s);this._timers.set(t.toLowerCase(),i),this._UpdateTickState()}_StopTimer(e){this._timers.delete(e.toLowerCase()),this._UpdateTickState()}_StopAllTimers(){this._timers.clear(),this._UpdateTickState()}_IsTimerRunning(e){return this._timers.has(e.toLowerCase())}_GetTimerCurrentTime(e){const t=this._timers.get(e.toLowerCase());return t?t.GetCurrentTime():0}_GetTimerNormalizedProgress(e){const t=this._timers.get(e.toLowerCase());return t?t.GetCurrentTime()/t.GetDuration():0}_GetTimerTotalTime(e){const t=this._timers.get(e.toLowerCase());return t?t.GetTotalTime():0}_GetTimerDuration(e){const t=this._timers.get(e.toLowerCase());return t?t.GetDuration():0}_HasTimerFinished(e){const t=this._timers.get(e.toLowerCase());return!!t&&t.HasFinished()}_SetTimerPaused(e,t){const s=this._timers.get(e.toLowerCase());s&&s.SetPaused(t)}_IsTimerPaused(e){const t=this._timers.get(e.toLowerCase());return!!t&&t.IsPaused()}_SetAllTimersPaused(e){for(const t of this._timers.values())t.SetPaused(e)}_UpdateTickState(){this._timers.size>0?(this._StartTicking(),this._StartTicking2()):(this._StopTicking(),this._StopTicking2())}SaveToJson(){const e={};for(const[t,s]of this._timers.entries())e[t]=s.SaveToJson();return e}LoadFromJson(e){this._timers.clear();for(const[t,s]of Object.entries(e)){const e=new NO.Behaviors.Timer.SingleTimer;e.LoadFromJson(s),this._timers.set(t,e)}this._UpdateTickState()}Tick(){const e=this._runtime.GetDt(this._inst);for(const[t,s]of this._timers)s.IsPaused()||(s.Add(e),s.HasFinished()&&this.DispatchScriptEvent("timer",!1,{tag:t}))}Tick2(){for(const[e,t]of this._timers.entries())t.Update()&&this._timers.delete(e)}GetDebuggerProperties(){return[{title:"behaviors.timer.debugger.timers",properties:[...this._timers.entries()].map(e=>({name:"$"+e[0],value:`${Math.round(10*e[1].GetCurrentTime())/10} / ${Math.round(10*e[1].GetDuration())/10}`}))}]}GetScriptInterfaceClass(){return self.ITimerBehaviorInstance}};const VO=["once","regular"];self.ITimerBehaviorInstance=class extends UO{#e;constructor(){super(),this.#e=UO._GetInitInst().GetSdkInstance()}startTimer(e,t,s="once"){WO.RequireFiniteNumber(e),WO.RequireString(t);const i=VO.indexOf(s);if(-1===i)throw new Error("invalid type");this.#e._StartTimer(e,t,1===i)}setTimerPaused(e,t){WO.RequireString(e),this.#e._SetTimerPaused(e,!!t)}setAllTimersPaused(e){this.#e._SetAllTimersPaused(!!e)}stopTimer(e){WO.RequireString(e),this.#e._StopTimer(e)}stopAllTimers(){this.#e._StopAllTimers()}isTimerRunning(e){return WO.RequireString(e),this.#e._IsTimerRunning(e)}isTimerPaused(e){return WO.RequireString(e),this.#e._IsTimerPaused(e)}getCurrentTime(e){return WO.RequireString(e),this.#e._GetTimerCurrentTime(e)}getNormalizedProgress(e){return WO.RequireString(e),this.#e._GetTimerNormalizedProgress(e)}getTotalTime(e){return WO.RequireString(e),this.#e._GetTimerTotalTime(e)}getDuration(e){return WO.RequireString(e),this.#e._GetTimerDuration(e)}hasFinished(e){return WO.RequireString(e),this.#e._HasTimerFinished(e)}}}self.C3.Behaviors.Timer.Cnds={OnTimer(e){return this._HasTimerFinished(e)},IsTimerRunning(e){return this._IsTimerRunning(e)},IsTimerPaused(e){return this._IsTimerPaused(e)}},self.C3.Behaviors.Timer.Acts={StartTimer(e,t,s){this._StartTimer(e,s,1===t)},StopTimer(e){this._StopTimer(e)},StopAllTimers(){this._StopAllTimers()},PauseResumeTimer(e,t){this._SetTimerPaused(e,0===t)},PauseResumeAllTimers(e){this._SetAllTimersPaused(0===e)}},self.C3.Behaviors.Timer.Exps={CurrentTime(e){return this._GetTimerCurrentTime(e)},NormalizedProgress(e){return this._GetTimerNormalizedProgress(e)},TotalTime(e){return this._GetTimerTotalTime(e)},Duration(e){return this._GetTimerDuration(e)}};{const HO=self.C3;HO.Behaviors.LOS=class extends HO.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const jO=self.C3;jO.Behaviors.LOS.Type=class extends jO.SDKBehaviorTypeBase{constructor(e){super(e),this._obstacleTypes=[]}Release(){jO.clearArray(this._obstacleTypes),super.Release()}OnCreate(){}AddObstacle(e){if(!this._obstacleTypes.includes(e)){for(const t of this._obstacleTypes)if(t.IsFamily()&&t.FamilyHasMember(e))return;this._obstacleTypes.push(e)}}ClearObstacles(){jO.clearArray(this._obstacleTypes)}GetObstacleTypes(){return this._obstacleTypes}FindLOSBehavior(e){const t=this.GetBehaviorType();for(const s of e.GetBehaviorInstances())if(s.GetBehaviorType()===t)return s.GetSdkInstance();return null}}}{const zO=self.C3,XO=self.C3X,YO=self.IBehaviorInstance,qO=0,KO=1,$O=2,JO=3,ZO=0,QO=[];zO.Behaviors.LOS.Instance=class extends zO.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._obstacleMode=0,this._range=1e4,this._cone=zO.toRadians(360),this._useCollisionCells=!0,this._ray=new zO.Ray,t&&(this._obstacleMode=t[qO],this._range=t[KO],this._cone=zO.toRadians(t[$O]),this._useCollisionCells=t[JO])}Release(){super.Release()}SaveToJson(){return{r:this._range,c:this._cone,om:this._obstacleMode,ucc:this._useCollisionCells,t:this.GetSdkType().GetObstacleTypes().map(e=>e.GetSID())}}LoadFromJson(e){this._range=e.r,this._cone=e.c,this._obstacleMode=e.om||0,this._useCollisionCells=!!e.ucc;const t=this.GetSdkType().GetObstacleTypes();zO.clearArray(t);for(const s of e.t){const e=this._runtime.GetObjectClassBySID(s);e&&t.push(e)}}HasLOSToInstance(e,t){const s=e.GetUID(),[i,r]=e.GetImagePoint(t);return this.HasLOSTo(i,r)||this._ray.DidCollide()&&this._ray.hitUid===s}HasLOSTo(e,t){const s=this.GetWorldInfo();let i=s.GetAngle();return s.GetWidth()<0&&(i+=Math.PI),this.HasLOSBetweenPositions(s.GetX(),s.GetY(),i,e,t)}HasLOSBetweenPositions(e,t,s,i,r){this._ray.Reset();const n=this._range;if(zO.distanceSquared(e,t,i,r)>n*n)return!1;const a=zO.angleTo(e,t,i,r);return!(zO.angleDiff(s,a)>this._cone/2)&&!this.CastRay(e,t,i,r,this._useCollisionCells).DidCollide()}_GetCollisionCandidates(e,t){if(t){const t=this.GetWorldInfo().GetLayer(),s=this._runtime.GetCollisionEngine();return this._obstacleMode===ZO?s.GetSolidCollisionCandidates(t,e.rect,QO):s.GetObjectClassesCollisionCandidates(t,this._GetObstacleTypes(),e.rect,QO),QO}if(this._obstacleMode===ZO){const e=this._runtime.GetSolidBehavior();return e?e.GetInstances():QO}for(const e of this._GetObstacleTypes())zO.appendArray(QO,e.GetInstances());return QO}_GetObstacleTypes(){return this.GetSdkType().GetObstacleTypes()}CastRay(e,t,s,i,r){const n=this._ray.Set(e,t,s,i),a=this._GetCollisionCandidates(n,r),o=this._runtime.GetCollisionEngine(),h=this._obstacleMode===ZO,l=this._inst;for(let e=0,t=a.length;e<t;++e){const t=a[e];t!==l&&(h&&!o.IsSolidCollisionAllowed(t,l)||o.TestRayIntersectsInstance(t,n))}return n.Complete(),zO.clearArray(QO),n}_GetRay(){return this._ray}_GetRayHitX(){const e=this._ray;return e.DidCollide()?e.hitX:0}_GetRayHitY(){const e=this._ray;return e.DidCollide()?e.hitY:0}_GetRayHitDistance(){const e=this._ray;return e.DidCollide()?e.distance:0}_GetRayHitUID(){const e=this._ray;return e.DidCollide()?e.hitUid:-1}_GetRayNormalX(e){const t=this._ray;return t.DidCollide()?t.hitX+e*t.normalX:0}_GetRayNormalY(e){const t=this._ray;return t.DidCollide()?t.hitY+e*t.normalY:0}_GetRayNormalAngle(){const e=this._ray;return e.DidCollide()?e.hitNormal:0}_GetRayReflectionX(e){const t=this._ray;return t.DidCollide()?t.hitX+e*t.reflectionX:0}_GetRayReflectionY(e){const t=this._ray;return t.DidCollide()?t.hitY+e*t.reflectionY:0}_GetRayReflectionAngle(){const e=this._ray;return e.DidCollide()?Math.atan2(e.reflectionY,e.reflectionX):0}_SetRange(e){this._range=e}_GetRange(){return this._range}_SetConeOfView(e){this._cone=e}_GetConeOfView(){return this._cone}GetPropertyValueByIndex(e){switch(e){case qO:return this._obstacleMode;case KO:return this._range;case $O:return zO.toDegrees(this._cone);case JO:return this._useCollisionCells}}SetPropertyValueByIndex(e,t){switch(e){case qO:this._obstacleMode=t;break;case KO:this._range=t;break;case $O:this._cone=zO.toRadians(t);break;case JO:this._useCollisionCells=!!t}}GetDebuggerProperties(){const e="behaviors.los.properties";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".range.name",value:this._GetRange(),onedit:e=>this._SetRange(e)},{name:e+".cone-of-view.name",value:zO.toDegrees(this._GetConeOfView()),onedit:e=>this._SetConeOfView(zO.toRadians(e))}]}]}GetScriptInterfaceClass(){return self.ILOSBehaviorInstance}};const eB=new WeakMap;self.ILOSBehaviorInstance=class extends YO{constructor(){super();const e=YO._GetInitInst().GetSdkInstance();eB.set(this,e),this.ray=new self.ILOSBehaviorRay(e)}set range(e){XO.RequireFiniteNumber(e),eB.get(this)._SetRange(e)}get range(){return eB.get(this)._GetRange()}set coneOfView(e){XO.RequireFiniteNumber(e),eB.get(this)._SetConeOfView(e)}get coneOfView(){return eB.get(this)._GetConeOfView()}hasLOStoPosition(e,t){return XO.RequireNumber(e),XO.RequireNumber(t),eB.get(this).HasLOSTo(e,t)}hasLOSBetweenPositions(e,t,s,i,r){return XO.RequireNumber(e),XO.RequireNumber(t),XO.RequireNumber(s),XO.RequireNumber(i),XO.RequireNumber(r),eB.get(this).HasLOSBetweenPositions(e,t,s,i,r)}castRay(e,t,s,i,r=!0){return XO.RequireNumber(e),XO.RequireNumber(t),XO.RequireNumber(s),XO.RequireNumber(i),eB.get(this).CastRay(e,t,s,i,r),this.ray}addObstacle(e){const t=eB.get(this),s=t.GetRuntime()._UnwrapIObjectClass(e);t.GetSdkType().AddObstacle(s)}clearObstacles(){eB.get(this).GetSdkType().ClearObstacles()}},self.ILOSBehaviorRay=class{constructor(e){eB.set(this,e)}get didCollide(){return eB.get(this)._GetRay().DidCollide()}get hitX(){return eB.get(this)._GetRayHitX()}get hitY(){return eB.get(this)._GetRayHitY()}getHitPosition(){const e=eB.get(this);return[e._GetRayHitX(),e._GetRayHitY()]}get hitDistance(){return eB.get(this)._GetRayHitDistance()}get hitUid(){return eB.get(this)._GetRayHitUID()}getNormalX(e){return XO.RequireFiniteNumber(e),eB.get(this)._GetRayNormalX(e)}getNormalY(e){return XO.RequireFiniteNumber(e),eB.get(this)._GetRayNormalY(e)}getNormal(e){XO.RequireFiniteNumber(e);const t=eB.get(this);return[t._GetRayNormalX(e),t._GetRayNormalY(e)]}get normalAngle(){return eB.get(this)._GetRayNormalAngle()}getReflectionX(e){return XO.RequireFiniteNumber(e),eB.get(this)._GetRayReflectionX(e)}getReflectionY(e){return XO.RequireFiniteNumber(e),eB.get(this)._GetRayReflectionY(e)}getReflection(e){XO.RequireFiniteNumber(e);const t=eB.get(this);return[t._GetRayReflectionX(e),t._GetRayReflectionY(e)]}get reflectionAngle(){return eB.get(this)._GetRayReflectionAngle()}}}{const tB=self.C3,sB=new Set,iB=new Set;tB.Behaviors.LOS.Cnds={HasLOSToPosition(e,t){return this.HasLOSTo(e,t)},RayIntersected(){return this._ray.DidCollide()},HasLOSBetweenPositions(e,t,s,i,r){return this.HasLOSBetweenPositions(e,t,tB.toRadians(s),i,r)},HasLOSToObject(e,t){if(!e)return!1;const s=this._runtime.GetCurrentCondition(),i=s.GetEventBlock().IsOrBlock(),r=s.GetRuntime(),n=s.GetObjectClass().GetCurrentSol(),a=e.GetCurrentSol();let o=n.GetInstances(),h=a.GetInstances();n.IsSelectAll()?tB.clearArray(n._GetOwnElseInstances()):i&&(o=r.IsCurrentConditionFirst()&&!n._GetOwnElseInstances().length&&n._GetOwnInstances().length?n._GetOwnInstances():n._GetOwnElseInstances()),a.IsSelectAll()?tB.clearArray(a._GetOwnElseInstances()):i&&(h=r.IsCurrentConditionFirst()&&!a._GetOwnElseInstances().length&&a._GetOwnInstances().length?a._GetOwnInstances():a._GetOwnElseInstances());const l=s.IsInverted(),c=this.GetSdkType();for(const e of o){let s=!1;const i=c.FindLOSBehavior(e);if(0===h.length)l&&(s=!0);else for(const r of h)e!==r&&tB.xor(i.HasLOSToInstance(r,t),l)&&(s=!0,iB.add(r));s&&sB.add(e)}return i?(o===n._GetOwnElseInstances()?n.TransferElseInstancesToOwn(sB):(n.AddElseInstances(sB,o),n.SetSetPicked(sB)),h===a._GetOwnElseInstances()?a.TransferElseInstancesToOwn(iB):(a.AddElseInstances(iB,h),a.SetSetPicked(iB))):(n.SetSetPicked(sB),a.SetSetPicked(iB)),sB.clear(),iB.clear(),n.HasAnyInstances()}}}{const rB=self.C3;rB.Behaviors.LOS.Acts={SetRange(e){this._SetRange(e)},SetCone(e){this._SetConeOfView(rB.toRadians(e))},CastRay(e,t,s,i,r){this.CastRay(e,t,s,i,r)},AddObstacle(e){this.GetSdkType().AddObstacle(e)},ClearObstacles(){this.GetSdkType().ClearObstacles()}}}{const nB=self.C3;nB.Behaviors.LOS.Exps={Range(){return this._GetRange()},ConeOfView(){return nB.toDegrees(this._GetConeOfView())},HitX(){return this._GetRayHitX()},HitY(){return this._GetRayHitY()},HitDistance(){return this._GetRayHitDistance()},HitUID(){return this._GetRayHitUID()},NormalX(e){return this._GetRayNormalX(e)},NormalY(e){return this._GetRayNormalY(e)},NormalAngle(){return nB.toDegrees(this._GetRayNormalAngle())},ReflectionX(e){return this._GetRayReflectionX(e)},ReflectionY(e){return this._GetRayReflectionY(e)},ReflectionAngle(){return nB.toDegrees(this._GetRayReflectionAngle())}}}{const aB=self.C3;aB.Behaviors.Turret=class extends aB.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const oB=self.C3;oB.Behaviors.Turret.Type=class extends oB.SDKBehaviorTypeBase{constructor(e){super(e),this._targetTypes=[]}Release(){oB.clearArray(this._targetTypes),super.Release()}OnCreate(){}GetTargetTypes(){return this._targetTypes}}}{const hB=self.C3,lB=self.C3X,cB=self.IBehaviorInstance,uB=0,dB=1,_B=2,pB=3,fB=4,mB=5,gB=6,SB=7,GB=8,yB=hB.New(hB.Rect),IB=[];hB.Behaviors.Turret.Instance=class extends hB.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._range=300,this._rateOfFire=1,this._isRotateEnabled=!0,this._rotateSpeed=hB.toRadians(180),this._targetMode=0,this._predictiveAim=!1,this._projectileSpeed=500,this._useCollisionCells=!0,this._isEnabled=!0,this._lastCheckTime=0,this._fireTimeCount=0,this._currentTarget=null,this._loadTargetUid=-1,this._oldTargetX=0,this._oldTargetY=0,t&&(this._range=t[uB],this._rateOfFire=t[dB],this._isRotateEnabled=!!t[_B],this._rotateSpeed=hB.toRadians(t[pB]),this._targetMode=t[fB],this._predictiveAim=!!t[mB],this._projectileSpeed=t[gB],this._useCollisionCells=!!t[SB],this._isEnabled=!!t[GB]),this._fireTimeCount=this._rateOfFire;const s=this._runtime.Dispatcher();this._disposables=new hB.CompositeDisposable(hB.Disposable.From(s,"instancedestroy",e=>this._OnInstanceDestroyed(e.instance)),hB.Disposable.From(s,"afterload",e=>this._OnAfterLoad())),this._isEnabled&&this._StartTicking()}Release(){this._currentTarget=null,super.Release()}_OnAfterLoad(){-1===this._loadTargetUid?this._currentTarget=null:this._currentTarget=this._runtime.GetInstanceByUID(this._loadTargetUid)}_OnInstanceDestroyed(e){this._currentTarget===e&&(this._currentTarget=null)}_MaybeAcquireTargetInstance(e){return!(this._currentTarget===e||this._inst===e||!this.IsInRange(e)||(this._currentTarget=e,this._OnTargetAcquired(),0))}_UnacquireTarget(){this._currentTarget=null}_SetRange(e){this._range=e}_GetRange(){return this._range}_SetRateOfFire(e){this._rateOfFire=e}_GetRateOfFire(){return this._rateOfFire}_SetRotateEnabled(e){this._isRotateEnabled=!!e}_IsRotateEnabled(){return this._isRotateEnabled}_SetRotateSpeed(e){this._rotateSpeed=e}_GetRotateSpeed(){return this._rotateSpeed}_SetTargetMode(e){this._targetMode=e}_GetTargetMode(){return this._targetMode}_SetPredictiveAim(e){this._predictiveAim=!!e}_IsPredictiveAim(){return this._predictiveAim}_SetProjectileSpeed(e){this._projectileSpeed=e}_GetProjectileSpeed(){return this._projectileSpeed}_SetEnabled(e){this._isEnabled=!!e,this._isEnabled?this._StartTicking():this._StopTicking()}_IsEnabled(){return this._isEnabled}SaveToJson(){return{r:this._range,rof:this._rateOfFire,re:this._isRotateEnabled,rs:this._rotateSpeed,tm:this._targetMode,pa:this._predictiveAim,ps:this._projectileSpeed,ucc:this._useCollisionCells,e:this._isEnabled,ftc:this._fireTimeCount,t:this._currentTarget?this._currentTarget.GetUID():-1,ox:this._oldTargetX,oy:this._oldTargetY,targs:this.GetSdkType().GetTargetTypes().map(e=>e.GetSID())}}LoadFromJson(e){this._range=e.r,this._rateOfFire=e.rof,this._isRotateEnabled=e.re,this._rotateSpeed=e.rs,this._targetMode=e.tm,this._predictiveAim=e.pa,this._projectileSpeed=e.ps,this._useCollisionCells=e.ucc,this._SetEnabled(e.e),this._fireTimeCount=e.ftc,this._loadTargetUid=e.t,this._oldTargetX=e.ox,this._oldTargetY=e.oy,this._lastCheckTime=0;const t=this.GetSdkType().GetTargetTypes();hB.clearArray(t);for(const s of e.targs){const e=this._runtime.GetObjectClassBySID(s);e&&t.push(e)}}IsInRange(e){const t=this.GetWorldInfo(),s=e.GetWorldInfo(),i=s.GetX()-t.GetX(),r=s.GetY()-t.GetY();return i*i+r*r<=this._range*this._range}LookForFirstTarget(){const e=this.GetWorldInfo(),t=this.GetSdkType().GetTargetTypes(),s=this._runtime.GetCollisionEngine();if(this._useCollisionCells)yB.set(e.GetX()-this._range,e.GetY()-this._range,e.GetX()+this._range,e.GetY()+this._range),s.GetObjectClassesCollisionCandidates(e.GetLayer(),t,yB,IB);else for(const e of t)hB.appendArray(IB,e.GetInstances());for(const e of IB)if(e!==this._inst&&this.IsInRange(e))return this._currentTarget=e,void hB.clearArray(IB);hB.clearArray(IB)}LookForNearestTarget(){const e=this.GetWorldInfo(),t=this.GetSdkType().GetTargetTypes(),s=this._runtime.GetCollisionEngine(),i=e.GetX(),r=e.GetY();let n=this._range*this._range;if(this._currentTarget=null,this._useCollisionCells)yB.set(i-this._range,r-this._range,i+this._range,r+this._range),s.GetObjectClassesCollisionCandidates(e.GetLayer(),t,yB,IB);else for(const e of t)hB.appendArray(IB,e.GetInstances());for(const e of IB){if(e===this._inst)continue;const t=e.GetWorldInfo(),s=i-t.GetX(),a=r-t.GetY(),o=s*s+a*a;o<n&&(this._currentTarget=e,n=o)}hB.clearArray(IB)}_OnTargetAcquired(){const e=this._currentTarget.GetWorldInfo();this._oldTargetX=e.GetX(),this._oldTargetY=e.GetY(),this.DispatchScriptEvent("targetacquired",!1,{targetInst:this._currentTarget.GetInterfaceClass()}),this.Trigger(hB.Behaviors.Turret.Cnds.OnTargetAcquired)}Tick(){if(!this._isEnabled)return;const e=this._runtime.GetDt(this._inst),t=this._runtime.GetGameTime(),s=this.GetWorldInfo();if(this._currentTarget&&!this.IsInRange(this._currentTarget)&&(this._currentTarget=null),t>=this._lastCheckTime+.1)if(this._lastCheckTime=t,0!==this._targetMode||this._currentTarget){if(1===this._targetMode){const e=this._currentTarget;this.LookForNearestTarget(),this._currentTarget&&this._currentTarget!==e&&this._OnTargetAcquired()}}else this.LookForFirstTarget(),this._currentTarget&&this._OnTargetAcquired();if(this._fireTimeCount+=e,this._currentTarget){let t=this._currentTarget.GetWorldInfo();const i=s.GetX(),r=s.GetY(),n=t.GetX(),a=t.GetY(),o=hB.angleTo(i,r,t.GetX(),t.GetY());let h=0;if(this._predictiveAim){const t=n-i,s=a-r,l=(n-this._oldTargetX)/e,c=(a-this._oldTargetY)/e,u=t*c-s*l,d=Math.asin(hB.clamp(u/(this._projectileSpeed*hB.hypot2DFast(t,s)),-1,1))+o;h=(Math.cos(d)*c-Math.sin(d)*l)*u>0?d:o}else h=o;this._isRotateEnabled&&(s.SetAngle(hB.angleRotate(s.GetAngle(),h,this._rotateSpeed*e)),s.SetBboxChanged()),this._fireTimeCount>=this._rateOfFire&&(!this._isRotateEnabled||hB.toDegrees(hB.angleDiff(s.GetAngle(),h))<=.1)&&(this._fireTimeCount-=this._rateOfFire,this._fireTimeCount>=this._rateOfFire&&(this._fireTimeCount=0),this.DispatchScriptEvent("shoot",!1,{targetInst:this._currentTarget.GetInterfaceClass()}),this.Trigger(hB.Behaviors.Turret.Cnds.OnShoot)),this._currentTarget&&(t=this._currentTarget.GetWorldInfo(),this._oldTargetX=t.GetX(),this._oldTargetY=t.GetY())}this._fireTimeCount>this._rateOfFire&&(this._fireTimeCount=this._rateOfFire)}GetPropertyValueByIndex(e){switch(e){case uB:return this._GetRange();case dB:return this._GetRateOfFire();case _B:return this._IsRotateEnabled();case pB:return hB.toDegrees(this._GetRotateSpeed());case fB:return this._GetTargetMode();case mB:return this._IsPredictiveAim();case gB:return this._GetProjectileSpeed();case SB:return this._useCollisionCells;case GB:return this._IsEnabled()}}SetPropertyValueByIndex(e,t){switch(e){case uB:this._SetRange(t);break;case dB:this._SetRateOfFire(t);break;case _B:this._SetRotateEnabled(!!t);break;case pB:if(!this._IsRotateEnabled())return;this._SetRotateSpeed(hB.toRadians(t));break;case fB:this._SetTargetMode(t);break;case mB:this._SetPredictiveAim(!!t);break;case gB:if(!this._IsPredictiveAim())return;this._SetProjectileSpeed(t);break;case SB:this._useCollisionCells=!!t;break;case GB:this._SetEnabled(t)}}GetDebuggerProperties(){const e="behaviors.turret";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".properties.range.name",value:this._GetRange(),onedit:e=>this._SetRange(e)},{name:e+".properties.rate-of-fire.name",value:this._GetRateOfFire(),onedit:e=>this._SetRateOfFire(e)},{name:e+".properties.rotate-speed.name",value:hB.toDegrees(this._GetRotateSpeed()),onedit:e=>this._SetRotateSpeed(hB.toRadians(e))},{name:e+".properties.predictive-aim.name",value:this._IsPredictiveAim(),onedit:e=>this._SetPredictiveAim(e)},{name:e+".properties.projectile-speed.name",value:this._GetProjectileSpeed(),onedit:e=>this._SetProjectileSpeed(e)},{name:e+".debugger.has-target",value:!!this._currentTarget},{name:e+".debugger.target-uid",value:this._currentTarget?this._currentTarget.GetUID():0},{name:e+".properties.enabled.name",value:this._IsEnabled(),onedit:e=>this._SetEnabled(e)}]}]}GetScriptInterfaceClass(){return self.ITurretBehaviorInstance}};const TB=new WeakMap,CB=["first","nearest"];self.ITurretBehaviorInstance=class extends cB{constructor(){super(),TB.set(this,cB._GetInitInst().GetSdkInstance())}get currentTarget(){const e=TB.get(this)._currentTarget;return e?e.GetInterfaceClass():null}set currentTarget(e){const t=TB.get(this);e?t._MaybeAcquireTargetInstance(t.GetRuntime()._UnwrapIWorldInstance(e)):t._UnacquireTarget()}get range(){return TB.get(this)._GetRange()}set range(e){lB.RequireFiniteNumber(e),TB.get(this)._SetRange(e)}get rateOfFire(){return TB.get(this)._GetRateOfFire()}set rateOfFire(e){lB.RequireFiniteNumber(e),TB.get(this)._SetRateOfFire(e)}get isRotateEnabled(){return TB.get(this)._IsRotateEnabled()}set isRotateEnabled(e){TB.get(this)._SetRotateEnabled(!!e)}get rotateSpeed(){return TB.get(this)._GetRotateSpeed()}set rotateSpeed(e){lB.RequireFiniteNumber(e),TB.get(this)._SetRotateSpeed(e)}get targetMode(){return CB[TB.get(this)._GetTargetMode()]}set targetMode(e){const t=CB.indexOf(e);if(-1===t)throw new Error("invalid targetMode");TB.get(this)._SetTargetMode(t)}get isPredictiveAimEnabled(){return TB.get(this)._IsPredictiveAim()}set isPredictiveAimEnabled(e){TB.get(this)._SetPredictiveAim(!!e)}get projectileSpeed(){return TB.get(this)._GetProjectileSpeed()}set projectileSpeed(e){lB.RequireFiniteNumber(e),TB.get(this)._SetProjectileSpeed(e)}get isEnabled(){return TB.get(this)._IsEnabled()}set isEnabled(e){TB.get(this)._SetEnabled(e)}}}self.C3.Behaviors.Turret.Cnds={HasTarget(){return!!this._currentTarget},OnShoot:()=>!0,OnTargetAcquired:()=>!0,IsEnabled(){return this._IsEnabled()}};{const bB=self.C3;bB.Behaviors.Turret.Acts={AcquireTarget(e){if(!e)return;const t=e.GetCurrentSol().GetInstances();for(const e of t)if(this._MaybeAcquireTargetInstance(e))break},AddTarget(e){const t=this.GetSdkType().GetTargetTypes();if(!t.includes(e)){for(const s of t)if(s.IsFamily()&&s.FamilyHasMember(e))return;t.push(e)}},ClearTargets(){bB.clearArray(this.GetSdkType().GetTargetTypes())},UnacquireTarget(){this._UnacquireTarget()},SetEnabled(e){this._SetEnabled(0!==e)},SetRange(e){this._SetRange(e)},SetRateOfFire(e){this._SetRateOfFire(e)},SetRotate(e){this._SetRotateEnabled(0!==e)},SetRotateSpeed(e){this._SetRotateSpeed(bB.toRadians(e))},SetTargetMode(e){this._SetTargetMode(e)},SetPredictiveAim(e){this._SetPredictiveAim(0!==e)},SetProjectileSpeed(e){this._SetProjectileSpeed(e)}}}{const xB=self.C3;xB.Behaviors.Turret.Exps={TargetUID(){return this._currentTarget?this._currentTarget.GetUID():0},Range(){return this._GetRange()},RateOfFire(){return this._GetRateOfFire()},RotateSpeed(){return xB.toDegrees(this._GetRotateSpeed())}}}{const wB=self.C3;wB.Behaviors.Follow=class extends wB.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const PB=self.C3;PB.Behaviors.Follow.Type=class extends PB.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const RB=self.C3,vB=self.C3X,AB=self.IBehaviorInstance,MB=0,DB=1,EB=2,FB=3,OB=4,BB=5,kB=6,LB=7,NB=8,WB=9,UB=10,VB=11,HB=12,jB=13,zB=["x","y","z-elevation","width","height","angle","opacity","visibility","destroyed"],XB=["step","linear","angular"],YB=["time","distance"];RB.Behaviors.Follow.Instance=class extends RB.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._mode="time",this._delay=2,this._maxDelay=2,this._historyRate=30;const s=RB.Behaviors.Follow.BuiltinPropertyState;this._followProps={x:new s("x","x",!0,"linear"),y:new s("y","y",!0,"linear"),zElevation:new s("z-elevation","z",!1,"linear"),width:new s("width","w",!1,"linear"),height:new s("height","h",!1,"linear"),angle:new s("angle","a",!1,"angular"),opacity:new s("opacity","o",!1,"linear"),visibility:new s("visibility","v",!1,"step"),destroyed:new s("destroyed","d",!0,"step")},this._followPropsByApiId=new Map,this._followPropsBySaveId=new Map;for(const e of Object.values(this._followProps))this._followPropsByApiId.set(e.GetApiId(),e),this._followPropsBySaveId.set(e.GetSaveId(),e);if(this._customPropsById=new Map,this._isEnabled=!0,this._followInst=null,this._loadFollowInstUid=-1,this._nextEntryTime=-1,this._history=[],this._isPaused=!1,this._pausedAtTime=0,this._clockOffset=0,t){this._mode=["time","distance"][t[MB]],this._delay=t[DB],this._maxDelay=t[EB],this._historyRate=t[FB];const e=this._followProps;e.x.SetEnabled(!!t[OB]),e.y.SetEnabled(!!t[BB]),e.zElevation.SetEnabled(!!t[kB]),e.width.SetEnabled(!!t[LB]),e.height.SetEnabled(!!t[NB]),e.angle.SetEnabled(!!t[WB]),e.opacity.SetEnabled(!!t[UB]),e.visibility.SetEnabled(!!t[VB]),e.destroyed.SetEnabled(!!t[HB]),this._isEnabled=!!t[jB]}const i=this._runtime.Dispatcher();this._disposables=new RB.CompositeDisposable(RB.Disposable.From(i,"instancedestroy",e=>this._OnInstanceDestroyed(e.instance)),RB.Disposable.From(i,"afterload",()=>this._OnAfterLoad()))}Release(){this._followInst=null,super.Release()}_OnInstanceDestroyed(e){if(this._followInst===e){if(this._followProps.destroyed.IsEnabled()){const e="distance"===this._mode,t=new RB.Behaviors.Follow.HistoryEntry(this._runtime.GetGameTime());t.SetData(this._followInst,{x:e,y:e,destroyed:!0}),this._history.push(t)}this._followInst=null}}Tick2(){this._followInst&&this._MaybeAddHistoryEntry(),this._MaybeRemoveHistoryEntries(),this._UpdateTicking(),this._UpdateInstance()}_GetFollowTime(){return this._isPaused?this._pausedAtTime:this._runtime.GetGameTime()-this._clockOffset}_MaybeAddHistoryEntry(){const e=this._GetFollowTime(),t="distance"===this._mode,s=1/this._historyRate;if(0===this._history.length||e>=this._nextEntryTime-.02*s){let i;const r=this._GetFollowWorldInfo();if(t&&r&&this._history.length>0){const[e,t]=r.GetXY(),s=this._history.at(-1),[n,a]=s.GetXY();e===n&&t===a&&(i=s)}i||(i=new RB.Behaviors.Follow.HistoryEntry(e),this._history.push(i));const n=this._followProps;i.SetData(this._followInst,{x:n.x.IsEnabled()||t,y:n.y.IsEnabled()||t,zElevation:n.zElevation.IsEnabled(),width:n.width.IsEnabled(),height:n.height.IsEnabled(),angle:n.angle.IsEnabled(),opacity:n.opacity.IsEnabled(),visibility:n.visibility.IsEnabled(),customProperties:this._GetCustomPropertyValuesForHistoryEntry()}),-1===this._nextEntryTime?this._nextEntryTime=e+s:(this._nextEntryTime+=s,this._nextEntryTime<e&&(this._nextEntryTime=e+s))}}_GetCustomPropertyValuesForHistoryEntry(){if(0===this._customPropsById.size)return null;const e=new Map;for(const t of this._customPropsById.values())e.set(t.GetId(),t.GetCurrentValue());return e}_MaybeRemoveHistoryEntries(){0!==this._history.length&&("time"===this._mode?this._MaybeRemoveHistoryEntries_Time():"distance"===this._mode&&this._MaybeRemoveHistoryEntries_Distance())}_MaybeRemoveHistoryEntries_Time(){const e=this._GetFollowTime()-this._maxDelay,t=this._history;for(let s=0,i=t.length;s<i;++s)if(t[s].GetTime()>e){s>=2&&t.splice(0,s-1);break}}_MaybeRemoveHistoryEntries_Distance(){const e=this._maxDelay;let t=0;const s=this._history;for(let i=s.length-2;i>=0;--i){const r=s[i],[n,a]=r.GetXY(),o=s[i+1],[h,l]=o.GetXY();if(t+=RB.hypot2DFast(n-h,a-l),t>e){i>=1&&s.splice(0,i);break}}}_UpdateInstance(){if(this._followInst===this._inst)return;const[e,t,s]=this._GetHistoryEntryPairForCurrentDelay();if(null===e)return;const i=this._inst,r=i.GetWorldInfo(),n=this._followProps;if(r){let i=!1,a=!1;if(n.x.IsEnabled()){const a=this._Interpolate(e.GetX(),t?.GetX(),s,n.x.GetInterpolation());null!==a&&a!==r.GetX()&&(r.SetX(a),i=!0)}if(n.y.IsEnabled()){const a=this._Interpolate(e.GetY(),t?.GetY(),s,n.y.GetInterpolation());null!==a&&a!==r.GetY()&&(r.SetY(a),i=!0)}if(n.zElevation.IsEnabled()){const a=this._Interpolate(e.GetZElevation(),t?.GetZElevation(),s,n.zElevation.GetInterpolation());null!==a&&a!==r.GetZElevation()&&(r.SetZElevation(a),i=!0)}if(n.width.IsEnabled()){const a=this._Interpolate(e.GetWidth(),t?.GetWidth(),s,n.width.GetInterpolation());null!==a&&a!==r.GetWidth()&&(r.SetWidth(a),i=!0)}if(n.height.IsEnabled()){const a=this._Interpolate(e.GetHeight(),t?.GetHeight(),s,n.height.GetInterpolation());null!==a&&a!==r.GetHeight()&&(r.SetHeight(a),i=!0)}if(n.angle.IsEnabled()){const a=this._Interpolate(e.GetAngle(),t?.GetAngle(),s,n.angle.GetInterpolation());null!==a&&a!==r.GetAngle()&&(r.SetAngle(a),i=!0)}if(n.opacity.IsEnabled()){const i=this._Interpolate(e.GetOpacity(),t?.GetOpacity(),s,n.opacity.GetInterpolation());null!==i&&i!==r.GetOpacity()&&(r.SetOpacity(i),a=!0)}if(n.visibility.IsEnabled()){const i=this._Interpolate(e.IsVisible(),t?.IsVisible(),s,n.visibility.GetInterpolation());null!==i&&i!==r.IsVisible()&&(r.SetVisible(i),a=!0)}i?r.SetBboxChanged():a&&this._runtime.UpdateRender()}n.destroyed.IsEnabled()&&e.IsDestroyEntry()&&this._runtime.DestroyInstance(i);for(const i of this._customPropsById.values()){const r=i.GetId(),n=this._Interpolate(e.GetCustomProperty(r),t?.GetCustomProperty(r),s,i.GetInterpolation());null!==n&&i.SetDelayedValue(n)}}_Interpolate(e,t,s,i){if(null==t)return e;if("string"==typeof e||"string"==typeof t)return s<1?e:t;switch(i){case"step":return s<1?e:t;case"linear":return RB.lerp(e,t,s);case"angular":return RB.angleLerp(e,t,s);default:throw new Error("bad interpolation type")}}_GetHistoryEntryPairForCurrentDelay(){let e=null,t=null,s=0;if("time"===this._mode){const i=this._GetFollowTime()-this._delay;[e,t]=this._GetHistoryEntryPairForTime(i),e&&t&&(s=RB.unlerp(e.GetTime(),t.GetTime(),i))}else if("distance"===this._mode){let i=null;const r=this._GetFollowWorldInfo();if(r&&this._history.length>0){const[e,t]=r.GetXY(),[s,n]=this._history.at(-1).GetXY();e===s&&t===n||(i=new RB.Behaviors.Follow.HistoryEntry(this._GetFollowTime()),i.SetData(this._followInst,{x:!0,y:!0}),this._history.push(i))}[e,t,s]=this._GetHistoryEntryPairForDistance(this._delay),i&&this._history.pop()}return[e,t,s]}_GetHistoryEntryPairForTime(e){const t=this._history;for(let s=0,i=t.length;s<i;++s){const r=t[s];if(r.GetTime()===e)return s<i-1?[r,t[s+1]]:s>=1?[t[0],r]:[r,null];if(r.GetTime()>e)return s>=1?[t[s-1],r]:[null,r]}return t.length>=1?[t.at(-1),null]:[null,null]}_GetHistoryEntryPairForDistance(e){let t=0;const s=this._history;for(let i=s.length-2;i>=0;--i){const r=s[i],[n,a]=r.GetXY(),o=s[i+1],[h,l]=o.GetXY(),c=t;if(t+=RB.hypot2DFast(n-h,a-l),t>=e)return[r,o,RB.unlerp(t,c,e)]}return s.length>=1?[null,s[0],0]:[null,null,0]}_ClearHistory(){this._history.length=0}_RewindHistory(e){if(e<=0)return;if(e>=this._maxDelay)return void this._ClearHistory();const t=this._GetFollowTime()-e;this._history=this._history.filter(e=>e.GetTime()<=t),this._IsPaused()?this._pausedAtTime-=e:this._clockOffset+=e,this._nextEntryTime=this._GetFollowTime()+1/this._GetHistoryRate()}_HasFollowData(){const[e]=this._GetHistoryEntryPairForCurrentDelay();return!!e}_GetHistoryEntryCount(){return this._history.length}_StartFollowingInstance(e,t=!1){if(!e)throw new Error("invalid instance");this._followInst!==e&&(this._followInst=e,t&&this._AddDelayedHistoryEntryForSelf(),this._UpdateTicking())}_StopFollowingInstance(){this._followInst&&(this._followInst=null,this._UpdateTicking())}_AddDelayedHistoryEntryForSelf(){const e="distance"===this._mode,t=this._followProps,s=new RB.Behaviors.Follow.HistoryEntry(this._GetFollowTime()-this._GetDelay());s.SetData(this._inst,{x:t.x.IsEnabled()||e,y:t.y.IsEnabled()||e,zElevation:t.zElevation.IsEnabled(),width:t.width.IsEnabled(),height:t.height.IsEnabled(),angle:t.angle.IsEnabled(),opacity:t.opacity.IsEnabled(),visibility:t.visibility.IsEnabled(),customProperties:this._GetCustomPropertyValuesForHistoryEntry()});let i=0,r=!1;for(const e of this._history){if(e.GetTime()>=s.GetTime()){this._history.splice(i,0,s),r=!0;break}++i}r||this._history.push(s)}_GetFollowInstance(){return this._followInst}_GetFollowWorldInfo(){return this._followInst?.GetWorldInfo()}_SetMode(e){this._mode!==e&&(this._mode=e,this._runtime.UpdateRender())}_GetMode(){return this._mode}_SetDelay(e){e=Math.max(e,0),this._delay!==e&&(this._delay=e,this._UpdateInstance())}_GetDelay(){return this._delay}_SetMaxDelay(e){this._maxDelay=Math.max(e,0)}_GetMaxDelay(){return this._maxDelay}_SetHistoryRate(e){this._historyRate=Math.max(e,0)}_GetHistoryRate(){return this._historyRate}_GetFollowPropertyInfo(e){return this._followPropsByApiId.get(e)}_SetFollowPropertyEnabled(e,t){t=!!t;const s=this._GetFollowPropertyInfo(e);s.IsEnabled()!==t&&(s.SetEnabled(t),this._runtime.UpdateRender())}_IsFollowPropertyEnabled(e){return this._GetFollowPropertyInfo(e).IsEnabled()}_SetFollowPropertyInterpolation(e,t){const s=this._GetFollowPropertyInfo(e);s.GetInterpolation()!==t&&(s.SetInterpolation(t),this._runtime.UpdateRender())}_GetFollowPropertyInterpolation(e){return this._GetFollowPropertyInfo(e).GetInterpolation()}_IsFollowingCustomProperty(e){return this._customPropsById.has(e.toLowerCase())}_StartFollowingCustomProperty(e,t){const s=e.toLowerCase(),i=this._customPropsById.get(s);i?i.SetInterpolation(t):this._customPropsById.set(s,new RB.Behaviors.Follow.CustomPropertyState(s,t))}_StopFollowingCustomProperty(e){this._customPropsById.delete(e.toLowerCase())}_SetCustomPropertyValue(e,t){const s=this._customPropsById.get(e.toLowerCase());s&&s.SetCurrentValue(t)}_GetDelayedCustomPropertyValue(e){const t=this._customPropsById.get(e.toLowerCase());return t?t.GetDelayedValue():null}_PropertyIndexToId(e){return zB[e]}_InterpolationIndexToId(e){return XB[e]}_ModeIndexToId(e){return YB[e]}_SetEnabled(e){e=!!e,this._isEnabled!==e&&(this._isEnabled=e,this._UpdateTicking())}_IsEnabled(){return this._isEnabled}_SetPaused(e){e=!!e,this._isPaused!==e&&(e?this._pausedAtTime=this._GetFollowTime():this._clockOffset=this._runtime.GetGameTime()-this._pausedAtTime,this._isPaused=e,this._UpdateTicking())}_IsPaused(){return this._isPaused}_UpdateTicking(){this._IsEnabled()&&!this._IsPaused()&&(this._GetFollowInstance()||this._history.length>0)?this._StartTicking2():this._StopTicking2()}_SaveHistoryToJSON(e){const t=this._GetFollowTime();let s=this._history;return 0!==e&&(s=s.filter(s=>s.GetTime()>=t-e)),{h:s.map(e=>e.SaveToJson(t))}}_LoadHistoryJSON(e){const t=this._GetFollowTime();this._history.length=0;for(const s of e.h){const e=RB.Behaviors.Follow.HistoryEntry.CreateFromJson(s);e.OffsetTime(t),this._history.push(e)}this._history.length>0&&this._SetDelay(Math.min(t-this._history[0].GetTime(),this._GetMaxDelay())),this._UpdateTicking()}SaveToJson(){const e={};for(const[t,s]of this._followPropsBySaveId)s.IsDefault()||(e[t]=s.SaveToJson());return{m:YB.indexOf(this._mode),d:this._delay,md:this._maxDelay,hr:this._historyRate,net:this._nextEntryTime,f:this._followInst?this._followInst.GetUID():-1,ps:e,cps:[...this._customPropsById.values()].map(e=>e.SaveToJson()),h:this._history.map(e=>e.SaveToJson()),p:this._isPaused,pt:this._pausedAtTime,co:this._clockOffset,e:this._isEnabled}}LoadFromJson(e){const t=YB[e.m];"string"==typeof t&&(this._mode=t),this._delay=e.d,this._maxDelay=e.md,this._historyRate=e.hr,this._nextEntryTime=e.net,this._loadFollowInstUid=e.f,this._isPaused=!!e.p,this._pausedAtTime=e.pt,this._clockOffset=e.co,this._history.length=0;for(const t of e.h)this._history.push(RB.Behaviors.Follow.HistoryEntry.CreateFromJson(t));const s=new Set;for(const[t,i]of Object.entries(e.ps)){const e=this._followPropsBySaveId.get(t);e&&(e.LoadFromJson(i),s.add(t))}for(const[e,t]of this._followPropsBySaveId)s.has(e)||t.SetDefault();this._customPropsById.clear();for(const t of e.cps){const e=RB.Behaviors.Follow.CustomPropertyState.CreateFromJson(t);this._customPropsById.set(e.GetId(),e)}this._UpdateTicking()}_OnAfterLoad(){-1===this._loadFollowInstUid?this._followInst=null:(this._followInst=this._runtime.GetInstanceByUID(this._loadFollowInstUid),this._loadFollowInstUid=-1)}GetPropertyValueByIndex(e){switch(e){case DB:return this._GetDelay();case EB:return this._GetMaxDelay();case FB:return this._GetHistoryRate();case OB:return this._IsFollowPropertyEnabled("x");case BB:return this._IsFollowPropertyEnabled("y");case kB:return this._IsFollowPropertyEnabled("z-elevation");case LB:return this._IsFollowPropertyEnabled("width");case NB:return this._IsFollowPropertyEnabled("height");case WB:return this._IsFollowPropertyEnabled("angle");case UB:return this._IsFollowPropertyEnabled("opacity");case VB:return this._IsFollowPropertyEnabled("visibility");case HB:return this._IsFollowPropertyEnabled("destroyed")}}SetPropertyValueByIndex(e,t){switch(e){case DB:this._SetDelay(t);break;case EB:this._SetMaxDelay(t);break;case FB:this._SetHistoryRate(t);break;case OB:this._SetFollowPropertyEnabled("x",t);break;case BB:this._SetFollowPropertyEnabled("y",t);break;case kB:this._SetFollowPropertyEnabled("z-elevation",t);break;case LB:this._SetFollowPropertyEnabled("width",t);break;case NB:this._SetFollowPropertyEnabled("height",t);break;case WB:this._SetFollowPropertyEnabled("angle",t);break;case UB:this._SetFollowPropertyEnabled("opacity",t);break;case VB:this._SetFollowPropertyEnabled("visibility",t);break;case HB:this._SetFollowPropertyEnabled("destroyed",t)}}GetDebuggerProperties(){const e="behaviors.follow";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".properties.mode.name",value:this._GetMode()},{name:e+".properties.delay.name",value:this._GetDelay(),onedit:e=>this._SetDelay(e)},{name:e+".properties.max-delay.name",value:this._GetMaxDelay(),onedit:e=>this._SetMaxDelay(e)},{name:e+".properties.history-rate.name",value:this._GetHistoryRate(),onedit:e=>this._SetHistoryRate(e)},{name:e+".properties.follow-x.name",value:this._IsFollowPropertyEnabled("x"),onedit:e=>this._SetFollowPropertyEnabled("x",e)},{name:e+".properties.follow-y.name",value:this._IsFollowPropertyEnabled("y"),onedit:e=>this._SetFollowPropertyEnabled("y",e)},{name:e+".properties.follow-z-elevation.name",value:this._IsFollowPropertyEnabled("z-elevation"),onedit:e=>this._SetFollowPropertyEnabled("z-elevation",e)},{name:e+".properties.follow-width.name",value:this._IsFollowPropertyEnabled("width"),onedit:e=>this._SetFollowPropertyEnabled("width",e)},{name:e+".properties.follow-height.name",value:this._IsFollowPropertyEnabled("height"),onedit:e=>this._SetFollowPropertyEnabled("height",e)},{name:e+".properties.follow-angle.name",value:this._IsFollowPropertyEnabled("angle"),onedit:e=>this._SetFollowPropertyEnabled("angle",e)},{name:e+".properties.follow-opacity.name",value:this._IsFollowPropertyEnabled("opacity"),onedit:e=>this._SetFollowPropertyEnabled("opacity",e)},{name:e+".properties.follow-visibility.name",value:this._IsFollowPropertyEnabled("visibility"),onedit:e=>this._SetFollowPropertyEnabled("visibility",e)},{name:e+".properties.follow-destroyed.name",value:this._IsFollowPropertyEnabled("destroyed"),onedit:e=>this._SetFollowPropertyEnabled("destroyed",e)},{name:e+".properties.enabled.name",value:this._IsEnabled(),onedit:e=>this._SetEnabled(e)},{name:e+".debugger.paused",value:this._IsPaused(),onedit:e=>this._SetPaused(e)},{name:e+".debugger.history-entry-count",value:this._GetHistoryEntryCount()}]}]}GetScriptInterfaceClass(){return self.IFollowBehaviorInstance}},RB.Behaviors.Follow.INTERP_ID_ARRAY=XB;const qB=new WeakMap,KB=new Set(YB),$B=new Set(XB),JB=new Set(zB);self.IFollowBehaviorInstance=class extends AB{constructor(){super(),qB.set(this,AB._GetInitInst().GetSdkInstance())}startFollowing(e,t=!1){const s=qB.get(this),i=s.GetRuntime()._UnwrapIInstance(e);s._StartFollowingInstance(i,t)}stopFollowing(){qB.get(this)._StopFollowingInstance()}get followInstance(){const e=qB.get(this)._GetFollowInstance();return e?e.GetInterfaceClass():null}set mode(e){if(!KB.has(e))throw new Error("invalid mode");qB.get(this)._SetMode(e)}get mode(){return qB.get(this)._GetMode()}set delay(e){vB.RequireFiniteNumber(e),qB.get(this)._SetDelay(e)}get delay(){return qB.get(this)._GetDelay()}set maxDelay(e){vB.RequireFiniteNumber(e),qB.get(this)._SetMaxDelay(e)}get maxDelay(){return qB.get(this)._GetMaxDelay()}set historyRate(e){vB.RequireFiniteNumber(e),qB.get(this)._SetHistoryRate(e)}get historyRate(){return qB.get(this)._GetHistoryRate()}clearHistory(){qB.get(this)._ClearHistory()}rewindHistory(e){vB.RequireFiniteNumber(e),qB.get(this)._RewindHistory(e)}get hasFollowData(){return qB.get(this)._HasFollowData()}setFollowingProperty(e,t){if(!JB.has(e))throw new Error("invalid property");qB.get(this)._SetFollowPropertyEnabled(e,t)}isFollowingProperty(e){if(!JB.has(e))throw new Error("invalid property");return qB.get(this)._IsFollowPropertyEnabled(e)}setPropertyInterpolation(e,t){if(!JB.has(e))throw new Error("invalid property");if(!$B.has(t))throw new Error("invalid interpolation mode");qB.get(this)._SetFollowPropertyInterpolation(e,t)}getPropertyInterpolation(e){if(!JB.has(e))throw new Error("invalid property");return qB.get(this)._GetFollowPropertyInterpolation(e)}startFollowingCustomProperty(e,t){if(vB.RequireString(e),!$B.has(t))throw new Error("invalid interpolation mode");qB.get(this)._StartFollowingCustomProperty(e,t)}stopFollowingCustomProperty(e){vB.RequireString(e),qB.get(this)._StopFollowingCustomProperty(e)}isFollowingCustomProperty(e){vB.RequireString(e),qB.get(this)._IsFollowingCustomProperty(e)}setCustomPropertyValue(e,t){if(vB.RequireString(e),"number"!=typeof t&&"string"!=typeof t)throw new TypeError("expected number or string");qB.get(this)._SetCustomPropertyValue(e,t)}getDelayedCustomPropertyValue(e){return vB.RequireString(e),qB.get(this)._GetDelayedCustomPropertyValue(e)}get isPaused(){return qB.get(this)._IsPaused()}set isPaused(e){qB.get(this)._SetPaused(!!e)}saveHistoryToJSON(e=0){return vB.RequireFiniteNumber(e),qB.get(this)._SaveHistoryToJSON(e)}loadHistoryFromJSON(e){vB.RequireObject(e),qB.get(this)._LoadHistoryJSON(e)}get isEnabled(){return qB.get(this)._IsEnabled()}set isEnabled(e){qB.get(this)._SetEnabled(e)}}}{const ZB=self.C3;ZB.Behaviors.Follow.Cnds={CompareMode(e){return this._GetMode()===this._ModeIndexToId(e)},CompareDelay(e,t){return ZB.compare(this._GetDelay(),e,t)},CompareMaxDelay(e,t){return ZB.compare(this._GetMaxDelay(),e,t)},CompareHistoryRate(e,t){return ZB.compare(this._GetHistoryRate(),e,t)},IsFollowingProperty(e){return this._IsFollowPropertyEnabled(this._PropertyIndexToId(e))},IsFollowingCustomProperty(e){return this._IsFollowingCustomProperty(e)},IsEnabled(){return this._IsEnabled()},IsFollowingObject(){return!!this._GetFollowInstance()},HasFollowData(){return this._HasFollowData()},IsPaused(){return this._IsPaused()}}}self.C3.Behaviors.Follow.Acts={SetMode(e){this._SetMode(this._ModeIndexToId(e))},SetDelay(e){this._SetDelay(e)},SetMaxDelay(e){this._SetMaxDelay(e)},SetHistoryRate(e){this._SetHistoryRate(e)},SetFollowingProperty(e,t){this._SetFollowPropertyEnabled(this._PropertyIndexToId(e),t)},SetPropertyInterpolation(e,t){this._SetFollowPropertyInterpolation(this._PropertyIndexToId(e),this._InterpolationIndexToId(t))},StartFollowingCustomProperty(e,t){this._StartFollowingCustomProperty(e,this._InterpolationIndexToId(t))},StopFollowingCustomProperty(e){this._StopFollowingCustomProperty(e)},SetCustomPropertyValue(e,t){this._SetCustomPropertyValue(e,t)},FollowObject(e,t){if(!e)return;const s=e.GetPairedInstance(this._inst);s&&this._StartFollowingInstance(s,t)},FollowSelf(){this._StartFollowingInstance(this._inst)},StopFollowing(){this._StopFollowingInstance()},SetEnabled(e){this._SetEnabled(e)},ClearHistory(){this._ClearHistory()},RewindHistory(e){this._RewindHistory(e)},SetPaused(e){this._SetPaused(e)},LoadHistoryJSON(e){let t=null;try{t=JSON.parse(e)}catch(e){return void console.warn("[Construct] Follow behavior failed to load history from JSON: ",e)}this._LoadHistoryJSON(t)}},self.C3.Behaviors.Follow.Exps={Delay(){return this._GetDelay()},MaxDelay(){return this._GetMaxDelay()},HistoryRate(){return this._GetHistoryRate()},FollowUID(){const e=this._GetFollowInstance();return e?e.GetUID():-1},DelayedCustomPropertyValue(e){return this._GetDelayedCustomPropertyValue(e)??0},HistoryAsJSON(e){return JSON.stringify(this._SaveHistoryToJSON(e))}};{const QB=self.C3;QB.Behaviors.Follow.HistoryEntry=class{constructor(e){this._time=e,this._props=new Map,this._customProps=null}SetData(e,t){const s=this._props,i=e?.GetWorldInfo();i&&(t.x&&s.set("x",i.GetX()),t.y&&s.set("y",i.GetY()),t.zElevation&&s.set("z",i.GetZElevation()),t.width&&s.set("w",i.GetWidth()),t.height&&s.set("h",i.GetHeight()),t.angle&&s.set("a",i.GetAngle()),t.opacity&&s.set("o",i.GetOpacity()),t.visibility&&s.set("v",i.IsVisible())),t.destroyed&&s.set("d",!0),t.customProperties&&(this._customProps=t.customProperties)}GetTime(){return this._time}OffsetTime(e){this._time+=e}GetX(){return this._props.get("x")??null}GetY(){return this._props.get("y")??null}GetXY(){return[this.GetX(),this.GetY()]}GetZElevation(){return this._props.get("z")??null}GetWidth(){return this._props.get("w")??null}GetHeight(){return this._props.get("h")??null}GetAngle(){return this._props.get("a")??null}GetOpacity(){return this._props.get("o")??null}IsVisible(){return!!this._props.get("v")}IsDestroyEntry(){return!!this._props.get("d")}GetCustomProperty(e){return this._customProps?.get(e)??null}SaveToJson(e){const t={};for(const[e,s]of this._props)t[e]=s;return{t:"number"==typeof e?this._time-e:this._time,p:t}}static CreateFromJson(e){const t=new QB.Behaviors.Follow.HistoryEntry(e.t);for(const[s,i]of Object.entries(e.p))t._props.set(s,i);return t}}}{const ek=self.C3;ek.Behaviors.Follow.BuiltinPropertyState=class{constructor(e,t,s,i){this._apiId=e,this._saveId=t||this._apiId,this._isEnabled=!!s,this._interpolation=i,this._defaultIsEnabled=this._isEnabled,this._defaultInterpolation=this._interpolation}GetApiId(){return this._apiId}GetSaveId(){return this._saveId}SetEnabled(e){this._isEnabled=!!e}IsEnabled(){return this._isEnabled}SetInterpolation(e){this._interpolation=e}GetInterpolation(){return this._interpolation}IsDefault(){return this._isEnabled===this._defaultIsEnabled&&this._interpolation===this._defaultInterpolation}SetDefault(){this._isEnabled=this._defaultIsEnabled,this._interpolation=this._defaultInterpolation}SaveToJson(){return{e:this._isEnabled,i:ek.Behaviors.Follow.INTERP_ID_ARRAY.indexOf(this._interpolation)}}LoadFromJson(e){this._isEnabled=!!e.e;const t=ek.Behaviors.Follow.INTERP_ID_ARRAY[e.i];"string"==typeof t&&(this._interpolation=t)}},ek.Behaviors.Follow.CustomPropertyState=class{constructor(e,t){this._id=e,this._interpolation=t,this._currentValue=null,this._delayedValue=null}GetId(){return this._id}SetInterpolation(e){this._interpolation=e}GetInterpolation(){return this._interpolation}SetCurrentValue(e){this._currentValue=e}GetCurrentValue(){return this._currentValue}SetDelayedValue(e){this._delayedValue=e}GetDelayedValue(){return this._delayedValue}SaveToJson(){return{id:this._id,i:ek.Behaviors.Follow.INTERP_ID_ARRAY.indexOf(this._interpolation),cv:this._currentValue,dv:this._delayedValue}}static CreateFromJson(e){const t=e.id,s=ek.Behaviors.Follow.INTERP_ID_ARRAY[e.i],i=new ek.Behaviors.Follow.CustomPropertyState(t,s);return i._currentValue=e.cv,i._delayedValue=e.dv,i}}}{const tk=self.C3;tk.Behaviors.Rotate=class extends tk.SDKBehaviorBase{constructor(e){super(e)}Release(){super.Release()}}}{const sk=self.C3;sk.Behaviors.Rotate.Type=class extends sk.SDKBehaviorTypeBase{constructor(e){super(e)}Release(){super.Release()}OnCreate(){}}}{const ik=self.C3,rk=self.C3X,nk=self.IBehaviorInstance,ak=0,ok=1,hk=2;ik.Behaviors.Rotate.Instance=class extends ik.SDKBehaviorInstanceBase{constructor(e,t){super(e),this._speed=0,this._acceleration=0,this._isEnabled=!0,t&&(this._speed=ik.toRadians(t[ak]),this._acceleration=ik.toRadians(t[ok]),this._isEnabled=t[hk]),this._isEnabled&&this._StartTicking()}Release(){super.Release()}_SetSpeed(e){this._speed=e}_GetSpeed(){return this._speed}_SetAcceleration(e){this._acceleration=e}_GetAcceleration(){return this._acceleration}SaveToJson(){return{s:this._speed,a:this._acceleration,e:this._isEnabled}}LoadFromJson(e){this._speed=e.s,this._acceleration=e.a,this._SetEnabled(e.e)}Tick(){if(!this._isEnabled)return;const e=this._runtime.GetDt(this._inst);if(0!==e&&(0!==this._acceleration&&(this._speed+=this._acceleration*e),0!==this._speed)){const t=this._inst.GetWorldInfo();t.SetAngle(t.GetAngle()+this._speed*e),t.SetBboxChanged()}}GetPropertyValueByIndex(e){switch(e){case ak:return ik.toDegrees(this._GetSpeed());case ok:return ik.toDegrees(this._GetAcceleration());case hk:return this._IsEnabled()}}SetPropertyValueByIndex(e,t){switch(e){case ak:this._SetSpeed(ik.toRadians(t));break;case ok:this._SetAcceleration(ik.toRadians(t));break;case hk:this._SetEnabled(t)}}_SetEnabled(e){this._isEnabled=!!e,this._isEnabled?this._StartTicking():this._StopTicking()}_IsEnabled(){return this._isEnabled}GetDebuggerProperties(){const e="behaviors.rotate";return[{title:"$"+this.GetBehaviorType().GetName(),properties:[{name:e+".properties.speed.name",value:ik.toDegrees(this._GetSpeed()),onedit:e=>this._SetSpeed(ik.toRadians(e))},{name:e+".properties.acceleration.name",value:ik.toDegrees(this._GetAcceleration()),onedit:e=>this._SetAcceleration(ik.toRadians(e))},{name:e+".properties.enabled.name",value:this._IsEnabled(),onedit:e=>this._SetEnabled(e)}]}]}GetScriptInterfaceClass(){return self.IRotateBehaviorInstance}};const lk=new WeakMap;self.IRotateBehaviorInstance=class extends nk{constructor(){super(),lk.set(this,nk._GetInitInst().GetSdkInstance())}set speed(e){rk.RequireFiniteNumber(e),lk.get(this)._SetSpeed(e)}get speed(){return lk.get(this)._GetSpeed()}set acceleration(e){rk.RequireFiniteNumber(e),lk.get(this)._SetAcceleration(e)}get acceleration(){return lk.get(this)._GetAcceleration()}get isEnabled(){return lk.get(this)._IsEnabled()}set isEnabled(e){lk.get(this)._SetEnabled(e)}}}self.C3.Behaviors.Rotate.Cnds={IsEnabled(){return this._IsEnabled()}};{const ck=self.C3;ck.Behaviors.Rotate.Acts={SetSpeed(e){this._SetSpeed(ck.toRadians(e))},SetAcceleration(e){this._SetAcceleration(ck.toRadians(e))},SetEnabled(e){this._SetEnabled(e)}}}{const uk=self.C3;uk.Behaviors.Rotate.Exps={Speed(){return uk.toDegrees(this._GetSpeed())},Acceleration(){return uk.toDegrees(this._GetAcceleration())}}}{let dk=function(e){return"number"==typeof e?-e:e},_k=function(e,t){return"number"==typeof e&&"number"==typeof t},pk=function(e,t){return _k(e,t)?e+t:e},fk=function(e,t){return _k(e,t)?e-t:e},mk=function(e,t){return _k(e,t)?e*t:e},gk=function(e,t){return _k(e,t)?e/t:e},Sk=function(e,t){return _k(e,t)?e%t:e},Gk=function(e,t){return _k(e,t)?Math.pow(e,t):e},yk=function(e,t){if("string"==typeof e||"string"==typeof t){let s,i;return s="number"==typeof e?(Math.round(1e10*e)/1e10).toString():e,i="number"==typeof t?(Math.round(1e10*t)/1e10).toString():t,s+i}return e&&t?1:0},Ik=function(e,t){return _k(e,t)?e||t?1:0:e};unaryminus=dk,bothNumbers=_k,add=pk,subtract=fk,multiply=mk,divide=gk,mod=Sk,pow=Gk,and=yk,or=Ik;const Tk=self.C3;self.C3_ExpressionFuncs=[()=>"misc",()=>0,()=>-5,()=>"music",()=>-100,()=>"music?",()=>1,()=>"fade out",()=>2,e=>{const t=e._GetNode(0),s=e._GetNode(1);return()=>t.ExpObject()+s.ExpObject()/2},()=>"",e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t(185,285)},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetVar(),r=e._GetNode(3).GetVar();return()=>t(s.GetValue(),i.GetValue(),r.GetValue())},e=>{const t=e._GetNode(0).GetVar();return()=>t.GetValue()},e=>{const t=e._GetNode(0);return()=>t.ExpObject()},e=>{const t=e._GetNode(0);return()=>t.ExpObject()+60},()=>4,()=>3,e=>{const t=e._GetNode(0);return()=>t.ExpObject(1)},e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetBoundMethod(),i=e._GetNode(2).GetBoundMethod(),r=e._GetNode(3).GetBoundMethod(),n=e._GetNode(4).GetBoundMethod(),a=e._GetNode(5).GetBoundMethod();return()=>yk(yk(yk(yk(t(),"/"),s())+"\n",i(r(),1))+"%/",n(a(),1))+"%"},()=>"GlowHorizontal",e=>{const t=e._GetNode(0);return()=>50+t.ExpBehavior()},()=>"GlowVertical",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2).GetBoundMethod();return()=>Tk.lerp(t(),s.ExpObject(),10*i())},e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2),r=e._GetNode(3);return()=>Tk.clamp(Tk.distanceTo(t.ExpObject(),s.ExpObject(),i.ExpObject(),r.ExpObject())/10,0,40)},()=>"player",()=>"up",()=>"down",()=>"left",()=>"right",()=>"idle",()=>.25,e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1),i=e._GetNode(2),r=e._GetNode(3);return()=>t(s.ExpInstVar(),i.ExpInstVar(),r.ExpInstVar())},()=>-10,()=>"death",()=>5,()=>.1,()=>-3,()=>240,e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod();return()=>t.ExpObject()+90*s()},()=>300,()=>3e3,e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod();return()=>t.ExpObject()-130*s()},()=>735,()=>7350,()=>420,()=>4200,e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t()},()=>-7.5,()=>"fade in",()=>100,()=>6,()=>"particles",()=>"creatures",e=>{const t=e._GetNode(0);return()=>t.ExpInstVar()},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("creature_talkl","creature_talkm","creature_talkh")},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>Math.floor(t(0,10001))},()=>.125,()=>"wait",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1).GetVar(),i=e._GetNode(2).GetVar();return()=>t(5-s.GetValue()/25,20-i.GetValue()/25)},e=>{const t=e._GetNode(0);return()=>t.ExpInstVar_Family()},e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t(10001,10002,10003)},()=>"message3",()=>5e3,()=>"message1",()=>5001,()=>1e4,()=>"message2",()=>10001,()=>"random1",()=>10002,()=>"random2",()=>10003,()=>"random3",e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t("hurt1","hurt2")},()=>.5,()=>140,()=>190,e=>{const t=e._GetNode(0);return()=>70*t.ExpInstVar_Family()+140},e=>{const t=e._GetNode(0);return()=>t.ExpBehavior()+50},()=>-2.5,()=>"collect",e=>{const t=e._GetNode(0).GetBoundMethod(),s=e._GetNode(1);return()=>t(s.ExpInstVar_Family())/5},()=>"timer",()=>.2,()=>.4,e=>{const t=e._GetNode(0).GetBoundMethod();return()=>t(1/30,.05)},()=>"celebrate",()=>"enemies",e=>{const t=e._GetNode(0).GetBoundMethod();return()=>180*t()},e=>{const t=e._GetNode(0),s=e._GetNode(1),i=e._GetNode(2).GetBoundMethod();return()=>Tk.lerp(t.ExpObject(),s.ExpObject(),30*i())},()=>"flash",()=>"none",()=>"creature",()=>"find",()=>"lose",()=>"shake",()=>"fire",()=>"charge",()=>-2,()=>"bonk",e=>{const t=e._GetNode(0);return()=>t.ExpObject()+3},e=>{const t=e._GetNode(0);return()=>t.ExpObject()-3},()=>"aim",e=>{const t=e._GetNode(0),s=e._GetNode(1).GetBoundMethod();return()=>t.ExpInstVar()+s(-40,40)},()=>1.25,()=>.15,()=>"enemies (unused)",()=>33,e=>{const t=e._GetNode(0).GetVar(),s=e._GetNode(1).GetVar();return()=>yk(yk("Completion:\n",3*t.GetValue())+"%\n\nDeaths:\n",s.GetValue())+"\n\nThanks for playing!"},e=>{const t=e._GetNode(0).GetVar();return()=>yk("Completion:\n100%\n\nDeaths:\n",t.GetValue())+"\n\nThanks for playing!"},()=>"menu",()=>.8,()=>.35,()=>1/0]}}}),import_c3runtime=__toESM(require_c3runtime()),C32=self.C3;self.C3_GetObjectRefTable=function(){return[C32.Plugins.Audio,C32.Plugins.Browser,C32.Plugins.Keyboard,C32.Plugins.Mouse,C32.Plugins.PlatformInfo,C32.Plugins.Tilemap,C32.Behaviors.solid,C32.Plugins.Sprite,C32.Behaviors.destroy,C32.Behaviors.Sin,C32.Behaviors.Fade,C32.Plugins.TiledBg,C32.Behaviors.Tween,C32.Behaviors.EightDir,C32.Behaviors.bound,C32.Behaviors.Flash,C32.Behaviors.Bullet,C32.Plugins.Text,C32.Plugins.Spritefont2,C32.Behaviors.Timer,C32.Plugins.Particles,C32.Behaviors.LOS,C32.Behaviors.Turret,C32.Behaviors.Follow,C32.Behaviors.Rotate,C32.Plugins.System.Cnds.IsGroupActive,C32.Plugins.System.Cnds.OnLayoutStart,C32.Plugins.Sprite.Acts.SetPosToObject,C32.Plugins.Sprite.Acts.AddChild,C32.Plugins.Sprite.Acts.Destroy,C32.Plugins.Audio.Acts.Play,C32.Plugins.Sprite.Acts.MoveToBottom,C32.Behaviors.LOS.Acts.AddObstacle,C32.Plugins.Spritefont2.Acts.AddChild,C32.Behaviors.Tween.Acts.TweenOneProperty,C32.Plugins.System.Acts.ScrollToObject,C32.Plugins.System.Cnds.ForEach,C32.Plugins.System.Acts.CreateObject,C32.Plugins.Tilemap.Exps.X,C32.Plugins.Tilemap.Exps.Width,C32.Plugins.Tilemap.Exps.Y,C32.Plugins.Tilemap.Exps.Height,C32.Plugins.System.Acts.SetVar,C32.Plugins.System.Exps.random,C32.Plugins.Sprite.Acts.SetDefaultColor,C32.Plugins.System.Exps.rgbex255,C32.Plugins.Sprite.Acts.SetInstanceVar,C32.Plugins.Sprite.Acts.Spawn,C32.Plugins.Sprite.Exps.X,C32.Plugins.Sprite.Exps.Y,C32.Plugins.Sprite.Exps.UID,C32.Plugins.Sprite.Exps.ImagePointX,C32.Plugins.Sprite.Exps.ImagePointY,C32.Plugins.Sprite.Exps.Angle,C32.Plugins.System.Cnds.EveryTick,C32.Plugins.Text.Acts.SetText,C32.Plugins.PlatformInfo.Exps.FramesPerSecond,C32.Plugins.PlatformInfo.Exps.TicksPerSecond,C32.Plugins.System.Exps.roundtodp,C32.Plugins.System.Exps.cpuutilisation,C32.Plugins.System.Exps.gpuutilisation,C32.Plugins.Sprite.Acts.SetEffectParam,C32.Behaviors.Sin.Exps.Value,C32.Plugins.Sprite.Cnds.PickDistance,C32.Plugins.System.Acts.Scroll,C32.Plugins.System.Exps.scrollx,C32.Plugins.System.Exps.dt,C32.Plugins.System.Exps.scrolly,C32.Plugins.Sprite.Cnds.IsOnScreen,C32.Plugins.Sprite.Acts.SetOpacity,C32.Plugins.Keyboard.Cnds.IsKeyDown,C32.Behaviors.EightDir.Cnds.IsEnabled,C32.Plugins.System.Cnds.CompareBoolVar,C32.Behaviors.EightDir.Acts.SimulateControl,C32.Plugins.Sprite.Acts.SetAnim,C32.Behaviors.EightDir.Cnds.IsMoving,C32.Plugins.Sprite.Cnds.IsAnimPlaying,C32.Plugins.Sprite.Cnds.CompareY,C32.Plugins.Sprite.Acts.ZMoveToObject,C32.Plugins.Sprite.Cnds.IsOverlapping,C32.Plugins.System.Cnds.Every,C32.Plugins.Particles.Acts.SetDefaultColor,C32.Plugins.Sprite.Cnds.OnCollision,C32.Behaviors.EightDir.Acts.SetEnabled,C32.Plugins.System.Acts.AddVar,C32.Plugins.Sprite.Cnds.OnAnimFinished,C32.Plugins.Sprite.Acts.SetPos,C32.Behaviors.Flash.Acts.Flash,C32.Plugins.Sprite.Acts.SetVisible,C32.Plugins.System.Cnds.Else,C32.Plugins.System.Cnds.TriggerOnce,C32.Plugins.Audio.Acts.FadeVolume,C32.Plugins.Sprite.Cnds.IsBoolInstanceVarSet,C32.Plugins.TiledBg.Cnds.CompareWidth,C32.Plugins.TiledBg.Acts.SetWidth,C32.Plugins.TiledBg.Exps.Width,C32.Behaviors.EightDir.Acts.SetMaxSpeed,C32.Behaviors.EightDir.Acts.SetAcceleration,C32.Behaviors.EightDir.Acts.SetDeceleration,C32.Plugins.TiledBg.Acts.SetVisible,C32.Plugins.Mouse.Cnds.OnClick,C32.Plugins.Sprite.Acts.SetBoolInstanceVar,C32.Plugins.Mouse.Cnds.OnRelease,C32.Plugins.System.Cnds.Compare,C32.Plugins.Sprite.Exps.Count,C32.Plugins.Sprite.Acts.SetTowardPosition,C32.Plugins.Mouse.Exps.X,C32.Plugins.Mouse.Exps.Y,C32.Plugins.Mouse.Acts.SetCursor,C32.Plugins.System.Acts.SetBoolVar,C32.Behaviors.EightDir.Acts.Stop,C32.Plugins.System.Acts.Wait,C32.Plugins.System.Acts.WaitForPreviousActions,C32.Plugins.System.Acts.GoToLayout,C32.Plugins.Particles.Cnds.IsSpraying,C32.Plugins.Particles.Acts.Destroy,C32.Plugins.System.Cnds.PickByComparison,C32.Plugins.Sprite.Cnds.CompareOpacity,C32.Plugins.Audio.Acts.PlayByName,C32.Plugins.System.Exps.choose,C32.Behaviors.Timer.Acts.StartTimer,C32.Plugins.System.Cnds.PickByEvaluate,C32.Plugins.System.Cnds.PickRandom,C32.Plugins.Sprite.Acts.MoveToTop,C32.Plugins.System.Cnds.CompareBetween,C32.Behaviors.Tween.Acts.StopAllTweens,C32.Behaviors.Timer.Acts.StopAllTimers,C32.Behaviors.Rotate.Cnds.IsEnabled,C32.Behaviors.Rotate.Acts.SetEnabled,C32.Plugins.Sprite.Acts.SetAngle,C32.Behaviors.Timer.Cnds.OnTimer,C32.Plugins.Sprite.Cnds.CompareInstanceVar,C32.Behaviors.Follow.Acts.FollowObject,C32.Behaviors.Follow.Acts.SetDelay,C32.Behaviors.Follow.Acts.SetMaxDelay,C32.Behaviors.Follow.Exps.Delay,C32.Plugins.Sprite.Acts.MoveToLayer,C32.Behaviors.Fade.Acts.StartFade,C32.Plugins.Spritefont2.Acts.SetOpacity,C32.Plugins.Spritefont2.Acts.SetText,C32.Plugins.System.Exps.len,C32.Plugins.Sprite.Cnds.CompareX,C32.Plugins.Sprite.Acts.SetMirrored,C32.Behaviors.Sin.Acts.SetEnabled,C32.Behaviors.Sin.Acts.SetPhase,C32.Plugins.Sprite.Cnds.PickByUID,C32.Behaviors.LOS.Cnds.HasLOSToObject,C32.Plugins.Sprite.Acts.RotateTowardPosition,C32.Plugins.Audio.Acts.Stop,C32.Behaviors.LOS.Cnds.RayIntersected,C32.Plugins.Sprite.Cnds.CompareFrame,C32.Plugins.Audio.Acts.StopAll,C32.Plugins.System.Cnds.CompareVar,C32.Plugins.Spritefont2.Acts.TypewriterText,C32.Plugins.Keyboard.Cnds.OnKey,C32.Plugins.TiledBg.Cnds.CompareOpacity]},self.C3_JsPropNameTable=[{audio:0},{browser:0},{keyboard:0},{mouse:0},{info:0},{Solid:0},{level_room:0},{DestroyOutsideLayout:0},{level_roomscroll:0},{color:0},{Sine:0},{level_bush:0},{level_torch:0},{creatureuid:0},{Fade:0},{level_secretdoor:0},{level_checkpoint:0},{level_fire:0},{level_conveyor:0},{level_secretarea:0},{level_chattymode:0},{Tween:0},{level_fade:0},{dashing:0},{"8Direction":0},{"8Direction2":0},{BoundToLayout:0},{player_collision:0},{Flash:0},{player_image:0},{player_dashmeter_background:0},{player_dashmeter:0},{Bullet:0},{player_beam:0},{text_debug:0},{Timer:0},{text_collect:0},{text_blank:0},{text_enddialog:0},{text_dialog_background:0},{text_endstats:0},{text_blink:0},{dump_1:0},{dump_2:0},{dump_3:0},{particle_leaves:0},{particle_torch:0},{particle_smoke:0},{particle_star:0},{index:0},{collected:0},{message:0},{targetedby:0},{creature_bushl:0},{creature_bushd:0},{creature_maze:0},{belongsto:0},{creature_speechbubble:0},{creature_bushhidden:0},{creature_door:0},{creature_checkpoint:0},{creature_coin:0},{creature_hallway:0},{creature_secret:0},{creature_speed:0},{creature_beam:0},{shadow_bush:0},{shadow_creature:0},{shadow_player:0},{target:0},{aimer:0},{targeting:0},{LineOfSight:0},{Turret:0},{enemy_turret:0},{turret:0},{enemy_turret_target:0},{enemy_turret_aimline:0},{enemy_turret_bullet:0},{initialangle:0},{enemy_tripleturret:0},{enemy_movingturret:0},{enemy_turret_ash:0},{ending_background:0},{menu_background:0},{PARTICLES:0},{ORDERED:0},{Follow:0},{Rotate:0},{CREATURES:0},{TARGETS:0},{SHADOWS:0},{LETHAL:0},{checkpointx:0},{checkpointy:0},{chattymode:0},{deaths:0},{Number:0}],self.InstanceType={audio:class extends self.IInstance{},browser:class extends self.IInstance{},keyboard:class extends self.IInstance{},mouse:class extends self.IInstance{},info:class extends self.IInstance{},level_room:class extends self.ITilemapInstance{},level_roomscroll:class extends self.ISpriteInstance{},level_bush:class extends self.ISpriteInstance{},level_torch:class extends self.ISpriteInstance{},level_secretdoor:class extends self.ISpriteInstance{},level_checkpoint:class extends self.ISpriteInstance{},level_fire:class extends self.ISpriteInstance{},level_conveyor:class extends self.ISpriteInstance{},level_secretarea:class extends self.ISpriteInstance{},level_chattymode:class extends self.ISpriteInstance{},level_fade:class extends self.ITiledBackgroundInstance{},player_collision:class extends self.ISpriteInstance{},player_image:class extends self.ISpriteInstance{},player_dashmeter_background:class extends self.ITiledBackgroundInstance{},player_dashmeter:class extends self.ITiledBackgroundInstance{},player_beam:class extends self.ISpriteInstance{},text_debug:class extends self.ITextInstance{},text_collect:class extends self.ISpriteFontInstance{},text_blank:class extends self.ISpriteFontInstance{},text_enddialog:class extends self.ISpriteFontInstance{},text_dialog_background:class extends self.ISpriteInstance{},text_endstats:class extends self.ISpriteFontInstance{},text_blink:class extends self.ISpriteFontInstance{},dump_1:class extends self.ISpriteInstance{},dump_2:class extends self.ISpriteInstance{},dump_3:class extends self.ISpriteInstance{},particle_leaves:class extends self.IParticlesInstance{},particle_torch:class extends self.IParticlesInstance{},particle_smoke:class extends self.IParticlesInstance{},particle_star:class extends self.IParticlesInstance{},creature_bushl:class extends self.ISpriteInstance{},creature_bushd:class extends self.ISpriteInstance{},creature_maze:class extends self.ISpriteInstance{},creature_speechbubble:class extends self.ISpriteInstance{},creature_bushhidden:class extends self.ISpriteInstance{},creature_door:class extends self.ISpriteInstance{},creature_checkpoint:class extends self.ISpriteInstance{},creature_coin:class extends self.ISpriteInstance{},creature_hallway:class extends self.ISpriteInstance{},creature_secret:class extends self.ISpriteInstance{},creature_speed:class extends self.ISpriteInstance{},creature_beam:class extends self.ISpriteInstance{},shadow_bush:class extends self.ISpriteInstance{},shadow_creature:class extends self.ISpriteInstance{},shadow_player:class extends self.ISpriteInstance{},enemy_turret:class extends self.ISpriteInstance{},enemy_turret_target:class extends self.ISpriteInstance{},enemy_turret_aimline:class extends self.ISpriteInstance{},enemy_turret_bullet:class extends self.ISpriteInstance{},enemy_tripleturret:class extends self.ISpriteInstance{},enemy_movingturret:class extends self.ISpriteInstance{},enemy_turret_ash:class extends self.ISpriteInstance{},ending_background:class extends self.ISpriteInstance{},menu_background:class extends self.ISpriteInstance{},PARTICLES:class extends self.IParticlesInstance{},ORDERED:class extends self.ISpriteInstance{},CREATURES:class extends self.ISpriteInstance{},TARGETS:class extends self.ISpriteInstance{},SHADOWS:class extends self.ISpriteInstance{},LETHAL:class extends self.ISpriteInstance{}};
/*!
@fileoverview gl-matrix - High performance matrix and vector operations
@author Brandon Jones
@author Colin MacKenzie IV
@version 3.4.1

Copyright (c) 2015-2021, Brandon Jones, Colin MacKenzie IV.

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.

*/